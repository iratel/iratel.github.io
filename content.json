{"meta":{"title":"è®¸è¿›æ²‰æ€å½•-ä¸“æ³¨äºäº’è”ç½‘ä¸ä¸­é—´ä»¶åŸºç¡€æ¶æ„æŠ€æœ¯ç ”ç©¶","subtitle":"HaloğŸ’«","description":"Spring Cloudä¸­å›½ç¤¾åŒºåˆ›å§‹äººï¼Œå…¥èŒäºé˜¿é‡Œ,æ›¾å…¥èŒäºå”¯å“ä¼šä¸­é—´ä»¶,ä¸šä½™ä¸»è¦ç ”ç©¶Spring Cloudã€‚ã€Šé‡æ–°å®šä¹‰Spring Cloudå®æˆ˜ã€‹ä½œè€…","author":"HaloğŸ’«","url":"http://xujin.org"},"pages":[{"title":"404 Page Not Found","date":"2017-08-04T15:36:59.000Z","updated":"2019-01-09T15:56:50.499Z","comments":true,"path":"404.html","permalink":"http://xujin.org/404.html","excerpt":"","text":""},{"title":"about","date":"2017-07-28T16:50:51.000Z","updated":"2019-01-10T14:34:17.803Z","comments":true,"path":"about/index.html","permalink":"http://xujin.org/about/index.html","excerpt":"","text":"ä¸€.è‡ªæˆ‘ä»‹ç» ç±è´¯äº‘å—ï¼Œç°å±…ä¸Šæµ·ã€‚å…¥èŒäºé˜¿é‡Œï¼ŒèŠ±åç¹éœ–ã€‚è½¯ä»¶å·¥ç¨‹ä¸“ä¸šï¼Œä¸“æ³¨äºåŸºç¡€æ¶æ„å’Œå„ç§ä¸­é—´ä»¶è®¾è®¡ä¸ç ”å‘ã€‚Spring Cloudä¸­å›½ç¤¾åŒºåˆ›å§‹äººï¼Œã€Šé‡æ–°å®šä¹‰Spring Cloudå®æˆ˜ã€‹ä½œè€…ä¹‹ä¸€ã€‚ å½“å½“è´­ä¹°åœ°å€:http://product.dangdang.com/25348282.htmläº¬ä¸œè´­ä¹°åœ°å€:https://item.jd.com/12447280.html æ›¾å°±èŒäºé¥¿äº†ä¹ˆã€‚ æ›¾å°±èŒäºå”¯å“ä¼šå¹³å°æ¶æ„éƒ¨ï¼Œå‚ä¸å”¯å“ä¼šä¸­é—´ä»¶(æœåŠ¡ç½‘å…³,åº”ç”¨æ¡†æ¶ï¼Œä»£ç ç”Ÿæˆå™¨ç­‰)ç›¸å…³çš„ç ”å‘å·¥ä½œã€‚ æ›¾å‚ä¸å”¯å“ä¼šäº’è”ç½‘é‡‘èå¹³å°çš„è®¾è®¡ä¸å¼€å‘(https://jinrong.vip.com/)ï¼Œ æ›¾å‚ä¸åŸºäºäº‘è®¡ç®—Iaasçš„å¹³å®‰ç§‘æŠ€äº‘å¹³å°(www.pinganyun.com)å’Œå›½æ³°å›å®‰è¯å·äº‘å¹³å°çš„å¼€å‘ï¼Œ æ›¾å‚ä¸åŸºäºäº‘è®¡ç®—Saaså¹³å°çš„äº‘é”€å”®ç®¡ç†ç³»ç»Ÿçš„å¼€å‘ç­‰ã€‚å¼€å‘çš„ç§æœ‰äº‘äº§å“åº”ç”¨äºå¤ªå¹³äººå¯¿ï¼Œä¸œäºšé“¶è¡Œï¼Œå¤©ç¿¼è§†è®¯ï¼Œä¸Šæµ·è¯åˆ¸äº¤æ˜“æ‰€,å›½æ³°å›å®‰ç­‰ã€‚ ç†Ÿç»ƒè¿ç”¨å„ç§æµè¡Œçš„JavaEEæŠ€æœ¯è¿›è¡Œç»„åˆå¼æ¶æ„è®¾è®¡ä¸å¼€å‘ã€‚ä¸šä½™æ—¶é—´ç ”ç©¶å¹¶å‘ç¼–ç¨‹ï¼Œä¸­é—´ä»¶ï¼Œå¼‚åœ°å¤šæ´»ï¼ŒSpring Cloudï¼ŒZStack(zstack.org.cn)ï¼ŒMycatç­‰å¼€æºé¡¹ç›®ï¼Œä»¥åŠè½¯ä»¶æ¶æ„è®¾è®¡ï¼Œç¨‹åºæ€§èƒ½ä¼˜åŒ–ï¼ŒJVMï¼Œé«˜å¹¶å‘ç­‰ï¼ äºŒ.åˆ†äº«ç»å† Spring Cloud Zuulä¸ç½‘å…³ä¸­é—´ä»¶ Spring Cloudä¸ä¸­é—´ä»¶åŠå›½å†…ä½¿ç”¨æƒ…å†µ Spring Cloud ä¸å¾®æœåŠ¡ç½‘å…³ Spring Cloudä¸é¢†åŸŸé©±åŠ¨æ¶æ„æ²»ç†å®æˆ˜ ä¸‰.è”ç³»æ–¹å¼ E-mail: Software_King@qq.com Github: Software_King ç½‘ç«™: http://xujin.org ç½‘ç»œID:Software_King å¾®ä¿¡:Software_King Spring Cloudä¸­å›½ç¤¾åŒº:http://springcloud.cn åº§å³é“­:è½¯ä»¶ä¸–ç•Œå°±æ˜¯æ¨¡æ‹Ÿå®¢è§‚ä¸–ç•Œï¼Œä»è€Œéœ€æ±‚åˆ†æï¼ŒæŠ€æœ¯é©±åŠ¨ï¼Œæ”¹é€ ä¸–ç•Œï¼"},{"title":"Categories","date":"2018-01-04T16:00:00.000Z","updated":"2019-01-09T15:56:50.511Z","comments":true,"path":"categories/index.html","permalink":"http://xujin.org/categories/index.html","excerpt":"","text":"title: Androiddate: 2018-01-05 00:00:00 type: â€œcategoriesâ€ title: Hexodate: 2018-01-05 00:00:00 type: â€œcategoriesâ€"},{"title":"search","date":"2018-04-01T09:52:02.000Z","updated":"2019-01-09T15:56:50.511Z","comments":true,"path":"search/index.html","permalink":"http://xujin.org/search/index.html","excerpt":"","text":""},{"title":"Tags","date":"2018-03-31T16:00:00.000Z","updated":"2019-01-09T15:56:50.512Z","comments":true,"path":"tags/index.html","permalink":"http://xujin.org/tags/index.html","excerpt":"","text":""},{"title":"Android","date":"2018-01-04T16:00:00.000Z","updated":"2019-01-09T15:56:50.510Z","comments":true,"path":"categories/Android/index.html","permalink":"http://xujin.org/categories/Android/index.html","excerpt":"","text":""},{"title":"Hexo","date":"2018-01-04T16:00:00.000Z","updated":"2019-01-09T15:56:50.511Z","comments":true,"path":"categories/Hexo/index.html","permalink":"http://xujin.org/categories/Hexo/index.html","excerpt":"","text":""}],"posts":[{"title":"Spring Cloudç¬¬äºŒä»£","slug":"sc/sc2","date":"2018-11-27T06:00:00.000Z","updated":"2019-01-12T04:21:40.872Z","comments":true,"path":"sc/sc2/","link":"","permalink":"http://xujin.org/sc/sc2/","excerpt":"æ‘˜è¦: éšç€Eurekaä¸å†ç»´æŠ¤ï¼ŒHystrixä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œè¿›å…¥ç»´æŠ¤çŠ¶æ€ã€‚ä»¥åŠæœ€è¿‘ä¸­å›½å¼€æºå‡ºç°ä¸€äº›å¤§äº‹ï¼Œé¢„æµ‹ä¸€ä¸‹2019å¹´æœªæ¥Spring Cloudç”Ÿæ€åœˆä¸­çš„ç¬¬äºŒä»£ç»„ä»¶çš„ç»„åˆï¼Œä»…ä»£è¡¨ä¸ªäººçœ‹æ³•ã€‚ 1. Spring Cloudç¬¬ä¸€ä»£ Spring Cloudè‡ªä»æ¨å‡ºä¹‹åï¼Œç»™å¤§å®¶çš„æ„Ÿè§‰å°±æ˜¯Spring Cloudåšå®ƒæœ€æ“…é•¿çš„äº‹ï¼Œä¹Ÿå°±æ˜¯é«˜åº¦æŠ½è±¡å’Œå°è£…ï¼Œå¼ºå¼ºè”æ‰‹æ•´åˆæœ€ä¼˜ä¸œè¥¿ä¸ºæˆ‘æ‰€ç”¨ï¼Œæ¯”å¦‚Netflixå¼€æºçš„Eurekaï¼ŒHystrixï¼ŒRibbonç­‰ã€‚è€Œä¸”æä¾›å¤šç§æŠ€æœ¯é€‰å‹ï¼Œæ€åº¦ä¸­ç«‹è€Œé€‰æœ€ä¼˜ã€‚8å¤©å‰ä¹Ÿå°±æ˜¯2018å¹´11æœˆ19å·å·¦å³ï¼ŒNetflixçš„å¼€æºé¡¹ç›®Hystrixå®£å¸ƒçŠ¶æ€ï¼Œä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œå¤„äºç»´æŠ¤çŠ¶æ€ã€‚å¼•å‘æœ‹å‹åœˆçš„ä¸€äº›æ€è€ƒã€‚","text":"æ‘˜è¦: éšç€Eurekaä¸å†ç»´æŠ¤ï¼ŒHystrixä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œè¿›å…¥ç»´æŠ¤çŠ¶æ€ã€‚ä»¥åŠæœ€è¿‘ä¸­å›½å¼€æºå‡ºç°ä¸€äº›å¤§äº‹ï¼Œé¢„æµ‹ä¸€ä¸‹2019å¹´æœªæ¥Spring Cloudç”Ÿæ€åœˆä¸­çš„ç¬¬äºŒä»£ç»„ä»¶çš„ç»„åˆï¼Œä»…ä»£è¡¨ä¸ªäººçœ‹æ³•ã€‚ 1. Spring Cloudç¬¬ä¸€ä»£ Spring Cloudè‡ªä»æ¨å‡ºä¹‹åï¼Œç»™å¤§å®¶çš„æ„Ÿè§‰å°±æ˜¯Spring Cloudåšå®ƒæœ€æ“…é•¿çš„äº‹ï¼Œä¹Ÿå°±æ˜¯é«˜åº¦æŠ½è±¡å’Œå°è£…ï¼Œå¼ºå¼ºè”æ‰‹æ•´åˆæœ€ä¼˜ä¸œè¥¿ä¸ºæˆ‘æ‰€ç”¨ï¼Œæ¯”å¦‚Netflixå¼€æºçš„Eurekaï¼ŒHystrixï¼ŒRibbonç­‰ã€‚è€Œä¸”æä¾›å¤šç§æŠ€æœ¯é€‰å‹ï¼Œæ€åº¦ä¸­ç«‹è€Œé€‰æœ€ä¼˜ã€‚8å¤©å‰ä¹Ÿå°±æ˜¯2018å¹´11æœˆ19å·å·¦å³ï¼ŒNetflixçš„å¼€æºé¡¹ç›®Hystrixå®£å¸ƒçŠ¶æ€ï¼Œä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œå¤„äºç»´æŠ¤çŠ¶æ€ã€‚å¼•å‘æœ‹å‹åœˆçš„ä¸€äº›æ€è€ƒã€‚ è™½ç„¶Eurekaï¼ŒHystrixç­‰ä¸å†ç»§ç»­å¼€å‘æˆ–ç»´æŠ¤ï¼Œä½†æ˜¯ç›®å‰æ¥è¯´ä¸å½±å“ä½¿ç”¨ï¼Œä¸ç®¡æ€ä¹ˆè¯´æ„Ÿè°¢å¼€æºï¼Œå‘Netflixå…¬å¸çš„å¼€æºè‡´æ•¬ã€‚ éšç€Spring Cloudç”Ÿæ€åœˆçš„å‘å±•ä¸æˆé•¿ï¼ŒSpring Cloudé™†ç»­æ¨å‡ºäº†è‡ªå·±çš„ä¸€äº›ç»„ä»¶ï¼ŒæŒ‘é€‰ä¸»è¦ç»„ä»¶è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤º: ç»„ä»¶ æ¥æº è¯´æ˜ Spring-cloud-openfeign åŸºäºFeignçš„å‡çº§ æœåŠ¡ä¹‹é—´è°ƒç”¨çš„å¿…å¤‡ç»„ä»¶ spring-cloud-zuul æ¥æºäºNetflix Zuul ç›®å‰è¿˜åœ¨ç»§ç»­ç»´æŠ¤ï¼Œä½†æ˜¯å·²ç»æœ‰è‡ªå·±çš„Spring Cloud Gateway,ä¸ä¹…å°†æ¥é€æ¸æ·˜æ±° spring-cloud-eureka é›†æˆäºNetflix Eureka ç›®å‰è¿˜åœ¨è·ŸéšSpring Cloudç‰ˆæœ¬å‡çº§ç»´æŠ¤ï¼Œæœ€ç»ˆä¹Ÿä¼šè¢«æ›¿ä»£ spring-cloud-config è‡ªç ” åŠŸèƒ½ä¸è¶³ï¼Œå›½å†…ä½¿ç”¨å…¶å®ƒé…ç½®ä¸­å¿ƒæ›¿ä»£ï¼Œæ¯”å¦‚æºç¨‹çš„Apollo å…¨é“¾è·¯ç›‘æ§(sleuth+zikpinæˆ–pinpont) sleuthè‡ªç ”ï¼Œå…¶å®ƒç¬¬ä¸‰æ–¹ å›½å†…ç›®å‰ä½¿ç”¨æœ€å¤šçš„æ˜¯skywalingç­‰ä¸Šç”Ÿäº§ spring-cloud-ribbon æ¥æºäºNetflixé›†æˆ ribbonç›®å‰è¿˜åœ¨è·ŸéšSpring Cloudç‰ˆæœ¬ç»´æŠ¤ä¸­ï¼Œç›®å‰å­µåŒ–æœªæ¥æ›¿ä»£å“spring-cloud-lb Spring-cloud-hystrix æ¥æºäºNetflixé›†æˆ ç›®å‰è¿˜åœ¨è·ŸéšSpring Cloudç‰ˆæœ¬ç»´æŠ¤ä¸­ç›®å‰å·²ç»å­µåŒ–spring-cloud-r4j 2. Spring Cloud ç¬¬äºŒä»£ Spring Cloudç¬¬ä¸€ä»£å’Œç¬¬äºŒä»£çš„ç»„ä»¶ç»„åˆæ±‡æ€»ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚ Spring Cloudç¬¬ä¸€ä»£ Spring Cloudç¬¬äºŒä»£ ç½‘å…³ Spring Cloud Zuul Spring Cloud Gateway æ³¨å†Œä¸­å¿ƒ eureka(ä¸å†æ›´æ–°)ï¼ŒConsul,ZK é˜¿é‡ŒNacosï¼Œæ‹æ‹è´·radarç­‰å¯é€‰ é…ç½®ä¸­å¿ƒ spring cloud config é˜¿é‡ŒNacosï¼Œæºç¨‹Apolloï¼Œéšè¡Œä»˜Config Keeper å®¢æˆ·ç«¯è½¯è´Ÿè½½å‡è¡¡ Ribbon spring-cloud-loadbalancer ç†”æ–­å™¨ Hystrix spring-cloud-r4j(Resilience4J)ï¼Œé˜¿é‡ŒSentinel ç”±äºZuulæ€§èƒ½ä¸€èˆ¬ï¼Œzuul 2.x(ä¸€ç›´è·³ç¥¨ï¼Œè™½æœ€ç»ˆå¼€æºï¼‰ä½†æ˜¯Spring Cloudå®˜æ–¹å·²ç»æ¨å‡ºSpring Cloud gateway,Spring Cloudä¸­å›½ç¤¾åŒºå¾ˆä¹…ä¹‹å‰å·²ç»è¯å®ï¼ŒSpring Cloudå°†ä¸ä¼šé›†æˆzuul 2.xï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä¸å°±æœªæ¥Zuulå°†ä»Spring Cloudç”Ÿæ€åœˆä¸­é€€å‡ºã€‚ ribbonç”±äºä¸æ”¯æŒwebFluxçš„è´Ÿè½½å‡è¡¡ï¼ŒSpring Cloudå®˜æ–¹å¾ˆæ—©å°±åœ¨å­µåŒ–å™¨é¡¹ç›®ä¸­å­µåŒ–spring-cloud-loadbalancerï¼Œç›®å‰å·²ç»å°†ä»£ç åˆå¹¶åˆ°spring-cloud-commonä¸­ï¼Œé¢„è®¡åœ¨Spring Cloud Gç‰ˆå¯ä»¥ä½¿ç”¨ï¼Œé¢„è®¡2018å¹´12æœˆåº•realeseã€‚ è‡³äºHystrixï¼ŒNetflixåœ¨2018å¹´11æœˆ19å·å·¦å³ï¼ŒNetflixçš„å¼€æºé¡¹ç›®Hystrixå®£å¸ƒçŠ¶æ€ï¼Œä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œå¤„äºç»´æŠ¤çŠ¶æ€ï¼Œå…¶å®åœ¨ä¹‹å‰Spring Cloudå®˜æ–¹å°±åœ¨å­µåŒ–spring-cloud-r4j. 3.å¼€æºé¡¹ç›®çš„é“¾æ¥æœ¬æ–‡æ‰€æåˆ°çš„å¼€æºé¡¹ç›®é“¾æ¥æ±‡æ€»å¦‚ä¸‹æ‰€ç¤ºï¼š https://github.com/alibaba/Sentinel https://github.com/spring-cloud-incubator/spring-cloud-r4j é˜¿é‡ŒNacos-https://github.com/alibaba/nacos éšè¡Œä»˜Config-keeper-https://github.com/sxfad/config-keeper spring-cloud-loadbalancer https://github.com/ctripcorp/apollo https://github.com/apache/incubator-skywalking","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://xujin.org/categories/Spring-Cloud/"}],"tags":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://xujin.org/tags/Spring-Cloud/"}]},{"title":"ä½¿ç”¨Nacoså®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±","slug":"sc/gw/gw10","date":"2018-11-17T06:00:00.000Z","updated":"2019-01-12T03:33:48.579Z","comments":true,"path":"sc/gw/gw10/","link":"","permalink":"http://xujin.org/sc/gw/gw10/","excerpt":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦ä»‹ç»é€šè¿‡Nacosä¸‹å‘è·¯ç”±é…ç½®å®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚ 1.å‰è¨€ ç½‘å…³ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯è·¯ç”±é…ç½®å’Œè·¯ç”±è§„åˆ™ï¼Œè·¯ç”±é…ç½®æ˜¯æŒ‡é…ç½®æŸè¯·æ±‚è·¯å¾„è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°å€ã€‚è€Œè·¯ç”±è§„åˆ™æ˜¯æŒ‡åŒ¹é…åˆ°è·¯ç”±é…ç½®ä¹‹åï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè½¬å‘å¤„ç†ã€‚ Spring Cloud Gatewayä½œä¸ºæ‰€æœ‰è¯·æ±‚æµé‡çš„å…¥å£ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†ä¿è¯é«˜å¯é å’Œé«˜å¯ç”¨ï¼Œå°½é‡é¿å…é‡å¯,éœ€è¦å®ç°Spring Cloud GatewayåŠ¨æ€è·¯ç”±é…ç½®ã€‚å‰é¢ç« èŠ‚ä»‹ç»äº†Spring Cloud Gatewayæä¾›çš„ä¸¤ç§æ–¹æ³•å»é…ç½®è·¯ç”±è§„åˆ™ï¼Œä½†éƒ½æ˜¯åœ¨Spring Cloud Gatewayå¯åŠ¨æ—¶å€™ï¼Œå°±å°†è·¯ç”±é…ç½®å’Œè§„åˆ™åŠ è½½åˆ°å†…å­˜é‡Œï¼Œæ— æ³•åšåˆ°ä¸é‡å¯ç½‘å…³å°±å¯ä»¥åŠ¨æ€çš„å¯¹åº”è·¯ç”±çš„é…ç½®å’Œè§„åˆ™è¿›è¡Œå¢åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ã€‚æœ¬æ–‡æ˜¯åŸºäºSpring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±å®ç°åŸºç¡€ä¹‹ä¸Šç¼–å†™ï¼Œé€šè¿‡Nacosé…ç½®æœåŠ¡ä¸‹å‘è·¯ç”±é…ç½®å®ç°åŠ¨æ€è·¯ç”±ã€‚","text":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦ä»‹ç»é€šè¿‡Nacosä¸‹å‘è·¯ç”±é…ç½®å®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚ 1.å‰è¨€ ç½‘å…³ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯è·¯ç”±é…ç½®å’Œè·¯ç”±è§„åˆ™ï¼Œè·¯ç”±é…ç½®æ˜¯æŒ‡é…ç½®æŸè¯·æ±‚è·¯å¾„è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°å€ã€‚è€Œè·¯ç”±è§„åˆ™æ˜¯æŒ‡åŒ¹é…åˆ°è·¯ç”±é…ç½®ä¹‹åï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè½¬å‘å¤„ç†ã€‚ Spring Cloud Gatewayä½œä¸ºæ‰€æœ‰è¯·æ±‚æµé‡çš„å…¥å£ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†ä¿è¯é«˜å¯é å’Œé«˜å¯ç”¨ï¼Œå°½é‡é¿å…é‡å¯,éœ€è¦å®ç°Spring Cloud GatewayåŠ¨æ€è·¯ç”±é…ç½®ã€‚å‰é¢ç« èŠ‚ä»‹ç»äº†Spring Cloud Gatewayæä¾›çš„ä¸¤ç§æ–¹æ³•å»é…ç½®è·¯ç”±è§„åˆ™ï¼Œä½†éƒ½æ˜¯åœ¨Spring Cloud Gatewayå¯åŠ¨æ—¶å€™ï¼Œå°±å°†è·¯ç”±é…ç½®å’Œè§„åˆ™åŠ è½½åˆ°å†…å­˜é‡Œï¼Œæ— æ³•åšåˆ°ä¸é‡å¯ç½‘å…³å°±å¯ä»¥åŠ¨æ€çš„å¯¹åº”è·¯ç”±çš„é…ç½®å’Œè§„åˆ™è¿›è¡Œå¢åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ã€‚æœ¬æ–‡æ˜¯åŸºäºSpring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±å®ç°åŸºç¡€ä¹‹ä¸Šç¼–å†™ï¼Œé€šè¿‡Nacosé…ç½®æœåŠ¡ä¸‹å‘è·¯ç”±é…ç½®å®ç°åŠ¨æ€è·¯ç”±ã€‚ 2. Spring Cloud Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°Spring Cloud Gatewayçš„å®˜æ–¹æ–‡æ¡£å¹¶æ²¡æœ‰è®²å¦‚ä½•åŠ¨æ€é…ç½®ï¼ŒæŸ¥çœ‹ Spring Cloud Gatewayçš„æºç ï¼Œå‘ç°åœ¨org.springframework.cloud.gateway.actuate.GatewayControllerEndpointç±»ä¸­æä¾›äº†åŠ¨æ€é…ç½®çš„Restæ¥å£ï¼Œä½†æ˜¯éœ€è¦å¼€å¯Gatewayçš„ç«¯ç‚¹ï¼Œè€Œä¸”æä¾›çš„åŠŸèƒ½ä¸æ˜¯å¾ˆå¼ºå¤§ã€‚é€šè¿‡å‚è€ƒå’ŒGatewayControllerEndpointç›¸å…³çš„ä»£ç ï¼Œå¯ä»¥è‡ªå·±ç¼–ç å®é™…åŠ¨æ€è·¯ç”±é…ç½®ã€‚ä¸‹é¢é€šè¿‡æ¡ˆä¾‹çš„æ–¹å¼å»è®²è§£æ€ä¹ˆé€šNacoså®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚æ¡ˆä¾‹å·¥ç¨‹å¦‚spring-cloud-gateway-nacosæ‰€ç¤ºã€‚ ä»£ç åœ°å€:https://github.com/SpringCloud/spring-cloud-gateway-nacos 3. ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°3.1 æ–°å»ºMavenå·¥ç¨‹sc-gateway-server é…ç½®ä¸»è¦çš„æ ¸å¿ƒä¾èµ–å¦‚ä»£ç æ¸…å•æ‰€ç¤ºï¼š ä»£ç æ¸…å•: spring-cloud-gateway-nacos/sc-gateway-server/pom.xml123456789101112131415161718192021222324252627&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba.nacos&lt;/groupId&gt; &lt;artifactId&gt;nacos-client&lt;/artifactId&gt; &lt;version&gt;0.4.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;1.2.47&lt;/version&gt;&lt;/dependency&gt; 3.2 æ ¹æ®Spring Cloud Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹ åˆ†åˆ«åˆ›å»ºGatewayRouteDefinition.java, GatewayPredicateDefinition.java, GatewayFilterDefinition.javaè¿™ä¸‰ä¸ªç±»ã€‚(1) åˆ›å»ºè·¯ç”±å®šä¹‰æ¨¡å‹ 12345678910111213public class GatewayRouteDefinition &#123; //è·¯ç”±çš„Id private String id; //è·¯ç”±æ–­è¨€é›†åˆé…ç½® private List&lt;GatewayPredicateDefinition&gt; predicates = new ArrayList&lt;&gt;(); //è·¯ç”±è¿‡æ»¤å™¨é›†åˆé…ç½® private List&lt;GatewayFilterDefinition&gt; filters = new ArrayList&lt;&gt;(); //è·¯ç”±è§„åˆ™è½¬å‘çš„ç›®æ ‡uri private String uri; //è·¯ç”±æ‰§è¡Œçš„é¡ºåº private int order = 0; //æ­¤å¤„çœç•¥getå’Œsetæ–¹æ³•&#125; (2)åˆ›å»ºè¿‡æ»¤å™¨å®šä¹‰æ¨¡å‹ 1234567public class GatewayFilterDefinition &#123; //Filter Name private String name; //å¯¹åº”çš„è·¯ç”±è§„åˆ™ private Map&lt;String, String&gt; args = new LinkedHashMap&lt;&gt;(); //æ­¤å¤„çœç•¥Getå’ŒSetæ–¹æ³•&#125; (3)åˆ›å»ºè·¯ç”±æ–­è¨€å®šä¹‰æ¨¡å‹ 1234567public class GatewayPredicateDefinition &#123; //æ–­è¨€å¯¹åº”çš„Name private String name; //é…ç½®çš„æ–­è¨€è§„åˆ™ private Map&lt;String, String&gt; args = new LinkedHashMap&lt;&gt;(); //æ­¤å¤„çœç•¥Getå’ŒSetæ–¹æ³•&#125; 3.3 ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»ç¼–å†™DynamicRouteServiceImplå¹¶å®ç°ApplicationEventPublisherAwareæ¥å£ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º 12345678910111213141516171819202122232425262728293031323334353637@Servicepublic class DynamicRouteServiceImpl implements ApplicationEventPublisherAware &#123; @Autowired private RouteDefinitionWriter routeDefinitionWriter; private ApplicationEventPublisher publisher; //å¢åŠ è·¯ç”± public String add(RouteDefinition definition) &#123; routeDefinitionWriter.save(Mono.just(definition)).subscribe(); this.publisher.publishEvent(new RefreshRoutesEvent(this)); return \"success\"; &#125; //æ›´æ–°è·¯ç”± public String update(RouteDefinition definition) &#123; try &#123; this.routeDefinitionWriter.delete(Mono.just(definition.getId())); &#125; catch (Exception e) &#123; return \"update fail,not find route routeId: \"+definition.getId(); &#125; try &#123; routeDefinitionWriter.save(Mono.just(definition)).subscribe(); this.publisher.publishEvent(new RefreshRoutesEvent(this)); return \"success\"; &#125; catch (Exception e) &#123; return \"update route fail\"; &#125; &#125; //åˆ é™¤è·¯ç”± public Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(String id) &#123; return this.routeDefinitionWriter.delete(Mono.just(id)) .then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build()))) .onErrorResume(t -&gt; t instanceof NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build())); &#125; @Override public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) &#123; this.publisher = applicationEventPublisher; &#125;&#125; 3.4 ç¼–å†™Nacosç›‘å¬æ¥æ”¶ä¸‹å‘çš„è·¯ç”±é…ç½®3.4.1 ä½¿ç”¨Nacosç›‘å¬ä¸‹å‘çš„é…ç½®ç›‘å¬Nacos Config Serverä¸‹å‘é…ç½®çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š 1234567891011121314151617181920212223242526272829303132333435363738@Componentpublic class DynamicRouteServiceImplByNacos &#123; @Autowired private DynamicRouteServiceImpl dynamicRouteService; public DynamicRouteServiceImplByNacos() &#123; dynamicRouteByNacosListener(\"sc-gateway\",\"xujin_test\"); &#125; /** * ç›‘å¬Nacos Serverä¸‹å‘çš„åŠ¨æ€è·¯ç”±é…ç½® * @param dataId * @param group */ public void dynamicRouteByNacosListener (String dataId, String group)&#123; try &#123; ConfigService configService=NacosFactory.createConfigService(\"127.0.0.1:8848\"); String content = configService.getConfig(dataId, group, 5000); System.out.println(content); configService.addListener(dataId, group, new Listener() &#123; @Override public void receiveConfigInfo(String configInfo) &#123; RouteDefinition definition= JSON.parseObject(configInfo,RouteDefinition.class); dynamicRouteService.update(definition); &#125; @Override public Executor getExecutor() &#123; return null; &#125; &#125;); &#125; catch (NacosException e) &#123; //todo æé†’:å¼‚å¸¸è‡ªè¡Œå¤„ç†æ­¤å¤„çœç•¥ &#125; &#125;&#125; 3.4.2 ä¸¤ç§æ–¹å¼åˆ›å»ºConfigServiceä½¿ç”¨ä¸¤ç§æ–¹å¼åˆ›å»ºcom.alibaba.nacos.api.config.ConfigService 1.æ„å»ºPropertiesåˆ›å»º ä½¿ç”¨createConfigService(Properties properties)ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:1234Properties properties = new Properties(); properties.put(\"nacos.server-addr\", \"\"); properties.put(PropertyKeyConst.SERVER_ADDR, \"127.0.0.1:8848\"); ConfigService configService=NacosFactory.createConfigService(properties); æ³¨æ„:PropertyKeyConstæ˜¯com.alibaba.nacos.api.PropertyKeyConst 2.åªä¼ é€’Nacos Config Serverçš„åœ°å€ 1ConfigService configService=NacosFactory.createConfigService(\"127.0.0.1:8848\"); 4. ä½¿ç”¨Nacosä¸‹å‘é…ç½®4.1 Nacosæ¦‚è¿° Naocsç”±é˜¿é‡Œå¼€æºï¼ŒNacos è‡´åŠ›äºå¸®åŠ©æ‚¨å‘ç°ã€é…ç½®å’Œç®¡ç†å¾®æœåŠ¡ã€‚Nacos æä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚ Nacos å¸®åŠ©æ‚¨æ›´æ•æ·å’Œå®¹æ˜“åœ°æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡å¹³å°ã€‚ Nacos æ˜¯æ„å»ºä»¥â€œæœåŠ¡â€ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ (ä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼) çš„æœåŠ¡åŸºç¡€è®¾æ–½ã€‚githubåœ°å€:https://github.com/alibaba/nacos æ›´å¤šNacosçš„ä»‹ç»ï¼Œè¯·è®¿é—®å®˜æ–¹ç½‘ç«™:https://nacos.io/ 4.2 åœ¨IDEä¸­å¯åŠ¨ Nacosè®¿é—®https://github.com/alibaba/nacos ,ä½¿ç”¨Gitå…‹éš†Nacosä»£ç ï¼Œç›´æ¥å¯¼å…¥åˆ°IDEAä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºè®¾ç½®å¯åŠ¨å‚æ•°ï¼Œç›´æ¥å¯åŠ¨ã€‚ ä»IDEä¸­å¯åŠ¨Nacosæ˜¯æˆ‘æ¯”è¾ƒæ¨èçš„æ–¹å¼ï¼Œå› ä¸ºå¯ä»¥éšæ—¶Debug Nacosä»»ä½•ä»£ç ï¼Œå…¶å®ƒå¯åŠ¨æ–¹å¼è¯·å‚è€ƒå®˜ç½‘ã€‚ 5.æµ‹è¯•5.1 Nacosä¸­ä¸‹å‘Spring Cloud Gatewayçš„è·¯ç”±é…ç½® 1.æ‰“å¼€æµè§ˆå™¨è®¿é—®URL:http://localhost:8848/nacos/index.html ,Nacosçš„ç®¡æ§å¹³å°å¦‚ä¸‹æ‰€ç¤º: 2.åœ¨Nacosçš„é…ç½®åˆ—è¡¨ç‚¹å‡»+æŒ‰é’®ï¼Œä¸‹å‘Spring Cloud Gatewayçš„è·¯ç”±é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤º: ç”¨äºæµ‹è¯•çš„ç¤ºä¾‹æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤º: 123456789101112&#123; \"filters\": [], \"id\": \"jd_route\", \"order\": 0, \"predicates\": [&#123; \"args\": &#123; \"pattern\": \"/jd\" &#125;, \"name\": \"Path\" &#125;], \"uri\": \"http://www.jd.com\"&#125; 5.2 å¯åŠ¨sc-gateway-server 1.Debugå¯åŠ¨sc-gateway-server,è°ƒè¯•æˆªå›¾å¦‚ä¸‹æ‰€ç¤º: 2.é€šè¿‡Spring Cloud gatewayçš„ç«¯ç‚¹ï¼ŒæŸ¥çœ‹è·¯ç”±ä¿¡æ¯ 3.é€šè¿‡è®¿é—®http://localhost:8080/jd ,å¯ä»¥è½¬å‘åˆ°äº¬ä¸œå•†åŸä¸»é¡µ 5.3 æ›´æ–°è·¯ç”±é…ç½® 1.é€šè¿‡Nacosä¸‹å‘é…ç½®ï¼Œä¿®æ”¹Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±è§„åˆ™ 2.æŸ¥çœ‹è®¿é—®Spring Cloud gatewayçš„ç«¯ç‚¹é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°åŠ¨æ€è·¯ç”±ä¿®æ”¹å¦‚ä¸‹: 3.é€šè¿‡è®¿é—®http://localhost:8080/jd ,å¯ä»¥è½¬å‘åˆ°ç™¾åº¦ç›¸å…³é¡µé¢","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±å®ç°","slug":"sc/gw/gw09","date":"2018-11-03T06:00:00.000Z","updated":"2019-01-12T03:33:39.419Z","comments":true,"path":"sc/gw/gw09/","link":"","permalink":"http://xujin.org/sc/gw/gw09/","excerpt":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±çš„ç®€å•å®ç°æ–¹å¼ã€‚ 1.å‰è¨€ ç½‘å…³ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯è·¯ç”±é…ç½®å’Œè·¯ç”±è§„åˆ™ï¼Œè·¯ç”±é…ç½®æ˜¯æŒ‡é…ç½®æŸè¯·æ±‚è·¯å¾„è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°å€ã€‚è€Œè·¯ç”±è§„åˆ™æ˜¯æŒ‡åŒ¹é…åˆ°è·¯ç”±é…ç½®ä¹‹åï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè½¬å‘å¤„ç†ã€‚ Spring Cloud Gatewayä½œä¸ºæ‰€æœ‰è¯·æ±‚æµé‡çš„å…¥å£ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†ä¿è¯é«˜å¯é å’Œé«˜å¯ç”¨ï¼Œå°½é‡é¿å…é‡å¯,éœ€è¦å®ç°Spring Cloud GatewayåŠ¨æ€è·¯ç”±é…ç½®ã€‚å‰é¢ç« èŠ‚ä»‹ç»äº†Spring Cloud Gatewayæä¾›çš„ä¸¤ç§æ–¹æ³•å»é…ç½®è·¯ç”±è§„åˆ™ï¼Œä½†éƒ½æ˜¯åœ¨Spring Cloud Gatewayå¯åŠ¨æ—¶å€™ï¼Œå°±å°†è·¯ç”±é…ç½®å’Œè§„åˆ™åŠ è½½åˆ°å†…å­˜é‡Œï¼Œæ— æ³•åšåˆ°ä¸é‡å¯ç½‘å…³å°±å¯ä»¥åŠ¨æ€çš„å¯¹åº”è·¯ç”±çš„é…ç½®å’Œè§„åˆ™è¿›è¡Œå¢åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ã€‚æœ¬ç¯‡æ–‡ç« ç®€å•ä»‹ç»å¦‚ä½•å®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚","text":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±çš„ç®€å•å®ç°æ–¹å¼ã€‚ 1.å‰è¨€ ç½‘å…³ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯è·¯ç”±é…ç½®å’Œè·¯ç”±è§„åˆ™ï¼Œè·¯ç”±é…ç½®æ˜¯æŒ‡é…ç½®æŸè¯·æ±‚è·¯å¾„è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°å€ã€‚è€Œè·¯ç”±è§„åˆ™æ˜¯æŒ‡åŒ¹é…åˆ°è·¯ç”±é…ç½®ä¹‹åï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè½¬å‘å¤„ç†ã€‚ Spring Cloud Gatewayä½œä¸ºæ‰€æœ‰è¯·æ±‚æµé‡çš„å…¥å£ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†ä¿è¯é«˜å¯é å’Œé«˜å¯ç”¨ï¼Œå°½é‡é¿å…é‡å¯,éœ€è¦å®ç°Spring Cloud GatewayåŠ¨æ€è·¯ç”±é…ç½®ã€‚å‰é¢ç« èŠ‚ä»‹ç»äº†Spring Cloud Gatewayæä¾›çš„ä¸¤ç§æ–¹æ³•å»é…ç½®è·¯ç”±è§„åˆ™ï¼Œä½†éƒ½æ˜¯åœ¨Spring Cloud Gatewayå¯åŠ¨æ—¶å€™ï¼Œå°±å°†è·¯ç”±é…ç½®å’Œè§„åˆ™åŠ è½½åˆ°å†…å­˜é‡Œï¼Œæ— æ³•åšåˆ°ä¸é‡å¯ç½‘å…³å°±å¯ä»¥åŠ¨æ€çš„å¯¹åº”è·¯ç”±çš„é…ç½®å’Œè§„åˆ™è¿›è¡Œå¢åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ã€‚æœ¬ç¯‡æ–‡ç« ç®€å•ä»‹ç»å¦‚ä½•å®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚ 2. Spring Cloud Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°Spring Cloud Gatewayçš„å®˜æ–¹æ–‡æ¡£å¹¶æ²¡æœ‰è®²å¦‚ä½•åŠ¨æ€é…ç½®ï¼ŒæŸ¥çœ‹ Spring Cloud Gatewayçš„æºç ï¼Œå‘ç°åœ¨org.springframework.cloud.gateway.actuate.GatewayControllerEndpointç±»ä¸­æä¾›äº†åŠ¨æ€é…ç½®çš„Restæ¥å£ï¼Œä½†æ˜¯éœ€è¦å¼€å¯Gatewayçš„ç«¯ç‚¹ï¼Œè€Œä¸”æä¾›çš„åŠŸèƒ½ä¸æ˜¯å¾ˆå¼ºå¤§ã€‚é€šè¿‡å‚è€ƒå’ŒGatewayControllerEndpointç›¸å…³çš„ä»£ç ï¼Œå¯ä»¥è‡ªå·±ç¼–ç å®é™…åŠ¨æ€è·¯ç”±é…ç½®ã€‚ä¸‹é¢é€šè¿‡æ¡ˆä¾‹çš„æ–¹å¼å»è®²è§£æ€ä¹ˆå®ç°Gatewayçš„åŠ¨æ€è·¯ç”±é…ç½®ã€‚æ¡ˆä¾‹å·¥ç¨‹å¦‚ch18-7-gatewayæ‰€ç¤ºã€‚ ä»£ç åœ°å€:https://github.com/SpringCloud/spring-cloud-code/blob/master/ch18-7/ch18-7-gateway 3. ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°3.1 æ–°å»ºMavenå·¥ç¨‹ch18-7-gateway é…ç½®ä¸»è¦çš„æ ¸å¿ƒä¾èµ–å¦‚ä»£ç æ¸…å•18-33æ‰€ç¤ºï¼š ä»£ç æ¸…å•: ch18-7/ch18-7-gateway/pom.xml1234567891011121314&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; 3.2 æ ¹æ®Spring Cloud Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹ åˆ†åˆ«åˆ›å»ºGatewayRouteDefinition.java, GatewayPredicateDefinition.java, GatewayFilterDefinition.javaè¿™ä¸‰ä¸ªç±»ã€‚(1) åˆ›å»ºè·¯ç”±å®šä¹‰æ¨¡å‹å¦‚ä¸‹ä»£ç æ¸…å•18-34æ‰€ç¤ºï¼šä»£ç æ¸…å• 18-34: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayRouteDefinition.java 12345678910111213public class GatewayRouteDefinition &#123; //è·¯ç”±çš„Id private String id; //è·¯ç”±æ–­è¨€é›†åˆé…ç½® private List&lt;GatewayPredicateDefinition&gt; predicates = new ArrayList&lt;&gt;(); //è·¯ç”±è¿‡æ»¤å™¨é›†åˆé…ç½® private List&lt;GatewayFilterDefinition&gt; filters = new ArrayList&lt;&gt;(); //è·¯ç”±è§„åˆ™è½¬å‘çš„ç›®æ ‡uri private String uri; //è·¯ç”±æ‰§è¡Œçš„é¡ºåº private int order = 0; //æ­¤å¤„çœç•¥getå’Œsetæ–¹æ³•&#125; (2)åˆ›å»ºè¿‡æ»¤å™¨å®šä¹‰æ¨¡å‹,ä»£ç å¦‚ä»£ç æ¸…å•18-35æ‰€ç¤ºï¼šä»£ç æ¸…å•18-35: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayFilterDefinition.java 1234567public class GatewayFilterDefinition &#123; //Filter Name private String name; //å¯¹åº”çš„è·¯ç”±è§„åˆ™ private Map&lt;String, String&gt; args = new LinkedHashMap&lt;&gt;(); //æ­¤å¤„çœç•¥Getå’ŒSetæ–¹æ³•&#125; (3)è·¯ç”±æ–­è¨€å®šä¹‰æ¨¡å‹ï¼Œä»£ç å¦‚ä»£ç æ¸…å•18-36æ‰€ç¤º:ä»£ç æ¸…å•18-36: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayPredicateDefinition.java 1234567public class GatewayPredicateDefinition &#123; //æ–­è¨€å¯¹åº”çš„Name private String name; //é…ç½®çš„æ–­è¨€è§„åˆ™ private Map&lt;String, String&gt; args = new LinkedHashMap&lt;&gt;(); //æ­¤å¤„çœç•¥Getå’ŒSetæ–¹æ³•&#125; 3.3 ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»ç¼–å†™DynamicRouteServiceImplå¹¶å®ç°ApplicationEventPublisherAwareæ¥å£ï¼Œä»£ç å¦‚ä»£ç æ¸…å•18-37æ‰€ç¤º: ch18-37/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/route/DynamicRouteServiceImpl.java 12345678910111213141516171819202122232425262728293031323334353637@Servicepublic class DynamicRouteServiceImpl implements ApplicationEventPublisherAware &#123; @Autowired private RouteDefinitionWriter routeDefinitionWriter; private ApplicationEventPublisher publisher; //å¢åŠ è·¯ç”± public String add(RouteDefinition definition) &#123; routeDefinitionWriter.save(Mono.just(definition)).subscribe(); this.publisher.publishEvent(new RefreshRoutesEvent(this)); return \"success\"; &#125; //æ›´æ–°è·¯ç”± public String update(RouteDefinition definition) &#123; try &#123; this.routeDefinitionWriter.delete(Mono.just(definition.getId())); &#125; catch (Exception e) &#123; return \"update fail,not find route routeId: \"+definition.getId(); &#125; try &#123; routeDefinitionWriter.save(Mono.just(definition)).subscribe(); this.publisher.publishEvent(new RefreshRoutesEvent(this)); return \"success\"; &#125; catch (Exception e) &#123; return \"update route fail\"; &#125; &#125; //åˆ é™¤è·¯ç”± public Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(String id) &#123; return this.routeDefinitionWriter.delete(Mono.just(id)) .then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build()))) .onErrorResume(t -&gt; t instanceof NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build())); &#125; @Override public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) &#123; this.publisher = applicationEventPublisher; &#125;&#125; 3.4 ç¼–å†™Restæ¥å£ç¼–å†™RouteControllerç±»çš„æä¾›Restæ¥å£ï¼Œç”¨äºåŠ¨æ€è·¯ç”±é…ç½®ã€‚ä»£ç å¦‚ä»£ç æ¸…å•18-38æ‰€ç¤º:ä»£ç æ¸…å• 18-38: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/controller/RouteController.java 1234567891011121314151617181920212223242526272829@RestController@RequestMapping(\"/route\")public class RouteController &#123; @Autowired private DynamicRouteServiceImpl dynamicRouteService; //å¢åŠ è·¯ç”± @PostMapping(\"/add\") public String add(@RequestBody GatewayRouteDefinition gwdefinition) &#123; try &#123; RouteDefinition definition = assembleRouteDefinition(gwdefinition); return this.dynamicRouteService.add(definition); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return \"succss\"; &#125; //åˆ é™¤è·¯ç”± @DeleteMapping(\"/routes/&#123;id&#125;\") public Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(@PathVariable String id) &#123; return this.dynamicRouteService.delete(id); &#125; //æ›´æ–°è·¯ç”± @PostMapping(\"/update\") public String update(@RequestBody GatewayRouteDefinition gwdefinition) &#123; RouteDefinition definition = assembleRouteDefinition(gwdefinition); return this.dynamicRouteService.update(definition); &#125;&#125; 3.5 é…ç½®application.ymlæ–‡ä»¶åœ¨application.ymlæ–‡ä»¶é…ç½®åº”ç”¨çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶å¼€å¯Spring Cloud Gatewayå¯¹å¤–æä¾›çš„ç«¯ç‚¹Restæ¥å£ã€‚ä»£ç å¦‚ä»£ç æ¸…å•18-39æ‰€ç¤º:ä»£ç æ¸…å• 18-39: ch18-7/ch18-7-gateway/src/main/resources/application.ymlé…ç½®è¾“å‡ºæ—¥å¿—å¦‚ä¸‹æ‰€ç¤º:123456789101112131415# é…ç½®è¾“å‡ºæ—¥å¿—logging: level: org.springframework.cloud.gateway: TRACE org.springframework.http.server.reactive: DEBUG org.springframework.web.reactive: DEBUG reactor.ipc.netty: DEBUG#å¼€å¯ç«¯ç‚¹management: endpoints: web: exposure: include: '*' security: enabled: false 3.6 å¯åŠ¨ch18-7-gatewayåº”ç”¨æµ‹è¯•(1) å¯åŠ¨ch18-7-gatewayåº”ç”¨ä¹‹åï¼Œç”±äºå¼€å¯äº†ç«¯ç‚¹ï¼Œé¦–å…ˆæ‰“å¼€æµè§ˆå™¨è®¿é—®ç«¯ç‚¹URL:http://localhost:8080/actuator/gateway/routes ,æŸ¥çœ‹è·¯ç”±ä¿¡æ¯è¿”å›ä¸ºç©ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º: (2)æ‰“å¼€PostManï¼Œè®¿é—®http://localhost:8080/route/add, å‘èµ·Postè¯·æ±‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º,è¿”å›successè¯´æ˜å‘Gatewayå¢åŠ è·¯ç”±é…ç½®æˆåŠŸã€‚ ç„¶åå†æ‰“å¼€PostManè®¿é—®ç«¯ç‚¹URL:http://localhost:8080/actuator/gateway/routes , æŸ¥çœ‹è·¯ç”±ä¿¡æ¯è¿”å›å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æ·»åŠ çš„è·¯ç”±é…ç½®ã€‚ (3) æ‰“å¼€æµè§ˆå™¨è®¿é—®http://localhost:8080/jd, å¯ä»¥æ­£å¸¸è½¬å‘https://www.jd.com/å¯¹åº”çš„äº¬ä¸œå•†åŸé¦–é¡µã€‚(4) é€šè¿‡è®¿é—®http://localhost:8080/route/update, å¯¹idä¸ºjd_routeçš„è·¯ç”±æ›´æ–°é…ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç„¶åå†è®¿é—®è·¯ç”±ç«¯ç‚¹URL,å‘ç°è·¯ç”±é…ç½®å·²ç»è¢«æ›´æ–°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º: ç„¶åé€šè¿‡æµè§ˆå™¨è®¿é—®http://localhost:8080/taobao ,å¯ä»¥æˆåŠŸè½¬å‘åˆ°æ·˜å®ç½‘ã€‚(5) é€šè¿‡è®¿é—®http: //localhost:8080/route/delete/jd_route,å…¶ä¸­çš„idä¸ºè·¯ç”±å¯¹åº”çš„idï¼Œåˆ é™¤è·¯ç”±ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º: 4.Spring Cloud Gatewayæ¨èæ–‡ç« Spring Cloud Gatewayä¸­çš„æƒé‡è·¯ç”±Spring Cloud Gatewayä¸­çš„GatewayFilterå’ŒGlobalFilterSpring Cloud Gatewayåªæœ‰Preå’ŒPOSTä¸¤ç§ç±»å‹çš„FilterSpring Cloud GatewayåŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™Spring Cloud Gatewayçš„Beforeè·¯ç”±æ–­è¨€å·¥å‚Spring Cloud Gatewayçš„Afterè·¯ç”±æ–­è¨€å·¥å‚Spring Cloud Gatewayæ­ç§˜ä¹‹å¤„ç†è¯·æ±‚æµç¨‹Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹ 5.ã€Šé‡æ–°å®šä¹‰Spring Cloudå®æˆ˜ã€‹ä¸­çš„Spring Cloud Gatewayç¬¬17ç« Spring Cloud Gatewayä¸Šç¯‡39917.1 Spring Cloud Gatewayæ¦‚è¿°39917.1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway39917.1.2 Spring Cloud Gatewayçš„æ ¸å¿ƒæ¦‚å¿µ39917.2 Spring Cloud Gatewayçš„å·¥ä½œåŸç†40017.3 Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹40117.4 Spring Cloud Gatewayçš„è·¯ç”±æ–­è¨€40417.4.1 Afterè·¯ç”±æ–­è¨€å·¥å‚40417.4.2 Beforeè·¯ç”±æ–­è¨€å·¥å‚40617.4.3 Betweenè·¯ç”±æ–­è¨€å·¥å‚40617.4.4 Cookieè·¯ç”±æ–­è¨€å·¥å‚40717.4.5 Headerè·¯ç”±æ–­è¨€å·¥å‚40817.4.6 Hostè·¯ç”±æ–­è¨€å·¥å‚41017.4.7 Methodè·¯ç”±æ–­è¨€å·¥å‚41117.4.8 Queryè·¯ç”±æ–­è¨€å·¥å‚41117.4.9 RemoteAddrè·¯ç”±æ–­è¨€å·¥å‚41217.5 Spring Cloud Gatewayçš„å†…ç½®Filter41317.5.1 AddRequestHeaderè¿‡æ»¤å™¨å·¥å‚41317.5.2 AddRequestParameterè¿‡æ»¤å™¨41317.5.3 RewritePathè¿‡æ»¤å™¨41417.5.4 AddResponseHeaderè¿‡æ»¤å™¨41517.5.5 StripPrefixè¿‡æ»¤å™¨41617.5.6 Retryè¿‡æ»¤å™¨41717.5.7 Hystrixè¿‡æ»¤å™¨41817.6 æœ¬ç« å°ç»“420ç¬¬18ç«  Spring Cloud Gatewayä¸‹ç¯‡42118.1 GatewayåŸºäºæœåŠ¡å‘ç°çš„è·¯ç”±è§„åˆ™42118.1.1 Gatewayçš„æœåŠ¡å‘ç°è·¯ç”±æ¦‚è¿°42118.1.2 æœåŠ¡å‘ç°çš„è·¯ç”±è§„åˆ™æ¡ˆä¾‹42218.2 Gateway Filterå’ŒGlobal Filter42518.2.1 Gateway Filterå’ŒGlobal Filteræ¦‚è¿°42518.2.2 è‡ªå®šä¹‰Gateway Filteræ¡ˆä¾‹42518.2.3 è‡ªå®šä¹‰Global Filteræ¡ˆä¾‹42718.3 Spring Cloud Gatewayå®æˆ˜42818.3.1 Spring Cloud Gatewayæƒé‡è·¯ç”±42818.3.2 Spring Cloud Gatewayä¸­Httpsçš„ä½¿ç”¨æŠ€å·§43118.3.3 Spring Cloud Gatewayé›†æˆSwagger43618.3.4 Spring Cloud Gatewayé™æµ44218.3.5 Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±45018.4 Spring Cloud Gatewayæºç ç¯‡45818.4.1 Spring Cloud Gatewayçš„å¤„ç†æµç¨‹45818.4.2 Gatewayä¸­ServerWebExchangeæ„å»ºåˆ†æ45918.4.3 DispatcherHandleræºç åˆ†æ46018.4.4 RoutePredicateHandlerMappingæºç åˆ†æ46118.4.5 FilteringWebHandleræºç åˆ†æ46218.4.6 æ‰§è¡ŒFilteræºç åˆ†æ46318.5 æœ¬ç« å°ç»“465 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273â”œâ”€â”€ ch17-1â”‚ â”œâ”€â”€ ch17-1-1-gatewayâ”‚ â”œâ”€â”€ ch17-1-2-gatewayâ”‚ â”œâ”€â”€ ch17-1.imlâ”‚ â””â”€â”€ pom.xmlâ”œâ”€â”€ ch17-2â”‚ â”œâ”€â”€ ch17-2-1-gatewayâ”‚ â”œâ”€â”€ ch17-2-2-gatewayâ”‚ â”œâ”€â”€ ch17-2-3-gatewayâ”‚ â”œâ”€â”€ ch17-2-4-gatewayâ”‚ â”œâ”€â”€ ch17-2-5-gatewayâ”‚ â”œâ”€â”€ ch17-2-6-gatewayâ”‚ â”œâ”€â”€ ch17-2-7-gatewayâ”‚ â”œâ”€â”€ ch17-2-8-gatewayâ”‚ â”œâ”€â”€ ch17-2-9-gatewayâ”‚ â”œâ”€â”€ ch17-2-serviceâ”‚ â”œâ”€â”€ ch17-2.imlâ”‚ â””â”€â”€ pom.xmlâ”œâ”€â”€ ch17-3â”‚ â”œâ”€â”€ ch17-3-1-gatewayâ”‚ â”œâ”€â”€ ch17-3-2-gatewayâ”‚ â”œâ”€â”€ ch17-3-3-gatewayâ”‚ â”œâ”€â”€ ch17-3-4-gatewayâ”‚ â”œâ”€â”€ ch17-3-5-gatewayâ”‚ â”œâ”€â”€ ch17-3-6-gatewayâ”‚ â”œâ”€â”€ ch17-3-7-gatewayâ”‚ â”œâ”€â”€ ch17-3-serviceâ”‚ â”œâ”€â”€ ch17-3.imlâ”‚ â””â”€â”€ pom.xmlâ”œâ”€â”€ ch18-1â”‚ â”œâ”€â”€ ch18-1-consumerâ”‚ â”œâ”€â”€ ch18-1-eurekaâ”‚ â”œâ”€â”€ ch18-1-gatewayâ”‚ â”œâ”€â”€ ch18-1-providerâ”‚ â”œâ”€â”€ ch18-1.imlâ”‚ â””â”€â”€ pom.xmlâ”œâ”€â”€ ch18-2â”‚ â”œâ”€â”€ ch18-2-gatewayâ”‚ â”œâ”€â”€ ch18-2-providerâ”‚ â”œâ”€â”€ ch18-2.imlâ”‚ â”œâ”€â”€ pom.xmlâ”‚ â””â”€â”€ reademe.txtâ”œâ”€â”€ ch18-3â”‚ â”œâ”€â”€ ch18-3-gatewayâ”‚ â”œâ”€â”€ ch18-3-providerâ”‚ â”œâ”€â”€ ch18-3.imlâ”‚ â””â”€â”€ pom.xmlâ”œâ”€â”€ ch18-4â”‚ â”œâ”€â”€ ch18-4-eurekaâ”‚ â”œâ”€â”€ ch18-4-gateway-httpsâ”‚ â”œâ”€â”€ ch18-4-service-aâ”‚ â”œâ”€â”€ ch18-4-service-bâ”‚ â”œâ”€â”€ ch18-4.imlâ”‚ â”œâ”€â”€ pom.xmlâ”‚ â””â”€â”€ reademe.mdâ”œâ”€â”€ ch18-5â”‚ â”œâ”€â”€ ch18-5-eurekaâ”‚ â”œâ”€â”€ ch18-5-gatewayâ”‚ â”œâ”€â”€ ch18-5-serviceâ”‚ â”œâ”€â”€ ch18-5.imlâ”‚ â””â”€â”€ pom.xmlâ”œâ”€â”€ ch18-6â”‚ â”œâ”€â”€ ch18-6-1-gatewayâ”‚ â”œâ”€â”€ ch18-6-2-gatewayâ”‚ â”œâ”€â”€ ch18-6-3-gatewayâ”‚ â”œâ”€â”€ ch18-6-providerâ”‚ â”œâ”€â”€ ch18-6.imlâ”‚ â””â”€â”€ pom.xmlâ”œâ”€â”€ ch18-7â”‚ â”œâ”€â”€ ch18-7-gatewayâ”‚ â”œâ”€â”€ ch18-7.imlâ”‚ â”œâ”€â”€ pom.xmlâ”‚ â””â”€â”€ readme.md Spring Cloud Gatewayæ‰€æœ‰ç¤ºä¾‹ä»£ç åœ°å€:https://github.com/SpringCloud/spring-cloud-code","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"Spring Cloud Gatewayä¸­çš„æƒé‡è·¯ç”±","slug":"sc/gw/gw08","date":"2018-06-09T06:00:00.000Z","updated":"2019-01-12T03:31:12.149Z","comments":true,"path":"sc/gw/gw08/","link":"","permalink":"http://xujin.org/sc/gw/gw08/","excerpt":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦é€šè¿‡è¿ç”¨Spring Cloud Gatewayçš„WeightRoutePredicateFactoryå¯¹URLè¿›è¡Œæƒé‡è·¯ç”±ã€‚","text":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦é€šè¿‡è¿ç”¨Spring Cloud Gatewayçš„WeightRoutePredicateFactoryå¯¹URLè¿›è¡Œæƒé‡è·¯ç”±ã€‚ 1.æƒé‡è·¯ç”±1.1 æƒé‡è·¯ç”±ä½¿ç”¨åœºæ™¯åœ¨å¼€å‘æˆ–è€…æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ–è€…çº¿ä¸Šå‘å¸ƒï¼Œçº¿ä¸ŠæœåŠ¡å¤šç‰ˆæœ¬æ§åˆ¶çš„æ—¶å€™ï¼Œéœ€è¦å¯¹æœåŠ¡æä¾›æƒé‡è·¯ç”±ï¼Œæœ€å¸¸è§çš„ä½¿ç”¨å°±æ˜¯ï¼Œä¸€ä¸ªæœåŠ¡æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬V1ï¼Œæ–°ç‰ˆæœ¬v2ã€‚åœ¨çº¿ä¸Šç°åº¦çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ç½‘å…³åŠ¨æ€å®æ—¶æ¨é€ï¼Œè·¯ç”±æƒé‡ä¿¡æ¯ã€‚æ¯”å¦‚95%çš„æµé‡èµ°æœåŠ¡v1ç‰ˆæœ¬ï¼Œ5%çš„æµé‡èµ°æœåŠ¡v2ç‰ˆæœ¬ã€‚ issue: The Spring Cloud Gateway issue of Allow Rolling Deployments https://github.com/spring-cloud/spring-cloud-gateway/issues/67 1.2 Spring Cloud Gatewayæƒé‡è·¯ç”±åŸç†Spring Cloud Gatewayä¸­æä¾›äº†org.springframework.cloud.gateway.handler.predicate.WeightRoutePredicateFactoryå»å®ç°æ ¹æ®åˆ†ç»„è®¾ç½®æƒé‡è¿›è¡Œè·¯ç”±ï¼Œå› æ­¤ä½¿ç”¨èµ·æ¥ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæœ‰å…´è¶£çš„å¯ä»¥debugé˜…è¯»æºç ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960public class WeightRoutePredicateFactory extends AbstractRoutePredicateFactory&lt;WeightConfig&gt; implements ApplicationEventPublisherAware &#123; private static final Log log = LogFactory.getLog(WeightRoutePredicateFactory.class); public static final String GROUP_KEY = WeightConfig.CONFIG_PREFIX + \".group\"; public static final String WEIGHT_KEY = WeightConfig.CONFIG_PREFIX + \".weight\"; private ApplicationEventPublisher publisher; public WeightRoutePredicateFactory() &#123; super(WeightConfig.class); &#125; @Override public void setApplicationEventPublisher(ApplicationEventPublisher publisher) &#123; this.publisher = publisher; &#125; @Override public List&lt;String&gt; shortcutFieldOrder() &#123; return Arrays.asList(GROUP_KEY, WEIGHT_KEY); &#125; @Override public String shortcutFieldPrefix() &#123; return WeightConfig.CONFIG_PREFIX; &#125; @Override public void beforeApply(WeightConfig config) &#123; if (publisher != null) &#123; publisher.publishEvent(new WeightDefinedEvent(this, config)); &#125; &#125; @Override public Predicate&lt;ServerWebExchange&gt; apply(WeightConfig config) &#123; return exchange -&gt; &#123; Map&lt;String, String&gt; weights = exchange.getAttributeOrDefault(WEIGHT_ATTR, Collections.emptyMap()); String routeId = exchange.getAttribute(GATEWAY_PREDICATE_ROUTE_ATTR); // all calculations and comparison against random num happened in // WeightCalculatorWebFilter String group = config.getGroup(); if (weights.containsKey(group)) &#123; String chosenRoute = weights.get(group); if (log.isTraceEnabled()) &#123; log.trace(\"in group weight: \"+ group + \", current route: \" + routeId +\", chosen route: \" + chosenRoute); &#125; return routeId.equals(chosenRoute); &#125; return false; &#125;; &#125;&#125; 2.Spring Cloud Gatewayä¸­çš„æƒé‡è·¯ç”±æ¡ˆä¾‹2.1 æ¡ˆä¾‹ä»£ç åœ°å€https://github.com/SoftwareKing/sc-gateway/tree/master/ch4 2.2 Spring Cloud Gateway Serverè¯´æ˜Spring Cloud Gateway will dispatch 95% of the requests to version 1 and 5% of the traffic to version 2 of a specified service, as shown by the following figure. æˆ‘ä»¬é€šè¿‡åœ¨Spring Cloud Gatewayä¸­ä¼šé…ç½®ä¸åŒçš„æƒé‡ä¿¡æ¯åˆ°ä¸åŒURLä¸Šï¼ŒSpring Cloud Gatewayä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„è·¯ç”±æƒé‡ä¿¡æ¯ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„æºæœåŠ¡ç»„ï¼Œæƒé‡ä¿¡æ¯å¦‚ch4/ch4-gatewayä¸­çš„application.ymlæ‰€ç¤ºï¼Œä¸»è¦é…ç½®ä¿¡æ¯å¦‚ä¸‹ã€‚ 123456789101112131415161718spring: application: name: ch4-gateway cloud: gateway: routes: - id: service1_v1 uri: http://localhost:8081/v1 predicates: - Path=/test - Weight=service1, 95 - id: service1_v2 uri: http://localhost:8081/v2 predicates: - Path=/test - Weight=service1, 5 Weight=service1, 95ï¼ŒWeight=service1, 5å°±æ˜¯è·¯ç”±çš„æƒé‡ä¿¡æ¯ã€‚ 2.3 æºæœåŠ¡æºæœåŠ¡åœ¨æœ¬æ¡ˆä¾‹ä¸­æºæœåŠ¡å¦‚ch4-service-provideræ‰€ç¤ºï¼Œä¸»è¦ææä¾›Gateway Serveræƒé‡è·¯ç”±å¯¹åº”çš„åç«¯æºæœåŠ¡ã€‚å› ä¸ºæ¯”è¾ƒç®€å•å› æ­¤ä¸åšè¯¦ç»†è¯´æ˜ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314151617181920package org.xujin.sc.service;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import reactor.core.publisher.Mono;@RestControllerpublic class ServiceController &#123; @RequestMapping(value = \"/v1\", produces = \"text/plain;charset=UTF-8\") public Mono&lt;String&gt; v1() &#123; return Mono.just(\"v1\"); &#125; @RequestMapping(value = \"/v2\", produces = \"text/plain;charset=UTF-8\") public Mono&lt;String&gt; v2() &#123; return Mono.just(\"v2\"); &#125;&#125; 2.4 æµ‹è¯•åˆ†åˆ«å¯åŠ¨ch4-gatewayï¼Œch4-service-providerè¿›è¡Œè®¿é—®:http://localhost:8080/test æµ‹è¯•,å‘ç°ä¼šæ ¹æ®æ‰€è®¾æƒé‡è¿›è¡Œè·¯ç”±ã€‚","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"Spring Cloud Gatewayä¸­çš„GatewayFilterå’ŒGlobalFilter","slug":"sc/gw/gw07","date":"2018-05-26T06:00:00.000Z","updated":"2019-01-12T03:30:42.775Z","comments":true,"path":"sc/gw/gw07/","link":"","permalink":"http://xujin.org/sc/gw/gw07/","excerpt":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ä»€ä¹ˆæ˜¯GatewayFilterå’ŒGlobalFilterï¼Œä»¥åŠåŒºåˆ«å’Œè”ç³»ã€‚ç„¶åä»‹ç»å¦‚ä½•åœ¨Spring Cloud Gatewayä¸­è‡ªå®šä¹‰ä½¿ç”¨GatewayFilterå’ŒGlobalFilterã€‚","text":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ä»€ä¹ˆæ˜¯GatewayFilterå’ŒGlobalFilterï¼Œä»¥åŠåŒºåˆ«å’Œè”ç³»ã€‚ç„¶åä»‹ç»å¦‚ä½•åœ¨Spring Cloud Gatewayä¸­è‡ªå®šä¹‰ä½¿ç”¨GatewayFilterå’ŒGlobalFilterã€‚ 1. Spring Cloud gatewayçš„FilterSpring Cloud gatewayä¸­çš„Filterä»æ¥å£å®ç°ä¸Šåˆ†ä¸ºä¸¤ç§ä¸€ç§æ˜¯GatewayFilterï¼Œå¦å¤–ä¸€ç§æ˜¯GlobalFilterã€‚ 1.1 GatewayFilterä¸GlobalFilterçš„åŒºåˆ«åŒºåˆ«ç”¨è‹±è¯­å¯ä»¥æ€»ç»“å¦‚ä¸‹:At a high level global filters are applied to all routes, while a gateway filter will be applied to an individual route(s) åœ¨ä¸€ä¸ªé«˜çš„è§’åº¦æ¥çœ‹ï¼ŒGlobal filtersä¼šè¢«åº”ç”¨åˆ°æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œè€ŒGateway filterå°†åº”ç”¨åˆ°å•ä¸ªè·¯ç”±ä¸Šæˆ–è€…ä¸€ä¸ªåˆ†ç»„çš„è·¯ç”±ä¸Šã€‚åœ¨ä¸‹é¢çš„æ¡ˆä¾‹ä¸­å°†ä¼šè¿›è¡Œè¯´æ˜ã€‚ 1.2 æœ¬æ–‡ä»£ç åœ°å€ https://github.com/SoftwareKing/sc-gateway/tree/master/ch2 2. GatewayFilterå’ŒGlobalFilter2.1 GatewayFilter2.1.1 ä»€ä¹ˆæ˜¯GatewayFilterContract for interception-style, chained processing of Web requests that may be used to implement cross-cutting, application-agnostic requirements such as security, timeouts, and others. Specific to a Gateway Copied from WebFilter GatewayFilteræ˜¯ä»WebFilterä¸­Copyè¿‡æ¥çš„ï¼Œç›¸å½“äºä¸€ä¸ªFilterè¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è®¿é—®çš„URLè¿‡æ»¤æ¨ªåˆ‡å¤„ç†ï¼Œåº”ç”¨åœºæ™¯æ¯”å¦‚è¶…æ—¶ï¼Œå®‰å…¨ç­‰ã€‚ ä»Spring Cloud Gatewayçš„æºç ä¸­å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹å‡ºGatewayFilterçš„ä½¿ç”¨åœºæ™¯: 12345678910111213141516171819202122232425/** * Contract for interception-style, chained processing of Web requests that may * be used to implement cross-cutting, application-agnostic requirements such * as security, timeouts, and others. Specific to a Gateway * * Copied from WebFilter * * @author Rossen Stoyanchev * @since 5.0 */public interface GatewayFilter extends ShortcutConfigurable &#123; String NAME_KEY = \"name\"; String VALUE_KEY = \"value\"; /** * Process the Web request and (optionally) delegate to the next * &#123;@code WebFilter&#125; through the given &#123;@link GatewayFilterChain&#125;. * @param exchange the current server exchange * @param chain provides a way to delegate to the next filter * @return &#123;@code Mono&lt;Void&gt;&#125; to indicate when request processing is complete */ Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);&#125; GatewayFilterå’ŒGlobalFilterä¸¤ä¸ªæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ä¸€æ ·éƒ½æ˜¯Mono filter(ServerWebExchange exchange, GatewayFilterChain chain)ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯GatewayFilterç»§æ‰¿äº†ShortcutConfigurableï¼ŒGlobalFilteræ²¡æœ‰ä»»ä½•ç»§æ‰¿ã€‚ 2.1.2 è‡ªå®šä¹‰GatewayFilter(Custom GatewayFilter)å¦‚org.xujin.sc.filter.CustomFilterä»£ç æ‰€ç¤ºï¼Œé€šè¿‡è‡ªå®šä¹‰GatewayFilterå¯¹è·¯ç”±è½¬å‘çš„å¤„ç†æ—¶é•¿ç»Ÿè®¡ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738package org.xujin.sc.filter;import org.apache.commons.logging.Log;import org.apache.commons.logging.LogFactory;import org.springframework.cloud.gateway.filter.GatewayFilter;import org.springframework.cloud.gateway.filter.GatewayFilterChain;import org.springframework.core.Ordered;import org.springframework.web.server.ServerWebExchange;import reactor.core.publisher.Mono;/** * ç»Ÿè®¡æŸä¸ªæˆ–è€…æŸç§è·¯ç”±çš„çš„å¤„ç†æ—¶é•¿ * @author xujin */public class CustomFilter implements GatewayFilter, Ordered &#123; private static final Log log = LogFactory.getLog(GatewayFilter.class); private static final String COUNT_Start_TIME = \"countStartTime\"; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; exchange.getAttributes().put(COUNT_Start_TIME, System.currentTimeMillis()); return chain.filter(exchange).then( Mono.fromRunnable(() -&gt; &#123; Long startTime = exchange.getAttribute(COUNT_Start_TIME); Long endTime=(System.currentTimeMillis() - startTime); if (startTime != null) &#123; log.info(exchange.getRequest().getURI().getRawPath() + \": \" + endTime + \"ms\"); &#125; &#125;) ); &#125; @Override public int getOrder() &#123; return Ordered.LOWEST_PRECEDENCE; &#125;&#125; 2.1.3 Gateway Filterä¸RouteLocatorç»‘å®šä½¿ç”¨åœ¨org.xujin.sc.GatewayServerApplicationä¸­customerRouteLocatorå¦‚ä¸‹æ‰€ç¤º: 1234567891011121314151617181920212223@SpringBootApplicationpublic class GatewayServerApplication &#123; @Bean public RouteLocator customerRouteLocator(RouteLocatorBuilder builder) &#123; return builder.routes() .route(r -&gt; r.path(\"/test/prefix/**\") .filters(f -&gt; f.stripPrefix(2) .filter(new CustomFilter()) .addResponseHeader(\"X-Response-test\", \"test\")) .uri(\"lb://SC-CONSUMER\") .order(0) .id(\"test_consumer_service\") ) .build(); &#125; public static void main(String[] args) &#123; SpringApplication.run(GatewayServerApplication.class, args); &#125;&#125; r.path(â€œ/test/prefix/**â€)è¡¨ç¤ºè‡ªå®šä¹‰äº†è®¿é—®å‰ç¼€ï¼Œåœ¨çœŸæ­£çš„Gatewayè¿›è¡Œè·¯ç”±è½¬å‘çš„æ—¶å€™ï¼Œä¼šç”¨è¿‡f.stripPrefix(2)æŠŠå‰ç¼€å»æ‰ã€‚ ä½¿ç”¨åœºæ™¯:å¯ä»¥æŠŠå¯¹å¤–æš´éœ²çš„URLé€šè¿‡åŠ å‰ç¼€åˆ†ç»„æ‰“æ ‡ã€‚ filter(new CustomFilter() filter(new CustomFilter()ï¼Œè¡¨ç¤ºæŠŠè‡ªå®šä¹‰çš„FilteråŠ åˆ°Filteré“¾é‡Œé¢æ‰§è¡Œï¼Œæ³¨æ„ä¸€ç‚¹æ˜¯è‡ªå®šä¹‰GlobalFilterä¸éœ€è¦åŠ è¿›å»ã€‚ uri(â€œlb://SC-CONSUMERâ€) uri(â€œlb://SC-CONSUMERâ€)è¡¨ç¤ºSpring Cloud Gatewayå¯¹spring.application.nameç­‰äºsc-consumeræºæœåŠ¡åº”ç”¨ä¸­çš„URLè¿›è¡Œåè®®é€‚é…è½¬å‘ã€‚ 2.1.4 æµ‹è¯•å¦‚ä¸‹:1.è®¿é—®http://localhost:9000/SC-CONSUMER/hello/xujin èƒ½æ­£å¸¸è®¿é—®ã€‚ 123DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping : Route matched: CompositeDiscoveryClient_SC-CONSUMER2018-05-27 09:58:07.905 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$337/1295338046@f2ff0c8, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$717/1168359877@1f74a2b, order=1&#125;]&#125;2018-05-27 09:58:07.905 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@f5bf288&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$717/1168359877@1f74a2b, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@26c77f54&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@4c38cd16&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2c1d57bc&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@6e9a0bea&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@7ddcb0dc&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@3e856100&#125;, order=2147483647&#125;] ä»ä¸Šé¢çš„æ§åˆ¶å°æ‰“å°æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œæ²¡æœ‰æ‰“å°å‡ºè¯¥URLå¯¹åº”çš„è€—æ—¶ã€‚ 2.åŠ ä¸ŠURLå‰ç¼€/test/prefix/è®¿é—®ï¼Œæµ‹è¯•URLä¸ºhttp://localhost:9000/test/prefix/hello/testCustomFilter/xujin 1232018-05-27 10:01:56.057 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping : Mapping [Exchange: GET http://localhost:9000/test/prefix/hello/testCustomFilter/xujin] to Route&#123;id='test_consumer_service', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$337/1295338046@6dbaa72e, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory$$Lambda$340/1149217113@41fb2078, order=0&#125;, org.xujin.sc.filter.CustomFilter@281885a3, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory$$Lambda$342/1099925775@4705cae6, order=0&#125;]&#125;2018-05-27 10:01:56.057 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@f5bf288&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory$$Lambda$340/1149217113@41fb2078, order=0&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory$$Lambda$342/1099925775@4705cae6, order=0&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@26c77f54&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@4c38cd16&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2c1d57bc&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@6e9a0bea&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@7ddcb0dc&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@3e856100&#125;, order=2147483647&#125;, org.xujin.sc.filter.CustomFilter@281885a3]2018-05-27 10:02:00.347 INFO 31658 --- [ctor-http-nio-8] o.s.cloud.gateway.filter.GatewayFilter : /hello/testCustomFilter/xujin: 859ms å¦‚ä¸Šæ—¥å¿—å¯ä»¥çœ‹åˆ°/hello/testCustomFilter/xujin: 859msï¼ŒGatewayè½¬å‘çš„æ—¶å€™å»æ‰äº†å‰ç¼€ã€‚ 2.2 GlobalFilter2.2.1 ä»€ä¹ˆæ˜¯GlobalFilter The GlobalFilter interface has the same signature as GatewayFilter. These are special filters that are conditionally applied to all routes. (This interface and usage are subject to change in future milestones). Spring Cloud gatewayå®šä¹‰äº†GlobalFilterçš„æ¥å£è®©æˆ‘ä»¬å»è‡ªå®šä¹‰å®ç°è‡ªå·±çš„çš„GlobalFilterã€‚GlobalFilteræ˜¯ä¸€ä¸ªå…¨å±€çš„Filterï¼Œä½œç”¨äºæ‰€æœ‰çš„è·¯ç”±ã€‚ 123456789101112public interface GlobalFilter &#123; /** * Process the Web request and (optionally) delegate to the next * &#123;@code WebFilter&#125; through the given &#123;@link GatewayFilterChain&#125;. * @param exchange the current server exchange * @param chain provides a way to delegate to the next filter * @return &#123;@code Mono&lt;Void&gt;&#125; to indicate when request processing is complete */ Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);&#125; 2.2.2 è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨(Custom GlobalFilter)åœ¨è¿™é‡Œç®€å•å®šä¹‰AuthSignatureFilterå®ç°GlobalFilterï¼Œä½¿ç”¨åœºæ™¯å°±æ˜¯Gatewayå¯¹è¯·æ±‚çš„URLæ ¡éªŒæƒé™ï¼Œåˆ¤æ–­è¯·æ±‚çš„URLæ˜¯å¦æ˜¯åˆæ³•è¯·æ±‚ã€‚é€šè¿‡ä»ServerWebExchangeè·å–è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­authTokenå¯¹åº”çš„å€¼ï¼Œè¿›è¡Œåˆ¤nullå¤„ç†ï¼Œå…¶å®ƒçš„checké€»è¾‘å¯ä»¥è‡ªå®šå®šåˆ¶ã€‚ 12345678910111213141516171819202122232425262728293031package org.xujin.sc.filter;import org.springframework.cloud.gateway.filter.GatewayFilterChain;import org.springframework.cloud.gateway.filter.GlobalFilter;import org.springframework.core.Ordered;import org.springframework.http.HttpStatus;import org.springframework.stereotype.Component;import org.springframework.web.server.ServerWebExchange;import reactor.core.publisher.Mono;/** * è°ƒç”¨é‰´æƒ */@Componentpublic class AuthSignatureFilter implements GlobalFilter, Ordered &#123; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; String token = exchange.getRequest().getQueryParams().getFirst(\"authToken\"); if (token == null || token.isEmpty()) &#123; exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED); return exchange.getResponse().setComplete(); &#125; return chain.filter(exchange); &#125; @Override public int getOrder() &#123; return -200; &#125;&#125; GlobalFilterå†™å®Œäº†ï¼Œé‚£é—®é¢˜æ¥äº†ï¼Ÿå¦‚ä½•è®©å…¶åœ¨Gatewayä¸­è¿è¡Œç”Ÿæ•ˆï¼Œæœ‰ä¸¤ç§æ–¹å¼ä¸€ç§ç›´æ¥åŠ @Componentæ³¨è§£ï¼Œå¦å¤–ä¸€ç§å¯ä»¥åœ¨ Spring Config ä¸­é…ç½®è¿™ä¸ª Beanå¦‚ä¸‹æ‰€ç¤º: 1234@Beanpublic AuthSignatureFilter authSignatureFilter()&#123; return new AuthSignatureFilter();&#125; æµ‹è¯•1.è®¿é—®http://localhost:9000/test/prefix/hello/testCustomFilter/xujin å¦‚ä¸‹æ‰€ç¤ºç”±äºauthTokenä¸ºç©º401è¿”å›. 2.è®¿é—®http://localhost:9000/test/prefix/hello/testCustomFilter/xujin?authToken=asdasdsddasadsadsadsdadsewew32rg","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"Spring Cloud GatewayåŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™","slug":"sc/gw/gw05","date":"2018-05-21T06:00:00.000Z","updated":"2019-01-12T03:35:27.669Z","comments":true,"path":"sc/gw/gw05/","link":"","permalink":"http://xujin.org/sc/gw/gw05/","excerpt":"æ‘˜è¦:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayçš„åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œä»ä¸­å¯ä»¥çœ‹å‡ºGatewayçš„è·¯ç”±è§„åˆ™:http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/* å’Œ zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/*å·®ä¸å¤šã€‚","text":"æ‘˜è¦:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayçš„åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œä»ä¸­å¯ä»¥çœ‹å‡ºGatewayçš„è·¯ç”±è§„åˆ™:http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/* å’Œ zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/*å·®ä¸å¤šã€‚ 1.Spring Gatewayæ¦‚è¿°1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway Spring Cloud Gatewayæ˜¯Springå®˜æ–¹åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0å’ŒProject Reactorç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼ŒSpring Cloud Gatewayæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„ç»Ÿä¸€çš„APIè·¯ç”±ç®¡ç†æ–¹å¼ã€‚Spring Cloud Gatewayä½œä¸ºSpring Cloudç”Ÿæ€ç³»ä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£Netflix ZUULï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäºFilteré“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§/åŸ‹ç‚¹ï¼Œå’Œé™æµç­‰ã€‚ 1.2 Spring Cloud Gatewayçš„åŠŸèƒ½Spring Cloud Gateway çš„ç‰¹å¾ï¼š åŸºäº Spring Framework 5ï¼ŒProject Reactor å’Œ Spring Boot 2.0åŠ¨æ€è·¯ç”± Predicates å’Œ Filters ä½œç”¨äºç‰¹å®šè·¯ç”± é›†æˆ Hystrix æ–­è·¯å™¨ é›†æˆ Spring Cloud DiscoveryClient æ˜“äºç¼–å†™çš„ Predicates å’Œ Filters é™æµ è·¯å¾„é‡å†™ 2. Spring Cloud Gatewayçš„å·¥ç¨‹æµç¨‹ å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰ï¼ˆâ€œpreâ€ï¼‰æˆ–ä¹‹åï¼ˆâ€œpostâ€ï¼‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚ 2.1 Preå’ŒPOSTä¸¤ç§ç±»å‹çš„è¿‡æ»¤å™¨3.åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™3.1 zuulå’Œgatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™3.1.1 zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™è¯´æ˜é»˜è®¤æƒ…å†µä¸‹ï¼ŒZuulä¼šä»£ç†æ‰€æœ‰æ³¨å†Œåˆ°Eureka Serverçš„å¾®æœåŠ¡ï¼Œå¹¶ä¸”Zuulçš„è·¯ç”±è§„åˆ™å¦‚ä¸‹ï¼š http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/** ä¼šè¢«è½¬å‘åˆ°serviceIdå¯¹åº”çš„å¾®æœåŠ¡ã€‚ http://localhost:8040/sc-zuul-first-provider/sc/order/2 3.1.2 gatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™ä¸‹é¢çš„æ¡ˆä¾‹ä¸­ä¼šæ¼”ç¤ºï¼šhttp://localhost:9000/SC-CONSUMER/hello/xujin http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/**ï¼Œå…¶ä¸­å¾®æœåŠ¡åº”ç”¨åé»˜è®¤å¤§å†™è®¿é—®ã€‚ 3.2 æ¡ˆä¾‹ç¤ºä¾‹ä»£ç https://github.com/SoftwareKing/sc-gateway/tree/master/ch1 æ¨¡å— è¯´æ˜ ç«¯å£ ch1-sc-consumer æœåŠ¡æ¶ˆè´¹è€… 8000 ch1-sc-eureka Eureka Serveræ³¨å†Œä¸­å¿ƒ 8761 ch1-sc-gateway Spring Cloud Gateway Sever 9000 ch1-sc-provider æœåŠ¡æä¾›è€… 8001 3.2.1 ch1-sc-gatewayå·¥ç¨‹è¯´æ˜3.2.1.1 Mavenä¾èµ–Spring Cloud Gateway severä¸»è¦çš„mavenä¾èµ–å¦‚ä¸‹æ‰€ç¤º 12345678910&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; 3.2.1.2 ymlæ–‡ä»¶é…ç½®12345678910111213141516171819spring: application: name: sc-gateway-server cloud: gateway: discovery: locator: enabled: trueserver: port: 9000eureka: client: service-url: defaultZone: http://localhost:8761/eureka/logging: level: org.springframework.cloud.gateway: debug é…ç½®è¯´æ˜ï¼š spring.cloud.gateway.discovery.locator.enabledï¼šæ˜¯å¦ä¸æœåŠ¡å‘ç°ç»„ä»¶è¿›è¡Œç»“åˆï¼Œé€šè¿‡ serviceId è½¬å‘åˆ°å…·ä½“çš„æœåŠ¡å®ä¾‹ã€‚é»˜è®¤ä¸ºfalseï¼Œè®¾ä¸ºtrueä¾¿å¼€å¯é€šè¿‡æœåŠ¡ä¸­å¿ƒçš„è‡ªåŠ¨æ ¹æ® serviceId åˆ›å»ºè·¯ç”±çš„åŠŸèƒ½ã€‚ ä¿®æ”¹spring cloud gateway serverç›‘å¬çš„ç«¯å£ä¸º9000 eureka.client.service-url.defaultZone: http://localhost:8761/eureka/,æŒ‡å®šæ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼ŒSpring Cloud Gatewayä»æ³¨å†Œä¸­å¿ƒè·å–å·²ç»æ³¨å†Œçš„æœåŠ¡åˆ—è¡¨ã€‚ logging.level.org.springframework.cloud.gateway: debug,å¼€å¯spring-Cloud-gatewayçš„æ—¥å¿—çº§åˆ«ä¸ºdebugï¼Œæ–¹ä¾¿debugè°ƒè¯•ã€‚ 3.3 å¯åŠ¨æµ‹è¯•3.3.1 é”™è¯¯çš„è·¯ç”±è§„åˆ™è®¿é—®è®¿é—®Spring Cloud Gatewayå¯¹åº”çš„serverï¼Œå½“è®¿é—®http://localhost:9000/sc-consumer/hello/xujinçš„æ—¶å€™ï¼ŒæŠ¥é”™å¦‚ä¸‹æ‰€ç¤ºï¼Œæ­£ç¡®çš„Spring Cloud Gatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™:http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/** 1234567891011122018-05-18 01:10:49.742 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying &#123;pattern=/SC-CONSUMER/**&#125; to Path2018-05-18 01:10:49.743 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying filter &#123;regexp=/SC-CONSUMER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath2018-05-18 01:10:49.743 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition matched: CompositeDiscoveryClient_SC-CONSUMER2018-05-18 01:10:49.744 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying &#123;pattern=/SC-PRODUCER/**&#125; to Path2018-05-18 01:10:49.744 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying filter &#123;regexp=/SC-PRODUCER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath2018-05-18 01:10:49.745 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition matched: CompositeDiscoveryClient_SC-PRODUCER2018-05-18 01:10:49.745 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying &#123;pattern=/SC-GATEWAY-SERVER/**&#125; to Path2018-05-18 01:10:49.747 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying filter &#123;regexp=/SC-GATEWAY-SERVER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath2018-05-18 01:10:49.748 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition matched: CompositeDiscoveryClient_SC-GATEWAY-SERVER2018-05-18 01:10:49.748 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.h.RoutePredicateHandlerMapping : Route matched: CompositeDiscoveryClient_SC-CONSUMER2018-05-18 01:10:49.749 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.h.RoutePredicateHandlerMapping : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$707/751096818@7f4c6373, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$709/672603106@293895d2, order=1&#125;]&#125;2018-05-18 01:10:49.749 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.handler.FilteringWebHandler : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@5e85c21b&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$709/672603106@293895d2, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@38e83838&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@6ef2f7ad&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@41def031&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@4966bab1&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@22d477c2&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@39832280&#125;, order=2147483647&#125;] ä»ä¸Šé¢çš„logï¼Œçœ‹åˆ°è¿”å›äº† 404 é”™è¯¯ï¼Œè¿›ä¸€æ­¥å¯ä»¥çœ‹åˆ° Spring Cloud Gateway å·²ç»ä¸ºæˆ‘ä»¬çš„ provider å’Œ consumer è‡ªåŠ¨åˆ›å»ºäº†å¯¹åº”çš„è·¯ç”±è½¬å‘è§„åˆ™ï¼Œä½†æ˜¯è¿™é‡Œçš„ pattern/regexp é‡Œéƒ½æ˜¯å¤§å†™çš„ï¼Œä¸‹é¢æ¢æˆå¤§å†™çš„æµ‹è¯•ä¸€ä¸‹ã€‚ 3.3.2 Gatewayæ­£ç¡®çš„è·¯ç”±è§„åˆ™æµ‹è¯•è®¿é—®æ­£ç¡®çš„http://localhost:9000/SC-CONSUMER/hello/xujinï¼Œå¯ä»¥æˆåŠŸè®¿é—®ã€‚ 1234567891011122018-05-22 09:04:21.204 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying &#123;pattern=/SC-CONSUMER/**&#125; to Path2018-05-22 09:04:21.205 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying filter &#123;regexp=/SC-CONSUMER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath2018-05-22 09:04:21.205 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition matched: CompositeDiscoveryClient_SC-CONSUMER2018-05-22 09:04:21.206 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying &#123;pattern=/SC-PRODUCER/**&#125; to Path2018-05-22 09:04:21.207 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying filter &#123;regexp=/SC-PRODUCER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath2018-05-22 09:04:21.207 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition matched: CompositeDiscoveryClient_SC-PRODUCER2018-05-22 09:04:21.208 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying &#123;pattern=/SC-GATEWAY-SERVER/**&#125; to Path2018-05-22 09:04:21.208 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying filter &#123;regexp=/SC-GATEWAY-SERVER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator : RouteDefinition matched: CompositeDiscoveryClient_SC-GATEWAY-SERVER2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping : Route matched: CompositeDiscoveryClient_SC-CONSUMER2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$706/57023854@24f1a91e, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$708/2036079541@cbb7393, order=1&#125;]&#125;2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@29a98d9f&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$708/2036079541@cbb7393, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@544e8149&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@55d58825&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2da3b078&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@1a96d94c&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@19a64eae&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@7fb66650&#125;, order=2147483647&#125;] å¯ä»¥çœ‹å‡ºï¼ŒSpring Cloud Gateway è‡ªåŠ¨çš„ä¸ºæˆ‘ä»¬çš„ consumer åˆ›å»ºäº†ä¸€ä¸ªè·¯ç”±ï¼Œç±»ä¼¼äºä¸‹è¾¹è¿™æ ·12345678routes: - id: CompositeDiscoveryClient_SC-CONSUMER uri: lb://SC-CONSUMER order: 0 predicates: - Path=/SC-CONSUMER/** filters: - RewritePath=/SC-CONSUMER/(?&lt;segment&gt;.*), /$\\&#123;segment&#125; æ‰€ä»¥ä»zuulè¿ç§»åˆ°gatewayçš„æ—¶å€™ï¼ŒæœåŠ¡è·¯ç”±è§„åˆ™ä¸­çš„å¾®æœåŠ¡åº”ç”¨Idé»˜è®¤ä»å°å†™å˜ä¸ºå¤§å†™ã€‚","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"Spring Cloud Gatewayåªæœ‰Preå’ŒPOSTä¸¤ç§ç±»å‹çš„Filter","slug":"sc/gw/gw06","date":"2018-05-21T06:00:00.000Z","updated":"2019-01-12T03:30:08.378Z","comments":true,"path":"sc/gw/gw06/","link":"","permalink":"http://xujin.org/sc/gw/gw06/","excerpt":"æ‘˜è¦:Spring Cloud Gatewayåªæœ‰ä¸¤ç§ç±»å‹çš„Filterï¼Œæœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨Spring Cloud Gatewayä¸­åˆ›å»ºä¸€ä¸ªPreæˆ–Postç±»å‹çš„Filterã€‚","text":"æ‘˜è¦:Spring Cloud Gatewayåªæœ‰ä¸¤ç§ç±»å‹çš„Filterï¼Œæœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨Spring Cloud Gatewayä¸­åˆ›å»ºä¸€ä¸ªPreæˆ–Postç±»å‹çš„Filterã€‚ zuulçš„Filterç±»å‹Zuul çš„ Filter æ˜¯é€šè¿‡filterType()æ–¹æ³•æ¥æŒ‡å®šï¼Œä¸€ä¸ª Filter åªèƒ½å¯¹åº”ä¸€ç§ç±»å‹ï¼Œè¦ä¹ˆæ˜¯ â€œpreâ€ è¦ä¹ˆæ˜¯â€œpostâ€ Spring Cloud Gatewayçš„Filterç±»å‹Spring Cloud Gateway åŸºäº Project Reactor å’Œ WebFluxï¼Œé‡‡ç”¨å“åº”å¼ç¼–ç¨‹é£æ ¼ï¼Œæ‰“å¼€å®ƒçš„ Filter çš„æ¥å£GatewayFilterä½ ä¼šå‘ç°å®ƒåªæœ‰ä¸€ä¸ªæ–¹æ³•filter Preç±»å‹çš„Filteråœ¨Spring Cloud Gatewayæºç ä¸­å®šä¹‰äº†ä¸€ä¸ªPreç±»å‹çš„Filterï¼Œcodeå°†ä¼šåœ¨chain.filter() ä¹‹å‰è¢«æ‰§è¡Œ,ä»£ç :AddRequestHeader 12345678910111213141516171819202122package org.springframework.cloud.gateway.filter.factory;import org.springframework.cloud.gateway.filter.GatewayFilter;import org.springframework.http.server.reactive.ServerHttpRequest;/** * @author Spencer Gibb */public class AddRequestHeaderGatewayFilterFactory extends AbstractNameValueGatewayFilterFactory &#123; @Override public GatewayFilter apply(NameValueConfig config) &#123; return (exchange, chain) -&gt; &#123; ServerHttpRequest request = exchange.getRequest().mutate() .header(config.getName(), config.getValue()) .build(); return chain.filter(exchange.mutate().request(request).build()); &#125;; &#125;&#125; Postç±»å‹çš„Filterå¯¹äºPostç±»å‹çš„Filterï¼ŒSetStatusä»£ç å°†ä¼šåœ¨chain.filter(exchange).then()é‡Œé¢çš„ä»£ç è¿è¡Œã€‚ 12345678910111213141516public class SetStatusGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;SetStatusGatewayFilterFactory.Config&gt; &#123; @Override public GatewayFilter apply(Config config) &#123; final HttpStatus status = ServerWebExchangeUtils.parse(config.status); return (exchange, chain) -&gt; &#123; return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123; // check not really needed, since it is guarded in setStatusCode, // but it's a good example if (!exchange.getResponse().isCommitted()) &#123; setResponseStatus(exchange, status); &#125; &#125;)); &#125;; &#125;&#125;","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"å…¬ç›ŠEureka Serverä¸å®šåˆ¶æ–¹æ³•","slug":"sc/sc-diy-eureka","date":"2018-05-14T06:00:00.000Z","updated":"2019-01-12T03:46:24.845Z","comments":true,"path":"sc/sc-diy-eureka/","link":"","permalink":"http://xujin.org/sc/sc-diy-eureka/","excerpt":"æ‘˜è¦: æœ¬æ–‡ä¸»è¦ç®€å•ä»‹ç»å¦‚ä½•å®šåˆ¶ä¸€ä¸ªeureka serverï¼Œå¹¶ç›´æ¥æŒ‡å‡ºæœ€ä¼˜çš„å®šåˆ¶æ–¹å¼ã€‚","text":"æ‘˜è¦: æœ¬æ–‡ä¸»è¦ç®€å•ä»‹ç»å¦‚ä½•å®šåˆ¶ä¸€ä¸ªeureka serverï¼Œå¹¶ç›´æ¥æŒ‡å‡ºæœ€ä¼˜çš„å®šåˆ¶æ–¹å¼ã€‚ 1. Spring Cloudä¸­å›½å…¬ç›ŠEureka ServerEureka Serverä¸ºä½œä¸ºSpring Cloudå¼€å‘è¿‡ç¨‹ä¸­å¸¸ç”¨çš„æ³¨å†Œä¸­å¿ƒç»„ä»¶ï¼Œä½œä¸ºåŸºç¡€è®¾æ–½ç»„ä»¶ï¼Œå¼€å‘å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œç»å¸¸éœ€è¦è‡ªå·±åˆ›å»ºEureka Serveråº”ç”¨å’Œé‡å¯ã€‚ä¸ºäº†å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå­¦ä¹ å…¥é—¨ã€‚Spring Cloudä¸­å›½ç¤¾åŒºç‰¹æ­å»ºä¸€ä¸ªå…¬ç›Šæ³¨å†Œä¸­å¿ƒï¼Œä»…ä½œä¸ºå¸®åŠ©Spring Cloudçš„å¼€å‘è€…è¿›è¡Œå­¦ä¹ å’Œè°ƒè¯•ã€‚ä¸ºäº†æ›´å¥½æœåŠ¡å¤§å®¶ï¼Œè¯·å‹¿å¯¹æœ¬æ³¨å†Œä¸­å¿ƒè¿›è¡Œå‹æµ‹ã€‚å®šåˆ¶çš„Eureka Serveræ³¨å†Œä¸­å¿ƒUIå¦‚ä¸‹æ‰€ç¤ºã€‚ 1.1 è®¿é—®åœ°å€ http://eureka.springcloud.cn 2.å®šåˆ¶Eureka Serrverçš„UI2.1 ä¸ºä»€ä¹ˆè¦å®šåˆ¶Eureka Server åŸå› ä¸¤ç‚¹: 1.è§‰å¾—é»˜è®¤çš„UIæ¯”è¾ƒä¸‘ 2.Eureka Serveræƒ³å®¢åˆ¶åŒ–ä¸€ä¸‹ è‡³äºSpring Cloud Eurekaçš„UIå®¢åˆ¶åŒ–æˆä»€ä¹ˆæ ·å­ç”±ä½ è€Œå®šï¼ 3. ä¸¤ç§æ–¹æ³•å®šåˆ¶Eureka Server3.1 ç›´æ¥ä¿®æ”¹eureka serverçš„æºä»£ç  ç›´æ¥ä¿®æ”¹eureka serverçš„æºä»£ç ï¼Œè¯¥æ–¹æ³•æ˜¯æœ€çº¯çš„æ–¹å¼ï¼Œè€Œä¸”æ¯æ¬¡æœ‰ä¸€ä¸ªEureka Serverçš„ç‰ˆæœ¬éƒ½éœ€è¦å»ä¿®æ”¹ã€‚ 3.2 åªä¿®æ”¹Eureka Serverçš„UIåªéœ€è¦ä¿®æ”¹å¯¹åº”çš„html+css+æ–‡æ¡ˆå³å¯ï¼Œå®Œå…¨ä¸ç”¨å»ä¿®æ”¹Eureka Serverçš„æºç ,å¼ºçƒˆæ¨èã€‚ æºç å‚è€ƒåœ°å€:https://github.com/SpringCloud/spring-cloud-eureka 3.3 ä¸ºä»€ä¹ˆæˆ‘å®šåˆ¶è‡ªå·±çš„UIåŠ è¿›å» ä¸ºä»€ä¹ˆæˆ‘å®šåˆ¶è‡ªå·±çš„UIåŠ è¿›å»ï¼Œå°±å¯ä»¥ç›´æ¥Runï¼Œé‚£æºç ä»£ç ä¸­çš„UIæ˜¯ä¸æ˜¯è¢«è¦†ç›–äº†ï¼Ÿ 123456789101112&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;cn.springcloud.eureka&lt;/groupId&gt; &lt;artifactId&gt;eureka-server-ui&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; å¦‚ä¸Šmavené…ç½®æ‰€ç¤ºï¼Œå®˜æ–¹çš„spring-cloud-starter-netflix-eureka-serverä¾èµ–ä¿¡æ¯é…ç½®åœ¨ä¸‹é¢ï¼Œç”±mavençš„ä¾èµ–åŠ è½½é¡ºåºå†³å®šï¼Œå®šåˆ¶çš„UIä¼˜å…ˆåŠ è½½æ˜¾ç¤ºã€‚ 4. å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨DIYçš„Eureka Serveråªéœ€è¦é…ç½®mavenä¾èµ–å³å¯:123456789101112&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;cn.springcloud.eureka&lt;/groupId&gt; &lt;artifactId&gt;eureka-server-ui&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt;","categories":[{"name":"Eureka Server","slug":"Eureka-Server","permalink":"http://xujin.org/categories/Eureka-Server/"}],"tags":[{"name":"Eureka Server","slug":"Eureka-Server","permalink":"http://xujin.org/tags/Eureka-Server/"}]},{"title":"Spring Cloud Gatewayçš„Beforeè·¯ç”±æ–­è¨€å·¥å‚","slug":"sc/gw/gw04","date":"2018-03-28T06:00:00.000Z","updated":"2019-01-12T03:35:55.349Z","comments":true,"path":"sc/gw/gw04/","link":"","permalink":"http://xujin.org/sc/gw/gw04/","excerpt":"æ‘˜è¦:åœ¨ä¸Šæœ¬ç¯‡æ–‡ç« Spring Cloud Gatewayçš„Afterè·¯ç”±æ–­è¨€å·¥å‚ä»‹ç»äº†Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µå’ŒAfterè·¯ç”±æ–­è¨€ï¼Œæœ¬æ–‡ç®€å•ä»‹ç»Beforeè·¯ç”±æ–­è¨€å·¥å‚ã€‚å› ä¸ºæ¯”è¾ƒç®€å•æ‰€ä»¥å°±æŠ›ç –å¼•ç‰ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶å¿«é€Ÿå…¥é—¨Spring Cloud Gatewayï¼Œæ¬¢è¿å¤§å®¶åŠ æˆ‘å¾®ä¿¡Software_Kingï¼Œè¿›å…¥Spring Cloudä¸­å›½ç¤¾åŒºå¾®ä¿¡ç¾¤äº¤æµã€‚","text":"æ‘˜è¦:åœ¨ä¸Šæœ¬ç¯‡æ–‡ç« Spring Cloud Gatewayçš„Afterè·¯ç”±æ–­è¨€å·¥å‚ä»‹ç»äº†Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µå’ŒAfterè·¯ç”±æ–­è¨€ï¼Œæœ¬æ–‡ç®€å•ä»‹ç»Beforeè·¯ç”±æ–­è¨€å·¥å‚ã€‚å› ä¸ºæ¯”è¾ƒç®€å•æ‰€ä»¥å°±æŠ›ç –å¼•ç‰ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶å¿«é€Ÿå…¥é—¨Spring Cloud Gatewayï¼Œæ¬¢è¿å¤§å®¶åŠ æˆ‘å¾®ä¿¡Software_Kingï¼Œè¿›å…¥Spring Cloudä¸­å›½ç¤¾åŒºå¾®ä¿¡ç¾¤äº¤æµã€‚ 1. Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µ ç½‘å…³ç®€å•çš„è¯´å°±æ˜¯æä¾›ä¸€ä¸ªå¯¹å¤–ç»Ÿä¸€çš„APIå…¥å£å’Œå‡ºå£ï¼Œç»Ÿç®¡ä¼ä¸šå¯¹å¤–çš„æ‰€æœ‰APIå‡ºå£ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç½‘å…³å¯¹å¤–æš´éœ²çš„URLæˆ–è€…æ¥å£ä¿¡æ¯ï¼Œæˆ‘ä»¬ç»Ÿç§°ä¹‹ä¸ºè·¯ç”±ä¿¡æ¯ã€‚å¦‚æœç ”å‘è¿‡ç½‘å…³ä¸­é—´ä»¶ï¼Œæˆ–è€…ä½¿ç”¨æˆ–äº†è§£è¿‡ZUULçš„ï¼Œç½‘å…³çš„æ ¸å¿ƒè‚¯å®šæ˜¯Filterä»¥åŠFilter Chain(Filterè´£ä»»é“¾)ã€‚Spring Cloud Gatewayä¹Ÿå…·æœ‰è·¯ç”±ä¿¡æ¯å’ŒFilterã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹Spring Cloud gatewayä¸­æœ€é‡è¦çš„å‡ ä¸ªæ¦‚å¿µ: è·¯ç”±(route):è·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯ç”±ä¸€ä¸ªIDã€ä¸€ä¸ªç›®çš„urlã€ä¸€ç»„æ–­è¨€å·¥å‚å’Œä¸€ç»„Filterç»„æˆã€‚å¦‚æœè·¯ç”±æ–­è¨€å·¥å‚ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚çš„Urlå’Œé…ç½®çš„è·¯ç”±åŒ¹é…ã€‚ æ–­è¨€(Predicate): java 8ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gatewayä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯Spring 5.0æ¡†æ¶ä¸­çš„ServerWebExchangeã€‚Spring Cloud Gatewayä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é…æ¥è‡ªäºhttp requestä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚ è¿‡æ»¤å™¨(filter):ä¸€ä¸ªæ ‡å‡†çš„Spring webFilterã€‚Spring Cloud Gatewayä¸­çš„Filteråˆ†ä¸ºä¸¤ç§ç±»å‹çš„Filterï¼Œåˆ†åˆ«æ˜¯Gateway Filterå’ŒGlobal Filter.ç½‘å…³ Filterå®ä¾‹æ˜¯ç”±Spring æ¡†æ¶ä¸­çš„ç½‘å…³Filterçš„ç‰¹æ®Šå·¥å‚æ„é€ ã€‚requeståœ¨è½¬å‘åˆ°ç›®å‰æœåŠ¡ä¹‹å‰ï¼Œresponseåœ¨è¿”å›åˆ°è°ƒç”¨ç«¯ä¹‹å‰éƒ½å¯ä»¥è¢«ä¿®æ”¹æˆ–è€…è‡ªå®šä¹‰ã€‚ 2. ä»€ä¹ˆæ˜¯Beforeè·¯ç”±æ–­è¨€ Beforeè·¯ç”±æ–­è¨€å·¥å‚å¸¦æœ‰ä¸€ä¸ªUTCæ—¶é—´æ ¼å¼çš„æ—¶é—´å‚æ•°ï¼Œå½“è¯·æ±‚è¿›æ¥çš„å½“å‰æ—¶é—´åœ¨è·¯ç”±æ–­è¨€å·¥å‚ä¹‹å‰ä¼šæˆåŠŸåŒ¹é…ï¼Œå¦åˆ™ä¸èƒ½æˆåŠŸåŒ¹é…ã€‚ 3. Beforeè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹3.1 å¼•å…¥pomä¾èµ–pom.xmlä¾èµ–é…ç½®å¦‚ä¸‹æ‰€ç¤º: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990&lt;properties&gt; &lt;spring-cloud.version&gt;Finchley.M9&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt; &lt;scope&gt;runtime&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;repositories&gt; &lt;repository&gt; &lt;id&gt;spring-snapshots&lt;/id&gt; &lt;name&gt;Spring Snapshots&lt;/name&gt; &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/repository&gt; &lt;repository&gt; &lt;id&gt;spring-milestones&lt;/id&gt; &lt;name&gt;Spring Milestones&lt;/name&gt; &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;false&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/repository&gt; &lt;/repositories&gt; &lt;pluginRepositories&gt; &lt;pluginRepository&gt; &lt;id&gt;spring-snapshots&lt;/id&gt; &lt;name&gt;Spring Snapshots&lt;/name&gt; &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/pluginRepository&gt; &lt;pluginRepository&gt; &lt;id&gt;spring-milestones&lt;/id&gt; &lt;name&gt;Spring Milestones&lt;/name&gt; &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;false&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/pluginRepository&gt; &lt;/pluginRepositories&gt; 3.2 application.ymlæ–‡ä»¶é…ç½®:1234567891011121314151617181920server: port: 8082spring: cloud: gateway: routes: - id: before_route uri: http://xujin.org predicates: - Before=2022-03-13T00:54:30.877+08:00[Asia/Shanghai]logging: level: org.springframework.cloud.gateway: TRACE org.springframework.http.server.reactive: DEBUG org.springframework.web.reactive: DEBUG reactor.ipc.netty: DEBUGmanagement.endpoints.web.exposure.include: '*' Spring Cloud Gatewayæä¾›ä¸¤ç§æ–¹å¼å»é…ç½®Beforeè·¯ç”±æ–­è¨€å·¥å‚ï¼Œè¿™é‡Œä»‹ç»çš„æ˜¯ymlæ–‡ä»¶çš„é…ç½®æ–¹å¼ã€‚ 3.3 ç­‰ä»·çš„@Beané…ç½®12345678910111213@Beanpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123; ZonedDateTime datetime = LocalDateTime.now().plusDays(1).atZone(ZoneId.systemDefault()); //@formatter:off return builder.routes() .route(\"before_route\", r -&gt; r.before(datetime) .uri(\"http://xujin.org\")) .build(); //@formatter:on &#125; Spring Cloud Gatewayæä¾›ä¸¤ç§æ–¹å¼å»é…ç½®Afterè·¯ç”±æ–­è¨€å·¥å‚ï¼Œè¿™é‡Œä»‹ç»çš„æ˜¯@Beançš„é…ç½®æ–¹å¼ã€‚ä¸ç®¡é€šè¿‡ymlæ–‡ä»¶é…ç½®æˆ–è€…é€šè¿‡@Beançš„æ–¹å¼é…ç½®æ˜¯ç­‰ä»·çš„ã€‚ 3.4 æµ‹è¯•å¦‚ä¸‹:è®¿é—®http://localhost:8082/ æˆåŠŸè½¬å‘åˆ°http://xujin.orgã€‚","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"Spring Cloud Gatewayçš„Afterè·¯ç”±æ–­è¨€å·¥å‚","slug":"sc/gw/gw03","date":"2018-03-25T06:00:00.000Z","updated":"2019-01-12T03:24:23.992Z","comments":true,"path":"sc/gw/gw03/","link":"","permalink":"http://xujin.org/sc/gw/gw03/","excerpt":"æ‘˜è¦:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µå’ŒAfterè·¯ç”±æ–­è¨€ï¼Œå› ä¸ºæ¯”è¾ƒç®€å•æ‰€ä»¥å°±æŠ›ç –å¼•ç‰ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶å¿«é€Ÿå…¥é—¨Spring Cloud Gatewayï¼Œæ¬¢è¿å¤§å®¶åŠ æˆ‘å¾®ä¿¡Software_Kingï¼Œè¿›å…¥Spring Cloudä¸­å›½ç¤¾åŒºå¾®ä¿¡ç¾¤äº¤æµã€‚","text":"æ‘˜è¦:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µå’ŒAfterè·¯ç”±æ–­è¨€ï¼Œå› ä¸ºæ¯”è¾ƒç®€å•æ‰€ä»¥å°±æŠ›ç –å¼•ç‰ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶å¿«é€Ÿå…¥é—¨Spring Cloud Gatewayï¼Œæ¬¢è¿å¤§å®¶åŠ æˆ‘å¾®ä¿¡Software_Kingï¼Œè¿›å…¥Spring Cloudä¸­å›½ç¤¾åŒºå¾®ä¿¡ç¾¤äº¤æµã€‚ 1.Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µ ç½‘å…³ç®€å•çš„è¯´å°±æ˜¯æä¾›ä¸€ä¸ªå¯¹å¤–ç»Ÿä¸€çš„APIå…¥å£å’Œå‡ºå£ï¼Œç»Ÿç®¡ä¼ä¸šå¯¹å¤–çš„æ‰€æœ‰APIå‡ºå£ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç½‘å…³å¯¹å¤–æš´éœ²çš„URLæˆ–è€…æ¥å£ä¿¡æ¯ï¼Œæˆ‘ä»¬ç»Ÿç§°ä¹‹ä¸ºè·¯ç”±ä¿¡æ¯ã€‚å¦‚æœç ”å‘è¿‡ç½‘å…³ä¸­é—´ä»¶ï¼Œæˆ–è€…ä½¿ç”¨æˆ–äº†è§£è¿‡ZUULçš„ï¼Œç½‘å…³çš„æ ¸å¿ƒè‚¯å®šæ˜¯Filterä»¥åŠFilter Chain(Filterè´£ä»»é“¾)ã€‚Spring Cloud Gatewayä¹Ÿå…·æœ‰è·¯ç”±ä¿¡æ¯å’ŒFilterã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹Spring Cloud gatewayä¸­æœ€é‡è¦çš„å‡ ä¸ªæ¦‚å¿µ: è·¯ç”±(route):è·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯ç”±ä¸€ä¸ªIDã€ä¸€ä¸ªç›®çš„urlã€ä¸€ç»„æ–­è¨€å·¥å‚å’Œä¸€ç»„Filterç»„æˆã€‚å¦‚æœè·¯ç”±æ–­è¨€å·¥å‚ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚çš„Urlå’Œé…ç½®çš„è·¯ç”±åŒ¹é…ã€‚ æ–­è¨€(Predicate): java 8ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gatewayä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯Spring 5.0æ¡†æ¶ä¸­çš„ServerWebExchangeã€‚Spring Cloud Gatewayä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é…æ¥è‡ªäºhttp requestä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚ è¿‡æ»¤å™¨(filter):ä¸€ä¸ªæ ‡å‡†çš„Spring webFilterã€‚Spring Cloud Gatewayä¸­çš„Filteråˆ†ä¸ºä¸¤ç§ç±»å‹çš„Filterï¼Œåˆ†åˆ«æ˜¯Gateway Filterå’ŒGlobal Filter.ç½‘å…³ Filterå®ä¾‹æ˜¯ç”±Spring æ¡†æ¶ä¸­çš„ç½‘å…³Filterçš„ç‰¹æ®Šå·¥å‚æ„é€ ã€‚requeståœ¨è½¬å‘åˆ°ç›®å‰æœåŠ¡ä¹‹å‰ï¼Œresponseåœ¨è¿”å›åˆ°è°ƒç”¨ç«¯ä¹‹å‰éƒ½å¯ä»¥è¢«ä¿®æ”¹æˆ–è€…è‡ªå®šä¹‰ã€‚ 2.ä»€ä¹ˆæ˜¯Afterè·¯ç”±æ–­è¨€ After Route Predicate Factoryå¸¦æœ‰ä¸€ä¸ªUTCæ—¶é—´æ ¼å¼çš„æ—¶é—´å‚æ•°ï¼Œå½“è¯·æ±‚è¿›æ¥çš„å½“å‰æ—¶é—´åœ¨è·¯ç”±æ–­è¨€å·¥å‚ä¹‹åä¼šæˆåŠŸåŒ¹é…ï¼Œå¦åˆ™ä¸èƒ½æˆåŠŸåŒ¹é…ã€‚ 3.Afterè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹3.1 å¼•å…¥pomä¾èµ–pom.xmlä¾èµ–é…ç½®å¦‚ä¸‹æ‰€ç¤º: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990&lt;properties&gt; &lt;spring-cloud.version&gt;Finchley.M9&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt; &lt;scope&gt;runtime&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;repositories&gt; &lt;repository&gt; &lt;id&gt;spring-snapshots&lt;/id&gt; &lt;name&gt;Spring Snapshots&lt;/name&gt; &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/repository&gt; &lt;repository&gt; &lt;id&gt;spring-milestones&lt;/id&gt; &lt;name&gt;Spring Milestones&lt;/name&gt; &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;false&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/repository&gt; &lt;/repositories&gt; &lt;pluginRepositories&gt; &lt;pluginRepository&gt; &lt;id&gt;spring-snapshots&lt;/id&gt; &lt;name&gt;Spring Snapshots&lt;/name&gt; &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/pluginRepository&gt; &lt;pluginRepository&gt; &lt;id&gt;spring-milestones&lt;/id&gt; &lt;name&gt;Spring Milestones&lt;/name&gt; &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;false&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/pluginRepository&gt; &lt;/pluginRepositories&gt; 3.2 application.ymlæ–‡ä»¶é…ç½®:123456789101112131415161718192021server: port: 8081spring: cloud: gateway: routes: - id: after_route uri: http://xujin.org predicates: - After=2018-03-18T17:32:58.129+08:00[Asia/Shanghai]logging: level: org.springframework.cloud.gateway: TRACE org.springframework.http.server.reactive: DEBUG org.springframework.web.reactive: DEBUG reactor.ipc.netty: DEBUGmanagement.endpoints.web.exposure.include: '*' Spring Cloud Gatewayæä¾›ä¸¤ç§æ–¹å¼å»é…ç½®Afterè·¯ç”±æ–­è¨€å·¥å‚ï¼Œè¿™é‡Œä»‹ç»çš„æ˜¯ymlæ–‡ä»¶çš„é…ç½®æ–¹å¼ã€‚ 3.3 ç­‰ä»·çš„@Beané…ç½®123456789@Beanpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123; ZonedDateTime minusTime = LocalDateTime.now().minusDays(1).atZone(ZoneId.systemDefault()); return builder.routes() .route(\"after_route\", r -&gt; r.after(minusTime) .uri(\"http://xujin.org\")) .build(); &#125; Spring Cloud Gatewayæä¾›ä¸¤ç§æ–¹å¼å»é…ç½®Afterè·¯ç”±æ–­è¨€å·¥å‚ï¼Œè¿™é‡Œä»‹ç»çš„æ˜¯@Beançš„é…ç½®æ–¹å¼ã€‚ä¸ç®¡é€šè¿‡ymlæ–‡ä»¶é…ç½®æˆ–è€…é€šè¿‡@Beançš„æ–¹å¼é…ç½®æ˜¯ç­‰ä»·çš„ã€‚ 3.4 æµ‹è¯•å¦‚ä¸‹:è®¿é—®http://localhost:8081/æˆåŠŸè½¬å‘åˆ°http://xujin.org","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"Spring Cloud Gatewayæ­ç§˜ä¹‹å¤„ç†è¯·æ±‚æµç¨‹","slug":"sc/gw/gw02","date":"2018-03-17T06:00:00.000Z","updated":"2019-01-12T03:20:23.909Z","comments":true,"path":"sc/gw/gw02/","link":"","permalink":"http://xujin.org/sc/gw/gw02/","excerpt":"æ‘˜è¦:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»æºç çš„è§’åº¦æ­ç§˜Spring Cloud Gatewayçš„æ€ä¹ˆå¤„ç†è¯·æ±‚æµç¨‹ã€‚","text":"æ‘˜è¦:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»æºç çš„è§’åº¦æ­ç§˜Spring Cloud Gatewayçš„æ€ä¹ˆå¤„ç†è¯·æ±‚æµç¨‹ã€‚ 1.Spring Gatewayæ¦‚è¿° Spring Cloud Gatewayæ˜¯Springå®˜æ–¹åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0å’ŒProject Reactorç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼ŒSpring Cloud Gatewayæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„ç»Ÿä¸€çš„APIè·¯ç”±ç®¡ç†æ–¹å¼ã€‚Spring Cloud Gatewayä½œä¸ºSpring Cloudç”Ÿæ€ç³»ä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£Netflix ZUULï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäºFilteré“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§/åŸ‹ç‚¹ï¼Œå’Œé™æµç­‰ã€‚ 2. Spring Cloud gatewayè¯·æ±‚å…¥å£åˆ†æ ä¸ç®¡æ˜¯Zuulï¼Œè¿˜æ˜¯Spring Cloud Gatewayè¿˜æ˜¯åŸºäºNettyçš„è‡ªç ”ç½‘å…³ï¼Œéƒ½ä¼šæŠŠè¯·æ±‚è¿›æ¥çš„Requestï¼Œæˆ–è€…è¿”å›çš„Responseè¿›è¡ŒåŒ…è£…ï¼Œè½¬æ¢æå–ä¸ºç½‘å…³è¿è¡Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè€Œåœ¨Spring Cloud gatewayä¸­ç½‘å…³çš„ä¸Šä¸‹æ–‡ä¸ºServerWebExchangeã€‚ 2.1 å…¥å£HttpServerRequestå’ŒHttpServerResponseè½¬æ¢Spring Cloud Gatewayçš„è¯·æ±‚å…¥å£ï¼Œorg.springframework.http.server.reactive.ReactorHttpHandlerAdapter#applyæ–¹æ³• 123456789101112131415161718192021222324@Override public Mono&lt;Void&gt; apply(HttpServerRequest request, HttpServerResponse response) &#123; NettyDataBufferFactory bufferFactory = new NettyDataBufferFactory(response.alloc()); ServerHttpRequest adaptedRequest; ServerHttpResponse adaptedResponse; try &#123; adaptedRequest = new ReactorServerHttpRequest(request, bufferFactory); adaptedResponse = new ReactorServerHttpResponse(response, bufferFactory); &#125; catch (URISyntaxException ex) &#123; logger.error(\"Invalid URL \" + ex.getMessage(), ex); response.status(HttpResponseStatus.BAD_REQUEST); return Mono.empty(); &#125; if (adaptedRequest.getMethod() == HttpMethod.HEAD) &#123; adaptedResponse = new HttpHeadResponseDecorator(adaptedResponse); &#125; return this.httpHandler.handle(adaptedRequest, adaptedResponse) .doOnError(ex -&gt; logger.error(\"Handling completed with error\", ex)) .doOnSuccess(aVoid -&gt; logger.debug(\"Handling completed with success\")); &#125; PSï¼Œä»£ç æ¥æºäºspring-web-5.0.4.RELEASE.jaræ­¤æ–¹æ³•ä¸ºSpring Cloud Gatewayçš„è¯·æ±‚å…¥å£æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯æŠŠæ¥æ”¶åˆ°çš„HttpServerRequestæˆ–è€…æœ€ç»ˆéœ€è¦è¿”å›çš„HttpServerResponseï¼ŒåŒ…è£…è½¬æ¢ä¸ºReactorServerHttpRequestå’ŒReactorServerHttpResponseã€‚ 2.2 æ„é€ Spring Cloud gatewayçš„ä¸Šä¸‹æ–‡ServerWebExchangeåœ¨org.springframework.web.server.adapter.HttpWebHandlerAdapterçš„182è¡Œï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º: 1234567@Override public Mono&lt;Void&gt; handle(ServerHttpRequest request, ServerHttpResponse response) &#123; ServerWebExchange exchange = createExchange(request, response); return getDelegate().handle(exchange) .onErrorResume(ex -&gt; handleFailure(request, response, ex)) .then(Mono.defer(response::setComplete)); &#125; createExchange()å°†ServerHttpRequest ServerHttpResponseæ„å»ºç½‘å…³ä¸Šä¸‹æ–‡ServerWebExchangeã€‚ PS:å…¶ä¸­org.springframework.web.server.handler.WebHandlerDecorator.getDelegate()é€šè¿‡å§”æ‰˜çš„æ–¹å¼è·å–ä¸€ç³»åˆ—éœ€è¦å¤„ç†çš„WebHandler. 2.3 è¿›å…¥Filteré“¾org.springframework.cloud.gateway.handler.FilteringWebHandler#handleæ–¹æ³•ï¼Œå³77è¡Œï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º 12345678910111213@Overridepublic Mono&lt;Void&gt; handle(ServerWebExchange exchange) &#123; Route route = exchange.getRequiredAttribute(GATEWAY_ROUTE_ATTR); List&lt;GatewayFilter&gt; gatewayFilters = route.getFilters(); List&lt;GatewayFilter&gt; combined = new ArrayList&lt;&gt;(this.globalFilters); combined.addAll(gatewayFilters); //TODO: needed or cached? AnnotationAwareOrderComparator.sort(combined); logger.debug(\"Sorted gatewayFilterFactories: \"+ combined); return new DefaultGatewayFilterChain(combined).filter(exchange);&#125; 2.4 æ‰§è¡ŒFilteré“¾1234567891011121314151617181920private static class DefaultGatewayFilterChain implements GatewayFilterChain &#123; private int index; private final List&lt;GatewayFilter&gt; filters; public DefaultGatewayFilterChain(List&lt;GatewayFilter&gt; filters) &#123; this.filters = filters; &#125; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange) &#123; if (this.index &lt; filters.size()) &#123; GatewayFilter filter = filters.get(this.index++); return filter.filter(exchange, this); &#125; else &#123; return Mono.empty(); // complete &#125; &#125; &#125; 2.5 Gateway Filterå§”æ‰˜ä¸ºGloable Filteræ‰§è¡Œ123456789101112131415161718192021private static class GatewayFilterAdapter implements GatewayFilter &#123; private final GlobalFilter delegate; public GatewayFilterAdapter(GlobalFilter delegate) &#123; this.delegate = delegate; &#125; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; return this.delegate.filter(exchange, chain); &#125; @Override public String toString() &#123; final StringBuilder sb = new StringBuilder(\"GatewayFilterAdapter&#123;\"); sb.append(\"delegate=\").append(delegate); sb.append('&#125;'); return sb.toString(); &#125; &#125; 2.6 é¢„å‘Šå¾…ç»­åœ¨ä¹‹åçš„æ–‡ç« ä¸­ï¼Œå°†ä¼šæ­ç§˜Spring Cloud Gatewayçš„æ¶æ„è®¾è®¡ï¼ŒFilteré“¾è®¾è®¡ï¼Œä»¥åŠå¯åŠ¨è£…åœ¨æµç¨‹ç­‰ã€‚","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud æºç åˆ†æ","slug":"Spring-Cloud-æºç åˆ†æ","permalink":"http://xujin.org/tags/Spring-Cloud-æºç åˆ†æ/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹","slug":"sc/gw/gw-01","date":"2018-03-15T06:00:00.000Z","updated":"2019-01-12T03:21:16.579Z","comments":true,"path":"sc/gw/gw-01/","link":"","permalink":"http://xujin.org/sc/gw/gw-01/","excerpt":"æ‘˜è¦:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†ä»€ä¹ˆæ˜¯Spring Cloud Gatewayï¼Œå¹¶åŸºäºSpring Cloud Gatewayçš„Finchley.M8ç‰ˆæœ¬ç¼–å†™ä¸€ä¸ªSpring Cloud Gatewayçš„å…¥é—¨æ¡ˆä¾‹ï¼Œå³åŸºæœ¬ä»£ç†çš„è·¯ç”±è½¬å‘é…ç½®ã€‚","text":"æ‘˜è¦:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†ä»€ä¹ˆæ˜¯Spring Cloud Gatewayï¼Œå¹¶åŸºäºSpring Cloud Gatewayçš„Finchley.M8ç‰ˆæœ¬ç¼–å†™ä¸€ä¸ªSpring Cloud Gatewayçš„å…¥é—¨æ¡ˆä¾‹ï¼Œå³åŸºæœ¬ä»£ç†çš„è·¯ç”±è½¬å‘é…ç½®ã€‚ 1.Spring Gatewayæ¦‚è¿°1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway Spring Cloud Gatewayæ˜¯Springå®˜æ–¹åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0å’ŒProject Reactorç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼ŒSpring Cloud Gatewayæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„ç»Ÿä¸€çš„APIè·¯ç”±ç®¡ç†æ–¹å¼ã€‚Spring Cloud Gatewayä½œä¸ºSpring Cloudç”Ÿæ€ç³»ä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£Netflix ZUULï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäºFilteré“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§/åŸ‹ç‚¹ï¼Œå’Œé™æµç­‰ã€‚ 2. Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹2.1 åˆ›å»ºmavenå·¥ç¨‹é…ç½®Spring Cloud Gatewayçš„ç›¸å…³Mavenä¾èµ– 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt; &lt;parent&gt; &lt;artifactId&gt;ch18-1&lt;/artifactId&gt; &lt;groupId&gt;cn.springcloud.book&lt;/groupId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;/parent&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;artifactId&gt;ch18-1-gateway&lt;/artifactId&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;name&gt;ch18-1-gateway&lt;/name&gt; &lt;url&gt;http://springcloud.cn&lt;/url&gt; &lt;properties&gt; &lt;spring-cloud.version&gt;Finchley.M8&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;repositories&gt; &lt;repository&gt; &lt;id&gt;spring-snapshots&lt;/id&gt; &lt;name&gt;Spring Snapshots&lt;/name&gt; &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/repository&gt; &lt;repository&gt; &lt;id&gt;spring-milestones&lt;/id&gt; &lt;name&gt;Spring Milestones&lt;/name&gt; &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;false&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/repository&gt; &lt;/repositories&gt; &lt;pluginRepositories&gt; &lt;pluginRepository&gt; &lt;id&gt;spring-snapshots&lt;/id&gt; &lt;name&gt;Spring Snapshots&lt;/name&gt; &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;true&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/pluginRepository&gt; &lt;pluginRepository&gt; &lt;id&gt;spring-milestones&lt;/id&gt; &lt;name&gt;Spring Milestones&lt;/name&gt; &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt; &lt;snapshots&gt; &lt;enabled&gt;false&lt;/enabled&gt; &lt;/snapshots&gt; &lt;/pluginRepository&gt; &lt;/pluginRepositories&gt;&lt;/project&gt; 2.2 Spring Cloud Gatewayä¸»ç¨‹åºSpringCloudGatewayApplication.javaï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º: 12345678910111213141516171819202122232425package cn.springcloud.book.gateway;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.cloud.gateway.route.RouteLocator;import org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;import org.springframework.context.annotation.Bean;@SpringBootApplicationpublic class SpringCloudGatewayApplication &#123; @Bean public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123; return builder.routes() //basic proxy .route(r -&gt; r.path(\"/baidu\") .uri(\"http://baidu.com:80/\") ).build(); &#125; public static void main(String[] args) &#123; SpringApplication.run(SpringCloudGatewayApplication.class, args); &#125;&#125; 2.3 ç¼–å†™application.ymlæ–‡ä»¶123456789101112131415161718192021server: port: 8080spring: application: name: spring-cloud-gatewayspring: cloud: gateway: routes: - id: xujin_route uri: http://www.xujin.org:80/ predicates: - Path=/xujinlogging: level: org.springframework.cloud.gateway: TRACE org.springframework.http.server.reactive: DEBUG org.springframework.web.reactive: DEBUG reactor.ipc.netty: DEBUG 2.4 åŸºæœ¬ä»£ç†è·¯ç”±é…ç½®ç­‰åŒå†™æ³•Spring Cloud Gatewayæä¾›äº†ä¸¤ç§é…ç½®è·¯ç”±è§„åˆ™çš„æ–¹æ³• ç¬¬ä¸€:é€šè¿‡@Beanè‡ªå®šä¹‰RouteLocator12345678@Beanpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123; return builder.routes() //basic proxy .route(r -&gt; r.path(\"/baidu\") .uri(\"http://baidu.com:80/\") ).build();&#125; ç¬¬äºŒ:é€šè¿‡å±äºæ–‡ä»¶æˆ–è€…ymlæ–‡ä»¶é…ç½® 12345678spring: cloud: gateway: routes: - id: xujin_route uri: http://www.xujin.org:80/ predicates: - Path=/xujin PS,ä»¥ä¸Šä¸¤ç§æ–¹å¼ç­‰åŒã€‚ 2.5 é”™è¯¯çš„ç¤ºèŒƒä»£ç å¦‚ä¸‹:12345678@Beanpublic RouteLocator routingConfig() &#123; return Routes.locator() .route(\"xujin_route\") .uri(\"http://xujin.org\") .predicate(host(\"**.xujin.org\")) .build();&#125; æ¸©é¦¨æç¤ºï¼Œä¸Šé¢è¿™ç§å†™æ³•æ˜¯åŸºäºSpring Cloud Gateway FM4çš„ç‰ˆæœ¬ï¼Œç›¸å…³ä»£ç å·²åºŸå¼ƒï¼Œç›®å‰Spring Cloud Gatewayå°†ä¼šåœ¨FM9ä¹‹åRealeseã€‚ 2.6 è¿è¡Œæµ‹è¯• è®¿é—®http://localhost:8080/baidu,è·¯ç”±è½¬å‘åˆ°http://www.baidu.com è®¿é—®http://localhost:8080/xujin,è·¯ç”±è½¬å‘åˆ°http://xujin.orgyml 12345678@Bean public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123; return builder.routes() //basic proxy .route(r -&gt; r.path(\"/baidu\") .uri(\"http://baidu.com:80/\") ).build(); &#125; 12345678spring: cloud: gateway: routes: - id: xujin_route uri: http://www.xujin.org:80/ predicates: - Path=/xujin","categories":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/categories/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud æºç åˆ†æ","slug":"Spring-Cloud-æºç åˆ†æ","permalink":"http://xujin.org/tags/Spring-Cloud-æºç åˆ†æ/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://xujin.org/tags/Spring-Cloud-Gateway/"}]},{"title":"SCä¸­Eureka Serverçš„HAå’Œå®‰å…¨èº«ä»½éªŒè¯","slug":"sc/sc-eureka-02","date":"2017-03-25T06:00:00.000Z","updated":"2019-01-12T03:48:16.249Z","comments":true,"path":"sc/sc-eureka-02/","link":"","permalink":"http://xujin.org/sc/sc-eureka-02/","excerpt":"æ‘˜è¦:åœ¨ã€Šè·Ÿæˆ‘å­¦Spring Cloudã€‹ä¸­çš„ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ç®€å•ä»‹ç»äº†ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»ä¸€ä¸‹Eureka Serveræ³¨å†Œä¸­å¿ƒçš„HAä»¥åŠEureka Serverçš„èº«ä»½éªŒè¯ã€‚","text":"æ‘˜è¦:åœ¨ã€Šè·Ÿæˆ‘å­¦Spring Cloudã€‹ä¸­çš„ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ç®€å•ä»‹ç»äº†ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»ä¸€ä¸‹Eureka Serveræ³¨å†Œä¸­å¿ƒçš„HAä»¥åŠEureka Serverçš„èº«ä»½éªŒè¯ã€‚ ä»€ä¹ˆæ˜¯é«˜å¯ç”¨é«˜å¯ç”¨ High Availabilityï¼Œå³é«˜å¯ç”¨HAã€‚åœ¨åˆ†å¸ƒå¼æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç»å¸¸è¯´4ä¸ª9(99.99%)æˆ–è€…5ä¸ª9(99.999%)ã€‚ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªå¾®æœåŠ¡åˆ†å¸ƒå¼ç³»ç»Ÿä¾èµ–äº30ä¸ªå¾®æœåŠ¡ï¼Œæ¯ä¸ªå¾®æœåŠ¡å¯ç”¨æ€§æ˜¯99.99%ï¼Œé‚£ä¹ˆæ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿçš„å¯ç”¨æ€§å°±æ˜¯99.99%çš„30æ¬¡æ–¹ â‰ˆ 99.7% ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰0.3%ç³»ç»Ÿæ˜¯ä¸å¯ç”¨çš„ï¼Œ0.3%æ„å‘³ç€å¦‚æœQpså¾ˆé«˜ï¼Œæœ‰ä¸€äº¿æ¬¡è¯·æ±‚çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰30ä¸‡æ¬¡å¤±è´¥ã€‚æ¢ç®—æˆæ—¶é—´å¤§çº¦æ¯æœˆæœ‰2ä¸ªå°æ—¶æœåŠ¡ä¸ç¨³å®šã€‚ç‰¹åˆ«æ˜¯éšç€æœåŠ¡ä¾èµ–æ•°é‡çš„å˜å¤šï¼Œå¾®æœåŠ¡ä¸ç¨³å®šçš„æ¦‚ç‡ä¼šæˆæŒ‡æ•°æ€§ä¸Šå‡ã€‚å› æ­¤è¦ä¿è¯å¾®æœåŠ¡åº”ç”¨çš„HAéœ€è¦ä»å„æ–¹é¢å…¥æ‰‹ï¼Œä¸‹é¢ä¼šä»‹ç»ä¸€ä¸‹å¦‚ä½•å®ç°Eureka Serverçš„HAã€‚å‚è€ƒå·¥ç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚ Tipsï¼šä»£ç ç¤ºä¾‹:https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-ha Eureka Serverçš„HAEureka Serverçš„HAä¸¤ä¸ªå·¥ç¨‹æ¼”ç¤ºHA å¦‚ç¤ºä¾‹å·¥ç¨‹æ‰€ç¤ºï¼Œæˆ‘æ–°å»ºäº†ä¸¤ä¸ªProjectåˆ†åˆ«ä¸ºsc-eureka-ha-server1ï¼Œsc-eureka-ha-server2ï¼Œ æˆ‘ä»¬çŸ¥é“åœ¨Eureka Serverçš„Standaloneæ¨¡å¼ä¸‹é¢ï¼Œç”±äºåªæœ‰ä¸€ä¸ªEureka Serverï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡é…ç½®å¦‚ä¸‹ä¿¡æ¯å…³é—­Eureka Serverçš„è‡ªæˆ‘æ³¨å†Œå’ŒæŠ“å–æ³¨å†Œä¿¡æ¯ï¼Œä½†æ˜¯ä¸¤ä¸ªEureka Serverä¹‹é—´éœ€è¦è®¾ç½®ä¸ºTrueï¼Œç›¸äº’æ³¨å†Œç›¸äº’æ„ŸçŸ¥å¯¹æ–¹æ³¨å†Œä¿¡æ¯çš„å˜åŒ–ï¼Œä»è€Œå®ç°ä¿¡æ¯åŒæ­¥ã€‚ 1.sc-eureka-ha-server1çš„application.ymlé…ç½®Info å¦‚ä¸‹ï¼š 123456789spring: application: name: sc-eureka-ha-server1server: port: 8761 # æŒ‡å®šè¯¥Eurekaå®ä¾‹çš„ç«¯å£eureka: client: serviceUrl: defaultZone: http://localhost:8762/eureka/ 2.sc-eureka-ha-server2çš„application.ymlé…ç½®Info å¦‚ä¸‹ 12345678910spring: application: name: sc-eureka-ha-server2 server: port: 8762 # æŒ‡å®šè¯¥Eurekaå®ä¾‹çš„ç«¯å£eureka: client: serviceUrl: defaultZone: http://localhost:8761/eureka/ 3.ä¸»ç¨‹åºå…¥å£ä»£ç æ²¡ä»€ä¹ˆåŒºåˆ«å¦‚ä¸‹: 1234567@EnableEurekaServer@SpringBootApplicationpublic class EurekaServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(EurekaServerApplication.class, args); &#125;&#125; 4.åˆ†åˆ«å¯åŠ¨sc-eureka-ha-server1å’Œsc-eureka-ha-server2ï¼Œè®¿é—®http://localhost:8761/ ,http://localhost:8762/ ï¼Œå¦‚ä¸‹: 5.æœåŠ¡æä¾›è€…sc-eureka-ha-providerå…¶å®ƒä»£ç è§å·¥ç¨‹,application.ymlå¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011 server: port: 8000 spring: application: name: sc-eureka-ha-provider eureka: client: service-url: defaultZone: http://localhost:8761/eureka/ tips: æŠŠæœåŠ¡æä¾›è€…çš„æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼Œæ³¨å†Œåˆ°Eureka Server 01ä¸Šã€‚ å¯åŠ¨æœåŠ¡æä¾›è€…ï¼Œè§å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ç‰‡åˆ»æœåŠ¡æä¾›è€…çš„ä¿¡æ¯ä¹ŸåŒæ­¥åˆ°Eureka Server02ä¸Šé¢ Jaræ–¹å¼æ¼”ç¤ºHA Eureka Serverçš„HAï¼Œå…¶å®å¯ä»¥é€šè¿‡jarçš„æ–¹å¼æŒ‡å®šä½¿ç”¨ä¸åŒçš„profileé…ç½®çš„æ–¹å¼ï¼Œåœ¨æœ¬åœ°è¿è¡Œä¸¤ä¸ªEureka Serverã€‚åªéœ€å°†Eureka serverçš„application.ymlä¿®æ”¹å¦‚ä¸‹ï¼š12345678910111213141516171819202122232425spring: application: name: sc-eureka-ha-server --- spring: profiles: peer1 server: port: 8761 eureka: instance: hostname: peer1.xujin.org client: serviceUrl: defaultZone: http://peer2.xujin.org:8762/eureka/ --- spring: profiles: peer2 server: port: 8762 eureka: instance: hostname: peer2.xujin.org client: serviceUrl: defaultZone: http://peer1.xujin.org:8761/eureka/ é€šè¿‡é…ç½®switcHostsæˆ–è€…è‡ªè¡Œé…ç½®HostNameå¯¹åº”çš„IPåœ°å€,æŠŠå·¥ç¨‹æ‰“æˆjarä¹‹åï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤123 java -jar sc-eureka-ha-server1-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer2java -jar sc-eureka-ha-server1-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer1 æµ‹è¯•å¦‚ä¸‹: å®‰å…¨èº«ä»½éªŒè¯ å¦‚æœå®¢æˆ·ç«¯çš„eureka.client.serviceUrl.defaultZoneå‚æ•°å€¼(å³Eureka Serverçš„åœ°å€)ä¸­åŒ…å«HTTP Basic Authenticationä¿¡æ¯ï¼Œå¦‚http://user:password@localhost:8761/eurekaï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°±ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥ç”¨æˆ·åã€å¯†ç ä¿¡æ¯ä¸EurekaæœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ã€‚å¦‚æœä½ éœ€è¦æ›´å¤æ‚çš„éªŒè¯é€»è¾‘ï¼Œä½ å¿…é¡»æ³¨å†Œä¸€ä¸ªDiscoveryClientOptionalArgsç»„ä»¶ï¼Œå¹¶å°†ClientFilterç»„ä»¶æ³¨å…¥ï¼Œåœ¨è¿™é‡Œå®šä¹‰çš„é€»è¾‘ä¼šåœ¨æ¯æ¬¡å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚æ—¶æ‰§è¡Œã€‚ Tipsï¼šä»£ç ç¤ºä¾‹:https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-security è®¿é—®Eureka Serverå®‰å…¨èº«ä»½éªŒè¯ å¦‚å·¥ç¨‹sc-eureka-securitä¸­çš„sc-eureka-security-serverå·¥ç¨‹æ‰€ç¤ºï¼Œåœ¨pom.xmlä¸­å¢åŠ ä¾èµ–å¦‚ä¸‹: 1234 &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlå¦‚ä¸‹ 123456789101112131415161718 server: port: 8761 # æŒ‡å®šè¯¥Eurekaå®ä¾‹çš„ç«¯å£eureka: client: #è¡¨ç¤ºæ˜¯å¦å°†è‡ªå·±æ³¨å†Œåˆ°Eureka Serverä¸Šï¼Œé»˜è®¤ä¸ºtrueï¼Œå½“å‰åº”ç”¨ä¸ºEureka Serveræ‰€ä»¥æ— éœ€æ³¨å†Œ registerWithEureka: false #è¡¨ç¤ºæ˜¯å¦ä»Eureka Serverè·å–æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªå•ç‚¹çš„Eureka Serverï¼Œä¸éœ€è¦åŒæ­¥å…¶ä»–çš„Eureka ServerèŠ‚ç‚¹çš„æ•°æ®ï¼Œæ•…è€Œè®¾ä¸ºfalseã€‚ fetchRegistry: false #Eureka Serverçš„è®¿é—®åœ°å€ï¼ŒæœåŠ¡æ³¨å†Œå’Œclientè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯å‡é€šè¿‡è¯¥URLï¼Œå¤šä¸ªæœåŠ¡æ³¨å†Œåœ°å€ç”¨,éš”å¼€ serviceUrl: defaultZone: http://localhost:8761/eureka/ security: basic: enabled: true user: name: xujin password: 123 3.å¯åŠ¨Eureka serveræµ‹è¯•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º æœåŠ¡æä¾›è€…æ³¨å†ŒEureka Serverå®‰å…¨èº«ä»½éªŒè¯1.æœåŠ¡æä¾›è€…åªéœ€æ³¨å†Œæ—¶ä¿®æ”¹application.yml 1234567891011 server: port: 8000 spring: application: name: sc-eureka-security-provider eureka: client: service-url: defaultZone: http://xujin:123@localhost:8761/eureka/ Tips:å¦‚ä¸Šæ‰€ç¤º:http://ç”¨æˆ·å:å¯†ç @localhost:8761/eureka/","categories":[{"name":"è·Ÿæˆ‘å­¦Spring Cloud","slug":"è·Ÿæˆ‘å­¦Spring-Cloud","permalink":"http://xujin.org/categories/è·Ÿæˆ‘å­¦Spring-Cloud/"}],"tags":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/tags/Spring-Cloud-Eureka/"}]},{"title":"ä½¿ç”¨Spring Cloud Eurekaå®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°","slug":"sc/sc-eureka-01","date":"2017-03-23T06:00:00.000Z","updated":"2019-01-12T03:48:54.822Z","comments":true,"path":"sc/sc-eureka-01/","link":"","permalink":"http://xujin.org/sc/sc-eureka-01/","excerpt":"æ‘˜è¦:ç”±äºç›®å‰ï¼Œç½‘ä¸Šçš„Spring Cloudçš„å­¦ä¹ çš„æ¡ˆåˆ—ï¼Œæ¯”è¾ƒå‡Œä¹±è€Œä¸”æ²¡æœ‰å½¢æˆæ•´ä¸ªä½“ç³»ï¼Œå› æ­¤ç‰¹å¼€ä¸€ä¸ªä¸“é¢˜ä¸ºè·Ÿæˆ‘å­¦Spring Cloudï¼Œå¸Œæœ›å¸®åŠ©åˆ°æœ‰éœ€è¦çš„äººã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨Spring Cloudä¸­çš„Eurekaç»„ä»¶å¿«é€Ÿå®ç°å¾®æœåŠ¡çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚è‡³äºå®‰å…¨æ¨¡å¼å’ŒEureka Serverçš„HA,åé¢çš„æ–‡ç« ä¼šè¯¦ç»†ä»‹ç»ã€‚å¦‚æœæ‚¨è§‰å¾—ï¼Œæœ‰æƒ³äº†è§£çš„å†…å®¹ï¼Œå‚ä¸è¯„è®ºç•™è¨€ã€‚","text":"æ‘˜è¦:ç”±äºç›®å‰ï¼Œç½‘ä¸Šçš„Spring Cloudçš„å­¦ä¹ çš„æ¡ˆåˆ—ï¼Œæ¯”è¾ƒå‡Œä¹±è€Œä¸”æ²¡æœ‰å½¢æˆæ•´ä¸ªä½“ç³»ï¼Œå› æ­¤ç‰¹å¼€ä¸€ä¸ªä¸“é¢˜ä¸ºè·Ÿæˆ‘å­¦Spring Cloudï¼Œå¸Œæœ›å¸®åŠ©åˆ°æœ‰éœ€è¦çš„äººã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨Spring Cloudä¸­çš„Eurekaç»„ä»¶å¿«é€Ÿå®ç°å¾®æœåŠ¡çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚è‡³äºå®‰å…¨æ¨¡å¼å’ŒEureka Serverçš„HA,åé¢çš„æ–‡ç« ä¼šè¯¦ç»†ä»‹ç»ã€‚å¦‚æœæ‚¨è§‰å¾—ï¼Œæœ‰æƒ³äº†è§£çš„å†…å®¹ï¼Œå‚ä¸è¯„è®ºç•™è¨€ã€‚ ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°æœåŠ¡æ³¨å†Œä¸å‘ç° åœ¨æœåŠ¡åŒ–çš„æ—©æœŸï¼ŒæœåŠ¡ä¸æ˜¯å¾ˆå¤šï¼ŒæœåŠ¡çš„æ³¨å†Œä¸å‘ç°å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œçš„åè¯ï¼ŒNginx+å†…éƒ¨åŸŸåæœåŠ¡å™¨æ–¹å¼ï¼Œç”šè‡³Nginx+hostæ–‡ä»¶é…ç½®æ–¹å¼ä¹Ÿèƒ½å®ŒæˆæœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚æœåŠ¡ä¸Šä¸‹çº¿éœ€è¦åœ¨nginx,æœåŠ¡å™¨åšç›¸åº”çš„é…ç½®ï¼Œä¸€æ—¦æœåŠ¡çš„IPç«¯å£å‘ç”Ÿå˜åŒ–ï¼Œéƒ½éœ€è¦åœ¨nginxä¸Šåšç›¸åº”çš„é…ç½®ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å¼•å…¥æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚ æœåŠ¡æ³¨å†Œ,å³æœåŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™å°±å°†æœåŠ¡çš„IP,ç«¯å£,ç‰ˆæœ¬å·ç­‰EndPointæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ(Eueka,Zookeeper,Consul)å¯¹æœåŠ¡è¿›è¡Œç»Ÿä¸€ç®¡ç†. æœåŠ¡å‘ç°,ç®€å•çš„å°±æ˜¯è¯´ï¼Œä¸ç®¡æœåŠ¡ä¸Šä¸‹çº¿ï¼Œå½“å¯¹æŸä¸ªæœåŠ¡å‘èµ·è¯·æ±‚æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿçš„ä»æœ¬åœ°ç¼“å­˜æˆ–è€…æ³¨å†Œä¸­å¿ƒçš„æ³¨å†Œåˆ—è¡¨ä¸­ï¼Œå¿«é€Ÿæ‰¾åˆ°æœåŠ¡æä¾›è€…ã€‚ æœåŠ¡åŒ–æ—©æœŸçš„åšæ³•ç¤ºä¾‹å·¥ç¨‹è¯´æ˜ Tipsï¼šä»£ç ç¤ºä¾‹:https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-first Spring MVCä¸­åŸºäºæ— çŠ¶æ€çš„REST å·¥ç¨‹å¯ä»¥å‚è€ƒsc-rest-demoä¸‹é¢çš„sc-rest-providerå’Œsc-rest-consumerï¼Œå…·ä½“ä½¿ç”¨å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š123456789101112131415161718192021@RestController@RequestMapping(\"/sc\")public class ConsumerController &#123; @Autowired private RestTemplate restTemplate; // ä»å±æ€§æ–‡ä»¶ä¸­è¯»å–æœåŠ¡æä¾›çš„URL @Value(\"$&#123;order.orderServiceUrl&#125;\") private String orderServiceUrl; @GetMapping(\"/consumer/&#123;id&#125;\") public OrderModel getOrderInfo(@PathVariable Long id) &#123; // this.restTemplate.getForObject(\"http://localhost:8000/sc/order/\" + // id,OrderModel.class); return this.restTemplate.getForObject(this.orderServiceUrl + \"/sc/order/\" + id, OrderModel.class); &#125;&#125; å¤§å®¶æ³¨æ„åˆ°æ²¡ï¼ŒæŠŠhttp://localhost:8000 ,ç¡¬ç¼–ç åˆ°ç¨‹åºä¸­ï¼Œæ˜¯ä¸æ˜¯æ¯”è¾ƒlowã€‚å¯ä»¥é‡‡ç”¨ä¸Šé¢ä»£ç ä¸­çš„æ–¹å¼ï¼šorderServiceUrlè§£å†³ã€‚ä½†æ˜¯è¿™æ ·è¿˜æ˜¯æ¯”è¾ƒlow,ä¸‹é¢ä»‹ç»ä¸€ä¸‹å¼•å…¥Eurekaå®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°çš„å¤„ç†ã€‚ ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°æ­å»ºæ³¨å†Œä¸­å¿ƒ-Eureka Server 1.å¼•å…¥ä¾èµ–123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051&lt;?xml version=\"1.0\"?&gt;&lt;project xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\" xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;!-- å¼•å…¥spring bootçš„ä¾èµ– --&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;1.4.3.RELEASE&lt;/version&gt; &lt;/parent&gt; &lt;artifactId&gt;sc-eureka-first-server-HA01&lt;/artifactId&gt; &lt;name&gt;sc-eureka-first-server-HA01&lt;/name&gt; &lt;url&gt;http://maven.apache.org&lt;/url&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;!-- å¼•å…¥Spring Cloud Eurekaä¾èµ– --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;!-- å¼•å…¥spring cloudçš„ä¾èµ– --&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Camden.SR5&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; &lt;!-- æ·»åŠ spring-bootçš„mavenæ’ä»¶--&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; åœ¨Resourcesç›®å½•ä¸‹åˆ›å»ºapplication.yml123456789101112131415server: port: 8761 # æŒ‡å®šè¯¥Eurekaå®ä¾‹çš„ç«¯å£eureka: client: #è¡¨ç¤ºæ˜¯å¦å°†è‡ªå·±æ³¨å†Œåˆ°Eureka Serverä¸Šï¼Œé»˜è®¤ä¸ºtrueï¼Œå½“å‰åº”ç”¨ä¸ºEureka Serveræ‰€ä»¥æ— éœ€æ³¨å†Œ registerWithEureka: false #è¡¨ç¤ºæ˜¯å¦ä»Eureka Serverè·å–æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªå•ç‚¹çš„Eureka Serverï¼Œä¸éœ€è¦åŒæ­¥å…¶ä»–çš„Eureka ServerèŠ‚ç‚¹çš„æ•°æ®ï¼Œæ•…è€Œè®¾ä¸ºfalseã€‚ fetchRegistry: false #Eureka Serverçš„è®¿é—®åœ°å€ï¼ŒæœåŠ¡æ³¨å†Œå’Œclientè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯å‡é€šè¿‡è¯¥URLï¼Œå¤šä¸ªæœåŠ¡æ³¨å†Œåœ°å€ç”¨,éš”å¼€ serviceUrl: defaultZone: http://localhost:8761/eureka/# å‚è€ƒæ–‡æ¡£ï¼šhttp://projects.spring.io/spring-cloud/docs/1.0.3/spring-cloud.html#_standalone_mode# å‚è€ƒæ–‡æ¡£ï¼šhttp://my.oschina.net/buwei/blog/618756 3.åˆ›å»ºSpring Bootä¸»åº”ç”¨ç¨‹åºå¯åŠ¨ä»£ç 12345678910111213141516171819package org.xujin.sc.eureka.server;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;/** * Eureka Server * @author xujin */@SpringBootApplication@EnableEurekaServerpublic class SpringCloudEurekaServer &#123; public static void main(String[] args) &#123; SpringApplication.run(SpringCloudEurekaServer.class, args); &#125;&#125; å¯åŠ¨Eureka serveræµ‹è¯•ï¼š å¯åŠ¨sc-eureka-first-server-HA01ï¼Œè®¿é—®http://localhost:8761/ ,å¦‚ä¸‹å›¾æ‰€ç¤º: åˆ›å»ºæœåŠ¡æä¾›è€… 1.æœåŠ¡æä¾›è€…ï¼Œä¸ºäº†æ¼”ç¤ºåœ¨è¿™é‡Œæä¾›ä¸€ä¸ªç®€å•çš„è®¢å•æŸ¥è¯¢æœåŠ¡ï¼Œå¦‚å·¥ç¨‹sc-eureka-first-provider01å’Œsc-eureka-first-provider02æ‰€ç¤ºã€‚ 2.ä¸»ç¨‹åºå…¥å£ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š123456789101112131415161718192021package org.xujin.sc.eureka.first.order;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.cloud.client.discovery.EnableDiscoveryClient;/** * æœåŠ¡æä¾›è€…ç«¯ï¼ŒåŠ ä¸Š@EnableDiscoveryClientæ³¨è§£ï¼Œå®ŒæˆæœåŠ¡æ³¨å†Œã€‚ * @author xujin * @site http://xujin.org */@SpringBootApplication@EnableDiscoveryClient// @EnableEurekaClientpublic class OrderProviderSpringBootAppliaction &#123; public static void main(String[] args) &#123; SpringApplication.run(OrderProviderSpringBootAppliaction.class, args); &#125;&#125; Tips:å¦‚æœä½¿ç”¨Eureka, å¯ä»¥ä½¿ç”¨@EnableEurekaClientæ³¨è§£ï¼Œä½†æ˜¯æ¨èä½¿ç”¨@EnableDiscoveryClientä»£æ›¿@EnableEurekaClientæ³¨è§£ï¼Œå› ä¸º@EnableDiscoveryClientæ˜¯ä¸€ä¸ªé«˜åº¦çš„æŠ½è±¡ï¼Œ æ¥è‡ªäºspring-cloud-commonsï¼Œ ç”±äºSpring Cloudé€‰å‹æ˜¯ä¸­ç«‹çš„å› æ­¤æŠ½è±¡å‡ºè¯¥æ¥å£ï¼Œ å½“æœåŠ¡æ³¨å†Œä¸­å¿ƒé€‰å‹æ”¹å˜ä¸ºEurekaï¼ŒZKï¼ŒConsulæ—¶ï¼Œä¸éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç ä¸­çš„æ³¨è§£ã€‚ 3.æœåŠ¡æä¾›è€…æš´éœ²çš„æœåŠ¡-OrderController.java12345678910111213@RestControllerpublic class OrderController &#123; @Autowired private OrderService orderService; @GetMapping(\"/sc/order/&#123;id&#125;\") public OrderModel findOrderById(@PathVariable Long id) &#123; OrderModel orderModel = orderService.findOrderByOrderId(id); return orderModel; &#125;&#125; å¯åŠ¨æœåŠ¡æä¾›è€…ï¼ŒæŠŠæœåŠ¡æ³¨å†Œä¿¡æ¯ï¼Œæ³¨å†Œåˆ°Eureka Serveræ³¨å†Œä¸­å¿ƒå¯åŠ¨sc-eureka-first-provider01,å½“å¯åŠ¨å…¶ä¸­ä¸€ä¸ªæœåŠ¡ååˆ·æ–°Eureka Serverä¼šå‡ºç°å®‰å…¨æ¨¡å¼,å¦‚ä¸‹å›¾æ‰€ç¤º: å¯åŠ¨sc-eureka-first-provider02ï¼Œåˆ·æ–°Eureka Serverå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ åˆ›å»ºæœåŠ¡æ¶ˆè´¹è€… æœåŠ¡æ¶ˆè´¹è€…ä¸»è¦æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æˆ·æœåŠ¡ï¼Œç”¨æˆ·æœåŠ¡æŸ¥è¯¢è®¢å•æœåŠ¡çš„è®¢å•ä¿¡æ¯ã€‚ 1.å¼•å…¥ç›¸åº”çš„ä¾èµ– 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869 &lt;?xml version=\"1.0\"?&gt;&lt;project xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\" xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;org.xujin.sc&lt;/groupId&gt; &lt;artifactId&gt;sc-eureka-first-consumer&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;sc-eureka-first-consumer&lt;/name&gt; &lt;url&gt;http://maven.apache.org&lt;/url&gt; &lt;!-- å¼•å…¥spring bootçš„ä¾èµ– --&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;1.4.3.RELEASE&lt;/version&gt; &lt;/parent&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.16.6&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;!-- å¼•å…¥spring cloudçš„ä¾èµ– --&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Camden.SR4&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;!-- æ·»åŠ spring-bootçš„mavenæ’ä»¶ --&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; 2.ä¸»ç¨‹åºå…¥å£ä»£ç 12345678910111213141516171819202122package org.xujin.sc.eureka.user;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.cloud.client.discovery.EnableDiscoveryClient;import org.springframework.context.annotation.Bean;import org.springframework.web.client.RestTemplate;//æ¶ˆè´¹è€…ç«¯åŠ å…¥æœåŠ¡å‘ç°æ³¨è§£@EnableDiscoveryClient@SpringBootApplicationpublic class UserConsumerApplication &#123; @Bean public RestTemplate restTemplate() &#123; return new RestTemplate(); &#125; public static void main(String[] args) &#123; SpringApplication.run(UserConsumerApplication.class, args); &#125;&#125; æ¶ˆè´¹è€…è°ƒç”¨Controllerã€‚ 12345678910111213141516171819202122232425262728@RestControllerpublic class UserController &#123; private static final Logger logger = LoggerFactory.getLogger(UserController.class); @Autowired private RestTemplate restTemplate; @Autowired private DiscoveryClient discoveryClient; // discoveryClientè·å–æœåŠ¡åˆ—è¡¨ä¸­ï¼Œåº”ç”¨åä¸ºsc-eureka-first-providerä¸€ä¸ªæœåŠ¡æ³¨å†Œä¿¡æ¯ public String serviceUrl() &#123; List&lt;ServiceInstance&gt; list = discoveryClient .getInstances(\"sc-eureka-first-provider\"); if (list != null &amp;&amp; list.size() &gt; 0) &#123; return String.valueOf(list.get(0).getUri()); &#125; return null; &#125; @GetMapping(\"/sc/user/&#123;id&#125;\") public Order findByIdByEurekaServer(@PathVariable Long id) &#123; String providerServiceUrl = serviceUrl(); return this.restTemplate.getForObject(providerServiceUrl + \"sc/order/\" + id, Order.class); &#125;&#125; å¦‚ä¸Šè¿°ä»£ç ï¼Œæ‰€ç¤ºä½¿ç”¨discoveryClient.getInstances(&quot;sc-eureka-first-provider&quot;)è·å–æœåŠ¡åä¸ºsc-eureka-first-providerçš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¿¡æ¯ã€‚ æµ‹è¯•å…ˆåå¯åŠ¨sc-eureka-first-consumer,å¦‚æ²¡æœ‰å¼‚å¸¸ï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®:http://localhost:8010/sc/user/2 ,debugå¦‚ä¸‹æ‰€ç¤ºå¯ä»¥çœ‹åˆ° åœ¨åˆ·æ–°ä¸€ä¸‹Eureka Serverï¼Œå¦‚å›¾ä¸‹æ‰€ç¤º,æ­¤æ—¶å®‰å…¨æ¨¡å¼å…³é—­ã€‚ å…³äºå®‰å…¨æ¨¡å¼ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæš‚ä¸è®¨è®ºï¼Œåé¢å°†ä¼šä¸“å†™ä¸€ç¯‡æ–‡ç« ä»‹ç»ï¼Œè¯·æš‚æ—¶å¿½ç•¥ã€‚ è·å–æ¶ˆè´¹è€…è·å–æœåŠ¡ç«¯æ¶ˆè´¹åˆ—è¡¨ ä½¿ç”¨EurekaClientè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯ 1234567 @Autowiredprivate EurekaClient discoveryClient;public String serviceUrl() &#123; InstanceInfo instance = discoveryClient.getNextServerFromEureka(\"STORES\", false); return instance.getHomePageUrl();&#125; ä½¿ç”¨DiscoveryClientè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯ 12345678910 @Autowiredprivate DiscoveryClient discoveryClient;public String serviceUrl() &#123; List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(\"STORES\"); if (list != null &amp;&amp; list.size() &gt; 0 ) &#123; return list.get(0).getUri(); &#125; return null;&#125; å‚è€ƒé“¾æ¥ï¼šhttps://github.com/spring-cloud/spring-cloud-netflix/blob/master/docs/src/main/asciidoc/spring-cloud-netflix.adoc å°ç»“ ä¸Šé¢è¿™ä¸ªä¾‹å­ä½¿ç”¨Eurekaå®ç°äº†æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯è·å–æœåŠ¡æ³¨å†Œåˆ—è¡¨çš„æ–¹å¼æ¯”è¾ƒlowå¹¶ä¸”å¤ªæ–¹ä¾¿ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ²¡æœ‰ä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼ˆLoad Balance)ï¼Œè¿™æ ·å°±æ²¡æ³•å®ç°å¾®æœåŠ¡çš„HAã€‚åœ¨åé¢çš„æ–‡ç« å°†ä¼šä»‹ç»Eureka Serverçš„HAå’Œä½¿ç”¨Robbinå®ç°LBã€‚ã€‚","categories":[{"name":"è·Ÿæˆ‘å­¦Spring Cloud","slug":"è·Ÿæˆ‘å­¦Spring-Cloud","permalink":"http://xujin.org/categories/è·Ÿæˆ‘å­¦Spring-Cloud/"}],"tags":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/tags/Spring-Cloud-Eureka/"}]},{"title":"Spring Cloud EurekaæœåŠ¡ä¸‹çº¿(Cancel)æºç åˆ†æ","slug":"sc/sc-eureka-cancle","date":"2016-11-19T06:00:00.000Z","updated":"2019-01-12T04:25:00.258Z","comments":true,"path":"sc/sc-eureka-cancle/","link":"","permalink":"http://xujin.org/sc/sc-eureka-cancle/","excerpt":"æ‘˜è¦:åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä¸»è¦å¯¹Eurekaçš„Cancel(æœåŠ¡ä¸‹çº¿)è¿›è¡Œæºç åˆ†æï¼Œåœ¨Service ProvideræœåŠ¡shut downçš„æ—¶å€™ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥Eureka ServeræŠŠè‡ªå·±å‰”é™¤ï¼Œä»è€Œé¿å…å…¶å®ƒå®¢æˆ·ç«¯è°ƒç”¨å·²ç»ä¸‹çº¿çš„æœåŠ¡ï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚ Cancel(æœåŠ¡ä¸‹çº¿)æ¦‚è¿°åœ¨Service ProvideræœåŠ¡shut downçš„æ—¶å€™ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥Eureka ServeræŠŠè‡ªå·±å‰”é™¤ï¼Œä»è€Œé¿å…å®¢æˆ·ç«¯è°ƒç”¨å·²ç»ä¸‹çº¿çš„æœåŠ¡ã€‚ æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ åœ¨eureka-client-1.4.1ä¸­çš„com.netflix.discovery.DiscoveryClientä¸­shutdown()çš„867è¡Œã€‚","text":"æ‘˜è¦:åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä¸»è¦å¯¹Eurekaçš„Cancel(æœåŠ¡ä¸‹çº¿)è¿›è¡Œæºç åˆ†æï¼Œåœ¨Service ProvideræœåŠ¡shut downçš„æ—¶å€™ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥Eureka ServeræŠŠè‡ªå·±å‰”é™¤ï¼Œä»è€Œé¿å…å…¶å®ƒå®¢æˆ·ç«¯è°ƒç”¨å·²ç»ä¸‹çº¿çš„æœåŠ¡ï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚ Cancel(æœåŠ¡ä¸‹çº¿)æ¦‚è¿°åœ¨Service ProvideræœåŠ¡shut downçš„æ—¶å€™ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥Eureka ServeræŠŠè‡ªå·±å‰”é™¤ï¼Œä»è€Œé¿å…å®¢æˆ·ç«¯è°ƒç”¨å·²ç»ä¸‹çº¿çš„æœåŠ¡ã€‚ æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ åœ¨eureka-client-1.4.1ä¸­çš„com.netflix.discovery.DiscoveryClientä¸­shutdown()çš„867è¡Œã€‚ 123456789101112131415161718192021222324252627282930313233/** * Shuts down Eureka Client. Also sends a deregistration request to the * eureka server. */ @PreDestroy @Override public synchronized void shutdown() &#123; if (isShutdown.compareAndSet(false, true)) &#123; logger.info(\"Shutting down DiscoveryClient ...\"); if (statusChangeListener != null &amp;&amp; applicationInfoManager != null) &#123; applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId()); &#125; cancelScheduledTasks(); // If APPINFO was registered if (applicationInfoManager != null &amp;&amp; clientConfig.shouldRegisterWithEureka()) &#123; applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN); //è°ƒç”¨ä¸‹çº¿æ¥å£ unregister(); &#125; if (eurekaTransport != null) &#123; eurekaTransport.shutdown(); &#125; heartbeatStalenessMonitor.shutdown(); registryStalenessMonitor.shutdown(); logger.info(\"Completed shut down of DiscoveryClient\"); &#125; &#125; Tips @PreDestroyæ³¨è§£æˆ–shutdown()çš„æ–¹æ³•æ˜¯æœåŠ¡ä¸‹çº¿çš„å…¥å£ åœ¨eureka-client-1.4.1ä¸­çš„com.netflix.discovery.DiscoveryClientä¸­unregisterï¼ˆï¼‰çš„897è¡Œ12345678910111213141516 /** * unregister w/ the eureka service. */ void unregister() &#123; // It can be null if shouldRegisterWithEureka == false if(eurekaTransport != null &amp;&amp; eurekaTransport.registrationClient != null) &#123; try &#123; logger.info(\"Unregistering ...\"); //å‘é€æœåŠ¡ä¸‹çº¿è¯·æ±‚ EurekaHttpResponse&lt;Void&gt; httpResponse = eurekaTransport.registrationClient.cancel(instanceInfo.getAppName(), instanceInfo.getId()); logger.info(PREFIX + appPathIdentifier + \" - deregister status: \" + httpResponse.getStatusCode()); &#125; catch (Exception e) &#123; logger.error(PREFIX + appPathIdentifier + \" - de-registration failed\" + e.getMessage(), e); &#125; &#125;&#125; Eureka ServeræœåŠ¡ä¸‹çº¿å®ç°ç»†èŠ‚ åœ¨com.netflix.eureka.resources.InstanceResourceä¸­çš„280è¡Œä¸­çš„cancelLease()æ–¹æ³• 123456789101112131415@DELETEpublic Response cancelLease( @HeaderParam(PeerEurekaNode.HEADER_REPLICATION) String isReplication) &#123; //è°ƒç”¨cancel boolean isSuccess = registry.cancel(app.getName(), id, \"true\".equals(isReplication)); if (isSuccess) &#123; logger.debug(\"Found (Cancel): \" + app.getName() + \" - \" + id); return Response.ok().build(); &#125; else &#123; logger.info(\"Not Found (Cancel): \" + app.getName() + \" - \" + id); return Response.status(Status.NOT_FOUND).build(); &#125;&#125; åœ¨org.springframework.cloud.netflix.eureka.server.InstanceRegistryä¸­çš„95è¡Œçš„cancel()æ–¹æ³•ï¼Œ 123456@Overridepublic boolean cancel(String appName, String serverId, boolean isReplication) &#123; handleCancelation(appName, serverId, isReplication); //è°ƒç”¨çˆ¶ç±»ä¸­çš„cancel return super.cancel(appName, serverId, isReplication);&#125; åœ¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImplä¸­çš„376è¡Œ 123456789101112131415161718 @Override public boolean cancel(final String appName, final String id, final boolean isReplication) &#123; if (super.cancel(appName, id, isReplication)) &#123; //æœåŠ¡ä¸‹çº¿æˆåŠŸåï¼ŒåŒæ­¥æ›´æ–°ä¿¡æ¯åˆ°å…¶å®ƒEureka ServerèŠ‚ç‚¹ replicateToPeers(Action.Cancel, appName, id, null, null, isReplication); synchronized (lock) &#123; if (this.expectedNumberOfRenewsPerMin &gt; 0) &#123; // Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute) this.expectedNumberOfRenewsPerMin = this.expectedNumberOfRenewsPerMin - 2; this.numberOfRenewsPerMinThreshold = (int) (this.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold()); &#125; &#125; return true; &#125; return false;&#125; 4.åœ¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImplä¸­çš„618è¡Œï¼Œä¸»è¦æ¥å£å®ç°æ–¹å¼å’ŒregisteråŸºæœ¬ä¸€è‡´ï¼šé¦–å…ˆæ›´æ–°è‡ªèº«Eureka Serverä¸­æœåŠ¡çš„çŠ¶æ€ï¼Œå†åŒæ­¥åˆ°å…¶å®ƒEureka Serverä¸­ã€‚12345678910111213141516171819202122232425private void replicateToPeers(Action action, String appName, String id, InstanceInfo info /* optional */, InstanceStatus newStatus /* optional */, boolean isReplication) &#123; Stopwatch tracer = action.getTimer().start(); try &#123; if (isReplication) &#123; numberOfReplicationsLastMin.increment(); &#125; // If it is a replication already, do not replicate again as this will create a poison replication if (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123; return; &#125; // åŒæ­¥æŠŠæœåŠ¡ä¿¡æ¯åŒæ­¥åˆ°å…¶å®ƒçš„Eureka Serverä¸­ for (final PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123; // If the url represents this host, do not replicate to yourself. if (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123; continue; &#125; //æ ¹æ®actionåšç›¸åº”æ“ä½œçš„åŒæ­¥ replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node); &#125; &#125; finally &#123; tracer.stop(); &#125; &#125; è‡³æ­¤ï¼ŒEurekaæœåŠ¡ç»­çº¦æºç åˆ†æç»“æŸï¼Œå¤§å®¶æœ‰å…´è¶£å¯è‡ªè¡Œé˜…è¯»ã€‚ æºç åˆ†æé“¾æ¥ å…¶å®ƒæºç åˆ†æé“¾æ¥: Spring Cloudä¸­@EnableEurekaClientæºç åˆ†æ: http://xujin.org/sc/sc-enableEurekaClient-annonation/ Spring Cloud EurekaæœåŠ¡æ³¨å†Œæºç åˆ†æï¼š http://xujin.org/sc/sc-eureka-register/ Spring Cloud EurekaæœåŠ¡ç»­çº¦(Renew)æºç åˆ†æ http://xujin.org/sc/sc-eureka-renew/","categories":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/categories/Spring-Cloud-Eureka/"}],"tags":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/tags/Spring-Cloud-Eureka/"}]},{"title":"Spring Cloud EurekaæœåŠ¡ç»­çº¦(Renew)æºç åˆ†æ","slug":"sc/sc-eureka-renew","date":"2016-11-13T06:00:00.000Z","updated":"2019-01-12T04:36:27.970Z","comments":true,"path":"sc/sc-eureka-renew/","link":"","permalink":"http://xujin.org/sc/sc-eureka-renew/","excerpt":"æ‘˜è¦:åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä¸»è¦å¯¹Eurekaçš„Renew(æœåŠ¡ç»­çº¦)ï¼Œä»æœåŠ¡æä¾›è€…å‘èµ·ç»­çº¦è¯·æ±‚å¼€å§‹åˆ†æï¼Œé€šè¿‡é˜…è¯»æºç å’Œç”»æ—¶åºå›¾çš„æ–¹å¼ï¼Œå±•ç¤ºEurekaæœåŠ¡ç»­çº¦çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚æœåŠ¡ç»­çº¦ä¸»è¦æ˜¯æŠŠæœåŠ¡ç»­çº¦çš„ä¿¡æ¯æ›´æ–°åˆ°è‡ªèº«çš„Eureka Serverä¸­ï¼Œç„¶åå†åŒæ­¥åˆ°å…¶å®ƒEureka Serverä¸­ã€‚ 1. Renew(æœåŠ¡ç»­çº¦)1.1 æ¦‚è¿°Renewï¼ˆæœåŠ¡ç»­çº¦ï¼‰æ“ä½œç”±Service Providerå®šæœŸè°ƒç”¨ï¼Œç±»ä¼¼äºheartbeatã€‚ç›®çš„æ˜¯éš”ä¸€æ®µæ—¶é—´Service Providerè°ƒç”¨æ¥å£ï¼Œå‘Šè¯‰Eureka Serverå®ƒè¿˜æ´»ç€æ²¡æŒ‚ï¼Œä¸è¦æŠŠå®ƒTäº†ã€‚é€šä¿—çš„è¯´å°±æ˜¯å®ƒä»¬ä¸¤ä¹‹é—´çš„å¿ƒè·³æ£€æµ‹ï¼Œé¿å…æœåŠ¡æä¾›è€…è¢«å‰”é™¤æ‰ã€‚è¯·å‚è€ƒ:Spring Cloud Eurekaåè¯è§£é‡Š","text":"æ‘˜è¦:åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä¸»è¦å¯¹Eurekaçš„Renew(æœåŠ¡ç»­çº¦)ï¼Œä»æœåŠ¡æä¾›è€…å‘èµ·ç»­çº¦è¯·æ±‚å¼€å§‹åˆ†æï¼Œé€šè¿‡é˜…è¯»æºç å’Œç”»æ—¶åºå›¾çš„æ–¹å¼ï¼Œå±•ç¤ºEurekaæœåŠ¡ç»­çº¦çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚æœåŠ¡ç»­çº¦ä¸»è¦æ˜¯æŠŠæœåŠ¡ç»­çº¦çš„ä¿¡æ¯æ›´æ–°åˆ°è‡ªèº«çš„Eureka Serverä¸­ï¼Œç„¶åå†åŒæ­¥åˆ°å…¶å®ƒEureka Serverä¸­ã€‚ 1. Renew(æœåŠ¡ç»­çº¦)1.1 æ¦‚è¿°Renewï¼ˆæœåŠ¡ç»­çº¦ï¼‰æ“ä½œç”±Service Providerå®šæœŸè°ƒç”¨ï¼Œç±»ä¼¼äºheartbeatã€‚ç›®çš„æ˜¯éš”ä¸€æ®µæ—¶é—´Service Providerè°ƒç”¨æ¥å£ï¼Œå‘Šè¯‰Eureka Serverå®ƒè¿˜æ´»ç€æ²¡æŒ‚ï¼Œä¸è¦æŠŠå®ƒTäº†ã€‚é€šä¿—çš„è¯´å°±æ˜¯å®ƒä»¬ä¸¤ä¹‹é—´çš„å¿ƒè·³æ£€æµ‹ï¼Œé¿å…æœåŠ¡æä¾›è€…è¢«å‰”é™¤æ‰ã€‚è¯·å‚è€ƒ:Spring Cloud Eurekaåè¯è§£é‡Š 1.2 æœåŠ¡ç»­çº¦é…ç½® Renewæ“ä½œä¼šåœ¨Service Providerå®šæ—¶å‘èµ·ï¼Œç”¨æ¥é€šçŸ¥Eureka Serverè‡ªå·±è¿˜æ´»ç€ã€‚ è¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„é…ç½®éœ€è¦å¦‚ä¸‹ï¼Œå¯ä»¥åœ¨Runä¹‹å‰é…ç½®ã€‚1eureka.instance.leaseRenewalIntervalInSeconds Renewé¢‘ç‡ã€‚é»˜è®¤æ˜¯30ç§’ï¼Œä¹Ÿå°±æ˜¯æ¯30ç§’ä¼šå‘Eureka Serverå‘èµ·Renewæ“ä½œã€‚1eureka.instance.leaseExpirationDurationInSeconds æœåŠ¡å¤±æ•ˆæ—¶é—´ã€‚é»˜è®¤æ˜¯90ç§’ï¼Œä¹Ÿå°±æ˜¯å¦‚æœEureka Serveråœ¨90ç§’å†…æ²¡æœ‰æ¥æ”¶åˆ°æ¥è‡ªService Providerçš„Renewæ“ä½œï¼Œå°±ä¼šæŠŠService Providerå‰”é™¤ã€‚ 2. Renewæºç åˆ†æ2.1 æœåŠ¡æä¾›è€…å®ç°ç»†èŠ‚ æœåŠ¡æä¾›è€…å‘å‘èµ·æœåŠ¡ç»­çº¦çš„æ—¶åºå›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º,å¤§å®¶å…ˆç›´è§‚çš„çœ‹ä¸€ä¸‹æ—¶åºå›¾ï¼Œç­‰é˜…è¯»å®Œæºç å†å›é¡¾ä¸€ä¸‹ã€‚ åœ¨com.netflix.discovery.DiscoveryClient.initScheduledTasks()ä¸­çš„1272è¡Œï¼ŒTimedSupervisorTaskä¼šå®šæ—¶å‘èµ·æœåŠ¡ç»­çº¦ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:123456789101112// Heartbeat timer scheduler.schedule( new TimedSupervisorTask( \"heartbeat\", scheduler, heartbeatExecutor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, new HeartbeatThread() ), renewalIntervalInSecs, TimeUnit.SECONDS); 2.åœ¨com.netflix.discovery.DiscoveryClientä¸­çš„1393è¡Œï¼Œæœ‰ä¸€ä¸ªHeartbeatThreadçº¿ç¨‹å‘èµ·ç»­çº¦æ“ä½œ123456789 private class HeartbeatThread implements Runnable &#123; public void run() &#123; //è°ƒç”¨eureka-clientä¸­çš„renew if (renew()) &#123; lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis(); &#125; &#125;&#125; renew()è°ƒç”¨eureka-client-1.4.11.jarcom.netflix.discovery.DiscoveryClientä¸­829è¡Œrenew()å‘èµ·PUT Resetè¯·æ±‚ï¼Œè°ƒç”¨com.netflix.eureka.resources.InstanceResourceä¸­çš„renewLease()ç»­çº¦ã€‚12345678910111213141516171819/** * Renew with the eureka service by making the appropriate REST call */ boolean renew() &#123; EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse; try &#123; httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, null); logger.debug(\"&#123;&#125; - Heartbeat status: &#123;&#125;\", PREFIX + appPathIdentifier, httpResponse.getStatusCode()); if (httpResponse.getStatusCode() == 404) &#123; REREGISTER_COUNTER.increment(); logger.info(\"&#123;&#125; - Re-registering apps/&#123;&#125;\", PREFIX + appPathIdentifier, instanceInfo.getAppName()); return register(); &#125; return httpResponse.getStatusCode() == 200; &#125; catch (Throwable e) &#123; logger.error(\"&#123;&#125; - was unable to send heartbeat!\", PREFIX + appPathIdentifier, e); return false; &#125; &#125; 2.2 Netflixä¸­çš„Eureka Coreå®ç°ç»†èŠ‚ NetFlixä¸­Eureka Coreä¸­çš„æœåŠ¡ç»­çº¦æ—¶åºå›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æ‰“å¼€com.netflix.eureka.resources.InstanceResourceä¸­çš„106è¡Œçš„renewLease()æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹: 123456789101112private final PeerAwareInstanceRegistry registry@PUTpublic Response renewLease( @HeaderParam(PeerEurekaNode.HEADER_REPLICATION) String isReplication, @QueryParam(\"overriddenstatus\") String overriddenStatus, @QueryParam(\"status\") String status, @QueryParam(\"lastDirtyTimestamp\") String lastDirtyTimestamp) &#123; boolean isFromReplicaNode = \"true\".equals(isReplication); //è°ƒç”¨ boolean isSuccess = registry.renew(app.getName(), id, isFromReplicaNode); //å…¶ä½™çœç•¥&#125; ç‚¹å¼€registry.renew(app.getName(), id, isFromReplicaNode);æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨äº†org.springframework.cloud.netflix.eureka.server.InstanceRegistryä¸­çš„renewï¼ˆï¼‰æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹: 1234567891011121314151617181920212223 @Override public boolean renew(final String appName, final String serverId, boolean isReplication) &#123; log(\"renew \" + appName + \" serverId \" + serverId + \", isReplication &#123;&#125;\" + isReplication); List&lt;Application&gt; applications = getSortedApplications(); for (Application input : applications) &#123; if (input.getName().equals(appName)) &#123; InstanceInfo instance = null; for (InstanceInfo info : input.getInstances()) &#123; if (info.getHostName().equals(serverId)) &#123; instance = info; break; &#125; &#125; publishEvent(new EurekaInstanceRenewedEvent(this, appName, serverId, instance, isReplication)); break; &#125; &#125; //è°ƒç”¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImplä¸­çš„renewæ–¹æ³• return super.renew(appName, serverId, isReplication);&#125; 3.ä»super.renew()çœ‹åˆ°è°ƒç”¨äº†çˆ¶ç±»ä¸­çš„com.netflix.eureka.registry.PeerAwareInstanceRegistryImplä¸­420è¡Œçš„renew()æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹:123456789 public boolean renew(final String appName, final String id, final boolean isReplication) &#123; //æœåŠ¡ç»­çº¦æˆåŠŸï¼Œ if (super.renew(appName, id, isReplication)) &#123; //ç„¶åreplicateToPeersåŒæ­¥å…¶å®ƒEureka Serverä¸­çš„æ•°æ® replicateToPeers(Action.Heartbeat, appName, id, null, null, isReplication); return true; &#125; return false;&#125; 3.1 ä»ä¸Šé¢ä»£ç ä¸­super.renew(appName, id, isReplication)å¯ä»¥çœ‹å‡ºè°ƒç”¨çš„æ˜¯com.netflix.eureka.registry.AbstractInstanceRegistryä¸­345è¡Œçš„renew()æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º12345678910111213141516171819202122232425262728293031323334353637383940public boolean renew(String appName, String id, boolean isReplication) &#123; RENEW.increment(isReplication); Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName); Lease&lt;InstanceInfo&gt; leaseToRenew = null; if (gMap != null) &#123; leaseToRenew = gMap.get(id); &#125; if (leaseToRenew == null) &#123; RENEW_NOT_FOUND.increment(isReplication); logger.warn(\"DS: Registry: lease doesn't exist, registering resource: &#123;&#125; - &#123;&#125;\", appName, id); return false; &#125; else &#123; InstanceInfo instanceInfo = leaseToRenew.getHolder(); if (instanceInfo != null) &#123; // touchASGCache(instanceInfo.getASGName()); InstanceStatus overriddenInstanceStatus = this.getOverriddenInstanceStatus( instanceInfo, leaseToRenew, isReplication); if (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123; logger.info(\"Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;\" + \"; re-register required\", instanceInfo.getId()); RENEW_NOT_FOUND.increment(isReplication); return false; &#125; if (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123; Object[] args = &#123; instanceInfo.getStatus().name(), instanceInfo.getOverriddenStatus().name(), instanceInfo.getId() &#125;; logger.info( \"The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. \" + \"Hence setting the status to overridden status\", args); instanceInfo.setStatus(overriddenInstanceStatus); &#125; &#125; renewsLastMin.increment(); leaseToRenew.renew(); return true; &#125; &#125; å…¶ä¸­ leaseToRenew.renew()æ˜¯è°ƒç”¨com.netflix.eureka.lease.Leaseä¸­çš„62è¡Œçš„renew()æ–¹æ³•123456789/** * Renew the lease, use renewal duration if it was specified by the * associated &#123;@link T&#125; during registration, otherwise default duration is * &#123;@link #DEFAULT_DURATION_IN_SECS&#125;. */public void renew() &#123; lastUpdateTimestamp = System.currentTimeMillis() + duration;&#125; 3.2 replicateToPeers(Action.Heartbeat, appName, id, null, null, isReplication);è°ƒç”¨è‡ªèº«çš„replicateToPeers()æ–¹æ³•ï¼Œåœ¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImplä¸­çš„618è¡Œï¼Œä¸»è¦æ¥å£å®ç°æ–¹å¼å’ŒregisteråŸºæœ¬ä¸€è‡´ï¼šé¦–å…ˆæ›´æ–°è‡ªèº«Eureka Serverä¸­æœåŠ¡çš„çŠ¶æ€ï¼Œå†åŒæ­¥åˆ°å…¶å®ƒEureka Serverä¸­ã€‚12345678910111213141516171819202122232425private void replicateToPeers(Action action, String appName, String id, InstanceInfo info /* optional */, InstanceStatus newStatus /* optional */, boolean isReplication) &#123; Stopwatch tracer = action.getTimer().start(); try &#123; if (isReplication) &#123; numberOfReplicationsLastMin.increment(); &#125; // If it is a replication already, do not replicate again as this will create a poison replication if (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123; return; &#125; // åŒæ­¥æŠŠç»­çº¦ä¿¡æ¯åŒæ­¥åˆ°å…¶å®ƒçš„Eureka Serverä¸­ for (final PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123; // If the url represents this host, do not replicate to yourself. if (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123; continue; &#125; //æ ¹æ®actionåšç›¸åº”æ“ä½œçš„åŒæ­¥ replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node); &#125; &#125; finally &#123; tracer.stop(); &#125; &#125; è‡³æ­¤ï¼ŒEurekaæœåŠ¡ç»­çº¦æºç åˆ†æç»“æŸï¼Œå¤§å®¶æœ‰å…´è¶£å¯è‡ªè¡Œé˜…è¯»ã€‚ 2.3 æºç åˆ†æé“¾æ¥ å…¶å®ƒæºç åˆ†æé“¾æ¥: Spring Cloudä¸­@EnableEurekaClientæºç åˆ†æ: http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/ Spring Cloud EurekaæœåŠ¡æ³¨å†Œæºç åˆ†æï¼š http://blog.xujin.org/sc/sc-eureka-register/","categories":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/categories/Spring-Cloud-Eureka/"}],"tags":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/tags/Spring-Cloud-Eureka/"},{"name":"Spring Cloud æºç åˆ†æ","slug":"Spring-Cloud-æºç åˆ†æ","permalink":"http://xujin.org/tags/Spring-Cloud-æºç åˆ†æ/"}]},{"title":"Spring Cloudä¸­@EnableEurekaClientæºç åˆ†æ","slug":"sc/sc-enableEurekaClient-annonation","date":"2016-11-06T06:00:00.000Z","updated":"2019-01-12T04:01:26.567Z","comments":true,"path":"sc/sc-enableEurekaClient-annonation/","link":"","permalink":"http://xujin.org/sc/sc-enableEurekaClient-annonation/","excerpt":"æ‘˜è¦:åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»ä¸€ä¸‹Spring Cloudä¸­çš„@EnableEurekaClientæ³¨è§£ï¼Œä»æºç çš„è§’åº¦åˆ†ææ˜¯å¦‚ä½•workçš„ï¼Œè®©å¤§å®¶èƒ½äº†è§£Spring Cloudå¦‚ä½•é€šè¿‡@EnableEurekaClientæ³¨è§£å¯¹NetFlix Eureka Clientè¿›è¡Œå°è£…ä¸ºå®ƒæ‰€ç”¨ã€‚ NetFlix Eureka clientç®€ä»‹NetFlix Eureka clientEureka client è´Ÿè´£ä¸Eureka Server é…åˆå‘å¤–æä¾›æ³¨å†Œä¸å‘ç°æœåŠ¡æ¥å£ã€‚é¦–å…ˆçœ‹ä¸‹eureka clientæ˜¯æ€ä¹ˆå®šä¹‰ï¼ŒNetflixçš„ eureka clientçš„è¡Œä¸ºåœ¨LookupServiceä¸­å®šä¹‰ï¼ŒLookup service for finding active instancesï¼Œå®šä¹‰äº†ï¼Œä»outlineä¸­èƒ½çœ‹åˆ°èµ·â€œè§„å®šâ€äº†å¦‚ä¸‹å‡ ä¸ªæœ€åŸºæœ¬çš„æ–¹æ³•ã€‚æœåŠ¡å‘ç°å¿…é¡»å®ç°çš„åŸºæœ¬ç±»ï¼šcom.netflix.discovery.shared.LookupServiceï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç ã€‚ Eureka clientä¸Spring Cloudç±»å…³ç³» Eureka clientä¸Spring Cloud Eureka Clientç±»å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤º:åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘åŠ äº†å‰ç¼€ï¼Œå¸¦æœ‰Sçš„æ˜¯Spring Cloudå°è£…çš„ï¼Œå¸¦æœ‰Næ˜¯NetFlixåŸç”Ÿçš„ã€‚","text":"æ‘˜è¦:åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»ä¸€ä¸‹Spring Cloudä¸­çš„@EnableEurekaClientæ³¨è§£ï¼Œä»æºç çš„è§’åº¦åˆ†ææ˜¯å¦‚ä½•workçš„ï¼Œè®©å¤§å®¶èƒ½äº†è§£Spring Cloudå¦‚ä½•é€šè¿‡@EnableEurekaClientæ³¨è§£å¯¹NetFlix Eureka Clientè¿›è¡Œå°è£…ä¸ºå®ƒæ‰€ç”¨ã€‚ NetFlix Eureka clientç®€ä»‹NetFlix Eureka clientEureka client è´Ÿè´£ä¸Eureka Server é…åˆå‘å¤–æä¾›æ³¨å†Œä¸å‘ç°æœåŠ¡æ¥å£ã€‚é¦–å…ˆçœ‹ä¸‹eureka clientæ˜¯æ€ä¹ˆå®šä¹‰ï¼ŒNetflixçš„ eureka clientçš„è¡Œä¸ºåœ¨LookupServiceä¸­å®šä¹‰ï¼ŒLookup service for finding active instancesï¼Œå®šä¹‰äº†ï¼Œä»outlineä¸­èƒ½çœ‹åˆ°èµ·â€œè§„å®šâ€äº†å¦‚ä¸‹å‡ ä¸ªæœ€åŸºæœ¬çš„æ–¹æ³•ã€‚æœåŠ¡å‘ç°å¿…é¡»å®ç°çš„åŸºæœ¬ç±»ï¼šcom.netflix.discovery.shared.LookupServiceï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç ã€‚ Eureka clientä¸Spring Cloudç±»å…³ç³» Eureka clientä¸Spring Cloud Eureka Clientç±»å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤º:åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘åŠ äº†å‰ç¼€ï¼Œå¸¦æœ‰Sçš„æ˜¯Spring Cloudå°è£…çš„ï¼Œå¸¦æœ‰Næ˜¯NetFlixåŸç”Ÿçš„ã€‚ org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientä¸­49è¡Œçš„eurekaClientå°±æ˜¯com.netflix.discovery.EurekaClientï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:12345678@RequiredArgsConstructorpublic class EurekaDiscoveryClient implements DiscoveryClient &#123; public static final String DESCRIPTION = \"Spring Cloud Eureka Discovery Client\"; private final EurekaInstanceConfig config; // Netflixä¸­çš„Eureka Client private final EurekaClient eurekaClient; //å…¶ä½™çœç•¥&#125; Tips:org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientå®ç°äº†DiscoveryClientï¼Œå¹¶ä¾èµ–äºcom.netflix.discovery.EurekaClient ç‚¹å¼€com.netflix.discovery.EurekaClientæŸ¥çœ‹ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºEurekaClientç»§æ‰¿äº†LookupServiceå¹¶å®ç°äº†EurekaClientæ¥å£ã€‚ 1234@ImplementedBy(DiscoveryClient.class)public interface EurekaClient extends LookupService &#123; //å…¶ä½™çœç•¥&#125; com.netflix.discovery.DiscoveryClientæ˜¯netflixä½¿ç”¨çš„å®¢æˆ·ç«¯ï¼Œä»å…¶classçš„æ³¨é‡Šå¯ä»¥çœ‹åˆ°ä»–ä¸»è¦åšè¿™å‡ ä»¶äº‹æƒ…ï¼ša) Registering the instance with Eureka Serverb) Renewalof the lease with Eureka Serverc) Cancellation of the lease from Eureka Server during shutdown å…¶ä¸­com.netflix.discovery.DiscoveryClientå®ç°äº†com.netflix.discovery.EurekaClient,è€Œspring Cloudä¸­çš„org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientï¼Œä¾èµ–äºcom.netflix.discovery.EurekaClientï¼Œå› æ­¤Spring Cloudä¸NetFlixçš„å…³ç³»ç”±æ­¤è”ç³»åˆ°ä¸€èµ·ã€‚12345678@Singletonpublic class DiscoveryClient implements EurekaClient &#123; private static final Logger logger = LoggerFactory.getLogger(DiscoveryClient.class); // Constants public static final String HTTP_X_DISCOVERY_ALLOW_REDIRECT = \"X-Discovery-AllowRedirect\"; //å…¶ä½™çœç•¥&#125; @EnableEurekaClientæ³¨è§£å…¥å£åˆ†æ åœ¨ä¸Šé¢å°èŠ‚ä¸­ï¼Œç†æ¸…äº†NetFlix Eurekaä¸Spring cloudä¸­ç±»çš„ä¾èµ–å…³ç³»ï¼Œä¸‹é¢å°†ä»¥@EnableEurekaClientä¸ºå…¥å£ï¼Œåˆ†æä¸»è¦è°ƒç”¨é“¾ä¸­çš„ç±»å’Œæ–¹æ³•ã€‚ @EnableEurekaClientä½¿ç”¨ ç”¨è¿‡spring cloudçš„åŒå­¦éƒ½çŸ¥é“ï¼Œä½¿ç”¨@EnableEurekaClientå°±èƒ½ç®€å•çš„å¼€å¯Eureka Clientä¸­çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚123456789@EnableEurekaClient@SpringBootApplicationpublic class CloudEurekaClientApplication &#123; public static void main(String[] args) &#123; new SpringApplicationBuilder(CloudEurekaClientApplication.class).web(true).run(args); &#125;&#125; é€šè¿‡@EnableEurekaClientè¿™ä¸ªç®€å•çš„æ³¨è§£ï¼Œåœ¨spring cloudåº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥æŠŠEurekaDiscoveryClientæ³¨å…¥ï¼Œç»§è€Œä½¿ç”¨NetFlixæä¾›çš„Eureka clientã€‚ æ‰“å¼€EnableEurekaClientè¿™ä¸ªç±»ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªè‡ªå®šä¹‰çš„annotation @EnableEurekaClienté‡Œé¢æ²¡æœ‰å†…å®¹ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å¼€å¯Eureka discoveryçš„é…ç½®ï¼Œæ­£æ˜¯é€šè¿‡è¿™ä¸ªæ ‡è®°ï¼Œautoconfigurationå°±å¯ä»¥åŠ è½½ç›¸å…³çš„Eurekaç±»ã€‚é‚£æˆ‘ä»¬çœ‹ä¸‹å®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„ã€‚ 12345678@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@EnableDiscoveryClientpublic @interface EnableEurekaClient &#123;&#125; åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼ŒEnableEurekaClientä¸Šé¢åŠ å…¥äº†å¦å¤–ä¸€ä¸ªæ³¨è§£@EnableDiscoveryClientï¼Œçœ‹çœ‹è¿™ä¸ªæ³¨è§£çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º: 123456789101112/** * Annotation to enable a DiscoveryClient implementation. * @author Spencer Gibb */@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@Import(EnableDiscoveryClientImportSelector.class)public @interface EnableDiscoveryClient &#123;&#125; è¿™ä¸ªæ³¨è§£importäº†EnableDiscoveryClientImportSelector.classè¿™æ ·ä¸€ä¸ªç±»ï¼Œå…¶å®å°±æ˜¯é€šè¿‡è¿™ä¸ªç±»æ¥åŠ è½½éœ€è¦ç”¨åˆ°çš„beanã€‚ç‚¹å¼€EnableDiscoveryClientImportSelectorç±»ï¼Œå¦‚ä¸‹ä»£ç : 12345678910111213141516@Order(Ordered.LOWEST_PRECEDENCE - 100)public class EnableDiscoveryClientImportSelector extends SpringFactoryImportSelector&lt;EnableDiscoveryClient&gt; &#123; @Override protected boolean isEnabled() &#123; return new RelaxedPropertyResolver(getEnvironment()).getProperty( \"spring.cloud.discovery.enabled\", Boolean.class, Boolean.TRUE); &#125; @Override protected boolean hasDefaultFactory() &#123; return true; &#125;&#125; çœ‹åˆ°è¿™é‡Œæœ‰è¦†ç›–äº†çˆ¶ç±»SpringFactoryImportSelectorçš„ä¸€ä¸ªæ–¹æ³•isEnabledï¼Œæ³¨æ„ï¼Œé»˜è®¤æ˜¯TRUEï¼Œä¹Ÿå°±æ˜¯åªè¦importäº†è¿™ä¸ªé…ç½®ï¼Œå°±ä¼šenableã€‚ åœ¨å…¶çˆ¶ç±»org.springframework.cloud.commons.util.SpringFactoryImportSelectorçš„String[] selectImports(AnnotationMetadata metadata)æ–¹æ³•ä¸­æ­£æ˜¯æ ¹æ®è¿™ä¸ªæ ‡è®°ç±»åˆ¤å®šæ˜¯å¦åŠ è½½å¦‚ä¸‹å®šä¹‰çš„ç±»ã€‚åœ¨æºç ç¬¬59è¡Œï¼Œå±€éƒ¨ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚1234567891011121314151617181920212223242526272829@Override public String[] selectImports(AnnotationMetadata metadata) &#123; if (!isEnabled()) &#123; return new String[0]; &#125; AnnotationAttributes attributes = AnnotationAttributes.fromMap( metadata.getAnnotationAttributes(this.annotationClass.getName(), true)); Assert.notNull(attributes, \"No \" + getSimpleName() + \" attributes found. Is \" + metadata.getClassName() + \" annotated with @\" + getSimpleName() + \"?\"); // Find all possible auto configuration classes, filtering duplicates List&lt;String&gt; factories = new ArrayList&lt;&gt;(new LinkedHashSet&lt;&gt;(SpringFactoriesLoader .loadFactoryNames(this.annotationClass, this.beanClassLoader))); if (factories.isEmpty() &amp;&amp; !hasDefaultFactory()) &#123; throw new IllegalStateException(\"Annotation @\" + getSimpleName() + \" found, but there are no implementations. Did you forget to include a starter?\"); &#125; if (factories.size() &gt; 1) &#123; // there should only ever be one DiscoveryClient, but there might be more than // one factory log.warn(\"More than one implementation \" + \"of @\" + getSimpleName() + \" (now relying on @Conditionals to pick one): \" + factories); &#125; return factories.toArray(new String[factories.size()]); &#125; åœ¨æºç ä¸­70-71è¡Œï¼Œå³åœ¨org.springframework.core.io.support.SpringFactoriesLoader ä¸­çš„109è¡Œçš„loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader)æ–¹æ³•12345678910111213141516171819 public static List&lt;String&gt; loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader) &#123; String factoryClassName = factoryClass.getName(); try &#123; Enumeration&lt;URL&gt; urls = (classLoader != null ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) : ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION)); List&lt;String&gt; result = new ArrayList&lt;String&gt;(); while (urls.hasMoreElements()) &#123; URL url = urls.nextElement(); Properties properties = PropertiesLoaderUtils.loadProperties(new UrlResource(url)); String factoryClassNames = properties.getProperty(factoryClassName); result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames))); &#125; return result; &#125; catch (IOException ex) &#123; throw new IllegalArgumentException(\"Unable to load [\" + factoryClass.getName() + \"] factories from location [\" + FACTORIES_RESOURCE_LOCATION + \"]\", ex); &#125;&#125; å®é™…è°ƒç”¨loadFactoryNameså…¶å®åŠ è½½META-INF/spring.factoriesä¸‹çš„classã€‚12345 /*** The location to look for factories.* &lt;p&gt;Can be present in multiple JAR files. */ public static final String FACTORIES_RESOURCE_LOCATION = \"META-INF/spring.factories\"; è€Œåœ¨spring-cloud-netflix-eureka-client\\src\\main\\resources\\META-INF\\spring.factoriesä¸­é…ç½®ï¼Œç”¨äºåŠ è½½ä¸€ç³»åˆ—é…ç½®ä¿¡æ¯å’ŒDependences Beanå¯ä»¥çœ‹åˆ°EnableAutoConfigurationçš„åŒ…å«äº†EurekaClientConfigServerAutoConfigurationã€‚1234567891011org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration,\\org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceAutoConfiguration,\\org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration,\\org.springframework.cloud.netflix.ribbon.eureka.RibbonEurekaAutoConfigurationorg.springframework.cloud.bootstrap.BootstrapConfiguration=\\org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfigurationorg.springframework.cloud.client.discovery.EnableDiscoveryClient=\\org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration æ‰“å¼€org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfigurationå¯ä»¥çœ‹åˆ°EurekaClientAutoConfigurationå…·ä½“çš„æ³¨å…¥ä¿¡æ¯ã€‚ å…·ä½“@EnableEurekaClienæ³¨è§£å¼€å¯ä¹‹åï¼ŒæœåŠ¡å¯åŠ¨åï¼Œæ˜¯æœåŠ¡æ€ä¹ˆæ³¨å†Œçš„è¯·å‚è€ƒï¼Œä¸‹é¢é“¾æ¥ï¼šhttp://blog.xujin.org/sc/sc-eureka-register/ å…¶å®ƒæºç åˆ†æé“¾æ¥ Spring Cloudä¸­@EnableEurekaClientæºç åˆ†æ: http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/ Spring Cloud EurekaæœåŠ¡æ³¨å†Œæºç åˆ†æï¼š http://blog.xujin.org/sc/sc-eureka-register/ Spring Cloud EurekaæœåŠ¡ç»­çº¦(Renew)æºç åˆ†æ http://blog.xujin.org/sc/sc-eureka-renew/ Spring Cloud EurekaæœåŠ¡ä¸‹çº¿(Cancel)æºç åˆ†æ http://blog.xujin.org/sc/sc-eureka-cancle/","categories":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/categories/Spring-Cloud-Eureka/"}],"tags":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/tags/Spring-Cloud-Eureka/"},{"name":"Spring Cloud æºç åˆ†æ","slug":"Spring-Cloud-æºç åˆ†æ","permalink":"http://xujin.org/tags/Spring-Cloud-æºç åˆ†æ/"}]},{"title":"Spring Cloud EurekaæœåŠ¡æ³¨å†Œæºç åˆ†æ","slug":"sc/sc-eureka-register","date":"2016-11-01T06:00:00.000Z","updated":"2019-01-12T04:30:38.822Z","comments":true,"path":"sc/sc-eureka-register/","link":"","permalink":"http://xujin.org/sc/sc-eureka-register/","excerpt":"æ‘˜è¦:åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œä»‹ç»äº†Eurekaçš„ç›¸å…³çš„çŸ¥è¯†ï¼Œè§£é‡Šäº†Eurekaä¸ºä»€ä¹ˆé€‚åˆåšæœåŠ¡å‘ç°å’Œæ³¨å†Œã€‚æ¥ä¸‹æ¥ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å°†é€šè¿‡æºç åˆ†æçš„æ–¹å¼ï¼Œçœ‹ä¸€ä¸‹Eurekaæ˜¯æ€ä¹ˆworkçš„ã€‚æœ¬ç« ä¸»è¦ä»‹ç»Eurekaçš„æœåŠ¡æ³¨å†Œã€‚é‚£eureka clientå¦‚ä½•å°†æœ¬åœ°æœåŠ¡çš„æ³¨å†Œä¿¡æ¯å‘é€åˆ°è¿œç«¯çš„æ³¨å†ŒæœåŠ¡å™¨eureka serverä¸Šã€‚é€šè¿‡ä¸‹é¢çš„æºç åˆ†æï¼Œçœ‹å‡ºEureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„RESTæ¥å£ï¼Œè€ŒEurekaæ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚åä¼šå¤„ç†æœåŠ¡çš„æ³¨å†Œä»¥åŠEureka Serverä¸­çš„æ•°æ®åŒæ­¥çš„é—®é¢˜ã€‚ æœåŠ¡æ³¨å†Œ æœåŠ¡æ³¨å†Œï¼Œæƒ³å¿…å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œå°±æ˜¯æœåŠ¡æä¾›è€…å¯åŠ¨çš„æ—¶å€™ï¼ŒæŠŠè‡ªå·±æä¾›çš„æœåŠ¡ä¿¡æ¯ï¼Œä¾‹å¦‚ æœåŠ¡åï¼ŒIPï¼Œç«¯å£å·ï¼Œç‰ˆæœ¬å·ç­‰ä¿¡æ¯æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œæ¯”å¦‚æ³¨å†Œåˆ°ZKä¸­ã€‚é‚£eureka clientå¦‚ä½•å°†æœ¬åœ°æœåŠ¡çš„æ³¨å†Œä¿¡æ¯å‘é€åˆ°è¿œç«¯çš„æ³¨å†ŒæœåŠ¡å™¨eureka serverä¸Šã€‚é€šè¿‡ä¸‹é¢çš„æºç åˆ†æï¼Œçœ‹å‡ºæœåŠ¡æ³¨å†Œå¯ä»¥è®¤ä¸ºæ˜¯Eureka clientè‡ªå·±å®Œæˆï¼Œä¸éœ€è¦æœåŠ¡æœ¬èº«æ¥å…³å¿ƒã€‚ Eureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„æä¾›æ¥å£å®ç°æ€è·¯å…¶å®ä¹ŸæŒºç®€å•ï¼Œåœ¨com.netflix.discovery.DiscoveryClientå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶çš„æŠŠæœ¬åœ°çš„æœåŠ¡é…ç½®ä¿¡æ¯ï¼Œå³éœ€è¦æ³¨å†Œåˆ°è¿œç«¯çš„æœåŠ¡ä¿¡æ¯è‡ªåŠ¨åˆ·æ–°åˆ°æ³¨å†ŒæœåŠ¡å™¨ä¸Šã€‚é¦–å…ˆçœ‹ä¸€ä¸‹Eurekaçš„ä»£ç ï¼Œåœ¨spring-cloud-netflix-eureka-serverå·¥ç¨‹ä¸­å¯ä»¥æ‰¾åˆ°è¿™ä¸ªä¾èµ–eureka-client-1.4.11.jaræŸ¥çœ‹ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œcom.netflix.discovery.DiscoveryClient.javaä¸­çš„1240è¡Œå¯ä»¥çœ‹åˆ°Initializes all scheduled tasksï¼Œåœ¨1277è¡Œï¼Œå¯ä»¥çœ‹åˆ°InstanceInfoReplicatorå®šæ—¶ä»»åŠ¡ã€‚","text":"æ‘˜è¦:åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œä»‹ç»äº†Eurekaçš„ç›¸å…³çš„çŸ¥è¯†ï¼Œè§£é‡Šäº†Eurekaä¸ºä»€ä¹ˆé€‚åˆåšæœåŠ¡å‘ç°å’Œæ³¨å†Œã€‚æ¥ä¸‹æ¥ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å°†é€šè¿‡æºç åˆ†æçš„æ–¹å¼ï¼Œçœ‹ä¸€ä¸‹Eurekaæ˜¯æ€ä¹ˆworkçš„ã€‚æœ¬ç« ä¸»è¦ä»‹ç»Eurekaçš„æœåŠ¡æ³¨å†Œã€‚é‚£eureka clientå¦‚ä½•å°†æœ¬åœ°æœåŠ¡çš„æ³¨å†Œä¿¡æ¯å‘é€åˆ°è¿œç«¯çš„æ³¨å†ŒæœåŠ¡å™¨eureka serverä¸Šã€‚é€šè¿‡ä¸‹é¢çš„æºç åˆ†æï¼Œçœ‹å‡ºEureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„RESTæ¥å£ï¼Œè€ŒEurekaæ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚åä¼šå¤„ç†æœåŠ¡çš„æ³¨å†Œä»¥åŠEureka Serverä¸­çš„æ•°æ®åŒæ­¥çš„é—®é¢˜ã€‚ æœåŠ¡æ³¨å†Œ æœåŠ¡æ³¨å†Œï¼Œæƒ³å¿…å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œå°±æ˜¯æœåŠ¡æä¾›è€…å¯åŠ¨çš„æ—¶å€™ï¼ŒæŠŠè‡ªå·±æä¾›çš„æœåŠ¡ä¿¡æ¯ï¼Œä¾‹å¦‚ æœåŠ¡åï¼ŒIPï¼Œç«¯å£å·ï¼Œç‰ˆæœ¬å·ç­‰ä¿¡æ¯æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œæ¯”å¦‚æ³¨å†Œåˆ°ZKä¸­ã€‚é‚£eureka clientå¦‚ä½•å°†æœ¬åœ°æœåŠ¡çš„æ³¨å†Œä¿¡æ¯å‘é€åˆ°è¿œç«¯çš„æ³¨å†ŒæœåŠ¡å™¨eureka serverä¸Šã€‚é€šè¿‡ä¸‹é¢çš„æºç åˆ†æï¼Œçœ‹å‡ºæœåŠ¡æ³¨å†Œå¯ä»¥è®¤ä¸ºæ˜¯Eureka clientè‡ªå·±å®Œæˆï¼Œä¸éœ€è¦æœåŠ¡æœ¬èº«æ¥å…³å¿ƒã€‚ Eureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„æä¾›æ¥å£å®ç°æ€è·¯å…¶å®ä¹ŸæŒºç®€å•ï¼Œåœ¨com.netflix.discovery.DiscoveryClientå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶çš„æŠŠæœ¬åœ°çš„æœåŠ¡é…ç½®ä¿¡æ¯ï¼Œå³éœ€è¦æ³¨å†Œåˆ°è¿œç«¯çš„æœåŠ¡ä¿¡æ¯è‡ªåŠ¨åˆ·æ–°åˆ°æ³¨å†ŒæœåŠ¡å™¨ä¸Šã€‚é¦–å…ˆçœ‹ä¸€ä¸‹Eurekaçš„ä»£ç ï¼Œåœ¨spring-cloud-netflix-eureka-serverå·¥ç¨‹ä¸­å¯ä»¥æ‰¾åˆ°è¿™ä¸ªä¾èµ–eureka-client-1.4.11.jaræŸ¥çœ‹ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œcom.netflix.discovery.DiscoveryClient.javaä¸­çš„1240è¡Œå¯ä»¥çœ‹åˆ°Initializes all scheduled tasksï¼Œåœ¨1277è¡Œï¼Œå¯ä»¥çœ‹åˆ°InstanceInfoReplicatorå®šæ—¶ä»»åŠ¡ã€‚ åœ¨DiscoveryClientä¸­åˆå§‹åŒ–ä¸€ä¸ªInstanceInfoReplicatorï¼Œå…¶å®é‡Œé¢å°è£…äº†ä»¥å®šæ—¶ä»»åŠ¡ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475/** * Initializes all scheduled tasks. */ private void initScheduledTasks() &#123; if (clientConfig.shouldFetchRegistry()) &#123; // registry cache refresh timer int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds(); int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound(); scheduler.schedule( new TimedSupervisorTask( \"cacheRefresh\", scheduler, cacheRefreshExecutor, registryFetchIntervalSeconds, TimeUnit.SECONDS, expBackOffBound, new CacheRefreshThread() ), registryFetchIntervalSeconds, TimeUnit.SECONDS); &#125; if (clientConfig.shouldRegisterWithEureka()) &#123; int renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs(); int expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound(); logger.info(\"Starting heartbeat executor: \" + \"renew interval is: \" + renewalIntervalInSecs); // Heartbeat timer scheduler.schedule( new TimedSupervisorTask( \"heartbeat\", scheduler, heartbeatExecutor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, new HeartbeatThread() ), renewalIntervalInSecs, TimeUnit.SECONDS); // InstanceInfo replicator /**************************å°è£…äº†å®šæ—¶ä»»åŠ¡**********************************/ instanceInfoReplicator = new InstanceInfoReplicator( this, instanceInfo, clientConfig.getInstanceInfoReplicationIntervalSeconds(), 2); // burstSize statusChangeListener = new ApplicationInfoManager.StatusChangeListener() &#123; @Override public String getId() &#123; return \"statusChangeListener\"; &#125; @Override public void notify(StatusChangeEvent statusChangeEvent) &#123; if (InstanceStatus.DOWN == statusChangeEvent.getStatus() || InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123; // log at warn level if DOWN was involved logger.warn(\"Saw local status change event &#123;&#125;\", statusChangeEvent); &#125; else &#123; logger.info(\"Saw local status change event &#123;&#125;\", statusChangeEvent); &#125; instanceInfoReplicator.onDemandUpdate(); &#125; &#125;; if (clientConfig.shouldOnDemandUpdateStatusChange()) &#123; applicationInfoManager.registerStatusChangeListener(statusChangeListener); &#125; //ç‚¹å‡»å¯ä»¥æŸ¥çœ‹startæ–¹æ³• instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds()); &#125; else &#123; logger.info(\"Not registering with Eureka server per configuration\"); &#125; &#125; 2.ä»¥initialDelayMsä¸ºé—´éš”è°ƒç”¨ã€‚1234567public void start(int initialDelayMs) &#123; if (started.compareAndSet(false, true)) &#123; instanceInfo.setIsDirty(); // for initial register Future next = scheduler.schedule(this, initialDelayMs, TimeUnit.SECONDS); scheduledPeriodicRef.set(next); &#125;&#125; 3.ScheduledExecutorServiceçš„taskçš„å…·ä½“ä¸šåŠ¡å®šä¹‰åœ¨com.netflix.discovery.InstanceInfoReplicator.run()ä¸­ï¼Œä¹Ÿå°±æ˜¯InstanceInfoReplicatorä¸­çš„98-113è¡Œï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†äº†clientçš„registeræ–¹æ³•ã€‚1234567891011121314151617 public void run() &#123; try &#123; discoveryClient.refreshInstanceInfo(); Long dirtyTimestamp = instanceInfo.isDirtyWithTime(); if (dirtyTimestamp != null) &#123; //å®¢æˆ·ç«¯å‘é€hhtpæ³¨å†Œè¯·æ±‚çš„çœŸæ­£å…¥å£ discoveryClient.register(); instanceInfo.unsetIsDirty(dirtyTimestamp); &#125; &#125; catch (Throwable t) &#123; logger.warn(\"There was a problem with the instance info replicator\", t); &#125; finally &#123; Future next = scheduler.schedule(this, replicationIntervalSeconds, TimeUnit.SECONDS); scheduledPeriodicRef.set(next); &#125;&#125; 4.com.netflix.discovery.DiscoveryClientä¸­çš„ register()æ–¹æ³•ï¼Œå¤§æ¦‚åœ¨811è¡Œã€‚123456789101112131415161718/** * Register with the eureka service by making the appropriate REST call. */boolean register() throws Throwable &#123; logger.info(PREFIX + appPathIdentifier + \": registering service...\"); EurekaHttpResponse&lt;Void&gt; httpResponse; try &#123; //Eureka Clientå®¢æˆ·ç«¯ï¼Œè°ƒç”¨EurekaæœåŠ¡ç«¯çš„å…¥å£ httpResponse = eurekaTransport.registrationClient.register(instanceInfo); &#125; catch (Exception e) &#123; logger.warn(\"&#123;&#125; - registration failed &#123;&#125;\", PREFIX + appPathIdentifier, e.getMessage(), e); throw e; &#125; if (logger.isInfoEnabled()) &#123; logger.info(\"&#123;&#125; - registration status: &#123;&#125;\", PREFIX + appPathIdentifier, httpResponse.getStatusCode()); &#125; return httpResponse.getStatusCode() == 204;&#125; Eureka serverç«¯æ¥åˆ°è¯·æ±‚åçš„å¤„ç†æ‰“å¼€spring-cloud-netflix-eureka-serverå·¥ç¨‹æˆ–spring-cloud-netflix-eureka-clientè¿‡ç¨‹ï¼Œæ‰¾åˆ°ç›¸åº”çš„mavenä¾èµ–jarï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º 1.Eureka serveræœåŠ¡ç«¯è¯·æ±‚å…¥å£ApplicationResource.javaæ–‡ä»¶ä¸­ç¬¬183è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹å‡ºEurekaæ˜¯é€šè¿‡http postçš„æ–¹å¼å»æœåŠ¡æ³¨å†Œ1234567891011121314151617181920212223242526272829303132333435363738394041424344@POST @Consumes(&#123;\"application/json\", \"application/xml\"&#125;) public Response addInstance(InstanceInfo info, @HeaderParam(PeerEurekaNode.HEADER_REPLICATION) String isReplication) &#123; logger.debug(\"Registering instance &#123;&#125; (replication=&#123;&#125;)\", info.getId(), isReplication); // validate that the instanceinfo contains all the necessary required fields if (isBlank(info.getId())) &#123; return Response.status(400).entity(\"Missing instanceId\").build(); &#125; else if (isBlank(info.getHostName())) &#123; return Response.status(400).entity(\"Missing hostname\").build(); &#125; else if (isBlank(info.getAppName())) &#123; return Response.status(400).entity(\"Missing appName\").build(); &#125; else if (!appName.equals(info.getAppName())) &#123; return Response.status(400).entity(\"Mismatched appName, expecting \" + appName + \" but was \" + info.getAppName()).build(); &#125; else if (info.getDataCenterInfo() == null) &#123; return Response.status(400).entity(\"Missing dataCenterInfo\").build(); &#125; else if (info.getDataCenterInfo().getName() == null) &#123; return Response.status(400).entity(\"Missing dataCenterInfo Name\").build(); &#125; // handle cases where clients may be registering with bad DataCenterInfo with missing data DataCenterInfo dataCenterInfo = info.getDataCenterInfo(); if (dataCenterInfo instanceof UniqueIdentifier) &#123; String dataCenterInfoId = ((UniqueIdentifier) dataCenterInfo).getId(); if (isBlank(dataCenterInfoId)) &#123; boolean experimental = \"true\".equalsIgnoreCase(serverConfig.getExperimental(\"registration.validation.dataCenterInfoId\")); if (experimental) &#123; String entity = \"DataCenterInfo of type \" + dataCenterInfo.getClass() + \" must contain a valid id\"; return Response.status(400).entity(entity).build(); &#125; else if (dataCenterInfo instanceof AmazonInfo) &#123; AmazonInfo amazonInfo = (AmazonInfo) dataCenterInfo; String effectiveId = amazonInfo.get(AmazonInfo.MetaDataKey.instanceId); if (effectiveId == null) &#123; amazonInfo.getMetadata().put(AmazonInfo.MetaDataKey.instanceId.getName(), info.getId()); &#125; &#125; else &#123; logger.warn(\"Registering DataCenterInfo of type &#123;&#125; without an appropriate id\", dataCenterInfo.getClass()); &#125; &#125; &#125; //InstanceRegistry.javaæ–‡ä»¶ä¸­çš„88è¡Œçš„405è¡Œregisteræ–¹æ³• registry.register(info, \"true\".equals(isReplication)); return Response.status(204).build(); // 204 to be backwards compatible &#125; 2.å¦‚ä¸‹å›¾æ‰€ç¤ºå¯ä»¥çœ‹åˆ°ï¼Œä»ApplicationResource.javaæ€ä¹ˆè¿›å…¥åˆ°PeerAwareInstanceRegistryImplä¸­çš„registeræ–¹æ³•InstanceRegistry.javaæ–‡ä»¶ä¸­çš„88è¡Œï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨PeerAwareInstanceRegistryImplä¸­çš„405è¡Œregisteræ–¹æ³•123456@Overridepublic void register(final InstanceInfo info, final boolean isReplication) &#123; handleRegistration(info, resolveInstanceLeaseDuration(info), isReplication); //è°ƒç”¨PeerAwareInstanceRegistryImplä¸­çš„405è¡Œregisteræ–¹æ³• super.register(info, isReplication); &#125; 3.PeerAwareInstanceRegistryImplä¸­çš„405è¡Œregisteræ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚é˜…è¯»æ–¹æ³•ä¸Šé¢çš„æ³¨é‡Šï¼Œå°±çŸ¥é“è¯¥æ–¹æ³•æ˜¯æ³¨å†ŒæœåŠ¡ä¿¡æ¯å¹¶æŠŠEureka Serverä¸­çš„é…ç½®ä¿¡æ¯åŒæ­¥ã€‚æ‰§è¡Œæ³¨å†Œçš„åŠ¨ä½œåœ¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl.register(InstanceInfo info, boolean isReplication)ä¸­ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213141516171819202122/** * Registers the information about the &#123;@link InstanceInfo&#125; and replicates * this information to all peer eureka nodes. If this is replication event * from other replica nodes then it is not replicated. * * @param info * the &#123;@link InstanceInfo&#125; to be registered and replicated. * @param isReplication * true if this is a replication event from other replica nodes, * false otherwise. */ @Override public void register(final InstanceInfo info, final boolean isReplication) &#123; int leaseDuration = Lease.DEFAULT_DURATION_IN_SECS; if (info.getLeaseInfo() != null &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; 0) &#123; leaseDuration = info.getLeaseInfo().getDurationInSecs(); &#125; //è°ƒç”¨çˆ¶ç±»æ–¹æ³•æ³¨å†Œ super.register(info, leaseDuration, isReplication); // åŒæ­¥Eurekaä¸­çš„æœåŠ¡ä¿¡æ¯ replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, null, isReplication); &#125; 4.AbstractInstanceRegistry.javaä¸­192è¡Œï¼Œå¯ä»¥çœ‹åˆ°EurekaçœŸæ­£çš„æœåŠ¡æ³¨å†Œå®ç°çš„ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586/** * Registers a new instance with a given duration. * * @see com.netflix.eureka.lease.LeaseManager#register(java.lang.Object, int, boolean) */ public void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) &#123; try &#123; read.lock(); Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName()); REGISTER.increment(isReplication); if (gMap == null) &#123; final ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = new ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt;(); gMap = registry.putIfAbsent(registrant.getAppName(), gNewMap); if (gMap == null) &#123; gMap = gNewMap; &#125; &#125; Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId()); // Retain the last dirty timestamp without overwriting it, if there is already a lease if (existingLease != null &amp;&amp; (existingLease.getHolder() != null)) &#123; Long existingLastDirtyTimestamp = existingLease.getHolder().getLastDirtyTimestamp(); Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp(); logger.debug(\"Existing lease found (existing=&#123;&#125;, provided=&#123;&#125;\", existingLastDirtyTimestamp, registrationLastDirtyTimestamp); if (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) &#123; logger.warn(\"There is an existing lease and the existing lease's dirty timestamp &#123;&#125; is greater\" + \" than the one that is being registered &#123;&#125;\", existingLastDirtyTimestamp, registrationLastDirtyTimestamp); logger.warn(\"Using the existing instanceInfo instead of the new instanceInfo as the registrant\"); registrant = existingLease.getHolder(); &#125; &#125; else &#123; // The lease does not exist and hence it is a new registration synchronized (lock) &#123; if (this.expectedNumberOfRenewsPerMin &gt; 0) &#123; // Since the client wants to cancel it, reduce the threshold // (1 // for 30 seconds, 2 for a minute) this.expectedNumberOfRenewsPerMin = this.expectedNumberOfRenewsPerMin + 2; this.numberOfRenewsPerMinThreshold = (int) (this.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold()); &#125; &#125; logger.debug(\"No previous lease information found; it is new registration\"); &#125; Lease&lt;InstanceInfo&gt; lease = new Lease&lt;InstanceInfo&gt;(registrant, leaseDuration); if (existingLease != null) &#123; lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp()); &#125; gMap.put(registrant.getId(), lease); synchronized (recentRegisteredQueue) &#123; recentRegisteredQueue.add(new Pair&lt;Long, String&gt;( System.currentTimeMillis(), registrant.getAppName() + \"(\" + registrant.getId() + \")\")); &#125; // This is where the initial state transfer of overridden status happens if (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) &#123; logger.debug(\"Found overridden status &#123;&#125; for instance &#123;&#125;. Checking to see if needs to be add to the \" + \"overrides\", registrant.getOverriddenStatus(), registrant.getId()); if (!overriddenInstanceStatusMap.containsKey(registrant.getId())) &#123; logger.info(\"Not found overridden id &#123;&#125; and hence adding it\", registrant.getId()); overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus()); &#125; &#125; InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId()); if (overriddenStatusFromMap != null) &#123; logger.info(\"Storing overridden status &#123;&#125; from map\", overriddenStatusFromMap); registrant.setOverriddenStatus(overriddenStatusFromMap); &#125; // Set the status based on the overridden status rules InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication); registrant.setStatusWithoutDirty(overriddenInstanceStatus); // If the lease is registered with UP status, set lease service up timestamp if (InstanceStatus.UP.equals(registrant.getStatus())) &#123; lease.serviceUp(); &#125; registrant.setActionType(ActionType.ADDED); recentlyChangedQueue.add(new RecentlyChangedItem(lease)); registrant.setLastUpdatedTimestamp(); invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress()); logger.info(\"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)\", registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication); &#125; finally &#123; read.unlock(); &#125; &#125; æ›´å¤šçš„ç»†èŠ‚æºç å†…å®¹ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±é˜…è¯»ã€‚ æ€»ç»“ApplicationResourceç±»æ¥æ”¶HttpæœåŠ¡è¯·æ±‚ï¼Œè°ƒç”¨PeerAwareInstanceRegistryImplçš„registeræ–¹æ³•ï¼ŒPeerAwareInstanceRegistryImplå®ŒæˆæœåŠ¡æ³¨å†Œåï¼Œè°ƒç”¨replicateToPeerså‘å…¶å®ƒEureka ServerèŠ‚ç‚¹ï¼ˆPeerï¼‰åšçŠ¶æ€åŒæ­¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚","categories":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/categories/Spring-Cloud-Eureka/"}],"tags":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/tags/Spring-Cloud-Eureka/"},{"name":"Spring Cloud æºç åˆ†æ","slug":"Spring-Cloud-æºç åˆ†æ","permalink":"http://xujin.org/tags/Spring-Cloud-æºç åˆ†æ/"}]},{"title":"Spring Cloud Netflixä¹‹Eurekaä¸‹ç¯‡åŸç†","slug":"sc/sc-eureka-mid","date":"2016-10-25T06:00:00.000Z","updated":"2019-01-12T04:04:14.487Z","comments":true,"path":"sc/sc-eureka-mid/","link":"","permalink":"http://xujin.org/sc/sc-eureka-mid/","excerpt":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦ä»‹ç»Eurekaçš„å·¥ä½œåŸç†ï¼ŒEureka ç»„ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šEureka serverå’Œ Eureka clientã€‚è€Œå®¢æˆ·ç«¯åˆåˆ†ä¸º Application Service å®¢æˆ·ç«¯å’Œ Application Client å®¢æˆ·ç«¯ä¸¤ç§ã€‚Eureka çš„å·¥ä½œæœºåˆ¶æ¯ä¸ª region éƒ½æœ‰è‡ªå·±çš„ Eureka æœåŠ¡å™¨é›†ç¾¤ï¼Œæ¯ä¸ª zone è‡³å°‘è¦æœ‰ä¸€ä¸ª Eureka æœåŠ¡å™¨ä»¥åº”å¯¹ zone ç˜«ç—ªã€‚","text":"æ‘˜è¦:æœ¬æ–‡ä¸»è¦ä»‹ç»Eurekaçš„å·¥ä½œåŸç†ï¼ŒEureka ç»„ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šEureka serverå’Œ Eureka clientã€‚è€Œå®¢æˆ·ç«¯åˆåˆ†ä¸º Application Service å®¢æˆ·ç«¯å’Œ Application Client å®¢æˆ·ç«¯ä¸¤ç§ã€‚Eureka çš„å·¥ä½œæœºåˆ¶æ¯ä¸ª region éƒ½æœ‰è‡ªå·±çš„ Eureka æœåŠ¡å™¨é›†ç¾¤ï¼Œæ¯ä¸ª zone è‡³å°‘è¦æœ‰ä¸€ä¸ª Eureka æœåŠ¡å™¨ä»¥åº”å¯¹ zone ç˜«ç—ªã€‚ æ¦‚è¿°åè¯è§£é‡Š Renew:æˆ‘çš„ç†è§£æ˜¯ç»­çº¦ï¼Œä¸ºä»€ä¹ˆå«ç»­çº¦å‘¢ï¼ŸRenewï¼ˆæœåŠ¡ç»­çº¦ï¼‰æ“ä½œç”±Service Providerå®šæœŸè°ƒç”¨ï¼Œç±»ä¼¼äºheartbeatã€‚ç›®çš„æ˜¯éš”ä¸€æ®µæ—¶é—´Service Providerè°ƒç”¨æ¥å£ï¼Œå‘Šè¯‰Eureka Serverå®ƒè¿˜æ´»ç€æ²¡æŒ‚ï¼Œä¸è¦æŠŠå®ƒè¸¢æ‰ã€‚é€šä¿—çš„è¯´å°±æ˜¯å®ƒä»¬ä¸¤ä¹‹é—´çš„å¿ƒè·³æ£€æµ‹ï¼Œé¿å…æœåŠ¡æä¾›è€…è¢«å‰”é™¤æ‰ã€‚ Cancelï¼ˆæœåŠ¡ä¸‹çº¿ï¼‰ä¸€èˆ¬åœ¨Service ProvideræŒ‚äº†æˆ–shut downçš„æ—¶å€™è°ƒç”¨ï¼Œç”¨æ¥æŠŠè‡ªèº«çš„æœåŠ¡ä»Eureka Serverä¸­åˆ é™¤ï¼Œä»¥é˜²å®¢æˆ·ç«¯è°ƒç”¨åˆ°ä¸å­˜åœ¨çš„æœåŠ¡ã€‚ Fetch Registries(è·å–æ³¨å†Œä¿¡æ¯)ï¼ŒFetch Registriesç”±Service Consumer(æœåŠ¡æ¶ˆè´¹è€…)è°ƒç”¨ï¼Œç”¨æ¥è·å–Eureka Serverä¸Šæ³¨å†Œçš„æœåŠ¡infoã€‚ Eviction(å‰”é™¤)Evictionï¼ˆå¤±æ•ˆæœåŠ¡å‰”é™¤ï¼‰ç”¨æ¥å®šæœŸåœ¨Eureka Serveræ£€æµ‹å¤±æ•ˆçš„æœåŠ¡ï¼Œæ£€æµ‹æ ‡å‡†å°±æ˜¯è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰Renewçš„æœåŠ¡ã€‚å›é¡¾Eurekaæ¶æ„å›¾Eurekaæ¶æ„å›¾Eurekaæ¶æ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œgithubåœ°å€:https://github.com/netflix/eurekadocumentåœ°å€:https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance&ensp; ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒEureka ç»„ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šEureka serverå’Œ Eureka clientã€‚è€Œå®¢æˆ·ç«¯åˆåˆ†ä¸º Application Service å®¢æˆ·ç«¯å’Œ Application Client å®¢æˆ·ç«¯ä¸¤ç§ã€‚Eureka çš„å·¥ä½œæœºåˆ¶æ¯ä¸ª region éƒ½æœ‰è‡ªå·±çš„ Eureka æœåŠ¡å™¨é›†ç¾¤ï¼Œæ¯ä¸ª zone è‡³å°‘è¦æœ‰ä¸€ä¸ª Eureka æœåŠ¡å™¨ä»¥åº”å¯¹ zone ç˜«ç—ªã€‚&ensp; Application Service åœ¨å¯åŠ¨æ—¶æ³¨å†Œåˆ° Eureka æœåŠ¡å™¨ï¼Œä¹‹åæ¯ 30 ç§’é’Ÿå‘é€å¿ƒè·³ä»¥æ›´æ–°è‡ªèº«çŠ¶æ€,å³Renew(ç»­çº¦)ã€‚å¦‚æœè¯¥å®¢æˆ·ç«¯æ²¡èƒ½å‘é€å¿ƒè·³æ›´æ–°ï¼Œå®ƒå°†åœ¨ 90 ç§’ä¹‹åè¢«å…¶æ³¨å†Œçš„ Eureka æœåŠ¡å™¨å‰”é™¤ï¼Œå³Eviction(å‰”é™¤)ã€‚æ¥è‡ªä»»æ„ zone çš„ Application Client å¯ä»¥è·å–è¿™äº›æ³¨å†Œä¿¡æ¯(æ¯éš” 30 ç§’æŸ¥çœ‹ä¸€æ¬¡)å¹¶ä¾æ­¤å®šä½åˆ°åœ¨ä»»ä½•åŒºåŸŸå¯ä»¥ç»™è‡ªå·±æä¾›æœåŠ¡çš„æä¾›è€…(å³Fetch Registries)ï¼Œè¿›è€Œè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚ æœåŠ¡æä¾›è€…æœ¬èº«æºå¸¦çš„Eureka Clientæ—¢èƒ½æœåŠ¡æ³¨å†Œï¼ŒæœåŠ¡ç»­çº¦ï¼Œä¹Ÿèƒ½é€šè¿‡clientå®šä½æœåŠ¡å’Œè°ƒç”¨å…¶å®ƒçš„æœåŠ¡ã€‚ æœåŠ¡æ³¨å†ŒæœåŠ¡æ³¨å†Œ æœåŠ¡æ³¨å†Œæºç åˆ†æï¼Œè¯·å‚è€ƒ:http://blog.xujin.org/sc/sc-eureka-register/ Renew(æœåŠ¡ç»­çº¦)æœåŠ¡ç»­çº¦ Renewæ“ä½œä¼šåœ¨Service Providerç«¯å®šæœŸå‘èµ·ï¼Œç”¨æ¥é€šçŸ¥Eureka Serverè‡ªå·±è¿˜æ´»ç€ã€‚ è¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„é…ç½®éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š1eureka.instance.leaseRenewalIntervalInSeconds Renewé¢‘ç‡ã€‚é»˜è®¤æ˜¯30ç§’ï¼Œä¹Ÿå°±æ˜¯æ¯30ç§’ä¼šå‘Eureka Serverå‘èµ·Renewæ“ä½œã€‚1eureka.instance.leaseExpirationDurationInSeconds æœåŠ¡å¤±æ•ˆæ—¶é—´ã€‚é»˜è®¤æ˜¯90ç§’ï¼Œä¹Ÿå°±æ˜¯å¦‚æœEureka Serveråœ¨90ç§’å†…æ²¡æœ‰æ¥æ”¶åˆ°æ¥è‡ªService Providerçš„Renewæ“ä½œï¼Œå°±ä¼šæŠŠService Providerå‰”é™¤ã€‚","categories":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/categories/Spring-Cloud-Eureka/"}],"tags":[{"name":"Spring Cloud Eureka","slug":"Spring-Cloud-Eureka","permalink":"http://xujin.org/tags/Spring-Cloud-Eureka/"}]},{"title":"ä»€ä¹ˆæ˜¯Spring Cloud Configï¼Ÿ","slug":"sc/sc-config","date":"2016-10-19T06:00:00.000Z","updated":"2019-01-12T03:44:13.973Z","comments":true,"path":"sc/sc-config/","link":"","permalink":"http://xujin.org/sc/sc-config/","excerpt":"å‰è¨€:åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬çš„åšæ³•æ˜¯æŠŠPropertyå’ŒCodeæ”¾åœ¨ä¸€èµ·ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºå­˜åœ¨å¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œéœ€è¦åˆ†åˆ«ç®¡ç†åˆ°æ¯ä¸ªå…·ä½“çš„æœåŠ¡å·¥ç¨‹ä¸­çš„é…ç½®ï¼Œä¸Šçº¿éœ€è¦å‡†å¤‡check list å¹¶é€ä¸ªæ£€æŸ¥æ¯ä¸ªä¸Šçº¿çš„æœåŠ¡æ˜¯å¦æ­£ç¡®ã€‚åœ¨ç³»ç»Ÿä¸Šçº¿ä¹‹åä¿®æ”¹æŸä¸ªé…ç½®ï¼Œéœ€è¦é‡å¯æœåŠ¡ã€‚è¿™æ ·å¼€å‘å°±ç›¸å½“éº»çƒ¦ã€‚å› æ­¤æˆ‘ä»¬æ€¥éœ€éœ€è¦æŠŠåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é…ç½®ä¿¡æ¯æŠ½å–å‡ºæ¥ç»Ÿä¸€ç®¡ç†ï¼ŒæœåŠ¡è·å–ç³»ç»Ÿä¿¡æ¯æ—¶æœ‰ä¸€ä¸ªè¦†ç›–é¡ºåº:propertyâ€“&gt; Evnâ€”-&gt;é…ç½®ä¸­å¿ƒã€‚è¿™æ ·ä¿®æ”¹ç¯å¢ƒå˜é‡æˆ–è€…ä¿®æ”¹é…ç½®ä¸­å¿ƒçš„é…ç½®å°±èƒ½å–åˆ°æœ€æ–°çš„é…ç½®ä¿¡æ¯ã€‚åœ¨å”¯å“ä¼š Venus Frameworkä¸­æˆ‘ä»¬ä¸“é—¨è®¾è®¡äº†è¿™ä¸ªåŠŸèƒ½ã€‚Spring cloudå‡ºç°ä¹‹åï¼Œé¿å…äº†å¤§å®¶é‡å¤é€ è½®å­ã€‚ ä»€ä¹ˆæ˜¯ Spring Cloud Config ?å…¶å®˜æ–¹æ–‡æ¡£ä¸­å¯¹è‡ªå·±çš„å®šä¹‰æ˜¯å¦‚ä¸‹ï¼Œå®˜ç½‘è¿æ¥:Spring Cloud Configã€‚ Spring Cloud Config provides server and client-side support for externalized configuration in a distributed system.With the Config Server you have a central place to manage external properties for applications across all environments. ç®€å•æ¥è¯´ï¼ŒSpring Cloud Configå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šçš„é…ç½®ä¸­å¿ƒ - æŠŠåº”ç”¨åŸæœ¬æ”¾åœ¨æœ¬åœ°æ–‡ä»¶çš„é…ç½®æŠ½å–å‡ºæ¥æ”¾åœ¨ä¸­å¿ƒæœåŠ¡å™¨ï¼Œä»è€Œèƒ½å¤Ÿæä¾›æ›´å¥½çš„ç®¡ç†ã€å‘å¸ƒèƒ½åŠ›ã€‚","text":"å‰è¨€:åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬çš„åšæ³•æ˜¯æŠŠPropertyå’ŒCodeæ”¾åœ¨ä¸€èµ·ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºå­˜åœ¨å¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œéœ€è¦åˆ†åˆ«ç®¡ç†åˆ°æ¯ä¸ªå…·ä½“çš„æœåŠ¡å·¥ç¨‹ä¸­çš„é…ç½®ï¼Œä¸Šçº¿éœ€è¦å‡†å¤‡check list å¹¶é€ä¸ªæ£€æŸ¥æ¯ä¸ªä¸Šçº¿çš„æœåŠ¡æ˜¯å¦æ­£ç¡®ã€‚åœ¨ç³»ç»Ÿä¸Šçº¿ä¹‹åä¿®æ”¹æŸä¸ªé…ç½®ï¼Œéœ€è¦é‡å¯æœåŠ¡ã€‚è¿™æ ·å¼€å‘å°±ç›¸å½“éº»çƒ¦ã€‚å› æ­¤æˆ‘ä»¬æ€¥éœ€éœ€è¦æŠŠåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é…ç½®ä¿¡æ¯æŠ½å–å‡ºæ¥ç»Ÿä¸€ç®¡ç†ï¼ŒæœåŠ¡è·å–ç³»ç»Ÿä¿¡æ¯æ—¶æœ‰ä¸€ä¸ªè¦†ç›–é¡ºåº:propertyâ€“&gt; Evnâ€”-&gt;é…ç½®ä¸­å¿ƒã€‚è¿™æ ·ä¿®æ”¹ç¯å¢ƒå˜é‡æˆ–è€…ä¿®æ”¹é…ç½®ä¸­å¿ƒçš„é…ç½®å°±èƒ½å–åˆ°æœ€æ–°çš„é…ç½®ä¿¡æ¯ã€‚åœ¨å”¯å“ä¼š Venus Frameworkä¸­æˆ‘ä»¬ä¸“é—¨è®¾è®¡äº†è¿™ä¸ªåŠŸèƒ½ã€‚Spring cloudå‡ºç°ä¹‹åï¼Œé¿å…äº†å¤§å®¶é‡å¤é€ è½®å­ã€‚ ä»€ä¹ˆæ˜¯ Spring Cloud Config ?å…¶å®˜æ–¹æ–‡æ¡£ä¸­å¯¹è‡ªå·±çš„å®šä¹‰æ˜¯å¦‚ä¸‹ï¼Œå®˜ç½‘è¿æ¥:Spring Cloud Configã€‚ Spring Cloud Config provides server and client-side support for externalized configuration in a distributed system.With the Config Server you have a central place to manage external properties for applications across all environments. ç®€å•æ¥è¯´ï¼ŒSpring Cloud Configå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šçš„é…ç½®ä¸­å¿ƒ - æŠŠåº”ç”¨åŸæœ¬æ”¾åœ¨æœ¬åœ°æ–‡ä»¶çš„é…ç½®æŠ½å–å‡ºæ¥æ”¾åœ¨ä¸­å¿ƒæœåŠ¡å™¨ï¼Œä»è€Œèƒ½å¤Ÿæä¾›æ›´å¥½çš„ç®¡ç†ã€å‘å¸ƒèƒ½åŠ›ã€‚ å¦å¤–ï¼ŒSpring Cloud Configæä¾›åŸºäºä»¥ä¸‹3ä¸ªç»´åº¦çš„é…ç½®ç®¡ç†ï¼š åº”ç”¨ è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œæ¯ä¸ªé…ç½®éƒ½æ˜¯å±äºæŸä¸€ä¸ªåº”ç”¨çš„ ç¯å¢ƒ æ¯ä¸ªé…ç½®éƒ½æ˜¯åŒºåˆ†ç¯å¢ƒçš„ï¼Œå¦‚dev, test, prodç­‰ ç‰ˆæœ¬ è¿™ä¸ªå¯èƒ½æ˜¯ä¸€èˆ¬çš„é…ç½®ä¸­å¿ƒæ‰€ç¼ºä¹çš„ï¼Œå°±æ˜¯å¯¹åŒä¸€ä»½é…ç½®çš„ä¸åŒç‰ˆæœ¬ç®¡ç†ï¼Œæ¯”å¦‚:å¯ä»¥é€šè¿‡Gitè¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚ Spring Cloud Configæä¾›ç‰ˆæœ¬çš„æ”¯æŒï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äºä¸€ä¸ªåº”ç”¨çš„ä¸åŒéƒ¨ç½²å®ä¾‹ï¼Œå¯ä»¥ä»æœåŠ¡ç«¯è·å–åˆ°ä¸åŒç‰ˆæœ¬çš„é…ç½®ï¼Œè¿™å¯¹äºä¸€äº›ç‰¹æ®Šåœºæ™¯å¦‚ï¼šç°åº¦å‘å¸ƒï¼ŒA/Bæµ‹è¯•ç­‰æä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚ ä¸ºä»€ä¹ˆä¼šè¯ç”ŸSpring Cloud Config? é…ç½®ä¸­å¿ƒç›®å‰ç°çŠ¶:ä¸ç®¡æ˜¯å¼€æºçš„(ç™¾åº¦çš„disconf)ï¼Œè¿˜æ˜¯ä¸€äº›å…¬å¸è‡ªå·±é—­æºæŠ•å…¥ä½¿ç”¨çš„äº§å“å·²ç»ä¸å°‘äº†ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜ä¼šè¯ç”ŸSpring Cloud Configå‘¢ï¼Ÿ åœ¨æˆ‘çœ‹æ¥ï¼ŒSpring Cloud Configåœ¨ä»¥ä¸‹å‡ æ–¹é¢è¿˜æ˜¯æœ‰æ¯”è¾ƒç‹¬ç‰¹çš„ä¼˜åŠ¿ï¼Œå¦‚ä¸‹ï¼š åŸºäºåº”ç”¨ã€ç¯å¢ƒã€ç‰ˆæœ¬ä¸‰ä¸ªç»´åº¦ç®¡ç† è¿™ä¸ªåœ¨å‰é¢æè¿‡äº†ï¼Œä¸»è¦æ˜¯æœ‰ç‰ˆæœ¬çš„æ”¯æŒ é…ç½®å­˜å‚¨æ”¯æŒGit è¿™ä¸ªå°±æ¯”è¾ƒæœ‰ç‰¹è‰²äº†ï¼Œåç«¯åŸºäºGitå­˜å‚¨ï¼Œä¸€æ–¹é¢ç¨‹åºå‘˜éå¸¸ç†Ÿæ‚‰ï¼Œå¦ä¸€æ–¹é¢åœ¨éƒ¨ç½²ä¸Šä¼šéå¸¸ç®€å•ï¼Œè€Œä¸”å€ŸåŠ©äºGitï¼Œå¤©ç”Ÿå°±èƒ½éå¸¸å¥½çš„æ”¯æŒç‰ˆæœ¬ å½“ç„¶ï¼Œå®ƒè¿˜æ”¯æŒå…¶å®ƒçš„å­˜å‚¨å¦‚æœ¬åœ°æ–‡ä»¶ã€SVNç­‰ å’ŒSpringæ— ç¼é›†æˆ å®ƒæ— ç¼æ”¯æŒSpringé‡Œé¢Environmentå’ŒPropertySourceçš„æ¥å£ æ‰€ä»¥å¯¹äºå·²æœ‰çš„Springåº”ç”¨ç¨‹åºçš„è¿ç§»æˆæœ¬éå¸¸ä½ï¼Œåœ¨é…ç½®è·å–çš„æ¥å£ä¸Šæ˜¯å®Œå…¨ä¸€è‡´çš„ Spring Cloud Config å…¥é—¨ä¾‹å­ä¸Šè¿°èŠ‚ç‚¹ä¸»è¦ä»‹ç»äº†Spring cloudçš„ç›¸å…³ç†è®ºï¼Œå¤§å®¶å¯¹Spring Cloud Configæœ‰äº†ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ï¼Œæ¥ä¸‹æ¥ä¾‹å­è®©å¤§å®¶æ„Ÿå—ä¸€ä¸‹Spring cloud configçš„é­…åŠ›ã€‚ Overview ä¸Šå›¾ç®€è¦æè¿°äº†ä¸€ä¸ªæ™®é€šSpring Cloud Configåº”ç”¨çš„åœºæ™¯ã€‚å…¶ä¸­ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š Config Client Clientå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ä½¿ç”¨äº†Spring Cloud Configçš„åº”ç”¨ Spring Cloud Configæä¾›äº†åŸºäºSpringçš„å®¢æˆ·ç«¯ï¼Œåº”ç”¨åªè¦åœ¨ä»£ç ä¸­å¼•å…¥Spring Cloud Config Clientçš„jaråŒ…å³å¯å·¥ä½œ Config Server Config Serveræ˜¯éœ€è¦ç‹¬ç«‹éƒ¨ç½²çš„ä¸€ä¸ªwebåº”ç”¨ï¼Œå®ƒè´Ÿè´£æŠŠgitä¸Šçš„é…ç½®è¿”å›ç»™å®¢æˆ·ç«¯ Remote Git Repository è¿œç¨‹Gitä»“åº“ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä¼šæŠŠé…ç½®æ”¾åœ¨ä¸€ä¸ªè¿œç¨‹ä»“åº“ï¼Œé€šè¿‡ç°æˆçš„gitå®¢æˆ·ç«¯æ¥ç®¡ç†é…ç½® Local Git Repostiory Config Serverçš„æœ¬åœ°Gitä»“åº“ Config Serveræ¥åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„é…ç½®è·å–è¯·æ±‚åï¼Œä¼šå…ˆæŠŠè¿œç¨‹ä»“åº“çš„é…ç½®cloneåˆ°æœ¬åœ°çš„ä¸´æ—¶ç›®å½•ï¼Œç„¶åä»ä¸´æ—¶ç›®å½•è¯»å–é…ç½®å¹¶è¿”å›","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://xujin.org/categories/Spring-Cloud/"}],"tags":[{"name":"Spring Cloud Config","slug":"Spring-Cloud-Config","permalink":"http://xujin.org/tags/Spring-Cloud-Config/"}]},{"title":"å…³äºSpringCloudä¸­å›½ç¤¾åŒºä»¥åŠå›½å†…ä½¿ç”¨æƒ…å†µ","slug":"sc/springcloud","date":"2016-10-03T06:00:00.000Z","updated":"2019-01-12T04:32:01.781Z","comments":true,"path":"sc/springcloud/","link":"","permalink":"http://xujin.org/sc/springcloud/","excerpt":"Spring Cloudä¸­å›½ç¤¾åŒºèµ·æº å…¶å®å½“Spring Cloudé¡¹ç›®åˆšåœ¨githubä¸Šå‡ºç°çš„æ—¶å€™ï¼Œæˆ‘å°±ä¸€ç›´åœ¨å…³æ³¨å…¶é¡¹ç›®å‘å±•ï¼Œåˆ°äº†2015å¹´8æœˆï¼Œç”±äºä¸ªäººå…´è¶£ç ”ç©¶Spring Cloudé¡¹ç›®ï¼Œç”±äºå›½å†…ç›¸å…³æ–‡æ¡£è¾ƒå°‘ï¼Œå½“æ—¶å°±æƒ³å»ºç«‹ä¸€ä¸ªä¸­å›½ç¤¾åŒºï¼Œäºæ˜¯å°±å…ˆæŠŠåŸŸåæ³¨å†Œäº†ï¼Œé€‰ä¸­åŸŸåä¸ºspringcloud.cnã€‚ ä¸ºä»€ä¹ˆè¦å‘èµ·Spring Cloudä¸­å›½ç¤¾åŒº Spring Cloudå‘å±•åˆ°2016å¹´ï¼Œå›½å†…å…³æ³¨çš„äººè¶Šæ¥è¶Šå¤šï¼Œä½†æ˜¯ç›¸åº”å­¦ä¹ äº¤æµçš„å¹³å°å’Œææ–™æ¯”è¾ƒåˆ†æ•£ï¼Œä¸åˆ©äºå­¦ä¹ äº¤æµï¼Œå› æ­¤Spring Cloudä¸­å›½ç¤¾åŒºåº”è¿è€Œç”Ÿã€‚ Spring Cloudä¸­å›½ç¤¾åŒºæ˜¯å›½å†…é¦–ä¸ªSpring Cloudæ„å»ºå¾®æœåŠ¡æ¶æ„çš„äº¤æµç¤¾åŒºã€‚æˆ‘ä»¬è‡´åŠ›äºä¸ºSpring Bootæˆ–Spring CloudæŠ€æœ¯äººå‘˜æä¾›åˆ†äº«å’Œäº¤æµçš„å¹³å°ï¼Œæ¨åŠ¨Spring Cloudåœ¨ä¸­å›½çš„æ™®åŠå’Œåº”ç”¨ã€‚ æ¬¢è¿CTOã€æ¶æ„å¸ˆã€å¼€å‘è€…ç­‰ï¼Œåœ¨è¿™é‡Œå­¦ä¹ ä¸äº¤æµä½¿ç”¨Spring Cloudçš„å®æˆ˜ç»éªŒã€‚ ç›®å‰QQç¾¤äººæ•°:7000+,å¾®ä¿¡ç¾¤:2000+. æ‰«æä¸‹é¢äºŒç»´ç æˆ–è€…å¾®ä¿¡æœç´¢SpringCloudï¼Œå…³æ³¨ç¤¾åŒºå…¬ä¼—å· Spring Cloudä¸­å›½ç¤¾åŒºQQç¾¤â‘ :415028731 Spring cloudä¸­å›½ç¤¾åŒºQQç¾¤â‘¡:530321604 Spring Cloudä¸­å›½ç¤¾åŒºå®˜ç½‘:http://springcloud.cn Spring Cloudä¸­å›½ç¤¾åŒºè®ºå›:http://springcloud.cn Spring Cloudä¸­å›½ç¤¾åŒºæ–‡æ¡£:http://docs.springcloud.cn spring cloudç›®å‰å›½å†…ä½¿ç”¨æƒ…å†µ ä¸­å›½è”é€šå­å…¬å¸http://flp.baidu.com/feedland/video/?entry=box_searchbox_feed&amp;id=144115189637730162&amp;from=timeline&amp;isappinstalled=0","text":"Spring Cloudä¸­å›½ç¤¾åŒºèµ·æº å…¶å®å½“Spring Cloudé¡¹ç›®åˆšåœ¨githubä¸Šå‡ºç°çš„æ—¶å€™ï¼Œæˆ‘å°±ä¸€ç›´åœ¨å…³æ³¨å…¶é¡¹ç›®å‘å±•ï¼Œåˆ°äº†2015å¹´8æœˆï¼Œç”±äºä¸ªäººå…´è¶£ç ”ç©¶Spring Cloudé¡¹ç›®ï¼Œç”±äºå›½å†…ç›¸å…³æ–‡æ¡£è¾ƒå°‘ï¼Œå½“æ—¶å°±æƒ³å»ºç«‹ä¸€ä¸ªä¸­å›½ç¤¾åŒºï¼Œäºæ˜¯å°±å…ˆæŠŠåŸŸåæ³¨å†Œäº†ï¼Œé€‰ä¸­åŸŸåä¸ºspringcloud.cnã€‚ ä¸ºä»€ä¹ˆè¦å‘èµ·Spring Cloudä¸­å›½ç¤¾åŒº Spring Cloudå‘å±•åˆ°2016å¹´ï¼Œå›½å†…å…³æ³¨çš„äººè¶Šæ¥è¶Šå¤šï¼Œä½†æ˜¯ç›¸åº”å­¦ä¹ äº¤æµçš„å¹³å°å’Œææ–™æ¯”è¾ƒåˆ†æ•£ï¼Œä¸åˆ©äºå­¦ä¹ äº¤æµï¼Œå› æ­¤Spring Cloudä¸­å›½ç¤¾åŒºåº”è¿è€Œç”Ÿã€‚ Spring Cloudä¸­å›½ç¤¾åŒºæ˜¯å›½å†…é¦–ä¸ªSpring Cloudæ„å»ºå¾®æœåŠ¡æ¶æ„çš„äº¤æµç¤¾åŒºã€‚æˆ‘ä»¬è‡´åŠ›äºä¸ºSpring Bootæˆ–Spring CloudæŠ€æœ¯äººå‘˜æä¾›åˆ†äº«å’Œäº¤æµçš„å¹³å°ï¼Œæ¨åŠ¨Spring Cloudåœ¨ä¸­å›½çš„æ™®åŠå’Œåº”ç”¨ã€‚ æ¬¢è¿CTOã€æ¶æ„å¸ˆã€å¼€å‘è€…ç­‰ï¼Œåœ¨è¿™é‡Œå­¦ä¹ ä¸äº¤æµä½¿ç”¨Spring Cloudçš„å®æˆ˜ç»éªŒã€‚ ç›®å‰QQç¾¤äººæ•°:7000+,å¾®ä¿¡ç¾¤:2000+. æ‰«æä¸‹é¢äºŒç»´ç æˆ–è€…å¾®ä¿¡æœç´¢SpringCloudï¼Œå…³æ³¨ç¤¾åŒºå…¬ä¼—å· Spring Cloudä¸­å›½ç¤¾åŒºQQç¾¤â‘ :415028731 Spring cloudä¸­å›½ç¤¾åŒºQQç¾¤â‘¡:530321604 Spring Cloudä¸­å›½ç¤¾åŒºå®˜ç½‘:http://springcloud.cn Spring Cloudä¸­å›½ç¤¾åŒºè®ºå›:http://springcloud.cn Spring Cloudä¸­å›½ç¤¾åŒºæ–‡æ¡£:http://docs.springcloud.cn spring cloudç›®å‰å›½å†…ä½¿ç”¨æƒ…å†µ ä¸­å›½è”é€šå­å…¬å¸http://flp.baidu.com/feedland/video/?entry=box_searchbox_feed&amp;id=144115189637730162&amp;from=timeline&amp;isappinstalled=0 ä¸Šæµ·ç±³ä¹ˆé‡‘æœ æŒ‡ç‚¹æ— é™ï¼ˆåŒ—äº¬ï¼‰ç§‘æŠ€æœ‰é™å…¬å¸ æ˜“ä¿è½¯ä»¶ ç›®å‰åœ¨å®šåˆ¶å¼€å‘ä¸­ http://www.ebaotech.com/cn/ å¹¿å·ç®€æ³•ç½‘ç»œ æ·±åœ³ç¿äº‘æ™ºåˆç§‘æŠ€æœ‰é™å…¬å¸ æŒç»­äº¤ä»˜äº§å“åŸºäºSpring Cloudç ”å‘ http://www.wise2c.com çŒªå…«æˆ’ç½‘ ä¸Šæµ·äº‘é¦–ç§‘æŠ€æœ‰é™å…¬å¸ åä¸º æ•´åˆnettyè¿›æ¥ç”¨rpc åŒ…æ‹¬nerflixé‚£å¥—ä¸œè¥¿ éœ€è¦æ³¨æ„çš„æ˜¯sleuth traceidçš„ä¼ é€’éœ€è¦è‡ªå·±å†™ã€‚tpsåœ¨ç‰©ç†æœºä¸Šèƒ½çªç ´20w ä¸œè½¯ å—äº¬äº‘å¸æˆ¿ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ å››ä¼—äº’è”(åŒ—äº¬)ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ æ·±åœ³æ‘©ä»¤æŠ€æœ¯ç§‘æŠ€æœ‰é™å…¬å¸ å¹¿å·ä¸‡è¡¨ç½‘ è§†è§‰ä¸­å›½ ä¸Šæµ·ç§¦è‹ä¿¡æ¯ç§‘æŠ€æœ‰é™å…¬å¸-ä¹°å•ä¾  çˆ±æ²¹ç§‘æŠ€(å¤§è¿)æœ‰é™å…¬å¸çˆ±æ²¹ç§‘æŠ€åŸºäºSpringCloudçš„å¾®æœåŠ¡å®è·µ å¹¿å‘é“¶è¡Œ å–è´§éƒ(http://www.51mhl.com/ï¼‰ æ‹æ‹è´· ç”˜è‚ƒç”µä¿¡ æ–°æµªå•†å“éƒ¨ æ˜¥ç§‹èˆªç©º å†°é‰´ç§‘æŠ€ ä¸‡è¾¾ç½‘ç»œç§‘æŠ€é›†å›¢-å…±äº«å•†ä¸šå¹³å°-å…±äº«ä¾›åº”é“¾ä¸­å¿ƒ ç½‘æ˜“ä¹å¾—æŠ€æœ¯å›¢é˜Ÿ é¥¿äº†ä¹ˆæŸæŠ€æœ¯å›¢é˜Ÿ é«˜é˜³æ·è¿…ä¿¡æ¯ç§‘æŠ€â€“è¯è´¹ä¸­å¿ƒä¸šåŠ¡å¹³å°â€“å‡­è¯æŸ¥è¯¢åŠæ”¶å•ç³»ç»Ÿæ•°æ®åœ¨ç»Ÿè®¡ä¹‹ä¸­ï¼Œä¼šä¸€ç›´æŒç»­æ›´æ–°ï¼Œæ•¬è¯·æœŸå¾…ï¼ æèµ ç¤¾åŒºå‘å±•æèµ ç¤¾åŒº å¦‚æœä½ è§‰å¾—ï¼ŒSpring Cloudä¸­å›½ç¤¾åŒºè¿˜å¯ä»¥ï¼Œä¸ºäº†æ›´å¥½çš„å‘å±•ï¼Œä½ å¯ä»¥æèµ ç¤¾åŒºï¼Œç‚¹å‡»ä¸‹é¢çš„æ‰“èµæèµ ï¼Œæèµ çš„é’±å°†ç”¨äºç¤¾åŒºå‘å±•å’Œçº¿ä¸‹meeting upã€‚","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://xujin.org/categories/Spring-Cloud/"}],"tags":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://xujin.org/tags/Spring-Cloud/"}]}]}