<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>è®¸è¿›æ²‰æ€å½•-ä¸“æ³¨äºäº’è”ç½‘ä¸ä¸­é—´ä»¶åŸºç¡€æ¶æ„æŠ€æœ¯ç ”ç©¶</title>
  
  <subtitle>HaloğŸ’«</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://xujin.org/"/>
  <updated>2019-01-12T04:21:40.872Z</updated>
  <id>http://xujin.org/</id>
  
  <author>
    <name>HaloğŸ’«</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring Cloudç¬¬äºŒä»£</title>
    <link href="http://xujin.org/sc/sc2/"/>
    <id>http://xujin.org/sc/sc2/</id>
    <published>2018-11-27T06:00:00.000Z</published>
    <updated>2019-01-12T04:21:40.872Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>: éšç€Eurekaä¸å†ç»´æŠ¤ï¼ŒHystrixä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œè¿›å…¥ç»´æŠ¤çŠ¶æ€ã€‚ä»¥åŠæœ€è¿‘ä¸­å›½å¼€æºå‡ºç°ä¸€äº›å¤§äº‹ï¼Œé¢„æµ‹ä¸€ä¸‹2019å¹´æœªæ¥Spring Cloudç”Ÿæ€åœˆä¸­çš„ç¬¬äºŒä»£ç»„ä»¶çš„ç»„åˆï¼Œä»…<code>ä»£è¡¨ä¸ªäººçœ‹æ³•</code>ã€‚</p><h2 id="1-Spring-Cloudç¬¬ä¸€ä»£"><a href="#1-Spring-Cloudç¬¬ä¸€ä»£" class="headerlink" title="1. Spring Cloudç¬¬ä¸€ä»£"></a>1. Spring Cloudç¬¬ä¸€ä»£</h2><p>  Spring Cloudè‡ªä»æ¨å‡ºä¹‹åï¼Œç»™å¤§å®¶çš„æ„Ÿè§‰å°±æ˜¯Spring Cloudåš<code>å®ƒæœ€æ“…é•¿çš„äº‹ï¼Œä¹Ÿå°±æ˜¯é«˜åº¦æŠ½è±¡å’Œå°è£…ï¼Œå¼ºå¼ºè”æ‰‹æ•´åˆæœ€ä¼˜ä¸œè¥¿ä¸ºæˆ‘æ‰€ç”¨</code>ï¼Œæ¯”å¦‚Netflixå¼€æºçš„Eurekaï¼ŒHystrixï¼ŒRibbonç­‰ã€‚è€Œä¸”æä¾›<code>å¤šç§æŠ€æœ¯é€‰å‹ï¼Œæ€åº¦ä¸­ç«‹è€Œé€‰æœ€ä¼˜</code>ã€‚8å¤©å‰ä¹Ÿå°±æ˜¯2018å¹´11æœˆ19å·å·¦å³ï¼ŒNetflixçš„å¼€æºé¡¹ç›®Hystrixå®£å¸ƒçŠ¶æ€ï¼Œä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œå¤„äºç»´æŠ¤çŠ¶æ€ã€‚å¼•å‘æœ‹å‹åœˆçš„ä¸€äº›æ€è€ƒã€‚</p><a id="more"></a><p><img src="/images/sc/hystrix.jpg" alt=""></p><blockquote><p>è™½ç„¶Eurekaï¼ŒHystrixç­‰ä¸å†ç»§ç»­å¼€å‘æˆ–ç»´æŠ¤ï¼Œä½†æ˜¯ç›®å‰æ¥è¯´ä¸å½±å“ä½¿ç”¨ï¼Œä¸ç®¡æ€ä¹ˆè¯´æ„Ÿè°¢å¼€æºï¼Œå‘Netflixå…¬å¸çš„å¼€æºè‡´æ•¬ã€‚</p></blockquote><p>  éšç€Spring Cloudç”Ÿæ€åœˆçš„å‘å±•ä¸æˆé•¿ï¼ŒSpring Cloudé™†ç»­æ¨å‡ºäº†è‡ªå·±çš„ä¸€äº›ç»„ä»¶ï¼ŒæŒ‘é€‰ä¸»è¦ç»„ä»¶è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤º:</p><table><thead><tr><th>ç»„ä»¶</th><th>æ¥æº</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Spring-cloud-openfeign</td><td>åŸºäºFeignçš„å‡çº§</td><td>æœåŠ¡ä¹‹é—´è°ƒç”¨çš„å¿…å¤‡ç»„ä»¶</td></tr><tr><td>spring-cloud-zuul</td><td>æ¥æºäºNetflix Zuul</td><td>ç›®å‰è¿˜åœ¨ç»§ç»­ç»´æŠ¤ï¼Œä½†æ˜¯å·²ç»æœ‰è‡ªå·±çš„Spring Cloud Gateway,ä¸ä¹…å°†æ¥é€æ¸æ·˜æ±°</td></tr><tr><td>spring-cloud-eureka</td><td>é›†æˆäºNetflix Eureka</td><td>ç›®å‰è¿˜åœ¨è·ŸéšSpring Cloudç‰ˆæœ¬å‡çº§ç»´æŠ¤ï¼Œæœ€ç»ˆä¹Ÿä¼šè¢«æ›¿ä»£</td></tr><tr><td>spring-cloud-config</td><td>è‡ªç ”</td><td>åŠŸèƒ½ä¸è¶³ï¼Œå›½å†…ä½¿ç”¨å…¶å®ƒé…ç½®ä¸­å¿ƒæ›¿ä»£ï¼Œæ¯”å¦‚æºç¨‹çš„Apollo</td></tr><tr><td>å…¨é“¾è·¯ç›‘æ§(sleuth+zikpinæˆ–pinpont)</td><td>sleuthè‡ªç ”ï¼Œå…¶å®ƒç¬¬ä¸‰æ–¹</td><td>å›½å†…ç›®å‰ä½¿ç”¨æœ€å¤šçš„æ˜¯skywalingç­‰ä¸Šç”Ÿäº§</td></tr><tr><td>spring-cloud-ribbon</td><td>æ¥æºäºNetflixé›†æˆ</td><td>ribbonç›®å‰è¿˜åœ¨è·ŸéšSpring Cloudç‰ˆæœ¬ç»´æŠ¤ä¸­ï¼Œç›®å‰å­µåŒ–æœªæ¥æ›¿ä»£å“spring-cloud-lb</td></tr><tr><td>Spring-cloud-hystrix</td><td>æ¥æºäºNetflixé›†æˆ</td><td>ç›®å‰è¿˜åœ¨è·ŸéšSpring Cloudç‰ˆæœ¬ç»´æŠ¤ä¸­ç›®å‰å·²ç»å­µåŒ–spring-cloud-r4j</td></tr></tbody></table><h2 id="2-Spring-Cloud-ç¬¬äºŒä»£"><a href="#2-Spring-Cloud-ç¬¬äºŒä»£" class="headerlink" title="2. Spring Cloud ç¬¬äºŒä»£"></a>2. Spring Cloud ç¬¬äºŒä»£</h2><p> Spring Cloudç¬¬ä¸€ä»£å’Œç¬¬äºŒä»£çš„ç»„ä»¶ç»„åˆæ±‡æ€»ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><thead><tr><th></th><th>Spring Cloudç¬¬ä¸€ä»£</th><th>Spring Cloudç¬¬äºŒä»£</th></tr></thead><tbody><tr><td>ç½‘å…³</td><td>Spring Cloud Zuul</td><td>Spring Cloud Gateway</td></tr><tr><td>æ³¨å†Œä¸­å¿ƒ</td><td>eureka(ä¸å†æ›´æ–°)ï¼ŒConsul,ZK</td><td>é˜¿é‡ŒNacosï¼Œæ‹æ‹è´·radarç­‰å¯é€‰</td></tr><tr><td>é…ç½®ä¸­å¿ƒ</td><td>spring cloud config</td><td>é˜¿é‡ŒNacosï¼Œæºç¨‹Apolloï¼Œéšè¡Œä»˜Config Keeper</td></tr><tr><td>å®¢æˆ·ç«¯è½¯è´Ÿè½½å‡è¡¡</td><td>Ribbon</td><td>spring-cloud-loadbalancer</td></tr><tr><td>ç†”æ–­å™¨</td><td>Hystrix</td><td>spring-cloud-r4j(Resilience4J)ï¼Œé˜¿é‡ŒSentinel</td></tr></tbody></table><blockquote><p>ç”±äºZuulæ€§èƒ½ä¸€èˆ¬ï¼Œzuul 2.x(ä¸€ç›´è·³ç¥¨ï¼Œè™½æœ€ç»ˆå¼€æºï¼‰ä½†æ˜¯Spring Cloudå®˜æ–¹å·²ç»æ¨å‡ºSpring Cloud gateway,Spring Cloudä¸­å›½ç¤¾åŒºå¾ˆä¹…ä¹‹å‰å·²ç»è¯å®ï¼ŒSpring Cloudå°†ä¸ä¼šé›†æˆzuul 2.xï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä¸å°±æœªæ¥Zuulå°†ä»Spring Cloudç”Ÿæ€åœˆä¸­é€€å‡ºã€‚</p></blockquote><hr><blockquote><p>ribbonç”±äºä¸æ”¯æŒwebFluxçš„è´Ÿè½½å‡è¡¡ï¼ŒSpring Cloudå®˜æ–¹å¾ˆæ—©å°±åœ¨å­µåŒ–å™¨é¡¹ç›®ä¸­å­µåŒ–spring-cloud-loadbalancerï¼Œç›®å‰å·²ç»å°†ä»£ç åˆå¹¶åˆ°spring-cloud-commonä¸­ï¼Œé¢„è®¡åœ¨Spring Cloud Gç‰ˆå¯ä»¥ä½¿ç”¨ï¼Œé¢„è®¡2018å¹´12æœˆåº•realeseã€‚</p></blockquote><hr><blockquote><p>è‡³äºHystrixï¼ŒNetflixåœ¨2018å¹´11æœˆ19å·å·¦å³ï¼ŒNetflixçš„å¼€æºé¡¹ç›®Hystrixå®£å¸ƒçŠ¶æ€ï¼Œä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œå¤„äºç»´æŠ¤çŠ¶æ€ï¼Œå…¶å®åœ¨ä¹‹å‰Spring Cloudå®˜æ–¹å°±åœ¨å­µåŒ–spring-cloud-r4j.</p></blockquote><h2 id="3-å¼€æºé¡¹ç›®çš„é“¾æ¥"><a href="#3-å¼€æºé¡¹ç›®çš„é“¾æ¥" class="headerlink" title="3.å¼€æºé¡¹ç›®çš„é“¾æ¥"></a>3.å¼€æºé¡¹ç›®çš„é“¾æ¥</h2><p>æœ¬æ–‡æ‰€æåˆ°çš„å¼€æºé¡¹ç›®é“¾æ¥æ±‡æ€»å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel</a></p><p><a href="https://github.com/spring-cloud-incubator/spring-cloud-r4j" target="_blank" rel="noopener">https://github.com/spring-cloud-incubator/spring-cloud-r4j</a></p><p><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener">é˜¿é‡ŒNacos-https://github.com/alibaba/nacos</a></p><p><a href="https://github.com/sxfad/config-keeper" target="_blank" rel="noopener">éšè¡Œä»˜Config-keeper-https://github.com/sxfad/config-keeper</a></p><p><a href="https://github.com/spring-cloud-incubator/spring-cloud-loadbalancer" target="_blank" rel="noopener">spring-cloud-loadbalancer</a></p><p><a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo</a></p><p><a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener">https://github.com/apache/incubator-skywalking</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;: éšç€Eurekaä¸å†ç»´æŠ¤ï¼ŒHystrixä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œè¿›å…¥ç»´æŠ¤çŠ¶æ€ã€‚ä»¥åŠæœ€è¿‘ä¸­å›½å¼€æºå‡ºç°ä¸€äº›å¤§äº‹ï¼Œé¢„æµ‹ä¸€ä¸‹2019å¹´æœªæ¥Spring Cloudç”Ÿæ€åœˆä¸­çš„ç¬¬äºŒä»£ç»„ä»¶çš„ç»„åˆï¼Œä»…&lt;code&gt;ä»£è¡¨ä¸ªäººçœ‹æ³•&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-Spring-Cloudç¬¬ä¸€ä»£&quot;&gt;&lt;a href=&quot;#1-Spring-Cloudç¬¬ä¸€ä»£&quot; class=&quot;headerlink&quot; title=&quot;1. Spring Cloudç¬¬ä¸€ä»£&quot;&gt;&lt;/a&gt;1. Spring Cloudç¬¬ä¸€ä»£&lt;/h2&gt;&lt;p&gt;  Spring Cloudè‡ªä»æ¨å‡ºä¹‹åï¼Œç»™å¤§å®¶çš„æ„Ÿè§‰å°±æ˜¯Spring Cloudåš&lt;code&gt;å®ƒæœ€æ“…é•¿çš„äº‹ï¼Œä¹Ÿå°±æ˜¯é«˜åº¦æŠ½è±¡å’Œå°è£…ï¼Œå¼ºå¼ºè”æ‰‹æ•´åˆæœ€ä¼˜ä¸œè¥¿ä¸ºæˆ‘æ‰€ç”¨&lt;/code&gt;ï¼Œæ¯”å¦‚Netflixå¼€æºçš„Eurekaï¼ŒHystrixï¼ŒRibbonç­‰ã€‚è€Œä¸”æä¾›&lt;code&gt;å¤šç§æŠ€æœ¯é€‰å‹ï¼Œæ€åº¦ä¸­ç«‹è€Œé€‰æœ€ä¼˜&lt;/code&gt;ã€‚8å¤©å‰ä¹Ÿå°±æ˜¯2018å¹´11æœˆ19å·å·¦å³ï¼ŒNetflixçš„å¼€æºé¡¹ç›®Hystrixå®£å¸ƒçŠ¶æ€ï¼Œä¸å†å¼€å‘æ–°åŠŸèƒ½ï¼Œå¤„äºç»´æŠ¤çŠ¶æ€ã€‚å¼•å‘æœ‹å‹åœˆçš„ä¸€äº›æ€è€ƒã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud" scheme="http://xujin.org/categories/Spring-Cloud/"/>
    
    
      <category term="Spring Cloud" scheme="http://xujin.org/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Nacoså®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±</title>
    <link href="http://xujin.org/sc/gw/gw10/"/>
    <id>http://xujin.org/sc/gw/gw10/</id>
    <published>2018-11-17T06:00:00.000Z</published>
    <updated>2019-01-12T03:33:48.579Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬æ–‡ä¸»è¦ä»‹ç»é€šè¿‡Nacosä¸‹å‘è·¯ç”±é…ç½®å®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚</p><h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1.å‰è¨€"></a>1.å‰è¨€</h2><p>   ç½‘å…³ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯è·¯ç”±é…ç½®å’Œè·¯ç”±è§„åˆ™ï¼Œè·¯ç”±é…ç½®æ˜¯æŒ‡é…ç½®æŸè¯·æ±‚è·¯å¾„è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°å€ã€‚è€Œè·¯ç”±è§„åˆ™æ˜¯æŒ‡åŒ¹é…åˆ°è·¯ç”±é…ç½®ä¹‹åï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè½¬å‘å¤„ç†ã€‚<br>   Spring Cloud Gatewayä½œä¸ºæ‰€æœ‰è¯·æ±‚æµé‡çš„å…¥å£ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†ä¿è¯é«˜å¯é å’Œé«˜å¯ç”¨ï¼Œå°½é‡é¿å…é‡å¯,éœ€è¦å®ç°Spring Cloud GatewayåŠ¨æ€è·¯ç”±é…ç½®ã€‚å‰é¢ç« èŠ‚ä»‹ç»äº†Spring Cloud Gatewayæä¾›çš„ä¸¤ç§æ–¹æ³•å»é…ç½®è·¯ç”±è§„åˆ™ï¼Œä½†éƒ½æ˜¯åœ¨Spring Cloud Gatewayå¯åŠ¨æ—¶å€™ï¼Œå°±å°†è·¯ç”±é…ç½®å’Œè§„åˆ™åŠ è½½åˆ°å†…å­˜é‡Œï¼Œæ— æ³•åšåˆ°ä¸é‡å¯ç½‘å…³å°±å¯ä»¥åŠ¨æ€çš„å¯¹åº”è·¯ç”±çš„é…ç½®å’Œè§„åˆ™è¿›è¡Œå¢åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ã€‚æœ¬æ–‡æ˜¯åŸºäº<a href="http://xujin.org/sc/gw/gw09/">Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±å®ç°</a><br>åŸºç¡€ä¹‹ä¸Šç¼–å†™ï¼Œé€šè¿‡Nacosé…ç½®æœåŠ¡ä¸‹å‘è·¯ç”±é…ç½®å®ç°åŠ¨æ€è·¯ç”±ã€‚</p><a id="more"></a><h2 id="2-Spring-Cloud-Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°"><a href="#2-Spring-Cloud-Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°" class="headerlink" title="2. Spring Cloud Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°"></a>2. Spring Cloud Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°</h2><p>Spring Cloud Gatewayçš„å®˜æ–¹æ–‡æ¡£å¹¶æ²¡æœ‰è®²å¦‚ä½•åŠ¨æ€é…ç½®ï¼ŒæŸ¥çœ‹ Spring Cloud Gatewayçš„æºç ï¼Œå‘ç°<code>åœ¨org.springframework.cloud.gateway.actuate.GatewayControllerEndpoint</code>ç±»ä¸­æä¾›äº†åŠ¨æ€é…ç½®çš„Restæ¥å£ï¼Œä½†æ˜¯<code>éœ€è¦å¼€å¯Gatewayçš„ç«¯ç‚¹</code>ï¼Œè€Œä¸”æä¾›çš„åŠŸèƒ½ä¸æ˜¯å¾ˆå¼ºå¤§ã€‚é€šè¿‡å‚è€ƒå’ŒGatewayControllerEndpointç›¸å…³çš„ä»£ç ï¼Œå¯ä»¥è‡ªå·±ç¼–ç å®é™…åŠ¨æ€è·¯ç”±é…ç½®ã€‚<br>ä¸‹é¢é€šè¿‡æ¡ˆä¾‹çš„æ–¹å¼å»è®²è§£æ€ä¹ˆé€šNacoså®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚æ¡ˆä¾‹å·¥ç¨‹å¦‚spring-cloud-gateway-nacosæ‰€ç¤ºã€‚</p><blockquote><p>ä»£ç åœ°å€:<a href="https://github.com/SpringCloud/spring-cloud-gateway-nacos" target="_blank" rel="noopener">https://github.com/SpringCloud/spring-cloud-gateway-nacos</a></p></blockquote><h2 id="3-ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°"><a href="#3-ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°" class="headerlink" title="3. ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°"></a>3. ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°</h2><h3 id="3-1-æ–°å»ºMavenå·¥ç¨‹sc-gateway-server"><a href="#3-1-æ–°å»ºMavenå·¥ç¨‹sc-gateway-server" class="headerlink" title="3.1 æ–°å»ºMavenå·¥ç¨‹sc-gateway-server"></a>3.1 æ–°å»ºMavenå·¥ç¨‹sc-gateway-server</h3><p>  é…ç½®ä¸»è¦çš„æ ¸å¿ƒä¾èµ–å¦‚ä»£ç æ¸…å•æ‰€ç¤ºï¼š<br>  ä»£ç æ¸…å•: spring-cloud-gateway-nacos/sc-gateway-server/pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.nacos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="3-2-æ ¹æ®Spring-Cloud-Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹"><a href="#3-2-æ ¹æ®Spring-Cloud-Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹" class="headerlink" title="3.2 æ ¹æ®Spring Cloud Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹"></a>3.2 æ ¹æ®Spring Cloud Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹</h3><p> åˆ†åˆ«åˆ›å»ºGatewayRouteDefinition.java, GatewayPredicateDefinition.java, GatewayFilterDefinition.javaè¿™ä¸‰ä¸ªç±»ã€‚<br>(1) åˆ›å»ºè·¯ç”±å®šä¹‰æ¨¡å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayRouteDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·¯ç”±çš„Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">//è·¯ç”±æ–­è¨€é›†åˆé…ç½®</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GatewayPredicateDefinition&gt; predicates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//è·¯ç”±è¿‡æ»¤å™¨é›†åˆé…ç½®</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GatewayFilterDefinition&gt; filters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//è·¯ç”±è§„åˆ™è½¬å‘çš„ç›®æ ‡uri</span></span><br><span class="line">    <span class="keyword">private</span> String uri;</span><br><span class="line">    <span class="comment">//è·¯ç”±æ‰§è¡Œçš„é¡ºåº</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//æ­¤å¤„çœç•¥getå’Œsetæ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(2)åˆ›å»ºè¿‡æ»¤å™¨å®šä¹‰æ¨¡å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Filter Name</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//å¯¹åº”çš„è·¯ç”±è§„åˆ™</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ­¤å¤„çœç•¥Getå’ŒSetæ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(3)åˆ›å»ºè·¯ç”±æ–­è¨€å®šä¹‰æ¨¡å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayPredicateDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ–­è¨€å¯¹åº”çš„Name</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//é…ç½®çš„æ–­è¨€è§„åˆ™</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ­¤å¤„çœç•¥Getå’ŒSetæ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»"><a href="#3-3-ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»" class="headerlink" title="3.3 ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»"></a>3.3 ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»</h3><p>ç¼–å†™DynamicRouteServiceImplå¹¶å®ç°ApplicationEventPublisherAwareæ¥å£ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImpl</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher publisher;</span><br><span class="line">    <span class="comment">//å¢åŠ è·¯ç”±</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</span><br><span class="line">        routeDefinitionWriter.save(Mono.just(definition)).subscribe();</span><br><span class="line">        <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ›´æ–°è·¯ç”±</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(definition.getId()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"update fail,not find route  routeId: "</span>+definition.getId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            routeDefinitionWriter.save(Mono.just(definition)).subscribe();</span><br><span class="line">            <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"update route  fail"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ é™¤è·¯ç”±</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(String id) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(id))</span><br><span class="line">                .then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build())))</span><br><span class="line">                .onErrorResume(t -&gt; t <span class="keyword">instanceof</span> NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.publisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-ç¼–å†™Nacosç›‘å¬æ¥æ”¶ä¸‹å‘çš„è·¯ç”±é…ç½®"><a href="#3-4-ç¼–å†™Nacosç›‘å¬æ¥æ”¶ä¸‹å‘çš„è·¯ç”±é…ç½®" class="headerlink" title="3.4 ç¼–å†™Nacosç›‘å¬æ¥æ”¶ä¸‹å‘çš„è·¯ç”±é…ç½®"></a>3.4 ç¼–å†™Nacosç›‘å¬æ¥æ”¶ä¸‹å‘çš„è·¯ç”±é…ç½®</h3><h3 id="3-4-1-ä½¿ç”¨Nacosç›‘å¬ä¸‹å‘çš„é…ç½®"><a href="#3-4-1-ä½¿ç”¨Nacosç›‘å¬ä¸‹å‘çš„é…ç½®" class="headerlink" title="3.4.1 ä½¿ç”¨Nacosç›‘å¬ä¸‹å‘çš„é…ç½®"></a>3.4.1 ä½¿ç”¨Nacosç›‘å¬ä¸‹å‘çš„é…ç½®</h3><p>ç›‘å¬Nacos Config Serverä¸‹å‘é…ç½®çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImplByNacos</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DynamicRouteServiceImpl dynamicRouteService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicRouteServiceImplByNacos</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        dynamicRouteByNacosListener(<span class="string">"sc-gateway"</span>,<span class="string">"xujin_test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›‘å¬Nacos Serverä¸‹å‘çš„åŠ¨æ€è·¯ç”±é…ç½®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dynamicRouteByNacosListener</span> <span class="params">(String dataId, String group)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ConfigService configService=NacosFactory.createConfigService(<span class="string">"127.0.0.1:8848"</span>);</span><br><span class="line">            String content = configService.getConfig(dataId, group, <span class="number">5000</span>);</span><br><span class="line">            System.out.println(content);</span><br><span class="line">            configService.addListener(dataId, group, <span class="keyword">new</span> Listener()  &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConfigInfo</span><span class="params">(String configInfo)</span> </span>&#123;</span><br><span class="line">                    RouteDefinition definition= JSON.parseObject(configInfo,RouteDefinition.class);</span><br><span class="line">                    dynamicRouteService.update(definition);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">            <span class="comment">//todo æé†’:å¼‚å¸¸è‡ªè¡Œå¤„ç†æ­¤å¤„çœç•¥</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-4-2-ä¸¤ç§æ–¹å¼åˆ›å»ºConfigService"><a href="#3-4-2-ä¸¤ç§æ–¹å¼åˆ›å»ºConfigService" class="headerlink" title="3.4.2 ä¸¤ç§æ–¹å¼åˆ›å»ºConfigService"></a>3.4.2 ä¸¤ç§æ–¹å¼åˆ›å»ºConfigService</h4><p>ä½¿ç”¨ä¸¤ç§æ–¹å¼åˆ›å»ºcom.alibaba.nacos.api.config.ConfigService</p><ul><li>1.æ„å»ºPropertiesåˆ›å»º</li></ul><p>ä½¿ç”¨createConfigService(Properties properties)ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            properties.put(<span class="string">"nacos.server-addr"</span>, <span class="string">""</span>);</span><br><span class="line">            properties.put(PropertyKeyConst.SERVER_ADDR, <span class="string">"127.0.0.1:8848"</span>);</span><br><span class="line">            ConfigService configService=NacosFactory.createConfigService(properties);</span><br></pre></td></tr></table></figure></p><blockquote><p>æ³¨æ„:PropertyKeyConstæ˜¯com.alibaba.nacos.api.PropertyKeyConst</p></blockquote><ul><li>2.åªä¼ é€’Nacos Config Serverçš„åœ°å€</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConfigService configService=NacosFactory.createConfigService(<span class="string">"127.0.0.1:8848"</span>);</span><br></pre></td></tr></table></figure><h2 id="4-ä½¿ç”¨Nacosä¸‹å‘é…ç½®"><a href="#4-ä½¿ç”¨Nacosä¸‹å‘é…ç½®" class="headerlink" title="4. ä½¿ç”¨Nacosä¸‹å‘é…ç½®"></a>4. ä½¿ç”¨Nacosä¸‹å‘é…ç½®</h2><h3 id="4-1-Nacosæ¦‚è¿°"><a href="#4-1-Nacosæ¦‚è¿°" class="headerlink" title="4.1 Nacosæ¦‚è¿°"></a>4.1 Nacosæ¦‚è¿°</h3><p>   Naocsç”±é˜¿é‡Œå¼€æºï¼ŒNacos è‡´åŠ›äºå¸®åŠ©æ‚¨å‘ç°ã€é…ç½®å’Œç®¡ç†å¾®æœåŠ¡ã€‚Nacos æä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚<br>   Nacos å¸®åŠ©æ‚¨æ›´æ•æ·å’Œå®¹æ˜“åœ°æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡å¹³å°ã€‚ Nacos æ˜¯æ„å»ºä»¥â€œæœåŠ¡â€ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ (ä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼) çš„æœåŠ¡åŸºç¡€è®¾æ–½ã€‚githubåœ°å€:<a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener">https://github.com/alibaba/nacos</a></p><blockquote><p>æ›´å¤šNacosçš„ä»‹ç»ï¼Œè¯·è®¿é—®å®˜æ–¹ç½‘ç«™:<a href="https://nacos.io/" target="_blank" rel="noopener">https://nacos.io/</a></p></blockquote><h3 id="4-2-åœ¨IDEä¸­å¯åŠ¨-Nacos"><a href="#4-2-åœ¨IDEä¸­å¯åŠ¨-Nacos" class="headerlink" title="4.2 åœ¨IDEä¸­å¯åŠ¨ Nacos"></a>4.2 åœ¨IDEä¸­å¯åŠ¨ Nacos</h3><p>è®¿é—®<a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener">https://github.com/alibaba/nacos</a> ,ä½¿ç”¨Gitå…‹éš†Nacosä»£ç ï¼Œç›´æ¥å¯¼å…¥åˆ°IDEAä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºè®¾ç½®å¯åŠ¨å‚æ•°ï¼Œç›´æ¥å¯åŠ¨ã€‚</p><p><img src="/images/mw/nacos/nacos0.jpg" alt=""></p><blockquote><p>ä»IDEä¸­å¯åŠ¨Nacosæ˜¯æˆ‘æ¯”è¾ƒæ¨èçš„æ–¹å¼ï¼Œå› ä¸ºå¯ä»¥éšæ—¶Debug Nacosä»»ä½•ä»£ç ï¼Œå…¶å®ƒå¯åŠ¨æ–¹å¼è¯·å‚è€ƒå®˜ç½‘ã€‚</p></blockquote><h2 id="5-æµ‹è¯•"><a href="#5-æµ‹è¯•" class="headerlink" title="5.æµ‹è¯•"></a>5.æµ‹è¯•</h2><h3 id="5-1-Nacosä¸­ä¸‹å‘Spring-Cloud-Gatewayçš„è·¯ç”±é…ç½®"><a href="#5-1-Nacosä¸­ä¸‹å‘Spring-Cloud-Gatewayçš„è·¯ç”±é…ç½®" class="headerlink" title="5.1  Nacosä¸­ä¸‹å‘Spring Cloud Gatewayçš„è·¯ç”±é…ç½®"></a>5.1  Nacosä¸­ä¸‹å‘Spring Cloud Gatewayçš„è·¯ç”±é…ç½®</h3><ul><li>1.æ‰“å¼€æµè§ˆå™¨è®¿é—®URL:<a href="http://localhost:8848/nacos/index.html" target="_blank" rel="noopener">http://localhost:8848/nacos/index.html</a> ,Nacosçš„ç®¡æ§å¹³å°å¦‚ä¸‹æ‰€ç¤º:</li></ul><p><img src="/images/mw/nacos/nacos1.jpg" alt=""></p><ul><li>2.åœ¨Nacosçš„é…ç½®åˆ—è¡¨ç‚¹å‡»<code>+</code>æŒ‰é’®ï¼Œä¸‹å‘Spring Cloud Gatewayçš„è·¯ç”±é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤º:</li></ul><p><img src="/images/mw/nacos/nacos2.jpg" alt=""></p><hr><p>ç”¨äºæµ‹è¯•çš„ç¤ºä¾‹æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"filters"</span>: [],</span><br><span class="line"><span class="attr">"id"</span>: <span class="string">"jd_route"</span>,</span><br><span class="line"><span class="attr">"order"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">"predicates"</span>: [&#123;</span><br><span class="line"><span class="attr">"args"</span>: &#123;</span><br><span class="line"><span class="attr">"pattern"</span>: <span class="string">"/jd"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"Path"</span></span><br><span class="line">&#125;],</span><br><span class="line"><span class="attr">"uri"</span>: <span class="string">"http://www.jd.com"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/mw/nacos/nacos3.jpg" alt=""><br><img src="/images/mw/nacos/nacos4.jpg" alt=""></p><h3 id="5-2-å¯åŠ¨sc-gateway-server"><a href="#5-2-å¯åŠ¨sc-gateway-server" class="headerlink" title="5.2 å¯åŠ¨sc-gateway-server"></a>5.2 å¯åŠ¨sc-gateway-server</h3><ul><li>1.Debugå¯åŠ¨sc-gateway-server,è°ƒè¯•æˆªå›¾å¦‚ä¸‹æ‰€ç¤º:</li></ul><p><img src="/images/mw/nacos/nacos5.jpg" alt=""></p><ul><li>2.é€šè¿‡Spring Cloud gatewayçš„ç«¯ç‚¹ï¼ŒæŸ¥çœ‹è·¯ç”±ä¿¡æ¯</li></ul><p><img src="/images/mw/nacos/nacos6.jpg" alt=""></p><ul><li>3.é€šè¿‡è®¿é—®<a href="http://localhost:8080/jd" target="_blank" rel="noopener">http://localhost:8080/jd</a> ,å¯ä»¥è½¬å‘åˆ°äº¬ä¸œå•†åŸä¸»é¡µ</li></ul><h3 id="5-3-æ›´æ–°è·¯ç”±é…ç½®"><a href="#5-3-æ›´æ–°è·¯ç”±é…ç½®" class="headerlink" title="5.3 æ›´æ–°è·¯ç”±é…ç½®"></a>5.3 æ›´æ–°è·¯ç”±é…ç½®</h3><ul><li>1.é€šè¿‡Nacosä¸‹å‘é…ç½®ï¼Œä¿®æ”¹Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±è§„åˆ™</li></ul><p><img src="/images/mw/nacos/nacos7.jpg" alt=""></p><ul><li>2.æŸ¥çœ‹è®¿é—®Spring Cloud gatewayçš„ç«¯ç‚¹é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°åŠ¨æ€è·¯ç”±ä¿®æ”¹å¦‚ä¸‹:</li></ul><p><img src="/images/mw/nacos/nacos8.jpg" alt=""></p><ul><li>3.é€šè¿‡è®¿é—®<a href="http://localhost:8080/jd" target="_blank" rel="noopener">http://localhost:8080/jd</a> ,å¯ä»¥è½¬å‘åˆ°ç™¾åº¦ç›¸å…³é¡µé¢</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬æ–‡ä¸»è¦ä»‹ç»é€šè¿‡Nacosä¸‹å‘è·¯ç”±é…ç½®å®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-å‰è¨€&quot;&gt;&lt;a href=&quot;#1-å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;1.å‰è¨€&quot;&gt;&lt;/a&gt;1.å‰è¨€&lt;/h2&gt;&lt;p&gt;   ç½‘å…³ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯è·¯ç”±é…ç½®å’Œè·¯ç”±è§„åˆ™ï¼Œè·¯ç”±é…ç½®æ˜¯æŒ‡é…ç½®æŸè¯·æ±‚è·¯å¾„è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°å€ã€‚è€Œè·¯ç”±è§„åˆ™æ˜¯æŒ‡åŒ¹é…åˆ°è·¯ç”±é…ç½®ä¹‹åï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè½¬å‘å¤„ç†ã€‚&lt;br&gt;   Spring Cloud Gatewayä½œä¸ºæ‰€æœ‰è¯·æ±‚æµé‡çš„å…¥å£ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†ä¿è¯é«˜å¯é å’Œé«˜å¯ç”¨ï¼Œå°½é‡é¿å…é‡å¯,éœ€è¦å®ç°Spring Cloud GatewayåŠ¨æ€è·¯ç”±é…ç½®ã€‚å‰é¢ç« èŠ‚ä»‹ç»äº†Spring Cloud Gatewayæä¾›çš„ä¸¤ç§æ–¹æ³•å»é…ç½®è·¯ç”±è§„åˆ™ï¼Œä½†éƒ½æ˜¯åœ¨Spring Cloud Gatewayå¯åŠ¨æ—¶å€™ï¼Œå°±å°†è·¯ç”±é…ç½®å’Œè§„åˆ™åŠ è½½åˆ°å†…å­˜é‡Œï¼Œæ— æ³•åšåˆ°ä¸é‡å¯ç½‘å…³å°±å¯ä»¥åŠ¨æ€çš„å¯¹åº”è·¯ç”±çš„é…ç½®å’Œè§„åˆ™è¿›è¡Œå¢åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ã€‚æœ¬æ–‡æ˜¯åŸºäº&lt;a href=&quot;http://xujin.org/sc/gw/gw09/&quot;&gt;Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±å®ç°&lt;/a&gt;&lt;br&gt;åŸºç¡€ä¹‹ä¸Šç¼–å†™ï¼Œé€šè¿‡Nacosé…ç½®æœåŠ¡ä¸‹å‘è·¯ç”±é…ç½®å®ç°åŠ¨æ€è·¯ç”±ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±å®ç°</title>
    <link href="http://xujin.org/sc/gw/gw09/"/>
    <id>http://xujin.org/sc/gw/gw09/</id>
    <published>2018-11-03T06:00:00.000Z</published>
    <updated>2019-01-12T03:33:39.419Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬æ–‡ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±çš„ç®€å•å®ç°æ–¹å¼ã€‚</p><h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1.å‰è¨€"></a>1.å‰è¨€</h2><p>   ç½‘å…³ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯è·¯ç”±é…ç½®å’Œè·¯ç”±è§„åˆ™ï¼Œè·¯ç”±é…ç½®æ˜¯æŒ‡é…ç½®æŸè¯·æ±‚è·¯å¾„è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°å€ã€‚è€Œè·¯ç”±è§„åˆ™æ˜¯æŒ‡åŒ¹é…åˆ°è·¯ç”±é…ç½®ä¹‹åï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè½¬å‘å¤„ç†ã€‚<br>   Spring Cloud Gatewayä½œä¸ºæ‰€æœ‰è¯·æ±‚æµé‡çš„å…¥å£ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†ä¿è¯é«˜å¯é å’Œé«˜å¯ç”¨ï¼Œå°½é‡é¿å…é‡å¯,éœ€è¦å®ç°Spring Cloud GatewayåŠ¨æ€è·¯ç”±é…ç½®ã€‚å‰é¢ç« èŠ‚ä»‹ç»äº†Spring Cloud Gatewayæä¾›çš„ä¸¤ç§æ–¹æ³•å»é…ç½®è·¯ç”±è§„åˆ™ï¼Œä½†éƒ½æ˜¯åœ¨Spring Cloud Gatewayå¯åŠ¨æ—¶å€™ï¼Œå°±å°†è·¯ç”±é…ç½®å’Œè§„åˆ™åŠ è½½åˆ°å†…å­˜é‡Œï¼Œæ— æ³•åšåˆ°ä¸é‡å¯ç½‘å…³å°±å¯ä»¥åŠ¨æ€çš„å¯¹åº”è·¯ç”±çš„é…ç½®å’Œè§„åˆ™è¿›è¡Œå¢åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ã€‚<code>æœ¬ç¯‡æ–‡ç« ç®€å•ä»‹ç»å¦‚ä½•å®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚</code><br><a id="more"></a></p><h2 id="2-Spring-Cloud-Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°"><a href="#2-Spring-Cloud-Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°" class="headerlink" title="2. Spring Cloud Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°"></a>2. Spring Cloud Gatewayç®€å•çš„åŠ¨æ€è·¯ç”±å®ç°</h2><p>Spring Cloud Gatewayçš„å®˜æ–¹æ–‡æ¡£å¹¶æ²¡æœ‰è®²å¦‚ä½•åŠ¨æ€é…ç½®ï¼ŒæŸ¥çœ‹ Spring Cloud Gatewayçš„æºç ï¼Œå‘ç°<code>åœ¨org.springframework.cloud.gateway.actuate.GatewayControllerEndpoint</code>ç±»ä¸­æä¾›äº†åŠ¨æ€é…ç½®çš„Restæ¥å£ï¼Œä½†æ˜¯<code>éœ€è¦å¼€å¯Gatewayçš„ç«¯ç‚¹</code>ï¼Œè€Œä¸”æä¾›çš„åŠŸèƒ½ä¸æ˜¯å¾ˆå¼ºå¤§ã€‚é€šè¿‡å‚è€ƒå’ŒGatewayControllerEndpointç›¸å…³çš„ä»£ç ï¼Œå¯ä»¥è‡ªå·±ç¼–ç å®é™…åŠ¨æ€è·¯ç”±é…ç½®ã€‚<br>ä¸‹é¢é€šè¿‡æ¡ˆä¾‹çš„æ–¹å¼å»è®²è§£æ€ä¹ˆå®ç°Gatewayçš„åŠ¨æ€è·¯ç”±é…ç½®ã€‚æ¡ˆä¾‹å·¥ç¨‹å¦‚ch18-7-gatewayæ‰€ç¤ºã€‚</p><blockquote><p>ä»£ç åœ°å€:<a href="https://github.com/SpringCloud/spring-cloud-code/blob/master/ch18-7/ch18-7-gateway" target="_blank" rel="noopener">https://github.com/SpringCloud/spring-cloud-code/blob/master/ch18-7/ch18-7-gateway</a></p></blockquote><h2 id="3-ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°"><a href="#3-ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°" class="headerlink" title="3. ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°"></a>3. ç®€å•åŠ¨æ€è·¯ç”±çš„å®ç°</h2><h3 id="3-1-æ–°å»ºMavenå·¥ç¨‹ch18-7-gateway"><a href="#3-1-æ–°å»ºMavenå·¥ç¨‹ch18-7-gateway" class="headerlink" title="3.1 æ–°å»ºMavenå·¥ç¨‹ch18-7-gateway"></a>3.1 æ–°å»ºMavenå·¥ç¨‹ch18-7-gateway</h3><p>  é…ç½®ä¸»è¦çš„æ ¸å¿ƒä¾èµ–å¦‚ä»£ç æ¸…å•18-33æ‰€ç¤ºï¼š<br>  ä»£ç æ¸…å•: ch18-7/ch18-7-gateway/pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="3-2-æ ¹æ®Spring-Cloud-Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹"><a href="#3-2-æ ¹æ®Spring-Cloud-Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹" class="headerlink" title="3.2 æ ¹æ®Spring Cloud Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹"></a>3.2 æ ¹æ®Spring Cloud Gatewayçš„è·¯ç”±æ¨¡å‹å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹</h3><p> åˆ†åˆ«åˆ›å»ºGatewayRouteDefinition.java, GatewayPredicateDefinition.java, GatewayFilterDefinition.javaè¿™ä¸‰ä¸ªç±»ã€‚<br>(1) <code>åˆ›å»ºè·¯ç”±å®šä¹‰æ¨¡å‹</code>å¦‚ä¸‹ä»£ç æ¸…å•18-34æ‰€ç¤ºï¼š<br>ä»£ç æ¸…å• 18-34: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayRouteDefinition.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayRouteDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·¯ç”±çš„Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">//è·¯ç”±æ–­è¨€é›†åˆé…ç½®</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GatewayPredicateDefinition&gt; predicates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//è·¯ç”±è¿‡æ»¤å™¨é›†åˆé…ç½®</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GatewayFilterDefinition&gt; filters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//è·¯ç”±è§„åˆ™è½¬å‘çš„ç›®æ ‡uri</span></span><br><span class="line">    <span class="keyword">private</span> String uri;</span><br><span class="line">    <span class="comment">//è·¯ç”±æ‰§è¡Œçš„é¡ºåº</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//æ­¤å¤„çœç•¥getå’Œsetæ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(2)<code>åˆ›å»ºè¿‡æ»¤å™¨å®šä¹‰æ¨¡å‹</code>,ä»£ç å¦‚ä»£ç æ¸…å•18-35æ‰€ç¤ºï¼š<br>ä»£ç æ¸…å•18-35: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayFilterDefinition.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Filter Name</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//å¯¹åº”çš„è·¯ç”±è§„åˆ™</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ­¤å¤„çœç•¥Getå’ŒSetæ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(3)<code>è·¯ç”±æ–­è¨€å®šä¹‰æ¨¡å‹</code>ï¼Œä»£ç å¦‚ä»£ç æ¸…å•18-36æ‰€ç¤º:<br>ä»£ç æ¸…å•18-36: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayPredicateDefinition.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayPredicateDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ–­è¨€å¯¹åº”çš„Name</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//é…ç½®çš„æ–­è¨€è§„åˆ™</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ­¤å¤„çœç•¥Getå’ŒSetæ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»"><a href="#3-3-ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»" class="headerlink" title="3.3 ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»"></a>3.3 ç¼–å†™åŠ¨æ€è·¯ç”±å®ç°ç±»</h3><p>ç¼–å†™DynamicRouteServiceImplå¹¶å®ç°ApplicationEventPublisherAwareæ¥å£ï¼Œä»£ç å¦‚ä»£ç æ¸…å•18-37æ‰€ç¤º: ch18-37/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/route/DynamicRouteServiceImpl.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImpl</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher publisher;</span><br><span class="line">    <span class="comment">//å¢åŠ è·¯ç”±</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</span><br><span class="line">        routeDefinitionWriter.save(Mono.just(definition)).subscribe();</span><br><span class="line">        <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ›´æ–°è·¯ç”±</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(definition.getId()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"update fail,not find route  routeId: "</span>+definition.getId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            routeDefinitionWriter.save(Mono.just(definition)).subscribe();</span><br><span class="line">            <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"update route  fail"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ é™¤è·¯ç”±</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(String id) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(id))</span><br><span class="line">                .then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build())))</span><br><span class="line">                .onErrorResume(t -&gt; t <span class="keyword">instanceof</span> NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.publisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-ç¼–å†™Restæ¥å£"><a href="#3-4-ç¼–å†™Restæ¥å£" class="headerlink" title="3.4 ç¼–å†™Restæ¥å£"></a>3.4 ç¼–å†™Restæ¥å£</h3><p>ç¼–å†™RouteControllerç±»çš„æä¾›Restæ¥å£ï¼Œç”¨äºåŠ¨æ€è·¯ç”±é…ç½®ã€‚ä»£ç å¦‚ä»£ç æ¸…å•18-38æ‰€ç¤º:<br>ä»£ç æ¸…å• 18-38: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/controller/RouteController.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/route"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DynamicRouteServiceImpl dynamicRouteService;</span><br><span class="line">    <span class="comment">//å¢åŠ è·¯ç”±</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(@RequestBody GatewayRouteDefinition gwdefinition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            RouteDefinition definition = assembleRouteDefinition(gwdefinition);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.add(definition);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"succss"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ é™¤è·¯ç”±</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(<span class="string">"/routes/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(<span class="meta">@PathVariable</span> String id) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ›´æ–°è·¯ç”±</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(@RequestBody GatewayRouteDefinition gwdefinition)</span> </span>&#123;</span><br><span class="line">        RouteDefinition definition = assembleRouteDefinition(gwdefinition);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.update(definition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5-é…ç½®application-ymlæ–‡ä»¶"><a href="#3-5-é…ç½®application-ymlæ–‡ä»¶" class="headerlink" title="3.5 é…ç½®application.ymlæ–‡ä»¶"></a>3.5 é…ç½®application.ymlæ–‡ä»¶</h3><p>åœ¨application.ymlæ–‡ä»¶é…ç½®åº”ç”¨çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶å¼€å¯Spring Cloud Gatewayå¯¹å¤–æä¾›çš„ç«¯ç‚¹Restæ¥å£ã€‚ä»£ç å¦‚ä»£ç æ¸…å•18-39æ‰€ç¤º:<br>ä»£ç æ¸…å• 18-39: ch18-7/ch18-7-gateway/src/main/resources/application.yml<br>é…ç½®è¾“å‡ºæ—¥å¿—å¦‚ä¸‹æ‰€ç¤º:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é…ç½®è¾“å‡ºæ—¥å¿—</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">TRACE</span></span><br><span class="line">    <span class="string">org.springframework.http.server.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">org.springframework.web.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">reactor.ipc.netty:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="comment">#å¼€å¯ç«¯ç‚¹</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  security:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><h3 id="3-6-å¯åŠ¨ch18-7-gatewayåº”ç”¨æµ‹è¯•"><a href="#3-6-å¯åŠ¨ch18-7-gatewayåº”ç”¨æµ‹è¯•" class="headerlink" title="3.6 å¯åŠ¨ch18-7-gatewayåº”ç”¨æµ‹è¯•"></a>3.6 å¯åŠ¨ch18-7-gatewayåº”ç”¨æµ‹è¯•</h3><p>(1) å¯åŠ¨ch18-7-gatewayåº”ç”¨ä¹‹åï¼Œç”±äºå¼€å¯äº†ç«¯ç‚¹ï¼Œé¦–å…ˆæ‰“å¼€æµè§ˆå™¨è®¿é—®ç«¯ç‚¹URL:<br><a href="http://localhost:8080/actuator/gateway/routes" target="_blank" rel="noopener">http://localhost:8080/actuator/gateway/routes</a>  ,æŸ¥çœ‹è·¯ç”±ä¿¡æ¯è¿”å›ä¸ºç©ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img src="/images/sc-g-route/1.png" alt="ç©ºçš„è·¯ç”±ä¿¡æ¯"></p><p>(2)æ‰“å¼€PostManï¼Œè®¿é—®<a href="http://localhost:8080/route/add" target="_blank" rel="noopener">http://localhost:8080/route/add</a>, å‘èµ·Postè¯·æ±‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º,è¿”å›successè¯´æ˜å‘Gatewayå¢åŠ è·¯ç”±é…ç½®æˆåŠŸã€‚<br><img src="/images/sc-g-route/2.png" alt="åŠ¨æ€æ·»åŠ è·¯ç”±æˆåŠŸ"></p><p> ç„¶åå†æ‰“å¼€PostManè®¿é—®ç«¯ç‚¹URL:<a href="http://localhost:8080/actuator/gateway/routes" target="_blank" rel="noopener">http://localhost:8080/actuator/gateway/routes</a> ,<br> æŸ¥çœ‹è·¯ç”±ä¿¡æ¯è¿”å›å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æ·»åŠ çš„è·¯ç”±é…ç½®ã€‚<br><img src="/images/sc-g-route/3.png" alt="è·¯ç”±ç«¯ç‚¹è¿”å›ç»“æœ"></p><p>(3) æ‰“å¼€æµè§ˆå™¨è®¿é—®<a href="http://localhost:8080/jd" target="_blank" rel="noopener">http://localhost:8080/jd</a>, å¯ä»¥æ­£å¸¸è½¬å‘<a href="https://www.jd.com/å¯¹åº”çš„äº¬ä¸œå•†åŸé¦–é¡µã€‚" target="_blank" rel="noopener">https://www.jd.com/å¯¹åº”çš„äº¬ä¸œå•†åŸé¦–é¡µã€‚</a><br>(4) é€šè¿‡è®¿é—®<a href="http://localhost:8080/route/update" target="_blank" rel="noopener">http://localhost:8080/route/update</a>, å¯¹idä¸ºjd_routeçš„è·¯ç”±æ›´æ–°é…ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/images/sc-g-route/4.png" alt="æ›´æ–°è·¯ç”±é…ç½®"></p><p> ç„¶åå†è®¿é—®è·¯ç”±ç«¯ç‚¹URL,å‘ç°è·¯ç”±é…ç½®å·²ç»è¢«æ›´æ–°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:<br><img src="/images/sc-g-route/5.png" alt="æŸ¥çœ‹è·¯ç”±ç«¯ç‚¹"></p><p>ç„¶åé€šè¿‡æµè§ˆå™¨è®¿é—®<a href="http://localhost:8080/taobao" target="_blank" rel="noopener">http://localhost:8080/taobao</a> ,å¯ä»¥æˆåŠŸè½¬å‘åˆ°æ·˜å®ç½‘ã€‚<br>(5) é€šè¿‡è®¿é—®http: //localhost:8080/route/delete/jd_route,å…¶ä¸­çš„idä¸ºè·¯ç”±å¯¹åº”çš„idï¼Œåˆ é™¤è·¯ç”±ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º:<br><img src="/images/sc-g-route/6.png" alt="åˆ é™¤è·¯ç”±æˆåŠŸ"></p><h2 id="4-Spring-Cloud-Gatewayæ¨èæ–‡ç« "><a href="#4-Spring-Cloud-Gatewayæ¨èæ–‡ç« " class="headerlink" title="4.Spring Cloud Gatewayæ¨èæ–‡ç« "></a>4.Spring Cloud Gatewayæ¨èæ–‡ç« </h2><p><a href="http://xujin.org/sc/gw/gw08/">Spring Cloud Gatewayä¸­çš„æƒé‡è·¯ç”±</a><br><a href="http://xujin.org/sc/gw/gw07/">Spring Cloud Gatewayä¸­çš„GatewayFilterå’ŒGlobalFilter</a><br><a href="http://xujin.org/sc/gw/gw06/">Spring Cloud Gatewayåªæœ‰Preå’ŒPOSTä¸¤ç§ç±»å‹çš„Filter</a><br><a href="http://xujin.org/sc/gw/gw05/">Spring Cloud GatewayåŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™</a><br><a href="http://xujin.org/sc/gw/gw04/">Spring Cloud Gatewayçš„Beforeè·¯ç”±æ–­è¨€å·¥å‚</a><br><a href="http://xujin.org/sc/gw/gw03/">Spring Cloud Gatewayçš„Afterè·¯ç”±æ–­è¨€å·¥å‚</a><br><a href="http://xujin.org/sc/gw/gw02/">Spring Cloud Gatewayæ­ç§˜ä¹‹å¤„ç†è¯·æ±‚æµç¨‹</a><br><a href="http://xujin.org/sc/gw/gw-01/">Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹</a></p><h2 id="5-ã€Šé‡æ–°å®šä¹‰Spring-Cloudå®æˆ˜ã€‹ä¸­çš„Spring-Cloud-Gateway"><a href="#5-ã€Šé‡æ–°å®šä¹‰Spring-Cloudå®æˆ˜ã€‹ä¸­çš„Spring-Cloud-Gateway" class="headerlink" title="5.ã€Šé‡æ–°å®šä¹‰Spring Cloudå®æˆ˜ã€‹ä¸­çš„Spring Cloud Gateway"></a>5.ã€Šé‡æ–°å®šä¹‰Spring Cloudå®æˆ˜ã€‹ä¸­çš„Spring Cloud Gateway</h2><p>ç¬¬17ç« Spring Cloud Gatewayä¸Šç¯‡399<br>17.1 Spring Cloud Gatewayæ¦‚è¿°399<br>17.1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway399<br>17.1.2 Spring Cloud Gatewayçš„æ ¸å¿ƒæ¦‚å¿µ399<br>17.2 Spring Cloud Gatewayçš„å·¥ä½œåŸç†400<br>17.3 Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹401<br>17.4 Spring Cloud Gatewayçš„è·¯ç”±æ–­è¨€404<br>17.4.1 Afterè·¯ç”±æ–­è¨€å·¥å‚404<br>17.4.2 Beforeè·¯ç”±æ–­è¨€å·¥å‚406<br>17.4.3 Betweenè·¯ç”±æ–­è¨€å·¥å‚406<br>17.4.4 Cookieè·¯ç”±æ–­è¨€å·¥å‚407<br>17.4.5 Headerè·¯ç”±æ–­è¨€å·¥å‚408<br>17.4.6 Hostè·¯ç”±æ–­è¨€å·¥å‚410<br>17.4.7 Methodè·¯ç”±æ–­è¨€å·¥å‚411<br>17.4.8 Queryè·¯ç”±æ–­è¨€å·¥å‚411<br>17.4.9 RemoteAddrè·¯ç”±æ–­è¨€å·¥å‚412<br>17.5 Spring Cloud Gatewayçš„å†…ç½®Filter413<br>17.5.1 AddRequestHeaderè¿‡æ»¤å™¨å·¥å‚413<br>17.5.2 AddRequestParameterè¿‡æ»¤å™¨413<br>17.5.3 RewritePathè¿‡æ»¤å™¨414<br>17.5.4 AddResponseHeaderè¿‡æ»¤å™¨415<br>17.5.5 StripPrefixè¿‡æ»¤å™¨416<br>17.5.6 Retryè¿‡æ»¤å™¨417<br>17.5.7 Hystrixè¿‡æ»¤å™¨418<br>17.6 æœ¬ç« å°ç»“420<br>ç¬¬18ç«  Spring Cloud Gatewayä¸‹ç¯‡421<br>18.1 GatewayåŸºäºæœåŠ¡å‘ç°çš„è·¯ç”±è§„åˆ™421<br>18.1.1 Gatewayçš„æœåŠ¡å‘ç°è·¯ç”±æ¦‚è¿°421<br>18.1.2 æœåŠ¡å‘ç°çš„è·¯ç”±è§„åˆ™æ¡ˆä¾‹422<br>18.2 Gateway Filterå’ŒGlobal Filter425<br>18.2.1 Gateway Filterå’ŒGlobal Filteræ¦‚è¿°425<br>18.2.2 è‡ªå®šä¹‰Gateway Filteræ¡ˆä¾‹425<br>18.2.3 è‡ªå®šä¹‰Global Filteræ¡ˆä¾‹427<br>18.3 Spring Cloud Gatewayå®æˆ˜428<br>18.3.1 Spring Cloud Gatewayæƒé‡è·¯ç”±428<br>18.3.2 Spring Cloud Gatewayä¸­Httpsçš„ä½¿ç”¨æŠ€å·§431<br>18.3.3 Spring Cloud Gatewayé›†æˆSwagger436<br>18.3.4 Spring Cloud Gatewayé™æµ442<br>18.3.5 Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±450<br>18.4 Spring Cloud Gatewayæºç ç¯‡458<br>18.4.1 Spring Cloud Gatewayçš„å¤„ç†æµç¨‹458<br>18.4.2 Gatewayä¸­ServerWebExchangeæ„å»ºåˆ†æ459<br>18.4.3 DispatcherHandleræºç åˆ†æ460<br>18.4.4 RoutePredicateHandlerMappingæºç åˆ†æ461<br>18.4.5 FilteringWebHandleræºç åˆ†æ462<br>18.4.6 æ‰§è¡ŒFilteræºç åˆ†æ463<br>18.5 æœ¬ç« å°ç»“465</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ ch17-1</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-1-1-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-1-2-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-1.iml</span><br><span class="line">â”‚   â””â”€â”€ pom.xml</span><br><span class="line">â”œâ”€â”€ ch17-2</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-1-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-2-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-3-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-4-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-5-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-6-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-7-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-8-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-9-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2-service</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-2.iml</span><br><span class="line">â”‚   â””â”€â”€ pom.xml</span><br><span class="line">â”œâ”€â”€ ch17-3</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3-1-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3-2-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3-3-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3-4-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3-5-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3-6-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3-7-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3-service</span><br><span class="line">â”‚   â”œâ”€â”€ ch17-3.iml</span><br><span class="line">â”‚   â””â”€â”€ pom.xml</span><br><span class="line">â”œâ”€â”€ ch18-1</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-1-consumer</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-1-eureka</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-1-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-1-provider</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-1.iml</span><br><span class="line">â”‚   â””â”€â”€ pom.xml</span><br><span class="line">â”œâ”€â”€ ch18-2</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-2-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-2-provider</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-2.iml</span><br><span class="line">â”‚   â”œâ”€â”€ pom.xml</span><br><span class="line">â”‚   â””â”€â”€ reademe.txt</span><br><span class="line">â”œâ”€â”€ ch18-3</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-3-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-3-provider</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-3.iml</span><br><span class="line">â”‚   â””â”€â”€ pom.xml</span><br><span class="line">â”œâ”€â”€ ch18-4</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-4-eureka</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-4-gateway-https</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-4-service-a</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-4-service-b</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-4.iml</span><br><span class="line">â”‚   â”œâ”€â”€ pom.xml</span><br><span class="line">â”‚   â””â”€â”€ reademe.md</span><br><span class="line">â”œâ”€â”€ ch18-5</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-5-eureka</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-5-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-5-service</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-5.iml</span><br><span class="line">â”‚   â””â”€â”€ pom.xml</span><br><span class="line">â”œâ”€â”€ ch18-6</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-6-1-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-6-2-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-6-3-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-6-provider</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-6.iml</span><br><span class="line">â”‚   â””â”€â”€ pom.xml</span><br><span class="line">â”œâ”€â”€ ch18-7</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-7-gateway</span><br><span class="line">â”‚   â”œâ”€â”€ ch18-7.iml</span><br><span class="line">â”‚   â”œâ”€â”€ pom.xml</span><br><span class="line">â”‚   â””â”€â”€ readme.md</span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gatewayæ‰€æœ‰ç¤ºä¾‹ä»£ç åœ°å€:<a href="https://github.com/SpringCloud/spring-cloud-code" target="_blank" rel="noopener">https://github.com/SpringCloud/spring-cloud-code</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬æ–‡ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±çš„ç®€å•å®ç°æ–¹å¼ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-å‰è¨€&quot;&gt;&lt;a href=&quot;#1-å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;1.å‰è¨€&quot;&gt;&lt;/a&gt;1.å‰è¨€&lt;/h2&gt;&lt;p&gt;   ç½‘å…³ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œé‚£å°±æ˜¯è·¯ç”±é…ç½®å’Œè·¯ç”±è§„åˆ™ï¼Œè·¯ç”±é…ç½®æ˜¯æŒ‡é…ç½®æŸè¯·æ±‚è·¯å¾„è·¯ç”±åˆ°æŒ‡å®šçš„ç›®çš„åœ°å€ã€‚è€Œè·¯ç”±è§„åˆ™æ˜¯æŒ‡åŒ¹é…åˆ°è·¯ç”±é…ç½®ä¹‹åï¼Œå†æ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè½¬å‘å¤„ç†ã€‚&lt;br&gt;   Spring Cloud Gatewayä½œä¸ºæ‰€æœ‰è¯·æ±‚æµé‡çš„å…¥å£ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†ä¿è¯é«˜å¯é å’Œé«˜å¯ç”¨ï¼Œå°½é‡é¿å…é‡å¯,éœ€è¦å®ç°Spring Cloud GatewayåŠ¨æ€è·¯ç”±é…ç½®ã€‚å‰é¢ç« èŠ‚ä»‹ç»äº†Spring Cloud Gatewayæä¾›çš„ä¸¤ç§æ–¹æ³•å»é…ç½®è·¯ç”±è§„åˆ™ï¼Œä½†éƒ½æ˜¯åœ¨Spring Cloud Gatewayå¯åŠ¨æ—¶å€™ï¼Œå°±å°†è·¯ç”±é…ç½®å’Œè§„åˆ™åŠ è½½åˆ°å†…å­˜é‡Œï¼Œæ— æ³•åšåˆ°ä¸é‡å¯ç½‘å…³å°±å¯ä»¥åŠ¨æ€çš„å¯¹åº”è·¯ç”±çš„é…ç½®å’Œè§„åˆ™è¿›è¡Œå¢åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ã€‚&lt;code&gt;æœ¬ç¯‡æ–‡ç« ç®€å•ä»‹ç»å¦‚ä½•å®ç°Spring Cloud Gatewayçš„åŠ¨æ€è·¯ç”±ã€‚&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gatewayä¸­çš„æƒé‡è·¯ç”±</title>
    <link href="http://xujin.org/sc/gw/gw08/"/>
    <id>http://xujin.org/sc/gw/gw08/</id>
    <published>2018-06-09T06:00:00.000Z</published>
    <updated>2019-01-12T03:31:12.149Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬æ–‡ä¸»è¦é€šè¿‡è¿ç”¨Spring Cloud Gatewayçš„WeightRoutePredicateFactoryå¯¹URLè¿›è¡Œæƒé‡è·¯ç”±ã€‚</p><a id="more"></a><h2 id="1-æƒé‡è·¯ç”±"><a href="#1-æƒé‡è·¯ç”±" class="headerlink" title="1.æƒé‡è·¯ç”±"></a>1.æƒé‡è·¯ç”±</h2><h3 id="1-1-æƒé‡è·¯ç”±ä½¿ç”¨åœºæ™¯"><a href="#1-1-æƒé‡è·¯ç”±ä½¿ç”¨åœºæ™¯" class="headerlink" title="1.1 æƒé‡è·¯ç”±ä½¿ç”¨åœºæ™¯"></a>1.1 æƒé‡è·¯ç”±ä½¿ç”¨åœºæ™¯</h3><p>åœ¨å¼€å‘æˆ–è€…æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ–è€…çº¿ä¸Šå‘å¸ƒï¼Œçº¿ä¸ŠæœåŠ¡å¤šç‰ˆæœ¬æ§åˆ¶çš„æ—¶å€™ï¼Œéœ€è¦å¯¹æœåŠ¡æä¾›æƒé‡è·¯ç”±ï¼Œæœ€å¸¸è§çš„ä½¿ç”¨å°±æ˜¯ï¼Œä¸€ä¸ªæœåŠ¡æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬V1ï¼Œæ–°ç‰ˆæœ¬v2ã€‚åœ¨çº¿ä¸Šç°åº¦çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ç½‘å…³åŠ¨æ€å®æ—¶æ¨é€ï¼Œè·¯ç”±æƒé‡ä¿¡æ¯ã€‚æ¯”å¦‚95%çš„æµé‡èµ°æœåŠ¡v1ç‰ˆæœ¬ï¼Œ5%çš„æµé‡èµ°æœåŠ¡v2ç‰ˆæœ¬ã€‚</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/ce44017f07ce3a1b1d30e87995227ef4.jpg?Expires=1843884992&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=DBIQ%2BF%2BgIkpjik7x0CmmfaSrglU%3D" alt=""></p><blockquote><p>issue: The Spring Cloud Gateway issue of Allow Rolling Deployments <a href="https://github.com/spring-cloud/spring-cloud-gateway/issues/67" target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-gateway/issues/67</a></p></blockquote><h3 id="1-2-Spring-Cloud-Gatewayæƒé‡è·¯ç”±åŸç†"><a href="#1-2-Spring-Cloud-Gatewayæƒé‡è·¯ç”±åŸç†" class="headerlink" title="1.2 Spring Cloud Gatewayæƒé‡è·¯ç”±åŸç†"></a>1.2 Spring Cloud Gatewayæƒé‡è·¯ç”±åŸç†</h3><p>Spring Cloud Gatewayä¸­æä¾›äº†<code>org.springframework.cloud.gateway.handler.predicate.WeightRoutePredicateFactory</code>å»å®ç°æ ¹æ®åˆ†ç»„è®¾ç½®æƒé‡è¿›è¡Œè·¯ç”±ï¼Œå› æ­¤ä½¿ç”¨èµ·æ¥ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæœ‰å…´è¶£çš„å¯ä»¥debugé˜…è¯»æºç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeightRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">WeightConfig</span>&gt; <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(WeightRoutePredicateFactory.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_KEY = WeightConfig.CONFIG_PREFIX + <span class="string">".group"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEIGHT_KEY = WeightConfig.CONFIG_PREFIX + <span class="string">".weight"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ApplicationEventPublisher publisher;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WeightRoutePredicateFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(WeightConfig.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher publisher)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.publisher = publisher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Arrays.asList(GROUP_KEY, WEIGHT_KEY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">shortcutFieldPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> WeightConfig.CONFIG_PREFIX;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeApply</span><span class="params">(WeightConfig config)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (publisher != <span class="keyword">null</span>) &#123;</span><br><span class="line">publisher.publishEvent(<span class="keyword">new</span> WeightDefinedEvent(<span class="keyword">this</span>, config));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(WeightConfig config)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> exchange -&gt; &#123;</span><br><span class="line">Map&lt;String, String&gt; weights = exchange.getAttributeOrDefault(WEIGHT_ATTR,</span><br><span class="line">Collections.emptyMap());</span><br><span class="line"></span><br><span class="line">String routeId = exchange.getAttribute(GATEWAY_PREDICATE_ROUTE_ATTR);</span><br><span class="line"></span><br><span class="line"><span class="comment">// all calculations and comparison against random num happened in</span></span><br><span class="line"><span class="comment">// WeightCalculatorWebFilter</span></span><br><span class="line">String group = config.getGroup();</span><br><span class="line"><span class="keyword">if</span> (weights.containsKey(group)) &#123;</span><br><span class="line"></span><br><span class="line">String chosenRoute = weights.get(group);</span><br><span class="line"><span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">log.trace(<span class="string">"in group weight: "</span>+ group + <span class="string">", current route: "</span> + routeId +<span class="string">", chosen route: "</span> + chosenRoute);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> routeId.equals(chosenRoute);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-Spring-Cloud-Gatewayä¸­çš„æƒé‡è·¯ç”±æ¡ˆä¾‹"><a href="#2-Spring-Cloud-Gatewayä¸­çš„æƒé‡è·¯ç”±æ¡ˆä¾‹" class="headerlink" title="2.Spring Cloud Gatewayä¸­çš„æƒé‡è·¯ç”±æ¡ˆä¾‹"></a>2.Spring Cloud Gatewayä¸­çš„æƒé‡è·¯ç”±æ¡ˆä¾‹</h2><h3 id="2-1-æ¡ˆä¾‹ä»£ç åœ°å€"><a href="#2-1-æ¡ˆä¾‹ä»£ç åœ°å€" class="headerlink" title="2.1 æ¡ˆä¾‹ä»£ç åœ°å€"></a>2.1 æ¡ˆä¾‹ä»£ç åœ°å€</h3><p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch4" target="_blank" rel="noopener">https://github.com/SoftwareKing/sc-gateway/tree/master/ch4</a></p><h3 id="2-2-Spring-Cloud-Gateway-Serverè¯´æ˜"><a href="#2-2-Spring-Cloud-Gateway-Serverè¯´æ˜" class="headerlink" title="2.2 Spring Cloud Gateway Serverè¯´æ˜"></a>2.2 Spring Cloud Gateway Serverè¯´æ˜</h3><p>Spring Cloud Gateway will dispatch 95% of the requests to version 1 and 5% of the traffic to version 2 of a specified service, as shown by the following figure.</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/f8e439776d6bbff94993fafdfc02b98c.png?Expires=1843885017&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=a8ZhI5O5y7Gs7TP4eusGOT7qdoE%3D" alt=""></p><p>æˆ‘ä»¬é€šè¿‡åœ¨Spring Cloud Gatewayä¸­ä¼šé…ç½®ä¸åŒçš„æƒé‡ä¿¡æ¯åˆ°ä¸åŒURLä¸Šï¼ŒSpring Cloud Gatewayä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„è·¯ç”±æƒé‡ä¿¡æ¯ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„æºæœåŠ¡ç»„ï¼Œæƒé‡ä¿¡æ¯å¦‚ch4/ch4-gatewayä¸­çš„application.ymlæ‰€ç¤ºï¼Œä¸»è¦é…ç½®ä¿¡æ¯å¦‚ä¸‹ã€‚</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">ch4-gateway</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">service1_v1</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:8081/v1</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/test</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Weight=service1,</span> <span class="number">95</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">service1_v2</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:8081/v2</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/test</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Weight=service1,</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><blockquote><p>Weight=service1, 95ï¼ŒWeight=service1, 5å°±æ˜¯è·¯ç”±çš„æƒé‡ä¿¡æ¯ã€‚</p></blockquote><h3 id="2-3-æºæœåŠ¡"><a href="#2-3-æºæœåŠ¡" class="headerlink" title="2.3 æºæœåŠ¡"></a>2.3 æºæœåŠ¡</h3><p>æºæœåŠ¡åœ¨æœ¬æ¡ˆä¾‹ä¸­æºæœåŠ¡å¦‚ch4-service-provideræ‰€ç¤ºï¼Œä¸»è¦ææä¾›Gateway Serveræƒé‡è·¯ç”±å¯¹åº”çš„åç«¯æºæœåŠ¡ã€‚å› ä¸ºæ¯”è¾ƒç®€å•å› æ­¤ä¸åšè¯¦ç»†è¯´æ˜ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/v1"</span>, produces = <span class="string">"text/plain;charset=UTF-8"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">v1</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Mono.just(<span class="string">"v1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/v2"</span>, produces = <span class="string">"text/plain;charset=UTF-8"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">v2</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Mono.just(<span class="string">"v2"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-æµ‹è¯•"><a href="#2-4-æµ‹è¯•" class="headerlink" title="2.4 æµ‹è¯•"></a>2.4 æµ‹è¯•</h3><p>åˆ†åˆ«å¯åŠ¨ch4-gatewayï¼Œch4-service-providerè¿›è¡Œè®¿é—®:<a href="http://localhost:8080/test" target="_blank" rel="noopener">http://localhost:8080/test</a> æµ‹è¯•,å‘ç°ä¼šæ ¹æ®æ‰€è®¾æƒé‡è¿›è¡Œè·¯ç”±ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬æ–‡ä¸»è¦é€šè¿‡è¿ç”¨Spring Cloud Gatewayçš„WeightRoutePredicateFactoryå¯¹URLè¿›è¡Œæƒé‡è·¯ç”±ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gatewayä¸­çš„GatewayFilterå’ŒGlobalFilter</title>
    <link href="http://xujin.org/sc/gw/gw07/"/>
    <id>http://xujin.org/sc/gw/gw07/</id>
    <published>2018-05-26T06:00:00.000Z</published>
    <updated>2019-01-12T03:30:42.775Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ä»€ä¹ˆæ˜¯GatewayFilterå’ŒGlobalFilterï¼Œä»¥åŠåŒºåˆ«å’Œè”ç³»ã€‚ç„¶åä»‹ç»å¦‚ä½•åœ¨Spring Cloud Gatewayä¸­è‡ªå®šä¹‰ä½¿ç”¨GatewayFilterå’ŒGlobalFilterã€‚</p><a id="more"></a><h2 id="1-Spring-Cloud-gatewayçš„Filter"><a href="#1-Spring-Cloud-gatewayçš„Filter" class="headerlink" title="1. Spring Cloud gatewayçš„Filter"></a>1. Spring Cloud gatewayçš„Filter</h2><p>Spring Cloud gatewayä¸­çš„Filterä»æ¥å£å®ç°ä¸Šåˆ†ä¸ºä¸¤ç§ä¸€ç§æ˜¯GatewayFilterï¼Œå¦å¤–ä¸€ç§æ˜¯GlobalFilterã€‚</p><h2 id="1-1-GatewayFilterä¸GlobalFilterçš„åŒºåˆ«"><a href="#1-1-GatewayFilterä¸GlobalFilterçš„åŒºåˆ«" class="headerlink" title="1.1 GatewayFilterä¸GlobalFilterçš„åŒºåˆ«"></a>1.1 GatewayFilterä¸GlobalFilterçš„åŒºåˆ«</h2><p>åŒºåˆ«ç”¨è‹±è¯­å¯ä»¥æ€»ç»“å¦‚ä¸‹:<br>At a high level global filters are applied to all routes, while a gateway filter will be applied to an individual route(s)</p><blockquote><p>åœ¨ä¸€ä¸ªé«˜çš„è§’åº¦æ¥çœ‹ï¼ŒGlobal filtersä¼šè¢«åº”ç”¨åˆ°æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œè€ŒGateway filterå°†åº”ç”¨åˆ°<code>å•ä¸ªè·¯ç”±</code>ä¸Šæˆ–è€…<code>ä¸€ä¸ªåˆ†ç»„çš„è·¯ç”±</code>ä¸Šã€‚åœ¨ä¸‹é¢çš„æ¡ˆä¾‹ä¸­å°†ä¼šè¿›è¡Œè¯´æ˜ã€‚</p></blockquote><h2 id="1-2-æœ¬æ–‡ä»£ç åœ°å€"><a href="#1-2-æœ¬æ–‡ä»£ç åœ°å€" class="headerlink" title="1.2 æœ¬æ–‡ä»£ç åœ°å€"></a>1.2 æœ¬æ–‡ä»£ç åœ°å€</h2><blockquote><p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch2" target="_blank" rel="noopener">https://github.com/SoftwareKing/sc-gateway/tree/master/ch2</a></p></blockquote><h2 id="2-GatewayFilterå’ŒGlobalFilter"><a href="#2-GatewayFilterå’ŒGlobalFilter" class="headerlink" title="2. GatewayFilterå’ŒGlobalFilter"></a>2. GatewayFilterå’ŒGlobalFilter</h2><h3 id="2-1-GatewayFilter"><a href="#2-1-GatewayFilter" class="headerlink" title="2.1 GatewayFilter"></a>2.1 GatewayFilter</h3><h4 id="2-1-1-ä»€ä¹ˆæ˜¯GatewayFilter"><a href="#2-1-1-ä»€ä¹ˆæ˜¯GatewayFilter" class="headerlink" title="2.1.1 ä»€ä¹ˆæ˜¯GatewayFilter"></a>2.1.1 ä»€ä¹ˆæ˜¯GatewayFilter</h4><p>Contract for interception-style, chained processing of Web requests that may be used to implement cross-cutting, application-agnostic requirements such<br> as security, timeouts, and others. Specific to a Gateway Copied from WebFilter</p><blockquote><p>GatewayFilteræ˜¯ä»WebFilterä¸­Copyè¿‡æ¥çš„ï¼Œç›¸å½“äºä¸€ä¸ªFilterè¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è®¿é—®çš„URLè¿‡æ»¤æ¨ªåˆ‡å¤„ç†ï¼Œåº”ç”¨åœºæ™¯æ¯”å¦‚è¶…æ—¶ï¼Œå®‰å…¨ç­‰ã€‚</p></blockquote><p>ä»Spring Cloud Gatewayçš„æºç ä¸­å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹å‡ºGatewayFilterçš„ä½¿ç”¨åœºæ™¯:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Contract for interception-style, chained processing of Web requests that may</span></span><br><span class="line"><span class="comment"> * be used to implement cross-cutting, application-agnostic requirements such</span></span><br><span class="line"><span class="comment"> * as security, timeouts, and others. Specific to a Gateway</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Copied from WebFilter</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 5.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GatewayFilter</span> <span class="keyword">extends</span> <span class="title">ShortcutConfigurable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">String NAME_KEY = <span class="string">"name"</span>;</span><br><span class="line">String VALUE_KEY = <span class="string">"value"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process the Web request and (optionally) delegate to the next</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> WebFilter&#125; through the given &#123;<span class="doctag">@link</span> GatewayFilterChain&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange the current server exchange</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chain provides a way to delegate to the next filter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request processing is complete</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>GatewayFilterå’ŒGlobalFilterä¸¤ä¸ªæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ä¸€æ ·éƒ½æ˜¯Mono<void> filter(ServerWebExchange exchange, GatewayFilterChain chain)ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯GatewayFilterç»§æ‰¿äº†ShortcutConfigurableï¼ŒGlobalFilteræ²¡æœ‰ä»»ä½•ç»§æ‰¿ã€‚</void></p></blockquote><h5 id="2-1-2-è‡ªå®šä¹‰GatewayFilter-Custom-GatewayFilter"><a href="#2-1-2-è‡ªå®šä¹‰GatewayFilter-Custom-GatewayFilter" class="headerlink" title="2.1.2 è‡ªå®šä¹‰GatewayFilter(Custom GatewayFilter)"></a>2.1.2 è‡ªå®šä¹‰GatewayFilter(Custom GatewayFilter)</h5><p>å¦‚org.xujin.sc.filter.CustomFilterä»£ç æ‰€ç¤ºï¼Œé€šè¿‡è‡ªå®šä¹‰GatewayFilterå¯¹è·¯ç”±è½¬å‘çš„å¤„ç†æ—¶é•¿ç»Ÿè®¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»Ÿè®¡æŸä¸ªæˆ–è€…æŸç§è·¯ç”±çš„çš„å¤„ç†æ—¶é•¿</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xujin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(GatewayFilter.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COUNT_Start_TIME = <span class="string">"countStartTime"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        exchange.getAttributes().put(COUNT_Start_TIME, System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(</span><br><span class="line">                Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    Long startTime = exchange.getAttribute(COUNT_Start_TIME);</span><br><span class="line">                    Long endTime=(System.currentTimeMillis() - startTime);</span><br><span class="line">                    <span class="keyword">if</span> (startTime != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        log.info(exchange.getRequest().getURI().getRawPath() + <span class="string">": "</span> + endTime + <span class="string">"ms"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-3-Gateway-Filterä¸RouteLocatorç»‘å®šä½¿ç”¨"><a href="#2-1-3-Gateway-Filterä¸RouteLocatorç»‘å®šä½¿ç”¨" class="headerlink" title="2.1.3 Gateway Filterä¸RouteLocatorç»‘å®šä½¿ç”¨"></a>2.1.3 Gateway Filterä¸RouteLocatorç»‘å®šä½¿ç”¨</h4><p>åœ¨org.xujin.sc.GatewayServerApplicationä¸­customerRouteLocatorå¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customerRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">                .route(r -&gt; r.path(<span class="string">"/test/prefix/**"</span>)</span><br><span class="line">                        .filters(f -&gt; f.stripPrefix(<span class="number">2</span>)</span><br><span class="line">                                .filter(<span class="keyword">new</span> CustomFilter())</span><br><span class="line">                                .addResponseHeader(<span class="string">"X-Response-test"</span>, <span class="string">"test"</span>))</span><br><span class="line">                        .uri(<span class="string">"lb://SC-CONSUMER"</span>)</span><br><span class="line">                        .order(<span class="number">0</span>)</span><br><span class="line">                        .id(<span class="string">"test_consumer_service"</span>)</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>r.path(â€œ/test/prefix/**â€)è¡¨ç¤ºè‡ªå®šä¹‰äº†è®¿é—®å‰ç¼€ï¼Œåœ¨çœŸæ­£çš„Gatewayè¿›è¡Œè·¯ç”±è½¬å‘çš„æ—¶å€™ï¼Œä¼šç”¨è¿‡f.stripPrefix(2)æŠŠå‰ç¼€å»æ‰ã€‚</p><blockquote><p>ä½¿ç”¨åœºæ™¯:å¯ä»¥æŠŠå¯¹å¤–æš´éœ²çš„URLé€šè¿‡åŠ å‰ç¼€åˆ†ç»„æ‰“æ ‡ã€‚</p></blockquote></li><li><p>filter(new CustomFilter()</p><blockquote><p>filter(new CustomFilter()ï¼Œè¡¨ç¤ºæŠŠè‡ªå®šä¹‰çš„FilteråŠ åˆ°Filteré“¾é‡Œé¢æ‰§è¡Œï¼Œæ³¨æ„ä¸€ç‚¹æ˜¯è‡ªå®šä¹‰GlobalFilterä¸éœ€è¦åŠ è¿›å»ã€‚</p></blockquote></li><li><p>uri(â€œlb://SC-CONSUMERâ€)</p><blockquote><p>uri(â€œlb://SC-CONSUMERâ€)è¡¨ç¤ºSpring Cloud Gatewayå¯¹spring.application.nameç­‰äºsc-consumeræºæœåŠ¡åº”ç”¨ä¸­çš„URLè¿›è¡Œåè®®é€‚é…è½¬å‘ã€‚</p></blockquote></li></ol><h4 id="2-1-4-æµ‹è¯•å¦‚ä¸‹"><a href="#2-1-4-æµ‹è¯•å¦‚ä¸‹" class="headerlink" title="2.1.4 æµ‹è¯•å¦‚ä¸‹:"></a>2.1.4 æµ‹è¯•å¦‚ä¸‹:</h4><p>1.è®¿é—®<a href="http://localhost:9000/SC-CONSUMER/hello/xujin" target="_blank" rel="noopener">http://localhost:9000/SC-CONSUMER/hello/xujin</a> èƒ½æ­£å¸¸è®¿é—®ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-27 09:58:07.905 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$337/1295338046@f2ff0c8, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$717/1168359877@1f74a2b, order=1&#125;]&#125;</span><br><span class="line">2018-05-27 09:58:07.905 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@f5bf288&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$717/1168359877@1f74a2b, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@26c77f54&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@4c38cd16&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2c1d57bc&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@6e9a0bea&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@7ddcb0dc&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@3e856100&#125;, order=2147483647&#125;]</span><br></pre></td></tr></table></figure><blockquote><p>ä»ä¸Šé¢çš„æ§åˆ¶å°æ‰“å°æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œæ²¡æœ‰æ‰“å°å‡ºè¯¥URLå¯¹åº”çš„è€—æ—¶ã€‚</p></blockquote><p>2.åŠ ä¸ŠURLå‰ç¼€/test/prefix/è®¿é—®ï¼Œæµ‹è¯•URLä¸º<br><a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin" target="_blank" rel="noopener">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-05-27 10:01:56.057 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/test/prefix/hello/testCustomFilter/xujin] to Route&#123;id='test_consumer_service', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$337/1295338046@6dbaa72e, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory$$Lambda$340/1149217113@41fb2078, order=0&#125;, org.xujin.sc.filter.CustomFilter@281885a3, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory$$Lambda$342/1099925775@4705cae6, order=0&#125;]&#125;</span><br><span class="line">2018-05-27 10:01:56.057 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@f5bf288&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory$$Lambda$340/1149217113@41fb2078, order=0&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory$$Lambda$342/1099925775@4705cae6, order=0&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@26c77f54&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@4c38cd16&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2c1d57bc&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@6e9a0bea&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@7ddcb0dc&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@3e856100&#125;, order=2147483647&#125;, org.xujin.sc.filter.CustomFilter@281885a3]</span><br><span class="line">2018-05-27 10:02:00.347  INFO 31658 --- [ctor-http-nio-8] o.s.cloud.gateway.filter.GatewayFilter   : /hello/testCustomFilter/xujin: 859ms</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚ä¸Šæ—¥å¿—å¯ä»¥çœ‹åˆ°/hello/testCustomFilter/xujin: 859msï¼ŒGatewayè½¬å‘çš„æ—¶å€™å»æ‰äº†å‰ç¼€ã€‚</p></blockquote><h3 id="2-2-GlobalFilter"><a href="#2-2-GlobalFilter" class="headerlink" title="2.2 GlobalFilter"></a>2.2 GlobalFilter</h3><h4 id="2-2-1-ä»€ä¹ˆæ˜¯GlobalFilter"><a href="#2-2-1-ä»€ä¹ˆæ˜¯GlobalFilter" class="headerlink" title="2.2.1 ä»€ä¹ˆæ˜¯GlobalFilter"></a>2.2.1 ä»€ä¹ˆæ˜¯GlobalFilter</h4><blockquote><p>The GlobalFilter interface has the same signature as GatewayFilter. These are special filters that are conditionally applied to all routes. (This interface and usage are subject to change in future milestones).</p></blockquote><p>Spring Cloud gatewayå®šä¹‰äº†GlobalFilterçš„æ¥å£è®©æˆ‘ä»¬å»è‡ªå®šä¹‰å®ç°è‡ªå·±çš„çš„GlobalFilterã€‚GlobalFilteræ˜¯ä¸€ä¸ªå…¨å±€çš„Filterï¼Œä½œç”¨äºæ‰€æœ‰çš„è·¯ç”±ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GlobalFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process the Web request and (optionally) delegate to the next</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> WebFilter&#125; through the given &#123;<span class="doctag">@link</span> GatewayFilterChain&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange the current server exchange</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chain provides a way to delegate to the next filter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request processing is complete</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨-Custom-GlobalFilter"><a href="#2-2-2-è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨-Custom-GlobalFilter" class="headerlink" title="2.2.2 è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨(Custom GlobalFilter)"></a>2.2.2 è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨(Custom GlobalFilter)</h4><p>åœ¨è¿™é‡Œç®€å•å®šä¹‰AuthSignatureFilterå®ç°<code>GlobalFilter</code>ï¼Œä½¿ç”¨åœºæ™¯å°±æ˜¯Gatewayå¯¹è¯·æ±‚çš„URLæ ¡éªŒæƒé™ï¼Œåˆ¤æ–­è¯·æ±‚çš„URLæ˜¯å¦æ˜¯åˆæ³•è¯·æ±‚ã€‚é€šè¿‡ä»ServerWebExchangeè·å–è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­authTokenå¯¹åº”çš„å€¼ï¼Œè¿›è¡Œåˆ¤nullå¤„ç†ï¼Œå…¶å®ƒçš„checké€»è¾‘å¯ä»¥è‡ªå®šå®šåˆ¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è°ƒç”¨é‰´æƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthSignatureFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        String token = exchange.getRequest().getQueryParams().getFirst(<span class="string">"authToken"</span>);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span> || token.isEmpty()) &#123;</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>GlobalFilterå†™å®Œäº†ï¼Œé‚£é—®é¢˜æ¥äº†ï¼Ÿå¦‚ä½•è®©å…¶åœ¨Gatewayä¸­è¿è¡Œç”Ÿæ•ˆï¼Œæœ‰ä¸¤ç§æ–¹å¼ä¸€ç§ç›´æ¥åŠ <code>@Component</code>æ³¨è§£ï¼Œå¦å¤–ä¸€ç§å¯ä»¥åœ¨ Spring Config ä¸­é…ç½®è¿™ä¸ª Beanå¦‚ä¸‹æ‰€ç¤º:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AuthSignatureFilter <span class="title">authSignatureFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> AuthSignatureFilter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>1.è®¿é—®<a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin" target="_blank" rel="noopener">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin</a> å¦‚ä¸‹æ‰€ç¤ºç”±äºauthTokenä¸ºç©º401è¿”å›.</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/91ce199f4af8f4bd9576aace65940253.jpeg?Expires=1842749245&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=Is0KT0QAVXkPS20EdSPvDqmlxmc%3D" alt=""></p><p>2.è®¿é—®<a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin?authToken=asdasdsddasadsadsadsdadsewew32rg" target="_blank" rel="noopener">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin?authToken=asdasdsddasadsadsadsdadsewew32rg</a></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/86509f882391c3a20d2f32778dd1c2e9.jpeg?Expires=1842749511&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=lAd7U0lj4WZ0HMWF9SpbfKJ4aR8%3D" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ä»€ä¹ˆæ˜¯GatewayFilterå’ŒGlobalFilterï¼Œä»¥åŠåŒºåˆ«å’Œè”ç³»ã€‚ç„¶åä»‹ç»å¦‚ä½•åœ¨Spring Cloud Gatewayä¸­è‡ªå®šä¹‰ä½¿ç”¨GatewayFilterå’ŒGlobalFilterã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud GatewayåŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™</title>
    <link href="http://xujin.org/sc/gw/gw05/"/>
    <id>http://xujin.org/sc/gw/gw05/</id>
    <published>2018-05-21T06:00:00.000Z</published>
    <updated>2019-01-12T03:35:27.669Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayçš„åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œä»ä¸­å¯ä»¥çœ‹å‡ºGatewayçš„è·¯ç”±è§„åˆ™:<a href="http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/*" target="_blank" rel="noopener">http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/*</a> å’Œ zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™<a href="http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/*å·®ä¸å¤šã€‚" target="_blank" rel="noopener">http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/*å·®ä¸å¤šã€‚</a></p><a id="more"></a><h2 id="1-Spring-Gatewayæ¦‚è¿°"><a href="#1-Spring-Gatewayæ¦‚è¿°" class="headerlink" title="1.Spring Gatewayæ¦‚è¿°"></a>1.Spring Gatewayæ¦‚è¿°</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯Spring-Cloud-Gateway"><a href="#1-1-ä»€ä¹ˆæ˜¯Spring-Cloud-Gateway" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway"></a>1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway</h3><p>   <code>Spring Cloud Gateway</code>æ˜¯Springå®˜æ–¹åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0å’ŒProject Reactorç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼ŒSpring Cloud Gatewayæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„ç»Ÿä¸€çš„APIè·¯ç”±ç®¡ç†æ–¹å¼ã€‚Spring Cloud Gatewayä½œä¸ºSpring Cloudç”Ÿæ€ç³»ä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£Netflix ZUULï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäºFilteré“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§/åŸ‹ç‚¹ï¼Œå’Œé™æµç­‰ã€‚</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/3f25fcd95769a54eb391931449d5298f.jpg?Expires=1841935182&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=F%2BSKuTDpXoj5xCXwIIJ4u8D1C2A%3D" alt=""></p><h3 id="1-2-Spring-Cloud-Gatewayçš„åŠŸèƒ½"><a href="#1-2-Spring-Cloud-Gatewayçš„åŠŸèƒ½" class="headerlink" title="1.2 Spring Cloud Gatewayçš„åŠŸèƒ½"></a>1.2 Spring Cloud Gatewayçš„åŠŸèƒ½</h3><p>Spring Cloud Gateway çš„ç‰¹å¾ï¼š</p><ul><li>åŸºäº Spring Framework 5ï¼ŒProject Reactor å’Œ Spring Boot 2.0<br>åŠ¨æ€è·¯ç”±</li><li>Predicates å’Œ Filters ä½œç”¨äºç‰¹å®šè·¯ç”±</li><li>é›†æˆ Hystrix æ–­è·¯å™¨</li><li>é›†æˆ Spring Cloud DiscoveryClient</li><li>æ˜“äºç¼–å†™çš„ Predicates å’Œ Filters</li><li>é™æµ</li><li>è·¯å¾„é‡å†™</li></ul><h2 id="2-Spring-Cloud-Gatewayçš„å·¥ç¨‹æµç¨‹"><a href="#2-Spring-Cloud-Gatewayçš„å·¥ç¨‹æµç¨‹" class="headerlink" title="2. Spring Cloud Gatewayçš„å·¥ç¨‹æµç¨‹"></a>2. Spring Cloud Gatewayçš„å·¥ç¨‹æµç¨‹</h2><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/22e4eccf2cbe09332678c04b8de98ebe.jpg?Expires=1841935407&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=NHcssduqPTQry7HCmudjphw0qC4%3D" alt=""></p><p>   å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚<br>è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰ï¼ˆâ€œpreâ€ï¼‰æˆ–ä¹‹åï¼ˆâ€œpostâ€ï¼‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p><h3 id="2-1-Preå’ŒPOSTä¸¤ç§ç±»å‹çš„è¿‡æ»¤å™¨"><a href="#2-1-Preå’ŒPOSTä¸¤ç§ç±»å‹çš„è¿‡æ»¤å™¨" class="headerlink" title="2.1 Preå’ŒPOSTä¸¤ç§ç±»å‹çš„è¿‡æ»¤å™¨"></a>2.1 Preå’ŒPOSTä¸¤ç§ç±»å‹çš„è¿‡æ»¤å™¨</h3><h2 id="3-åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™"><a href="#3-åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™" class="headerlink" title="3.åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™"></a>3.åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™</h2><h3 id="3-1-zuulå’Œgatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™"><a href="#3-1-zuulå’Œgatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™" class="headerlink" title="3.1 zuulå’Œgatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™"></a>3.1 zuulå’Œgatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™</h3><h4 id="3-1-1-zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™"><a href="#3-1-1-zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™" class="headerlink" title="3.1.1 zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™"></a>3.1.1 zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™</h4><p>è¯´æ˜é»˜è®¤æƒ…å†µä¸‹ï¼ŒZuulä¼šä»£ç†æ‰€æœ‰æ³¨å†Œåˆ°Eureka Serverçš„å¾®æœåŠ¡ï¼Œå¹¶ä¸”Zuulçš„è·¯ç”±è§„åˆ™å¦‚ä¸‹ï¼š<br>   <a href="http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/**" target="_blank" rel="noopener">http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/**</a> ä¼šè¢«è½¬å‘åˆ°serviceIdå¯¹åº”çš„å¾®æœåŠ¡ã€‚<br>   <a href="http://localhost:8040/sc-zuul-first-provider/sc/order/2" target="_blank" rel="noopener">http://localhost:8040/sc-zuul-first-provider/sc/order/2</a><br>   <img src="http://xujin.org/images/sc-study/sc-zuul-01-t1.png" alt="é»˜è®¤è·¯ç”±è§„åˆ™"></p><h4 id="3-1-2-gatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™"><a href="#3-1-2-gatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™" class="headerlink" title="3.1.2 gatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™"></a>3.1.2 gatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™</h4><p>ä¸‹é¢çš„æ¡ˆä¾‹ä¸­ä¼šæ¼”ç¤ºï¼š<a href="http://localhost:9000/SC-CONSUMER/hello/xujin" target="_blank" rel="noopener">http://localhost:9000/SC-CONSUMER/hello/xujin</a></p><blockquote><p><a href="http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/**ï¼Œå…¶ä¸­å¾®æœåŠ¡åº”ç”¨åé»˜è®¤å¤§å†™è®¿é—®ã€‚" target="_blank" rel="noopener">http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/**ï¼Œå…¶ä¸­å¾®æœåŠ¡åº”ç”¨åé»˜è®¤å¤§å†™è®¿é—®ã€‚</a></p></blockquote><h3 id="3-2-æ¡ˆä¾‹ç¤ºä¾‹ä»£ç "><a href="#3-2-æ¡ˆä¾‹ç¤ºä¾‹ä»£ç " class="headerlink" title="3.2  æ¡ˆä¾‹ç¤ºä¾‹ä»£ç "></a>3.2  æ¡ˆä¾‹ç¤ºä¾‹ä»£ç </h3><p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch1" target="_blank" rel="noopener">https://github.com/SoftwareKing/sc-gateway/tree/master/ch1</a></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/74473f8fa112dbf946452dd234be9783.jpeg?Expires=1841935730&OSSAccessKeyId=LTAI57F52hRuWq3h&Signature=8hk%2BcIs0lpEA3S01TQsu%2BVdome8%3D" width="450px" height="252px"></p><table><thead><tr><th>æ¨¡å—</th><th>è¯´æ˜</th><th>ç«¯å£</th></tr></thead><tbody><tr><td>ch1-sc-consumer</td><td>æœåŠ¡æ¶ˆè´¹è€…</td><td>8000</td></tr><tr><td>ch1-sc-eureka</td><td>Eureka Serveræ³¨å†Œä¸­å¿ƒ</td><td>8761</td></tr><tr><td>ch1-sc-gateway</td><td>Spring Cloud Gateway Sever</td><td>9000</td></tr><tr><td>ch1-sc-provider</td><td>æœåŠ¡æä¾›è€…</td><td>8001</td></tr></tbody></table><h4 id="3-2-1-ch1-sc-gatewayå·¥ç¨‹è¯´æ˜"><a href="#3-2-1-ch1-sc-gatewayå·¥ç¨‹è¯´æ˜" class="headerlink" title="3.2.1 ch1-sc-gatewayå·¥ç¨‹è¯´æ˜"></a>3.2.1 ch1-sc-gatewayå·¥ç¨‹è¯´æ˜</h4><h4 id="3-2-1-1-Mavenä¾èµ–"><a href="#3-2-1-1-Mavenä¾èµ–" class="headerlink" title="3.2.1.1  Mavenä¾èµ–"></a>3.2.1.1  Mavenä¾èµ–</h4><p>Spring Cloud Gateway severä¸»è¦çš„mavenä¾èµ–å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="3-2-1-2-ymlæ–‡ä»¶é…ç½®"><a href="#3-2-1-2-ymlæ–‡ä»¶é…ç½®" class="headerlink" title="3.2.1.2 ymlæ–‡ä»¶é…ç½®"></a>3.2.1.2 ymlæ–‡ä»¶é…ç½®</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-gateway-server</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        locator:</span></span><br><span class="line"><span class="attr">          enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><p>é…ç½®è¯´æ˜ï¼š</p><blockquote><p>spring.cloud.gateway.discovery.locator.enabledï¼šæ˜¯å¦ä¸æœåŠ¡å‘ç°ç»„ä»¶è¿›è¡Œç»“åˆï¼Œé€šè¿‡ serviceId è½¬å‘åˆ°å…·ä½“çš„æœåŠ¡å®ä¾‹ã€‚é»˜è®¤ä¸ºfalseï¼Œè®¾ä¸ºtrueä¾¿å¼€å¯é€šè¿‡æœåŠ¡ä¸­å¿ƒçš„è‡ªåŠ¨æ ¹æ® serviceId åˆ›å»ºè·¯ç”±çš„åŠŸèƒ½ã€‚</p></blockquote><hr><blockquote><p>ä¿®æ”¹spring cloud gateway serverç›‘å¬çš„ç«¯å£ä¸º9000</p></blockquote><hr><blockquote><p>eureka.client.service-url.defaultZone: <a href="http://localhost:8761/eureka/,æŒ‡å®šæ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼ŒSpring" target="_blank" rel="noopener">http://localhost:8761/eureka/,æŒ‡å®šæ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼ŒSpring</a> Cloud Gatewayä»æ³¨å†Œä¸­å¿ƒè·å–å·²ç»æ³¨å†Œçš„æœåŠ¡åˆ—è¡¨ã€‚</p></blockquote><hr><blockquote><p>logging.level.org.springframework.cloud.gateway: debug,å¼€å¯spring-Cloud-gatewayçš„æ—¥å¿—çº§åˆ«ä¸ºdebugï¼Œæ–¹ä¾¿debugè°ƒè¯•ã€‚</p></blockquote><h3 id="3-3-å¯åŠ¨æµ‹è¯•"><a href="#3-3-å¯åŠ¨æµ‹è¯•" class="headerlink" title="3.3 å¯åŠ¨æµ‹è¯•"></a>3.3 å¯åŠ¨æµ‹è¯•</h3><h4 id="3-3-1-é”™è¯¯çš„è·¯ç”±è§„åˆ™è®¿é—®"><a href="#3-3-1-é”™è¯¯çš„è·¯ç”±è§„åˆ™è®¿é—®" class="headerlink" title="3.3.1 é”™è¯¯çš„è·¯ç”±è§„åˆ™è®¿é—®"></a>3.3.1 é”™è¯¯çš„è·¯ç”±è§„åˆ™è®¿é—®</h4><p>è®¿é—®Spring Cloud Gatewayå¯¹åº”çš„serverï¼Œå½“è®¿é—®<a href="http://localhost:9000/sc-consumer/hello/xujinçš„æ—¶å€™ï¼ŒæŠ¥é”™å¦‚ä¸‹æ‰€ç¤ºï¼Œæ­£ç¡®çš„Spring" target="_blank" rel="noopener">http://localhost:9000/sc-consumer/hello/xujinçš„æ—¶å€™ï¼ŒæŠ¥é”™å¦‚ä¸‹æ‰€ç¤ºï¼Œæ­£ç¡®çš„Spring</a> Cloud Gatewayçš„é»˜è®¤è·¯ç”±è§„åˆ™:<code>http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/**</code></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/d98d829455d0f1a180eb1b4561c7d530.jpeg?Expires=1842311197&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=bIbKneLe1y%2B32zADPV6uQP4B2QY%3D" alt=""></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2018-05-18 01:10:49.742 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying &#123;pattern=/SC-CONSUMER/**&#125; to Path</span><br><span class="line">2018-05-18 01:10:49.743 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying filter &#123;regexp=/SC-CONSUMER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-18 01:10:49.743 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-18 01:10:49.744 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying &#123;pattern=/SC-PRODUCER/**&#125; to Path</span><br><span class="line">2018-05-18 01:10:49.744 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying filter &#123;regexp=/SC-PRODUCER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-18 01:10:49.745 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-PRODUCER</span><br><span class="line">2018-05-18 01:10:49.745 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying &#123;pattern=/SC-GATEWAY-SERVER/**&#125; to Path</span><br><span class="line">2018-05-18 01:10:49.747 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying filter &#123;regexp=/SC-GATEWAY-SERVER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-18 01:10:49.748 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-GATEWAY-SERVER</span><br><span class="line">2018-05-18 01:10:49.748 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-18 01:10:49.749 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$707/751096818@7f4c6373, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$709/672603106@293895d2, order=1&#125;]&#125;</span><br><span class="line">2018-05-18 01:10:49.749 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@5e85c21b&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$709/672603106@293895d2, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@38e83838&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@6ef2f7ad&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@41def031&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@4966bab1&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@22d477c2&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@39832280&#125;, order=2147483647&#125;]</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„logï¼Œçœ‹åˆ°è¿”å›äº† 404 é”™è¯¯ï¼Œè¿›ä¸€æ­¥å¯ä»¥çœ‹åˆ° Spring Cloud Gateway å·²ç»ä¸ºæˆ‘ä»¬çš„ provider å’Œ consumer è‡ªåŠ¨åˆ›å»ºäº†å¯¹åº”çš„è·¯ç”±è½¬å‘è§„åˆ™ï¼Œä½†æ˜¯è¿™é‡Œçš„ pattern/regexp é‡Œéƒ½æ˜¯å¤§å†™çš„ï¼Œä¸‹é¢æ¢æˆå¤§å†™çš„æµ‹è¯•ä¸€ä¸‹ã€‚</p><h4 id="3-3-2-Gatewayæ­£ç¡®çš„è·¯ç”±è§„åˆ™æµ‹è¯•"><a href="#3-3-2-Gatewayæ­£ç¡®çš„è·¯ç”±è§„åˆ™æµ‹è¯•" class="headerlink" title="3.3.2 Gatewayæ­£ç¡®çš„è·¯ç”±è§„åˆ™æµ‹è¯•"></a>3.3.2 Gatewayæ­£ç¡®çš„è·¯ç”±è§„åˆ™æµ‹è¯•</h4><p>è®¿é—®æ­£ç¡®çš„<a href="http://localhost:9000/SC-CONSUMER/hello/xujinï¼Œå¯ä»¥æˆåŠŸè®¿é—®ã€‚" target="_blank" rel="noopener">http://localhost:9000/SC-CONSUMER/hello/xujinï¼Œå¯ä»¥æˆåŠŸè®¿é—®ã€‚</a></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/42059405c29359bcca90c14e3e1f34ca.jpeg?Expires=1842311310&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=eEHIkLTtbPzvhXI2OhoK0TUXwtE%3D" alt=""></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/ff700908c44140ec692956f4f1b526cc.jpeg?Expires=1842311231&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=ZPi13%2BGvvb2eEIHEqRIkzL3mwKw%3D" alt=""></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2018-05-22 09:04:21.204 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying &#123;pattern=/SC-CONSUMER/**&#125; to Path</span><br><span class="line">2018-05-22 09:04:21.205 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying filter &#123;regexp=/SC-CONSUMER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-22 09:04:21.205 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-22 09:04:21.206 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying &#123;pattern=/SC-PRODUCER/**&#125; to Path</span><br><span class="line">2018-05-22 09:04:21.207 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying filter &#123;regexp=/SC-PRODUCER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-22 09:04:21.207 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-PRODUCER</span><br><span class="line">2018-05-22 09:04:21.208 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying &#123;pattern=/SC-GATEWAY-SERVER/**&#125; to Path</span><br><span class="line">2018-05-22 09:04:21.208 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying filter &#123;regexp=/SC-GATEWAY-SERVER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-GATEWAY-SERVER</span><br><span class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$706/57023854@24f1a91e, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$708/2036079541@cbb7393, order=1&#125;]&#125;</span><br><span class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@29a98d9f&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$708/2036079541@cbb7393, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@544e8149&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@55d58825&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2da3b078&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@1a96d94c&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@19a64eae&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@7fb66650&#125;, order=2147483647&#125;]</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼ŒSpring Cloud Gateway è‡ªåŠ¨çš„ä¸ºæˆ‘ä»¬çš„ consumer åˆ›å»ºäº†ä¸€ä¸ªè·¯ç”±ï¼Œç±»ä¼¼äºä¸‹è¾¹è¿™æ ·<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="attr">    - id:</span> <span class="string">CompositeDiscoveryClient_SC-CONSUMER</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">lb://SC-CONSUMER</span></span><br><span class="line"><span class="attr">      order:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      predicates:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">Path=/SC-CONSUMER/**</span></span><br><span class="line"><span class="attr">      filters:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">RewritePath=/SC-CONSUMER/(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure></p><blockquote><p>æ‰€ä»¥ä»zuulè¿ç§»åˆ°gatewayçš„æ—¶å€™ï¼ŒæœåŠ¡è·¯ç”±è§„åˆ™ä¸­çš„å¾®æœåŠ¡åº”ç”¨Idé»˜è®¤ä»å°å†™å˜ä¸ºå¤§å†™ã€‚</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayçš„åŸºäºæœåŠ¡å‘ç°çš„é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œä»ä¸­å¯ä»¥çœ‹å‡ºGatewayçš„è·¯ç”±è§„åˆ™:&lt;a href=&quot;http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/*&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://Gateway_HOST:Gateway_PORT/å¤§å†™çš„serviceId/*&lt;/a&gt; å’Œ zuulçš„é»˜è®¤è·¯ç”±è§„åˆ™&lt;a href=&quot;http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/*å·®ä¸å¤šã€‚&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://ZUUL_HOST:ZUUL_PORT/å¾®æœåŠ¡åœ¨Eurekaä¸Šçš„serviceId/*å·®ä¸å¤šã€‚&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gatewayåªæœ‰Preå’ŒPOSTä¸¤ç§ç±»å‹çš„Filter</title>
    <link href="http://xujin.org/sc/gw/gw06/"/>
    <id>http://xujin.org/sc/gw/gw06/</id>
    <published>2018-05-21T06:00:00.000Z</published>
    <updated>2019-01-12T03:30:08.378Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:Spring Cloud Gatewayåªæœ‰ä¸¤ç§ç±»å‹çš„Filterï¼Œæœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨Spring Cloud Gatewayä¸­åˆ›å»ºä¸€ä¸ªPreæˆ–Postç±»å‹çš„Filterã€‚</p><a id="more"></a><h2 id="zuulçš„Filterç±»å‹"><a href="#zuulçš„Filterç±»å‹" class="headerlink" title="zuulçš„Filterç±»å‹"></a>zuulçš„Filterç±»å‹</h2><p>Zuul çš„ Filter æ˜¯é€šè¿‡filterType()æ–¹æ³•æ¥æŒ‡å®šï¼Œä¸€ä¸ª Filter åªèƒ½å¯¹åº”ä¸€ç§ç±»å‹ï¼Œè¦ä¹ˆæ˜¯ â€œpreâ€ è¦ä¹ˆæ˜¯â€œpostâ€</p><h3 id="Spring-Cloud-Gatewayçš„Filterç±»å‹"><a href="#Spring-Cloud-Gatewayçš„Filterç±»å‹" class="headerlink" title="Spring Cloud Gatewayçš„Filterç±»å‹"></a>Spring Cloud Gatewayçš„Filterç±»å‹</h3><p>Spring Cloud Gateway åŸºäº Project Reactor å’Œ WebFluxï¼Œé‡‡ç”¨å“åº”å¼ç¼–ç¨‹é£æ ¼ï¼Œæ‰“å¼€å®ƒçš„ Filter çš„æ¥å£GatewayFilterä½ ä¼šå‘ç°å®ƒåªæœ‰ä¸€ä¸ªæ–¹æ³•filter</p><h2 id="Preç±»å‹çš„Filter"><a href="#Preç±»å‹çš„Filter" class="headerlink" title="Preç±»å‹çš„Filter"></a>Preç±»å‹çš„Filter</h2><p>åœ¨Spring Cloud Gatewayæºç ä¸­å®šä¹‰äº†ä¸€ä¸ªPreç±»å‹çš„Filterï¼Œcodeå°†ä¼šåœ¨chain.filter() ä¹‹å‰è¢«æ‰§è¡Œ,ä»£ç :<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/master/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/AddRequestHeaderGatewayFilterFactory.java" target="_blank" rel="noopener">AddRequestHeader</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.cloud.gateway.filter.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddRequestHeaderGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractNameValueGatewayFilterFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(NameValueConfig config)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">ServerHttpRequest request = exchange.getRequest().mutate()</span><br><span class="line">.header(config.getName(), config.getValue())</span><br><span class="line">.build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</span><br><span class="line">&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Postç±»å‹çš„Filter"><a href="#Postç±»å‹çš„Filter" class="headerlink" title="Postç±»å‹çš„Filter"></a>Postç±»å‹çš„Filter</h2><p>å¯¹äºPostç±»å‹çš„Filterï¼Œ<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/master/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/SetStatusGatewayFilterFactory.java" target="_blank" rel="noopener">SetStatus</a><br>ä»£ç å°†ä¼šåœ¨chain.filter(exchange).then()é‡Œé¢çš„ä»£ç è¿è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SetStatusGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">SetStatusGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> HttpStatus status = ServerWebExchangeUtils.parse(config.status);</span><br><span class="line">        <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// check not really needed, since it is guarded in setStatusCode,</span></span><br><span class="line">                <span class="comment">// but it's a good example</span></span><br><span class="line">                <span class="keyword">if</span> (!exchange.getResponse().isCommitted()) &#123;</span><br><span class="line">                    setResponseStatus(exchange, status);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:Spring Cloud Gatewayåªæœ‰ä¸¤ç§ç±»å‹çš„Filterï¼Œæœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨Spring Cloud Gatewayä¸­åˆ›å»ºä¸€ä¸ªPreæˆ–Postç±»å‹çš„Filterã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>å…¬ç›ŠEureka Serverä¸å®šåˆ¶æ–¹æ³•</title>
    <link href="http://xujin.org/sc/sc-diy-eureka/"/>
    <id>http://xujin.org/sc/sc-diy-eureka/</id>
    <published>2018-05-14T06:00:00.000Z</published>
    <updated>2019-01-12T03:46:24.845Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>: æœ¬æ–‡ä¸»è¦ç®€å•ä»‹ç»å¦‚ä½•å®šåˆ¶ä¸€ä¸ªeureka serverï¼Œå¹¶ç›´æ¥æŒ‡å‡ºæœ€ä¼˜çš„å®šåˆ¶æ–¹å¼ã€‚</p><a id="more"></a><h2 id="1-Spring-Cloudä¸­å›½å…¬ç›ŠEureka-Server"><a href="#1-Spring-Cloudä¸­å›½å…¬ç›ŠEureka-Server" class="headerlink" title="1. Spring Cloudä¸­å›½å…¬ç›ŠEureka Server"></a>1. Spring Cloudä¸­å›½å…¬ç›ŠEureka Server</h2><p>Eureka Serverä¸ºä½œä¸ºSpring Cloudå¼€å‘è¿‡ç¨‹ä¸­å¸¸ç”¨çš„æ³¨å†Œä¸­å¿ƒç»„ä»¶ï¼Œä½œä¸ºåŸºç¡€è®¾æ–½ç»„ä»¶ï¼Œå¼€å‘å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œç»å¸¸éœ€è¦è‡ªå·±åˆ›å»ºEureka Serveråº”ç”¨å’Œé‡å¯ã€‚ä¸ºäº†å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå­¦ä¹ å…¥é—¨ã€‚Spring Cloudä¸­å›½ç¤¾åŒºç‰¹æ­å»ºä¸€ä¸ªå…¬ç›Šæ³¨å†Œä¸­å¿ƒï¼Œä»…ä½œä¸ºå¸®åŠ©Spring Cloudçš„å¼€å‘è€…è¿›è¡Œå­¦ä¹ å’Œè°ƒè¯•ã€‚ä¸ºäº†æ›´å¥½æœåŠ¡å¤§å®¶ï¼Œè¯·å‹¿å¯¹æœ¬æ³¨å†Œä¸­å¿ƒè¿›è¡Œå‹æµ‹ã€‚å®šåˆ¶çš„Eureka Serveræ³¨å†Œä¸­å¿ƒUIå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/1966ed6f184d06c2ab793dcaf2c41c8b.jpeg?Expires=1841654009&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=OeNSoXly3WYi9wfNq3guMPq%2Bt48%3D" alt=""></p><h3 id="1-1-è®¿é—®åœ°å€"><a href="#1-1-è®¿é—®åœ°å€" class="headerlink" title="1.1 è®¿é—®åœ°å€"></a>1.1 è®¿é—®åœ°å€</h3><p> <a href="http://eureka.springcloud.cn" title="http://eureka.springcloud.cn" target="_blank" rel="noopener">http://eureka.springcloud.cn</a></p><h2 id="2-å®šåˆ¶Eureka-Serrverçš„UI"><a href="#2-å®šåˆ¶Eureka-Serrverçš„UI" class="headerlink" title="2.å®šåˆ¶Eureka Serrverçš„UI"></a>2.å®šåˆ¶Eureka Serrverçš„UI</h2><h3 id="2-1-ä¸ºä»€ä¹ˆè¦å®šåˆ¶Eureka-Server"><a href="#2-1-ä¸ºä»€ä¹ˆè¦å®šåˆ¶Eureka-Server" class="headerlink" title="2.1 ä¸ºä»€ä¹ˆè¦å®šåˆ¶Eureka Server"></a>2.1 ä¸ºä»€ä¹ˆè¦å®šåˆ¶Eureka Server</h3><p> åŸå› ä¸¤ç‚¹:</p><ul><li>1.è§‰å¾—é»˜è®¤çš„UIæ¯”è¾ƒä¸‘  </li><li>2.Eureka Serveræƒ³å®¢åˆ¶åŒ–ä¸€ä¸‹</li></ul><blockquote><p>è‡³äºSpring Cloud Eurekaçš„UIå®¢åˆ¶åŒ–æˆä»€ä¹ˆæ ·å­ç”±ä½ è€Œå®šï¼</p></blockquote><h2 id="3-ä¸¤ç§æ–¹æ³•å®šåˆ¶Eureka-Server"><a href="#3-ä¸¤ç§æ–¹æ³•å®šåˆ¶Eureka-Server" class="headerlink" title="3. ä¸¤ç§æ–¹æ³•å®šåˆ¶Eureka Server"></a>3. ä¸¤ç§æ–¹æ³•å®šåˆ¶Eureka Server</h2><h3 id="3-1-ç›´æ¥ä¿®æ”¹eureka-serverçš„æºä»£ç "><a href="#3-1-ç›´æ¥ä¿®æ”¹eureka-serverçš„æºä»£ç " class="headerlink" title="3.1 ç›´æ¥ä¿®æ”¹eureka serverçš„æºä»£ç "></a>3.1 ç›´æ¥ä¿®æ”¹eureka serverçš„æºä»£ç </h3><p>   ç›´æ¥ä¿®æ”¹eureka serverçš„æºä»£ç ï¼Œè¯¥æ–¹æ³•æ˜¯æœ€çº¯çš„æ–¹å¼ï¼Œè€Œä¸”æ¯æ¬¡æœ‰ä¸€ä¸ªEureka Serverçš„ç‰ˆæœ¬éƒ½éœ€è¦å»ä¿®æ”¹ã€‚</p><h3 id="3-2-åªä¿®æ”¹Eureka-Serverçš„UI"><a href="#3-2-åªä¿®æ”¹Eureka-Serverçš„UI" class="headerlink" title="3.2 åªä¿®æ”¹Eureka Serverçš„UI"></a>3.2 åªä¿®æ”¹Eureka Serverçš„UI</h3><p>åªéœ€è¦ä¿®æ”¹å¯¹åº”çš„html+css+æ–‡æ¡ˆå³å¯ï¼Œå®Œå…¨ä¸ç”¨å»ä¿®æ”¹Eureka Serverçš„æºç ,å¼ºçƒˆæ¨èã€‚</p><blockquote><p>æºç å‚è€ƒåœ°å€:<a href="https://github.com/SpringCloud/spring-cloud-eureka" target="_blank" rel="noopener">https://github.com/SpringCloud/spring-cloud-eureka</a></p></blockquote><h3 id="3-3-ä¸ºä»€ä¹ˆæˆ‘å®šåˆ¶è‡ªå·±çš„UIåŠ è¿›å»"><a href="#3-3-ä¸ºä»€ä¹ˆæˆ‘å®šåˆ¶è‡ªå·±çš„UIåŠ è¿›å»" class="headerlink" title="3.3 ä¸ºä»€ä¹ˆæˆ‘å®šåˆ¶è‡ªå·±çš„UIåŠ è¿›å»"></a>3.3 ä¸ºä»€ä¹ˆæˆ‘å®šåˆ¶è‡ªå·±çš„UIåŠ è¿›å»</h3><p> ä¸ºä»€ä¹ˆæˆ‘å®šåˆ¶è‡ªå·±çš„UIåŠ è¿›å»ï¼Œå°±å¯ä»¥ç›´æ¥Runï¼Œé‚£æºç ä»£ç ä¸­çš„UIæ˜¯ä¸æ˜¯è¢«è¦†ç›–äº†ï¼Ÿ<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.eureka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-server-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p><blockquote><p>å¦‚ä¸Šmavené…ç½®æ‰€ç¤ºï¼Œå®˜æ–¹çš„spring-cloud-starter-netflix-eureka-serverä¾èµ–ä¿¡æ¯é…ç½®åœ¨ä¸‹é¢ï¼Œç”±mavençš„ä¾èµ–åŠ è½½é¡ºåºå†³å®šï¼Œå®šåˆ¶çš„UIä¼˜å…ˆåŠ è½½æ˜¾ç¤ºã€‚</p></blockquote><h2 id="4-å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨DIYçš„Eureka-Server"><a href="#4-å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨DIYçš„Eureka-Server" class="headerlink" title="4. å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨DIYçš„Eureka Server"></a>4. å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨DIYçš„Eureka Server</h2><p>åªéœ€è¦é…ç½®mavenä¾èµ–å³å¯:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.eureka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-server-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;: æœ¬æ–‡ä¸»è¦ç®€å•ä»‹ç»å¦‚ä½•å®šåˆ¶ä¸€ä¸ªeureka serverï¼Œå¹¶ç›´æ¥æŒ‡å‡ºæœ€ä¼˜çš„å®šåˆ¶æ–¹å¼ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Eureka Server" scheme="http://xujin.org/categories/Eureka-Server/"/>
    
    
      <category term="Eureka Server" scheme="http://xujin.org/tags/Eureka-Server/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gatewayçš„Beforeè·¯ç”±æ–­è¨€å·¥å‚</title>
    <link href="http://xujin.org/sc/gw/gw04/"/>
    <id>http://xujin.org/sc/gw/gw04/</id>
    <published>2018-03-28T06:00:00.000Z</published>
    <updated>2019-01-12T03:35:55.349Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:åœ¨ä¸Šæœ¬ç¯‡æ–‡ç« Spring Cloud Gatewayçš„Afterè·¯ç”±æ–­è¨€å·¥å‚ä»‹ç»äº†Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µå’ŒAfterè·¯ç”±æ–­è¨€ï¼Œæœ¬æ–‡ç®€å•ä»‹ç»Beforeè·¯ç”±æ–­è¨€å·¥å‚ã€‚å› ä¸ºæ¯”è¾ƒç®€å•æ‰€ä»¥å°±<code>æŠ›ç –å¼•ç‰ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶å¿«é€Ÿå…¥é—¨Spring Cloud Gateway</code>ï¼Œæ¬¢è¿å¤§å®¶<code>åŠ æˆ‘å¾®ä¿¡Software_King</code>ï¼Œè¿›å…¥Spring Cloudä¸­å›½ç¤¾åŒºå¾®ä¿¡ç¾¤äº¤æµã€‚</p><a id="more"></a><h2 id="1-Spring-Cloud-Gatewayæ ¸å¿ƒæ¦‚å¿µ"><a href="#1-Spring-Cloud-Gatewayæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="1. Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µ"></a>1. Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µ</h2><p>   ç½‘å…³ç®€å•çš„è¯´å°±æ˜¯æä¾›ä¸€ä¸ªå¯¹å¤–ç»Ÿä¸€çš„APIå…¥å£å’Œå‡ºå£ï¼Œç»Ÿç®¡ä¼ä¸šå¯¹å¤–çš„æ‰€æœ‰APIå‡ºå£ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç½‘å…³å¯¹å¤–æš´éœ²çš„URLæˆ–è€…æ¥å£ä¿¡æ¯ï¼Œæˆ‘ä»¬ç»Ÿç§°ä¹‹ä¸ºè·¯ç”±ä¿¡æ¯ã€‚å¦‚æœç ”å‘è¿‡ç½‘å…³ä¸­é—´ä»¶ï¼Œæˆ–è€…ä½¿ç”¨æˆ–äº†è§£è¿‡ZUULçš„ï¼Œç½‘å…³çš„æ ¸å¿ƒè‚¯å®šæ˜¯Filterä»¥åŠFilter Chain(Filterè´£ä»»é“¾)ã€‚Spring Cloud Gatewayä¹Ÿå…·æœ‰è·¯ç”±ä¿¡æ¯å’ŒFilterã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹Spring Cloud gatewayä¸­æœ€é‡è¦çš„å‡ ä¸ªæ¦‚å¿µ:</p><ul><li><code>è·¯ç”±(route)</code>:è·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯ç”±ä¸€ä¸ªIDã€ä¸€ä¸ªç›®çš„urlã€ä¸€ç»„æ–­è¨€å·¥å‚å’Œä¸€ç»„Filterç»„æˆã€‚å¦‚æœè·¯ç”±æ–­è¨€å·¥å‚ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚çš„Urlå’Œé…ç½®çš„è·¯ç”±åŒ¹é…ã€‚</li><li><code>æ–­è¨€(Predicate)</code>: java 8ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gatewayä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯Spring 5.0æ¡†æ¶ä¸­çš„ServerWebExchangeã€‚Spring Cloud Gatewayä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é…æ¥è‡ªäºhttp requestä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚</li><li><code>è¿‡æ»¤å™¨(filter)</code>:ä¸€ä¸ªæ ‡å‡†çš„Spring webFilterã€‚Spring Cloud Gatewayä¸­çš„Filteråˆ†ä¸ºä¸¤ç§ç±»å‹çš„Filterï¼Œåˆ†åˆ«æ˜¯Gateway Filterå’ŒGlobal Filter.ç½‘å…³ Filterå®ä¾‹æ˜¯ç”±Spring æ¡†æ¶ä¸­çš„ç½‘å…³Filterçš„ç‰¹æ®Šå·¥å‚æ„é€ ã€‚requeståœ¨è½¬å‘åˆ°ç›®å‰æœåŠ¡ä¹‹å‰ï¼Œresponseåœ¨è¿”å›åˆ°è°ƒç”¨ç«¯ä¹‹å‰éƒ½å¯ä»¥è¢«ä¿®æ”¹æˆ–è€…è‡ªå®šä¹‰ã€‚</li></ul><h2 id="2-ä»€ä¹ˆæ˜¯Beforeè·¯ç”±æ–­è¨€"><a href="#2-ä»€ä¹ˆæ˜¯Beforeè·¯ç”±æ–­è¨€" class="headerlink" title="2. ä»€ä¹ˆæ˜¯Beforeè·¯ç”±æ–­è¨€"></a>2. ä»€ä¹ˆæ˜¯Beforeè·¯ç”±æ–­è¨€</h2><p>  <code>Beforeè·¯ç”±æ–­è¨€å·¥å‚</code>å¸¦æœ‰ä¸€ä¸ª<code>UTCæ—¶é—´æ ¼å¼</code>çš„æ—¶é—´å‚æ•°ï¼Œå½“è¯·æ±‚è¿›æ¥çš„<code>å½“å‰æ—¶é—´åœ¨è·¯ç”±æ–­è¨€å·¥å‚ä¹‹å‰</code>ä¼šæˆåŠŸåŒ¹é…ï¼Œå¦åˆ™ä¸èƒ½æˆåŠŸåŒ¹é…ã€‚</p><h2 id="3-Beforeè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹"><a href="#3-Beforeè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹" class="headerlink" title="3. Beforeè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹"></a>3. Beforeè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹</h2><h3 id="3-1-å¼•å…¥pomä¾èµ–"><a href="#3-1-å¼•å…¥pomä¾èµ–" class="headerlink" title="3.1 å¼•å…¥pomä¾èµ–"></a>3.1 å¼•å…¥pomä¾èµ–</h3><p>pom.xmlä¾èµ–é…ç½®å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-2-application-ymlæ–‡ä»¶é…ç½®"><a href="#3-2-application-ymlæ–‡ä»¶é…ç½®" class="headerlink" title="3.2 application.ymlæ–‡ä»¶é…ç½®:"></a>3.2 application.ymlæ–‡ä»¶é…ç½®:</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">before_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://xujin.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Before=2022-03-13T00:54:30.877+08:00[Asia/Shanghai]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">TRACE</span></span><br><span class="line">    <span class="string">org.springframework.http.server.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">org.springframework.web.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">reactor.ipc.netty:</span> <span class="string">DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="string">management.endpoints.web.exposure.include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gatewayæä¾›ä¸¤ç§æ–¹å¼å»é…ç½®Beforeè·¯ç”±æ–­è¨€å·¥å‚ï¼Œè¿™é‡Œä»‹ç»çš„æ˜¯ymlæ–‡ä»¶çš„é…ç½®æ–¹å¼ã€‚</p></blockquote><h3 id="3-3-ç­‰ä»·çš„-Beané…ç½®"><a href="#3-3-ç­‰ä»·çš„-Beané…ç½®" class="headerlink" title="3.3 ç­‰ä»·çš„@Beané…ç½®"></a>3.3 ç­‰ä»·çš„@Beané…ç½®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">ZonedDateTime datetime = LocalDateTime.now().plusDays(<span class="number">1</span>).atZone(ZoneId.systemDefault());</span><br><span class="line"></span><br><span class="line"><span class="comment">//@formatter:off</span></span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line">.route(<span class="string">"before_route"</span>, r -&gt; r.before(datetime)</span><br><span class="line">.uri(<span class="string">"http://xujin.org"</span>))</span><br><span class="line"></span><br><span class="line">.build();</span><br><span class="line"><span class="comment">//@formatter:on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gatewayæä¾›ä¸¤ç§æ–¹å¼å»é…ç½®Afterè·¯ç”±æ–­è¨€å·¥å‚ï¼Œè¿™é‡Œä»‹ç»çš„æ˜¯@Beançš„é…ç½®æ–¹å¼ã€‚ä¸ç®¡é€šè¿‡<code>ymlæ–‡ä»¶é…ç½®æˆ–è€…é€šè¿‡@Bean</code>çš„æ–¹å¼é…ç½®æ˜¯ç­‰ä»·çš„ã€‚</p></blockquote><h3 id="3-4-æµ‹è¯•å¦‚ä¸‹"><a href="#3-4-æµ‹è¯•å¦‚ä¸‹" class="headerlink" title="3.4 æµ‹è¯•å¦‚ä¸‹:"></a>3.4 æµ‹è¯•å¦‚ä¸‹:</h3><p>è®¿é—®<a href="http://localhost:8082/" target="_blank" rel="noopener">http://localhost:8082/</a> æˆåŠŸè½¬å‘åˆ°<a href="http://xujin.orgã€‚" target="_blank" rel="noopener">http://xujin.orgã€‚</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:åœ¨ä¸Šæœ¬ç¯‡æ–‡ç« Spring Cloud Gatewayçš„Afterè·¯ç”±æ–­è¨€å·¥å‚ä»‹ç»äº†Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µå’ŒAfterè·¯ç”±æ–­è¨€ï¼Œæœ¬æ–‡ç®€å•ä»‹ç»Beforeè·¯ç”±æ–­è¨€å·¥å‚ã€‚å› ä¸ºæ¯”è¾ƒç®€å•æ‰€ä»¥å°±&lt;code&gt;æŠ›ç –å¼•ç‰ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶å¿«é€Ÿå…¥é—¨Spring Cloud Gateway&lt;/code&gt;ï¼Œæ¬¢è¿å¤§å®¶&lt;code&gt;åŠ æˆ‘å¾®ä¿¡Software_King&lt;/code&gt;ï¼Œè¿›å…¥Spring Cloudä¸­å›½ç¤¾åŒºå¾®ä¿¡ç¾¤äº¤æµã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gatewayçš„Afterè·¯ç”±æ–­è¨€å·¥å‚</title>
    <link href="http://xujin.org/sc/gw/gw03/"/>
    <id>http://xujin.org/sc/gw/gw03/</id>
    <published>2018-03-25T06:00:00.000Z</published>
    <updated>2019-01-12T03:24:23.992Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µå’ŒAfterè·¯ç”±æ–­è¨€ï¼Œå› ä¸ºæ¯”è¾ƒç®€å•æ‰€ä»¥å°±<code>æŠ›ç –å¼•ç‰ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶å¿«é€Ÿå…¥é—¨Spring Cloud Gateway</code>ï¼Œæ¬¢è¿å¤§å®¶<code>åŠ æˆ‘å¾®ä¿¡Software_King</code>ï¼Œè¿›å…¥Spring Cloudä¸­å›½ç¤¾åŒºå¾®ä¿¡ç¾¤äº¤æµã€‚<br><a id="more"></a></p><h2 id="1-Spring-Cloud-Gatewayæ ¸å¿ƒæ¦‚å¿µ"><a href="#1-Spring-Cloud-Gatewayæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="1.Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µ"></a>1.Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µ</h2><p>   ç½‘å…³ç®€å•çš„è¯´å°±æ˜¯æä¾›ä¸€ä¸ªå¯¹å¤–ç»Ÿä¸€çš„APIå…¥å£å’Œå‡ºå£ï¼Œç»Ÿç®¡ä¼ä¸šå¯¹å¤–çš„æ‰€æœ‰APIå‡ºå£ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç½‘å…³å¯¹å¤–æš´éœ²çš„URLæˆ–è€…æ¥å£ä¿¡æ¯ï¼Œæˆ‘ä»¬ç»Ÿç§°ä¹‹ä¸ºè·¯ç”±ä¿¡æ¯ã€‚å¦‚æœç ”å‘è¿‡ç½‘å…³ä¸­é—´ä»¶ï¼Œæˆ–è€…ä½¿ç”¨æˆ–äº†è§£è¿‡ZUULçš„ï¼Œç½‘å…³çš„æ ¸å¿ƒè‚¯å®šæ˜¯Filterä»¥åŠFilter Chain(Filterè´£ä»»é“¾)ã€‚Spring Cloud Gatewayä¹Ÿå…·æœ‰è·¯ç”±ä¿¡æ¯å’ŒFilterã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹Spring Cloud gatewayä¸­æœ€é‡è¦çš„å‡ ä¸ªæ¦‚å¿µ:</p><ul><li><code>è·¯ç”±(route)</code>:è·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯ç”±ä¸€ä¸ªIDã€ä¸€ä¸ªç›®çš„urlã€ä¸€ç»„æ–­è¨€å·¥å‚å’Œä¸€ç»„Filterç»„æˆã€‚å¦‚æœè·¯ç”±æ–­è¨€å·¥å‚ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚çš„Urlå’Œé…ç½®çš„è·¯ç”±åŒ¹é…ã€‚</li><li><code>æ–­è¨€(Predicate)</code>: java 8ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gatewayä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯Spring 5.0æ¡†æ¶ä¸­çš„ServerWebExchangeã€‚Spring Cloud Gatewayä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é…æ¥è‡ªäºhttp requestä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚</li><li><code>è¿‡æ»¤å™¨(filter)</code>:ä¸€ä¸ªæ ‡å‡†çš„Spring webFilterã€‚Spring Cloud Gatewayä¸­çš„Filteråˆ†ä¸ºä¸¤ç§ç±»å‹çš„Filterï¼Œåˆ†åˆ«æ˜¯Gateway Filterå’ŒGlobal Filter.ç½‘å…³ Filterå®ä¾‹æ˜¯ç”±Spring æ¡†æ¶ä¸­çš„ç½‘å…³Filterçš„ç‰¹æ®Šå·¥å‚æ„é€ ã€‚requeståœ¨è½¬å‘åˆ°ç›®å‰æœåŠ¡ä¹‹å‰ï¼Œresponseåœ¨è¿”å›åˆ°è°ƒç”¨ç«¯ä¹‹å‰éƒ½å¯ä»¥è¢«ä¿®æ”¹æˆ–è€…è‡ªå®šä¹‰ã€‚</li></ul><h2 id="2-ä»€ä¹ˆæ˜¯Afterè·¯ç”±æ–­è¨€"><a href="#2-ä»€ä¹ˆæ˜¯Afterè·¯ç”±æ–­è¨€" class="headerlink" title="2.ä»€ä¹ˆæ˜¯Afterè·¯ç”±æ–­è¨€"></a>2.ä»€ä¹ˆæ˜¯Afterè·¯ç”±æ–­è¨€</h2><p>   After Route Predicate Factoryå¸¦æœ‰ä¸€ä¸ªUTCæ—¶é—´æ ¼å¼çš„æ—¶é—´å‚æ•°ï¼Œå½“è¯·æ±‚è¿›æ¥çš„å½“å‰æ—¶é—´åœ¨è·¯ç”±æ–­è¨€å·¥å‚ä¹‹åä¼šæˆåŠŸåŒ¹é…ï¼Œå¦åˆ™ä¸èƒ½æˆåŠŸåŒ¹é…ã€‚</p><h2 id="3-Afterè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹"><a href="#3-Afterè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹" class="headerlink" title="3.Afterè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹"></a>3.Afterè·¯ç”±æ–­è¨€å·¥å‚çš„æ¡ˆä¾‹</h2><h3 id="3-1-å¼•å…¥pomä¾èµ–"><a href="#3-1-å¼•å…¥pomä¾èµ–" class="headerlink" title="3.1 å¼•å…¥pomä¾èµ–"></a>3.1 å¼•å…¥pomä¾èµ–</h3><p>pom.xmlä¾èµ–é…ç½®å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-2-application-ymlæ–‡ä»¶é…ç½®"><a href="#3-2-application-ymlæ–‡ä»¶é…ç½®" class="headerlink" title="3.2  application.ymlæ–‡ä»¶é…ç½®:"></a>3.2  application.ymlæ–‡ä»¶é…ç½®:</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">after_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://xujin.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">After=2018-03-18T17:32:58.129+08:00[Asia/Shanghai]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">TRACE</span></span><br><span class="line">    <span class="string">org.springframework.http.server.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">org.springframework.web.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">reactor.ipc.netty:</span> <span class="string">DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="string">management.endpoints.web.exposure.include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gatewayæä¾›ä¸¤ç§æ–¹å¼å»é…ç½®Afterè·¯ç”±æ–­è¨€å·¥å‚ï¼Œè¿™é‡Œä»‹ç»çš„æ˜¯ymlæ–‡ä»¶çš„é…ç½®æ–¹å¼ã€‚</p></blockquote><h3 id="3-3-ç­‰ä»·çš„-Beané…ç½®"><a href="#3-3-ç­‰ä»·çš„-Beané…ç½®" class="headerlink" title="3.3 ç­‰ä»·çš„@Beané…ç½®"></a>3.3 ç­‰ä»·çš„@Beané…ç½®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">ZonedDateTime minusTime = LocalDateTime.now().minusDays(<span class="number">1</span>).atZone(ZoneId.systemDefault());</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line">.route(<span class="string">"after_route"</span>, r -&gt; r.after(minusTime)</span><br><span class="line">.uri(<span class="string">"http://xujin.org"</span>))</span><br><span class="line"></span><br><span class="line">.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gatewayæä¾›ä¸¤ç§æ–¹å¼å»é…ç½®Afterè·¯ç”±æ–­è¨€å·¥å‚ï¼Œè¿™é‡Œä»‹ç»çš„æ˜¯@Beançš„é…ç½®æ–¹å¼ã€‚ä¸ç®¡é€šè¿‡ymlæ–‡ä»¶é…ç½®æˆ–è€…é€šè¿‡@Beançš„æ–¹å¼é…ç½®æ˜¯ç­‰ä»·çš„ã€‚</p></blockquote><h3 id="3-4-æµ‹è¯•å¦‚ä¸‹"><a href="#3-4-æµ‹è¯•å¦‚ä¸‹" class="headerlink" title="3.4 æµ‹è¯•å¦‚ä¸‹:"></a>3.4 æµ‹è¯•å¦‚ä¸‹:</h3><p>è®¿é—®<a href="http://localhost:8081/æˆåŠŸè½¬å‘åˆ°http://xujin.org" target="_blank" rel="noopener">http://localhost:8081/æˆåŠŸè½¬å‘åˆ°http://xujin.org</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µå’ŒAfterè·¯ç”±æ–­è¨€ï¼Œå› ä¸ºæ¯”è¾ƒç®€å•æ‰€ä»¥å°±&lt;code&gt;æŠ›ç –å¼•ç‰ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶å¿«é€Ÿå…¥é—¨Spring Cloud Gateway&lt;/code&gt;ï¼Œæ¬¢è¿å¤§å®¶&lt;code&gt;åŠ æˆ‘å¾®ä¿¡Software_King&lt;/code&gt;ï¼Œè¿›å…¥Spring Cloudä¸­å›½ç¤¾åŒºå¾®ä¿¡ç¾¤äº¤æµã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gatewayæ­ç§˜ä¹‹å¤„ç†è¯·æ±‚æµç¨‹</title>
    <link href="http://xujin.org/sc/gw/gw02/"/>
    <id>http://xujin.org/sc/gw/gw02/</id>
    <published>2018-03-17T06:00:00.000Z</published>
    <updated>2019-01-12T03:20:23.909Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»æºç çš„è§’åº¦æ­ç§˜Spring Cloud Gatewayçš„æ€ä¹ˆå¤„ç†è¯·æ±‚æµç¨‹ã€‚</p><a id="more"></a><h2 id="1-Spring-Gatewayæ¦‚è¿°"><a href="#1-Spring-Gatewayæ¦‚è¿°" class="headerlink" title="1.Spring Gatewayæ¦‚è¿°"></a>1.Spring Gatewayæ¦‚è¿°</h2><p>   <code>Spring Cloud Gateway</code>æ˜¯Springå®˜æ–¹åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0å’ŒProject Reactorç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼ŒSpring Cloud Gatewayæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„ç»Ÿä¸€çš„APIè·¯ç”±ç®¡ç†æ–¹å¼ã€‚Spring Cloud Gatewayä½œä¸ºSpring Cloudç”Ÿæ€ç³»ä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£Netflix ZUULï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäºFilteré“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§/åŸ‹ç‚¹ï¼Œå’Œé™æµç­‰ã€‚</p><h2 id="2-Spring-Cloud-gatewayè¯·æ±‚å…¥å£åˆ†æ"><a href="#2-Spring-Cloud-gatewayè¯·æ±‚å…¥å£åˆ†æ" class="headerlink" title="2. Spring Cloud gatewayè¯·æ±‚å…¥å£åˆ†æ"></a>2. Spring Cloud gatewayè¯·æ±‚å…¥å£åˆ†æ</h2><p>  ä¸ç®¡æ˜¯Zuulï¼Œè¿˜æ˜¯Spring Cloud Gatewayè¿˜æ˜¯åŸºäºNettyçš„è‡ªç ”ç½‘å…³ï¼Œéƒ½ä¼šæŠŠè¯·æ±‚è¿›æ¥çš„Requestï¼Œæˆ–è€…è¿”å›çš„Responseè¿›è¡ŒåŒ…è£…ï¼Œè½¬æ¢æå–ä¸ºç½‘å…³è¿è¡Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè€Œåœ¨Spring Cloud gatewayä¸­ç½‘å…³çš„ä¸Šä¸‹æ–‡ä¸ºServerWebExchangeã€‚</p><h3 id="2-1-å…¥å£HttpServerRequestå’ŒHttpServerResponseè½¬æ¢"><a href="#2-1-å…¥å£HttpServerRequestå’ŒHttpServerResponseè½¬æ¢" class="headerlink" title="2.1 å…¥å£HttpServerRequestå’ŒHttpServerResponseè½¬æ¢"></a>2.1 å…¥å£HttpServerRequestå’ŒHttpServerResponseè½¬æ¢</h3><p>Spring Cloud Gatewayçš„è¯·æ±‚å…¥å£ï¼Œorg.springframework.http.server.reactive.ReactorHttpHandlerAdapter#applyæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">apply</span><span class="params">(HttpServerRequest request, HttpServerResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">NettyDataBufferFactory bufferFactory = <span class="keyword">new</span> NettyDataBufferFactory(response.alloc());</span><br><span class="line">ServerHttpRequest adaptedRequest;</span><br><span class="line">ServerHttpResponse adaptedResponse;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">adaptedRequest = <span class="keyword">new</span> ReactorServerHttpRequest(request, bufferFactory);</span><br><span class="line">adaptedResponse = <span class="keyword">new</span> ReactorServerHttpResponse(response, bufferFactory);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (URISyntaxException ex) &#123;</span><br><span class="line">logger.error(<span class="string">"Invalid URL "</span> + ex.getMessage(), ex);</span><br><span class="line">response.status(HttpResponseStatus.BAD_REQUEST);</span><br><span class="line"><span class="keyword">return</span> Mono.empty();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (adaptedRequest.getMethod() == HttpMethod.HEAD) &#123;</span><br><span class="line">adaptedResponse = <span class="keyword">new</span> HttpHeadResponseDecorator(adaptedResponse);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.httpHandler.handle(adaptedRequest, adaptedResponse)</span><br><span class="line">.doOnError(ex -&gt; logger.error(<span class="string">"Handling completed with error"</span>, ex))</span><br><span class="line">.doOnSuccess(aVoid -&gt; logger.debug(<span class="string">"Handling completed with success"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PSï¼Œä»£ç æ¥æºäºspring-web-5.0.4.RELEASE.jar<br>æ­¤æ–¹æ³•ä¸ºSpring Cloud Gatewayçš„è¯·æ±‚å…¥å£æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯æŠŠæ¥æ”¶åˆ°çš„HttpServerRequestæˆ–è€…æœ€ç»ˆéœ€è¦è¿”å›çš„HttpServerResponseï¼ŒåŒ…è£…è½¬æ¢ä¸ºReactorServerHttpRequestå’ŒReactorServerHttpResponseã€‚</p></blockquote><h3 id="2-2-æ„é€ Spring-Cloud-gatewayçš„ä¸Šä¸‹æ–‡ServerWebExchange"><a href="#2-2-æ„é€ Spring-Cloud-gatewayçš„ä¸Šä¸‹æ–‡ServerWebExchange" class="headerlink" title="2.2 æ„é€ Spring Cloud gatewayçš„ä¸Šä¸‹æ–‡ServerWebExchange"></a>2.2 æ„é€ Spring Cloud gatewayçš„ä¸Šä¸‹æ–‡ServerWebExchange</h3><p>åœ¨org.springframework.web.server.adapter.HttpWebHandlerAdapterçš„182è¡Œï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line">ServerWebExchange exchange = createExchange(request, response);</span><br><span class="line"><span class="keyword">return</span> getDelegate().handle(exchange)</span><br><span class="line">.onErrorResume(ex -&gt; handleFailure(request, response, ex))</span><br><span class="line">.then(Mono.defer(response::setComplete));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>createExchange()å°†ServerHttpRequest ServerHttpResponseæ„å»ºç½‘å…³ä¸Šä¸‹æ–‡ServerWebExchangeã€‚</p></blockquote><hr><blockquote><p>PS:å…¶ä¸­org.springframework.web.server.handler.WebHandlerDecorator.getDelegate()é€šè¿‡å§”æ‰˜çš„æ–¹å¼è·å–ä¸€ç³»åˆ—éœ€è¦å¤„ç†çš„WebHandler.</p></blockquote><h3 id="2-3-è¿›å…¥Filteré“¾"><a href="#2-3-è¿›å…¥Filteré“¾" class="headerlink" title="2.3 è¿›å…¥Filteré“¾"></a>2.3 è¿›å…¥Filteré“¾</h3><p>org.springframework.cloud.gateway.handler.FilteringWebHandler#handleæ–¹æ³•ï¼Œå³77è¡Œï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">    Route route = exchange.getRequiredAttribute(GATEWAY_ROUTE_ATTR);</span><br><span class="line">    List&lt;GatewayFilter&gt; gatewayFilters = route.getFilters();</span><br><span class="line"></span><br><span class="line">    List&lt;GatewayFilter&gt; combined = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.globalFilters);</span><br><span class="line">    combined.addAll(gatewayFilters);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> needed or cached?</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(combined);</span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">"Sorted gatewayFilterFactories: "</span>+ combined);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultGatewayFilterChain(combined).filter(exchange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-æ‰§è¡ŒFilteré“¾"><a href="#2-4-æ‰§è¡ŒFilteré“¾" class="headerlink" title="2.4 æ‰§è¡ŒFilteré“¾"></a>2.4 æ‰§è¡ŒFilteré“¾</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultGatewayFilterChain</span> <span class="keyword">implements</span> <span class="title">GatewayFilterChain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; filters;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultGatewayFilterChain</span><span class="params">(List&lt;GatewayFilter&gt; filters)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.filters = filters;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.index &lt; filters.size()) &#123;</span><br><span class="line">GatewayFilter filter = filters.get(<span class="keyword">this</span>.index++);</span><br><span class="line"><span class="keyword">return</span> filter.filter(exchange, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Mono.empty(); <span class="comment">// complete</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-Gateway-Filterå§”æ‰˜ä¸ºGloable-Filteræ‰§è¡Œ"><a href="#2-5-Gateway-Filterå§”æ‰˜ä¸ºGloable-Filteræ‰§è¡Œ" class="headerlink" title="2.5 Gateway Filterå§”æ‰˜ä¸ºGloable Filteræ‰§è¡Œ"></a>2.5 Gateway Filterå§”æ‰˜ä¸ºGloable Filteræ‰§è¡Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterAdapter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> GlobalFilter delegate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GatewayFilterAdapter</span><span class="params">(GlobalFilter delegate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.delegate.filter(exchange, chain);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"GatewayFilterAdapter&#123;"</span>);</span><br><span class="line">sb.append(<span class="string">"delegate="</span>).append(delegate);</span><br><span class="line">sb.append(<span class="string">'&#125;'</span>);</span><br><span class="line"><span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-6-é¢„å‘Šå¾…ç»­"><a href="#2-6-é¢„å‘Šå¾…ç»­" class="headerlink" title="2.6 é¢„å‘Šå¾…ç»­"></a>2.6 é¢„å‘Šå¾…ç»­</h3><p>åœ¨ä¹‹åçš„æ–‡ç« ä¸­ï¼Œå°†ä¼šæ­ç§˜Spring Cloud Gatewayçš„æ¶æ„è®¾è®¡ï¼ŒFilteré“¾è®¾è®¡ï¼Œä»¥åŠå¯åŠ¨è£…åœ¨æµç¨‹ç­‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»æºç çš„è§’åº¦æ­ç§˜Spring Cloud Gatewayçš„æ€ä¹ˆå¤„ç†è¯·æ±‚æµç¨‹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud æºç åˆ†æ" scheme="http://xujin.org/tags/Spring-Cloud-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹</title>
    <link href="http://xujin.org/sc/gw/gw-01/"/>
    <id>http://xujin.org/sc/gw/gw-01/</id>
    <published>2018-03-15T06:00:00.000Z</published>
    <updated>2019-01-12T03:21:16.579Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†ä»€ä¹ˆæ˜¯<code>Spring Cloud Gateway</code>ï¼Œå¹¶åŸºäºSpring Cloud Gatewayçš„Finchley.M8ç‰ˆæœ¬ç¼–å†™ä¸€ä¸ªSpring Cloud Gatewayçš„å…¥é—¨æ¡ˆä¾‹ï¼Œå³åŸºæœ¬ä»£ç†çš„è·¯ç”±è½¬å‘é…ç½®ã€‚</p><a id="more"></a><h2 id="1-Spring-Gatewayæ¦‚è¿°"><a href="#1-Spring-Gatewayæ¦‚è¿°" class="headerlink" title="1.Spring Gatewayæ¦‚è¿°"></a>1.Spring Gatewayæ¦‚è¿°</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯Spring-Cloud-Gateway"><a href="#1-1-ä»€ä¹ˆæ˜¯Spring-Cloud-Gateway" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway"></a>1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway</h3><p>   <code>Spring Cloud Gateway</code>æ˜¯Springå®˜æ–¹åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0å’ŒProject Reactorç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼ŒSpring Cloud Gatewayæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„ç»Ÿä¸€çš„APIè·¯ç”±ç®¡ç†æ–¹å¼ã€‚Spring Cloud Gatewayä½œä¸ºSpring Cloudç”Ÿæ€ç³»ä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£Netflix ZUULï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäºFilteré“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§/åŸ‹ç‚¹ï¼Œå’Œé™æµç­‰ã€‚</p><h2 id="2-Spring-Cloud-Gatewayå…¥é—¨æ¡ˆä¾‹"><a href="#2-Spring-Cloud-Gatewayå…¥é—¨æ¡ˆä¾‹" class="headerlink" title="2. Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹"></a>2. Spring Cloud Gatewayå…¥é—¨æ¡ˆä¾‹</h2><h3 id="2-1-åˆ›å»ºmavenå·¥ç¨‹"><a href="#2-1-åˆ›å»ºmavenå·¥ç¨‹" class="headerlink" title="2.1 åˆ›å»ºmavenå·¥ç¨‹"></a>2.1 åˆ›å»ºmavenå·¥ç¨‹</h3><p>é…ç½®Spring  Cloud Gatewayçš„ç›¸å…³Mavenä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ch18-1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.book<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ch18-1-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>ch18-1-gateway<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://springcloud.cn<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M8<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-Spring-Cloud-Gatewayä¸»ç¨‹åº"><a href="#2-2-Spring-Cloud-Gatewayä¸»ç¨‹åº" class="headerlink" title="2.2  Spring Cloud Gatewayä¸»ç¨‹åº"></a>2.2  Spring Cloud Gatewayä¸»ç¨‹åº</h3><p>SpringCloudGatewayApplication.javaï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.springcloud.book.gateway;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudGatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line"><span class="comment">//basic proxy</span></span><br><span class="line">.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</span><br><span class="line">.uri(<span class="string">"http://baidu.com:80/"</span>)</span><br><span class="line">).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(SpringCloudGatewayApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-ç¼–å†™application-ymlæ–‡ä»¶"><a href="#2-3-ç¼–å†™application-ymlæ–‡ä»¶" class="headerlink" title="2.3 ç¼–å†™application.ymlæ–‡ä»¶"></a>2.3 ç¼–å†™application.ymlæ–‡ä»¶</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">spring-cloud-gateway</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">xujin_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://www.xujin.org:80/</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/xujin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">TRACE</span></span><br><span class="line">    <span class="string">org.springframework.http.server.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">org.springframework.web.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">reactor.ipc.netty:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure><h3 id="2-4-åŸºæœ¬ä»£ç†è·¯ç”±é…ç½®ç­‰åŒå†™æ³•"><a href="#2-4-åŸºæœ¬ä»£ç†è·¯ç”±é…ç½®ç­‰åŒå†™æ³•" class="headerlink" title="2.4 åŸºæœ¬ä»£ç†è·¯ç”±é…ç½®ç­‰åŒå†™æ³•"></a>2.4 åŸºæœ¬ä»£ç†è·¯ç”±é…ç½®ç­‰åŒå†™æ³•</h3><p>Spring Cloud Gatewayæä¾›äº†ä¸¤ç§é…ç½®è·¯ç”±è§„åˆ™çš„æ–¹æ³•</p><ul><li>ç¬¬ä¸€:é€šè¿‡@Beanè‡ªå®šä¹‰RouteLocator<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line"><span class="comment">//basic proxy</span></span><br><span class="line">.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</span><br><span class="line">.uri(<span class="string">"http://baidu.com:80/"</span>)</span><br><span class="line">).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><ul><li>ç¬¬äºŒ:é€šè¿‡å±äºæ–‡ä»¶æˆ–è€…ymlæ–‡ä»¶é…ç½®</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">xujin_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://www.xujin.org:80/</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/xujin</span></span><br></pre></td></tr></table></figure><blockquote><p>PS,ä»¥ä¸Šä¸¤ç§æ–¹å¼ç­‰åŒã€‚</p></blockquote><h3 id="2-5-é”™è¯¯çš„ç¤ºèŒƒä»£ç å¦‚ä¸‹"><a href="#2-5-é”™è¯¯çš„ç¤ºèŒƒä»£ç å¦‚ä¸‹" class="headerlink" title="2.5 é”™è¯¯çš„ç¤ºèŒƒä»£ç å¦‚ä¸‹:"></a>2.5 é”™è¯¯çš„ç¤ºèŒƒä»£ç å¦‚ä¸‹:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">routingConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Routes.locator()</span><br><span class="line">      .route(<span class="string">"xujin_route"</span>)</span><br><span class="line">      .uri(<span class="string">"http://xujin.org"</span>)</span><br><span class="line">      .predicate(host(<span class="string">"**.xujin.org"</span>))</span><br><span class="line">      .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ¸©é¦¨æç¤ºï¼Œä¸Šé¢è¿™ç§å†™æ³•æ˜¯åŸºäºSpring Cloud Gateway FM4çš„ç‰ˆæœ¬ï¼Œç›¸å…³ä»£ç å·²åºŸå¼ƒï¼Œç›®å‰Spring Cloud Gatewayå°†ä¼šåœ¨FM9ä¹‹åRealeseã€‚</p></blockquote><h3 id="2-6-è¿è¡Œæµ‹è¯•"><a href="#2-6-è¿è¡Œæµ‹è¯•" class="headerlink" title="2.6 è¿è¡Œæµ‹è¯•"></a>2.6 è¿è¡Œæµ‹è¯•</h3><ol><li>è®¿é—®<a href="http://localhost:8080/baidu" target="_blank" rel="noopener">http://localhost:8080/baidu</a>,è·¯ç”±è½¬å‘åˆ°<a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a></li><li>è®¿é—®<a href="http://localhost:8080/xujin" target="_blank" rel="noopener">http://localhost:8080/xujin</a>,è·¯ç”±è½¬å‘åˆ°<a href="http://xujin.org">http://xujin.orgyml</a></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line"><span class="comment">//basic proxy</span></span><br><span class="line">.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</span><br><span class="line">.uri(<span class="string">"http://baidu.com:80/"</span>)</span><br><span class="line">).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">xujin_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://www.xujin.org:80/</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/xujin</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†ä»€ä¹ˆæ˜¯&lt;code&gt;Spring Cloud Gateway&lt;/code&gt;ï¼Œå¹¶åŸºäºSpring Cloud Gatewayçš„Finchley.M8ç‰ˆæœ¬ç¼–å†™ä¸€ä¸ªSpring Cloud Gatewayçš„å…¥é—¨æ¡ˆä¾‹ï¼Œå³åŸºæœ¬ä»£ç†çš„è·¯ç”±è½¬å‘é…ç½®ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud æºç åˆ†æ" scheme="http://xujin.org/tags/Spring-Cloud-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>SCä¸­Eureka Serverçš„HAå’Œå®‰å…¨èº«ä»½éªŒè¯</title>
    <link href="http://xujin.org/sc/sc-eureka-02/"/>
    <id>http://xujin.org/sc/sc-eureka-02/</id>
    <published>2017-03-25T06:00:00.000Z</published>
    <updated>2019-01-12T03:48:16.249Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:åœ¨ã€Šè·Ÿæˆ‘å­¦Spring Cloudã€‹ä¸­çš„ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ç®€å•ä»‹ç»äº†ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»ä¸€ä¸‹Eureka Serveræ³¨å†Œä¸­å¿ƒçš„HAä»¥åŠEureka Serverçš„èº«ä»½éªŒè¯ã€‚<br><a id="more"></a></p><h2 id="ä»€ä¹ˆæ˜¯é«˜å¯ç”¨"><a href="#ä»€ä¹ˆæ˜¯é«˜å¯ç”¨" class="headerlink" title="ä»€ä¹ˆæ˜¯é«˜å¯ç”¨"></a>ä»€ä¹ˆæ˜¯é«˜å¯ç”¨</h2><h3 id="é«˜å¯ç”¨"><a href="#é«˜å¯ç”¨" class="headerlink" title="é«˜å¯ç”¨"></a>é«˜å¯ç”¨</h3><p>   High Availabilityï¼Œå³é«˜å¯ç”¨HAã€‚åœ¨åˆ†å¸ƒå¼æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç»å¸¸è¯´<code>4ä¸ª9</code>(99.99%)æˆ–è€…<code>5ä¸ª9</code>(99.999%)ã€‚ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªå¾®æœåŠ¡åˆ†å¸ƒå¼ç³»ç»Ÿä¾èµ–äº30ä¸ªå¾®æœåŠ¡ï¼Œæ¯ä¸ªå¾®æœåŠ¡å¯ç”¨æ€§æ˜¯99.99%ï¼Œé‚£ä¹ˆæ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿçš„å¯ç”¨æ€§å°±æ˜¯99.99%çš„30æ¬¡æ–¹ â‰ˆ 99.7% ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰0.3%ç³»ç»Ÿæ˜¯ä¸å¯ç”¨çš„ï¼Œ0.3%æ„å‘³ç€å¦‚æœ<code>Qpså¾ˆé«˜</code>ï¼Œæœ‰ä¸€äº¿æ¬¡è¯·æ±‚çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰<code>30ä¸‡</code>æ¬¡å¤±è´¥ã€‚æ¢ç®—æˆæ—¶é—´<code>å¤§çº¦æ¯æœˆæœ‰2ä¸ªå°æ—¶æœåŠ¡ä¸ç¨³å®š</code>ã€‚ç‰¹åˆ«æ˜¯éšç€æœåŠ¡ä¾èµ–æ•°é‡çš„å˜å¤šï¼Œå¾®æœåŠ¡ä¸ç¨³å®šçš„æ¦‚ç‡ä¼šæˆæŒ‡æ•°æ€§ä¸Šå‡ã€‚å› æ­¤è¦ä¿è¯å¾®æœåŠ¡åº”ç”¨çš„HAéœ€è¦ä»å„æ–¹é¢å…¥æ‰‹ï¼Œä¸‹é¢ä¼šä»‹ç»ä¸€ä¸‹å¦‚ä½•å®ç°Eureka Serverçš„HAã€‚å‚è€ƒå·¥ç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚ </p><blockquote><p><code>Tips</code>ï¼šä»£ç ç¤ºä¾‹:<a href="https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-ha" target="_blank" rel="noopener">https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-ha</a></p></blockquote><p><img src="/images/sc-study/sc-eureka-ha-01.png" alt="å‚è€ƒå·¥ç¨‹"></p><h2 id="Eureka-Serverçš„HA"><a href="#Eureka-Serverçš„HA" class="headerlink" title="Eureka Serverçš„HA"></a>Eureka Serverçš„HA</h2><h3 id="Eureka-Serverçš„HA-1"><a href="#Eureka-Serverçš„HA-1" class="headerlink" title="Eureka Serverçš„HA"></a>Eureka Serverçš„HA</h3><h4 id="ä¸¤ä¸ªå·¥ç¨‹æ¼”ç¤ºHA"><a href="#ä¸¤ä¸ªå·¥ç¨‹æ¼”ç¤ºHA" class="headerlink" title="ä¸¤ä¸ªå·¥ç¨‹æ¼”ç¤ºHA"></a>ä¸¤ä¸ªå·¥ç¨‹æ¼”ç¤ºHA</h4><p> å¦‚ç¤ºä¾‹å·¥ç¨‹æ‰€ç¤ºï¼Œæˆ‘æ–°å»ºäº†ä¸¤ä¸ªProjectåˆ†åˆ«ä¸ºsc-eureka-ha-server1ï¼Œsc-eureka-ha-server2ï¼Œ æˆ‘ä»¬çŸ¥é“åœ¨Eureka Serverçš„Standaloneæ¨¡å¼ä¸‹é¢ï¼Œç”±äºåªæœ‰ä¸€ä¸ªEureka Serverï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡é…ç½®å¦‚ä¸‹ä¿¡æ¯å…³é—­Eureka Serverçš„è‡ªæˆ‘æ³¨å†Œå’ŒæŠ“å–æ³¨å†Œä¿¡æ¯ï¼Œä½†æ˜¯ä¸¤ä¸ªEureka Serverä¹‹é—´éœ€è¦è®¾ç½®ä¸ºTrueï¼Œç›¸äº’æ³¨å†Œç›¸äº’æ„ŸçŸ¥å¯¹æ–¹æ³¨å†Œä¿¡æ¯çš„å˜åŒ–ï¼Œä»è€Œå®ç°ä¿¡æ¯åŒæ­¥ã€‚<br> 1.sc-eureka-ha-server1çš„application.ymlé…ç½®Info å¦‚ä¸‹ï¼š</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-ha-server1</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span>                    <span class="comment"># æŒ‡å®šè¯¥Eurekaå®ä¾‹çš„ç«¯å£</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8762/eureka/</span></span><br></pre></td></tr></table></figure><p> 2.sc-eureka-ha-server2çš„application.ymlé…ç½®Info å¦‚ä¸‹</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-ha-server2</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8762</span>                    <span class="comment"># æŒ‡å®šè¯¥Eurekaå®ä¾‹çš„ç«¯å£</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure><p> 3.ä¸»ç¨‹åºå…¥å£ä»£ç æ²¡ä»€ä¹ˆåŒºåˆ«å¦‚ä¸‹:<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(EurekaServerApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p> 4.åˆ†åˆ«å¯åŠ¨sc-eureka-ha-server1å’Œsc-eureka-ha-server2ï¼Œè®¿é—®<a href="http://localhost:8761/" target="_blank" rel="noopener">http://localhost:8761/</a> ,<a href="http://localhost:8762/" target="_blank" rel="noopener">http://localhost:8762/</a> ï¼Œå¦‚ä¸‹:<br><img src="/images/sc-study/sc-e-ha-02.png" alt="å¯åŠ¨Eureka Server01"></p><p><img src="/images/sc-study/sc-e-ha-03.png" alt="å¯åŠ¨Eureka Server02"></p><p> 5.æœåŠ¡æä¾›è€…sc-eureka-ha-providerå…¶å®ƒä»£ç è§å·¥ç¨‹,application.ymlå¦‚ä¸‹æ‰€ç¤ºã€‚<br> <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr"> server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8000</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-ha-provider</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure></p><blockquote><p><code>tips:</code> æŠŠæœåŠ¡æä¾›è€…çš„æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼Œæ³¨å†Œåˆ°Eureka Server 01ä¸Šã€‚</p></blockquote><p>å¯åŠ¨æœåŠ¡æä¾›è€…ï¼Œè§å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br> <img src="/images/sc-study/sc-e-ha-04.png" alt="æœåŠ¡æä¾›è€…æ³¨å†ŒEureka Server01"><br>ç‰‡åˆ»æœåŠ¡æä¾›è€…çš„ä¿¡æ¯ä¹ŸåŒæ­¥åˆ°Eureka Server02ä¸Šé¢<br> <img src="/images/sc-study/sc-e-ha-05.png" alt="æœåŠ¡æä¾›è€…ä¿¡æ¯åŒæ­¥åˆ°Eureka Server02"></p><h4 id="Jaræ–¹å¼æ¼”ç¤ºHA"><a href="#Jaræ–¹å¼æ¼”ç¤ºHA" class="headerlink" title="Jaræ–¹å¼æ¼”ç¤ºHA"></a>Jaræ–¹å¼æ¼”ç¤ºHA</h4><p> Eureka Serverçš„HAï¼Œå…¶å®å¯ä»¥é€šè¿‡<code>jarçš„æ–¹å¼</code>æŒ‡å®šä½¿ç”¨ä¸åŒçš„<code>profileé…ç½®</code>çš„æ–¹å¼ï¼Œåœ¨æœ¬åœ°è¿è¡Œä¸¤ä¸ª<code>Eureka Server</code>ã€‚åªéœ€å°†Eureka serverçš„application.ymlä¿®æ”¹å¦‚ä¸‹ï¼š<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-ha-server</span>  </span><br><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">   profiles:</span> <span class="string">peer1</span>                                 </span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">   port:</span> <span class="number">8761</span> </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">   instance:</span></span><br><span class="line"><span class="attr">      hostname:</span> <span class="string">peer1.xujin.org</span>  </span><br><span class="line"><span class="attr">   client:</span>                                    </span><br><span class="line"><span class="attr">      serviceUrl:</span></span><br><span class="line"><span class="attr">         defaultZone:</span> <span class="attr">http://peer2.xujin.org:8762/eureka/</span> </span><br><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr"> profiles:</span> <span class="string">peer2</span> </span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">   port:</span> <span class="number">8762</span> </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">   instance:</span></span><br><span class="line"><span class="attr">      hostname:</span> <span class="string">peer2.xujin.org</span></span><br><span class="line"><span class="attr">   client:</span></span><br><span class="line"><span class="attr">     serviceUrl:</span></span><br><span class="line"><span class="attr">        defaultZone:</span> <span class="attr">http://peer1.xujin.org:8761/eureka/</span></span><br></pre></td></tr></table></figure></p><p>é€šè¿‡é…ç½®switcHostsæˆ–è€…è‡ªè¡Œé…ç½®HostNameå¯¹åº”çš„IPåœ°å€,æŠŠå·¥ç¨‹æ‰“æˆjarä¹‹åï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> java -jar sc-eureka-ha-server1-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer2</span><br><span class="line"></span><br><span class="line">java -jar sc-eureka-ha-server1-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer1</span><br></pre></td></tr></table></figure></p><p>æµ‹è¯•å¦‚ä¸‹:<br><img src="/images/sc-study/sc-e-ha-06.png" alt="è®¿é—®Eureka Server HAéªŒè¯"><br><img src="/images/sc-study/sc-e-ha-07.png" alt="è®¿é—®Eureka Server HAéªŒè¯"></p><h2 id="å®‰å…¨èº«ä»½éªŒè¯"><a href="#å®‰å…¨èº«ä»½éªŒè¯" class="headerlink" title="å®‰å…¨èº«ä»½éªŒè¯"></a>å®‰å…¨èº«ä»½éªŒè¯</h2><p>   å¦‚æœå®¢æˆ·ç«¯çš„eureka.client.serviceUrl.defaultZoneå‚æ•°å€¼(å³Eureka Serverçš„åœ°å€)ä¸­åŒ…å«HTTP Basic Authenticationä¿¡æ¯ï¼Œå¦‚<a href="http://user:password@localhost:8761/eureka" target="_blank" rel="noopener">http://user:password@localhost:8761/eureka</a>ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°±ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥ç”¨æˆ·åã€å¯†ç ä¿¡æ¯ä¸EurekaæœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ã€‚å¦‚æœä½ éœ€è¦æ›´å¤æ‚çš„éªŒè¯é€»è¾‘ï¼Œä½ å¿…é¡»æ³¨å†Œä¸€ä¸ªDiscoveryClientOptionalArgsç»„ä»¶ï¼Œå¹¶å°†ClientFilterç»„ä»¶æ³¨å…¥ï¼Œåœ¨è¿™é‡Œå®šä¹‰çš„é€»è¾‘ä¼šåœ¨æ¯æ¬¡å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚æ—¶æ‰§è¡Œã€‚</p><blockquote><p><code>Tips</code>ï¼šä»£ç ç¤ºä¾‹:<a href="https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-security" target="_blank" rel="noopener">https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-security</a></p></blockquote><h3 id="è®¿é—®Eureka-Serverå®‰å…¨èº«ä»½éªŒè¯"><a href="#è®¿é—®Eureka-Serverå®‰å…¨èº«ä»½éªŒè¯" class="headerlink" title="è®¿é—®Eureka Serverå®‰å…¨èº«ä»½éªŒè¯"></a>è®¿é—®Eureka Serverå®‰å…¨èº«ä»½éªŒè¯</h3><ol><li><p>å¦‚å·¥ç¨‹sc-eureka-securitä¸­çš„sc-eureka-security-serverå·¥ç¨‹æ‰€ç¤ºï¼Œåœ¨pom.xmlä¸­å¢åŠ ä¾èµ–å¦‚ä¸‹:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>application.ymlå¦‚ä¸‹</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">  server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span>                    <span class="comment"># æŒ‡å®šè¯¥Eurekaå®ä¾‹çš„ç«¯å£</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line">    <span class="comment">#è¡¨ç¤ºæ˜¯å¦å°†è‡ªå·±æ³¨å†Œåˆ°Eureka Serverä¸Šï¼Œé»˜è®¤ä¸ºtrueï¼Œå½“å‰åº”ç”¨ä¸ºEureka Serveræ‰€ä»¥æ— éœ€æ³¨å†Œ</span></span><br><span class="line"><span class="attr">    registerWithEureka:</span> <span class="literal">false</span>  </span><br><span class="line">    <span class="comment">#è¡¨ç¤ºæ˜¯å¦ä»Eureka Serverè·å–æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªå•ç‚¹çš„Eureka Serverï¼Œä¸éœ€è¦åŒæ­¥å…¶ä»–çš„Eureka ServerèŠ‚ç‚¹çš„æ•°æ®ï¼Œæ•…è€Œè®¾ä¸ºfalseã€‚ </span></span><br><span class="line"><span class="attr">    fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#Eureka Serverçš„è®¿é—®åœ°å€ï¼ŒæœåŠ¡æ³¨å†Œå’Œclientè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯å‡é€šè¿‡è¯¥URLï¼Œå¤šä¸ªæœåŠ¡æ³¨å†Œåœ°å€ç”¨,éš”å¼€</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">  basic:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">     name:</span> <span class="string">xujin</span></span><br><span class="line"><span class="attr">     password:</span> <span class="number">123</span></span><br></pre></td></tr></table></figure><p>3.å¯åŠ¨Eureka serveræµ‹è¯•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="/images/sc-study/sc-e-s-01.png" alt="è®¿é—®Eureka Serverå®‰å…¨éªŒè¯"></p><h3 id="æœåŠ¡æä¾›è€…æ³¨å†ŒEureka-Serverå®‰å…¨èº«ä»½éªŒè¯"><a href="#æœåŠ¡æä¾›è€…æ³¨å†ŒEureka-Serverå®‰å…¨èº«ä»½éªŒè¯" class="headerlink" title="æœåŠ¡æä¾›è€…æ³¨å†ŒEureka Serverå®‰å…¨èº«ä»½éªŒè¯"></a>æœåŠ¡æä¾›è€…æ³¨å†ŒEureka Serverå®‰å…¨èº«ä»½éªŒè¯</h3><p>1.æœåŠ¡æä¾›è€…åªéœ€æ³¨å†Œæ—¶ä¿®æ”¹application.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr"> server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8000</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-security-provider</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://xujin:123@localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure><blockquote><p>Tips:å¦‚ä¸Šæ‰€ç¤º:<a href="http://ç”¨æˆ·å:å¯†ç @localhost:8761/eureka/" target="_blank" rel="noopener">http://ç”¨æˆ·å:å¯†ç @localhost:8761/eureka/</a></p></blockquote></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:åœ¨ã€Šè·Ÿæˆ‘å­¦Spring Cloudã€‹ä¸­çš„ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ç®€å•ä»‹ç»äº†ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»ä¸€ä¸‹Eureka Serveræ³¨å†Œä¸­å¿ƒçš„HAä»¥åŠEureka Serverçš„èº«ä»½éªŒè¯ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="è·Ÿæˆ‘å­¦Spring Cloud" scheme="http://xujin.org/categories/%E8%B7%9F%E6%88%91%E5%AD%A6Spring-Cloud/"/>
    
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/tags/Spring-Cloud-Eureka/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Spring Cloud Eurekaå®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°</title>
    <link href="http://xujin.org/sc/sc-eureka-01/"/>
    <id>http://xujin.org/sc/sc-eureka-01/</id>
    <published>2017-03-23T06:00:00.000Z</published>
    <updated>2019-01-12T03:48:54.822Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:ç”±äºç›®å‰ï¼Œ<code>ç½‘ä¸Šçš„Spring Cloudçš„å­¦ä¹ çš„æ¡ˆåˆ—</code>ï¼Œæ¯”è¾ƒ<code>å‡Œä¹±</code>è€Œä¸”<code>æ²¡æœ‰å½¢æˆæ•´ä¸ªä½“ç³»</code>ï¼Œå› æ­¤ç‰¹å¼€ä¸€ä¸ªä¸“é¢˜ä¸º<code>è·Ÿæˆ‘å­¦Spring Cloud</code>ï¼Œå¸Œæœ›å¸®åŠ©åˆ°<code>æœ‰éœ€è¦çš„äºº</code>ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨<code>Spring Cloudä¸­çš„Eurekaç»„ä»¶</code>å¿«é€Ÿå®ç°<code>å¾®æœåŠ¡çš„æœåŠ¡æ³¨å†Œä¸å‘ç°</code>ã€‚è‡³äºå®‰å…¨æ¨¡å¼å’ŒEureka Serverçš„HA,åé¢çš„æ–‡ç« ä¼šè¯¦ç»†ä»‹ç»ã€‚å¦‚æœæ‚¨è§‰å¾—ï¼Œæœ‰æƒ³äº†è§£çš„å†…å®¹ï¼Œå‚ä¸è¯„è®ºç•™è¨€ã€‚<br><a id="more"></a></p><h2 id="ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°"><a href="#ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°" class="headerlink" title="ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°"></a>ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°</h2><h3 id="æœåŠ¡æ³¨å†Œä¸å‘ç°"><a href="#æœåŠ¡æ³¨å†Œä¸å‘ç°" class="headerlink" title="æœåŠ¡æ³¨å†Œä¸å‘ç°"></a>æœåŠ¡æ³¨å†Œä¸å‘ç°</h3><p>   åœ¨æœåŠ¡åŒ–çš„æ—©æœŸï¼ŒæœåŠ¡ä¸æ˜¯å¾ˆå¤šï¼ŒæœåŠ¡çš„æ³¨å†Œä¸å‘ç°å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œçš„åè¯ï¼ŒNginx+å†…éƒ¨åŸŸåæœåŠ¡å™¨æ–¹å¼ï¼Œç”šè‡³Nginx+hostæ–‡ä»¶é…ç½®æ–¹å¼ä¹Ÿèƒ½å®ŒæˆæœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚æœåŠ¡ä¸Šä¸‹çº¿éœ€è¦åœ¨nginx,æœåŠ¡å™¨åšç›¸åº”çš„é…ç½®ï¼Œä¸€æ—¦æœåŠ¡çš„IPç«¯å£å‘ç”Ÿå˜åŒ–ï¼Œéƒ½éœ€è¦åœ¨nginxä¸Šåšç›¸åº”çš„é…ç½®ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å¼•å…¥æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚<br>   æœåŠ¡æ³¨å†Œ,å³æœåŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™å°±å°†æœåŠ¡çš„IP,ç«¯å£,ç‰ˆæœ¬å·ç­‰EndPointæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ(Eueka,Zookeeper,Consul)å¯¹æœåŠ¡è¿›è¡Œç»Ÿä¸€ç®¡ç†.<br>   æœåŠ¡å‘ç°,ç®€å•çš„å°±æ˜¯è¯´ï¼Œä¸ç®¡æœåŠ¡ä¸Šä¸‹çº¿ï¼Œå½“å¯¹æŸä¸ªæœåŠ¡å‘èµ·è¯·æ±‚æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿçš„ä»æœ¬åœ°ç¼“å­˜æˆ–è€…æ³¨å†Œä¸­å¿ƒçš„æ³¨å†Œåˆ—è¡¨ä¸­ï¼Œå¿«é€Ÿæ‰¾åˆ°æœåŠ¡æä¾›è€…ã€‚</p><h2 id="æœåŠ¡åŒ–æ—©æœŸçš„åšæ³•"><a href="#æœåŠ¡åŒ–æ—©æœŸçš„åšæ³•" class="headerlink" title="æœåŠ¡åŒ–æ—©æœŸçš„åšæ³•"></a>æœåŠ¡åŒ–æ—©æœŸçš„åšæ³•</h2><h3 id="ç¤ºä¾‹å·¥ç¨‹è¯´æ˜"><a href="#ç¤ºä¾‹å·¥ç¨‹è¯´æ˜" class="headerlink" title="ç¤ºä¾‹å·¥ç¨‹è¯´æ˜"></a>ç¤ºä¾‹å·¥ç¨‹è¯´æ˜</h3><blockquote><p><code>Tips</code>ï¼šä»£ç ç¤ºä¾‹:<a href="https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-first" target="_blank" rel="noopener">https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-first</a></p></blockquote><p><img src="/images/sc-study/sc-e-p.png" alt="å‚è€ƒå·¥ç¨‹"></p><h3 id="Spring-MVCä¸­åŸºäºæ— çŠ¶æ€çš„REST"><a href="#Spring-MVCä¸­åŸºäºæ— çŠ¶æ€çš„REST" class="headerlink" title="Spring MVCä¸­åŸºäºæ— çŠ¶æ€çš„REST"></a>Spring MVCä¸­åŸºäºæ— çŠ¶æ€çš„REST</h3><p>   å·¥ç¨‹å¯ä»¥å‚è€ƒsc-rest-demoä¸‹é¢çš„sc-rest-providerå’Œsc-rest-consumerï¼Œå…·ä½“ä½¿ç”¨å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/sc"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»å±æ€§æ–‡ä»¶ä¸­è¯»å–æœåŠ¡æä¾›çš„URL</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;order.orderServiceUrl&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String orderServiceUrl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/consumer/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> OrderModel <span class="title">getOrderInfo</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line"><span class="comment">// this.restTemplate.getForObject("http://localhost:8000/sc/order/" +</span></span><br><span class="line"><span class="comment">// id,OrderModel.class);</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(<span class="keyword">this</span>.orderServiceUrl + <span class="string">"/sc/order/"</span> + id,</span><br><span class="line">OrderModel.class);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>å¤§å®¶æ³¨æ„åˆ°æ²¡ï¼ŒæŠŠ<a href="http://localhost:8000" target="_blank" rel="noopener">http://localhost:8000</a> ,ç¡¬ç¼–ç åˆ°ç¨‹åºä¸­ï¼Œæ˜¯ä¸æ˜¯æ¯”è¾ƒlowã€‚å¯ä»¥é‡‡ç”¨ä¸Šé¢ä»£ç ä¸­çš„æ–¹å¼ï¼šorderServiceUrlè§£å†³ã€‚ä½†æ˜¯è¿™æ ·è¿˜æ˜¯æ¯”è¾ƒlow,ä¸‹é¢ä»‹ç»ä¸€ä¸‹å¼•å…¥Eurekaå®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°çš„å¤„ç†ã€‚</p></blockquote><h2 id="ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°"><a href="#ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°" class="headerlink" title="ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°"></a>ä½¿ç”¨Eurekaå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°</h2><h3 id="æ­å»ºæ³¨å†Œä¸­å¿ƒ-Eureka-Server"><a href="#æ­å»ºæ³¨å†Œä¸­å¿ƒ-Eureka-Server" class="headerlink" title="æ­å»ºæ³¨å†Œä¸­å¿ƒ-Eureka Server"></a>æ­å»ºæ³¨å†Œä¸­å¿ƒ-Eureka Server</h3><p>  1.å¼•å…¥ä¾èµ–<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- å¼•å…¥spring bootçš„ä¾èµ– --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sc-eureka-first-server-HA01<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>sc-eureka-first-server-HA01<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- å¼•å…¥Spring Cloud Eurekaä¾èµ– --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- å¼•å…¥spring cloudçš„ä¾èµ– --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Camden.SR5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- æ·»åŠ spring-bootçš„mavenæ’ä»¶--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><ol><li>åœ¨Resourcesç›®å½•ä¸‹åˆ›å»ºapplication.yml<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span>                    <span class="comment"># æŒ‡å®šè¯¥Eurekaå®ä¾‹çš„ç«¯å£</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line">    <span class="comment">#è¡¨ç¤ºæ˜¯å¦å°†è‡ªå·±æ³¨å†Œåˆ°Eureka Serverä¸Šï¼Œé»˜è®¤ä¸ºtrueï¼Œå½“å‰åº”ç”¨ä¸ºEureka Serveræ‰€ä»¥æ— éœ€æ³¨å†Œ</span></span><br><span class="line"><span class="attr">    registerWithEureka:</span> <span class="literal">false</span>  </span><br><span class="line">    <span class="comment">#è¡¨ç¤ºæ˜¯å¦ä»Eureka Serverè·å–æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªå•ç‚¹çš„Eureka Serverï¼Œä¸éœ€è¦åŒæ­¥å…¶ä»–çš„Eureka ServerèŠ‚ç‚¹çš„æ•°æ®ï¼Œæ•…è€Œè®¾ä¸ºfalseã€‚ </span></span><br><span class="line"><span class="attr">    fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#Eureka Serverçš„è®¿é—®åœ°å€ï¼ŒæœåŠ¡æ³¨å†Œå’Œclientè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯å‡é€šè¿‡è¯¥URLï¼Œå¤šä¸ªæœåŠ¡æ³¨å†Œåœ°å€ç”¨,éš”å¼€</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚è€ƒæ–‡æ¡£ï¼šhttp://projects.spring.io/spring-cloud/docs/1.0.3/spring-cloud.html#_standalone_mode</span></span><br><span class="line"><span class="comment"># å‚è€ƒæ–‡æ¡£ï¼šhttp://my.oschina.net/buwei/blog/618756</span></span><br></pre></td></tr></table></figure></li></ol><p>3.åˆ›å»ºSpring Bootä¸»åº”ç”¨ç¨‹åºå¯åŠ¨ä»£ç <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.eureka.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Eureka Server</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xujin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudEurekaServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(SpringCloudEurekaServer.class, args);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯åŠ¨Eureka serveræµ‹è¯•ï¼š<br>  å¯åŠ¨sc-eureka-first-server-HA01ï¼Œè®¿é—®<a href="http://localhost:8761/" target="_blank" rel="noopener">http://localhost:8761/</a> ,å¦‚ä¸‹å›¾æ‰€ç¤º:</p><p>  <img src="/images/sc-study/sc-e-1.png" alt="Eureka server"></p><h3 id="åˆ›å»ºæœåŠ¡æä¾›è€…"><a href="#åˆ›å»ºæœåŠ¡æä¾›è€…" class="headerlink" title="åˆ›å»ºæœåŠ¡æä¾›è€…"></a>åˆ›å»ºæœåŠ¡æä¾›è€…</h3><p>  1.æœåŠ¡æä¾›è€…ï¼Œä¸ºäº†æ¼”ç¤ºåœ¨è¿™é‡Œæä¾›ä¸€ä¸ªç®€å•çš„<code>è®¢å•æŸ¥è¯¢æœåŠ¡</code>ï¼Œå¦‚å·¥ç¨‹<code>sc-eureka-first-provider01</code>å’Œ<code>sc-eureka-first-provider02</code>æ‰€ç¤ºã€‚<br>  2.ä¸»ç¨‹åºå…¥å£ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.eureka.first.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœåŠ¡æä¾›è€…ç«¯ï¼ŒåŠ ä¸Š<span class="doctag">@EnableDiscoveryClient</span>æ³¨è§£ï¼Œå®ŒæˆæœåŠ¡æ³¨å†Œã€‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xujin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@site</span> http://xujin.org</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="comment">// @EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderProviderSpringBootAppliaction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(OrderProviderSpringBootAppliaction.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p><code>Tips</code>:å¦‚æœä½¿ç”¨Eureka, å¯ä»¥ä½¿ç”¨@EnableEurekaClientæ³¨è§£ï¼Œä½†æ˜¯æ¨èä½¿ç”¨@EnableDiscoveryClientä»£æ›¿@EnableEurekaClientæ³¨è§£ï¼Œå› ä¸º@EnableDiscoveryClientæ˜¯ä¸€ä¸ªé«˜åº¦çš„æŠ½è±¡ï¼Œ æ¥è‡ªäºspring-cloud-commonsï¼Œ ç”±äºSpring Cloudé€‰å‹æ˜¯ä¸­ç«‹çš„å› æ­¤æŠ½è±¡å‡ºè¯¥æ¥å£ï¼Œ å½“æœåŠ¡æ³¨å†Œä¸­å¿ƒé€‰å‹æ”¹å˜ä¸ºEurekaï¼ŒZKï¼ŒConsulæ—¶ï¼Œä¸éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç ä¸­çš„æ³¨è§£ã€‚</p></blockquote><p>3.æœåŠ¡æä¾›è€…æš´éœ²çš„æœåŠ¡-OrderController.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/sc/order/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> OrderModel <span class="title">findOrderById</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">OrderModel orderModel = orderService.findOrderByOrderId(id);</span><br><span class="line"><span class="keyword">return</span> orderModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯åŠ¨æœåŠ¡æä¾›è€…ï¼ŒæŠŠæœåŠ¡æ³¨å†Œä¿¡æ¯ï¼Œæ³¨å†Œåˆ°Eureka Serveræ³¨å†Œä¸­å¿ƒ<br>å¯åŠ¨sc-eureka-first-provider01,å½“å¯åŠ¨å…¶ä¸­ä¸€ä¸ªæœåŠ¡ååˆ·æ–°Eureka Serverä¼šå‡ºç°å®‰å…¨æ¨¡å¼,å¦‚ä¸‹å›¾æ‰€ç¤º:<br><img src="/images/sc-study/sc-e-safe.png" alt="å®‰å…¨æ¨¡å¼"></p><p>å¯åŠ¨sc-eureka-first-provider02ï¼Œåˆ·æ–°Eureka Serverå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><img src="/images/sc-study/sc-e-safe-2.png" alt="å®‰å…¨æ¨¡å¼"></p><h3 id="åˆ›å»ºæœåŠ¡æ¶ˆè´¹è€…"><a href="#åˆ›å»ºæœåŠ¡æ¶ˆè´¹è€…" class="headerlink" title="åˆ›å»ºæœåŠ¡æ¶ˆè´¹è€…"></a>åˆ›å»ºæœåŠ¡æ¶ˆè´¹è€…</h3><p> æœåŠ¡æ¶ˆè´¹è€…ä¸»è¦æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æˆ·æœåŠ¡ï¼Œç”¨æˆ·æœåŠ¡æŸ¥è¯¢è®¢å•æœåŠ¡çš„è®¢å•ä¿¡æ¯ã€‚<br> 1.å¼•å…¥ç›¸åº”çš„ä¾èµ–<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xujin.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sc-eureka-first-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>sc-eureka-first-consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- å¼•å…¥spring bootçš„ä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- å¼•å…¥spring cloudçš„ä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>Camden.SR4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- æ·»åŠ spring-bootçš„mavenæ’ä»¶ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2.ä¸»ç¨‹åºå…¥å£ä»£ç <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.eureka.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¶ˆè´¹è€…ç«¯åŠ å…¥æœåŠ¡å‘ç°æ³¨è§£</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(UserConsumerApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ol><li>æ¶ˆè´¹è€…è°ƒç”¨Controllerã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(UserController.class);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">// discoveryClientè·å–æœåŠ¡åˆ—è¡¨ä¸­ï¼Œåº”ç”¨åä¸ºsc-eureka-first-providerä¸€ä¸ªæœåŠ¡æ³¨å†Œä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serviceUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">List&lt;ServiceInstance&gt; list = discoveryClient</span><br><span class="line">.getInstances(<span class="string">"sc-eureka-first-provider"</span>);</span><br><span class="line"><span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> String.valueOf(list.get(<span class="number">0</span>).getUri());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/sc/user/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Order <span class="title">findByIdByEurekaServer</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">String providerServiceUrl = serviceUrl();</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(providerServiceUrl + <span class="string">"sc/order/"</span> + id,</span><br><span class="line">Order.class);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚ä¸Šè¿°ä»£ç ï¼Œæ‰€ç¤ºä½¿ç”¨<code>discoveryClient.getInstances(&quot;sc-eureka-first-provider&quot;)</code>è·å–æœåŠ¡åä¸º<code>sc-eureka-first-provider</code>çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¿¡æ¯ã€‚</p></blockquote><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>å…ˆåå¯åŠ¨sc-eureka-first-consumer,å¦‚æ²¡æœ‰å¼‚å¸¸ï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®:<a href="http://localhost:8010/sc/user/2" target="_blank" rel="noopener">http://localhost:8010/sc/user/2</a> ,debugå¦‚ä¸‹æ‰€ç¤ºå¯ä»¥çœ‹åˆ°<br><img src="/images/sc-study/sc-e-consumer-1.png" alt="æœåŠ¡æä¾›è€…ç«¯æœåŠ¡å‘ç°"></p><p>åœ¨åˆ·æ–°ä¸€ä¸‹Eureka Serverï¼Œå¦‚å›¾ä¸‹æ‰€ç¤º,æ­¤æ—¶å®‰å…¨æ¨¡å¼å…³é—­ã€‚<br><img src="/images/sc-study/sc-e-safe-3.png" alt="Eureka Server"></p><blockquote><p>å…³äºå®‰å…¨æ¨¡å¼ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæš‚ä¸è®¨è®ºï¼Œåé¢å°†ä¼šä¸“å†™ä¸€ç¯‡æ–‡ç« ä»‹ç»ï¼Œè¯·æš‚æ—¶å¿½ç•¥ã€‚</p></blockquote><h3 id="è·å–æ¶ˆè´¹è€…è·å–æœåŠ¡ç«¯æ¶ˆè´¹åˆ—è¡¨"><a href="#è·å–æ¶ˆè´¹è€…è·å–æœåŠ¡ç«¯æ¶ˆè´¹åˆ—è¡¨" class="headerlink" title="è·å–æ¶ˆè´¹è€…è·å–æœåŠ¡ç«¯æ¶ˆè´¹åˆ—è¡¨"></a>è·å–æ¶ˆè´¹è€…è·å–æœåŠ¡ç«¯æ¶ˆè´¹åˆ—è¡¨</h3><ol><li><p>ä½¿ç”¨EurekaClientè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EurekaClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serviceUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InstanceInfo instance = discoveryClient.getNextServerFromEureka(<span class="string">"STORES"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> instance.getHomePageUrl();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨DiscoveryClientè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serviceUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">"STORES"</span>);</span><br><span class="line">    <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> list.get(<span class="number">0</span>).getUri();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒé“¾æ¥ï¼š<a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/master/docs/src/main/asciidoc/spring-cloud-netflix.adoc" target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-netflix/blob/master/docs/src/main/asciidoc/spring-cloud-netflix.adoc</a></p></li></ol><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p> ä¸Šé¢è¿™ä¸ªä¾‹å­ä½¿ç”¨Eurekaå®ç°äº†æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯è·å–æœåŠ¡æ³¨å†Œåˆ—è¡¨çš„æ–¹å¼æ¯”è¾ƒlowå¹¶ä¸”å¤ªæ–¹ä¾¿ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ²¡æœ‰ä½¿ç”¨è´Ÿè½½å‡è¡¡ï¼ˆLoad Balance)ï¼Œè¿™æ ·å°±æ²¡æ³•å®ç°å¾®æœåŠ¡çš„HAã€‚åœ¨åé¢çš„æ–‡ç« å°†ä¼šä»‹ç»Eureka Serverçš„HAå’Œä½¿ç”¨Robbinå®ç°LBã€‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:ç”±äºç›®å‰ï¼Œ&lt;code&gt;ç½‘ä¸Šçš„Spring Cloudçš„å­¦ä¹ çš„æ¡ˆåˆ—&lt;/code&gt;ï¼Œæ¯”è¾ƒ&lt;code&gt;å‡Œä¹±&lt;/code&gt;è€Œä¸”&lt;code&gt;æ²¡æœ‰å½¢æˆæ•´ä¸ªä½“ç³»&lt;/code&gt;ï¼Œå› æ­¤ç‰¹å¼€ä¸€ä¸ªä¸“é¢˜ä¸º&lt;code&gt;è·Ÿæˆ‘å­¦Spring Cloud&lt;/code&gt;ï¼Œå¸Œæœ›å¸®åŠ©åˆ°&lt;code&gt;æœ‰éœ€è¦çš„äºº&lt;/code&gt;ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨&lt;code&gt;Spring Cloudä¸­çš„Eurekaç»„ä»¶&lt;/code&gt;å¿«é€Ÿå®ç°&lt;code&gt;å¾®æœåŠ¡çš„æœåŠ¡æ³¨å†Œä¸å‘ç°&lt;/code&gt;ã€‚è‡³äºå®‰å…¨æ¨¡å¼å’ŒEureka Serverçš„HA,åé¢çš„æ–‡ç« ä¼šè¯¦ç»†ä»‹ç»ã€‚å¦‚æœæ‚¨è§‰å¾—ï¼Œæœ‰æƒ³äº†è§£çš„å†…å®¹ï¼Œå‚ä¸è¯„è®ºç•™è¨€ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="è·Ÿæˆ‘å­¦Spring Cloud" scheme="http://xujin.org/categories/%E8%B7%9F%E6%88%91%E5%AD%A6Spring-Cloud/"/>
    
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/tags/Spring-Cloud-Eureka/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud EurekaæœåŠ¡ä¸‹çº¿(Cancel)æºç åˆ†æ</title>
    <link href="http://xujin.org/sc/sc-eureka-cancle/"/>
    <id>http://xujin.org/sc/sc-eureka-cancle/</id>
    <published>2016-11-19T06:00:00.000Z</published>
    <updated>2019-01-12T04:25:00.258Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä¸»è¦å¯¹Eurekaçš„Cancel(æœåŠ¡ä¸‹çº¿)è¿›è¡Œæºç åˆ†æï¼Œåœ¨Service ProvideræœåŠ¡shut downçš„æ—¶å€™ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥Eureka ServeræŠŠè‡ªå·±å‰”é™¤ï¼Œä»è€Œé¿å…å…¶å®ƒå®¢æˆ·ç«¯è°ƒç”¨å·²ç»ä¸‹çº¿çš„æœåŠ¡ï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚</p><h2 id="Cancel-æœåŠ¡ä¸‹çº¿"><a href="#Cancel-æœåŠ¡ä¸‹çº¿" class="headerlink" title="Cancel(æœåŠ¡ä¸‹çº¿)"></a>Cancel(æœåŠ¡ä¸‹çº¿)</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>åœ¨Service ProvideræœåŠ¡shut downçš„æ—¶å€™ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥Eureka ServeræŠŠè‡ªå·±å‰”é™¤ï¼Œä»è€Œé¿å…å®¢æˆ·ç«¯è°ƒç”¨å·²ç»ä¸‹çº¿çš„æœåŠ¡ã€‚</p><h2 id="æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ"><a href="#æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ" class="headerlink" title="æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ"></a>æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ</h2><ol><li>åœ¨eureka-client-1.4.1ä¸­çš„com.netflix.discovery.DiscoveryClientä¸­shutdown()çš„<code>867</code>è¡Œã€‚<a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Shuts down Eureka Client. Also sends a deregistration request to the</span></span><br><span class="line"><span class="comment">    * eureka server.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PreDestroy</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (isShutdown.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">           logger.info(<span class="string">"Shutting down DiscoveryClient ..."</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (statusChangeListener != <span class="keyword">null</span> &amp;&amp; applicationInfoManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">               applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           cancelScheduledTasks();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If APPINFO was registered</span></span><br><span class="line">           <span class="keyword">if</span> (applicationInfoManager != <span class="keyword">null</span> &amp;&amp; clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">               applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN);</span><br><span class="line">               <span class="comment">//è°ƒç”¨ä¸‹çº¿æ¥å£</span></span><br><span class="line">               unregister();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (eurekaTransport != <span class="keyword">null</span>) &#123;</span><br><span class="line">               eurekaTransport.shutdown();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           heartbeatStalenessMonitor.shutdown();</span><br><span class="line">           registryStalenessMonitor.shutdown();</span><br><span class="line"></span><br><span class="line">           logger.info(<span class="string">"Completed shut down of DiscoveryClient"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ol><blockquote><p><code>Tips</code> <code>@PreDestroy</code>æ³¨è§£æˆ–<code>shutdown()</code>çš„æ–¹æ³•æ˜¯æœåŠ¡ä¸‹çº¿çš„å…¥å£</p></blockquote><ol><li>åœ¨eureka-client-1.4.1ä¸­çš„<code>com.netflix.discovery.DiscoveryClient</code>ä¸­<code>unregisterï¼ˆï¼‰</code>çš„<code>897</code>è¡Œ<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * unregister w/ the eureka service.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">unregister</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// It can be null if shouldRegisterWithEureka == false</span></span><br><span class="line">  <span class="keyword">if</span>(eurekaTransport != <span class="keyword">null</span> &amp;&amp; eurekaTransport.registrationClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         logger.info(<span class="string">"Unregistering ..."</span>);</span><br><span class="line">         <span class="comment">//å‘é€æœåŠ¡ä¸‹çº¿è¯·æ±‚</span></span><br><span class="line">         EurekaHttpResponse&lt;Void&gt; httpResponse = eurekaTransport.registrationClient.cancel(instanceInfo.getAppName(), instanceInfo.getId());</span><br><span class="line">         logger.info(PREFIX + appPathIdentifier + <span class="string">" - deregister  status: "</span> + httpResponse.getStatusCode());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(PREFIX + appPathIdentifier + <span class="string">" - de-registration failed"</span> + e.getMessage(), e);</span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Eureka-ServeræœåŠ¡ä¸‹çº¿å®ç°ç»†èŠ‚"><a href="#Eureka-ServeræœåŠ¡ä¸‹çº¿å®ç°ç»†èŠ‚" class="headerlink" title="Eureka ServeræœåŠ¡ä¸‹çº¿å®ç°ç»†èŠ‚"></a>Eureka ServeræœåŠ¡ä¸‹çº¿å®ç°ç»†èŠ‚</h2><ol><li><p>åœ¨<code>com.netflix.eureka.resources.InstanceResource</code>ä¸­çš„<code>280</code>è¡Œä¸­çš„<code>cancelLease()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DELETE</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">cancelLease</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params"> @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</span><br><span class="line">   <span class="comment">//è°ƒç”¨cancel</span></span><br><span class="line">   <span class="keyword">boolean</span> isSuccess = registry.cancel(app.getName(), id,</span><br><span class="line">                <span class="string">"true"</span>.equals(isReplication));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">     logger.debug(<span class="string">"Found (Cancel): "</span> + app.getName() + <span class="string">" - "</span> + id);</span><br><span class="line">            <span class="keyword">return</span> Response.ok().build();</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     logger.info(<span class="string">"Not Found (Cancel): "</span> + app.getName() + <span class="string">" - "</span> + id);</span><br><span class="line">            <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨<code>org.springframework.cloud.netflix.eureka.server.InstanceRegistry</code>ä¸­çš„<code>95</code>è¡Œçš„<code>cancel()</code>æ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(String appName, String serverId, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">   handleCancelation(appName, serverId, isReplication);</span><br><span class="line">   <span class="comment">//è°ƒç”¨çˆ¶ç±»ä¸­çš„cancel</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">super</span>.cancel(appName, serverId, isReplication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨<code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</code>ä¸­çš„<code>376</code>è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">super</span>.cancel(appName, id, isReplication)) &#123;</span><br><span class="line">            <span class="comment">//æœåŠ¡ä¸‹çº¿æˆåŠŸåï¼ŒåŒæ­¥æ›´æ–°ä¿¡æ¯åˆ°å…¶å®ƒEureka ServerèŠ‚ç‚¹</span></span><br><span class="line">            replicateToPeers(Action.Cancel, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute)</span></span><br><span class="line">                    <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin - <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</span><br><span class="line">                            (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>4.åœ¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImplä¸­çš„<code>618</code>è¡Œï¼Œä¸»è¦æ¥å£å®ç°æ–¹å¼å’ŒregisteråŸºæœ¬ä¸€è‡´ï¼šé¦–å…ˆæ›´æ–°è‡ªèº«Eureka Serverä¸­æœåŠ¡çš„çŠ¶æ€ï¼Œå†åŒæ­¥åˆ°å…¶å®ƒEureka Serverä¸­ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateToPeers</span><span class="params">(Action action, String appName, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InstanceInfo info <span class="comment">/* optional */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InstanceStatus newStatus <span class="comment">/* optional */</span>, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = action.getTimer().start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isReplication) &#123;</span><br><span class="line">                numberOfReplicationsLastMin.increment();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If it is a replication already, do not replicate again as this will create a poison replication</span></span><br><span class="line">            <span class="keyword">if</span> (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åŒæ­¥æŠŠæœåŠ¡ä¿¡æ¯åŒæ­¥åˆ°å…¶å®ƒçš„Eureka Serverä¸­</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123;</span><br><span class="line">                <span class="comment">// If the url represents this host, do not replicate to yourself.</span></span><br><span class="line">                <span class="keyword">if</span> (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//æ ¹æ®actionåšç›¸åº”æ“ä½œçš„åŒæ­¥</span></span><br><span class="line">                replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            tracer.stop();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>è‡³æ­¤ï¼ŒEurekaæœåŠ¡ç»­çº¦æºç åˆ†æç»“æŸï¼Œå¤§å®¶æœ‰å…´è¶£å¯è‡ªè¡Œé˜…è¯»ã€‚</p><h3 id="æºç åˆ†æé“¾æ¥"><a href="#æºç åˆ†æé“¾æ¥" class="headerlink" title="æºç åˆ†æé“¾æ¥"></a>æºç åˆ†æé“¾æ¥</h3><p> å…¶å®ƒæºç åˆ†æé“¾æ¥:<br> Spring Cloudä¸­@EnableEurekaClientæºç åˆ†æ:<br> <a href="http://xujin.org/sc/sc-enableEurekaClient-annonation/">http://xujin.org/sc/sc-enableEurekaClient-annonation/</a><br> Spring Cloud EurekaæœåŠ¡æ³¨å†Œæºç åˆ†æï¼š<br> <a href="http://xujin.org/sc/sc-eureka-register/">http://xujin.org/sc/sc-eureka-register/</a><br> Spring Cloud EurekaæœåŠ¡ç»­çº¦(Renew)æºç åˆ†æ<br> <a href="http://xujin.org/sc/sc-eureka-renew/">http://xujin.org/sc/sc-eureka-renew/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä¸»è¦å¯¹Eurekaçš„Cancel(æœåŠ¡ä¸‹çº¿)è¿›è¡Œæºç åˆ†æï¼Œåœ¨Service ProvideræœåŠ¡shut downçš„æ—¶å€™ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥Eureka ServeræŠŠè‡ªå·±å‰”é™¤ï¼Œä»è€Œé¿å…å…¶å®ƒå®¢æˆ·ç«¯è°ƒç”¨å·²ç»ä¸‹çº¿çš„æœåŠ¡ï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Cancel-æœåŠ¡ä¸‹çº¿&quot;&gt;&lt;a href=&quot;#Cancel-æœåŠ¡ä¸‹çº¿&quot; class=&quot;headerlink&quot; title=&quot;Cancel(æœåŠ¡ä¸‹çº¿)&quot;&gt;&lt;/a&gt;Cancel(æœåŠ¡ä¸‹çº¿)&lt;/h2&gt;&lt;h3 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h3&gt;&lt;p&gt;åœ¨Service ProvideræœåŠ¡shut downçš„æ—¶å€™ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥Eureka ServeræŠŠè‡ªå·±å‰”é™¤ï¼Œä»è€Œé¿å…å®¢æˆ·ç«¯è°ƒç”¨å·²ç»ä¸‹çº¿çš„æœåŠ¡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ&quot;&gt;&lt;a href=&quot;#æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ&quot;&gt;&lt;/a&gt;æœåŠ¡æä¾›è€…ç«¯æºç åˆ†æ&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;åœ¨eureka-client-1.4.1ä¸­çš„com.netflix.discovery.DiscoveryClientä¸­shutdown()çš„&lt;code&gt;867&lt;/code&gt;è¡Œã€‚
    
    </summary>
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/categories/Spring-Cloud-Eureka/"/>
    
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/tags/Spring-Cloud-Eureka/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud EurekaæœåŠ¡ç»­çº¦(Renew)æºç åˆ†æ</title>
    <link href="http://xujin.org/sc/sc-eureka-renew/"/>
    <id>http://xujin.org/sc/sc-eureka-renew/</id>
    <published>2016-11-13T06:00:00.000Z</published>
    <updated>2019-01-12T04:36:27.970Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä¸»è¦å¯¹Eurekaçš„Renew(æœåŠ¡ç»­çº¦)ï¼Œä»æœåŠ¡æä¾›è€…å‘èµ·ç»­çº¦è¯·æ±‚å¼€å§‹åˆ†æï¼Œé€šè¿‡é˜…è¯»æºç å’Œç”»æ—¶åºå›¾çš„æ–¹å¼ï¼Œå±•ç¤ºEurekaæœåŠ¡ç»­çº¦çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚æœåŠ¡ç»­çº¦ä¸»è¦æ˜¯æŠŠæœåŠ¡ç»­çº¦çš„ä¿¡æ¯æ›´æ–°åˆ°è‡ªèº«çš„Eureka Serverä¸­ï¼Œç„¶åå†åŒæ­¥åˆ°å…¶å®ƒEureka Serverä¸­ã€‚</p><h2 id="1-Renew-æœåŠ¡ç»­çº¦"><a href="#1-Renew-æœåŠ¡ç»­çº¦" class="headerlink" title="1. Renew(æœåŠ¡ç»­çº¦)"></a>1. Renew(æœåŠ¡ç»­çº¦)</h2><h3 id="1-1-æ¦‚è¿°"><a href="#1-1-æ¦‚è¿°" class="headerlink" title="1.1 æ¦‚è¿°"></a>1.1 æ¦‚è¿°</h3><p>Renewï¼ˆæœåŠ¡ç»­çº¦ï¼‰æ“ä½œç”±Service Providerå®šæœŸè°ƒç”¨ï¼Œç±»ä¼¼äºheartbeatã€‚ç›®çš„æ˜¯éš”ä¸€æ®µæ—¶é—´Service Providerè°ƒç”¨æ¥å£ï¼Œå‘Šè¯‰Eureka Serverå®ƒè¿˜æ´»ç€æ²¡æŒ‚ï¼Œä¸è¦æŠŠå®ƒTäº†ã€‚é€šä¿—çš„è¯´å°±æ˜¯å®ƒä»¬ä¸¤ä¹‹é—´çš„å¿ƒè·³æ£€æµ‹ï¼Œé¿å…æœåŠ¡æä¾›è€…è¢«å‰”é™¤æ‰ã€‚<br>è¯·å‚è€ƒ:<a href="http://blog.xujin.org/sc/sc-eureka-mid/#åè¯è§£é‡Š" target="_blank" rel="noopener">Spring Cloud Eurekaåè¯è§£é‡Š</a><br><a id="more"></a></p><h3 id="1-2-æœåŠ¡ç»­çº¦é…ç½®"><a href="#1-2-æœåŠ¡ç»­çº¦é…ç½®" class="headerlink" title="1.2 æœåŠ¡ç»­çº¦é…ç½®"></a>1.2 æœåŠ¡ç»­çº¦é…ç½®</h3><p>  Renewæ“ä½œä¼šåœ¨Service Providerå®šæ—¶å‘èµ·ï¼Œç”¨æ¥é€šçŸ¥Eureka Serverè‡ªå·±è¿˜æ´»ç€ã€‚ è¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„é…ç½®éœ€è¦å¦‚ä¸‹ï¼Œå¯ä»¥åœ¨Runä¹‹å‰é…ç½®ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.leaseRenewalIntervalInSeconds</span><br></pre></td></tr></table></figure></p><p>  Renewé¢‘ç‡ã€‚é»˜è®¤æ˜¯<code>30ç§’</code>ï¼Œä¹Ÿå°±æ˜¯æ¯30ç§’ä¼šå‘Eureka Serverå‘èµ·Renewæ“ä½œã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.leaseExpirationDurationInSeconds</span><br></pre></td></tr></table></figure></p><p> æœåŠ¡å¤±æ•ˆæ—¶é—´ã€‚é»˜è®¤æ˜¯<code>90ç§’</code>ï¼Œä¹Ÿå°±æ˜¯å¦‚æœEureka Serveråœ¨90ç§’å†…æ²¡æœ‰æ¥æ”¶åˆ°æ¥è‡ªService Providerçš„Renewæ“ä½œï¼Œå°±ä¼šæŠŠ<code>Service Providerå‰”é™¤</code>ã€‚</p><h2 id="2-Renewæºç åˆ†æ"><a href="#2-Renewæºç åˆ†æ" class="headerlink" title="2. Renewæºç åˆ†æ"></a>2. Renewæºç åˆ†æ</h2><h3 id="2-1-æœåŠ¡æä¾›è€…å®ç°ç»†èŠ‚"><a href="#2-1-æœåŠ¡æä¾›è€…å®ç°ç»†èŠ‚" class="headerlink" title="2.1 æœåŠ¡æä¾›è€…å®ç°ç»†èŠ‚"></a>2.1 æœåŠ¡æä¾›è€…å®ç°ç»†èŠ‚</h3><p> æœåŠ¡æä¾›è€…å‘å‘èµ·æœåŠ¡ç»­çº¦çš„æ—¶åºå›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º,å¤§å®¶å…ˆç›´è§‚çš„çœ‹ä¸€ä¸‹æ—¶åºå›¾ï¼Œç­‰é˜…è¯»å®Œæºç å†å›é¡¾ä¸€ä¸‹ã€‚<br><img src="/images/spring-cloud-netflix/eureka/service-renew.png" alt="æœåŠ¡æä¾›è€…å‘èµ·ç»­çº¦æ—¶åºå›¾"></p><ol><li>åœ¨com.netflix.discovery.DiscoveryClient.initScheduledTasks()ä¸­çš„1272è¡Œï¼ŒTimedSupervisorTaskä¼šå®šæ—¶å‘èµ·æœåŠ¡ç»­çº¦ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Heartbeat timer</span></span><br><span class="line">  scheduler.schedule(</span><br><span class="line">     <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">            <span class="string">"heartbeat"</span>,</span><br><span class="line">             scheduler,</span><br><span class="line">             heartbeatExecutor,</span><br><span class="line">             renewalIntervalInSecs,</span><br><span class="line">             TimeUnit.SECONDS,</span><br><span class="line">             expBackOffBound,</span><br><span class="line">              <span class="keyword">new</span> HeartbeatThread()</span><br><span class="line">            ),</span><br><span class="line">  renewalIntervalInSecs, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure></li></ol><p>2.åœ¨com.netflix.discovery.DiscoveryClientä¸­çš„1393è¡Œï¼Œæœ‰ä¸€ä¸ª<code>HeartbeatThread</code>çº¿ç¨‹å‘èµ·ç»­çº¦æ“ä½œ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">//è°ƒç”¨eureka-clientä¸­çš„renew</span></span><br><span class="line">            <span class="keyword">if</span> (renew()) &#123;</span><br><span class="line">                lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>renew()è°ƒç”¨eureka-client-1.4.11.jarcom.netflix.discovery.DiscoveryClientä¸­<code>829</code>è¡Œrenew()å‘èµ·<code>PUT Reset</code>è¯·æ±‚ï¼Œè°ƒç”¨com.netflix.eureka.resources.InstanceResourceä¸­çš„renewLease()ç»­çº¦ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Renew with the eureka service by making the appropriate REST call</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="keyword">null</span>);</span><br><span class="line">           logger.debug(<span class="string">"&#123;&#125; - Heartbeat status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">           <span class="keyword">if</span> (httpResponse.getStatusCode() == <span class="number">404</span>) &#123;</span><br><span class="line">               REREGISTER_COUNTER.increment();</span><br><span class="line">               logger.info(<span class="string">"&#123;&#125; - Re-registering apps/&#123;&#125;"</span>, PREFIX + appPathIdentifier, instanceInfo.getAppName());</span><br><span class="line">               <span class="keyword">return</span> register();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">200</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">           logger.error(<span class="string">"&#123;&#125; - was unable to send heartbeat!"</span>, PREFIX + appPathIdentifier, e);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><h3 id="2-2-Netflixä¸­çš„Eureka-Coreå®ç°ç»†èŠ‚"><a href="#2-2-Netflixä¸­çš„Eureka-Coreå®ç°ç»†èŠ‚" class="headerlink" title="2.2 Netflixä¸­çš„Eureka Coreå®ç°ç»†èŠ‚"></a>2.2 Netflixä¸­çš„Eureka Coreå®ç°ç»†èŠ‚</h3><p>   NetFlixä¸­Eureka Coreä¸­çš„æœåŠ¡ç»­çº¦æ—¶åºå›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br>  <img src="/images/spring-cloud-netflix/eureka/eureka-renew.png" alt="æœåŠ¡ç»­çº¦æ—¶åºå›¾"></p><ol><li><p>æ‰“å¼€<code>com.netflix.eureka.resources.InstanceResource</code>ä¸­çš„<code>106</code>è¡Œçš„<code>renewLease()</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PeerAwareInstanceRegistry registry</span><br><span class="line"><span class="meta">@PUT</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">renewLease</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"overriddenstatus"</span>)</span> String overriddenStatus,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"status"</span>)</span> String status,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isFromReplicaNode = <span class="string">"true"</span>.equals(isReplication);</span><br><span class="line">    <span class="comment">//è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">boolean</span> isSuccess = registry.renew(app.getName(), id, isFromReplicaNode);</span><br><span class="line">    <span class="comment">//å…¶ä½™çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç‚¹å¼€registry.renew(app.getName(), id, isFromReplicaNode);æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨äº†<code>org.springframework.cloud.netflix.eureka.server.InstanceRegistry</code>ä¸­çš„<code>renewï¼ˆï¼‰</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String serverId,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">log(<span class="string">"renew "</span> + appName + <span class="string">" serverId "</span> + serverId + <span class="string">", isReplication &#123;&#125;"</span></span><br><span class="line">+ isReplication);</span><br><span class="line">List&lt;Application&gt; applications = getSortedApplications();</span><br><span class="line"><span class="keyword">for</span> (Application input : applications) &#123;</span><br><span class="line"><span class="keyword">if</span> (input.getName().equals(appName)) &#123;</span><br><span class="line">InstanceInfo instance = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">for</span> (InstanceInfo info : input.getInstances()) &#123;</span><br><span class="line"><span class="keyword">if</span> (info.getHostName().equals(serverId)) &#123;</span><br><span class="line">instance = info;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">publishEvent(<span class="keyword">new</span> EurekaInstanceRenewedEvent(<span class="keyword">this</span>, appName, serverId,</span><br><span class="line">instance, isReplication));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">//è°ƒç”¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImplä¸­çš„renewæ–¹æ³•</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.renew(appName, serverId, isReplication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>3.ä»<code>super.renew()</code>çœ‹åˆ°è°ƒç”¨äº†çˆ¶ç±»ä¸­çš„<code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</code>ä¸­<code>420</code>è¡Œçš„<code>renew()</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æœåŠ¡ç»­çº¦æˆåŠŸï¼Œ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">super</span>.renew(appName, id, isReplication)) &#123;</span><br><span class="line">            <span class="comment">//ç„¶åreplicateToPeersåŒæ­¥å…¶å®ƒEureka Serverä¸­çš„æ•°æ®</span></span><br><span class="line">            replicateToPeers(Action.Heartbeat, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3.1 ä»ä¸Šé¢ä»£ç ä¸­<code>super.renew(appName, id, isReplication)</code>å¯ä»¥çœ‹å‡ºè°ƒç”¨çš„æ˜¯com.netflix.eureka.registry.AbstractInstanceRegistryä¸­<code>345</code>è¡Œçš„renew()æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">      RENEW.increment(isReplication);</span><br><span class="line">      Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</span><br><span class="line">      Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">          leaseToRenew = gMap.get(id);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (leaseToRenew == <span class="keyword">null</span>) &#123;</span><br><span class="line">          RENEW_NOT_FOUND.increment(isReplication);</span><br><span class="line">          logger.warn(<span class="string">"DS: Registry: lease doesn't exist, registering resource: &#123;&#125; - &#123;&#125;"</span>, appName, id);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          InstanceInfo instanceInfo = leaseToRenew.getHolder();</span><br><span class="line">          <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// touchASGCache(instanceInfo.getASGName());</span></span><br><span class="line">              InstanceStatus overriddenInstanceStatus = <span class="keyword">this</span>.getOverriddenInstanceStatus(</span><br><span class="line">                      instanceInfo, leaseToRenew, isReplication);</span><br><span class="line">              <span class="keyword">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;</span><br><span class="line">                  logger.info(<span class="string">"Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;"</span></span><br><span class="line">                          + <span class="string">"; re-register required"</span>, instanceInfo.getId());</span><br><span class="line">                  RENEW_NOT_FOUND.increment(isReplication);</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;</span><br><span class="line">                  Object[] args = &#123;</span><br><span class="line">                          instanceInfo.getStatus().name(),</span><br><span class="line">                          instanceInfo.getOverriddenStatus().name(),</span><br><span class="line">                          instanceInfo.getId()</span><br><span class="line">                  &#125;;</span><br><span class="line">                  logger.info(</span><br><span class="line">                          <span class="string">"The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. "</span></span><br><span class="line">                                  + <span class="string">"Hence setting the status to overridden status"</span>, args);</span><br><span class="line">                  instanceInfo.setStatus(overriddenInstanceStatus);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          renewsLastMin.increment();</span><br><span class="line">          leaseToRenew.renew();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ <code>leaseToRenew.renew()</code>æ˜¯è°ƒç”¨com.netflix.eureka.lease.Lease<t>ä¸­çš„<code>62</code>è¡Œçš„renew()æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Renew the lease, use renewal duration if it was specified by the</span></span><br><span class="line"><span class="comment"> * associated &#123;<span class="doctag">@link</span> T&#125; during registration, otherwise default duration is</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #DEFAULT_DURATION_IN_SECS&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    lastUpdateTimestamp = System.currentTimeMillis() + duration;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></t></p><p>3.2 replicateToPeers(Action.Heartbeat, appName, id, null, null, isReplication);è°ƒç”¨è‡ªèº«çš„<code>replicateToPeers()</code>æ–¹æ³•ï¼Œåœ¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImplä¸­çš„<code>618</code>è¡Œï¼Œä¸»è¦æ¥å£å®ç°æ–¹å¼å’ŒregisteråŸºæœ¬ä¸€è‡´ï¼šé¦–å…ˆæ›´æ–°è‡ªèº«Eureka Serverä¸­æœåŠ¡çš„çŠ¶æ€ï¼Œå†åŒæ­¥åˆ°å…¶å®ƒEureka Serverä¸­ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateToPeers</span><span class="params">(Action action, String appName, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InstanceInfo info <span class="comment">/* optional */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InstanceStatus newStatus <span class="comment">/* optional */</span>, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = action.getTimer().start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isReplication) &#123;</span><br><span class="line">                numberOfReplicationsLastMin.increment();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If it is a replication already, do not replicate again as this will create a poison replication</span></span><br><span class="line">            <span class="keyword">if</span> (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åŒæ­¥æŠŠç»­çº¦ä¿¡æ¯åŒæ­¥åˆ°å…¶å®ƒçš„Eureka Serverä¸­</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123;</span><br><span class="line">                <span class="comment">// If the url represents this host, do not replicate to yourself.</span></span><br><span class="line">                <span class="keyword">if</span> (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//æ ¹æ®actionåšç›¸åº”æ“ä½œçš„åŒæ­¥</span></span><br><span class="line">                replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            tracer.stop();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>è‡³æ­¤ï¼ŒEurekaæœåŠ¡ç»­çº¦æºç åˆ†æç»“æŸï¼Œå¤§å®¶æœ‰å…´è¶£å¯è‡ªè¡Œé˜…è¯»ã€‚</p><h3 id="2-3-æºç åˆ†æé“¾æ¥"><a href="#2-3-æºç åˆ†æé“¾æ¥" class="headerlink" title="2.3 æºç åˆ†æé“¾æ¥"></a>2.3 æºç åˆ†æé“¾æ¥</h3><p> å…¶å®ƒæºç åˆ†æé“¾æ¥:<br> Spring Cloudä¸­@EnableEurekaClientæºç åˆ†æ:<br> <a href="http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/</a><br> Spring Cloud EurekaæœåŠ¡æ³¨å†Œæºç åˆ†æï¼š<br> <a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-register/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä¸»è¦å¯¹Eurekaçš„Renew(æœåŠ¡ç»­çº¦)ï¼Œä»æœåŠ¡æä¾›è€…å‘èµ·ç»­çº¦è¯·æ±‚å¼€å§‹åˆ†æï¼Œé€šè¿‡é˜…è¯»æºç å’Œç”»æ—¶åºå›¾çš„æ–¹å¼ï¼Œå±•ç¤ºEurekaæœåŠ¡ç»­çº¦çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚æœåŠ¡ç»­çº¦ä¸»è¦æ˜¯æŠŠæœåŠ¡ç»­çº¦çš„ä¿¡æ¯æ›´æ–°åˆ°è‡ªèº«çš„Eureka Serverä¸­ï¼Œç„¶åå†åŒæ­¥åˆ°å…¶å®ƒEureka Serverä¸­ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-Renew-æœåŠ¡ç»­çº¦&quot;&gt;&lt;a href=&quot;#1-Renew-æœåŠ¡ç»­çº¦&quot; class=&quot;headerlink&quot; title=&quot;1. Renew(æœåŠ¡ç»­çº¦)&quot;&gt;&lt;/a&gt;1. Renew(æœåŠ¡ç»­çº¦)&lt;/h2&gt;&lt;h3 id=&quot;1-1-æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#1-1-æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;1.1 æ¦‚è¿°&quot;&gt;&lt;/a&gt;1.1 æ¦‚è¿°&lt;/h3&gt;&lt;p&gt;Renewï¼ˆæœåŠ¡ç»­çº¦ï¼‰æ“ä½œç”±Service Providerå®šæœŸè°ƒç”¨ï¼Œç±»ä¼¼äºheartbeatã€‚ç›®çš„æ˜¯éš”ä¸€æ®µæ—¶é—´Service Providerè°ƒç”¨æ¥å£ï¼Œå‘Šè¯‰Eureka Serverå®ƒè¿˜æ´»ç€æ²¡æŒ‚ï¼Œä¸è¦æŠŠå®ƒTäº†ã€‚é€šä¿—çš„è¯´å°±æ˜¯å®ƒä»¬ä¸¤ä¹‹é—´çš„å¿ƒè·³æ£€æµ‹ï¼Œé¿å…æœåŠ¡æä¾›è€…è¢«å‰”é™¤æ‰ã€‚&lt;br&gt;è¯·å‚è€ƒ:&lt;a href=&quot;http://blog.xujin.org/sc/sc-eureka-mid/#åè¯è§£é‡Š&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Spring Cloud Eurekaåè¯è§£é‡Š&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/categories/Spring-Cloud-Eureka/"/>
    
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/tags/Spring-Cloud-Eureka/"/>
    
      <category term="Spring Cloud æºç åˆ†æ" scheme="http://xujin.org/tags/Spring-Cloud-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloudä¸­@EnableEurekaClientæºç åˆ†æ</title>
    <link href="http://xujin.org/sc/sc-enableEurekaClient-annonation/"/>
    <id>http://xujin.org/sc/sc-enableEurekaClient-annonation/</id>
    <published>2016-11-06T06:00:00.000Z</published>
    <updated>2019-01-12T04:01:26.567Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»ä¸€ä¸‹Spring Cloudä¸­çš„@EnableEurekaClientæ³¨è§£ï¼Œä»æºç çš„è§’åº¦åˆ†ææ˜¯å¦‚ä½•workçš„ï¼Œè®©å¤§å®¶èƒ½äº†è§£Spring Cloudå¦‚ä½•é€šè¿‡@EnableEurekaClientæ³¨è§£å¯¹NetFlix Eureka Clientè¿›è¡Œå°è£…ä¸ºå®ƒæ‰€ç”¨ã€‚</p><h2 id="NetFlix-Eureka-clientç®€ä»‹"><a href="#NetFlix-Eureka-clientç®€ä»‹" class="headerlink" title="NetFlix Eureka clientç®€ä»‹"></a>NetFlix Eureka clientç®€ä»‹</h2><h3 id="NetFlix-Eureka-client"><a href="#NetFlix-Eureka-client" class="headerlink" title="NetFlix Eureka client"></a>NetFlix Eureka client</h3><p><code>Eureka client</code> è´Ÿè´£ä¸<code>Eureka Server</code> é…åˆå‘å¤–æä¾›æ³¨å†Œä¸å‘ç°æœåŠ¡æ¥å£ã€‚é¦–å…ˆçœ‹ä¸‹eureka clientæ˜¯æ€ä¹ˆå®šä¹‰ï¼ŒNetflixçš„ eureka clientçš„è¡Œä¸ºåœ¨<code>LookupService</code>ä¸­å®šä¹‰ï¼ŒLookup service for finding active instancesï¼Œå®šä¹‰äº†ï¼Œä»outlineä¸­èƒ½çœ‹åˆ°èµ·â€œè§„å®šâ€äº†å¦‚ä¸‹å‡ ä¸ªæœ€åŸºæœ¬çš„æ–¹æ³•ã€‚<br>æœåŠ¡å‘ç°å¿…é¡»å®ç°çš„åŸºæœ¬ç±»ï¼šcom.netflix.discovery.shared.LookupService<t>ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç ã€‚</t></p><h2 id="Eureka-clientä¸Spring-Cloudç±»å…³ç³»"><a href="#Eureka-clientä¸Spring-Cloudç±»å…³ç³»" class="headerlink" title="Eureka clientä¸Spring Cloudç±»å…³ç³»"></a>Eureka clientä¸Spring Cloudç±»å…³ç³»</h2><p> Eureka clientä¸Spring Cloud Eureka Clientç±»å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤º:<br><img src="/images/spring-cloud-netflix/eureka/anoation/class.png" alt="ç±»å…³ç³»å›¾"><br>åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘åŠ äº†å‰ç¼€ï¼Œå¸¦æœ‰<code>S</code>çš„æ˜¯Spring Cloudå°è£…çš„ï¼Œå¸¦æœ‰<code>N</code>æ˜¯NetFlixåŸç”Ÿçš„ã€‚<br><a id="more"></a></p><ol><li>org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientä¸­<code>49</code>è¡Œçš„eurekaClientå°±æ˜¯com.netflix.discovery.EurekaClientï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaDiscoveryClient</span> <span class="keyword">implements</span> <span class="title">DiscoveryClient</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DESCRIPTION = <span class="string">"Spring Cloud Eureka Discovery Client"</span>;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> EurekaInstanceConfig config;</span><br><span class="line"> <span class="comment">// Netflixä¸­çš„Eureka Client</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> EurekaClient eurekaClient;</span><br><span class="line"> <span class="comment">//å…¶ä½™çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><blockquote><p><code>Tips</code>:org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientå®ç°äº†DiscoveryClientï¼Œå¹¶ä¾èµ–äºcom.netflix.discovery.EurekaClient</p></blockquote><ol><li><p>ç‚¹å¼€com.netflix.discovery.EurekaClientæŸ¥çœ‹ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºEurekaClientç»§æ‰¿äº†LookupServiceå¹¶å®ç°äº†EurekaClientæ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImplementedBy</span>(DiscoveryClient.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaClient</span> <span class="keyword">extends</span> <span class="title">LookupService</span> </span>&#123;</span><br><span class="line">  <span class="comment">//å…¶ä½™çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>com.netflix.discovery.DiscoveryClientæ˜¯netflixä½¿ç”¨çš„å®¢æˆ·ç«¯ï¼Œä»å…¶classçš„æ³¨é‡Šå¯ä»¥çœ‹åˆ°ä»–ä¸»è¦åšè¿™å‡ ä»¶äº‹æƒ…ï¼š<br>a) Registering the instance with Eureka Server<br>b) Renewalof the lease with Eureka Server<br>c) Cancellation of the lease from Eureka Server during shutdown</p></li></ol><p>å…¶ä¸­<code>com.netflix.discovery.DiscoveryClient</code>å®ç°äº†<code>com.netflix.discovery.EurekaClient</code>,è€Œspring Cloudä¸­çš„<code>org.springframework.cloud.netflix.eureka.EurekaDiscoveryClient</code>ï¼Œä¾èµ–äº<code>com.netflix.discovery.EurekaClient</code>ï¼Œå› æ­¤Spring Cloudä¸NetFlixçš„å…³ç³»ç”±æ­¤è”ç³»åˆ°ä¸€èµ·ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DiscoveryClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constants</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HTTP_X_DISCOVERY_ALLOW_REDIRECT = <span class="string">"X-Discovery-AllowRedirect"</span>;</span><br><span class="line">    <span class="comment">//å…¶ä½™çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="EnableEurekaClientæ³¨è§£å…¥å£åˆ†æ"><a href="#EnableEurekaClientæ³¨è§£å…¥å£åˆ†æ" class="headerlink" title="@EnableEurekaClientæ³¨è§£å…¥å£åˆ†æ"></a>@EnableEurekaClientæ³¨è§£å…¥å£åˆ†æ</h2><p>   åœ¨ä¸Šé¢å°èŠ‚ä¸­ï¼Œç†æ¸…äº†<code>NetFlix Eureka</code>ä¸<code>Spring cloud</code>ä¸­ç±»çš„ä¾èµ–å…³ç³»ï¼Œä¸‹é¢å°†ä»¥@EnableEurekaClientä¸ºå…¥å£ï¼Œåˆ†æä¸»è¦è°ƒç”¨é“¾ä¸­çš„ç±»å’Œæ–¹æ³•ã€‚</p><h3 id="EnableEurekaClientä½¿ç”¨"><a href="#EnableEurekaClientä½¿ç”¨" class="headerlink" title="@EnableEurekaClientä½¿ç”¨"></a>@EnableEurekaClientä½¿ç”¨</h3><ol><li>ç”¨è¿‡spring cloudçš„åŒå­¦éƒ½çŸ¥é“ï¼Œä½¿ç”¨@EnableEurekaClientå°±èƒ½ç®€å•çš„å¼€å¯Eureka Clientä¸­çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudEurekaClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="keyword">new</span> SpringApplicationBuilder(CloudEurekaClientApplication.class).web(<span class="keyword">true</span>).run(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>é€šè¿‡@EnableEurekaClientè¿™ä¸ªç®€å•çš„æ³¨è§£ï¼Œåœ¨spring cloudåº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥æŠŠEurekaDiscoveryClientæ³¨å…¥ï¼Œç»§è€Œä½¿ç”¨NetFlixæä¾›çš„Eureka clientã€‚</p><ol><li><p>æ‰“å¼€EnableEurekaClientè¿™ä¸ªç±»ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªè‡ªå®šä¹‰çš„annotation @EnableEurekaClienté‡Œé¢æ²¡æœ‰å†…å®¹ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å¼€å¯Eureka discoveryçš„é…ç½®ï¼Œæ­£æ˜¯é€šè¿‡è¿™ä¸ªæ ‡è®°ï¼Œautoconfigurationå°±å¯ä»¥åŠ è½½ç›¸å…³çš„Eurekaç±»ã€‚é‚£æˆ‘ä»¬çœ‹ä¸‹å®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableEurekaClient &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼ŒEnableEurekaClientä¸Šé¢åŠ å…¥äº†å¦å¤–ä¸€ä¸ªæ³¨è§£@EnableDiscoveryClientï¼Œçœ‹çœ‹è¿™ä¸ªæ³¨è§£çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Annotation to enable a DiscoveryClient implementation.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(EnableDiscoveryClientImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDiscoveryClient &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¿™ä¸ªæ³¨è§£importäº†EnableDiscoveryClientImportSelector.classè¿™æ ·ä¸€ä¸ªç±»ï¼Œå…¶å®å°±æ˜¯é€šè¿‡è¿™ä¸ªç±»æ¥<code>åŠ è½½</code>éœ€è¦ç”¨åˆ°çš„beanã€‚<br>ç‚¹å¼€EnableDiscoveryClientImportSelectorç±»ï¼Œå¦‚ä¸‹ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(Ordered.LOWEST_PRECEDENCE - <span class="number">100</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableDiscoveryClientImportSelector</span></span></span><br><span class="line"><span class="class"><span class="keyword">extends</span> <span class="title">SpringFactoryImportSelector</span>&lt;<span class="title">EnableDiscoveryClient</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RelaxedPropertyResolver(getEnvironment()).getProperty(</span><br><span class="line"><span class="string">"spring.cloud.discovery.enabled"</span>, Boolean.class, Boolean.TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasDefaultFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>çœ‹åˆ°è¿™é‡Œæœ‰è¦†ç›–äº†<code>çˆ¶ç±»SpringFactoryImportSelector</code>çš„ä¸€ä¸ªæ–¹æ³•<code>isEnabled</code>ï¼Œæ³¨æ„ï¼Œé»˜è®¤æ˜¯TRUEï¼Œä¹Ÿå°±æ˜¯åªè¦importäº†è¿™ä¸ªé…ç½®ï¼Œå°±ä¼šenableã€‚</p></blockquote><p>åœ¨å…¶çˆ¶ç±»<code>org.springframework.cloud.commons.util.SpringFactoryImportSelector</code><br>çš„<code>String[] selectImports(AnnotationMetadata metadata)</code>æ–¹æ³•ä¸­æ­£æ˜¯æ ¹æ®è¿™ä¸ªæ ‡è®°ç±»åˆ¤å®šæ˜¯å¦åŠ è½½å¦‚ä¸‹å®šä¹‰çš„ç±»ã€‚åœ¨æºç ç¬¬59è¡Œï¼Œå±€éƒ¨ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata metadata) &#123;</span><br><span class="line"><span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line">AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">metadata.getAnnotationAttributes(<span class="keyword">this</span>.annotationClass.getName(), <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">Assert.notNull(attributes, <span class="string">"No "</span> + getSimpleName() + <span class="string">" attributes found. Is "</span></span><br><span class="line">+ metadata.getClassName() + <span class="string">" annotated with @"</span> + getSimpleName() + <span class="string">"?"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find all possible auto configuration classes, filtering duplicates</span></span><br><span class="line">List&lt;String&gt; factories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">new</span> LinkedHashSet&lt;&gt;(SpringFactoriesLoader</span><br><span class="line">.loadFactoryNames(<span class="keyword">this</span>.annotationClass, <span class="keyword">this</span>.beanClassLoader)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (factories.isEmpty() &amp;&amp; !hasDefaultFactory()) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Annotation @"</span> + getSimpleName()</span><br><span class="line">+ <span class="string">" found, but there are no implementations. Did you forget to include a starter?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (factories.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">// there should only ever be one DiscoveryClient, but there might be more than</span></span><br><span class="line"><span class="comment">// one factory</span></span><br><span class="line">log.warn(<span class="string">"More than one implementation "</span> + <span class="string">"of @"</span> + getSimpleName()</span><br><span class="line">+ <span class="string">" (now relying on @Conditionals to pick one): "</span> + factories);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> factories.toArray(<span class="keyword">new</span> String[factories.size()]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨æºç ä¸­70-71è¡Œï¼Œå³åœ¨<br>org.springframework.core.io.support.SpringFactoriesLoader ä¸­çš„109è¡Œçš„loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader)æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">String factoryClassName = factoryClass.getName();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span><br><span class="line">ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"><span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">URL url = urls.nextElement();</span><br><span class="line">Properties properties = PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> UrlResource(url));</span><br><span class="line">String factoryClassNames = properties.getProperty(factoryClassName);</span><br><span class="line">result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load ["</span> + factoryClass.getName() +</span><br><span class="line"><span class="string">"] factories from location ["</span> + FACTORIES_RESOURCE_LOCATION + <span class="string">"]"</span>, ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ol><li>å®é™…è°ƒç”¨<code>loadFactoryNames</code>å…¶å®åŠ è½½<code>META-INF/spring.factories</code>ä¸‹çš„classã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">* The location to look for factories.</span></span><br><span class="line"><span class="comment">* &lt;p&gt;Can be present in multiple JAR files.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACTORIES_RESOURCE_LOCATION = <span class="string">"META-INF/spring.factories"</span>;</span><br></pre></td></tr></table></figure></li></ol><p>è€Œåœ¨spring-cloud-netflix-eureka-client\src\main\resources\META-INF\spring.factoriesä¸­é…ç½®ï¼Œç”¨äºåŠ è½½ä¸€ç³»åˆ—é…ç½®ä¿¡æ¯å’ŒDependences Bean<br><img src="/images/spring-cloud-netflix/eureka/anoation/1.png" alt="spring.factories"><br>å¯ä»¥çœ‹åˆ°<code>EnableAutoConfiguration</code>çš„åŒ…å«äº†<code>EurekaClientConfigServerAutoConfiguration</code>ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.ribbon.eureka.RibbonEurekaAutoConfiguration</span><br><span class="line"></span><br><span class="line">org.springframework.cloud.bootstrap.BootstrapConfiguration=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration</span><br><span class="line"></span><br><span class="line">org.springframework.cloud.client.discovery.EnableDiscoveryClient=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration</span><br></pre></td></tr></table></figure></p><p>æ‰“å¼€org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfigurationå¯ä»¥çœ‹åˆ°<br>EurekaClientAutoConfigurationå…·ä½“çš„æ³¨å…¥ä¿¡æ¯ã€‚</p><p>å…·ä½“@EnableEurekaClienæ³¨è§£å¼€å¯ä¹‹åï¼ŒæœåŠ¡å¯åŠ¨åï¼Œæ˜¯æœåŠ¡æ€ä¹ˆæ³¨å†Œçš„è¯·å‚è€ƒï¼Œä¸‹é¢é“¾æ¥ï¼š<br><a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-register/</a></p><h2 id="å…¶å®ƒæºç åˆ†æé“¾æ¥"><a href="#å…¶å®ƒæºç åˆ†æé“¾æ¥" class="headerlink" title="å…¶å®ƒæºç åˆ†æé“¾æ¥"></a>å…¶å®ƒæºç åˆ†æé“¾æ¥</h2><p> Spring Cloudä¸­@EnableEurekaClientæºç åˆ†æ:<br> <a href="http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/</a><br> Spring Cloud EurekaæœåŠ¡æ³¨å†Œæºç åˆ†æï¼š<br> <a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-register/</a><br> Spring Cloud EurekaæœåŠ¡ç»­çº¦(Renew)æºç åˆ†æ<br> <a href="http://blog.xujin.org/sc/sc-eureka-renew/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-renew/</a><br> Spring Cloud EurekaæœåŠ¡ä¸‹çº¿(Cancel)æºç åˆ†æ<br> <a href="http://blog.xujin.org/sc/sc-eureka-cancle/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-cancle/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦ä»‹ç»ä¸€ä¸‹Spring Cloudä¸­çš„@EnableEurekaClientæ³¨è§£ï¼Œä»æºç çš„è§’åº¦åˆ†ææ˜¯å¦‚ä½•workçš„ï¼Œè®©å¤§å®¶èƒ½äº†è§£Spring Cloudå¦‚ä½•é€šè¿‡@EnableEurekaClientæ³¨è§£å¯¹NetFlix Eureka Clientè¿›è¡Œå°è£…ä¸ºå®ƒæ‰€ç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&quot;NetFlix-Eureka-clientç®€ä»‹&quot;&gt;&lt;a href=&quot;#NetFlix-Eureka-clientç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;NetFlix Eureka clientç®€ä»‹&quot;&gt;&lt;/a&gt;NetFlix Eureka clientç®€ä»‹&lt;/h2&gt;&lt;h3 id=&quot;NetFlix-Eureka-client&quot;&gt;&lt;a href=&quot;#NetFlix-Eureka-client&quot; class=&quot;headerlink&quot; title=&quot;NetFlix Eureka client&quot;&gt;&lt;/a&gt;NetFlix Eureka client&lt;/h3&gt;&lt;p&gt;&lt;code&gt;Eureka client&lt;/code&gt; è´Ÿè´£ä¸&lt;code&gt;Eureka Server&lt;/code&gt; é…åˆå‘å¤–æä¾›æ³¨å†Œä¸å‘ç°æœåŠ¡æ¥å£ã€‚é¦–å…ˆçœ‹ä¸‹eureka clientæ˜¯æ€ä¹ˆå®šä¹‰ï¼ŒNetflixçš„ eureka clientçš„è¡Œä¸ºåœ¨&lt;code&gt;LookupService&lt;/code&gt;ä¸­å®šä¹‰ï¼ŒLookup service for finding active instancesï¼Œå®šä¹‰äº†ï¼Œä»outlineä¸­èƒ½çœ‹åˆ°èµ·â€œè§„å®šâ€äº†å¦‚ä¸‹å‡ ä¸ªæœ€åŸºæœ¬çš„æ–¹æ³•ã€‚&lt;br&gt;æœåŠ¡å‘ç°å¿…é¡»å®ç°çš„åŸºæœ¬ç±»ï¼šcom.netflix.discovery.shared.LookupService&lt;t&gt;ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç ã€‚&lt;/t&gt;&lt;/p&gt;
&lt;h2 id=&quot;Eureka-clientä¸Spring-Cloudç±»å…³ç³»&quot;&gt;&lt;a href=&quot;#Eureka-clientä¸Spring-Cloudç±»å…³ç³»&quot; class=&quot;headerlink&quot; title=&quot;Eureka clientä¸Spring Cloudç±»å…³ç³»&quot;&gt;&lt;/a&gt;Eureka clientä¸Spring Cloudç±»å…³ç³»&lt;/h2&gt;&lt;p&gt; Eureka clientä¸Spring Cloud Eureka Clientç±»å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤º:&lt;br&gt;&lt;img src=&quot;/images/spring-cloud-netflix/eureka/anoation/class.png&quot; alt=&quot;ç±»å…³ç³»å›¾&quot;&gt;&lt;br&gt;åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘åŠ äº†å‰ç¼€ï¼Œå¸¦æœ‰&lt;code&gt;S&lt;/code&gt;çš„æ˜¯Spring Cloudå°è£…çš„ï¼Œå¸¦æœ‰&lt;code&gt;N&lt;/code&gt;æ˜¯NetFlixåŸç”Ÿçš„ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/categories/Spring-Cloud-Eureka/"/>
    
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/tags/Spring-Cloud-Eureka/"/>
    
      <category term="Spring Cloud æºç åˆ†æ" scheme="http://xujin.org/tags/Spring-Cloud-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud EurekaæœåŠ¡æ³¨å†Œæºç åˆ†æ</title>
    <link href="http://xujin.org/sc/sc-eureka-register/"/>
    <id>http://xujin.org/sc/sc-eureka-register/</id>
    <published>2016-11-01T06:00:00.000Z</published>
    <updated>2019-01-12T04:30:38.822Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œä»‹ç»äº†Eurekaçš„ç›¸å…³çš„çŸ¥è¯†ï¼Œè§£é‡Šäº†Eurekaä¸ºä»€ä¹ˆé€‚åˆåšæœåŠ¡å‘ç°å’Œæ³¨å†Œã€‚æ¥ä¸‹æ¥ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å°†é€šè¿‡æºç åˆ†æçš„æ–¹å¼ï¼Œçœ‹ä¸€ä¸‹Eurekaæ˜¯æ€ä¹ˆworkçš„ã€‚æœ¬ç« ä¸»è¦ä»‹ç»Eurekaçš„æœåŠ¡æ³¨å†Œã€‚é‚£eureka clientå¦‚ä½•å°†æœ¬åœ°æœåŠ¡çš„æ³¨å†Œä¿¡æ¯å‘é€åˆ°è¿œç«¯çš„æ³¨å†ŒæœåŠ¡å™¨eureka serverä¸Šã€‚é€šè¿‡ä¸‹é¢çš„æºç åˆ†æï¼Œçœ‹å‡ºEureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„RESTæ¥å£ï¼Œè€ŒEurekaæ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚åä¼šå¤„ç†æœåŠ¡çš„æ³¨å†Œä»¥åŠEureka Serverä¸­çš„æ•°æ®åŒæ­¥çš„é—®é¢˜ã€‚</p><h2 id="æœåŠ¡æ³¨å†Œ"><a href="#æœåŠ¡æ³¨å†Œ" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h2><p> æœåŠ¡æ³¨å†Œï¼Œæƒ³å¿…å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œå°±æ˜¯æœåŠ¡æä¾›è€…å¯åŠ¨çš„æ—¶å€™ï¼ŒæŠŠè‡ªå·±æä¾›çš„æœåŠ¡ä¿¡æ¯ï¼Œä¾‹å¦‚ æœåŠ¡åï¼ŒIPï¼Œç«¯å£å·ï¼Œç‰ˆæœ¬å·ç­‰ä¿¡æ¯æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œæ¯”å¦‚æ³¨å†Œåˆ°ZKä¸­ã€‚é‚£eureka clientå¦‚ä½•å°†æœ¬åœ°æœåŠ¡çš„æ³¨å†Œä¿¡æ¯å‘é€åˆ°è¿œç«¯çš„æ³¨å†ŒæœåŠ¡å™¨eureka serverä¸Šã€‚é€šè¿‡ä¸‹é¢çš„æºç åˆ†æï¼Œçœ‹å‡ºæœåŠ¡æ³¨å†Œå¯ä»¥è®¤ä¸ºæ˜¯Eureka clientè‡ªå·±å®Œæˆï¼Œä¸éœ€è¦æœåŠ¡æœ¬èº«æ¥å…³å¿ƒã€‚</p><h3 id="Eureka-Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka-Serverçš„æä¾›æ¥å£"><a href="#Eureka-Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka-Serverçš„æä¾›æ¥å£" class="headerlink" title="Eureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„æä¾›æ¥å£"></a>Eureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„æä¾›æ¥å£</h3><p>å®ç°æ€è·¯å…¶å®ä¹ŸæŒºç®€å•ï¼Œåœ¨com.netflix.discovery.DiscoveryClientå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶çš„æŠŠæœ¬åœ°çš„æœåŠ¡é…ç½®ä¿¡æ¯ï¼Œå³éœ€è¦æ³¨å†Œåˆ°è¿œç«¯çš„æœåŠ¡ä¿¡æ¯è‡ªåŠ¨åˆ·æ–°åˆ°æ³¨å†ŒæœåŠ¡å™¨ä¸Šã€‚<br>é¦–å…ˆçœ‹ä¸€ä¸‹Eurekaçš„ä»£ç ï¼Œåœ¨spring-cloud-netflix-eureka-serverå·¥ç¨‹ä¸­å¯ä»¥æ‰¾åˆ°è¿™ä¸ªä¾èµ–eureka-client-1.4.11.jaræŸ¥çœ‹ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ<br>com.netflix.discovery.DiscoveryClient.javaä¸­çš„1240è¡Œå¯ä»¥çœ‹åˆ°Initializes all scheduled tasksï¼Œåœ¨1277è¡Œï¼Œå¯ä»¥çœ‹åˆ°InstanceInfoReplicatorå®šæ—¶ä»»åŠ¡ã€‚<br><a id="more"></a></p><ol><li>åœ¨DiscoveryClientä¸­åˆå§‹åŒ–ä¸€ä¸ªInstanceInfoReplicatorï¼Œå…¶å®é‡Œé¢å°è£…äº†ä»¥å®šæ—¶ä»»åŠ¡ã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes all scheduled tasks.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">            <span class="comment">// registry cache refresh timer</span></span><br><span class="line">            <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">            <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">            scheduler.schedule(</span><br><span class="line">                    <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                            <span class="string">"cacheRefresh"</span>,</span><br><span class="line">                            scheduler,</span><br><span class="line">                            cacheRefreshExecutor,</span><br><span class="line">                            registryFetchIntervalSeconds,</span><br><span class="line">                            TimeUnit.SECONDS,</span><br><span class="line">                            expBackOffBound,</span><br><span class="line">                            <span class="keyword">new</span> CacheRefreshThread()</span><br><span class="line">                    ),</span><br><span class="line">                    registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">            <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">            <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">            logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Heartbeat timer</span></span><br><span class="line">            scheduler.schedule(</span><br><span class="line">                    <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                            <span class="string">"heartbeat"</span>,</span><br><span class="line">                            scheduler,</span><br><span class="line">                            heartbeatExecutor,</span><br><span class="line">                            renewalIntervalInSecs,</span><br><span class="line">                            TimeUnit.SECONDS,</span><br><span class="line">                            expBackOffBound,</span><br><span class="line">                            <span class="keyword">new</span> HeartbeatThread()</span><br><span class="line">                    ),</span><br><span class="line">                    renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// InstanceInfo replicator</span></span><br><span class="line">            <span class="comment">/**************************å°è£…äº†å®šæ—¶ä»»åŠ¡**********************************/</span></span><br><span class="line">            instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</span><br><span class="line">                    <span class="keyword">this</span>,</span><br><span class="line">                    instanceInfo,</span><br><span class="line">                    clientConfig.getInstanceInfoReplicationIntervalSeconds(),</span><br><span class="line">                    <span class="number">2</span>); <span class="comment">// burstSize</span></span><br><span class="line"></span><br><span class="line">            statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</span><br><span class="line">                            InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</span><br><span class="line">                        <span class="comment">// log at warn level if DOWN was involved</span></span><br><span class="line">                        logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125;</span><br><span class="line">                    instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</span><br><span class="line">                applicationInfoManager.registerStatusChangeListener(statusChangeListener);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ç‚¹å‡»å¯ä»¥æŸ¥çœ‹startæ–¹æ³•</span></span><br><span class="line">            instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ol><p>2.ä»¥initialDelayMsä¸ºé—´éš”è°ƒç”¨ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> initialDelayMs)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (started.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">           instanceInfo.setIsDirty();  <span class="comment">// for initial register</span></span><br><span class="line">           Future next = scheduler.schedule(<span class="keyword">this</span>, initialDelayMs, TimeUnit.SECONDS);</span><br><span class="line">           scheduledPeriodicRef.set(next);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3.ScheduledExecutorServiceçš„taskçš„å…·ä½“ä¸šåŠ¡å®šä¹‰åœ¨com.netflix.discovery.InstanceInfoReplicator.run()ä¸­ï¼Œä¹Ÿå°±æ˜¯InstanceInfoReplicatorä¸­çš„98-113è¡Œï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†äº†clientçš„registeræ–¹æ³•ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           discoveryClient.refreshInstanceInfo();</span><br><span class="line"></span><br><span class="line">           Long dirtyTimestamp = instanceInfo.isDirtyWithTime();</span><br><span class="line">           <span class="keyword">if</span> (dirtyTimestamp != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">//å®¢æˆ·ç«¯å‘é€hhtpæ³¨å†Œè¯·æ±‚çš„çœŸæ­£å…¥å£</span></span><br><span class="line">               discoveryClient.register();</span><br><span class="line">               instanceInfo.unsetIsDirty(dirtyTimestamp);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">           logger.warn(<span class="string">"There was a problem with the instance info replicator"</span>, t);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           Future next = scheduler.schedule(<span class="keyword">this</span>, replicationIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">           scheduledPeriodicRef.set(next);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4.com.netflix.discovery.DiscoveryClientä¸­çš„ register()æ–¹æ³•ï¼Œå¤§æ¦‚åœ¨811è¡Œã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Register with the eureka service by making the appropriate REST call.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    logger.info(PREFIX + appPathIdentifier + <span class="string">": registering service..."</span>);</span><br><span class="line">    EurekaHttpResponse&lt;Void&gt; httpResponse;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//Eureka Clientå®¢æˆ·ç«¯ï¼Œè°ƒç”¨EurekaæœåŠ¡ç«¯çš„å…¥å£</span></span><br><span class="line">        httpResponse = eurekaTransport.registrationClient.register(instanceInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.warn(<span class="string">"&#123;&#125; - registration failed &#123;&#125;"</span>, PREFIX + appPathIdentifier, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(<span class="string">"&#123;&#125; - registration status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">204</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Eureka-serverç«¯æ¥åˆ°è¯·æ±‚åçš„å¤„ç†"><a href="#Eureka-serverç«¯æ¥åˆ°è¯·æ±‚åçš„å¤„ç†" class="headerlink" title="Eureka serverç«¯æ¥åˆ°è¯·æ±‚åçš„å¤„ç†"></a>Eureka serverç«¯æ¥åˆ°è¯·æ±‚åçš„å¤„ç†</h3><p>æ‰“å¼€spring-cloud-netflix-eureka-serverå·¥ç¨‹æˆ–spring-cloud-netflix-eureka-clientè¿‡ç¨‹ï¼Œæ‰¾åˆ°ç›¸åº”çš„mavenä¾èµ–jarï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="/images/spring-cloud-netflix/eureka/2016-11-01_223409.png" alt="Eurekaä¸­registerå…¥å£"><br> 1.Eureka serveræœåŠ¡ç«¯è¯·æ±‚å…¥å£<br>ApplicationResource.javaæ–‡ä»¶ä¸­ç¬¬183è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹å‡ºEurekaæ˜¯é€šè¿‡http postçš„æ–¹å¼å»æœåŠ¡æ³¨å†Œ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@POST</span></span><br><span class="line">    <span class="meta">@Consumes</span>(&#123;<span class="string">"application/json"</span>, <span class="string">"application/xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">addInstance</span><span class="params">(InstanceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</span><br><span class="line">        logger.debug(<span class="string">"Registering instance &#123;&#125; (replication=&#123;&#125;)"</span>, info.getId(), isReplication);</span><br><span class="line">        <span class="comment">// validate that the instanceinfo contains all the necessary required fields</span></span><br><span class="line">        <span class="keyword">if</span> (isBlank(info.getId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing instanceId"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getHostName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing hostname"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getAppName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing appName"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!appName.equals(info.getAppName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Mismatched appName, expecting "</span> + appName + <span class="string">" but was "</span> + info.getAppName()).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo().getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo Name"</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// handle cases where clients may be registering with bad DataCenterInfo with missing data</span></span><br><span class="line">        DataCenterInfo dataCenterInfo = info.getDataCenterInfo();</span><br><span class="line">        <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> UniqueIdentifier) &#123;</span><br><span class="line">            String dataCenterInfoId = ((UniqueIdentifier) dataCenterInfo).getId();</span><br><span class="line">            <span class="keyword">if</span> (isBlank(dataCenterInfoId)) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> experimental = <span class="string">"true"</span>.equalsIgnoreCase(serverConfig.getExperimental(<span class="string">"registration.validation.dataCenterInfoId"</span>));</span><br><span class="line">                <span class="keyword">if</span> (experimental) &#123;</span><br><span class="line">                    String entity = <span class="string">"DataCenterInfo of type "</span> + dataCenterInfo.getClass() + <span class="string">" must contain a valid id"</span>;</span><br><span class="line">                    <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(entity).build();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> AmazonInfo) &#123;</span><br><span class="line">                    AmazonInfo amazonInfo = (AmazonInfo) dataCenterInfo;</span><br><span class="line">                    String effectiveId = amazonInfo.get(AmazonInfo.MetaDataKey.instanceId);</span><br><span class="line">                    <span class="keyword">if</span> (effectiveId == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        amazonInfo.getMetadata().put(AmazonInfo.MetaDataKey.instanceId.getName(), info.getId());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Registering DataCenterInfo of type &#123;&#125; without an appropriate id"</span>, dataCenterInfo.getClass());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//InstanceRegistry.javaæ–‡ä»¶ä¸­çš„88è¡Œçš„405è¡Œregisteræ–¹æ³•</span></span><br><span class="line">        registry.register(info, <span class="string">"true"</span>.equals(isReplication));</span><br><span class="line">        <span class="keyword">return</span> Response.status(<span class="number">204</span>).build();  <span class="comment">// 204 to be backwards compatible</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>2.å¦‚ä¸‹å›¾æ‰€ç¤ºå¯ä»¥çœ‹åˆ°ï¼Œä»ApplicationResource.javaæ€ä¹ˆè¿›å…¥åˆ°PeerAwareInstanceRegistryImplä¸­çš„registeræ–¹æ³•<br><img src="/images/spring-cloud-netflix/eureka/2016-11-01_222223.png" alt="è°ƒç”¨PeerAwareInstanceRegistryImplä¸­çš„register"><br>InstanceRegistry.javaæ–‡ä»¶ä¸­çš„88è¡Œï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨PeerAwareInstanceRegistryImplä¸­çš„405è¡Œregisteræ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">handleRegistration(info, resolveInstanceLeaseDuration(info), isReplication);</span><br><span class="line">       <span class="comment">//è°ƒç”¨PeerAwareInstanceRegistryImplä¸­çš„405è¡Œregisteræ–¹æ³•</span></span><br><span class="line"><span class="keyword">super</span>.register(info, isReplication);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>3.PeerAwareInstanceRegistryImplä¸­çš„405è¡Œregisteræ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚é˜…è¯»æ–¹æ³•ä¸Šé¢çš„æ³¨é‡Šï¼Œå°±çŸ¥é“è¯¥æ–¹æ³•æ˜¯æ³¨å†ŒæœåŠ¡ä¿¡æ¯å¹¶æŠŠEureka Serverä¸­çš„é…ç½®ä¿¡æ¯åŒæ­¥ã€‚æ‰§è¡Œæ³¨å†Œçš„åŠ¨ä½œåœ¨com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl.register(InstanceInfo info, boolean isReplication)ä¸­ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Registers the information about the &#123;<span class="doctag">@link</span> InstanceInfo&#125; and replicates</span></span><br><span class="line"><span class="comment">    * this information to all peer eureka nodes. If this is replication event</span></span><br><span class="line"><span class="comment">    * from other replica nodes then it is not replicated.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> info</span></span><br><span class="line"><span class="comment">    *            the &#123;<span class="doctag">@link</span> InstanceInfo&#125; to be registered and replicated.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> isReplication</span></span><br><span class="line"><span class="comment">    *            true if this is a replication event from other replica nodes,</span></span><br><span class="line"><span class="comment">    *            false otherwise.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> leaseDuration = Lease.DEFAULT_DURATION_IN_SECS;</span><br><span class="line">       <span class="keyword">if</span> (info.getLeaseInfo() != <span class="keyword">null</span> &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           leaseDuration = info.getLeaseInfo().getDurationInSecs();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//è°ƒç”¨çˆ¶ç±»æ–¹æ³•æ³¨å†Œ</span></span><br><span class="line">       <span class="keyword">super</span>.register(info, leaseDuration, isReplication);</span><br><span class="line">       <span class="comment">// åŒæ­¥Eurekaä¸­çš„æœåŠ¡ä¿¡æ¯</span></span><br><span class="line">       replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="keyword">null</span>, isReplication);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>4.AbstractInstanceRegistry.javaä¸­192è¡Œï¼Œå¯ä»¥çœ‹åˆ°EurekaçœŸæ­£çš„æœåŠ¡æ³¨å†Œå®ç°çš„ä»£ç <br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers a new instance with a given duration.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> com.netflix.eureka.lease.LeaseManager#register(java.lang.Object, int, boolean)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            read.lock();</span><br><span class="line">            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());</span><br><span class="line">            REGISTER.increment(isReplication);</span><br><span class="line">            <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt;();</span><br><span class="line">                gMap = registry.putIfAbsent(registrant.getAppName(), gNewMap);</span><br><span class="line">                <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    gMap = gNewMap;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());</span><br><span class="line">            <span class="comment">// Retain the last dirty timestamp without overwriting it, if there is already a lease</span></span><br><span class="line">            <span class="keyword">if</span> (existingLease != <span class="keyword">null</span> &amp;&amp; (existingLease.getHolder() != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                Long existingLastDirtyTimestamp = existingLease.getHolder().getLastDirtyTimestamp();</span><br><span class="line">                Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp();</span><br><span class="line">                logger.debug(<span class="string">"Existing lease found (existing=&#123;&#125;, provided=&#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">                <span class="keyword">if</span> (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"There is an existing lease and the existing lease's dirty timestamp &#123;&#125; is greater"</span> +</span><br><span class="line">                            <span class="string">" than the one that is being registered &#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">                    logger.warn(<span class="string">"Using the existing instanceInfo instead of the new instanceInfo as the registrant"</span>);</span><br><span class="line">                    registrant = existingLease.getHolder();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The lease does not exist and hence it is a new registration</span></span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// Since the client wants to cancel it, reduce the threshold</span></span><br><span class="line">                        <span class="comment">// (1</span></span><br><span class="line">                        <span class="comment">// for 30 seconds, 2 for a minute)</span></span><br><span class="line">                        <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</span><br><span class="line">                                (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                logger.debug(<span class="string">"No previous lease information found; it is new registration"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Lease&lt;InstanceInfo&gt; lease = <span class="keyword">new</span> Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);</span><br><span class="line">            <span class="keyword">if</span> (existingLease != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());</span><br><span class="line">            &#125;</span><br><span class="line">            gMap.put(registrant.getId(), lease);</span><br><span class="line">            <span class="keyword">synchronized</span> (recentRegisteredQueue) &#123;</span><br><span class="line">                recentRegisteredQueue.add(<span class="keyword">new</span> Pair&lt;Long, String&gt;(</span><br><span class="line">                        System.currentTimeMillis(),</span><br><span class="line">                        registrant.getAppName() + <span class="string">"("</span> + registrant.getId() + <span class="string">")"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// This is where the initial state transfer of overridden status happens</span></span><br><span class="line">            <span class="keyword">if</span> (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Found overridden status &#123;&#125; for instance &#123;&#125;. Checking to see if needs to be add to the "</span></span><br><span class="line">                                + <span class="string">"overrides"</span>, registrant.getOverriddenStatus(), registrant.getId());</span><br><span class="line">                <span class="keyword">if</span> (!overriddenInstanceStatusMap.containsKey(registrant.getId())) &#123;</span><br><span class="line">                    logger.info(<span class="string">"Not found overridden id &#123;&#125; and hence adding it"</span>, registrant.getId());</span><br><span class="line">                    overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId());</span><br><span class="line">            <span class="keyword">if</span> (overriddenStatusFromMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.info(<span class="string">"Storing overridden status &#123;&#125; from map"</span>, overriddenStatusFromMap);</span><br><span class="line">                registrant.setOverriddenStatus(overriddenStatusFromMap);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set the status based on the overridden status rules</span></span><br><span class="line">            InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication);</span><br><span class="line">            registrant.setStatusWithoutDirty(overriddenInstanceStatus);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the lease is registered with UP status, set lease service up timestamp</span></span><br><span class="line">            <span class="keyword">if</span> (InstanceStatus.UP.equals(registrant.getStatus())) &#123;</span><br><span class="line">                lease.serviceUp();</span><br><span class="line">            &#125;</span><br><span class="line">            registrant.setActionType(ActionType.ADDED);</span><br><span class="line">            recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(lease));</span><br><span class="line">            registrant.setLastUpdatedTimestamp();</span><br><span class="line">            invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</span><br><span class="line">            logger.info(<span class="string">"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)"</span>,</span><br><span class="line">                    registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            read.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>æ›´å¤šçš„ç»†èŠ‚æºç å†…å®¹ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±é˜…è¯»ã€‚</p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ApplicationResourceç±»æ¥æ”¶HttpæœåŠ¡è¯·æ±‚ï¼Œè°ƒç”¨PeerAwareInstanceRegistryImplçš„registeræ–¹æ³•ï¼ŒPeerAwareInstanceRegistryImplå®ŒæˆæœåŠ¡æ³¨å†Œåï¼Œè°ƒç”¨replicateToPeerså‘å…¶å®ƒEureka ServerèŠ‚ç‚¹ï¼ˆPeerï¼‰åšçŠ¶æ€åŒæ­¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><img src="/images/spring-cloud-netflix/eureka/eureka-server-register.png" alt="Eureka Serveræ³¨å†Œæ—¶åºå›¾"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œä»‹ç»äº†Eurekaçš„ç›¸å…³çš„çŸ¥è¯†ï¼Œè§£é‡Šäº†Eurekaä¸ºä»€ä¹ˆé€‚åˆåšæœåŠ¡å‘ç°å’Œæ³¨å†Œã€‚æ¥ä¸‹æ¥ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å°†é€šè¿‡æºç åˆ†æçš„æ–¹å¼ï¼Œçœ‹ä¸€ä¸‹Eurekaæ˜¯æ€ä¹ˆworkçš„ã€‚æœ¬ç« ä¸»è¦ä»‹ç»Eurekaçš„æœåŠ¡æ³¨å†Œã€‚é‚£eureka clientå¦‚ä½•å°†æœ¬åœ°æœåŠ¡çš„æ³¨å†Œä¿¡æ¯å‘é€åˆ°è¿œç«¯çš„æ³¨å†ŒæœåŠ¡å™¨eureka serverä¸Šã€‚é€šè¿‡ä¸‹é¢çš„æºç åˆ†æï¼Œçœ‹å‡ºEureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„RESTæ¥å£ï¼Œè€ŒEurekaæ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚åä¼šå¤„ç†æœåŠ¡çš„æ³¨å†Œä»¥åŠEureka Serverä¸­çš„æ•°æ®åŒæ­¥çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æœåŠ¡æ³¨å†Œ&quot;&gt;&lt;a href=&quot;#æœåŠ¡æ³¨å†Œ&quot; class=&quot;headerlink&quot; title=&quot;æœåŠ¡æ³¨å†Œ&quot;&gt;&lt;/a&gt;æœåŠ¡æ³¨å†Œ&lt;/h2&gt;&lt;p&gt; æœåŠ¡æ³¨å†Œï¼Œæƒ³å¿…å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œå°±æ˜¯æœåŠ¡æä¾›è€…å¯åŠ¨çš„æ—¶å€™ï¼ŒæŠŠè‡ªå·±æä¾›çš„æœåŠ¡ä¿¡æ¯ï¼Œä¾‹å¦‚ æœåŠ¡åï¼ŒIPï¼Œç«¯å£å·ï¼Œç‰ˆæœ¬å·ç­‰ä¿¡æ¯æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œæ¯”å¦‚æ³¨å†Œåˆ°ZKä¸­ã€‚é‚£eureka clientå¦‚ä½•å°†æœ¬åœ°æœåŠ¡çš„æ³¨å†Œä¿¡æ¯å‘é€åˆ°è¿œç«¯çš„æ³¨å†ŒæœåŠ¡å™¨eureka serverä¸Šã€‚é€šè¿‡ä¸‹é¢çš„æºç åˆ†æï¼Œçœ‹å‡ºæœåŠ¡æ³¨å†Œå¯ä»¥è®¤ä¸ºæ˜¯Eureka clientè‡ªå·±å®Œæˆï¼Œä¸éœ€è¦æœåŠ¡æœ¬èº«æ¥å…³å¿ƒã€‚&lt;/p&gt;
&lt;h3 id=&quot;Eureka-Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka-Serverçš„æä¾›æ¥å£&quot;&gt;&lt;a href=&quot;#Eureka-Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka-Serverçš„æä¾›æ¥å£&quot; class=&quot;headerlink&quot; title=&quot;Eureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„æä¾›æ¥å£&quot;&gt;&lt;/a&gt;Eureka Clientçš„å®šæ—¶ä»»åŠ¡è°ƒç”¨Eureka Serverçš„æä¾›æ¥å£&lt;/h3&gt;&lt;p&gt;å®ç°æ€è·¯å…¶å®ä¹ŸæŒºç®€å•ï¼Œåœ¨com.netflix.discovery.DiscoveryClientå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶çš„æŠŠæœ¬åœ°çš„æœåŠ¡é…ç½®ä¿¡æ¯ï¼Œå³éœ€è¦æ³¨å†Œåˆ°è¿œç«¯çš„æœåŠ¡ä¿¡æ¯è‡ªåŠ¨åˆ·æ–°åˆ°æ³¨å†ŒæœåŠ¡å™¨ä¸Šã€‚&lt;br&gt;é¦–å…ˆçœ‹ä¸€ä¸‹Eurekaçš„ä»£ç ï¼Œåœ¨spring-cloud-netflix-eureka-serverå·¥ç¨‹ä¸­å¯ä»¥æ‰¾åˆ°è¿™ä¸ªä¾èµ–eureka-client-1.4.11.jaræŸ¥çœ‹ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ&lt;br&gt;com.netflix.discovery.DiscoveryClient.javaä¸­çš„1240è¡Œå¯ä»¥çœ‹åˆ°Initializes all scheduled tasksï¼Œåœ¨1277è¡Œï¼Œå¯ä»¥çœ‹åˆ°InstanceInfoReplicatorå®šæ—¶ä»»åŠ¡ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/categories/Spring-Cloud-Eureka/"/>
    
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/tags/Spring-Cloud-Eureka/"/>
    
      <category term="Spring Cloud æºç åˆ†æ" scheme="http://xujin.org/tags/Spring-Cloud-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Netflixä¹‹Eurekaä¸‹ç¯‡åŸç†</title>
    <link href="http://xujin.org/sc/sc-eureka-mid/"/>
    <id>http://xujin.org/sc/sc-eureka-mid/</id>
    <published>2016-10-25T06:00:00.000Z</published>
    <updated>2019-01-12T04:04:14.487Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ‘˜è¦</strong>:æœ¬æ–‡ä¸»è¦ä»‹ç»Eurekaçš„å·¥ä½œåŸç†ï¼ŒEureka ç»„ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š<code>Eureka server</code>å’Œ <code>Eureka client</code>ã€‚è€Œå®¢æˆ·ç«¯åˆåˆ†ä¸º <code>Application Service å®¢æˆ·ç«¯</code>å’Œ <code>Application Client å®¢æˆ·ç«¯</code>ä¸¤ç§ã€‚Eureka çš„å·¥ä½œæœºåˆ¶æ¯ä¸ª region éƒ½æœ‰è‡ªå·±çš„ Eureka æœåŠ¡å™¨é›†ç¾¤ï¼Œæ¯ä¸ª zone è‡³å°‘è¦æœ‰ä¸€ä¸ª Eureka æœåŠ¡å™¨ä»¥åº”å¯¹ zone ç˜«ç—ªã€‚<br><a id="more"></a></p><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><h3 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h3><ol><li>Renew:æˆ‘çš„ç†è§£æ˜¯ç»­çº¦ï¼Œä¸ºä»€ä¹ˆå«ç»­çº¦å‘¢ï¼Ÿ<br>Renewï¼ˆæœåŠ¡ç»­çº¦ï¼‰æ“ä½œç”±Service Provider<code>å®šæœŸè°ƒç”¨</code>ï¼Œç±»ä¼¼äºheartbeatã€‚ç›®çš„æ˜¯éš”ä¸€æ®µæ—¶é—´Service Providerè°ƒç”¨æ¥å£ï¼Œå‘Šè¯‰Eureka Serverå®ƒè¿˜æ´»ç€æ²¡æŒ‚ï¼Œä¸è¦æŠŠå®ƒè¸¢æ‰ã€‚é€šä¿—çš„è¯´å°±æ˜¯å®ƒä»¬ä¸¤ä¹‹é—´çš„å¿ƒè·³æ£€æµ‹ï¼Œé¿å…æœåŠ¡æä¾›è€…è¢«å‰”é™¤æ‰ã€‚</li><li>Cancelï¼ˆæœåŠ¡ä¸‹çº¿ï¼‰<br>ä¸€èˆ¬åœ¨Service Provider<code>æŒ‚äº†</code>æˆ–<code>shut down</code>çš„æ—¶å€™è°ƒç”¨ï¼Œç”¨æ¥æŠŠè‡ªèº«çš„æœåŠ¡ä»Eureka Serverä¸­<code>åˆ é™¤</code>ï¼Œä»¥é˜²å®¢æˆ·ç«¯è°ƒç”¨åˆ°ä¸å­˜åœ¨çš„æœåŠ¡ã€‚</li><li>Fetch Registries(è·å–æ³¨å†Œä¿¡æ¯)ï¼Œ<br>Fetch Registriesç”±Service Consumer(æœåŠ¡æ¶ˆè´¹è€…)è°ƒç”¨ï¼Œç”¨æ¥è·å–Eureka Serverä¸Šæ³¨å†Œçš„æœåŠ¡infoã€‚</li><li>Eviction(å‰”é™¤)<br>Evictionï¼ˆå¤±æ•ˆæœåŠ¡å‰”é™¤ï¼‰ç”¨æ¥å®šæœŸåœ¨Eureka Serveræ£€æµ‹å¤±æ•ˆçš„æœåŠ¡ï¼Œæ£€æµ‹æ ‡å‡†å°±æ˜¯è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰Renewçš„æœåŠ¡ã€‚<h2 id="å›é¡¾Eurekaæ¶æ„å›¾"><a href="#å›é¡¾Eurekaæ¶æ„å›¾" class="headerlink" title="å›é¡¾Eurekaæ¶æ„å›¾"></a>å›é¡¾Eurekaæ¶æ„å›¾</h2><h3 id="Eurekaæ¶æ„å›¾"><a href="#Eurekaæ¶æ„å›¾" class="headerlink" title="Eurekaæ¶æ„å›¾"></a>Eurekaæ¶æ„å›¾</h3>Eurekaæ¶æ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œgithubåœ°å€:<a href="https://github.com/netflix/eureka" target="_blank" rel="noopener">https://github.com/netflix/eureka</a><br>documentåœ°å€:<a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance" target="_blank" rel="noopener">https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance</a><br><img src="/images/spring-cloud-netflix/eureka/eureka_architecture.png" alt="Eurekaæ¶æ„å›¾"><br>&ensp;ã€€ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒEureka ç»„ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š<code>Eureka server</code>å’Œ <code>Eureka client</code>ã€‚è€Œå®¢æˆ·ç«¯åˆåˆ†ä¸º <code>Application Service å®¢æˆ·ç«¯</code>å’Œ <code>Application Client å®¢æˆ·ç«¯</code>ä¸¤ç§ã€‚Eureka çš„å·¥ä½œæœºåˆ¶æ¯ä¸ª region éƒ½æœ‰è‡ªå·±çš„ Eureka æœåŠ¡å™¨é›†ç¾¤ï¼Œæ¯ä¸ª zone è‡³å°‘è¦æœ‰ä¸€ä¸ª Eureka æœåŠ¡å™¨ä»¥åº”å¯¹ zone ç˜«ç—ªã€‚<br>&ensp;ã€€Application Service åœ¨å¯åŠ¨æ—¶æ³¨å†Œåˆ° Eureka æœåŠ¡å™¨ï¼Œä¹‹åæ¯ <code>30</code> ç§’é’Ÿå‘é€å¿ƒè·³ä»¥æ›´æ–°è‡ªèº«çŠ¶æ€,å³<code>Renew(ç»­çº¦)</code>ã€‚å¦‚æœè¯¥å®¢æˆ·ç«¯æ²¡èƒ½å‘é€å¿ƒè·³æ›´æ–°ï¼Œå®ƒå°†åœ¨ <code>90</code> ç§’ä¹‹åè¢«å…¶æ³¨å†Œçš„ Eureka æœåŠ¡å™¨å‰”é™¤ï¼Œå³<code>Eviction(å‰”é™¤)</code>ã€‚æ¥è‡ªä»»æ„ zone çš„ Application Client å¯ä»¥è·å–è¿™äº›æ³¨å†Œä¿¡æ¯(æ¯éš” <code>30</code> ç§’æŸ¥çœ‹ä¸€æ¬¡)å¹¶ä¾æ­¤å®šä½åˆ°åœ¨ä»»ä½•åŒºåŸŸå¯ä»¥ç»™è‡ªå·±æä¾›æœåŠ¡çš„æä¾›è€…(å³Fetch Registries)ï¼Œè¿›è€Œè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚<blockquote><p>æœåŠ¡æä¾›è€…æœ¬èº«æºå¸¦çš„Eureka Clientæ—¢èƒ½<code>æœåŠ¡æ³¨å†Œ</code>ï¼Œ<code>æœåŠ¡ç»­çº¦</code>ï¼Œä¹Ÿèƒ½é€šè¿‡client<code>å®šä½æœåŠ¡</code>å’Œ<code>è°ƒç”¨å…¶å®ƒçš„æœåŠ¡</code>ã€‚</p></blockquote></li></ol><h2 id="æœåŠ¡æ³¨å†Œ"><a href="#æœåŠ¡æ³¨å†Œ" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h2><h3 id="æœåŠ¡æ³¨å†Œ-1"><a href="#æœåŠ¡æ³¨å†Œ-1" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h3><p>  æœåŠ¡æ³¨å†Œæºç åˆ†æï¼Œè¯·å‚è€ƒ:<a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-register/</a></p><h2 id="Renew-æœåŠ¡ç»­çº¦"><a href="#Renew-æœåŠ¡ç»­çº¦" class="headerlink" title="Renew(æœåŠ¡ç»­çº¦)"></a>Renew(æœåŠ¡ç»­çº¦)</h2><h3 id="æœåŠ¡ç»­çº¦"><a href="#æœåŠ¡ç»­çº¦" class="headerlink" title="æœåŠ¡ç»­çº¦"></a>æœåŠ¡ç»­çº¦</h3><p>  Renewæ“ä½œä¼šåœ¨Service Providerç«¯å®šæœŸå‘èµ·ï¼Œç”¨æ¥é€šçŸ¥Eureka Serverè‡ªå·±è¿˜æ´»ç€ã€‚ è¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„é…ç½®éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.leaseRenewalIntervalInSeconds</span><br></pre></td></tr></table></figure></p><p>  Renewé¢‘ç‡ã€‚é»˜è®¤æ˜¯30ç§’ï¼Œä¹Ÿå°±æ˜¯æ¯30ç§’ä¼šå‘Eureka Serverå‘èµ·Renewæ“ä½œã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.leaseExpirationDurationInSeconds</span><br></pre></td></tr></table></figure></p><p> æœåŠ¡å¤±æ•ˆæ—¶é—´ã€‚é»˜è®¤æ˜¯90ç§’ï¼Œä¹Ÿå°±æ˜¯å¦‚æœEureka Serveråœ¨90ç§’å†…æ²¡æœ‰æ¥æ”¶åˆ°æ¥è‡ªService Providerçš„Renewæ“ä½œï¼Œå°±ä¼šæŠŠService Providerå‰”é™¤ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;:æœ¬æ–‡ä¸»è¦ä»‹ç»Eurekaçš„å·¥ä½œåŸç†ï¼ŒEureka ç»„ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š&lt;code&gt;Eureka server&lt;/code&gt;å’Œ &lt;code&gt;Eureka client&lt;/code&gt;ã€‚è€Œå®¢æˆ·ç«¯åˆåˆ†ä¸º &lt;code&gt;Application Service å®¢æˆ·ç«¯&lt;/code&gt;å’Œ &lt;code&gt;Application Client å®¢æˆ·ç«¯&lt;/code&gt;ä¸¤ç§ã€‚Eureka çš„å·¥ä½œæœºåˆ¶æ¯ä¸ª region éƒ½æœ‰è‡ªå·±çš„ Eureka æœåŠ¡å™¨é›†ç¾¤ï¼Œæ¯ä¸ª zone è‡³å°‘è¦æœ‰ä¸€ä¸ª Eureka æœåŠ¡å™¨ä»¥åº”å¯¹ zone ç˜«ç—ªã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/categories/Spring-Cloud-Eureka/"/>
    
    
      <category term="Spring Cloud Eureka" scheme="http://xujin.org/tags/Spring-Cloud-Eureka/"/>
    
  </entry>
  
  <entry>
    <title>ä»€ä¹ˆæ˜¯Spring Cloud Configï¼Ÿ</title>
    <link href="http://xujin.org/sc/sc-config/"/>
    <id>http://xujin.org/sc/sc-config/</id>
    <published>2016-10-19T06:00:00.000Z</published>
    <updated>2019-01-12T03:44:13.973Z</updated>
    
    <content type="html"><![CDATA[<p>å‰è¨€:åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬çš„åšæ³•æ˜¯æŠŠPropertyå’ŒCodeæ”¾åœ¨ä¸€èµ·ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºå­˜åœ¨å¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œéœ€è¦åˆ†åˆ«ç®¡ç†åˆ°æ¯ä¸ªå…·ä½“çš„æœåŠ¡å·¥ç¨‹ä¸­çš„é…ç½®ï¼Œä¸Šçº¿éœ€è¦å‡†å¤‡check list å¹¶é€ä¸ªæ£€æŸ¥æ¯ä¸ªä¸Šçº¿çš„æœåŠ¡æ˜¯å¦æ­£ç¡®ã€‚åœ¨ç³»ç»Ÿä¸Šçº¿ä¹‹åä¿®æ”¹æŸä¸ªé…ç½®ï¼Œéœ€è¦é‡å¯æœåŠ¡ã€‚è¿™æ ·å¼€å‘å°±ç›¸å½“éº»çƒ¦ã€‚å› æ­¤æˆ‘ä»¬æ€¥éœ€éœ€è¦æŠŠåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é…ç½®ä¿¡æ¯æŠ½å–å‡ºæ¥ç»Ÿä¸€ç®¡ç†ï¼ŒæœåŠ¡è·å–ç³»ç»Ÿä¿¡æ¯æ—¶æœ‰ä¸€ä¸ªè¦†ç›–é¡ºåº:propertyâ€“&gt; Evnâ€”-&gt;é…ç½®ä¸­å¿ƒã€‚è¿™æ ·ä¿®æ”¹ç¯å¢ƒå˜é‡æˆ–è€…ä¿®æ”¹é…ç½®ä¸­å¿ƒçš„é…ç½®å°±èƒ½å–åˆ°æœ€æ–°çš„é…ç½®ä¿¡æ¯ã€‚åœ¨å”¯å“ä¼š Venus Frameworkä¸­æˆ‘ä»¬ä¸“é—¨è®¾è®¡äº†è¿™ä¸ªåŠŸèƒ½ã€‚Spring cloudå‡ºç°ä¹‹åï¼Œé¿å…äº†å¤§å®¶é‡å¤é€ è½®å­ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-Spring-Cloud-Config"><a href="#ä»€ä¹ˆæ˜¯-Spring-Cloud-Config" class="headerlink" title="ä»€ä¹ˆæ˜¯ Spring Cloud Config ?"></a>ä»€ä¹ˆæ˜¯ Spring Cloud Config ?</h2><p>å…¶å®˜æ–¹æ–‡æ¡£ä¸­å¯¹è‡ªå·±çš„å®šä¹‰æ˜¯å¦‚ä¸‹ï¼Œå®˜ç½‘è¿æ¥:<a href="http://cloud.spring.io/spring-cloud-config/" target="_blank">Spring Cloud Config</a>ã€‚</p><blockquote><p>Spring Cloud Config provides server and client-side support for externalized configuration in a distributed system.<br>With the Config Server you have a central place to manage external properties for applications across all environments.</p></blockquote><p>ç®€å•æ¥è¯´ï¼ŒSpring Cloud Configå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šçš„é…ç½®ä¸­å¿ƒ - æŠŠåº”ç”¨åŸæœ¬æ”¾åœ¨æœ¬åœ°æ–‡ä»¶çš„é…ç½®æŠ½å–å‡ºæ¥æ”¾åœ¨ä¸­å¿ƒæœåŠ¡å™¨ï¼Œä»è€Œèƒ½å¤Ÿæä¾›æ›´å¥½çš„ç®¡ç†ã€å‘å¸ƒèƒ½åŠ›ã€‚<br><a id="more"></a></p><p>å¦å¤–ï¼ŒSpring Cloud Configæä¾›åŸºäºä»¥ä¸‹3ä¸ªç»´åº¦çš„é…ç½®ç®¡ç†ï¼š</p><ul><li><strong>åº”ç”¨</strong><ul><li>è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œæ¯ä¸ªé…ç½®éƒ½æ˜¯å±äºæŸä¸€ä¸ªåº”ç”¨çš„</li></ul></li><li><strong>ç¯å¢ƒ</strong><ul><li>æ¯ä¸ªé…ç½®éƒ½æ˜¯åŒºåˆ†ç¯å¢ƒçš„ï¼Œå¦‚dev, test, prodç­‰</li></ul></li><li><strong>ç‰ˆæœ¬</strong><ul><li>è¿™ä¸ªå¯èƒ½æ˜¯ä¸€èˆ¬çš„é…ç½®ä¸­å¿ƒæ‰€ç¼ºä¹çš„ï¼Œå°±æ˜¯å¯¹åŒä¸€ä»½é…ç½®çš„ä¸åŒç‰ˆæœ¬ç®¡ç†ï¼Œæ¯”å¦‚:å¯ä»¥é€šè¿‡Gitè¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚</li><li>Spring Cloud Configæä¾›ç‰ˆæœ¬çš„æ”¯æŒï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äºä¸€ä¸ªåº”ç”¨çš„ä¸åŒéƒ¨ç½²å®ä¾‹ï¼Œå¯ä»¥ä»æœåŠ¡ç«¯è·å–åˆ°ä¸åŒç‰ˆæœ¬çš„é…ç½®ï¼Œè¿™å¯¹äºä¸€äº›ç‰¹æ®Šåœºæ™¯å¦‚ï¼šç°åº¦å‘å¸ƒï¼ŒA/Bæµ‹è¯•ç­‰æä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚</li></ul></li></ul><h2 id="ä¸ºä»€ä¹ˆä¼šè¯ç”ŸSpring-Cloud-Config"><a href="#ä¸ºä»€ä¹ˆä¼šè¯ç”ŸSpring-Cloud-Config" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šè¯ç”ŸSpring Cloud Config?"></a>ä¸ºä»€ä¹ˆä¼šè¯ç”ŸSpring Cloud Config?</h2><p>   é…ç½®ä¸­å¿ƒç›®å‰ç°çŠ¶:ä¸ç®¡æ˜¯å¼€æºçš„(ç™¾åº¦çš„disconf)ï¼Œè¿˜æ˜¯ä¸€äº›å…¬å¸è‡ªå·±é—­æºæŠ•å…¥ä½¿ç”¨çš„äº§å“å·²ç»ä¸å°‘äº†ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜ä¼šè¯ç”ŸSpring Cloud Configå‘¢ï¼Ÿ</p><p>åœ¨æˆ‘çœ‹æ¥ï¼ŒSpring Cloud Configåœ¨ä»¥ä¸‹å‡ æ–¹é¢è¿˜æ˜¯æœ‰æ¯”è¾ƒç‹¬ç‰¹çš„ä¼˜åŠ¿ï¼Œå¦‚ä¸‹ï¼š</p><ul><li><strong>åŸºäºåº”ç”¨ã€ç¯å¢ƒã€ç‰ˆæœ¬ä¸‰ä¸ªç»´åº¦ç®¡ç†</strong><ul><li>è¿™ä¸ªåœ¨å‰é¢æè¿‡äº†ï¼Œä¸»è¦æ˜¯æœ‰ç‰ˆæœ¬çš„æ”¯æŒ</li></ul></li><li><strong>é…ç½®å­˜å‚¨æ”¯æŒGit</strong><ul><li>è¿™ä¸ªå°±æ¯”è¾ƒæœ‰ç‰¹è‰²äº†ï¼Œåç«¯åŸºäºGitå­˜å‚¨ï¼Œä¸€æ–¹é¢ç¨‹åºå‘˜éå¸¸ç†Ÿæ‚‰ï¼Œå¦ä¸€æ–¹é¢åœ¨éƒ¨ç½²ä¸Šä¼šéå¸¸ç®€å•ï¼Œè€Œä¸”å€ŸåŠ©äºGitï¼Œå¤©ç”Ÿå°±èƒ½éå¸¸å¥½çš„æ”¯æŒç‰ˆæœ¬</li><li>å½“ç„¶ï¼Œå®ƒè¿˜æ”¯æŒå…¶å®ƒçš„å­˜å‚¨å¦‚æœ¬åœ°æ–‡ä»¶ã€SVNç­‰</li></ul></li><li><strong>å’ŒSpringæ— ç¼é›†æˆ</strong><ul><li>å®ƒæ— ç¼æ”¯æŒSpringé‡Œé¢<code>Environment</code>å’Œ<code>PropertySource</code>çš„æ¥å£</li><li>æ‰€ä»¥å¯¹äºå·²æœ‰çš„Springåº”ç”¨ç¨‹åºçš„è¿ç§»æˆæœ¬éå¸¸ä½ï¼Œåœ¨é…ç½®è·å–çš„æ¥å£ä¸Šæ˜¯å®Œå…¨ä¸€è‡´çš„</li></ul></li></ul><h2 id="Spring-Cloud-Config-å…¥é—¨ä¾‹å­"><a href="#Spring-Cloud-Config-å…¥é—¨ä¾‹å­" class="headerlink" title="Spring Cloud Config å…¥é—¨ä¾‹å­"></a>Spring Cloud Config å…¥é—¨ä¾‹å­</h2><p>ä¸Šè¿°èŠ‚ç‚¹ä¸»è¦ä»‹ç»äº†Spring cloudçš„ç›¸å…³ç†è®ºï¼Œå¤§å®¶å¯¹Spring Cloud Configæœ‰äº†ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ï¼Œæ¥ä¸‹æ¥ä¾‹å­è®©å¤§å®¶æ„Ÿå—ä¸€ä¸‹Spring cloud configçš„é­…åŠ›ã€‚</p><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p><img src="/images/2016-10-18/overview.png" alt="Overview"></p><p>ä¸Šå›¾ç®€è¦æè¿°äº†ä¸€ä¸ªæ™®é€šSpring Cloud Configåº”ç”¨çš„åœºæ™¯ã€‚å…¶ä¸­ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p><ul><li><em>Config Client</em><ul><li>Clientå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ä½¿ç”¨äº†Spring Cloud Configçš„åº”ç”¨</li><li>Spring Cloud Configæä¾›äº†åŸºäºSpringçš„å®¢æˆ·ç«¯ï¼Œåº”ç”¨åªè¦åœ¨ä»£ç ä¸­å¼•å…¥Spring Cloud Config Clientçš„jaråŒ…å³å¯å·¥ä½œ</li></ul></li><li><em>Config Server</em><ul><li>Config Serveræ˜¯éœ€è¦ç‹¬ç«‹éƒ¨ç½²çš„ä¸€ä¸ªwebåº”ç”¨ï¼Œå®ƒè´Ÿè´£æŠŠgitä¸Šçš„é…ç½®è¿”å›ç»™å®¢æˆ·ç«¯</li></ul></li><li><em>Remote Git Repository</em><ul><li>è¿œç¨‹Gitä»“åº“ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä¼šæŠŠé…ç½®æ”¾åœ¨ä¸€ä¸ªè¿œç¨‹ä»“åº“ï¼Œé€šè¿‡ç°æˆçš„gitå®¢æˆ·ç«¯æ¥ç®¡ç†é…ç½®</li></ul></li><li><em>Local Git Repostiory</em><ul><li>Config Serverçš„æœ¬åœ°Gitä»“åº“</li><li>Config Serveræ¥åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„é…ç½®è·å–è¯·æ±‚åï¼Œä¼šå…ˆæŠŠè¿œç¨‹ä»“åº“çš„é…ç½®cloneåˆ°æœ¬åœ°çš„ä¸´æ—¶ç›®å½•ï¼Œç„¶åä»ä¸´æ—¶ç›®å½•è¯»å–é…ç½®å¹¶è¿”å›</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰è¨€:åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬çš„åšæ³•æ˜¯æŠŠPropertyå’ŒCodeæ”¾åœ¨ä¸€èµ·ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºå­˜åœ¨å¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œéœ€è¦åˆ†åˆ«ç®¡ç†åˆ°æ¯ä¸ªå…·ä½“çš„æœåŠ¡å·¥ç¨‹ä¸­çš„é…ç½®ï¼Œä¸Šçº¿éœ€è¦å‡†å¤‡check list å¹¶é€ä¸ªæ£€æŸ¥æ¯ä¸ªä¸Šçº¿çš„æœåŠ¡æ˜¯å¦æ­£ç¡®ã€‚åœ¨ç³»ç»Ÿä¸Šçº¿ä¹‹åä¿®æ”¹æŸä¸ªé…ç½®ï¼Œéœ€è¦é‡å¯æœåŠ¡ã€‚è¿™æ ·å¼€å‘å°±ç›¸å½“éº»çƒ¦ã€‚å› æ­¤æˆ‘ä»¬æ€¥éœ€éœ€è¦æŠŠåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é…ç½®ä¿¡æ¯æŠ½å–å‡ºæ¥ç»Ÿä¸€ç®¡ç†ï¼ŒæœåŠ¡è·å–ç³»ç»Ÿä¿¡æ¯æ—¶æœ‰ä¸€ä¸ªè¦†ç›–é¡ºåº:propertyâ€“&amp;gt; Evnâ€”-&amp;gt;é…ç½®ä¸­å¿ƒã€‚è¿™æ ·ä¿®æ”¹ç¯å¢ƒå˜é‡æˆ–è€…ä¿®æ”¹é…ç½®ä¸­å¿ƒçš„é…ç½®å°±èƒ½å–åˆ°æœ€æ–°çš„é…ç½®ä¿¡æ¯ã€‚åœ¨å”¯å“ä¼š Venus Frameworkä¸­æˆ‘ä»¬ä¸“é—¨è®¾è®¡äº†è¿™ä¸ªåŠŸèƒ½ã€‚Spring cloudå‡ºç°ä¹‹åï¼Œé¿å…äº†å¤§å®¶é‡å¤é€ è½®å­ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯-Spring-Cloud-Config&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯-Spring-Cloud-Config&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯ Spring Cloud Config ?&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯ Spring Cloud Config ?&lt;/h2&gt;&lt;p&gt;å…¶å®˜æ–¹æ–‡æ¡£ä¸­å¯¹è‡ªå·±çš„å®šä¹‰æ˜¯å¦‚ä¸‹ï¼Œå®˜ç½‘è¿æ¥:&lt;a href=&quot;http://cloud.spring.io/spring-cloud-config/&quot; target=&quot;_blank&quot;&gt;Spring Cloud Config&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Spring Cloud Config provides server and client-side support for externalized configuration in a distributed system.&lt;br&gt;With the Config Server you have a central place to manage external properties for applications across all environments.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç®€å•æ¥è¯´ï¼ŒSpring Cloud Configå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šçš„é…ç½®ä¸­å¿ƒ - æŠŠåº”ç”¨åŸæœ¬æ”¾åœ¨æœ¬åœ°æ–‡ä»¶çš„é…ç½®æŠ½å–å‡ºæ¥æ”¾åœ¨ä¸­å¿ƒæœåŠ¡å™¨ï¼Œä»è€Œèƒ½å¤Ÿæä¾›æ›´å¥½çš„ç®¡ç†ã€å‘å¸ƒèƒ½åŠ›ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud" scheme="http://xujin.org/categories/Spring-Cloud/"/>
    
    
      <category term="Spring Cloud Config" scheme="http://xujin.org/tags/Spring-Cloud-Config/"/>
    
  </entry>
  
</feed>
