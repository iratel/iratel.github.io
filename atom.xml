<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>许进沉思录-专注于互联网与中间件基础架构技术研究</title>
  <subtitle>沉思录</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://xujin.org/"/>
  <updated>2019-03-07T09:14:13.082Z</updated>
  <id>http://xujin.org/</id>
  
  <author>
    <name>许进</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring Boot Admin和Nacos集成</title>
    <link href="http://xujin.org/sc/sba-nacos/"/>
    <id>http://xujin.org/sc/sba-nacos/</id>
    <published>2019-03-07T06:00:00.000Z</published>
    <updated>2019-03-07T09:14:13.082Z</updated>
    
    <content type="html"><![CDATA[<p> <strong>摘要</strong>:本文主要讲解如何将<code>Spring Boot Admin</code>与Spring Cloud Alibaba中的<code>spring-cloud-starter-alibaba-nacos-discovery</code>进行整合使用。</p>
<a id="more"></a>
<h2 id="1-整合概述"><a href="#1-整合概述" class="headerlink" title="1. 整合概述"></a>1. 整合概述</h2><p> 通过搭建一个Spring Boot Admin Server，并将其通过spring-cloud-starter-alibaba-nacos-discovery注册到Nacos Server中即可。<br> 源码工程地址为:<a href="https://github.com/SoftwareKing/sba-nacos" target="_blank" rel="external">https://github.com/SoftwareKing/sba-nacos</a></p>
<blockquote>
<p>说明本文使用的Spring Boot Admin的版本为2.1.2，Spring Cloud的版本为Greenwich.RELEASE，Spring Cloud Alibaba的版本为0.2.1.RELEASE。至于其它版本，请读者自行适配处理。</p>
</blockquote>
<h2 id="2-创建sba-nacos工程"><a href="#2-创建sba-nacos工程" class="headerlink" title="2. 创建sba-nacos工程"></a>2. 创建sba-nacos工程</h2><p>1.创建sba-nacos工程，添加maven依赖如下所示:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xujin.moss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sba-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">spring.boot.admin.version</span>&gt;</span>2.1.2<span class="tag">&lt;/<span class="name">spring.boot.admin.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-starter-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.admin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jolokia<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jolokia-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>sba-nacos<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>创建主入口程序，代码如下所示:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.xujin.moss.nacos;</div><div class="line"></div><div class="line"><span class="keyword">import</span> de.codecentric.boot.admin.server.config.EnableAdminServer;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableAdminServer</span></div><div class="line"><span class="meta">@EnableDiscoveryClient</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MossNacosApplication</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(MossNacosApplication.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.application.yml配置如下所示:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">    application:</span></div><div class="line"><span class="attr">        name:</span> sba-nacos</div><div class="line"><span class="attr">    cloud:</span></div><div class="line"><span class="attr">      nacos:</span></div><div class="line"><span class="attr">        discovery:</span></div><div class="line"><span class="attr">          server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8848</span></div><div class="line"></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">    port:</span> <span class="number">8080</span> <span class="comment">#启动端口</span></div><div class="line"></div><div class="line">info.groupId: @project.groupId@</div><div class="line">info.artifactId: @project.artifactId@</div><div class="line">info.version: @project.version@</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#开启端点</span></div><div class="line"><span class="attr">management:</span></div><div class="line"><span class="attr">  endpoints:</span></div><div class="line"><span class="attr">    web:</span></div><div class="line"><span class="attr">      exposure:</span></div><div class="line"><span class="attr">        include:</span> <span class="string">'*'</span></div><div class="line"><span class="attr">  security:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  endpoint:</span></div><div class="line"><span class="attr">    health:</span></div><div class="line"><span class="attr">      show-details:</span> ALWAYS</div></pre></td></tr></table></figure>
<blockquote>
<p>其中127.0.0.1:8848为Nacos Server的地址。</p>
</blockquote>
<h2 id="3-启动测试"><a href="#3-启动测试" class="headerlink" title="3.启动测试"></a>3.启动测试</h2><h3 id="3-1-本地源码启动Nacos"><a href="#3-1-本地源码启动Nacos" class="headerlink" title="3.1 本地源码启动Nacos"></a>3.1 本地源码启动Nacos</h3><p>至于什么是Nacos，这里不做过多介绍。有兴趣者可以访问<a href="http://nacos.io" target="_blank" rel="external">http://nacos.io</a>,或者访问: <a href="http://nacos.net" target="_blank" rel="external">http://nacos.net</a>.</p>
<blockquote>
<p>说明: <a href="http://nacos.net" target="_blank" rel="external">http://nacos.net</a>.目前内容为快照版本。</p>
</blockquote>
<p>访问<a href="https://github.com/alibaba/nacos" target="_blank" rel="external">https://github.com/alibaba/nacos</a> ,使用Git克隆Nacos代码，直接导入到IDEA中，如下所示设置启动参数，直接启动。<br><img src="https://raw.githubusercontent.com/SoftwareKing/cdn/master/images/me20190307131151.png" alt=""></p>
<blockquote>
<p>从IDE中启动Nacos是我个人喜欢的方式，因为可以随时Debug Nacos任何代码，其它启动方式请参考官网。</p>
</blockquote>
<h3 id="3-2-启动sba-nacos"><a href="#3-2-启动sba-nacos" class="headerlink" title="3.2 启动sba-nacos"></a>3.2 启动sba-nacos</h3><p>以Debug方式启动，sba-nacos，如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/SoftwareKing/cdn/master/images/me20190307131651.png" alt=""></p>
<p>启动之后访问nacos控制台，我们可以看到sba-nacos已经注册到Nacos注册中心。如下图所示.<br><img src="https://raw.githubusercontent.com/SoftwareKing/cdn/master/images/me20190307131338.png" alt=""></p>
<blockquote>
<p>说明访问Nacos控制台，需要输入用户名和密码默认为用户名为nacos，密码:nacos</p>
</blockquote>
<p>访问<a href="http://localhost:8080/#/instances/92cfba09790d/details，我们可以看到Spring" target="_blank" rel="external">http://localhost:8080/#/instances/92cfba09790d/details，我们可以看到Spring</a> Boot Admin Server已经成功启动，并且通过EndPoint获取到自己的端点信息，如下图所示:</p>
<p><img src="https://raw.githubusercontent.com/SoftwareKing/cdn/master/images/me20190307132151.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt; &lt;strong&gt;摘要&lt;/strong&gt;:本文主要讲解如何将&lt;code&gt;Spring Boot Admin&lt;/code&gt;与Spring Cloud Alibaba中的&lt;code&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/code&gt;进行整合使用。&lt;/p&gt;
    
    </summary>
    
      <category term="Moss" scheme="http://xujin.org/categories/Moss/"/>
    
    
      <category term="Naocs" scheme="http://xujin.org/tags/Naocs/"/>
    
  </entry>
  
  <entry>
    <title>Moss-让Spring Cloud应用“不再流浪”</title>
    <link href="http://xujin.org/mw/moss/1/"/>
    <id>http://xujin.org/mw/moss/1/</id>
    <published>2019-03-05T06:00:00.000Z</published>
    <updated>2019-03-07T09:18:14.624Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>: 本文介绍了什么是Moss以及Moss的功能包括服务画像，服务实例画像，服务上下线事件记录，服务上下线websocket消息通知，针对生产应用可配置多种服务上线通知工具，支持多种注册中心，比如Eureka，Consul，Nacos.支持动态连接注册中心进去切换进行服务治理操作。</p>
<a id="more"></a>
<h2 id="1-什么是Moss"><a href="#1-什么是Moss" class="headerlink" title="1.什么是Moss"></a>1.什么是Moss</h2><h3 id="1-1-什么是服务治理"><a href="#1-1-什么是服务治理" class="headerlink" title="1.1 什么是服务治理"></a>1.1 什么是服务治理</h3><p>服务治理，我也称之为微服务治理，是指用来管理微服务的整个生命周期。包括应用的创建，服务名的规范，服务的上下线，服务的迁移，整个服务的生老病死等方方面面的治理。<br><img src="https://raw.githubusercontent.com/SoftwareKing/cdn/master/images/me20190307171756.png" alt=""></p>
<h3 id="1-2-Moss概述"><a href="#1-2-Moss概述" class="headerlink" title="1.2 Moss概述"></a>1.2 Moss概述</h3><p> Moss(<code>莫斯</code>)是<code>服务治理平台的代号</code>，取名灵感来自电影《流浪地球》中的莫斯(Moss),Moss是电影《流浪地球》中领航员号空间站的人工智能机器人-负责管理空间站所有事务以及流浪地球的计划，而Moss跟Boos一样，是所有微服务的老板，Moss首字母M取Micro Service中Micro的首字母。所有微服务的生命周期将归其统管。</p>
<p> 为什么会<code>出现Moss</code>？因为基于Spring Cloud的微服务体系，<code>缺乏统一的可视化的纳管治理平台</code>。</p>
<blockquote>
<p>Spring Cloud中国社区从2017年11月份，开始规划Spring Cloud Admin的开发和设计，专注于研究这个领域。Moss将会选择一个合适的时机开源，需要更多了解的可以加我微信Software_King。</p>
</blockquote>
<h3 id="1-3-Moss的功能"><a href="#1-3-Moss的功能" class="headerlink" title="1.3 Moss的功能"></a>1.3 Moss的功能</h3><p>Moss的功能包括服务画像，服务实例画像，服务上下线事件记录，服务上下线websocket消息通知，针对生产应用可配置多种服务上线通知工具，支持多种注册中心，比如Eureka，Consul，Nacos.支持动态连接注册中心进去切换进行服务治理操作。</p>
<h4 id="1-3-1-服务画像"><a href="#1-3-1-服务画像" class="headerlink" title="1.3.1 服务画像"></a>1.3.1 服务画像</h4><ul>
<li>服务画像: <ul>
<li>服务概要信息-<code>包括服务实例数，UP数，DOWN数，OffLine数，服务归属的项目，归属的Owner等</code>。</li>
<li>服务健康指标-展示服务的健康信息</li>
<li>服务请求映射-展示出服务对外提供的<code>所有REST接口</code></li>
<li>服务调用链-展示服务的依赖调用拓扑</li>
<li>服务API监控-通过http trace和全链路监控对API进行监控</li>
<li>服务内部组件状态-内部组件的依赖，使用版本状态</li>
<li>服务性能指标-<code>对服务进行QPS，性能指标收集打分</code></li>
<li>服务评级-自动根据评级规则对服务进行跑批评分打星。</li>
</ul>
</li>
</ul>
<h4 id="1-3-2-服务实例画像"><a href="#1-3-2-服务实例画像" class="headerlink" title="1.3.2 服务实例画像"></a>1.3.2 服务实例画像</h4><ul>
<li>服务实例画像<ul>
<li>实例调用拓扑-对接Skywalking，PinPoint等获取实例调用拓扑</li>
<li>实例Build信息-实例构建信息</li>
<li>实例Git提交信息-最后一次提交人的Git详细信息</li>
<li>Spring Cloud使用功能列表</li>
<li>实例的健康信息</li>
<li>实例的上下线Event信息</li>
<li>服务日志级别-查看应用的日志级别,根据需要调整日志级别打印对应日志级别的信息</li>
<li>环境配置-查看当前应用的环境配置信息</li>
<li>实例JMX信息-分类展示实例的JMX信息</li>
<li>查看JVM-实时展示应用实例的内存使用情况，GC次数，以及CPU和内存使用率</li>
<li>查看日志-实时获取应用的info日志或Error日志</li>
<li>查看线程-查看当前实例的线程情况</li>
<li>查看实例内部依赖-查看实例的内部Jar依赖情况，统计分析展示依赖拓扑等</li>
<li>HttpTrace-按时间展示http请求的轨迹信息，包括请求的路径，Response的状态，调用耗时等</li>
<li>支持GC Log日志查看</li>
</ul>
</li>
</ul>
<h4 id="1-3-3-服务纳管"><a href="#1-3-3-服务纳管" class="headerlink" title="1.3.3 服务纳管"></a>1.3.3 服务纳管</h4><p>   项目对应多个应用，每个应用由多个实例组成提供具体的服务，服务的生命周期管理需要可控，可追溯，可监控，可规范。<br>   由Spring Cloud体系构建的微服务体系，应用名即服务名。服务纳管分为历史应用纳管和新应用纳管。</p>
<ul>
<li>新应用纳管: 新应用使用Moss-Client，启动时连接Moss对应用名进行统一拦截check，从而规范应用名。</li>
<li>旧应用纳管: 旧应用引入对应的版本的Moss-Client，在Moss平台对其手动接入管理，录入应用名。</li>
</ul>
<h4 id="1-3-4-多注册中心支持"><a href="#1-3-4-多注册中心支持" class="headerlink" title="1.3.4 多注册中心支持"></a>1.3.4 多注册中心支持</h4><p>Moss通过注册中心接管Spring Cloud体系的微服务。支持动态连接注册中心，填注册中心的URL即可，快速接管服务。</p>
<h4 id="1-3-5-服务报表数据"><a href="#1-3-5-服务报表数据" class="headerlink" title="1.3.5 服务报表数据"></a>1.3.5 服务报表数据</h4><p>Moss通过注册中心接管Spring Cloud体系的微服务。然后获取每个服务使用Spring Boot的版本和Spring Cloud的版本，Moss的接入率以报表数据展示。</p>
<h2 id="2-Moss的架构设计"><a href="#2-Moss的架构设计" class="headerlink" title="2.Moss的架构设计"></a>2.Moss的架构设计</h2><h3 id="2-1-Moss的架构设计"><a href="#2-1-Moss的架构设计" class="headerlink" title="2.1 Moss的架构设计"></a>2.1 Moss的架构设计</h3><p>  Moss基于Spring Boot Admin 2.1.2版中的spring-boot-admin-server模块二次开发，基于可扩展思想。前端采用Ant Design Pro，采用Spring Boot+shiro+JWT+LDAP实现整个权限认证管理。通过Moss-Cloud-Adapter模块支持多注册中心，应用启动对应用名进行check是否规范。</p>
<blockquote>
<p>实现细节后续补充</p>
</blockquote>
<h3 id="2-2-Moss的服务设计"><a href="#2-2-Moss的服务设计" class="headerlink" title="2.2 Moss的服务设计"></a>2.2 Moss的服务设计</h3><p>Moss服务端主要自动探测EndPoint，代理EndPoint，对接各种注册中心，提供可视化的管理。</p>
<h3 id="2-3-Moss的客户端设计"><a href="#2-3-Moss的客户端设计" class="headerlink" title="2.3 Moss的客户端设计"></a>2.3 Moss的客户端设计</h3><p>moss客户端主要用于内置预设自研端点和管理配置信息，使接入方无感知接入。</p>
<blockquote>
<p>实现细节后续补充</p>
</blockquote>
<h4 id="2-3-1-Moss-Client"><a href="#2-3-1-Moss-Client" class="headerlink" title="2.3.1 Moss-Client"></a>2.3.1 Moss-Client</h4><p>Moss客户端支持两种Spring Boot版本，分别是Spring Boot 1.5.X和Spring Boot 2.X，使用只需引入moss-client-starter即可。示例2.x的客户端如下所示。</p>
<p>1.引入moss-client-starter</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xujin.moss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>moss-client-2.x<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>2.在application.yml中增加配置如下</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">info.groupId: @project.groupId@</div><div class="line">info.artifactId: @project.artifactId@</div><div class="line">info.version: @project.version@</div></pre></td></tr></table></figure>
<p>3.在pom中增加maven插件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>pl.project13.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>git-commit-id-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">			  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">							<span class="tag">&lt;<span class="name">goal</span>&gt;</span>revision<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">						<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">			  <span class="tag">&lt;<span class="name">dotGitDirectory</span>&gt;</span>$&#123;project.basedir&#125;/.git<span class="tag">&lt;/<span class="name">dotGitDirectory</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="3-Moss的实现细节"><a href="#3-Moss的实现细节" class="headerlink" title="3.Moss的实现细节"></a>3.Moss的实现细节</h2><p>关于Moss的实现细节，后续文章进行揭秘！敬请期待。</p>
<ul>
<li>Moss Client如何内置预设Spring Boot的Management信息</li>
<li>Moss client如何兼容Spring Boot 1.5.X和Spring Boot 2.x的Metrics信息</li>
<li>Moss client如何解决运维访问管理端口Health端点不需要前缀，而Moss治理需要带/actuator前缀</li>
<li>Moss服务端的选型设计和扩展</li>
<li>Moss的动态连接注册中心，支持多种注册中心的</li>
<li>@RestControllerEndpoint与@Endpoint端点写法引起的坑</li>
<li>等等<del>~</del><del>~</del>~~~</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;: 本文介绍了什么是Moss以及Moss的功能包括服务画像，服务实例画像，服务上下线事件记录，服务上下线websocket消息通知，针对生产应用可配置多种服务上线通知工具，支持多种注册中心，比如Eureka，Consul，Nacos.支持动态连接注册中心进去切换进行服务治理操作。&lt;/p&gt;
    
    </summary>
    
      <category term="Moss" scheme="http://xujin.org/categories/Moss/"/>
    
    
      <category term="Moss" scheme="http://xujin.org/tags/Moss/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud第二代</title>
    <link href="http://xujin.org/sc/sc2/"/>
    <id>http://xujin.org/sc/sc2/</id>
    <published>2018-11-27T06:00:00.000Z</published>
    <updated>2018-12-09T14:01:00.003Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>: 随着Eureka不再维护，Hystrix不再开发新功能，进入维护状态。以及最近中国开源出现一些大事，预测一下2019年未来Spring Cloud生态圈中的第二代组件的组合，仅<code>代表个人看法</code>。</p>
<h2 id="1-Spring-Cloud第一代"><a href="#1-Spring-Cloud第一代" class="headerlink" title="1. Spring Cloud第一代"></a>1. Spring Cloud第一代</h2><p>  Spring Cloud自从推出之后，给大家的感觉就是Spring Cloud做<code>它最擅长的事，也就是高度抽象和封装，强强联手整合最优东西为我所用</code>，比如Netflix开源的Eureka，Hystrix，Ribbon等。而且提供<code>多种技术选型，态度中立而选最优</code>。8天前也就是2018年11月19号左右，Netflix的开源项目Hystrix宣布状态，不再开发新功能，处于维护状态。引发朋友圈的一些思考。</p>
<a id="more"></a>
<p><img src="/images/sc/hystrix.jpg" alt=""></p>
<blockquote>
<p>虽然Eureka，Hystrix等不再继续开发或维护，但是目前来说不影响使用，不管怎么说感谢开源，向Netflix公司的开源致敬。</p>
</blockquote>
<p>  随着Spring Cloud生态圈的发展与成长，Spring Cloud陆续推出了自己的一些组件，挑选主要组件说明如下表所示:</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>来源</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Spring-cloud-openfeign</td>
<td>基于Feign的升级</td>
<td>服务之间调用的必备组件</td>
</tr>
<tr>
<td>spring-cloud-zuul</td>
<td>来源于Netflix Zuul</td>
<td>目前还在继续维护，但是已经有自己的Spring Cloud Gateway,不久将来逐渐淘汰</td>
</tr>
<tr>
<td>spring-cloud-eureka</td>
<td>集成于Netflix Eureka</td>
<td>目前还在跟随Spring Cloud版本升级维护，最终也会被替代</td>
</tr>
<tr>
<td>spring-cloud-config</td>
<td>自研</td>
<td>功能不足，国内使用其它配置中心替代，比如携程的Apollo</td>
</tr>
<tr>
<td>全链路监控(sleuth+zikpin或pinpont)</td>
<td>sleuth自研，其它第三方</td>
<td>国内目前使用最多的是skywaling等上生产</td>
</tr>
<tr>
<td>spring-cloud-ribbon</td>
<td>来源于Netflix集成</td>
<td>ribbon目前还在跟随Spring Cloud版本维护中，目前孵化未来替代品spring-cloud-lb</td>
</tr>
<tr>
<td>Spring-cloud-hystrix</td>
<td>来源于Netflix集成</td>
<td>目前还在跟随Spring Cloud版本维护中目前已经孵化spring-cloud-r4j</td>
</tr>
</tbody>
</table>
<h2 id="2-Spring-Cloud-第二代"><a href="#2-Spring-Cloud-第二代" class="headerlink" title="2. Spring Cloud 第二代"></a>2. Spring Cloud 第二代</h2><p> Spring Cloud第一代和第二代的组件组合汇总，如下表所示。</p>
<table>
<thead>
<tr>
<th></th>
<th>Spring Cloud第一代</th>
<th>Spring Cloud第二代</th>
</tr>
</thead>
<tbody>
<tr>
<td>网关</td>
<td>Spring Cloud Zuul</td>
<td>Spring Cloud Gateway</td>
</tr>
<tr>
<td>注册中心</td>
<td>eureka(不再更新)，Consul,ZK</td>
<td>阿里Nacos，拍拍贷radar等可选</td>
</tr>
<tr>
<td>配置中心</td>
<td>spring cloud config</td>
<td>阿里Nacos，携程Apollo，随行付Config Keeper</td>
</tr>
<tr>
<td>客户端软负载均衡</td>
<td>Ribbon</td>
<td>spring-cloud-loadbalancer</td>
</tr>
<tr>
<td>熔断器</td>
<td>Hystrix</td>
<td>spring-cloud-r4j(Resilience4J)，阿里Sentinel</td>
</tr>
</tbody>
</table>
<blockquote>
<p>由于Zuul性能一般，zuul 2.x(一直跳票，虽最终开源）但是Spring Cloud官方已经推出Spring Cloud gateway,Spring Cloud中国社区很久之前已经证实，Spring Cloud将不会集成zuul 2.x，也就是说在不就未来Zuul将从Spring Cloud生态圈中退出。</p>
</blockquote>
<hr>
<blockquote>
<p>ribbon由于不支持webFlux的负载均衡，Spring Cloud官方很早就在孵化器项目中孵化spring-cloud-loadbalancer，目前已经将代码合并到spring-cloud-common中，预计在Spring Cloud G版可以使用，预计2018年12月底realese。</p>
</blockquote>
<hr>
<blockquote>
<p>至于Hystrix，Netflix在2018年11月19号左右，Netflix的开源项目Hystrix宣布状态，不再开发新功能，处于维护状态，其实在之前Spring Cloud官方就在孵化spring-cloud-r4j.</p>
</blockquote>
<h2 id="3-开源项目的链接"><a href="#3-开源项目的链接" class="headerlink" title="3.开源项目的链接"></a>3.开源项目的链接</h2><p>本文所提到的开源项目链接汇总如下所示：</p>
<p><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="external">https://github.com/alibaba/Sentinel</a></p>
<p><a href="https://github.com/spring-cloud-incubator/spring-cloud-r4j" target="_blank" rel="external">https://github.com/spring-cloud-incubator/spring-cloud-r4j</a></p>
<p><a href="https://github.com/alibaba/nacos" target="_blank" rel="external">阿里Nacos-https://github.com/alibaba/nacos</a></p>
<p><a href="https://github.com/sxfad/config-keeper" target="_blank" rel="external">随行付Config-keeper-https://github.com/sxfad/config-keeper</a></p>
<p><a href="https://github.com/spring-cloud-incubator/spring-cloud-loadbalancer" target="_blank" rel="external">spring-cloud-loadbalancer</a></p>
<p><a href="https://github.com/ctripcorp/apollo" target="_blank" rel="external">https://github.com/ctripcorp/apollo</a></p>
<p><a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="external">https://github.com/apache/incubator-skywalking</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;: 随着Eureka不再维护，Hystrix不再开发新功能，进入维护状态。以及最近中国开源出现一些大事，预测一下2019年未来Spring Cloud生态圈中的第二代组件的组合，仅&lt;code&gt;代表个人看法&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&quot;1-Spring-Cloud第一代&quot;&gt;&lt;a href=&quot;#1-Spring-Cloud第一代&quot; class=&quot;headerlink&quot; title=&quot;1. Spring Cloud第一代&quot;&gt;&lt;/a&gt;1. Spring Cloud第一代&lt;/h2&gt;&lt;p&gt;  Spring Cloud自从推出之后，给大家的感觉就是Spring Cloud做&lt;code&gt;它最擅长的事，也就是高度抽象和封装，强强联手整合最优东西为我所用&lt;/code&gt;，比如Netflix开源的Eureka，Hystrix，Ribbon等。而且提供&lt;code&gt;多种技术选型，态度中立而选最优&lt;/code&gt;。8天前也就是2018年11月19号左右，Netflix的开源项目Hystrix宣布状态，不再开发新功能，处于维护状态。引发朋友圈的一些思考。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud" scheme="http://xujin.org/categories/Spring-Cloud/"/>
    
    
      <category term="Spring Cloud" scheme="http://xujin.org/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>使用Nacos实现Spring Cloud Gateway的动态路由</title>
    <link href="http://xujin.org/sc/gw/gw10/"/>
    <id>http://xujin.org/sc/gw/gw10/</id>
    <published>2018-11-17T06:00:00.000Z</published>
    <updated>2018-12-05T12:39:51.408Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要介绍通过Nacos下发路由配置实现Spring Cloud Gateway的动态路由。</p>
<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>   网关中有两个重要的概念，那就是路由配置和路由规则，路由配置是指配置某请求路径路由到指定的目的地址。而路由规则是指匹配到路由配置之后，再根据路由规则进行转发处理。<br>   Spring Cloud Gateway作为所有请求流量的入口，在实际生产环境中为了保证高可靠和高可用，尽量避免重启,需要实现Spring Cloud Gateway动态路由配置。前面章节介绍了Spring Cloud Gateway提供的两种方法去配置路由规则，但都是在Spring Cloud Gateway启动时候，就将路由配置和规则加载到内存里，无法做到不重启网关就可以动态的对应路由的配置和规则进行增加，修改和删除。本文是基于<a href="http://xujin.org/sc/gw/gw09/">Spring Cloud Gateway的动态路由实现</a><br>基础之上编写，通过Nacos配置服务下发路由配置实现动态路由。</p>
<a id="more"></a>
<h2 id="2-Spring-Cloud-Gateway简单的动态路由实现"><a href="#2-Spring-Cloud-Gateway简单的动态路由实现" class="headerlink" title="2. Spring Cloud Gateway简单的动态路由实现"></a>2. Spring Cloud Gateway简单的动态路由实现</h2><p>Spring Cloud Gateway的官方文档并没有讲如何动态配置，查看 Spring Cloud Gateway的源码，发现<code>在org.springframework.cloud.gateway.actuate.GatewayControllerEndpoint</code>类中提供了动态配置的Rest接口，但是<code>需要开启Gateway的端点</code>，而且提供的功能不是很强大。通过参考和GatewayControllerEndpoint相关的代码，可以自己编码实际动态路由配置。<br>下面通过案例的方式去讲解怎么通Nacos实现Spring Cloud Gateway的动态路由。案例工程如spring-cloud-gateway-nacos所示。</p>
<blockquote>
<p>代码地址:<a href="https://github.com/SpringCloud/spring-cloud-gateway-nacos" target="_blank" rel="external">https://github.com/SpringCloud/spring-cloud-gateway-nacos</a></p>
</blockquote>
<h2 id="3-简单动态路由的实现"><a href="#3-简单动态路由的实现" class="headerlink" title="3. 简单动态路由的实现"></a>3. 简单动态路由的实现</h2><h3 id="3-1-新建Maven工程sc-gateway-server"><a href="#3-1-新建Maven工程sc-gateway-server" class="headerlink" title="3.1 新建Maven工程sc-gateway-server"></a>3.1 新建Maven工程sc-gateway-server</h3><p>  配置主要的核心依赖如代码清单所示：<br>  代码清单: spring-cloud-gateway-nacos/sc-gateway-server/pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.nacos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="3-2-根据Spring-Cloud-Gateway的路由模型定义数据传输模型"><a href="#3-2-根据Spring-Cloud-Gateway的路由模型定义数据传输模型" class="headerlink" title="3.2 根据Spring Cloud Gateway的路由模型定义数据传输模型"></a>3.2 根据Spring Cloud Gateway的路由模型定义数据传输模型</h3><p> 分别创建GatewayRouteDefinition.java, GatewayPredicateDefinition.java, GatewayFilterDefinition.java这三个类。<br>(1) 创建路由定义模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayRouteDefinition</span> </span>&#123;</div><div class="line">    <span class="comment">//路由的Id</span></div><div class="line">    <span class="keyword">private</span> String id;</div><div class="line">    <span class="comment">//路由断言集合配置</span></div><div class="line">    <span class="keyword">private</span> List&lt;GatewayPredicateDefinition&gt; predicates = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="comment">//路由过滤器集合配置</span></div><div class="line">    <span class="keyword">private</span> List&lt;GatewayFilterDefinition&gt; filters = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="comment">//路由规则转发的目标uri</span></div><div class="line">    <span class="keyword">private</span> String uri;</div><div class="line">    <span class="comment">//路由执行的顺序</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">0</span>;</div><div class="line">    <span class="comment">//此处省略get和set方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(2)创建过滤器定义模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterDefinition</span> </span>&#123;</div><div class="line">    <span class="comment">//Filter Name</span></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="comment">//对应的路由规则</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    <span class="comment">//此处省略Get和Set方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(3)创建路由断言定义模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayPredicateDefinition</span> </span>&#123;</div><div class="line">    <span class="comment">//断言对应的Name</span></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="comment">//配置的断言规则</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    <span class="comment">//此处省略Get和Set方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-3-编写动态路由实现类"><a href="#3-3-编写动态路由实现类" class="headerlink" title="3.3 编写动态路由实现类"></a>3.3 编写动态路由实现类</h3><p>编写DynamicRouteServiceImpl并实现ApplicationEventPublisherAware接口，代码如下所示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImpl</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</div><div class="line">    <span class="keyword">private</span> ApplicationEventPublisher publisher;</div><div class="line">    <span class="comment">//增加路由</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</div><div class="line">        routeDefinitionWriter.save(Mono.just(definition)).subscribe();</div><div class="line">        <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</div><div class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//更新路由</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(definition.getId()));</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"update fail,not find route  routeId: "</span>+definition.getId();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            routeDefinitionWriter.save(Mono.just(definition)).subscribe();</div><div class="line">            <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</div><div class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"update route  fail"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//删除路由</span></div><div class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(String id) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(id))</div><div class="line">                .then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build())))</div><div class="line">                .onErrorResume(t -&gt; t <span class="keyword">instanceof</span> NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build()));</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.publisher = applicationEventPublisher;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-4-编写Nacos监听接收下发的路由配置"><a href="#3-4-编写Nacos监听接收下发的路由配置" class="headerlink" title="3.4 编写Nacos监听接收下发的路由配置"></a>3.4 编写Nacos监听接收下发的路由配置</h3><h3 id="3-4-1-使用Nacos监听下发的配置"><a href="#3-4-1-使用Nacos监听下发的配置" class="headerlink" title="3.4.1 使用Nacos监听下发的配置"></a>3.4.1 使用Nacos监听下发的配置</h3><p>监听Nacos Config Server下发配置的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImplByNacos</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> DynamicRouteServiceImpl dynamicRouteService;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicRouteServiceImplByNacos</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        dynamicRouteByNacosListener(<span class="string">"sc-gateway"</span>,<span class="string">"xujin_test"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 监听Nacos Server下发的动态路由配置</div><div class="line">     * <span class="doctag">@param</span> dataId</div><div class="line">     * <span class="doctag">@param</span> group</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dynamicRouteByNacosListener</span> <span class="params">(String dataId, String group)</span></span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ConfigService configService=NacosFactory.createConfigService(<span class="string">"127.0.0.1:8848"</span>);</div><div class="line">            String content = configService.getConfig(dataId, group, <span class="number">5000</span>);</div><div class="line">            System.out.println(content);</div><div class="line">            configService.addListener(dataId, group, <span class="keyword">new</span> Listener()  &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConfigInfo</span><span class="params">(String configInfo)</span> </span>&#123;</div><div class="line">                    RouteDefinition definition= JSON.parseObject(configInfo,RouteDefinition.class);</div><div class="line">                    dynamicRouteService.update(definition);</div><div class="line">                &#125;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (NacosException e) &#123;</div><div class="line">            <span class="comment">//todo 提醒:异常自行处理此处省略</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-4-2-两种方式创建ConfigService"><a href="#3-4-2-两种方式创建ConfigService" class="headerlink" title="3.4.2 两种方式创建ConfigService"></a>3.4.2 两种方式创建ConfigService</h4><p>使用两种方式创建com.alibaba.nacos.api.config.ConfigService</p>
<ul>
<li>1.构建Properties创建</li>
</ul>
<p>使用createConfigService(Properties properties)，代码如下所示:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">            properties.put(<span class="string">"nacos.server-addr"</span>, <span class="string">""</span>);</div><div class="line">            properties.put(PropertyKeyConst.SERVER_ADDR, <span class="string">"127.0.0.1:8848"</span>);</div><div class="line">            ConfigService configService=NacosFactory.createConfigService(properties);</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意:PropertyKeyConst是com.alibaba.nacos.api.PropertyKeyConst</p>
</blockquote>
<ul>
<li>2.只传递Nacos Config Server的地址</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ConfigService configService=NacosFactory.createConfigService(<span class="string">"127.0.0.1:8848"</span>);</div></pre></td></tr></table></figure>
<h2 id="4-使用Nacos下发配置"><a href="#4-使用Nacos下发配置" class="headerlink" title="4. 使用Nacos下发配置"></a>4. 使用Nacos下发配置</h2><h3 id="4-1-Nacos概述"><a href="#4-1-Nacos概述" class="headerlink" title="4.1 Nacos概述"></a>4.1 Nacos概述</h3><p>   Naocs由阿里开源，Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。<br>   Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。github地址:<a href="https://github.com/alibaba/nacos" target="_blank" rel="external">https://github.com/alibaba/nacos</a></p>
<blockquote>
<p>更多Nacos的介绍，请访问官方网站:<a href="https://nacos.io/" target="_blank" rel="external">https://nacos.io/</a></p>
</blockquote>
<h3 id="4-2-在IDE中启动-Nacos"><a href="#4-2-在IDE中启动-Nacos" class="headerlink" title="4.2 在IDE中启动 Nacos"></a>4.2 在IDE中启动 Nacos</h3><p>访问<a href="https://github.com/alibaba/nacos" target="_blank" rel="external">https://github.com/alibaba/nacos</a> ,使用Git克隆Nacos代码，直接导入到IDEA中，如下所示设置启动参数，直接启动。</p>
<p><img src="/images/mw/nacos/nacos0.jpg" alt=""></p>
<blockquote>
<p>从IDE中启动Nacos是我比较推荐的方式，因为可以随时Debug Nacos任何代码，其它启动方式请参考官网。</p>
</blockquote>
<h2 id="5-测试"><a href="#5-测试" class="headerlink" title="5.测试"></a>5.测试</h2><h3 id="5-1-Nacos中下发Spring-Cloud-Gateway的路由配置"><a href="#5-1-Nacos中下发Spring-Cloud-Gateway的路由配置" class="headerlink" title="5.1  Nacos中下发Spring Cloud Gateway的路由配置"></a>5.1  Nacos中下发Spring Cloud Gateway的路由配置</h3><ul>
<li>1.打开浏览器访问URL:<a href="http://localhost:8848/nacos/index.html" target="_blank" rel="external">http://localhost:8848/nacos/index.html</a> ,Nacos的管控平台如下所示:</li>
</ul>
<p><img src="/images/mw/nacos/nacos1.jpg" alt=""></p>
<ul>
<li>2.在Nacos的配置列表点击<code>+</code>按钮，下发Spring Cloud Gateway的路由配置，如下所示:</li>
</ul>
<p><img src="/images/mw/nacos/nacos2.jpg" alt=""></p>
<hr>
<p>用于测试的示例数据，如下所示:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	<span class="attr">"filters"</span>: [],</div><div class="line">	<span class="attr">"id"</span>: <span class="string">"jd_route"</span>,</div><div class="line">	<span class="attr">"order"</span>: <span class="number">0</span>,</div><div class="line">	<span class="attr">"predicates"</span>: [&#123;</div><div class="line">		<span class="attr">"args"</span>: &#123;</div><div class="line">			<span class="attr">"pattern"</span>: <span class="string">"/jd"</span></div><div class="line">		&#125;,</div><div class="line">		<span class="attr">"name"</span>: <span class="string">"Path"</span></div><div class="line">	&#125;],</div><div class="line">	<span class="attr">"uri"</span>: <span class="string">"http://www.jd.com"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/images/mw/nacos/nacos3.jpg" alt=""><br><img src="/images/mw/nacos/nacos4.jpg" alt=""></p>
<h3 id="5-2-启动sc-gateway-server"><a href="#5-2-启动sc-gateway-server" class="headerlink" title="5.2 启动sc-gateway-server"></a>5.2 启动sc-gateway-server</h3><ul>
<li>1.Debug启动sc-gateway-server,调试截图如下所示:</li>
</ul>
<p><img src="/images/mw/nacos/nacos5.jpg" alt=""></p>
<ul>
<li>2.通过Spring Cloud gateway的端点，查看路由信息</li>
</ul>
<p><img src="/images/mw/nacos/nacos6.jpg" alt=""></p>
<ul>
<li>3.通过访问<a href="http://localhost:8080/jd" target="_blank" rel="external">http://localhost:8080/jd</a> ,可以转发到京东商城主页</li>
</ul>
<h3 id="5-3-更新路由配置"><a href="#5-3-更新路由配置" class="headerlink" title="5.3 更新路由配置"></a>5.3 更新路由配置</h3><ul>
<li>1.通过Nacos下发配置，修改Spring Cloud Gateway的动态路由规则</li>
</ul>
<p><img src="/images/mw/nacos/nacos7.jpg" alt=""></p>
<ul>
<li>2.查看访问Spring Cloud gateway的端点配置，可以看到动态路由修改如下:</li>
</ul>
<p><img src="/images/mw/nacos/nacos8.jpg" alt=""></p>
<ul>
<li>3.通过访问<a href="http://localhost:8080/jd" target="_blank" rel="external">http://localhost:8080/jd</a> ,可以转发到百度相关页面</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本文主要介绍通过Nacos下发路由配置实现Spring Cloud Gateway的动态路由。&lt;/p&gt;
&lt;h2 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h2&gt;&lt;p&gt;   网关中有两个重要的概念，那就是路由配置和路由规则，路由配置是指配置某请求路径路由到指定的目的地址。而路由规则是指匹配到路由配置之后，再根据路由规则进行转发处理。&lt;br&gt;   Spring Cloud Gateway作为所有请求流量的入口，在实际生产环境中为了保证高可靠和高可用，尽量避免重启,需要实现Spring Cloud Gateway动态路由配置。前面章节介绍了Spring Cloud Gateway提供的两种方法去配置路由规则，但都是在Spring Cloud Gateway启动时候，就将路由配置和规则加载到内存里，无法做到不重启网关就可以动态的对应路由的配置和规则进行增加，修改和删除。本文是基于&lt;a href=&quot;http://xujin.org/sc/gw/gw09/&quot;&gt;Spring Cloud Gateway的动态路由实现&lt;/a&gt;&lt;br&gt;基础之上编写，通过Nacos配置服务下发路由配置实现动态路由。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway的动态路由实现</title>
    <link href="http://xujin.org/sc/gw/gw09/"/>
    <id>http://xujin.org/sc/gw/gw09/</id>
    <published>2018-11-03T06:00:00.000Z</published>
    <updated>2018-11-08T11:06:52.407Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要介绍了Spring Cloud Gateway的动态路由的简单实现方式。</p>
<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>   网关中有两个重要的概念，那就是路由配置和路由规则，路由配置是指配置某请求路径路由到指定的目的地址。而路由规则是指匹配到路由配置之后，再根据路由规则进行转发处理。<br>   Spring Cloud Gateway作为所有请求流量的入口，在实际生产环境中为了保证高可靠和高可用，尽量避免重启,需要实现Spring Cloud Gateway动态路由配置。前面章节介绍了Spring Cloud Gateway提供的两种方法去配置路由规则，但都是在Spring Cloud Gateway启动时候，就将路由配置和规则加载到内存里，无法做到不重启网关就可以动态的对应路由的配置和规则进行增加，修改和删除。<code>本篇文章简单介绍如何实现Spring Cloud Gateway的动态路由。</code><br><a id="more"></a></p>
<h2 id="2-Spring-Cloud-Gateway简单的动态路由实现"><a href="#2-Spring-Cloud-Gateway简单的动态路由实现" class="headerlink" title="2. Spring Cloud Gateway简单的动态路由实现"></a>2. Spring Cloud Gateway简单的动态路由实现</h2><p>Spring Cloud Gateway的官方文档并没有讲如何动态配置，查看 Spring Cloud Gateway的源码，发现<code>在org.springframework.cloud.gateway.actuate.GatewayControllerEndpoint</code>类中提供了动态配置的Rest接口，但是<code>需要开启Gateway的端点</code>，而且提供的功能不是很强大。通过参考和GatewayControllerEndpoint相关的代码，可以自己编码实际动态路由配置。<br>下面通过案例的方式去讲解怎么实现Gateway的动态路由配置。案例工程如ch18-7-gateway所示。</p>
<blockquote>
<p>代码地址:<a href="https://github.com/SpringCloud/spring-cloud-code/blob/master/ch18-7/ch18-7-gateway" target="_blank" rel="external">https://github.com/SpringCloud/spring-cloud-code/blob/master/ch18-7/ch18-7-gateway</a></p>
</blockquote>
<h2 id="3-简单动态路由的实现"><a href="#3-简单动态路由的实现" class="headerlink" title="3. 简单动态路由的实现"></a>3. 简单动态路由的实现</h2><h3 id="3-1-新建Maven工程ch18-7-gateway"><a href="#3-1-新建Maven工程ch18-7-gateway" class="headerlink" title="3.1 新建Maven工程ch18-7-gateway"></a>3.1 新建Maven工程ch18-7-gateway</h3><p>  配置主要的核心依赖如代码清单18-33所示：<br>  代码清单: ch18-7/ch18-7-gateway/pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="3-2-根据Spring-Cloud-Gateway的路由模型定义数据传输模型"><a href="#3-2-根据Spring-Cloud-Gateway的路由模型定义数据传输模型" class="headerlink" title="3.2 根据Spring Cloud Gateway的路由模型定义数据传输模型"></a>3.2 根据Spring Cloud Gateway的路由模型定义数据传输模型</h3><p> 分别创建GatewayRouteDefinition.java, GatewayPredicateDefinition.java, GatewayFilterDefinition.java这三个类。<br>(1) <code>创建路由定义模型</code>如下代码清单18-34所示：<br>代码清单 18-34: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayRouteDefinition.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayRouteDefinition</span> </span>&#123;</div><div class="line">    <span class="comment">//路由的Id</span></div><div class="line">    <span class="keyword">private</span> String id;</div><div class="line">    <span class="comment">//路由断言集合配置</span></div><div class="line">    <span class="keyword">private</span> List&lt;GatewayPredicateDefinition&gt; predicates = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="comment">//路由过滤器集合配置</span></div><div class="line">    <span class="keyword">private</span> List&lt;GatewayFilterDefinition&gt; filters = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="comment">//路由规则转发的目标uri</span></div><div class="line">    <span class="keyword">private</span> String uri;</div><div class="line">    <span class="comment">//路由执行的顺序</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">0</span>;</div><div class="line">    <span class="comment">//此处省略get和set方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(2)<code>创建过滤器定义模型</code>,代码如代码清单18-35所示：<br>代码清单18-35: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayFilterDefinition.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterDefinition</span> </span>&#123;</div><div class="line">    <span class="comment">//Filter Name</span></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="comment">//对应的路由规则</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    <span class="comment">//此处省略Get和Set方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(3)<code>路由断言定义模型</code>，代码如代码清单18-36所示:<br>代码清单18-36: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayPredicateDefinition.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayPredicateDefinition</span> </span>&#123;</div><div class="line">    <span class="comment">//断言对应的Name</span></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="comment">//配置的断言规则</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    <span class="comment">//此处省略Get和Set方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-3-编写动态路由实现类"><a href="#3-3-编写动态路由实现类" class="headerlink" title="3.3 编写动态路由实现类"></a>3.3 编写动态路由实现类</h3><p>编写DynamicRouteServiceImpl并实现ApplicationEventPublisherAware接口，代码如代码清单18-37所示: ch18-37/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/route/DynamicRouteServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImpl</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</div><div class="line">    <span class="keyword">private</span> ApplicationEventPublisher publisher;</div><div class="line">    <span class="comment">//增加路由</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</div><div class="line">        routeDefinitionWriter.save(Mono.just(definition)).subscribe();</div><div class="line">        <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</div><div class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//更新路由</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(definition.getId()));</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"update fail,not find route  routeId: "</span>+definition.getId();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            routeDefinitionWriter.save(Mono.just(definition)).subscribe();</div><div class="line">            <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</div><div class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"update route  fail"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//删除路由</span></div><div class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(String id) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(id))</div><div class="line">                .then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build())))</div><div class="line">                .onErrorResume(t -&gt; t <span class="keyword">instanceof</span> NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build()));</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.publisher = applicationEventPublisher;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-4-编写Rest接口"><a href="#3-4-编写Rest接口" class="headerlink" title="3.4 编写Rest接口"></a>3.4 编写Rest接口</h3><p>编写RouteController类的提供Rest接口，用于动态路由配置。代码如代码清单18-38所示:<br>代码清单 18-38: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/controller/RouteController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/route"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteController</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> DynamicRouteServiceImpl dynamicRouteService;</div><div class="line">    <span class="comment">//增加路由</span></div><div class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/add"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(@RequestBody GatewayRouteDefinition gwdefinition)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            RouteDefinition definition = assembleRouteDefinition(gwdefinition);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.add(definition);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">"succss"</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//删除路由</span></div><div class="line">    <span class="meta">@DeleteMapping</span>(<span class="string">"/routes/&#123;id&#125;"</span>)</div><div class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(<span class="meta">@PathVariable</span> String id) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.delete(id);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//更新路由</span></div><div class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/update"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(@RequestBody GatewayRouteDefinition gwdefinition)</span> </span>&#123;</div><div class="line">        RouteDefinition definition = assembleRouteDefinition(gwdefinition);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.update(definition);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-5-配置application-yml文件"><a href="#3-5-配置application-yml文件" class="headerlink" title="3.5 配置application.yml文件"></a>3.5 配置application.yml文件</h3><p>在application.yml文件配置应用的配置信息，并开启Spring Cloud Gateway对外提供的端点Rest接口。代码如代码清单18-39所示:<br>代码清单 18-39: ch18-7/ch18-7-gateway/src/main/resources/application.yml<br>配置输出日志如下所示:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 配置输出日志</span></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    org.springframework.cloud.gateway: TRACE</div><div class="line">    org.springframework.http.server.reactive: DEBUG</div><div class="line">    org.springframework.web.reactive: DEBUG</div><div class="line">    reactor.ipc.netty: DEBUG</div><div class="line"><span class="comment">#开启端点</span></div><div class="line"><span class="attr">management:</span></div><div class="line"><span class="attr">  endpoints:</span></div><div class="line"><span class="attr">    web:</span></div><div class="line"><span class="attr">      exposure:</span></div><div class="line"><span class="attr">        include:</span> <span class="string">'*'</span></div><div class="line"><span class="attr">  security:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div></pre></td></tr></table></figure></p>
<h3 id="3-6-启动ch18-7-gateway应用测试"><a href="#3-6-启动ch18-7-gateway应用测试" class="headerlink" title="3.6 启动ch18-7-gateway应用测试"></a>3.6 启动ch18-7-gateway应用测试</h3><p>(1) 启动ch18-7-gateway应用之后，由于开启了端点，首先打开浏览器访问端点URL:<br><a href="http://localhost:8080/actuator/gateway/routes" target="_blank" rel="external">http://localhost:8080/actuator/gateway/routes</a>  ,查看路由信息返回为空，如下图所示:</p>
<p><img src="/images/sc-g-route/1.png" alt="空的路由信息"></p>
<p>(2)打开PostMan，访问<a href="http://localhost:8080/route/add" target="_blank" rel="external">http://localhost:8080/route/add</a>, 发起Post请求，如下图所示,返回success说明向Gateway增加路由配置成功。<br><img src="/images/sc-g-route/2.png" alt="动态添加路由成功"></p>
<p> 然后再打开PostMan访问端点URL:<a href="http://localhost:8080/actuator/gateway/routes" target="_blank" rel="external">http://localhost:8080/actuator/gateway/routes</a> ,<br> 查看路由信息返回如下图所示，可以看到已经添加的路由配置。<br><img src="/images/sc-g-route/3.png" alt="路由端点返回结果"></p>
<p>(3) 打开浏览器访问<a href="http://localhost:8080/jd" target="_blank" rel="external">http://localhost:8080/jd</a>, 可以正常转发<a href="https://www.jd.com/对应的京东商城首页。" target="_blank" rel="external">https://www.jd.com/对应的京东商城首页。</a><br>(4) 通过访问<a href="http://localhost:8080/route/update" target="_blank" rel="external">http://localhost:8080/route/update</a>, 对id为jd_route的路由更新配置，如下图所示：<br><img src="/images/sc-g-route/4.png" alt="更新路由配置"></p>
<p> 然后再访问路由端点URL,发现路由配置已经被更新，如下图所示:<br><img src="/images/sc-g-route/5.png" alt="查看路由端点"></p>
<p>然后通过浏览器访问<a href="http://localhost:8080/taobao" target="_blank" rel="external">http://localhost:8080/taobao</a> ,可以成功转发到淘宝网。<br>(5) 通过访问http: //localhost:8080/route/delete/jd_route,其中的id为路由对应的id，删除路由结果如下图所示:<br><img src="/images/sc-g-route/6.png" alt="删除路由成功"></p>
<h2 id="4-Spring-Cloud-Gateway推荐文章"><a href="#4-Spring-Cloud-Gateway推荐文章" class="headerlink" title="4.Spring Cloud Gateway推荐文章"></a>4.Spring Cloud Gateway推荐文章</h2><p><a href="http://xujin.org/sc/gw/gw08/">Spring Cloud Gateway中的权重路由</a><br><a href="http://xujin.org/sc/gw/gw07/">Spring Cloud Gateway中的GatewayFilter和GlobalFilter</a><br><a href="http://xujin.org/sc/gw/gw06/">Spring Cloud Gateway只有Pre和POST两种类型的Filter</a><br><a href="http://xujin.org/sc/gw/gw05/">Spring Cloud Gateway基于服务发现的默认路由规则</a><br><a href="http://xujin.org/sc/gw/gw04/">Spring Cloud Gateway的Before路由断言工厂</a><br><a href="http://xujin.org/sc/gw/gw03/">Spring Cloud Gateway的After路由断言工厂</a><br><a href="http://xujin.org/sc/gw/gw02/">Spring Cloud Gateway揭秘之处理请求流程</a><br><a href="http://xujin.org/sc/gw/gw-01/">Spring Cloud Gateway入门案例</a></p>
<h2 id="5-《重新定义Spring-Cloud实战》中的Spring-Cloud-Gateway"><a href="#5-《重新定义Spring-Cloud实战》中的Spring-Cloud-Gateway" class="headerlink" title="5.《重新定义Spring Cloud实战》中的Spring Cloud Gateway"></a>5.《重新定义Spring Cloud实战》中的Spring Cloud Gateway</h2><p>第17章Spring Cloud Gateway上篇399<br>17.1 Spring Cloud Gateway概述399<br>17.1.1 什么是Spring Cloud Gateway399<br>17.1.2 Spring Cloud Gateway的核心概念399<br>17.2 Spring Cloud Gateway的工作原理400<br>17.3 Spring Cloud Gateway入门案例401<br>17.4 Spring Cloud Gateway的路由断言404<br>17.4.1 After路由断言工厂404<br>17.4.2 Before路由断言工厂406<br>17.4.3 Between路由断言工厂406<br>17.4.4 Cookie路由断言工厂407<br>17.4.5 Header路由断言工厂408<br>17.4.6 Host路由断言工厂410<br>17.4.7 Method路由断言工厂411<br>17.4.8 Query路由断言工厂411<br>17.4.9 RemoteAddr路由断言工厂412<br>17.5 Spring Cloud Gateway的内置Filter413<br>17.5.1 AddRequestHeader过滤器工厂413<br>17.5.2 AddRequestParameter过滤器413<br>17.5.3 RewritePath过滤器414<br>17.5.4 AddResponseHeader过滤器415<br>17.5.5 StripPrefix过滤器416<br>17.5.6 Retry过滤器417<br>17.5.7 Hystrix过滤器418<br>17.6 本章小结420<br>第18章 Spring Cloud Gateway下篇421<br>18.1 Gateway基于服务发现的路由规则421<br>18.1.1 Gateway的服务发现路由概述421<br>18.1.2 服务发现的路由规则案例422<br>18.2 Gateway Filter和Global Filter425<br>18.2.1 Gateway Filter和Global Filter概述425<br>18.2.2 自定义Gateway Filter案例425<br>18.2.3 自定义Global Filter案例427<br>18.3 Spring Cloud Gateway实战428<br>18.3.1 Spring Cloud Gateway权重路由428<br>18.3.2 Spring Cloud Gateway中Https的使用技巧431<br>18.3.3 Spring Cloud Gateway集成Swagger436<br>18.3.4 Spring Cloud Gateway限流442<br>18.3.5 Spring Cloud Gateway的动态路由450<br>18.4 Spring Cloud Gateway源码篇458<br>18.4.1 Spring Cloud Gateway的处理流程458<br>18.4.2 Gateway中ServerWebExchange构建分析459<br>18.4.3 DispatcherHandler源码分析460<br>18.4.4 RoutePredicateHandlerMapping源码分析461<br>18.4.5 FilteringWebHandler源码分析462<br>18.4.6 执行Filter源码分析463<br>18.5 本章小结465</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">├── ch17-1</div><div class="line">│   ├── ch17-1-1-gateway</div><div class="line">│   ├── ch17-1-2-gateway</div><div class="line">│   ├── ch17-1.iml</div><div class="line">│   └── pom.xml</div><div class="line">├── ch17-2</div><div class="line">│   ├── ch17-2-1-gateway</div><div class="line">│   ├── ch17-2-2-gateway</div><div class="line">│   ├── ch17-2-3-gateway</div><div class="line">│   ├── ch17-2-4-gateway</div><div class="line">│   ├── ch17-2-5-gateway</div><div class="line">│   ├── ch17-2-6-gateway</div><div class="line">│   ├── ch17-2-7-gateway</div><div class="line">│   ├── ch17-2-8-gateway</div><div class="line">│   ├── ch17-2-9-gateway</div><div class="line">│   ├── ch17-2-service</div><div class="line">│   ├── ch17-2.iml</div><div class="line">│   └── pom.xml</div><div class="line">├── ch17-3</div><div class="line">│   ├── ch17-3-1-gateway</div><div class="line">│   ├── ch17-3-2-gateway</div><div class="line">│   ├── ch17-3-3-gateway</div><div class="line">│   ├── ch17-3-4-gateway</div><div class="line">│   ├── ch17-3-5-gateway</div><div class="line">│   ├── ch17-3-6-gateway</div><div class="line">│   ├── ch17-3-7-gateway</div><div class="line">│   ├── ch17-3-service</div><div class="line">│   ├── ch17-3.iml</div><div class="line">│   └── pom.xml</div><div class="line">├── ch18-1</div><div class="line">│   ├── ch18-1-consumer</div><div class="line">│   ├── ch18-1-eureka</div><div class="line">│   ├── ch18-1-gateway</div><div class="line">│   ├── ch18-1-provider</div><div class="line">│   ├── ch18-1.iml</div><div class="line">│   └── pom.xml</div><div class="line">├── ch18-2</div><div class="line">│   ├── ch18-2-gateway</div><div class="line">│   ├── ch18-2-provider</div><div class="line">│   ├── ch18-2.iml</div><div class="line">│   ├── pom.xml</div><div class="line">│   └── reademe.txt</div><div class="line">├── ch18-3</div><div class="line">│   ├── ch18-3-gateway</div><div class="line">│   ├── ch18-3-provider</div><div class="line">│   ├── ch18-3.iml</div><div class="line">│   └── pom.xml</div><div class="line">├── ch18-4</div><div class="line">│   ├── ch18-4-eureka</div><div class="line">│   ├── ch18-4-gateway-https</div><div class="line">│   ├── ch18-4-service-a</div><div class="line">│   ├── ch18-4-service-b</div><div class="line">│   ├── ch18-4.iml</div><div class="line">│   ├── pom.xml</div><div class="line">│   └── reademe.md</div><div class="line">├── ch18-5</div><div class="line">│   ├── ch18-5-eureka</div><div class="line">│   ├── ch18-5-gateway</div><div class="line">│   ├── ch18-5-service</div><div class="line">│   ├── ch18-5.iml</div><div class="line">│   └── pom.xml</div><div class="line">├── ch18-6</div><div class="line">│   ├── ch18-6-1-gateway</div><div class="line">│   ├── ch18-6-2-gateway</div><div class="line">│   ├── ch18-6-3-gateway</div><div class="line">│   ├── ch18-6-provider</div><div class="line">│   ├── ch18-6.iml</div><div class="line">│   └── pom.xml</div><div class="line">├── ch18-7</div><div class="line">│   ├── ch18-7-gateway</div><div class="line">│   ├── ch18-7.iml</div><div class="line">│   ├── pom.xml</div><div class="line">│   └── readme.md</div></pre></td></tr></table></figure>
<blockquote>
<p>Spring Cloud Gateway所有示例代码地址:<a href="https://github.com/SpringCloud/spring-cloud-code" target="_blank" rel="external">https://github.com/SpringCloud/spring-cloud-code</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本文主要介绍了Spring Cloud Gateway的动态路由的简单实现方式。&lt;/p&gt;
&lt;h2 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1.前言&quot;&gt;&lt;/a&gt;1.前言&lt;/h2&gt;&lt;p&gt;   网关中有两个重要的概念，那就是路由配置和路由规则，路由配置是指配置某请求路径路由到指定的目的地址。而路由规则是指匹配到路由配置之后，再根据路由规则进行转发处理。&lt;br&gt;   Spring Cloud Gateway作为所有请求流量的入口，在实际生产环境中为了保证高可靠和高可用，尽量避免重启,需要实现Spring Cloud Gateway动态路由配置。前面章节介绍了Spring Cloud Gateway提供的两种方法去配置路由规则，但都是在Spring Cloud Gateway启动时候，就将路由配置和规则加载到内存里，无法做到不重启网关就可以动态的对应路由的配置和规则进行增加，修改和删除。&lt;code&gt;本篇文章简单介绍如何实现Spring Cloud Gateway的动态路由。&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>《重新定义Spring Cloud实战》</title>
    <link href="http://xujin.org/re/01/"/>
    <id>http://xujin.org/re/01/</id>
    <published>2018-09-24T06:00:00.000Z</published>
    <updated>2018-11-03T04:58:23.716Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要:</strong> 今天是2018年9月24号中秋节，祝福大家中秋节快乐，本文主要介绍《重新定义Spring Cloud实战》。</p>
<a id="more"></a>
<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>   随着互联网的快速普及，云计算近年来得到蓬勃发展，企业的IT环境和架构体系也逐渐发生变革，其中最典型的就是<code>过去的单体应用架构发展为当今流行的微服务架构</code>。微服务是一种架构风格，其优势是为软件应用开发带来很大的便利，让敏捷开发和复杂的企业应用快速持续交付成为可能。随着微服务架构的流行，很多企业纷纷使用微服务架构来搭建新的系统或者对历史系统进行重构，但是微服务架构的实施和落地会面临很大的挑战。<code>虽然微服务架构的解决方案很多，但是对于如何真正落地微服务架构，目前还没有公认的技术标准和规范</code>。幸运的是，业界已经有一些很有影响力的开源微服务解决方案，<code>比如2015年年初，Spring团队推出的Spring Cloud，其目标是成为Java领域微服务架构落地的标准。Spring Cloud经过高速迭代和发展，至今已经成为Java领域落地微服务架构的推荐解决方案，为企业IT架构变革保驾护航</code>。</p>
<p>   Spring Cloud是一个<code>优质的开源项目</code>，<code>它的稳健发展离不开众多开发人员的实践与反馈，开发人员通过一个社区化的平台去交流学习从而使Spring Cloud逐渐完善</code>。Spring Cloud发展到2016年，得到国内越来越多的人的关注，但是相应的学习交流平台和材料比较分散，这阻碍了Spring Cloud在我国的普及和发展。因此Spring Cloud中国社区应运而生。Spring Cloud中国社区 (<a href="http://springcloud.cn" target="_blank" rel="external">http://springcloud.cn</a>) 是国内基于Spring Cloud微服务体系创建的非盈利技术社区，是专为Spring Boot或Spring Cloud技术人员提供分享和交流服务的平台，目的是推动Spring Cloud在中国的普及和应用。</p>
<h2 id="2-背景概述"><a href="#2-背景概述" class="headerlink" title="2.背景概述"></a>2.背景概述</h2><p>   Spring Cloud中国社区(<a href="http://springcloud.cn" target="_blank" rel="external">http://springcloud.cn</a>) 是国内基于Spring Cloud微服务体系创建的非盈利技术社区。自2016年10月份创建以来，在北京，上海，深圳，成都等地举办了多次技术沙龙，提供技术交流平台,帮助数万开发者快速学习Spring Cloud并用于生产。为更好的推动Spring Cloud在中国的发展，让更多的开发者受益。社区针对Spring Cloud在国内的使用情况，结合国内企业使用Spring Cloud落地微服务架构遇到的问题给出实战解决方案，特推出此书。《重新定义Spring Cloud实战》封面如下图所示:</p>
<p><img src="/images/re/fm.png" width="350px" height="450px"></p>
<p>   本书基于<code>Spring Cloud的Finchley.RELEASE版编写</code>，由7位作者著，<code>共25章，共670页</code>，我们7位作者并不是Spring Cloud微服务落地的架构专家，我们只是Spring Cloud微服务架构的实践者，把我们自己的实践经验分享给大家，帮助大家解决学习和工作上遇到的问题。<code>三人行，必有我师焉，由于我们学识有限，难免会有不足之处，还请读者多多包涵，一起交流学习，共同进步</code>。</p>
<p><img src="/images/re/gmqd.png" width="350px" height="450px"></p>
<h2 id="3-本书介绍"><a href="#3-本书介绍" class="headerlink" title="3.本书介绍"></a>3.本书介绍</h2><h3 id="3-1-填坑记录"><a href="#3-1-填坑记录" class="headerlink" title="3.1 填坑记录"></a>3.1 填坑记录</h3><p><img src="/images/re/tkjl.png"></p>
<h3 id="3-2-BATJ部分书评"><a href="#3-2-BATJ部分书评" class="headerlink" title="3.2 BATJ部分书评"></a>3.2 BATJ部分书评</h3><p>过去十几年里，广义的“微服务”架构以其小团队快速创建和迭代服务带来的架构弹性、扩展性、敏捷性，天然匹配了互联网业务快速发展和变化的特点，在各大互联网公司取得了巨大的成功。时至云原生应用时代，已不再是是否采用微服务架构的问题，而是何时采用以及如何在生产上实战的问题。本书将如何基于Spring Cloud生态体系进行微服务实战的方方面面的细节都涵盖了，，从这个意义上来讲，确实做到了“重新定义”。</p>
<p><code>—— 坤宇 Nacos开源项目创始人/阿里巴巴高级技术专家</code></p>
<p>微服务以敏捷为目标，以降低复杂的系统结构为基础，带给我们更好的系统可用性和稳定性。Spring Cloud作为一套完善的微服务治理的典型框架，涵盖了微服务治理的方方面面。本书详细介绍了Spring Cloud的每一个核心模块，以理论与实际相结合的方式，透彻地讲述了Spring Cloud的精髓，是每一位奋战在服务化领域一线的工程师、架构师的*选技术书籍。</p>
<p><code>——李艳鹏 蚂蚁金服高级技术专家/《分布式服务架构》《可伸缩服务架构》作者</code></p>
<p>本书可以说是后端架构师的进阶宝典，全面地讲解了如何打造一套强大、健壮的微服务体系，深入分析了涉及到的各个组件。*难得的是，书中结合了作者多年积累的架构经验，分析了各种组件适用的场景，平实地说明了实际使用中的各种考量和细节优化，简直是奋斗在一线的工程师的心血结晶。任何想掌握大型后端架构的工程师，无论使用什么技术框架，都能从本书获益匪浅。</p>
<p><code>——李双涛 饿了么中间件资深架构师</code></p>
<p>Spring Cloud已然成为Java领域应用微服务化的*选框架，但国内一直缺少全面论述Spring Cloud商用实践相关的书籍。本书围绕Spring Cloud框架中的服务注册发现、服务路由、服务网关、分布式配置、服务治理、容器化及微服务设计等关键领域进行了深入浅出的讲解，并给予了大量的真实应用案例，新手和老手都可以从中受益良多。作者作为Spring Cloud中国的资深专家，对于Spring Cloud及微服务有着深刻的架构和实战经验，值得信赖。</p>
<p><code>——单家骏 腾讯中间件高级工程师</code></p>
<p>在微服务体系中，Spring Cloud是目前最热门的构建微服务体系的解决方案，它提供了构建微服务架构的一些基础设施。本书内容上覆盖了Spring Cloud的一些主要组件，不仅在如何使用上做了详细的介绍，也从原理上深入浅出地剖析了其中的技术要点，同时部分组件也跟周边的一些开源项目进行了对比，且提供了一些原理分析和相关的示例，是一本不可多得的Spring Cloud实战书籍。新手和有微服务实践经验的读者都能从书中得到一些不一样的收获。<br>     <code>——张艺辰 腾讯高级研发工程师</code></p>
<p>本书不仅对Spring Cloud各核心组件进行了细致入微的介绍，同时也跳出了框架本身，为微服务的实施和分布式架构所面临的基本问题交出了Spring Cloud式答卷，是开发者快速掌握Spring Cloud技术栈的神兵利器。不仅如此，本书还凝聚着Spring Cloud中国社区的智慧结晶，让我们看到了国人在开源领域的研发力量， 可喜可贺。<br>     <code>——王鸿飞 百度高级研发工程师</code></p>
<p>在微服务如火如荼的今天，各种微服务框架层出不穷，而Spring Cloud无疑是那颗最闪亮的星。从Spring Framework到Spring Boot，再到如今的Spring Cloud，Spring全家桶给众多程序员带来了真正的春天。由于分布式和服务化是极具挑战的任务，因此Spring Cloud也不可避免的愈加复杂。Spring CLoud中国社区为Spring Cloud的普及做出了巨大的贡献，并迅速的降低了语言问题所带来的学习门槛。这本书由Spring CLoud中国社区倾力打造，书籍涵盖了Spring Cloud的服务发现、网关、熔断器、配置、全链路监控等最核心组件，并很接地气地详述了Dubbo向Spring Cloud迁移以及Spring Cloud与分布式事务相关内容，值得一看。<br><code>——张亮 京东金融数据研发负责人/分布式数据库中间件Sharding-Sphere负责人</code></p>
<p>Spring Cloud提供了完整的微服务技术体系，可以帮助开发者快速地实现架构升级。《重新定义Spring Cloud实战》一书完整地介绍了Spring Cloud中各个组件的使用方法并深度剖析了其中的原理，文章深入浅出帮助开发者快速掌握和理解Spring Cloud。<br><code>——李艺恒 腾讯研发工程师</code></p>
<h3 id="3-3-读者反馈"><a href="#3-3-读者反馈" class="headerlink" title="3.3 读者反馈"></a>3.3 读者反馈</h3><p><a href="https://github.com/SpringCloud/spring-cloud-code/issues/1" target="_blank" rel="external">https://github.com/SpringCloud/spring-cloud-code/issues/1</a></p>
<h3 id="3-4-源码相关"><a href="#3-4-源码相关" class="headerlink" title="3.4 源码相关"></a>3.4 源码相关</h3><p>书籍目录：<a href="https://github.com/SpringCloud/spring-cloud-catalog" target="_blank" rel="external">https://github.com/SpringCloud/spring-cloud-catalog</a></p>
<p>源码地址:<a href="https://github.com/SpringCloud/spring-cloud-code" target="_blank" rel="external">https://github.com/SpringCloud/spring-cloud-code</a></p>
<h3 id="3-5-内容简介"><a href="#3-5-内容简介" class="headerlink" title="3.5 内容简介"></a>3.5 内容简介</h3><p>这是一本实践与理论并重、广度与深度兼顾的Spring Cloud生产实践开发指南，由Spring Cloud中国社区倾力打造，作者来自阿里、蚂蚁金服、京东金融等企业，本书针对Spring Cloud在国内的使用情况，结合国内企业使用Spring Cloud落地微服务架构遇到的问题，提出可落地的解决方案。</p>
<p>本书内容有3大特色：</p>
<ul>
<li><p><code>足够广</code>：详细讲解了Spring Cloud的核心常用组件以及Spring Cloud的增强生态，针对生产实践中常见问题给出可落地的最佳实践方案，无论您是初学者还是开发人员，还是架构师，都能从此书获益。</p>
</li>
<li><p><code>有深度</code>：本书对涉及的Spring Cloud组件按照从入门、进阶、实战、扩展增强的顺序循序渐进进行剖析和讲解,帮助作者知其然并知其所以然，授之以渔。</p>
</li>
<li><p><code>重实践</code>：注重生产实践，通过案例驱动，给出优秀的生产实践方案和优秀的生产配置，帮助读者快速落地企业微服务架构。</p>
</li>
</ul>
<p>全书共25章，分为三个部分：</p>
<ul>
<li><p>第一部分 核心组件篇（第1~10章）<br>主要讲解Spring Cloud的核心组件。首先从应用架构的发展历程讲起，介绍了微服务出现的背景，并对微服务架构的落地提出了相应的解决方案；然后分别详细介绍了Spring Cloud微服务体系中的核心常用组件，如Eureka、Feign、Ribbon、Hystrix、Zuul等；最后通过一个综合案例将前面介绍的组件连接起来，帮助大家融会贯通。</p>
</li>
<li><p>第二部分 进阶实战篇（第11~18章）<br>在核心组件的基础上，对Config、Consul、认证和鉴权、全链路监控以及对Spring Cloud生态圈中第二代网关Spring Cloud Gateway进行了详细阐述，循序渐进、案例驱动，帮助读者加深对组件的理解和运用，更好地掌握相关内容运用于生产实践。</p>
</li>
<li><p>第三部分 解决方案篇（第19~25章）<br> 主要从解决方案着手，内容包括Spring Cloud与gRPC的整合方式、版本控制与灰度发布、Spring Cloud容器化、Dubbo向Spring Cloud的迁移、分布式事务、领域驱动等生产级实用解决方案，为企业IT架构微服务化和变革保驾护航。</p>
</li>
</ul>
<h3 id="3-6-推荐理由"><a href="#3-6-推荐理由" class="headerlink" title="3.6 推荐理由"></a>3.6 推荐理由</h3><ul>
<li><p>本书由Spring Cloud社区官方撰写，核心成员来自原阿里、蚂蚁金服、京东金融等互联网企业，经验丰富。</p>
</li>
<li><p>本书内容有3大特色：宽度足够广、深度足够深，而且立足于生产实践，直接从生产实践出发，包含大量生产实践的配置</p>
</li>
<li><p>本书得到了来自阿里、腾讯、百度、京东等大型互联网企业的近10位专家的鼎力推荐。</p>
</li>
</ul>
<h3 id="3-7-作者介绍"><a href="#3-7-作者介绍" class="headerlink" title="3.7 作者介绍"></a>3.7 作者介绍</h3><ol>
<li><p>许进:Spring Cloud中国社区创始人，阿里原资深工程师，花名玹霖，专注于基础架构与中间件研发，曾就职于唯品会平台架构部和饿了么。个人网站：<a href="http://xujin.org。" target="_blank" rel="external">http://xujin.org。</a></p>
</li>
<li><p>钟尊发:Spring Cloud中国社区联合创始人，现就职于京东金融，对微服务有深入研究。</p>
</li>
<li><p>叶志远:Spring Cloud中国社区联合创始人，现就职于蚂蚁金服，花名梓尧。CSDN博客专家，开源社区活跃者，国内Spring Cloud早期实践者</p>
</li>
<li><p>方志朋:Spring Cloud中国社区联合创始人，硕士学历，《深入理解Spring Cloud与微服务构建》作者，CSDN博客专家（阅读量600万+），在社区具有较高活跃度与影响力。</p>
</li>
<li><p>蔡波斯:拥有多年Java开发经验，曾就职于美团、腾讯。国内Spring Cloud领域的早期实践者，现在金融行业从事FinTech相关研发</p>
</li>
<li><p>郭芳碧:多年微服务实践经验，现任职于某互联网金融公司中间件部门。</p>
</li>
<li><p>朱德明:拥有10年Java开发经验，多年技术架构和解决方案经验，现任灵雀云微服务架构师，在微服务领域有着丰富的落地经验，曾任某创业公司技术负责人。</p>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要:&lt;/strong&gt; 今天是2018年9月24号中秋节，祝福大家中秋节快乐，本文主要介绍《重新定义Spring Cloud实战》。&lt;/p&gt;
    
    </summary>
    
      <category term="重新定义" scheme="http://xujin.org/categories/%E9%87%8D%E6%96%B0%E5%AE%9A%E4%B9%89/"/>
    
    
      <category term="项目经验" scheme="http://xujin.org/tags/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C/"/>
    
      <category term="重新定义" scheme="http://xujin.org/tags/%E9%87%8D%E6%96%B0%E5%AE%9A%E4%B9%89/"/>
    
  </entry>
  
  <entry>
    <title>个人博客-有争议文章版权问题复盘声明</title>
    <link href="http://xujin.org/ex/bqsm/"/>
    <id>http://xujin.org/ex/bqsm/</id>
    <published>2018-09-03T06:00:00.000Z</published>
    <updated>2018-11-03T04:59:17.562Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:大家好，我是许进沉思录的博主许进，感谢大家对我的博客进行阅读，之所以网站<code>取名为沉思录</code>主要想用<code>博客的方式记录我人生每个阶段的技术思考和技术学习快照，和感悟</code>。由于最近有网友对我博客上的内容的<code>版权问题产生争议</code>，因此本文主要对我个人博客内容的版权问题争议<code>进行复盘声明</code>。</p>
<a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章为什么会出现呢？</p>
<ul>
<li>第一,因为最近发生了让我匪夷所思的事情，至于什么事情我不想做过多解释。我只想<code>做好我自己，尊师重道，有则改之，无责加勉</code>。</li>
<li>第二,最近有幸和另外6位作者写完一本名为《重新定义Spring Cloud实战》技术书，起初规划了32章，最后实在写不动了，保留了精华的25章，由于工作特别忙，7位作者经过无数个夜晚熬夜，最终初稿汇总之后 1400页，我第一感觉我的天呀，纸张这么贵。而且我们在写的过程中，站在读者的角度+降低成本的角度，做了很多思考。最后我们7人进行缩减，能用一句话说明白的就不要用两句话，经过对整本书进行调整，在保持内容不变的情况下最后初稿为1187页。好像跑题了，言归正传，最近电子鲜读版本已公开。好多技术朋友看完之后，有人问我:我可以在我博客上写一下关于这本书的读书笔记吗？我说可以呀，然后他问了我版权署名的问题。我回答是:我不太介意这个问题，我们做好自己就可以。但是为了避免引起不必要的麻烦，我建议他可以写为《某某某书的读书笔记》</li>
</ul>
<blockquote>
<p>针对上述两个问题，和最近发生的事情，真的有必要进行复盘进行声明。</p>
</blockquote>
<h2 id="1-博客概述"><a href="#1-博客概述" class="headerlink" title="1.博客概述"></a>1.博客概述</h2><p>   我开始接触写博客的时候是从新浪博客开始，后来经过多次折腾进行迁移。在写这篇文章之前，我想介绍一下什么是<code>博客</code>。百度百科对博客的描述如下图片所示:<br><img src="/images/csl/bkgs.png" width="650px" height="450px"></p>
<blockquote>
<p>简单的来说博客就是对<code>学习</code>，<code>生活</code>，<code>感悟</code>，<code>思考</code>的一种记录方式。仅代表个人观点。</p>
</blockquote>
<h2 id="2-博客版权声明"><a href="#2-博客版权声明" class="headerlink" title="2. 博客版权声明"></a>2. 博客版权声明</h2><p>  近几年随着知识产权和版权意识的增强，很多人开始对自己在网上发表的博客信息或网络日志，或者想法和感悟增加版权信息。</p>
<h3 id="2-1-Hexo博客版权增加"><a href="#2-1-Hexo博客版权增加" class="headerlink" title="2.1 Hexo博客版权增加"></a>2.1 Hexo博客版权增加</h3><p>用过Hexo或者Hugo的可以知道，有时为了反复添加重复内容，会统一添加版权信息。代码如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;! -- 添加版权信息 --&gt;</div><div class="line">&lt;div class=&quot;article-footer-copyright&quot;&gt;</div><div class="line">&lt;i class=&quot;fa fa-lightbulb-o&quot;&gt;&lt;/i&gt;</div><div class="line">本文由&lt;b&gt;&lt;a href=&quot;&lt;%= config.root %&gt;index.html&quot; target=&quot;_blank&quot; title=&quot;&lt;%= config.author %&gt;&quot;&gt;&lt;%= config.author %&gt;&lt;/a&gt;&lt;/b&gt;创作和发表,采用&lt;a href=&quot;http://creativecommons.org/licenses/by/3.0/cn&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CC BY 3.0 CN协议&lt;/a&gt; 进行许可。转载请注明作者及出处,本文作者为&lt;b&gt;&lt;a href=&quot;&lt;%= config.root %&gt;index.html&quot; target=&quot;_blank&quot; title=&quot;&lt;%= config.author %&gt;&quot;&gt;&lt;%= config.author %&gt;&lt;/a&gt;&lt;/b&gt;,本文标题为&lt;b&gt;&lt;a href=&quot;&lt;%- config.root %&gt;&lt;%- post.path %&gt;&quot; target=&quot;_blank&quot; title=&quot;&lt;%= post.title %&gt;&quot;&gt;&lt;%= post.title %&gt;&lt;/a&gt;&lt;/b&gt;</div><div class="line">本文链接为&lt;b&gt;&lt;a href=&quot;&lt;%- config.root %&gt;&lt;%- post.path %&gt;&quot; target=&quot;_blank&quot; title=&quot;&lt;%= post.title %&gt;&quot;&gt;&lt;%- config.url %&gt;/&lt;%- post.path %&gt;&lt;/a&gt;&lt;/b&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;! -- 添加版权信息 --&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>优点</code>:统一添加版权信息<br><code>缺点</code>:如果遗漏容易产生误解</p>
<p>统一添加的方式，虽然方便，即便你指明了作者是谁，但是也容易引起误会，可能会给自己造成困扰。比如下面争议的几篇文章。</p>
</blockquote>
<h2 id="3-博客版权-争议问题复盘说明"><a href="#3-博客版权-争议问题复盘说明" class="headerlink" title="3.博客版权-争议问题复盘说明"></a>3.博客版权-争议问题复盘说明</h2><h3 id="3-1-博客主题版权声明"><a href="#3-1-博客主题版权声明" class="headerlink" title="3.1 博客主题版权声明"></a>3.1 博客主题版权声明</h3><p>  我博客基于Hexo构建，主题基于<a href="https://github.com/ppoffice/hexo-theme-icarus优化美化进行定制DIY。感谢原作者贡献了分享了该主题。" target="_blank" rel="external">https://github.com/ppoffice/hexo-theme-icarus优化美化进行定制DIY。感谢原作者贡献了分享了该主题。</a></p>
<h3 id="3-2-Spring-Cloud-Zuul异常处理文章-版权说明"><a href="#3-2-Spring-Cloud-Zuul异常处理文章-版权说明" class="headerlink" title="3.2 Spring Cloud Zuul异常处理文章-版权说明"></a>3.2 Spring Cloud Zuul异常处理文章-版权说明</h3><p>如下图所示Spring Cloud Zuul异常处理文章来自于Spring Cloud中国社区博客投稿，文稿署名张劲，为了让更多的人学习了解。放了一份到我博客已注明作者。</p>
<p><img src="/images/csl/zywz1.jpg" width="650px" height="850px"></p>
<p>跟<code>作者沟通了解之后</code>，<code>作者没有参加过上海技术沙龙也没看过对应的PPT</code>，<br><img src="/images/csl/zjsm2.png" width="650px" height="850px"></p>
<h3 id="3-3-数据库连性池性能测试-文章版权声明"><a href="#3-3-数据库连性池性能测试-文章版权声明" class="headerlink" title="3.3 数据库连性池性能测试-文章版权声明"></a>3.3 数据库连性池性能测试-文章版权声明</h3><p> 本篇文章链接在我博客上地址是:<a href="http://xujin.org/mw/dcp-test/">http://xujin.org/mw/dcp-test/</a>， 是我在唯品会中间件团队时学习中间件的记录，收集整理成MD文稿而来。</p>
<ul>
<li><p>通过百度搜索结果如下，最下面的两个截图类似的文章。<br><img src="/images/csl/zjzh1.png" width="650px" height="850px"></p>
</li>
<li><p>跟原作者沟通声明版权为唯品会中间件团队<br>沟通结果如下:<br><img src="/images/csl/htjl.jpg" width="650px" height="850px"></p>
</li>
</ul>
<p>处理结果如下:<br><img src="/images/csl/zhsh.jpg" width="650px" height="850px"></p>
<h2 id="4-总结处理方式"><a href="#4-总结处理方式" class="headerlink" title="4.总结处理方式"></a>4.总结处理方式</h2><p>博客后期优化方式:<br>1.<code>修改统一加版权方式为手动添加，减少不必要的误会</code>。<br>2.<code>增加反馈机制</code>，第一时间<code>反馈处理</code></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:大家好，我是许进沉思录的博主许进，感谢大家对我的博客进行阅读，之所以网站&lt;code&gt;取名为沉思录&lt;/code&gt;主要想用&lt;code&gt;博客的方式记录我人生每个阶段的技术思考和技术学习快照，和感悟&lt;/code&gt;。由于最近有网友对我博客上的内容的&lt;code&gt;版权问题产生争议&lt;/code&gt;，因此本文主要对我个人博客内容的版权问题争议&lt;code&gt;进行复盘声明&lt;/code&gt;。&lt;/p&gt;
    
    </summary>
    
      <category term="沉思录" scheme="http://xujin.org/categories/%E6%B2%89%E6%80%9D%E5%BD%95/"/>
    
    
      <category term="沉思录" scheme="http://xujin.org/tags/%E6%B2%89%E6%80%9D%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway中的权重路由</title>
    <link href="http://xujin.org/sc/gw/gw08/"/>
    <id>http://xujin.org/sc/gw/gw08/</id>
    <published>2018-06-09T06:00:00.000Z</published>
    <updated>2018-11-03T05:01:09.899Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要通过运用Spring Cloud Gateway的WeightRoutePredicateFactory对URL进行权重路由。</p>
<a id="more"></a>
<h2 id="1-权重路由"><a href="#1-权重路由" class="headerlink" title="1.权重路由"></a>1.权重路由</h2><h3 id="1-1-权重路由使用场景"><a href="#1-1-权重路由使用场景" class="headerlink" title="1.1 权重路由使用场景"></a>1.1 权重路由使用场景</h3><p>在开发或者测试的时候，或者线上发布，线上服务多版本控制的时候，需要对服务提供权重路由，最常见的使用就是，一个服务有两个版本，旧版本V1，新版本v2。在线上灰度的时候，需要通过网关动态实时推送，路由权重信息。比如95%的流量走服务v1版本，5%的流量走服务v2版本。</p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/ce44017f07ce3a1b1d30e87995227ef4.jpg?Expires=1843884992&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=DBIQ%2BF%2BgIkpjik7x0CmmfaSrglU%3D" alt=""></p>
<blockquote>
<p>issue: The Spring Cloud Gateway issue of Allow Rolling Deployments <a href="https://github.com/spring-cloud/spring-cloud-gateway/issues/67" target="_blank" rel="external">https://github.com/spring-cloud/spring-cloud-gateway/issues/67</a></p>
</blockquote>
<h3 id="1-2-Spring-Cloud-Gateway权重路由原理"><a href="#1-2-Spring-Cloud-Gateway权重路由原理" class="headerlink" title="1.2 Spring Cloud Gateway权重路由原理"></a>1.2 Spring Cloud Gateway权重路由原理</h3><p>Spring Cloud Gateway中提供了<code>org.springframework.cloud.gateway.handler.predicate.WeightRoutePredicateFactory</code>去实现根据分组设置权重进行路由，因此使用起来相对比较简单，有兴趣的可以debug阅读源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeightRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">WeightConfig</span>&gt; <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(WeightRoutePredicateFactory.class);</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_KEY = WeightConfig.CONFIG_PREFIX + <span class="string">".group"</span>;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEIGHT_KEY = WeightConfig.CONFIG_PREFIX + <span class="string">".weight"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> ApplicationEventPublisher publisher;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">WeightRoutePredicateFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(WeightConfig.class);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher publisher)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.publisher = publisher;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Arrays.asList(GROUP_KEY, WEIGHT_KEY);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">shortcutFieldPrefix</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">return</span> WeightConfig.CONFIG_PREFIX;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeApply</span><span class="params">(WeightConfig config)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (publisher != <span class="keyword">null</span>) &#123;</div><div class="line">			publisher.publishEvent(<span class="keyword">new</span> WeightDefinedEvent(<span class="keyword">this</span>, config));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(WeightConfig config)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> exchange -&gt; &#123;</div><div class="line">			Map&lt;String, String&gt; weights = exchange.getAttributeOrDefault(WEIGHT_ATTR,</div><div class="line">					Collections.emptyMap());</div><div class="line"></div><div class="line">			String routeId = exchange.getAttribute(GATEWAY_PREDICATE_ROUTE_ATTR);</div><div class="line"></div><div class="line">			<span class="comment">// all calculations and comparison against random num happened in</span></div><div class="line">			<span class="comment">// WeightCalculatorWebFilter</span></div><div class="line">			String group = config.getGroup();</div><div class="line">			<span class="keyword">if</span> (weights.containsKey(group)) &#123;</div><div class="line"></div><div class="line">				String chosenRoute = weights.get(group);</div><div class="line">				<span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line">					log.trace(<span class="string">"in group weight: "</span>+ group + <span class="string">", current route: "</span> + routeId +<span class="string">", chosen route: "</span> + chosenRoute);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">return</span> routeId.equals(chosenRoute);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-Spring-Cloud-Gateway中的权重路由案例"><a href="#2-Spring-Cloud-Gateway中的权重路由案例" class="headerlink" title="2.Spring Cloud Gateway中的权重路由案例"></a>2.Spring Cloud Gateway中的权重路由案例</h2><h3 id="2-1-案例代码地址"><a href="#2-1-案例代码地址" class="headerlink" title="2.1 案例代码地址"></a>2.1 案例代码地址</h3><p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch4" target="_blank" rel="external">https://github.com/SoftwareKing/sc-gateway/tree/master/ch4</a></p>
<h3 id="2-2-Spring-Cloud-Gateway-Server说明"><a href="#2-2-Spring-Cloud-Gateway-Server说明" class="headerlink" title="2.2 Spring Cloud Gateway Server说明"></a>2.2 Spring Cloud Gateway Server说明</h3><p>Spring Cloud Gateway will dispatch 95% of the requests to version 1 and 5% of the traffic to version 2 of a specified service, as shown by the following figure.</p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/f8e439776d6bbff94993fafdfc02b98c.png?Expires=1843885017&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=a8ZhI5O5y7Gs7TP4eusGOT7qdoE%3D" alt=""></p>
<p>我们通过在Spring Cloud Gateway中会配置不同的权重信息到不同URL上，Spring Cloud Gateway会根据我们配置的路由权重信息，将请求分发到不同的源服务组，权重信息如ch4/ch4-gateway中的application.yml所示，主要配置信息如下。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> ch4-gateway</div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"></div><div class="line"><span class="attr">      - id:</span> service1_v1</div><div class="line"><span class="attr">        uri:</span> http://localhost:<span class="number">8081</span>/v1</div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> Path=/test</div><div class="line"><span class="bullet">        -</span> Weight=service1, <span class="number">95</span></div><div class="line"></div><div class="line"><span class="attr">      - id:</span> service1_v2</div><div class="line"><span class="attr">        uri:</span> http://localhost:<span class="number">8081</span>/v2</div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> Path=/test</div><div class="line"><span class="bullet">        -</span> Weight=service1, <span class="number">5</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Weight=service1, 95，Weight=service1, 5就是路由的权重信息。</p>
</blockquote>
<h3 id="2-3-源服务"><a href="#2-3-源服务" class="headerlink" title="2.3 源服务"></a>2.3 源服务</h3><p>源服务在本案例中源服务如ch4-service-provider所示，主要提提供Gateway Server权重路由对应的后端源服务。因为比较简单因此不做详细说明，主要代码如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.xujin.sc.service;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</div><div class="line"></div><div class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</div><div class="line"></div><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@RequestMapping</span>(value = <span class="string">"/v1"</span>, produces = <span class="string">"text/plain;charset=UTF-8"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">v1</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Mono.just(<span class="string">"v1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@RequestMapping</span>(value = <span class="string">"/v2"</span>, produces = <span class="string">"text/plain;charset=UTF-8"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">v2</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Mono.just(<span class="string">"v2"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-4-测试"><a href="#2-4-测试" class="headerlink" title="2.4 测试"></a>2.4 测试</h3><p>分别启动ch4-gateway，ch4-service-provider进行访问:<a href="http://localhost:8080/test" target="_blank" rel="external">http://localhost:8080/test</a> 测试,发现会根据所设权重进行路由。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本文主要通过运用Spring Cloud Gateway的WeightRoutePredicateFactory对URL进行权重路由。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway中的GatewayFilter和GlobalFilter</title>
    <link href="http://xujin.org/sc/gw/gw07/"/>
    <id>http://xujin.org/sc/gw/gw07/</id>
    <published>2018-05-26T06:00:00.000Z</published>
    <updated>2018-11-03T05:01:05.364Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要介绍了什么是GatewayFilter和GlobalFilter，以及区别和联系。然后介绍如何在Spring Cloud Gateway中自定义使用GatewayFilter和GlobalFilter。</p>
<a id="more"></a>
<h2 id="1-Spring-Cloud-gateway的Filter"><a href="#1-Spring-Cloud-gateway的Filter" class="headerlink" title="1. Spring Cloud gateway的Filter"></a>1. Spring Cloud gateway的Filter</h2><p>Spring Cloud gateway中的Filter从接口实现上分为两种一种是GatewayFilter，另外一种是GlobalFilter。</p>
<h2 id="1-1-GatewayFilter与GlobalFilter的区别"><a href="#1-1-GatewayFilter与GlobalFilter的区别" class="headerlink" title="1.1 GatewayFilter与GlobalFilter的区别"></a>1.1 GatewayFilter与GlobalFilter的区别</h2><p>区别用英语可以总结如下:<br>At a high level global filters are applied to all routes, while a gateway filter will be applied to an individual route(s)</p>
<blockquote>
<p>在一个高的角度来看，Global filters会被应用到所有的路由上，而Gateway filter将应用到<code>单个路由</code>上或者<code>一个分组的路由</code>上。在下面的案例中将会进行说明。</p>
</blockquote>
<h2 id="1-2-本文代码地址"><a href="#1-2-本文代码地址" class="headerlink" title="1.2 本文代码地址"></a>1.2 本文代码地址</h2><blockquote>
<p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch2" target="_blank" rel="external">https://github.com/SoftwareKing/sc-gateway/tree/master/ch2</a></p>
</blockquote>
<h2 id="2-GatewayFilter和GlobalFilter"><a href="#2-GatewayFilter和GlobalFilter" class="headerlink" title="2. GatewayFilter和GlobalFilter"></a>2. GatewayFilter和GlobalFilter</h2><h3 id="2-1-GatewayFilter"><a href="#2-1-GatewayFilter" class="headerlink" title="2.1 GatewayFilter"></a>2.1 GatewayFilter</h3><h4 id="2-1-1-什么是GatewayFilter"><a href="#2-1-1-什么是GatewayFilter" class="headerlink" title="2.1.1 什么是GatewayFilter"></a>2.1.1 什么是GatewayFilter</h4><p>Contract for interception-style, chained processing of Web requests that may be used to implement cross-cutting, application-agnostic requirements such<br> as security, timeouts, and others. Specific to a Gateway Copied from WebFilter</p>
<blockquote>
<p>GatewayFilter是从WebFilter中Copy过来的，相当于一个Filter过滤器，可以对访问的URL过滤横切处理，应用场景比如超时，安全等。</p>
</blockquote>
<p>从Spring Cloud Gateway的源码中如下所示，可以看出GatewayFilter的使用场景:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Contract for interception-style, chained processing of Web requests that may</div><div class="line"> * be used to implement cross-cutting, application-agnostic requirements such</div><div class="line"> * as security, timeouts, and others. Specific to a Gateway</div><div class="line"> *</div><div class="line"> * Copied from WebFilter</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> Rossen Stoyanchev</div><div class="line"> * <span class="doctag">@since</span> 5.0</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GatewayFilter</span> <span class="keyword">extends</span> <span class="title">ShortcutConfigurable</span> </span>&#123;</div><div class="line"></div><div class="line">	String NAME_KEY = <span class="string">"name"</span>;</div><div class="line">	String VALUE_KEY = <span class="string">"value"</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Process the Web request and (optionally) delegate to the next</div><div class="line">	 * &#123;<span class="doctag">@code</span> WebFilter&#125; through the given &#123;<span class="doctag">@link</span> GatewayFilterChain&#125;.</div><div class="line">	 * <span class="doctag">@param</span> exchange the current server exchange</div><div class="line">	 * <span class="doctag">@param</span> chain provides a way to delegate to the next filter</div><div class="line">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request processing is complete</div><div class="line">	 */</div><div class="line">	<span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>GatewayFilter和GlobalFilter两个接口中定义的方法一样都是Mono<void> filter(ServerWebExchange exchange, GatewayFilterChain chain)，唯一的区别就是GatewayFilter继承了ShortcutConfigurable，GlobalFilter没有任何继承。</void></p>
</blockquote>
<h5 id="2-1-2-自定义GatewayFilter-Custom-GatewayFilter"><a href="#2-1-2-自定义GatewayFilter-Custom-GatewayFilter" class="headerlink" title="2.1.2 自定义GatewayFilter(Custom GatewayFilter)"></a>2.1.2 自定义GatewayFilter(Custom GatewayFilter)</h5><p>如org.xujin.sc.filter.CustomFilter代码所示，通过自定义GatewayFilter对路由转发的处理时长统计。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.xujin.sc.filter;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</div><div class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</div><div class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</div><div class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 统计某个或者某种路由的的处理时长</div><div class="line"> * <span class="doctag">@author</span> xujin</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(GatewayFilter.class);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COUNT_Start_TIME = <span class="string">"countStartTime"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line">        exchange.getAttributes().put(COUNT_Start_TIME, System.currentTimeMillis());</div><div class="line">        <span class="keyword">return</span> chain.filter(exchange).then(</div><div class="line">                Mono.fromRunnable(() -&gt; &#123;</div><div class="line">                    Long startTime = exchange.getAttribute(COUNT_Start_TIME);</div><div class="line">                    Long endTime=(System.currentTimeMillis() - startTime);</div><div class="line">                    <span class="keyword">if</span> (startTime != <span class="keyword">null</span>) &#123;</div><div class="line">                        log.info(exchange.getRequest().getURI().getRawPath() + <span class="string">": "</span> + endTime + <span class="string">"ms"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-1-3-Gateway-Filter与RouteLocator绑定使用"><a href="#2-1-3-Gateway-Filter与RouteLocator绑定使用" class="headerlink" title="2.1.3 Gateway Filter与RouteLocator绑定使用"></a>2.1.3 Gateway Filter与RouteLocator绑定使用</h4><p>在org.xujin.sc.GatewayServerApplication中customerRouteLocator如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayServerApplication</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customerRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> builder.routes()</div><div class="line">                .route(r -&gt; r.path(<span class="string">"/test/prefix/**"</span>)</div><div class="line">                        .filters(f -&gt; f.stripPrefix(<span class="number">2</span>)</div><div class="line">                                .filter(<span class="keyword">new</span> CustomFilter())</div><div class="line">                                .addResponseHeader(<span class="string">"X-Response-test"</span>, <span class="string">"test"</span>))</div><div class="line">                        .uri(<span class="string">"lb://SC-CONSUMER"</span>)</div><div class="line">                        .order(<span class="number">0</span>)</div><div class="line">                        .id(<span class="string">"test_consumer_service"</span>)</div><div class="line">                )</div><div class="line">                .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(GatewayServerApplication.class, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><p>r.path(“/test/prefix/**”)表示自定义了访问前缀，在真正的Gateway进行路由转发的时候，会用过f.stripPrefix(2)把前缀去掉。</p>
<blockquote>
<p>使用场景:可以把对外暴露的URL通过加前缀分组打标。</p>
</blockquote>
</li>
<li><p>filter(new CustomFilter()</p>
<blockquote>
<p>filter(new CustomFilter()，表示把自定义的Filter加到Filter链里面执行，注意一点是自定义GlobalFilter不需要加进去。</p>
</blockquote>
</li>
<li><p>uri(“lb://SC-CONSUMER”)</p>
<blockquote>
<p>uri(“lb://SC-CONSUMER”)表示Spring Cloud Gateway对spring.application.name等于sc-consumer源服务应用中的URL进行协议适配转发。</p>
</blockquote>
</li>
</ol>
<h4 id="2-1-4-测试如下"><a href="#2-1-4-测试如下" class="headerlink" title="2.1.4 测试如下:"></a>2.1.4 测试如下:</h4><p>1.访问<a href="http://localhost:9000/SC-CONSUMER/hello/xujin" target="_blank" rel="external">http://localhost:9000/SC-CONSUMER/hello/xujin</a> 能正常访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</div><div class="line">2018-05-27 09:58:07.905 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id=&apos;CompositeDiscoveryClient_SC-CONSUMER&apos;, uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$337/1295338046@f2ff0c8, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$717/1168359877@1f74a2b, order=1&#125;]&#125;</div><div class="line">2018-05-27 09:58:07.905 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@f5bf288&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$717/1168359877@1f74a2b, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@26c77f54&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@4c38cd16&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2c1d57bc&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@6e9a0bea&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@7ddcb0dc&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@3e856100&#125;, order=2147483647&#125;]</div></pre></td></tr></table></figure>
<blockquote>
<p>从上面的控制台打印日志可以看出，没有打印出该URL对应的耗时。</p>
</blockquote>
<p>2.加上URL前缀/test/prefix/访问，测试URL为<br><a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin" target="_blank" rel="external">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2018-05-27 10:01:56.057 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/test/prefix/hello/testCustomFilter/xujin] to Route&#123;id=&apos;test_consumer_service&apos;, uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$337/1295338046@6dbaa72e, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory$$Lambda$340/1149217113@41fb2078, order=0&#125;, org.xujin.sc.filter.CustomFilter@281885a3, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory$$Lambda$342/1099925775@4705cae6, order=0&#125;]&#125;</div><div class="line">2018-05-27 10:01:56.057 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@f5bf288&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory$$Lambda$340/1149217113@41fb2078, order=0&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory$$Lambda$342/1099925775@4705cae6, order=0&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@26c77f54&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@4c38cd16&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2c1d57bc&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@6e9a0bea&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@7ddcb0dc&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@3e856100&#125;, order=2147483647&#125;, org.xujin.sc.filter.CustomFilter@281885a3]</div><div class="line">2018-05-27 10:02:00.347  INFO 31658 --- [ctor-http-nio-8] o.s.cloud.gateway.filter.GatewayFilter   : /hello/testCustomFilter/xujin: 859ms</div></pre></td></tr></table></figure>
<blockquote>
<p>如上日志可以看到/hello/testCustomFilter/xujin: 859ms，Gateway转发的时候去掉了前缀。</p>
</blockquote>
<h3 id="2-2-GlobalFilter"><a href="#2-2-GlobalFilter" class="headerlink" title="2.2 GlobalFilter"></a>2.2 GlobalFilter</h3><h4 id="2-2-1-什么是GlobalFilter"><a href="#2-2-1-什么是GlobalFilter" class="headerlink" title="2.2.1 什么是GlobalFilter"></a>2.2.1 什么是GlobalFilter</h4><blockquote>
<p>The GlobalFilter interface has the same signature as GatewayFilter. These are special filters that are conditionally applied to all routes. (This interface and usage are subject to change in future milestones).</p>
</blockquote>
<p>Spring Cloud gateway定义了GlobalFilter的接口让我们去自定义实现自己的的GlobalFilter。GlobalFilter是一个全局的Filter，作用于所有的路由。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GlobalFilter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Process the Web request and (optionally) delegate to the next</div><div class="line">	 * &#123;<span class="doctag">@code</span> WebFilter&#125; through the given &#123;<span class="doctag">@link</span> GatewayFilterChain&#125;.</div><div class="line">	 * <span class="doctag">@param</span> exchange the current server exchange</div><div class="line">	 * <span class="doctag">@param</span> chain provides a way to delegate to the next filter</div><div class="line">	 * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request processing is complete</div><div class="line">	 */</div><div class="line">	<span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-2-自定义全局过滤器-Custom-GlobalFilter"><a href="#2-2-2-自定义全局过滤器-Custom-GlobalFilter" class="headerlink" title="2.2.2 自定义全局过滤器(Custom GlobalFilter)"></a>2.2.2 自定义全局过滤器(Custom GlobalFilter)</h4><p>在这里简单定义AuthSignatureFilter实现<code>GlobalFilter</code>，使用场景就是Gateway对请求的URL校验权限，判断请求的URL是否是合法请求。通过从ServerWebExchange获取请求上下文中authToken对应的值，进行判null处理，其它的check逻辑可以自定定制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.xujin.sc.filter;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</div><div class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</div><div class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</div><div class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 调用鉴权</div><div class="line"> */</div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthSignatureFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line">        String token = exchange.getRequest().getQueryParams().getFirst(<span class="string">"authToken"</span>);</div><div class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span> || token.isEmpty()) &#123;</div><div class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</div><div class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> chain.filter(exchange);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> -<span class="number">200</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>GlobalFilter写完了，那问题来了？如何让其在Gateway中运行生效，有两种方式一种直接加<code>@Component</code>注解，另外一种可以在 Spring Config 中配置这个 Bean如下所示:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> AuthSignatureFilter <span class="title">authSignatureFilter</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> AuthSignatureFilter();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>1.访问<a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin" target="_blank" rel="external">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin</a> 如下所示由于authToken为空401返回.</p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/91ce199f4af8f4bd9576aace65940253.jpeg?Expires=1842749245&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=Is0KT0QAVXkPS20EdSPvDqmlxmc%3D" alt=""></p>
<p>2.访问<a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin?authToken=asdasdsddasadsadsadsdadsewew32rg" target="_blank" rel="external">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin?authToken=asdasdsddasadsadsadsdadsewew32rg</a></p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/86509f882391c3a20d2f32778dd1c2e9.jpeg?Expires=1842749511&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=lAd7U0lj4WZ0HMWF9SpbfKJ4aR8%3D" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本文主要介绍了什么是GatewayFilter和GlobalFilter，以及区别和联系。然后介绍如何在Spring Cloud Gateway中自定义使用GatewayFilter和GlobalFilter。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway只有Pre和POST两种类型的Filter</title>
    <link href="http://xujin.org/sc/gw/gw06/"/>
    <id>http://xujin.org/sc/gw/gw06/</id>
    <published>2018-05-21T06:00:00.000Z</published>
    <updated>2018-11-03T05:01:01.119Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:Spring Cloud Gateway只有两种类型的Filter，本文介绍如何在Spring Cloud Gateway中创建一个Pre或Post类型的Filter。</p>
<a id="more"></a>
<h2 id="zuul的Filter类型"><a href="#zuul的Filter类型" class="headerlink" title="zuul的Filter类型"></a>zuul的Filter类型</h2><p>Zuul 的 Filter 是通过filterType()方法来指定，一个 Filter 只能对应一种类型，要么是 “pre” 要么是“post”</p>
<h3 id="Spring-Cloud-Gateway的Filter类型"><a href="#Spring-Cloud-Gateway的Filter类型" class="headerlink" title="Spring Cloud Gateway的Filter类型"></a>Spring Cloud Gateway的Filter类型</h3><p>Spring Cloud Gateway 基于 Project Reactor 和 WebFlux，采用响应式编程风格，打开它的 Filter 的接口GatewayFilter你会发现它只有一个方法filter</p>
<h2 id="Pre类型的Filter"><a href="#Pre类型的Filter" class="headerlink" title="Pre类型的Filter"></a>Pre类型的Filter</h2><p>在Spring Cloud Gateway源码中定义了一个Pre类型的Filter，code将会在chain.filter() 之前被执行,代码:<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/master/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/AddRequestHeaderGatewayFilterFactory.java" target="_blank" rel="external">AddRequestHeader</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.springframework.cloud.gateway.filter.factory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</div><div class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> Spencer Gibb</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddRequestHeaderGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractNameValueGatewayFilterFactory</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(NameValueConfig config)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> (exchange, chain) -&gt; &#123;</div><div class="line">			ServerHttpRequest request = exchange.getRequest().mutate()</div><div class="line">					.header(config.getName(), config.getValue())</div><div class="line">					.build();</div><div class="line"></div><div class="line">			<span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</div><div class="line">		&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Post类型的Filter"><a href="#Post类型的Filter" class="headerlink" title="Post类型的Filter"></a>Post类型的Filter</h2><p>对于Post类型的Filter，<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/master/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/SetStatusGatewayFilterFactory.java" target="_blank" rel="external">SetStatus</a><br>代码将会在chain.filter(exchange).then()里面的代码运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SetStatusGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">SetStatusGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> HttpStatus status = ServerWebExchangeUtils.parse(config.status);</div><div class="line">        <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</div><div class="line">                <span class="comment">// check not really needed, since it is guarded in setStatusCode,</span></div><div class="line">                <span class="comment">// but it's a good example</span></div><div class="line">                <span class="keyword">if</span> (!exchange.getResponse().isCommitted()) &#123;</div><div class="line">                    setResponseStatus(exchange, status);</div><div class="line">                &#125;</div><div class="line">            &#125;));</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:Spring Cloud Gateway只有两种类型的Filter，本文介绍如何在Spring Cloud Gateway中创建一个Pre或Post类型的Filter。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway基于服务发现的默认路由规则</title>
    <link href="http://xujin.org/sc/gw/gw05/"/>
    <id>http://xujin.org/sc/gw/gw05/</id>
    <published>2018-05-21T06:00:00.000Z</published>
    <updated>2018-11-03T05:00:56.883Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本篇文章主要介绍了Spring Cloud Gateway的基于服务发现的默认路由规则，从中可以看出Gateway的路由规则:<a href="http://Gateway_HOST:Gateway_PORT/大写的serviceId/*" target="_blank" rel="external">http://Gateway_HOST:Gateway_PORT/大写的serviceId/*</a> 和 zuul的默认路由规则<a href="http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/*差不多。" target="_blank" rel="external">http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/*差不多。</a></p>
<a id="more"></a>
<h2 id="1-Spring-Gateway概述"><a href="#1-Spring-Gateway概述" class="headerlink" title="1.Spring Gateway概述"></a>1.Spring Gateway概述</h2><h3 id="1-1-什么是Spring-Cloud-Gateway"><a href="#1-1-什么是Spring-Cloud-Gateway" class="headerlink" title="1.1 什么是Spring Cloud Gateway"></a>1.1 什么是Spring Cloud Gateway</h3><p>   <code>Spring Cloud Gateway</code>是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代Netflix ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。</p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/3f25fcd95769a54eb391931449d5298f.jpg?Expires=1841935182&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=F%2BSKuTDpXoj5xCXwIIJ4u8D1C2A%3D" alt=""></p>
<h3 id="1-2-Spring-Cloud-Gateway的功能"><a href="#1-2-Spring-Cloud-Gateway的功能" class="headerlink" title="1.2 Spring Cloud Gateway的功能"></a>1.2 Spring Cloud Gateway的功能</h3><p>Spring Cloud Gateway 的特征：</p>
<ul>
<li>基于 Spring Framework 5，Project Reactor 和 Spring Boot 2.0<br>动态路由</li>
<li>Predicates 和 Filters 作用于特定路由</li>
<li>集成 Hystrix 断路器</li>
<li>集成 Spring Cloud DiscoveryClient</li>
<li>易于编写的 Predicates 和 Filters</li>
<li>限流</li>
<li>路径重写</li>
</ul>
<h2 id="2-Spring-Cloud-Gateway的工程流程"><a href="#2-Spring-Cloud-Gateway的工程流程" class="headerlink" title="2. Spring Cloud Gateway的工程流程"></a>2. Spring Cloud Gateway的工程流程</h2><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/22e4eccf2cbe09332678c04b8de98ebe.jpg?Expires=1841935407&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=NHcssduqPTQry7HCmudjphw0qC4%3D" alt=""></p>
<p>   客户端向 Spring Cloud Gateway 发出请求。然后在 Gateway Handler Mapping 中找到与请求相匹配的路由，将其发送到 Gateway Web Handler。Handler 再通过指定的过滤器链来将请求发送到我们实际的服务执行业务逻辑，然后返回。<br>过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前（“pre”）或之后（“post”）执行业务逻辑。</p>
<h3 id="2-1-Pre和POST两种类型的过滤器"><a href="#2-1-Pre和POST两种类型的过滤器" class="headerlink" title="2.1 Pre和POST两种类型的过滤器"></a>2.1 Pre和POST两种类型的过滤器</h3><h2 id="3-基于服务发现的默认路由规则"><a href="#3-基于服务发现的默认路由规则" class="headerlink" title="3.基于服务发现的默认路由规则"></a>3.基于服务发现的默认路由规则</h2><h3 id="3-1-zuul和gateway的默认路由规则"><a href="#3-1-zuul和gateway的默认路由规则" class="headerlink" title="3.1 zuul和gateway的默认路由规则"></a>3.1 zuul和gateway的默认路由规则</h3><h4 id="3-1-1-zuul的默认路由规则"><a href="#3-1-1-zuul的默认路由规则" class="headerlink" title="3.1.1 zuul的默认路由规则"></a>3.1.1 zuul的默认路由规则</h4><p>说明默认情况下，Zuul会代理所有注册到Eureka Server的微服务，并且Zuul的路由规则如下：<br>   <a href="http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/**" target="_blank" rel="external">http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/**</a> 会被转发到serviceId对应的微服务。<br>   <a href="http://localhost:8040/sc-zuul-first-provider/sc/order/2" target="_blank" rel="external">http://localhost:8040/sc-zuul-first-provider/sc/order/2</a><br>   <img src="http://xujin.org/images/sc-study/sc-zuul-01-t1.png" alt="默认路由规则"></p>
<h4 id="3-1-2-gateway的默认路由规则"><a href="#3-1-2-gateway的默认路由规则" class="headerlink" title="3.1.2 gateway的默认路由规则"></a>3.1.2 gateway的默认路由规则</h4><p>下面的案例中会演示：<a href="http://localhost:9000/SC-CONSUMER/hello/xujin" target="_blank" rel="external">http://localhost:9000/SC-CONSUMER/hello/xujin</a></p>
<blockquote>
<p><a href="http://Gateway_HOST:Gateway_PORT/大写的serviceId/**，其中微服务应用名默认大写访问。" target="_blank" rel="external">http://Gateway_HOST:Gateway_PORT/大写的serviceId/**，其中微服务应用名默认大写访问。</a></p>
</blockquote>
<h3 id="3-2-案例示例代码"><a href="#3-2-案例示例代码" class="headerlink" title="3.2  案例示例代码"></a>3.2  案例示例代码</h3><p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch1" target="_blank" rel="external">https://github.com/SoftwareKing/sc-gateway/tree/master/ch1</a></p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/74473f8fa112dbf946452dd234be9783.jpeg?Expires=1841935730&OSSAccessKeyId=LTAI57F52hRuWq3h&Signature=8hk%2BcIs0lpEA3S01TQsu%2BVdome8%3D" width="450px" height="252px"></p>
<table>
<thead>
<tr>
<th>模块</th>
<th>说明</th>
<th>端口</th>
</tr>
</thead>
<tbody>
<tr>
<td>ch1-sc-consumer</td>
<td>服务消费者</td>
<td>8000</td>
</tr>
<tr>
<td>ch1-sc-eureka</td>
<td>Eureka Server注册中心</td>
<td>8761</td>
</tr>
<tr>
<td>ch1-sc-gateway</td>
<td>Spring Cloud Gateway Sever</td>
<td>9000</td>
</tr>
<tr>
<td>ch1-sc-provider</td>
<td>服务提供者</td>
<td>8001</td>
</tr>
</tbody>
</table>
<h4 id="3-2-1-ch1-sc-gateway工程说明"><a href="#3-2-1-ch1-sc-gateway工程说明" class="headerlink" title="3.2.1 ch1-sc-gateway工程说明"></a>3.2.1 ch1-sc-gateway工程说明</h4><h4 id="3-2-1-1-Maven依赖"><a href="#3-2-1-1-Maven依赖" class="headerlink" title="3.2.1.1  Maven依赖"></a>3.2.1.1  Maven依赖</h4><p>Spring Cloud Gateway sever主要的maven依赖如下所示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="3-2-1-2-yml文件配置"><a href="#3-2-1-2-yml文件配置" class="headerlink" title="3.2.1.2 yml文件配置"></a>3.2.1.2 yml文件配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> sc-gateway-server</div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      discovery:</span></div><div class="line"><span class="attr">        locator:</span></div><div class="line"><span class="attr">          enabled:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">9000</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> http://localhost:<span class="number">8761</span>/eureka/</div><div class="line"></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    org.springframework.cloud.gateway: debug</div></pre></td></tr></table></figure>
<p>配置说明：</p>
<blockquote>
<p>spring.cloud.gateway.discovery.locator.enabled：是否与服务发现组件进行结合，通过 serviceId 转发到具体的服务实例。默认为false，设为true便开启通过服务中心的自动根据 serviceId 创建路由的功能。</p>
</blockquote>
<hr>
<blockquote>
<p>修改spring cloud gateway server监听的端口为9000</p>
</blockquote>
<hr>
<blockquote>
<p>eureka.client.service-url.defaultZone: <a href="http://localhost:8761/eureka/,指定注册中心的地址，Spring" target="_blank" rel="external">http://localhost:8761/eureka/,指定注册中心的地址，Spring</a> Cloud Gateway从注册中心获取已经注册的服务列表。</p>
</blockquote>
<hr>
<blockquote>
<p>logging.level.org.springframework.cloud.gateway: debug,开启spring-Cloud-gateway的日志级别为debug，方便debug调试。</p>
</blockquote>
<h3 id="3-3-启动测试"><a href="#3-3-启动测试" class="headerlink" title="3.3 启动测试"></a>3.3 启动测试</h3><h4 id="3-3-1-错误的路由规则访问"><a href="#3-3-1-错误的路由规则访问" class="headerlink" title="3.3.1 错误的路由规则访问"></a>3.3.1 错误的路由规则访问</h4><p>访问Spring Cloud Gateway对应的server，当访问<a href="http://localhost:9000/sc-consumer/hello/xujin的时候，报错如下所示，正确的Spring" target="_blank" rel="external">http://localhost:9000/sc-consumer/hello/xujin的时候，报错如下所示，正确的Spring</a> Cloud Gateway的默认路由规则:<code>http://Gateway_HOST:Gateway_PORT/大写的serviceId/**</code></p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/d98d829455d0f1a180eb1b4561c7d530.jpeg?Expires=1842311197&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=bIbKneLe1y%2B32zADPV6uQP4B2QY%3D" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">2018-05-18 01:10:49.742 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying &#123;pattern=/SC-CONSUMER/**&#125; to Path</div><div class="line">2018-05-18 01:10:49.743 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying filter &#123;regexp=/SC-CONSUMER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</div><div class="line">2018-05-18 01:10:49.743 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-CONSUMER</div><div class="line">2018-05-18 01:10:49.744 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying &#123;pattern=/SC-PRODUCER/**&#125; to Path</div><div class="line">2018-05-18 01:10:49.744 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying filter &#123;regexp=/SC-PRODUCER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</div><div class="line">2018-05-18 01:10:49.745 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-PRODUCER</div><div class="line">2018-05-18 01:10:49.745 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying &#123;pattern=/SC-GATEWAY-SERVER/**&#125; to Path</div><div class="line">2018-05-18 01:10:49.747 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying filter &#123;regexp=/SC-GATEWAY-SERVER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</div><div class="line">2018-05-18 01:10:49.748 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-GATEWAY-SERVER</div><div class="line">2018-05-18 01:10:49.748 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</div><div class="line">2018-05-18 01:10:49.749 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id=&apos;CompositeDiscoveryClient_SC-CONSUMER&apos;, uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$707/751096818@7f4c6373, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$709/672603106@293895d2, order=1&#125;]&#125;</div><div class="line">2018-05-18 01:10:49.749 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@5e85c21b&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$709/672603106@293895d2, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@38e83838&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@6ef2f7ad&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@41def031&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@4966bab1&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@22d477c2&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@39832280&#125;, order=2147483647&#125;]</div></pre></td></tr></table></figure>
<p>从上面的log，看到返回了 404 错误，进一步可以看到 Spring Cloud Gateway 已经为我们的 provider 和 consumer 自动创建了对应的路由转发规则，但是这里的 pattern/regexp 里都是大写的，下面换成大写的测试一下。</p>
<h4 id="3-3-2-Gateway正确的路由规则测试"><a href="#3-3-2-Gateway正确的路由规则测试" class="headerlink" title="3.3.2 Gateway正确的路由规则测试"></a>3.3.2 Gateway正确的路由规则测试</h4><p>访问正确的<a href="http://localhost:9000/SC-CONSUMER/hello/xujin，可以成功访问。" target="_blank" rel="external">http://localhost:9000/SC-CONSUMER/hello/xujin，可以成功访问。</a></p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/42059405c29359bcca90c14e3e1f34ca.jpeg?Expires=1842311310&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=eEHIkLTtbPzvhXI2OhoK0TUXwtE%3D" alt=""></p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/ff700908c44140ec692956f4f1b526cc.jpeg?Expires=1842311231&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=ZPi13%2BGvvb2eEIHEqRIkzL3mwKw%3D" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">2018-05-22 09:04:21.204 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying &#123;pattern=/SC-CONSUMER/**&#125; to Path</div><div class="line">2018-05-22 09:04:21.205 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying filter &#123;regexp=/SC-CONSUMER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</div><div class="line">2018-05-22 09:04:21.205 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-CONSUMER</div><div class="line">2018-05-22 09:04:21.206 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying &#123;pattern=/SC-PRODUCER/**&#125; to Path</div><div class="line">2018-05-22 09:04:21.207 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying filter &#123;regexp=/SC-PRODUCER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</div><div class="line">2018-05-22 09:04:21.207 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-PRODUCER</div><div class="line">2018-05-22 09:04:21.208 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying &#123;pattern=/SC-GATEWAY-SERVER/**&#125; to Path</div><div class="line">2018-05-22 09:04:21.208 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying filter &#123;regexp=/SC-GATEWAY-SERVER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</div><div class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-GATEWAY-SERVER</div><div class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</div><div class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id=&apos;CompositeDiscoveryClient_SC-CONSUMER&apos;, uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$706/57023854@24f1a91e, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$708/2036079541@cbb7393, order=1&#125;]&#125;</div><div class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@29a98d9f&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$708/2036079541@cbb7393, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@544e8149&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@55d58825&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2da3b078&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@1a96d94c&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@19a64eae&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@7fb66650&#125;, order=2147483647&#125;]</div></pre></td></tr></table></figure>
<p>可以看出，Spring Cloud Gateway 自动的为我们的 consumer 创建了一个路由，类似于下边这样<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attr">routes:</span></div><div class="line"><span class="attr">    - id:</span> CompositeDiscoveryClient_SC-CONSUMER</div><div class="line"><span class="attr">      uri:</span> lb://SC-CONSUMER</div><div class="line"><span class="attr">      order:</span> <span class="number">0</span></div><div class="line"><span class="attr">      predicates:</span></div><div class="line"><span class="bullet">          -</span> Path=/SC-CONSUMER/**</div><div class="line"><span class="attr">      filters:</span></div><div class="line"><span class="bullet">          -</span> RewritePath=/SC-CONSUMER/(?&lt;segment&gt;.*), /$\&#123;segment&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>所以从zuul迁移到gateway的时候，服务路由规则中的微服务应用Id默认从小写变为大写。</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本篇文章主要介绍了Spring Cloud Gateway的基于服务发现的默认路由规则，从中可以看出Gateway的路由规则:&lt;a href=&quot;http://Gateway_HOST:Gateway_PORT/大写的serviceId/*&quot;&gt;http://Gateway_HOST:Gateway_PORT/大写的serviceId/*&lt;/a&gt; 和 zuul的默认路由规则&lt;a href=&quot;http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/*差不多。&quot;&gt;http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/*差不多。&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>公益Eureka Server与定制方法</title>
    <link href="http://xujin.org/sc/sc-diy-eureka/"/>
    <id>http://xujin.org/sc/sc-diy-eureka/</id>
    <published>2018-05-14T06:00:00.000Z</published>
    <updated>2019-03-07T06:04:27.778Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>: 本文主要简单介绍如何定制一个eureka server，并直接指出最优的定制方式。</p>
<a id="more"></a>
<h2 id="1-Spring-Cloud中国公益Eureka-Server"><a href="#1-Spring-Cloud中国公益Eureka-Server" class="headerlink" title="1. Spring Cloud中国公益Eureka Server"></a>1. Spring Cloud中国公益Eureka Server</h2><p>Eureka Server为作为Spring Cloud开发过程中常用的注册中心组件，作为基础设施组件，开发学习过程中，经常需要自己创建Eureka Server应用和重启。为了帮助开发者快速学习入门。Spring Cloud中国社区特搭建一个公益注册中心，仅作为帮助Spring Cloud的开发者进行学习和调试。为了更好服务大家，请勿对本注册中心进行压测。定制的Eureka Server注册中心UI如下所示。</p>
<p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/1966ed6f184d06c2ab793dcaf2c41c8b.jpeg?Expires=1841654009&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=OeNSoXly3WYi9wfNq3guMPq%2Bt48%3D" alt=""></p>
<h3 id="1-1-访问地址"><a href="#1-1-访问地址" class="headerlink" title="1.1 访问地址"></a>1.1 访问地址</h3><p> <a href="http://eureka.springcloud.cn" title="http://eureka.springcloud.cn" target="_blank" rel="external">http://eureka.springcloud.cn</a></p>
<h2 id="2-定制Eureka-Serrver的UI"><a href="#2-定制Eureka-Serrver的UI" class="headerlink" title="2.定制Eureka Serrver的UI"></a>2.定制Eureka Serrver的UI</h2><h3 id="2-1-为什么要定制Eureka-Server"><a href="#2-1-为什么要定制Eureka-Server" class="headerlink" title="2.1 为什么要定制Eureka Server"></a>2.1 为什么要定制Eureka Server</h3><p> 原因两点:</p>
<ul>
<li>1.觉得默认的UI比较丑  </li>
<li>2.Eureka Server想客制化一下</li>
</ul>
<blockquote>
<p>至于Spring Cloud Eureka的UI客制化成什么样子由你而定！</p>
</blockquote>
<h2 id="3-两种方法定制Eureka-Server"><a href="#3-两种方法定制Eureka-Server" class="headerlink" title="3. 两种方法定制Eureka Server"></a>3. 两种方法定制Eureka Server</h2><h3 id="3-1-直接修改eureka-server的源代码"><a href="#3-1-直接修改eureka-server的源代码" class="headerlink" title="3.1 直接修改eureka server的源代码"></a>3.1 直接修改eureka server的源代码</h3><p>   直接修改eureka server的源代码，该方法是最纯的方式，而且每次有一个Eureka Server的版本都需要去修改。</p>
<h3 id="3-2-只修改Eureka-Server的UI"><a href="#3-2-只修改Eureka-Server的UI" class="headerlink" title="3.2 只修改Eureka Server的UI"></a>3.2 只修改Eureka Server的UI</h3><p>只需要修改对应的html+css+文案即可，完全不用去修改Eureka Server的源码,强烈推荐。</p>
<blockquote>
<p>源码参考地址:<a href="https://github.com/SpringCloud/spring-cloud-eureka" target="_blank" rel="external">https://github.com/SpringCloud/spring-cloud-eureka</a></p>
</blockquote>
<h3 id="3-3-为什么我定制自己的UI加进去"><a href="#3-3-为什么我定制自己的UI加进去" class="headerlink" title="3.3 为什么我定制自己的UI加进去"></a>3.3 为什么我定制自己的UI加进去</h3><p> 为什么我定制自己的UI加进去，就可以直接Run，那源码代码中的UI是不是被覆盖了？<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.eureka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-server-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>如上maven配置所示，官方的spring-cloud-starter-netflix-eureka-server依赖信息配置在下面，由maven的依赖加载顺序决定，定制的UI优先加载显示。</p>
</blockquote>
<h2 id="4-如何在项目中使用DIY的Eureka-Server"><a href="#4-如何在项目中使用DIY的Eureka-Server" class="headerlink" title="4. 如何在项目中使用DIY的Eureka Server"></a>4. 如何在项目中使用DIY的Eureka Server</h2><p>只需要配置maven依赖即可:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.eureka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-server-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;: 本文主要简单介绍如何定制一个eureka server，并直接指出最优的定制方式。&lt;/p&gt;
    
    </summary>
    
      <category term="Eureka Server" scheme="http://xujin.org/categories/Eureka-Server/"/>
    
    
      <category term="Eureka Server" scheme="http://xujin.org/tags/Eureka-Server/"/>
    
  </entry>
  
  <entry>
    <title>DinCos中间件生态圈</title>
    <link href="http://xujin.org/dincos/gs/"/>
    <id>http://xujin.org/dincos/gs/</id>
    <published>2018-04-21T06:00:00.000Z</published>
    <updated>2018-11-03T04:59:09.440Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-什么是DinCos？"><a href="#1-什么是DinCos？" class="headerlink" title="1. 什么是DinCos？"></a>1. 什么是DinCos？</h2><p> DinCos 是<strong>Di</strong>stributed <strong>N</strong>aming <strong>Co</strong>nfiguration <strong>S</strong>ervice 首字母简称，主要关注的领域是</p>
<ul>
<li><p>命名服务（Naming Service）<br><code>命名服务</code>:提供分布式系统中所有对象，实体的名字到关联元数据之间的映射管理服务，最典型的场景就是服务治理中间件中的服务注册与发现。</p>
</li>
<li><p>配置服务 (Configuration Service)<br><code>配置服务</code> 关注现在应用架构中所有服务的配置中心化，外部化以及动态化的统一配置管理方式，比如配置中心中间件。</p>
</li>
</ul>
<h2 id="2-DinCos中间件"><a href="#2-DinCos中间件" class="headerlink" title="2. DinCos中间件"></a>2. DinCos中间件</h2><p>主站: <a href="http://dincos.com/" target="_blank" rel="external">http://dincos.com/</a><br>Github: <a href="https://github.com/dincos" target="_blank" rel="external">https://github.com/dincos</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-什么是DinCos？&quot;&gt;&lt;a href=&quot;#1-什么是DinCos？&quot; class=&quot;headerlink&quot; title=&quot;1. 什么是DinCos？&quot;&gt;&lt;/a&gt;1. 什么是DinCos？&lt;/h2&gt;&lt;p&gt; DinCos 是&lt;strong&gt;Di&lt;/strong&gt;
    
    </summary>
    
      <category term="dincos" scheme="http://xujin.org/categories/dincos/"/>
    
    
      <category term="dincos" scheme="http://xujin.org/tags/dincos/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway的Before路由断言工厂</title>
    <link href="http://xujin.org/sc/gw/gw04/"/>
    <id>http://xujin.org/sc/gw/gw04/</id>
    <published>2018-03-28T06:00:00.000Z</published>
    <updated>2018-11-03T05:00:52.491Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:在上本篇文章Spring Cloud Gateway的After路由断言工厂介绍了Spring Cloud Gateway核心概念和After路由断言，本文简单介绍Before路由断言工厂。因为比较简单所以就<code>抛砖引玉，旨在帮助大家快速入门Spring Cloud Gateway</code>，欢迎大家<code>加我微信Software_King</code>，进入Spring Cloud中国社区微信群交流。</p>
<a id="more"></a>
<h2 id="1-Spring-Cloud-Gateway核心概念"><a href="#1-Spring-Cloud-Gateway核心概念" class="headerlink" title="1. Spring Cloud Gateway核心概念"></a>1. Spring Cloud Gateway核心概念</h2><p>   网关简单的说就是提供一个对外统一的API入口和出口，统管企业对外的所有API出口。一般来说，网关对外暴露的URL或者接口信息，我们统称之为路由信息。如果研发过网关中间件，或者使用或了解过ZUUL的，网关的核心肯定是Filter以及Filter Chain(Filter责任链)。Spring Cloud Gateway也具有路由信息和Filter。下面介绍一下Spring Cloud gateway中最重要的几个概念:</p>
<ul>
<li><code>路由(route)</code>:路由是网关最基础的部分，路由信息由一个ID、一个目的url、一组断言工厂和一组Filter组成。如果路由断言工厂为真，则说明请求的Url和配置的路由匹配。</li>
<li><code>断言(Predicate)</code>: java 8中的断言函数。Spring Cloud Gateway中的断言函数输入类型是Spring 5.0框架中的ServerWebExchange。Spring Cloud Gateway中的断言函数允许开发者去定义匹配来自于http request中的任何信息，比如请求头和参数等。</li>
<li><code>过滤器(filter)</code>:一个标准的Spring webFilter。Spring Cloud Gateway中的Filter分为两种类型的Filter，分别是Gateway Filter和Global Filter.网关 Filter实例是由Spring 框架中的网关Filter的特殊工厂构造。request在转发到目前服务之前，response在返回到调用端之前都可以被修改或者自定义。</li>
</ul>
<h2 id="2-什么是Before路由断言"><a href="#2-什么是Before路由断言" class="headerlink" title="2. 什么是Before路由断言"></a>2. 什么是Before路由断言</h2><p>  <code>Before路由断言工厂</code>带有一个<code>UTC时间格式</code>的时间参数，当请求进来的<code>当前时间在路由断言工厂之前</code>会成功匹配，否则不能成功匹配。</p>
<h2 id="3-Before路由断言工厂的案例"><a href="#3-Before路由断言工厂的案例" class="headerlink" title="3. Before路由断言工厂的案例"></a>3. Before路由断言工厂的案例</h2><h3 id="3-1-引入pom依赖"><a href="#3-1-引入pom依赖" class="headerlink" title="3.1 引入pom依赖"></a>3.1 引入pom依赖</h3><p>pom.xml依赖配置如下所示:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="3-2-application-yml文件配置"><a href="#3-2-application-yml文件配置" class="headerlink" title="3.2 application.yml文件配置:"></a>3.2 application.yml文件配置:</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8082</span></div><div class="line"></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - id:</span> before_route</div><div class="line"><span class="attr">        uri:</span> http://xujin.org</div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> Before=<span class="number">2022</span><span class="bullet">-03</span><span class="bullet">-13</span>T00:<span class="number">54</span>:<span class="number">30.877</span>+<span class="number">08</span>:<span class="number">00</span>[Asia/Shanghai]</div><div class="line"></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    org.springframework.cloud.gateway: TRACE</div><div class="line">    org.springframework.http.server.reactive: DEBUG</div><div class="line">    org.springframework.web.reactive: DEBUG</div><div class="line">    reactor.ipc.netty: DEBUG</div><div class="line"></div><div class="line">management.endpoints.web.exposure.include: <span class="string">'*'</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Spring Cloud Gateway提供两种方式去配置Before路由断言工厂，这里介绍的是yml文件的配置方式。</p>
</blockquote>
<h3 id="3-3-等价的-Bean配置"><a href="#3-3-等价的-Bean配置" class="headerlink" title="3.3 等价的@Bean配置"></a>3.3 等价的@Bean配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</div><div class="line"></div><div class="line">	ZonedDateTime datetime = LocalDateTime.now().plusDays(<span class="number">1</span>).atZone(ZoneId.systemDefault());</div><div class="line"></div><div class="line">	<span class="comment">//@formatter:off</span></div><div class="line">	<span class="keyword">return</span> builder.routes()</div><div class="line">				.route(<span class="string">"before_route"</span>, r -&gt; r.before(datetime)</div><div class="line">						.uri(<span class="string">"http://xujin.org"</span>))</div><div class="line"></div><div class="line">				.build();</div><div class="line">	<span class="comment">//@formatter:on</span></div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Spring Cloud Gateway提供两种方式去配置After路由断言工厂，这里介绍的是@Bean的配置方式。不管通过<code>yml文件配置或者通过@Bean</code>的方式配置是等价的。</p>
</blockquote>
<h3 id="3-4-测试如下"><a href="#3-4-测试如下" class="headerlink" title="3.4 测试如下:"></a>3.4 测试如下:</h3><p>访问<a href="http://localhost:8082/" target="_blank" rel="external">http://localhost:8082/</a> 成功转发到<a href="http://xujin.org。" target="_blank" rel="external">http://xujin.org。</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:在上本篇文章Spring Cloud Gateway的After路由断言工厂介绍了Spring Cloud Gateway核心概念和After路由断言，本文简单介绍Before路由断言工厂。因为比较简单所以就&lt;code&gt;抛砖引玉，旨在帮助大家快速入门Spring Cloud Gateway&lt;/code&gt;，欢迎大家&lt;code&gt;加我微信Software_King&lt;/code&gt;，进入Spring Cloud中国社区微信群交流。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway的After路由断言工厂</title>
    <link href="http://xujin.org/sc/gw/gw03/"/>
    <id>http://xujin.org/sc/gw/gw03/</id>
    <published>2018-03-25T06:00:00.000Z</published>
    <updated>2018-11-03T05:00:48.321Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本篇文章主要介绍了Spring Cloud Gateway核心概念和After路由断言，因为比较简单所以就<code>抛砖引玉，旨在帮助大家快速入门Spring Cloud Gateway</code>，欢迎大家<code>加我微信Software_King</code>，进入Spring Cloud中国社区微信群交流。<br><a id="more"></a></p>
<h2 id="1-Spring-Cloud-Gateway核心概念"><a href="#1-Spring-Cloud-Gateway核心概念" class="headerlink" title="1.Spring Cloud Gateway核心概念"></a>1.Spring Cloud Gateway核心概念</h2><p>   网关简单的说就是提供一个对外统一的API入口和出口，统管企业对外的所有API出口。一般来说，网关对外暴露的URL或者接口信息，我们统称之为路由信息。如果研发过网关中间件，或者使用或了解过ZUUL的，网关的核心肯定是Filter以及Filter Chain(Filter责任链)。Spring Cloud Gateway也具有路由信息和Filter。下面介绍一下Spring Cloud gateway中最重要的几个概念:</p>
<ul>
<li><code>路由(route)</code>:路由是网关最基础的部分，路由信息由一个ID、一个目的url、一组断言工厂和一组Filter组成。如果路由断言工厂为真，则说明请求的Url和配置的路由匹配。</li>
<li><code>断言(Predicate)</code>: java 8中的断言函数。Spring Cloud Gateway中的断言函数输入类型是Spring 5.0框架中的ServerWebExchange。Spring Cloud Gateway中的断言函数允许开发者去定义匹配来自于http request中的任何信息，比如请求头和参数等。</li>
<li><code>过滤器(filter)</code>:一个标准的Spring webFilter。Spring Cloud Gateway中的Filter分为两种类型的Filter，分别是Gateway Filter和Global Filter.网关 Filter实例是由Spring 框架中的网关Filter的特殊工厂构造。request在转发到目前服务之前，response在返回到调用端之前都可以被修改或者自定义。</li>
</ul>
<h2 id="2-什么是After路由断言"><a href="#2-什么是After路由断言" class="headerlink" title="2.什么是After路由断言"></a>2.什么是After路由断言</h2><p>   After Route Predicate Factory带有一个UTC时间格式的时间参数，当请求进来的当前时间在路由断言工厂之后会成功匹配，否则不能成功匹配。</p>
<h2 id="3-After路由断言工厂的案例"><a href="#3-After路由断言工厂的案例" class="headerlink" title="3.After路由断言工厂的案例"></a>3.After路由断言工厂的案例</h2><h3 id="3-1-引入pom依赖"><a href="#3-1-引入pom依赖" class="headerlink" title="3.1 引入pom依赖"></a>3.1 引入pom依赖</h3><p>pom.xml依赖配置如下所示:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="3-2-application-yml文件配置"><a href="#3-2-application-yml文件配置" class="headerlink" title="3.2  application.yml文件配置:"></a>3.2  application.yml文件配置:</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8081</span></div><div class="line"></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - id:</span> after_route</div><div class="line"><span class="attr">        uri:</span> http://xujin.org</div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> After=<span class="number">2018</span><span class="bullet">-03</span><span class="bullet">-18</span>T17:<span class="number">32</span>:<span class="number">58.129</span>+<span class="number">08</span>:<span class="number">00</span>[Asia/Shanghai]</div><div class="line"></div><div class="line"></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    org.springframework.cloud.gateway: TRACE</div><div class="line">    org.springframework.http.server.reactive: DEBUG</div><div class="line">    org.springframework.web.reactive: DEBUG</div><div class="line">    reactor.ipc.netty: DEBUG</div><div class="line"></div><div class="line">management.endpoints.web.exposure.include: <span class="string">'*'</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Spring Cloud Gateway提供两种方式去配置After路由断言工厂，这里介绍的是yml文件的配置方式。</p>
</blockquote>
<h3 id="3-3-等价的-Bean配置"><a href="#3-3-等价的-Bean配置" class="headerlink" title="3.3 等价的@Bean配置"></a>3.3 等价的@Bean配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</div><div class="line">		ZonedDateTime minusTime = LocalDateTime.now().minusDays(<span class="number">1</span>).atZone(ZoneId.systemDefault());</div><div class="line">		<span class="keyword">return</span> builder.routes()</div><div class="line">				.route(<span class="string">"after_route"</span>, r -&gt; r.after(minusTime)</div><div class="line">						.uri(<span class="string">"http://xujin.org"</span>))</div><div class="line"></div><div class="line">				.build();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Spring Cloud Gateway提供两种方式去配置After路由断言工厂，这里介绍的是@Bean的配置方式。不管通过yml文件配置或者通过@Bean的方式配置是等价的。</p>
</blockquote>
<h3 id="3-4-测试如下"><a href="#3-4-测试如下" class="headerlink" title="3.4 测试如下:"></a>3.4 测试如下:</h3><p>访问<a href="http://localhost:8081/成功转发到http://xujin.org" target="_blank" rel="external">http://localhost:8081/成功转发到http://xujin.org</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本篇文章主要介绍了Spring Cloud Gateway核心概念和After路由断言，因为比较简单所以就&lt;code&gt;抛砖引玉，旨在帮助大家快速入门Spring Cloud Gateway&lt;/code&gt;，欢迎大家&lt;code&gt;加我微信Software_King&lt;/code&gt;，进入Spring Cloud中国社区微信群交流。&lt;br&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway揭秘之处理请求流程</title>
    <link href="http://xujin.org/sc/gw/gw02/"/>
    <id>http://xujin.org/sc/gw/gw02/</id>
    <published>2018-03-17T06:00:00.000Z</published>
    <updated>2018-11-03T05:00:43.731Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本篇文章主要从源码的角度揭秘Spring Cloud Gateway的怎么处理请求流程。</p>
<a id="more"></a>
<h2 id="1-Spring-Gateway概述"><a href="#1-Spring-Gateway概述" class="headerlink" title="1.Spring Gateway概述"></a>1.Spring Gateway概述</h2><p>   <code>Spring Cloud Gateway</code>是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代Netflix ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。</p>
<h2 id="2-Spring-Cloud-gateway请求入口分析"><a href="#2-Spring-Cloud-gateway请求入口分析" class="headerlink" title="2. Spring Cloud gateway请求入口分析"></a>2. Spring Cloud gateway请求入口分析</h2><p>  不管是Zuul，还是Spring Cloud Gateway还是基于Netty的自研网关，都会把请求进来的Request，或者返回的Response进行包装，转换提取为网关运行的上下文信息，而在Spring Cloud gateway中网关的上下文为ServerWebExchange。</p>
<h3 id="2-1-入口HttpServerRequest和HttpServerResponse转换"><a href="#2-1-入口HttpServerRequest和HttpServerResponse转换" class="headerlink" title="2.1 入口HttpServerRequest和HttpServerResponse转换"></a>2.1 入口HttpServerRequest和HttpServerResponse转换</h3><p>Spring Cloud Gateway的请求入口，org.springframework.http.server.reactive.ReactorHttpHandlerAdapter#apply方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">apply</span><span class="params">(HttpServerRequest request, HttpServerResponse response)</span> </span>&#123;</div><div class="line"></div><div class="line">		NettyDataBufferFactory bufferFactory = <span class="keyword">new</span> NettyDataBufferFactory(response.alloc());</div><div class="line">		ServerHttpRequest adaptedRequest;</div><div class="line">		ServerHttpResponse adaptedResponse;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			adaptedRequest = <span class="keyword">new</span> ReactorServerHttpRequest(request, bufferFactory);</div><div class="line">			adaptedResponse = <span class="keyword">new</span> ReactorServerHttpResponse(response, bufferFactory);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (URISyntaxException ex) &#123;</div><div class="line">			logger.error(<span class="string">"Invalid URL "</span> + ex.getMessage(), ex);</div><div class="line">			response.status(HttpResponseStatus.BAD_REQUEST);</div><div class="line">			<span class="keyword">return</span> Mono.empty();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (adaptedRequest.getMethod() == HttpMethod.HEAD) &#123;</div><div class="line">			adaptedResponse = <span class="keyword">new</span> HttpHeadResponseDecorator(adaptedResponse);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.httpHandler.handle(adaptedRequest, adaptedResponse)</div><div class="line">				.doOnError(ex -&gt; logger.error(<span class="string">"Handling completed with error"</span>, ex))</div><div class="line">				.doOnSuccess(aVoid -&gt; logger.debug(<span class="string">"Handling completed with success"</span>));</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>PS，代码来源于spring-web-5.0.4.RELEASE.jar<br>此方法为Spring Cloud Gateway的请求入口方法，该方法的作用就是把接收到的HttpServerRequest或者最终需要返回的HttpServerResponse，包装转换为ReactorServerHttpRequest和ReactorServerHttpResponse。</p>
</blockquote>
<h3 id="2-2-构造Spring-Cloud-gateway的上下文ServerWebExchange"><a href="#2-2-构造Spring-Cloud-gateway的上下文ServerWebExchange" class="headerlink" title="2.2 构造Spring Cloud gateway的上下文ServerWebExchange"></a>2.2 构造Spring Cloud gateway的上下文ServerWebExchange</h3><p>在org.springframework.web.server.adapter.HttpWebHandlerAdapter的182行，代码如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response)</span> </span>&#123;</div><div class="line">		ServerWebExchange exchange = createExchange(request, response);</div><div class="line">		<span class="keyword">return</span> getDelegate().handle(exchange)</div><div class="line">				.onErrorResume(ex -&gt; handleFailure(request, response, ex))</div><div class="line">				.then(Mono.defer(response::setComplete));</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>createExchange()将ServerHttpRequest ServerHttpResponse构建网关上下文ServerWebExchange。</p>
</blockquote>
<hr>
<blockquote>
<p>PS:其中org.springframework.web.server.handler.WebHandlerDecorator.getDelegate()通过委托的方式获取一系列需要处理的WebHandler.</p>
</blockquote>
<h3 id="2-3-进入Filter链"><a href="#2-3-进入Filter链" class="headerlink" title="2.3 进入Filter链"></a>2.3 进入Filter链</h3><p>org.springframework.cloud.gateway.handler.FilteringWebHandler#handle方法，即77行，代码如下所示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">    Route route = exchange.getRequiredAttribute(GATEWAY_ROUTE_ATTR);</div><div class="line">    List&lt;GatewayFilter&gt; gatewayFilters = route.getFilters();</div><div class="line"></div><div class="line">    List&lt;GatewayFilter&gt; combined = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.globalFilters);</div><div class="line">    combined.addAll(gatewayFilters);</div><div class="line">    <span class="comment">//<span class="doctag">TODO:</span> needed or cached?</span></div><div class="line">    AnnotationAwareOrderComparator.sort(combined);</div><div class="line"></div><div class="line">    logger.debug(<span class="string">"Sorted gatewayFilterFactories: "</span>+ combined);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultGatewayFilterChain(combined).filter(exchange);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-4-执行Filter链"><a href="#2-4-执行Filter链" class="headerlink" title="2.4 执行Filter链"></a>2.4 执行Filter链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultGatewayFilterChain</span> <span class="keyword">implements</span> <span class="title">GatewayFilterChain</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">int</span> index;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; filters;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">DefaultGatewayFilterChain</span><span class="params">(List&lt;GatewayFilter&gt; filters)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.filters = filters;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.index &lt; filters.size()) &#123;</div><div class="line">				GatewayFilter filter = filters.get(<span class="keyword">this</span>.index++);</div><div class="line">				<span class="keyword">return</span> filter.filter(exchange, <span class="keyword">this</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">return</span> Mono.empty(); <span class="comment">// complete</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h3 id="2-5-Gateway-Filter委托为Gloable-Filter执行"><a href="#2-5-Gateway-Filter委托为Gloable-Filter执行" class="headerlink" title="2.5 Gateway Filter委托为Gloable Filter执行"></a>2.5 Gateway Filter委托为Gloable Filter执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterAdapter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> GlobalFilter delegate;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">GatewayFilterAdapter</span><span class="params">(GlobalFilter delegate)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.delegate = delegate;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.delegate.filter(exchange, chain);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"GatewayFilterAdapter&#123;"</span>);</div><div class="line">			sb.append(<span class="string">"delegate="</span>).append(delegate);</div><div class="line">			sb.append(<span class="string">'&#125;'</span>);</div><div class="line">			<span class="keyword">return</span> sb.toString();</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h3 id="2-6-预告待续"><a href="#2-6-预告待续" class="headerlink" title="2.6 预告待续"></a>2.6 预告待续</h3><p>在之后的文章中，将会揭秘Spring Cloud Gateway的架构设计，Filter链设计，以及启动装在流程等。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本篇文章主要从源码的角度揭秘Spring Cloud Gateway的怎么处理请求流程。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud 源码分析" scheme="http://xujin.org/tags/Spring-Cloud-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway入门案例</title>
    <link href="http://xujin.org/sc/gw/gw-01/"/>
    <id>http://xujin.org/sc/gw/gw-01/</id>
    <published>2018-03-15T06:00:00.000Z</published>
    <updated>2018-11-03T05:00:39.748Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本篇文章主要介绍了什么是<code>Spring Cloud Gateway</code>，并基于Spring Cloud Gateway的Finchley.M8版本编写一个Spring Cloud Gateway的入门案例，即基本代理的路由转发配置。</p>
<a id="more"></a>
<h2 id="1-Spring-Gateway概述"><a href="#1-Spring-Gateway概述" class="headerlink" title="1.Spring Gateway概述"></a>1.Spring Gateway概述</h2><h3 id="1-1-什么是Spring-Cloud-Gateway"><a href="#1-1-什么是Spring-Cloud-Gateway" class="headerlink" title="1.1 什么是Spring Cloud Gateway"></a>1.1 什么是Spring Cloud Gateway</h3><p>   <code>Spring Cloud Gateway</code>是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代Netflix ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。</p>
<h2 id="2-Spring-Cloud-Gateway入门案例"><a href="#2-Spring-Cloud-Gateway入门案例" class="headerlink" title="2. Spring Cloud Gateway入门案例"></a>2. Spring Cloud Gateway入门案例</h2><h3 id="2-1-创建maven工程"><a href="#2-1-创建maven工程" class="headerlink" title="2.1 创建maven工程"></a>2.1 创建maven工程</h3><p>配置Spring  Cloud Gateway的相关Maven依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ch18-1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.book<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ch18-1-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>ch18-1-gateway<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://springcloud.cn<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M8<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="2-2-Spring-Cloud-Gateway主程序"><a href="#2-2-Spring-Cloud-Gateway主程序" class="headerlink" title="2.2  Spring Cloud Gateway主程序"></a>2.2  Spring Cloud Gateway主程序</h3><p>SpringCloudGatewayApplication.java，代码如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.springcloud.book.gateway;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</div><div class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</div><div class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudGatewayApplication</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Bean</span></div><div class="line">	<span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> builder.routes()</div><div class="line">				<span class="comment">//basic proxy</span></div><div class="line">				.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</div><div class="line">						.uri(<span class="string">"http://baidu.com:80/"</span>)</div><div class="line">				).build();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		SpringApplication.run(SpringCloudGatewayApplication.class, args);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-3-编写application-yml文件"><a href="#2-3-编写application-yml文件" class="headerlink" title="2.3 编写application.yml文件"></a>2.3 编写application.yml文件</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8080</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> spring-cloud-gateway</div><div class="line"></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - id:</span> xujin_route</div><div class="line"><span class="attr">        uri:</span> http://www.xujin.org:<span class="number">80</span>/</div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> Path=/xujin</div><div class="line"></div><div class="line"><span class="attr">logging:</span></div><div class="line"><span class="attr">  level:</span></div><div class="line">    org.springframework.cloud.gateway: TRACE</div><div class="line">    org.springframework.http.server.reactive: DEBUG</div><div class="line">    org.springframework.web.reactive: DEBUG</div><div class="line">    reactor.ipc.netty: DEBUG</div></pre></td></tr></table></figure>
<h3 id="2-4-基本代理路由配置等同写法"><a href="#2-4-基本代理路由配置等同写法" class="headerlink" title="2.4 基本代理路由配置等同写法"></a>2.4 基本代理路由配置等同写法</h3><p>Spring Cloud Gateway提供了两种配置路由规则的方法</p>
<ul>
<li>第一:通过@Bean自定义RouteLocator<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> builder.routes()</div><div class="line">			<span class="comment">//basic proxy</span></div><div class="line">			.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</div><div class="line">			.uri(<span class="string">"http://baidu.com:80/"</span>)</div><div class="line">			).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<ul>
<li>第二:通过属于文件或者yml文件配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - id:</span> xujin_route</div><div class="line"><span class="attr">        uri:</span> http://www.xujin.org:<span class="number">80</span>/</div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> Path=/xujin</div></pre></td></tr></table></figure>
<blockquote>
<p>PS,以上两种方式等同。</p>
</blockquote>
<h3 id="2-5-错误的示范代码如下"><a href="#2-5-错误的示范代码如下" class="headerlink" title="2.5 错误的示范代码如下:"></a>2.5 错误的示范代码如下:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">routingConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Routes.locator()</div><div class="line">      .route(<span class="string">"xujin_route"</span>)</div><div class="line">      .uri(<span class="string">"http://xujin.org"</span>)</div><div class="line">      .predicate(host(<span class="string">"**.xujin.org"</span>))</div><div class="line">      .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>温馨提示，上面这种写法是基于Spring Cloud Gateway FM4的版本，相关代码已废弃，目前Spring Cloud Gateway将会在FM9之后Realese。</p>
</blockquote>
<h3 id="2-6-运行测试"><a href="#2-6-运行测试" class="headerlink" title="2.6 运行测试"></a>2.6 运行测试</h3><ol>
<li>访问<a href="http://localhost:8080/baidu" target="_blank" rel="external">http://localhost:8080/baidu</a>,路由转发到<a href="http://www.baidu.com" target="_blank" rel="external">http://www.baidu.com</a></li>
<li>访问<a href="http://localhost:8080/xujin" target="_blank" rel="external">http://localhost:8080/xujin</a>,路由转发到<a href="http://xujin.org">http://xujin.orgyml
</a></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line">	<span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> builder.routes()</div><div class="line">				<span class="comment">//basic proxy</span></div><div class="line">				.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</div><div class="line">						.uri(<span class="string">"http://baidu.com:80/"</span>)</div><div class="line">				).build();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    gateway:</span></div><div class="line"><span class="attr">      routes:</span></div><div class="line"><span class="attr">      - id:</span> xujin_route</div><div class="line"><span class="attr">        uri:</span> http://www.xujin.org:<span class="number">80</span>/</div><div class="line"><span class="attr">        predicates:</span></div><div class="line"><span class="bullet">        -</span> Path=/xujin</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本篇文章主要介绍了什么是&lt;code&gt;Spring Cloud Gateway&lt;/code&gt;，并基于Spring Cloud Gateway的Finchley.M8版本编写一个Spring Cloud Gateway的入门案例，即基本代理的路由转发配置。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/categories/Spring-Cloud-Gateway/"/>
    
    
      <category term="Spring Cloud 源码分析" scheme="http://xujin.org/tags/Spring-Cloud-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
      <category term="Spring Cloud Gateway" scheme="http://xujin.org/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Mysql批量执行更新shell脚本</title>
    <link href="http://xujin.org/ex/mysql-batch-update/"/>
    <id>http://xujin.org/ex/mysql-batch-update/</id>
    <published>2018-02-17T06:00:00.000Z</published>
    <updated>2018-02-17T02:45:15.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:在生产上执行更新sql，当更新的数据超过上100万的时候，执行更新操作会造成卡表或者锁表。本文主要记录一个了批量更新Mysql某张表的数据的脚本代码片。</p>
<a id="more"></a>
<h3 id="mysql的批量执行更新"><a href="#mysql的批量执行更新" class="headerlink" title="mysql的批量执行更新"></a>mysql的批量执行更新</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">. ~/.bash_profile</div><div class="line"></div><div class="line">log=/home/apps/update/update_log_1_$(date +%F).log</div><div class="line">vstart=1</div><div class="line">step=10000</div><div class="line">vstop=$(($&#123;vstart&#125;+$&#123;step&#125;))</div><div class="line">max=14800000</div><div class="line"></div><div class="line">echo &quot;stop value is $vstop&quot;</div><div class="line"></div><div class="line">while [ $&#123;vstart&#125; -lt $(($&#123;max&#125;+1)) ] </div><div class="line">do</div><div class="line">        echo &quot;`date +%F-%T`; mysql -uusername -ppwd --default-character-set=utf8 -S /tmp/mysql3306.sock vip_dbname -e\&quot;UPDATE tbname set limit_days=3, update_time=now() where pid between $&#123;vstart&#125;  and $&#123;vstop&#125;\&quot;&quot; &gt;&gt; $&#123;log&#125;</div><div class="line">        /apps/svr/mysql5/bin/mysql -uusername -ppwd --default-character-set=utf8 -S /tmp/mysql3306.sock vip_dbname -e&quot;UPDATE  tbname set limit_days=3, update_time=now() where pid between $&#123;vstart&#125;  and $&#123;vstop&#125; &quot;</div><div class="line"></div><div class="line">        vstart=$(($&#123;vstop&#125;+1))</div><div class="line">        vstop=$(($&#123;vstop&#125;+$&#123;step&#125;))</div><div class="line"></div><div class="line">        if [ $&#123;vstop&#125; -gt $&#123;max&#125; ]; then</div><div class="line">                vstop=$&#123;max&#125;</div><div class="line">        fi</div><div class="line"></div><div class="line">        sleep 1</div><div class="line">        #echo &quot;start at $&#123;vstart&#125;, stop at $&#123;vstop&#125;&quot;</div><div class="line">done</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:在生产上执行更新sql，当更新的数据超过上100万的时候，执行更新操作会造成卡表或者锁表。本文主要记录一个了批量更新Mysql某张表的数据的脚本代码片。&lt;/p&gt;
    
    </summary>
    
      <category term="项目经验" scheme="http://xujin.org/categories/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="项目经验" scheme="http://xujin.org/tags/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C/"/>
    
      <category term="mysql" scheme="http://xujin.org/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud中基于Sleuth的参数透传功能探索</title>
    <link href="http://xujin.org/sc/sq/sc-gfb/"/>
    <id>http://xujin.org/sc/sq/sc-gfb/</id>
    <published>2018-01-16T06:00:00.000Z</published>
    <updated>2018-01-30T16:02:40.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>:本文由<code>郭芳碧</code>投稿分享。投<code>稿请加微信Software_King</code>,本篇文章主要介绍Spring Cloud中基于Sleuth的参数透传功能探索的经历和相关解决方案。</p>
<a id="more"></a>
<h2 id="一-需求"><a href="#一-需求" class="headerlink" title="一.需求"></a>一.需求</h2><p>微服务环境，有A，B，C，D四个服务，调用关系为：A-&gt;B-&gt;C-&gt;D。用户在A的页面选择当前“语言”环境为“英文”,在某些业务场景下，其它几个服务需获取到这个“语言”信息。</p>
<h2 id="二-分析"><a href="#二-分析" class="headerlink" title="二.分析"></a>二.分析</h2><p>这个需求还是很简单的，类似于“击鼓传花”：当前服务从上一个服务中获取参数，并传给下一个服务。个人感觉基本上所有的RPC框架都会遇到这个问题，只是以前SOA架构下，服务层级比较少，将“语言”、“登陆”等附加信息放在参数列表中并不会带来太多工作量，所以这个问题并不是太突出。而引入了微服务架构思想后，服务调用层级急剧增长，这就需要一个更加优雅的方式来解决附加信息的传递问题。</p>
<h2 id="三-方案探索"><a href="#三-方案探索" class="headerlink" title="三.方案探索"></a>三.方案探索</h2><h3 id="3-1-方案一：参数放在接口参数列表中"><a href="#3-1-方案一：参数放在接口参数列表中" class="headerlink" title="3.1 方案一：参数放在接口参数列表中"></a>3.1 方案一：参数放在接口参数列表中</h3><p><strong>优点</strong>：思路简单，开发没有学习成本</p>
<p><strong>缺点</strong>：</p>
<ul>
<li>代码高度耦合：附加信息却要每个接口都显式维护</li>
<li>升级困难：如果将来再加一个参数，所有层级的接都要改动</li>
<li>引起迷惑：如果B服务的逻辑不需要“语言“参数，但是因为D需要，它也必须维护</li>
<li>太傻了，Big不够</li>
</ul>
<blockquote>
<p>思考：微服务之间绝大多数情况是通过HTTP调用的，HTTP的header中也可以放参数信息。这样，接口参数中就不用维护这些附加信了。</p>
</blockquote>
<hr>
<h3 id="3-2-方案二：参数放在httpRequest的header中"><a href="#3-2-方案二：参数放在httpRequest的header中" class="headerlink" title="3.2 方案二：参数放在httpRequest的header中"></a>3.2 方案二：参数放在httpRequest的header中</h3><p><strong>实现</strong>：<br> 1.自定义一个Filter，获取Request中自己需要的附加信息，<br> 2.将这些信息放入ThreadLocal中,<br> 3.实现feign.Client(这里先忽略RestTemplate)的execute()方法，将附件信息在调用下一层服务前塞入request的header中</p>
<p><strong>优点</strong>：参数解耦</p>
<p><strong>缺点</strong>：如果B在获取到附加信息后，新起了一个线程”T1“来调用服务C，这时T1就无法从HhreaLocal拿到附加信息了</p>
<blockquote>
<p>思考：</p>
<ol>
<li>如果我知道怎么用无侵入的方式，在当前线程”T”创建子孙线程”T1”、”T1-1”时，将数据传给后代，就能解决这个问题了</li>
<li>微服务调用链框架<a href="https://github.com/spring-cloud/spring-cloud-sleuth.git" target="_blank" rel="external">Sleuth</a>的核心功能即是跟踪一次请求从A到D的全过程，它肯定支持多线程调用下的traceId的传递。因此，我可以复用Sleuth的相关功能夹带私货</li>
</ol>
</blockquote>
<hr>
<h3 id="3-3-方案三：修改Sleuth源码，将附加信息跟着TraceId一起往后传递"><a href="#3-3-方案三：修改Sleuth源码，将附加信息跟着TraceId一起往后传递" class="headerlink" title="3.3 方案三：修改Sleuth源码，将附加信息跟着TraceId一起往后传递"></a>3.3 方案三：修改Sleuth源码，将附加信息跟着TraceId一起往后传递</h3><p><strong>优点</strong>：</p>
<ul>
<li>原理简单，不用考虑底层实现</li>
<li>不用考虑兼容性等问题，Sleuth都已经实现好</li>
<li>快(对，就是这一个字)<br><strong>缺点</strong>：</li>
<li>维护困难，很容易忘记以前修改了哪些地方，更别提移交给别人维护了</li>
<li>升级困难，以后每次Spring或者Sleuth升级，都要重新下载源码修改</li>
</ul>
<blockquote>
<p>思考：<br> 目前获取参数的问题解决了，用Filter，只剩下保存并传给下一层的问题<br> 既然Sleuth已经解决了多线程下traceId的传递问题，那我就直接用traceId来解决我的问题</p>
</blockquote>
<h3 id="3-4-方案四：充分利用traceId"><a href="#3-4-方案四：充分利用traceId" class="headerlink" title="3.4 方案四：充分利用traceId"></a>3.4 方案四：充分利用traceId</h3><p><strong>实现</strong>：</p>
<ul>
<li>自定义Filter(优先级要低于TraceFilter,因为你要获取TraceFilter里的traceId)，拿到traceId和附加信息后，将它们存在本地缓存中，traceId为key，附加信息为value</li>
<li>参考方案二的实现3。重写execute()方法，获取当前线程的traceId(这个Sleuth有接口，不再介绍)，然后再通过traceId去本地缓存中拿到附加信息，放进Request的header中</li>
</ul>
<p><strong>优点</strong>：拥有上述方案所有的优点,解决上述方案所有缺点</p>
<p><strong>缺点</strong>：看着很完美，但是你忽略了一件事：Sleuth要想传递自己的traceId，想必它已经重写了execute()方法(肯定的，那就是TraceFeignClient)，你要想用，那就要想办法在复用TraceFeignClient.execute()的同时，将自己的私货带进去</p>
<h3 id="3-5-方案五：重写TraceFeignClient"><a href="#3-5-方案五：重写TraceFeignClient" class="headerlink" title="3.5 方案五：重写TraceFeignClient"></a>3.5 方案五：重写TraceFeignClient</h3><p><strong>实现</strong>：有时候，改动源码并不需要直接在原有包里修改。比如：A-&gt;B-&gt;C-&gt;D，如果你要修改C的源码，那就将AB源码也copy出，作为A1,B1,C#，然后重写组件的入口，将组件加载顺序变为：A1-&gt;B1-&gt;C#-&gt;D，即可达到重写源码的目的。这时候注意的是，加载A1的条件必须跟加载A的相反。具体可参考我之前重写Consul的入口例子，示例代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ConditionalOnExpression</span>(<span class="string">"$&#123;spring.cloud.consul.ribbon.enabled:true&#125;==false"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRibbonConsulAutoConfiguration</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// 原有入口：</span></div><div class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"spring.cloud.consul.ribbon.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonConsulAutoConfiguration</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>综上，可以重写TraceFeigClient的入口 TraceFeignClientAutoConfiguration-&gt;TraceFeignObjectWrapper&gt;TraceFeignClient,即可达到自己的目的.</p>
</blockquote>
<p><strong>优点</strong>：感觉事儿基本就成了</p>
<p><strong>缺点</strong>：配置为false生效，使用者会觉得比较怪,Sleuth仿佛知道别人会这么干似的，它的类的访问权限基本都是default，为了copy过来的几个类能正常编译通过，你还要再copy九个它们的依赖类,程序太丑</p>
<blockquote>
<p>思考:突然想起来，还有一种改代码的方式叫字节码替换，如果我能在程序启动的时，将我的execute()直接替换掉Sleuth的execute(),就一劳永逸了</p>
</blockquote>
<h3 id="3-6-方案六：字节码替换代源码修改"><a href="#3-6-方案六：字节码替换代源码修改" class="headerlink" title="3.6 方案六：字节码替换代源码修改"></a>3.6 方案六：字节码替换代源码修改</h3><p><strong>优点</strong>：高大上,不在源码级替换，却在字节码级替换，虚虚实实</p>
<p><strong>缺点</strong>：没这么干过，总觉得说着容易做着难</p>
<blockquote>
<p>思考：基本上觉得方案五已经能解决问题了。本着精益求精的态度，去技术群里问了下，很快有<a href="https://github.com/saleson" target="_blank" rel="external">大神</a>发来<a href="https://github.com/saleson/fm-cloud.git" target="_blank" rel="external">Demo</a>,看过代码后顿觉惭愧：我一直在想怎么重写TraceFeignClient的execute()，其实这个execute()真正做http请求时，调用的是feign.Client的另外一个实现类,注意那句”this.delegate.execute”，只要想办法用自己的Client替换掉delegate即可</p>
</blockquote>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(MethodHandles.lookup().lookupClass());</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Client delegate;</div><div class="line">   <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	String spanName = getSpanName(request);</div><div class="line">	Span span = getTracer().createSpan(spanName);</div><div class="line">	<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">		log.debug(<span class="string">"Created new Feign span "</span> + span);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		AtomicReference&lt;Request&gt; feignRequest = <span class="keyword">new</span> AtomicReference&lt;&gt;(request);</div><div class="line">		spanInjector().inject(span, <span class="keyword">new</span> FeignRequestTextMap(feignRequest));</div><div class="line">		span.logEvent(Span.CLIENT_SEND);</div><div class="line">		addRequestTags(request);</div><div class="line">		Request modifiedRequest = feignRequest.get();</div><div class="line">		<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">			log.debug(<span class="string">"The modified request equals "</span> + modifiedRequest);</div><div class="line">		&#125;</div><div class="line">		Response response = <span class="keyword">this</span>.delegate.execute(modifiedRequest, options);</div><div class="line">		logCr();</div><div class="line">		<span class="keyword">return</span> response;</div><div class="line">	&#125; <span class="keyword">catch</span> (RuntimeException | IOException e) &#123;</div><div class="line">		logCr();</div><div class="line">		logError(e);</div><div class="line">		<span class="keyword">throw</span> e;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		closeSpan(span);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-7-方案七：替换掉TraceFeigClient的delegate即可"><a href="#3-7-方案七：替换掉TraceFeigClient的delegate即可" class="headerlink" title="3.7 方案七：替换掉TraceFeigClient的delegate即可"></a>3.7 方案七：替换掉TraceFeigClient的delegate即可</h3><p> <strong>实现</strong>:通过<strong>再次认真</strong>Debug源码知道，TraceFeignClient默认会加载你的Client实现类作为delegate(汗！)，因此你只要直接实现feign.Client接口即可。我偷懒了一把，自己写个实现类，直接复用了LoadBalancerFeignClient.execute()<br> <strong>优点</strong>:基本什么都有了吧<br> <strong>缺点</strong>:如果你以为只是简单地重写个execute()就行，那就大错特了。因为TraceFeignClient直接用了你的方法post过去，因此你要想办法把ribbon手动集成进来。如果不觉得麻烦的话，可以好好看下TraceFeignClient怎么生成Client的实例：TraceFeignObjectWrapper.wrap(Object bean)</p>
<blockquote>
<p>思考:既然你可以在程序里获取到trace和span，那为何不将你的信息放到span里呢。如果span中能放点额外信息就好了，就不用自己写这么多东西。经<a href="https://github.com/huanglc1988" target="_blank" rel="external">大神</a>提醒，Sleuth中有个baggage可以试试</p>
</blockquote>
<h3 id="3-8-方案八：使用baggage"><a href="#3-8-方案八：使用baggage" class="headerlink" title="3.8 方案八：使用baggage"></a>3.8 方案八：使用baggage</h3><p> <strong>实现:</strong>获取参数的方式不变，取得的参数放在baggage中</p>
<p> <strong>优点:</strong>简单,支持RestTemplate调用的情况,跟其他组件兼容性好</p>
<p> <strong>缺点:</strong>Sleuth的缺点</p>
<h2 id="四-项目源码"><a href="#四-项目源码" class="headerlink" title="四.项目源码"></a>四.项目源码</h2><h3 id="4-1-基于slueth的参数透传插件"><a href="#4-1-基于slueth的参数透传插件" class="headerlink" title="4.1 基于slueth的参数透传插件"></a>4.1 基于slueth的参数透传插件</h3><p>Github地址:<a href="https://github.com/bishion/sleuth-plugin" target="_blank" rel="external">https://github.com/bishion/sleuth-plugin</a></p>
<p><strong>简介</strong>:微服务下使用,调用过程中用户信息，页面语言信息的透传<br><strong>使用方式</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">bizi:</span></div><div class="line"><span class="attr">  sleuth:</span> </div><div class="line"><span class="attr">    config:</span></div><div class="line"><span class="attr">      headers:</span> lang_info <span class="comment">#如果由多个，逗号隔开.这里配置从filter里需要获取的headerName</span></div></pre></td></tr></table></figure>
<p><strong>调用方式</strong></p>
<figure class="highlight java"><figcaption><span>first_line:22   </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionInfoService</span> </span>&#123;</div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    <span class="keyword">private</span> SessionInfoOperator sessionInfoOperator;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLangInfo</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> sessionInfoOperator.getSessionInfo(<span class="string">"lang_info"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">()</span></span>&#123;</div><div class="line">        sessionInfoOperator.setSessionInfo(<span class="string">"user_id"</span>,<span class="string">"bishion"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="五-留下的坑"><a href="#五-留下的坑" class="headerlink" title="五.留下的坑"></a>五.留下的坑</h2><ol>
<li>Sleuth通过<em>LazyTraceExecutor</em>解决多线程下的问题，但是它并没有解决<strong>给手动创建的Thread传递信息</strong>的问题</li>
<li>有机会试试java字节码替换怎么操作</li>
<li>Sleuth如何重写RestTemplate的</li>
<li>TraceFeignClient怎么生成Client的实例</li>
</ol>
<h2 id="六-后记"><a href="#六-后记" class="headerlink" title="六.后记"></a>六.后记</h2><p>因为附加信息的传递在RPC中扮演了很重要的角色，我潜意识里觉得，肯定会有更加简洁的方法或者框架我还没有了解到。希望各位各位读者老师能不吝珠玉，批评指正</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;:本文由&lt;code&gt;郭芳碧&lt;/code&gt;投稿分享。投&lt;code&gt;稿请加微信Software_King&lt;/code&gt;,本篇文章主要介绍Spring Cloud中基于Sleuth的参数透传功能探索的经历和相关解决方案。&lt;/p&gt;
    
    </summary>
    
      <category term="社区" scheme="http://xujin.org/categories/%E7%A4%BE%E5%8C%BA/"/>
    
    
      <category term="Spring Cloud" scheme="http://xujin.org/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>代码生成器的设计</title>
    <link href="http://xujin.org/mw/codegen01/"/>
    <id>http://xujin.org/mw/codegen01/</id>
    <published>2018-01-06T06:00:00.000Z</published>
    <updated>2018-01-30T16:02:40.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>摘要</strong>: 本文主要讲述什么是代码生成器和代码生成器相关的设计，以及由<code>Venus Team</code>(Spring Cloud中国社区开源组织）打造的针对Spring Cloud的代码生成器</p>
<a id="more"></a>
<h2 id="代码生成器"><a href="#代码生成器" class="headerlink" title="代码生成器"></a>代码生成器</h2><h3 id="什么是代码生成器"><a href="#什么是代码生成器" class="headerlink" title="什么是代码生成器"></a>什么是代码生成器</h3><p> 早起进行软件工程开发，用文本编辑器去开发写代码，后来为了加快开发效率，出现一系列<code>IDE（开发集成开发工具)</code>,比如Eclipse,IDEA等。创建Maven或者Gradle工程都是通过IDE去创建，但是有些重复的工作，比如单表的CRUD操作，或者重复性劳动的配置，包括Maven或者Gradle的配置。</p>
<h3 id="代码生成器现状"><a href="#代码生成器现状" class="headerlink" title="代码生成器现状"></a>代码生成器现状</h3><h2 id="代码生成器设计"><a href="#代码生成器设计" class="headerlink" title="代码生成器设计"></a>代码生成器设计</h2><p>如下图所示，代码生成器的生成的工程，由元数据+模板(工程模板或代码模板)组装而成。</p>
<ul>
<li>元数据</li>
<li>模板<br><img src="/images/mw/codegen01.png" width="650px" height="450px"></li>
</ul>
<h2 id="Smart-CodeGen"><a href="#Smart-CodeGen" class="headerlink" title="Smart CodeGen"></a>Smart CodeGen</h2>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;摘要&lt;/strong&gt;: 本文主要讲述什么是代码生成器和代码生成器相关的设计，以及由&lt;code&gt;Venus Team&lt;/code&gt;(Spring Cloud中国社区开源组织）打造的针对Spring Cloud的代码生成器&lt;/p&gt;
    
    </summary>
    
      <category term="项目经验" scheme="http://xujin.org/categories/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="项目经验" scheme="http://xujin.org/tags/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C/"/>
    
  </entry>
  
</feed>
