<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>Spring Cloud第二代</title>
      <link href="/sc/sc2/"/>
      <url>/sc/sc2/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>: 随着Eureka不再维护，Hystrix不再开发新功能，进入维护状态。以及最近中国开源出现一些大事，预测一下2019年未来Spring Cloud生态圈中的第二代组件的组合，仅<code>代表个人看法</code>。</p><h2 id="1-Spring-Cloud第一代"><a href="#1-Spring-Cloud第一代" class="headerlink" title="1. Spring Cloud第一代"></a>1. Spring Cloud第一代</h2><p>  Spring Cloud自从推出之后，给大家的感觉就是Spring Cloud做<code>它最擅长的事，也就是高度抽象和封装，强强联手整合最优东西为我所用</code>，比如Netflix开源的Eureka，Hystrix，Ribbon等。而且提供<code>多种技术选型，态度中立而选最优</code>。8天前也就是2018年11月19号左右，Netflix的开源项目Hystrix宣布状态，不再开发新功能，处于维护状态。引发朋友圈的一些思考。</p><a id="more"></a><p><img src="/images/sc/hystrix.jpg" alt=""></p><blockquote><p>虽然Eureka，Hystrix等不再继续开发或维护，但是目前来说不影响使用，不管怎么说感谢开源，向Netflix公司的开源致敬。</p></blockquote><p>  随着Spring Cloud生态圈的发展与成长，Spring Cloud陆续推出了自己的一些组件，挑选主要组件说明如下表所示:</p><table><thead><tr><th>组件</th><th>来源</th><th>说明</th></tr></thead><tbody><tr><td>Spring-cloud-openfeign</td><td>基于Feign的升级</td><td>服务之间调用的必备组件</td></tr><tr><td>spring-cloud-zuul</td><td>来源于Netflix Zuul</td><td>目前还在继续维护，但是已经有自己的Spring Cloud Gateway,不久将来逐渐淘汰</td></tr><tr><td>spring-cloud-eureka</td><td>集成于Netflix Eureka</td><td>目前还在跟随Spring Cloud版本升级维护，最终也会被替代</td></tr><tr><td>spring-cloud-config</td><td>自研</td><td>功能不足，国内使用其它配置中心替代，比如携程的Apollo</td></tr><tr><td>全链路监控(sleuth+zikpin或pinpont)</td><td>sleuth自研，其它第三方</td><td>国内目前使用最多的是skywaling等上生产</td></tr><tr><td>spring-cloud-ribbon</td><td>来源于Netflix集成</td><td>ribbon目前还在跟随Spring Cloud版本维护中，目前孵化未来替代品spring-cloud-lb</td></tr><tr><td>Spring-cloud-hystrix</td><td>来源于Netflix集成</td><td>目前还在跟随Spring Cloud版本维护中目前已经孵化spring-cloud-r4j</td></tr></tbody></table><h2 id="2-Spring-Cloud-第二代"><a href="#2-Spring-Cloud-第二代" class="headerlink" title="2. Spring Cloud 第二代"></a>2. Spring Cloud 第二代</h2><p> Spring Cloud第一代和第二代的组件组合汇总，如下表所示。</p><table><thead><tr><th></th><th>Spring Cloud第一代</th><th>Spring Cloud第二代</th></tr></thead><tbody><tr><td>网关</td><td>Spring Cloud Zuul</td><td>Spring Cloud Gateway</td></tr><tr><td>注册中心</td><td>eureka(不再更新)，Consul,ZK</td><td>阿里Nacos，拍拍贷radar等可选</td></tr><tr><td>配置中心</td><td>spring cloud config</td><td>阿里Nacos，携程Apollo，随行付Config Keeper</td></tr><tr><td>客户端软负载均衡</td><td>Ribbon</td><td>spring-cloud-loadbalancer</td></tr><tr><td>熔断器</td><td>Hystrix</td><td>spring-cloud-r4j(Resilience4J)，阿里Sentinel</td></tr></tbody></table><blockquote><p>由于Zuul性能一般，zuul 2.x(一直跳票，虽最终开源）但是Spring Cloud官方已经推出Spring Cloud gateway,Spring Cloud中国社区很久之前已经证实，Spring Cloud将不会集成zuul 2.x，也就是说在不就未来Zuul将从Spring Cloud生态圈中退出。</p></blockquote><hr><blockquote><p>ribbon由于不支持webFlux的负载均衡，Spring Cloud官方很早就在孵化器项目中孵化spring-cloud-loadbalancer，目前已经将代码合并到spring-cloud-common中，预计在Spring Cloud G版可以使用，预计2018年12月底realese。</p></blockquote><hr><blockquote><p>至于Hystrix，Netflix在2018年11月19号左右，Netflix的开源项目Hystrix宣布状态，不再开发新功能，处于维护状态，其实在之前Spring Cloud官方就在孵化spring-cloud-r4j.</p></blockquote><h2 id="3-开源项目的链接"><a href="#3-开源项目的链接" class="headerlink" title="3.开源项目的链接"></a>3.开源项目的链接</h2><p>本文所提到的开源项目链接汇总如下所示：</p><p><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel</a></p><p><a href="https://github.com/spring-cloud-incubator/spring-cloud-r4j" target="_blank" rel="noopener">https://github.com/spring-cloud-incubator/spring-cloud-r4j</a></p><p><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener">阿里Nacos-https://github.com/alibaba/nacos</a></p><p><a href="https://github.com/sxfad/config-keeper" target="_blank" rel="noopener">随行付Config-keeper-https://github.com/sxfad/config-keeper</a></p><p><a href="https://github.com/spring-cloud-incubator/spring-cloud-loadbalancer" target="_blank" rel="noopener">spring-cloud-loadbalancer</a></p><p><a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo</a></p><p><a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener">https://github.com/apache/incubator-skywalking</a></p>]]></content>
      
      <categories>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用Nacos实现Spring Cloud Gateway的动态路由</title>
      <link href="/sc/gw/gw10/"/>
      <url>/sc/gw/gw10/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要介绍通过Nacos下发路由配置实现Spring Cloud Gateway的动态路由。</p><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>   网关中有两个重要的概念，那就是路由配置和路由规则，路由配置是指配置某请求路径路由到指定的目的地址。而路由规则是指匹配到路由配置之后，再根据路由规则进行转发处理。<br>   Spring Cloud Gateway作为所有请求流量的入口，在实际生产环境中为了保证高可靠和高可用，尽量避免重启,需要实现Spring Cloud Gateway动态路由配置。前面章节介绍了Spring Cloud Gateway提供的两种方法去配置路由规则，但都是在Spring Cloud Gateway启动时候，就将路由配置和规则加载到内存里，无法做到不重启网关就可以动态的对应路由的配置和规则进行增加，修改和删除。本文是基于<a href="http://xujin.org/sc/gw/gw09/">Spring Cloud Gateway的动态路由实现</a><br>基础之上编写，通过Nacos配置服务下发路由配置实现动态路由。</p><a id="more"></a><h2 id="2-Spring-Cloud-Gateway简单的动态路由实现"><a href="#2-Spring-Cloud-Gateway简单的动态路由实现" class="headerlink" title="2. Spring Cloud Gateway简单的动态路由实现"></a>2. Spring Cloud Gateway简单的动态路由实现</h2><p>Spring Cloud Gateway的官方文档并没有讲如何动态配置，查看 Spring Cloud Gateway的源码，发现<code>在org.springframework.cloud.gateway.actuate.GatewayControllerEndpoint</code>类中提供了动态配置的Rest接口，但是<code>需要开启Gateway的端点</code>，而且提供的功能不是很强大。通过参考和GatewayControllerEndpoint相关的代码，可以自己编码实际动态路由配置。<br>下面通过案例的方式去讲解怎么通Nacos实现Spring Cloud Gateway的动态路由。案例工程如spring-cloud-gateway-nacos所示。</p><blockquote><p>代码地址:<a href="https://github.com/SpringCloud/spring-cloud-gateway-nacos" target="_blank" rel="noopener">https://github.com/SpringCloud/spring-cloud-gateway-nacos</a></p></blockquote><h2 id="3-简单动态路由的实现"><a href="#3-简单动态路由的实现" class="headerlink" title="3. 简单动态路由的实现"></a>3. 简单动态路由的实现</h2><h3 id="3-1-新建Maven工程sc-gateway-server"><a href="#3-1-新建Maven工程sc-gateway-server" class="headerlink" title="3.1 新建Maven工程sc-gateway-server"></a>3.1 新建Maven工程sc-gateway-server</h3><p>  配置主要的核心依赖如代码清单所示：<br>  代码清单: spring-cloud-gateway-nacos/sc-gateway-server/pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.nacos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="3-2-根据Spring-Cloud-Gateway的路由模型定义数据传输模型"><a href="#3-2-根据Spring-Cloud-Gateway的路由模型定义数据传输模型" class="headerlink" title="3.2 根据Spring Cloud Gateway的路由模型定义数据传输模型"></a>3.2 根据Spring Cloud Gateway的路由模型定义数据传输模型</h3><p> 分别创建GatewayRouteDefinition.java, GatewayPredicateDefinition.java, GatewayFilterDefinition.java这三个类。<br>(1) 创建路由定义模型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayRouteDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//路由的Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">//路由断言集合配置</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GatewayPredicateDefinition&gt; predicates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//路由过滤器集合配置</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GatewayFilterDefinition&gt; filters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//路由规则转发的目标uri</span></span><br><span class="line">    <span class="keyword">private</span> String uri;</span><br><span class="line">    <span class="comment">//路由执行的顺序</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//此处省略get和set方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(2)创建过滤器定义模型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Filter Name</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//对应的路由规则</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//此处省略Get和Set方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(3)创建路由断言定义模型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayPredicateDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//断言对应的Name</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//配置的断言规则</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//此处省略Get和Set方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-编写动态路由实现类"><a href="#3-3-编写动态路由实现类" class="headerlink" title="3.3 编写动态路由实现类"></a>3.3 编写动态路由实现类</h3><p>编写DynamicRouteServiceImpl并实现ApplicationEventPublisherAware接口，代码如下所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImpl</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher publisher;</span><br><span class="line">    <span class="comment">//增加路由</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</span><br><span class="line">        routeDefinitionWriter.save(Mono.just(definition)).subscribe();</span><br><span class="line">        <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新路由</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(definition.getId()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"update fail,not find route  routeId: "</span>+definition.getId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            routeDefinitionWriter.save(Mono.just(definition)).subscribe();</span><br><span class="line">            <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"update route  fail"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删除路由</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(String id) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(id))</span><br><span class="line">                .then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build())))</span><br><span class="line">                .onErrorResume(t -&gt; t <span class="keyword">instanceof</span> NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.publisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-编写Nacos监听接收下发的路由配置"><a href="#3-4-编写Nacos监听接收下发的路由配置" class="headerlink" title="3.4 编写Nacos监听接收下发的路由配置"></a>3.4 编写Nacos监听接收下发的路由配置</h3><h3 id="3-4-1-使用Nacos监听下发的配置"><a href="#3-4-1-使用Nacos监听下发的配置" class="headerlink" title="3.4.1 使用Nacos监听下发的配置"></a>3.4.1 使用Nacos监听下发的配置</h3><p>监听Nacos Config Server下发配置的代码如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImplByNacos</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DynamicRouteServiceImpl dynamicRouteService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicRouteServiceImplByNacos</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        dynamicRouteByNacosListener(<span class="string">"sc-gateway"</span>,<span class="string">"xujin_test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听Nacos Server下发的动态路由配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dynamicRouteByNacosListener</span> <span class="params">(String dataId, String group)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ConfigService configService=NacosFactory.createConfigService(<span class="string">"127.0.0.1:8848"</span>);</span><br><span class="line">            String content = configService.getConfig(dataId, group, <span class="number">5000</span>);</span><br><span class="line">            System.out.println(content);</span><br><span class="line">            configService.addListener(dataId, group, <span class="keyword">new</span> Listener()  &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConfigInfo</span><span class="params">(String configInfo)</span> </span>&#123;</span><br><span class="line">                    RouteDefinition definition= JSON.parseObject(configInfo,RouteDefinition.class);</span><br><span class="line">                    dynamicRouteService.update(definition);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">            <span class="comment">//todo 提醒:异常自行处理此处省略</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-4-2-两种方式创建ConfigService"><a href="#3-4-2-两种方式创建ConfigService" class="headerlink" title="3.4.2 两种方式创建ConfigService"></a>3.4.2 两种方式创建ConfigService</h4><p>使用两种方式创建com.alibaba.nacos.api.config.ConfigService</p><ul><li>1.构建Properties创建</li></ul><p>使用createConfigService(Properties properties)，代码如下所示:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            properties.put(<span class="string">"nacos.server-addr"</span>, <span class="string">""</span>);</span><br><span class="line">            properties.put(PropertyKeyConst.SERVER_ADDR, <span class="string">"127.0.0.1:8848"</span>);</span><br><span class="line">            ConfigService configService=NacosFactory.createConfigService(properties);</span><br></pre></td></tr></table></figure></p><blockquote><p>注意:PropertyKeyConst是com.alibaba.nacos.api.PropertyKeyConst</p></blockquote><ul><li>2.只传递Nacos Config Server的地址</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConfigService configService=NacosFactory.createConfigService(<span class="string">"127.0.0.1:8848"</span>);</span><br></pre></td></tr></table></figure><h2 id="4-使用Nacos下发配置"><a href="#4-使用Nacos下发配置" class="headerlink" title="4. 使用Nacos下发配置"></a>4. 使用Nacos下发配置</h2><h3 id="4-1-Nacos概述"><a href="#4-1-Nacos概述" class="headerlink" title="4.1 Nacos概述"></a>4.1 Nacos概述</h3><p>   Naocs由阿里开源，Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。<br>   Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。github地址:<a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener">https://github.com/alibaba/nacos</a></p><blockquote><p>更多Nacos的介绍，请访问官方网站:<a href="https://nacos.io/" target="_blank" rel="noopener">https://nacos.io/</a></p></blockquote><h3 id="4-2-在IDE中启动-Nacos"><a href="#4-2-在IDE中启动-Nacos" class="headerlink" title="4.2 在IDE中启动 Nacos"></a>4.2 在IDE中启动 Nacos</h3><p>访问<a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener">https://github.com/alibaba/nacos</a> ,使用Git克隆Nacos代码，直接导入到IDEA中，如下所示设置启动参数，直接启动。</p><p><img src="/images/mw/nacos/nacos0.jpg" alt=""></p><blockquote><p>从IDE中启动Nacos是我比较推荐的方式，因为可以随时Debug Nacos任何代码，其它启动方式请参考官网。</p></blockquote><h2 id="5-测试"><a href="#5-测试" class="headerlink" title="5.测试"></a>5.测试</h2><h3 id="5-1-Nacos中下发Spring-Cloud-Gateway的路由配置"><a href="#5-1-Nacos中下发Spring-Cloud-Gateway的路由配置" class="headerlink" title="5.1  Nacos中下发Spring Cloud Gateway的路由配置"></a>5.1  Nacos中下发Spring Cloud Gateway的路由配置</h3><ul><li>1.打开浏览器访问URL:<a href="http://localhost:8848/nacos/index.html" target="_blank" rel="noopener">http://localhost:8848/nacos/index.html</a> ,Nacos的管控平台如下所示:</li></ul><p><img src="/images/mw/nacos/nacos1.jpg" alt=""></p><ul><li>2.在Nacos的配置列表点击<code>+</code>按钮，下发Spring Cloud Gateway的路由配置，如下所示:</li></ul><p><img src="/images/mw/nacos/nacos2.jpg" alt=""></p><hr><p>用于测试的示例数据，如下所示:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"filters"</span>: [],</span><br><span class="line"><span class="attr">"id"</span>: <span class="string">"jd_route"</span>,</span><br><span class="line"><span class="attr">"order"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">"predicates"</span>: [&#123;</span><br><span class="line"><span class="attr">"args"</span>: &#123;</span><br><span class="line"><span class="attr">"pattern"</span>: <span class="string">"/jd"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"Path"</span></span><br><span class="line">&#125;],</span><br><span class="line"><span class="attr">"uri"</span>: <span class="string">"http://www.jd.com"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/mw/nacos/nacos3.jpg" alt=""><br><img src="/images/mw/nacos/nacos4.jpg" alt=""></p><h3 id="5-2-启动sc-gateway-server"><a href="#5-2-启动sc-gateway-server" class="headerlink" title="5.2 启动sc-gateway-server"></a>5.2 启动sc-gateway-server</h3><ul><li>1.Debug启动sc-gateway-server,调试截图如下所示:</li></ul><p><img src="/images/mw/nacos/nacos5.jpg" alt=""></p><ul><li>2.通过Spring Cloud gateway的端点，查看路由信息</li></ul><p><img src="/images/mw/nacos/nacos6.jpg" alt=""></p><ul><li>3.通过访问<a href="http://localhost:8080/jd" target="_blank" rel="noopener">http://localhost:8080/jd</a> ,可以转发到京东商城主页</li></ul><h3 id="5-3-更新路由配置"><a href="#5-3-更新路由配置" class="headerlink" title="5.3 更新路由配置"></a>5.3 更新路由配置</h3><ul><li>1.通过Nacos下发配置，修改Spring Cloud Gateway的动态路由规则</li></ul><p><img src="/images/mw/nacos/nacos7.jpg" alt=""></p><ul><li>2.查看访问Spring Cloud gateway的端点配置，可以看到动态路由修改如下:</li></ul><p><img src="/images/mw/nacos/nacos8.jpg" alt=""></p><ul><li>3.通过访问<a href="http://localhost:8080/jd" target="_blank" rel="noopener">http://localhost:8080/jd</a> ,可以转发到百度相关页面</li></ul>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway的动态路由实现</title>
      <link href="/sc/gw/gw09/"/>
      <url>/sc/gw/gw09/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要介绍了Spring Cloud Gateway的动态路由的简单实现方式。</p><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>   网关中有两个重要的概念，那就是路由配置和路由规则，路由配置是指配置某请求路径路由到指定的目的地址。而路由规则是指匹配到路由配置之后，再根据路由规则进行转发处理。<br>   Spring Cloud Gateway作为所有请求流量的入口，在实际生产环境中为了保证高可靠和高可用，尽量避免重启,需要实现Spring Cloud Gateway动态路由配置。前面章节介绍了Spring Cloud Gateway提供的两种方法去配置路由规则，但都是在Spring Cloud Gateway启动时候，就将路由配置和规则加载到内存里，无法做到不重启网关就可以动态的对应路由的配置和规则进行增加，修改和删除。<code>本篇文章简单介绍如何实现Spring Cloud Gateway的动态路由。</code><br><a id="more"></a></p><h2 id="2-Spring-Cloud-Gateway简单的动态路由实现"><a href="#2-Spring-Cloud-Gateway简单的动态路由实现" class="headerlink" title="2. Spring Cloud Gateway简单的动态路由实现"></a>2. Spring Cloud Gateway简单的动态路由实现</h2><p>Spring Cloud Gateway的官方文档并没有讲如何动态配置，查看 Spring Cloud Gateway的源码，发现<code>在org.springframework.cloud.gateway.actuate.GatewayControllerEndpoint</code>类中提供了动态配置的Rest接口，但是<code>需要开启Gateway的端点</code>，而且提供的功能不是很强大。通过参考和GatewayControllerEndpoint相关的代码，可以自己编码实际动态路由配置。<br>下面通过案例的方式去讲解怎么实现Gateway的动态路由配置。案例工程如ch18-7-gateway所示。</p><blockquote><p>代码地址:<a href="https://github.com/SpringCloud/spring-cloud-code/blob/master/ch18-7/ch18-7-gateway" target="_blank" rel="noopener">https://github.com/SpringCloud/spring-cloud-code/blob/master/ch18-7/ch18-7-gateway</a></p></blockquote><h2 id="3-简单动态路由的实现"><a href="#3-简单动态路由的实现" class="headerlink" title="3. 简单动态路由的实现"></a>3. 简单动态路由的实现</h2><h3 id="3-1-新建Maven工程ch18-7-gateway"><a href="#3-1-新建Maven工程ch18-7-gateway" class="headerlink" title="3.1 新建Maven工程ch18-7-gateway"></a>3.1 新建Maven工程ch18-7-gateway</h3><p>  配置主要的核心依赖如代码清单18-33所示：<br>  代码清单: ch18-7/ch18-7-gateway/pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="3-2-根据Spring-Cloud-Gateway的路由模型定义数据传输模型"><a href="#3-2-根据Spring-Cloud-Gateway的路由模型定义数据传输模型" class="headerlink" title="3.2 根据Spring Cloud Gateway的路由模型定义数据传输模型"></a>3.2 根据Spring Cloud Gateway的路由模型定义数据传输模型</h3><p> 分别创建GatewayRouteDefinition.java, GatewayPredicateDefinition.java, GatewayFilterDefinition.java这三个类。<br>(1) <code>创建路由定义模型</code>如下代码清单18-34所示：<br>代码清单 18-34: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayRouteDefinition.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayRouteDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//路由的Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">//路由断言集合配置</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GatewayPredicateDefinition&gt; predicates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//路由过滤器集合配置</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GatewayFilterDefinition&gt; filters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//路由规则转发的目标uri</span></span><br><span class="line">    <span class="keyword">private</span> String uri;</span><br><span class="line">    <span class="comment">//路由执行的顺序</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//此处省略get和set方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(2)<code>创建过滤器定义模型</code>,代码如代码清单18-35所示：<br>代码清单18-35: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayFilterDefinition.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Filter Name</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//对应的路由规则</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//此处省略Get和Set方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(3)<code>路由断言定义模型</code>，代码如代码清单18-36所示:<br>代码清单18-36: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/model/GatewayPredicateDefinition.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayPredicateDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">//断言对应的Name</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//配置的断言规则</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; args = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//此处省略Get和Set方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-编写动态路由实现类"><a href="#3-3-编写动态路由实现类" class="headerlink" title="3.3 编写动态路由实现类"></a>3.3 编写动态路由实现类</h3><p>编写DynamicRouteServiceImpl并实现ApplicationEventPublisherAware接口，代码如代码清单18-37所示: ch18-37/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/route/DynamicRouteServiceImpl.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRouteServiceImpl</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RouteDefinitionWriter routeDefinitionWriter;</span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher publisher;</span><br><span class="line">    <span class="comment">//增加路由</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</span><br><span class="line">        routeDefinitionWriter.save(Mono.just(definition)).subscribe();</span><br><span class="line">        <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新路由</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(RouteDefinition definition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(definition.getId()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"update fail,not find route  routeId: "</span>+definition.getId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            routeDefinitionWriter.save(Mono.just(definition)).subscribe();</span><br><span class="line">            <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> RefreshRoutesEvent(<span class="keyword">this</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"update route  fail"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删除路由</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(String id) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.routeDefinitionWriter.delete(Mono.just(id))</span><br><span class="line">                .then(Mono.defer(() -&gt; Mono.just(ResponseEntity.ok().build())))</span><br><span class="line">                .onErrorResume(t -&gt; t <span class="keyword">instanceof</span> NotFoundException, t -&gt; Mono.just(ResponseEntity.notFound().build()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.publisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-编写Rest接口"><a href="#3-4-编写Rest接口" class="headerlink" title="3.4 编写Rest接口"></a>3.4 编写Rest接口</h3><p>编写RouteController类的提供Rest接口，用于动态路由配置。代码如代码清单18-38所示:<br>代码清单 18-38: ch18-7/ch18-7-gateway/src/main/java/cn/springcloud/book/gateway/controller/RouteController.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/route"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DynamicRouteServiceImpl dynamicRouteService;</span><br><span class="line">    <span class="comment">//增加路由</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(@RequestBody GatewayRouteDefinition gwdefinition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            RouteDefinition definition = assembleRouteDefinition(gwdefinition);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.add(definition);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"succss"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//删除路由</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(<span class="string">"/routes/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Object&gt;&gt; delete(<span class="meta">@PathVariable</span> String id) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新路由</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(@RequestBody GatewayRouteDefinition gwdefinition)</span> </span>&#123;</span><br><span class="line">        RouteDefinition definition = assembleRouteDefinition(gwdefinition);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dynamicRouteService.update(definition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5-配置application-yml文件"><a href="#3-5-配置application-yml文件" class="headerlink" title="3.5 配置application.yml文件"></a>3.5 配置application.yml文件</h3><p>在application.yml文件配置应用的配置信息，并开启Spring Cloud Gateway对外提供的端点Rest接口。代码如代码清单18-39所示:<br>代码清单 18-39: ch18-7/ch18-7-gateway/src/main/resources/application.yml<br>配置输出日志如下所示:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置输出日志</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">TRACE</span></span><br><span class="line">    <span class="string">org.springframework.http.server.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">org.springframework.web.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">reactor.ipc.netty:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="comment">#开启端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  security:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><h3 id="3-6-启动ch18-7-gateway应用测试"><a href="#3-6-启动ch18-7-gateway应用测试" class="headerlink" title="3.6 启动ch18-7-gateway应用测试"></a>3.6 启动ch18-7-gateway应用测试</h3><p>(1) 启动ch18-7-gateway应用之后，由于开启了端点，首先打开浏览器访问端点URL:<br><a href="http://localhost:8080/actuator/gateway/routes" target="_blank" rel="noopener">http://localhost:8080/actuator/gateway/routes</a>  ,查看路由信息返回为空，如下图所示:</p><p><img src="/images/sc-g-route/1.png" alt="空的路由信息"></p><p>(2)打开PostMan，访问<a href="http://localhost:8080/route/add" target="_blank" rel="noopener">http://localhost:8080/route/add</a>, 发起Post请求，如下图所示,返回success说明向Gateway增加路由配置成功。<br><img src="/images/sc-g-route/2.png" alt="动态添加路由成功"></p><p> 然后再打开PostMan访问端点URL:<a href="http://localhost:8080/actuator/gateway/routes" target="_blank" rel="noopener">http://localhost:8080/actuator/gateway/routes</a> ,<br> 查看路由信息返回如下图所示，可以看到已经添加的路由配置。<br><img src="/images/sc-g-route/3.png" alt="路由端点返回结果"></p><p>(3) 打开浏览器访问<a href="http://localhost:8080/jd" target="_blank" rel="noopener">http://localhost:8080/jd</a>, 可以正常转发<a href="https://www.jd.com/对应的京东商城首页。" target="_blank" rel="noopener">https://www.jd.com/对应的京东商城首页。</a><br>(4) 通过访问<a href="http://localhost:8080/route/update" target="_blank" rel="noopener">http://localhost:8080/route/update</a>, 对id为jd_route的路由更新配置，如下图所示：<br><img src="/images/sc-g-route/4.png" alt="更新路由配置"></p><p> 然后再访问路由端点URL,发现路由配置已经被更新，如下图所示:<br><img src="/images/sc-g-route/5.png" alt="查看路由端点"></p><p>然后通过浏览器访问<a href="http://localhost:8080/taobao" target="_blank" rel="noopener">http://localhost:8080/taobao</a> ,可以成功转发到淘宝网。<br>(5) 通过访问http: //localhost:8080/route/delete/jd_route,其中的id为路由对应的id，删除路由结果如下图所示:<br><img src="/images/sc-g-route/6.png" alt="删除路由成功"></p><h2 id="4-Spring-Cloud-Gateway推荐文章"><a href="#4-Spring-Cloud-Gateway推荐文章" class="headerlink" title="4.Spring Cloud Gateway推荐文章"></a>4.Spring Cloud Gateway推荐文章</h2><p><a href="http://xujin.org/sc/gw/gw08/">Spring Cloud Gateway中的权重路由</a><br><a href="http://xujin.org/sc/gw/gw07/">Spring Cloud Gateway中的GatewayFilter和GlobalFilter</a><br><a href="http://xujin.org/sc/gw/gw06/">Spring Cloud Gateway只有Pre和POST两种类型的Filter</a><br><a href="http://xujin.org/sc/gw/gw05/">Spring Cloud Gateway基于服务发现的默认路由规则</a><br><a href="http://xujin.org/sc/gw/gw04/">Spring Cloud Gateway的Before路由断言工厂</a><br><a href="http://xujin.org/sc/gw/gw03/">Spring Cloud Gateway的After路由断言工厂</a><br><a href="http://xujin.org/sc/gw/gw02/">Spring Cloud Gateway揭秘之处理请求流程</a><br><a href="http://xujin.org/sc/gw/gw-01/">Spring Cloud Gateway入门案例</a></p><h2 id="5-《重新定义Spring-Cloud实战》中的Spring-Cloud-Gateway"><a href="#5-《重新定义Spring-Cloud实战》中的Spring-Cloud-Gateway" class="headerlink" title="5.《重新定义Spring Cloud实战》中的Spring Cloud Gateway"></a>5.《重新定义Spring Cloud实战》中的Spring Cloud Gateway</h2><p>第17章Spring Cloud Gateway上篇399<br>17.1 Spring Cloud Gateway概述399<br>17.1.1 什么是Spring Cloud Gateway399<br>17.1.2 Spring Cloud Gateway的核心概念399<br>17.2 Spring Cloud Gateway的工作原理400<br>17.3 Spring Cloud Gateway入门案例401<br>17.4 Spring Cloud Gateway的路由断言404<br>17.4.1 After路由断言工厂404<br>17.4.2 Before路由断言工厂406<br>17.4.3 Between路由断言工厂406<br>17.4.4 Cookie路由断言工厂407<br>17.4.5 Header路由断言工厂408<br>17.4.6 Host路由断言工厂410<br>17.4.7 Method路由断言工厂411<br>17.4.8 Query路由断言工厂411<br>17.4.9 RemoteAddr路由断言工厂412<br>17.5 Spring Cloud Gateway的内置Filter413<br>17.5.1 AddRequestHeader过滤器工厂413<br>17.5.2 AddRequestParameter过滤器413<br>17.5.3 RewritePath过滤器414<br>17.5.4 AddResponseHeader过滤器415<br>17.5.5 StripPrefix过滤器416<br>17.5.6 Retry过滤器417<br>17.5.7 Hystrix过滤器418<br>17.6 本章小结420<br>第18章 Spring Cloud Gateway下篇421<br>18.1 Gateway基于服务发现的路由规则421<br>18.1.1 Gateway的服务发现路由概述421<br>18.1.2 服务发现的路由规则案例422<br>18.2 Gateway Filter和Global Filter425<br>18.2.1 Gateway Filter和Global Filter概述425<br>18.2.2 自定义Gateway Filter案例425<br>18.2.3 自定义Global Filter案例427<br>18.3 Spring Cloud Gateway实战428<br>18.3.1 Spring Cloud Gateway权重路由428<br>18.3.2 Spring Cloud Gateway中Https的使用技巧431<br>18.3.3 Spring Cloud Gateway集成Swagger436<br>18.3.4 Spring Cloud Gateway限流442<br>18.3.5 Spring Cloud Gateway的动态路由450<br>18.4 Spring Cloud Gateway源码篇458<br>18.4.1 Spring Cloud Gateway的处理流程458<br>18.4.2 Gateway中ServerWebExchange构建分析459<br>18.4.3 DispatcherHandler源码分析460<br>18.4.4 RoutePredicateHandlerMapping源码分析461<br>18.4.5 FilteringWebHandler源码分析462<br>18.4.6 执行Filter源码分析463<br>18.5 本章小结465</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">├── ch17-1</span><br><span class="line">│   ├── ch17-1-1-gateway</span><br><span class="line">│   ├── ch17-1-2-gateway</span><br><span class="line">│   ├── ch17-1.iml</span><br><span class="line">│   └── pom.xml</span><br><span class="line">├── ch17-2</span><br><span class="line">│   ├── ch17-2-1-gateway</span><br><span class="line">│   ├── ch17-2-2-gateway</span><br><span class="line">│   ├── ch17-2-3-gateway</span><br><span class="line">│   ├── ch17-2-4-gateway</span><br><span class="line">│   ├── ch17-2-5-gateway</span><br><span class="line">│   ├── ch17-2-6-gateway</span><br><span class="line">│   ├── ch17-2-7-gateway</span><br><span class="line">│   ├── ch17-2-8-gateway</span><br><span class="line">│   ├── ch17-2-9-gateway</span><br><span class="line">│   ├── ch17-2-service</span><br><span class="line">│   ├── ch17-2.iml</span><br><span class="line">│   └── pom.xml</span><br><span class="line">├── ch17-3</span><br><span class="line">│   ├── ch17-3-1-gateway</span><br><span class="line">│   ├── ch17-3-2-gateway</span><br><span class="line">│   ├── ch17-3-3-gateway</span><br><span class="line">│   ├── ch17-3-4-gateway</span><br><span class="line">│   ├── ch17-3-5-gateway</span><br><span class="line">│   ├── ch17-3-6-gateway</span><br><span class="line">│   ├── ch17-3-7-gateway</span><br><span class="line">│   ├── ch17-3-service</span><br><span class="line">│   ├── ch17-3.iml</span><br><span class="line">│   └── pom.xml</span><br><span class="line">├── ch18-1</span><br><span class="line">│   ├── ch18-1-consumer</span><br><span class="line">│   ├── ch18-1-eureka</span><br><span class="line">│   ├── ch18-1-gateway</span><br><span class="line">│   ├── ch18-1-provider</span><br><span class="line">│   ├── ch18-1.iml</span><br><span class="line">│   └── pom.xml</span><br><span class="line">├── ch18-2</span><br><span class="line">│   ├── ch18-2-gateway</span><br><span class="line">│   ├── ch18-2-provider</span><br><span class="line">│   ├── ch18-2.iml</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── reademe.txt</span><br><span class="line">├── ch18-3</span><br><span class="line">│   ├── ch18-3-gateway</span><br><span class="line">│   ├── ch18-3-provider</span><br><span class="line">│   ├── ch18-3.iml</span><br><span class="line">│   └── pom.xml</span><br><span class="line">├── ch18-4</span><br><span class="line">│   ├── ch18-4-eureka</span><br><span class="line">│   ├── ch18-4-gateway-https</span><br><span class="line">│   ├── ch18-4-service-a</span><br><span class="line">│   ├── ch18-4-service-b</span><br><span class="line">│   ├── ch18-4.iml</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── reademe.md</span><br><span class="line">├── ch18-5</span><br><span class="line">│   ├── ch18-5-eureka</span><br><span class="line">│   ├── ch18-5-gateway</span><br><span class="line">│   ├── ch18-5-service</span><br><span class="line">│   ├── ch18-5.iml</span><br><span class="line">│   └── pom.xml</span><br><span class="line">├── ch18-6</span><br><span class="line">│   ├── ch18-6-1-gateway</span><br><span class="line">│   ├── ch18-6-2-gateway</span><br><span class="line">│   ├── ch18-6-3-gateway</span><br><span class="line">│   ├── ch18-6-provider</span><br><span class="line">│   ├── ch18-6.iml</span><br><span class="line">│   └── pom.xml</span><br><span class="line">├── ch18-7</span><br><span class="line">│   ├── ch18-7-gateway</span><br><span class="line">│   ├── ch18-7.iml</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── readme.md</span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gateway所有示例代码地址:<a href="https://github.com/SpringCloud/spring-cloud-code" target="_blank" rel="noopener">https://github.com/SpringCloud/spring-cloud-code</a></p></blockquote>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway中的权重路由</title>
      <link href="/sc/gw/gw08/"/>
      <url>/sc/gw/gw08/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要通过运用Spring Cloud Gateway的WeightRoutePredicateFactory对URL进行权重路由。</p><a id="more"></a><h2 id="1-权重路由"><a href="#1-权重路由" class="headerlink" title="1.权重路由"></a>1.权重路由</h2><h3 id="1-1-权重路由使用场景"><a href="#1-1-权重路由使用场景" class="headerlink" title="1.1 权重路由使用场景"></a>1.1 权重路由使用场景</h3><p>在开发或者测试的时候，或者线上发布，线上服务多版本控制的时候，需要对服务提供权重路由，最常见的使用就是，一个服务有两个版本，旧版本V1，新版本v2。在线上灰度的时候，需要通过网关动态实时推送，路由权重信息。比如95%的流量走服务v1版本，5%的流量走服务v2版本。</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/ce44017f07ce3a1b1d30e87995227ef4.jpg?Expires=1843884992&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=DBIQ%2BF%2BgIkpjik7x0CmmfaSrglU%3D" alt=""></p><blockquote><p>issue: The Spring Cloud Gateway issue of Allow Rolling Deployments <a href="https://github.com/spring-cloud/spring-cloud-gateway/issues/67" target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-gateway/issues/67</a></p></blockquote><h3 id="1-2-Spring-Cloud-Gateway权重路由原理"><a href="#1-2-Spring-Cloud-Gateway权重路由原理" class="headerlink" title="1.2 Spring Cloud Gateway权重路由原理"></a>1.2 Spring Cloud Gateway权重路由原理</h3><p>Spring Cloud Gateway中提供了<code>org.springframework.cloud.gateway.handler.predicate.WeightRoutePredicateFactory</code>去实现根据分组设置权重进行路由，因此使用起来相对比较简单，有兴趣的可以debug阅读源码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeightRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">WeightConfig</span>&gt; <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(WeightRoutePredicateFactory.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_KEY = WeightConfig.CONFIG_PREFIX + <span class="string">".group"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEIGHT_KEY = WeightConfig.CONFIG_PREFIX + <span class="string">".weight"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ApplicationEventPublisher publisher;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WeightRoutePredicateFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(WeightConfig.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher publisher)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.publisher = publisher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Arrays.asList(GROUP_KEY, WEIGHT_KEY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">shortcutFieldPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> WeightConfig.CONFIG_PREFIX;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeApply</span><span class="params">(WeightConfig config)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (publisher != <span class="keyword">null</span>) &#123;</span><br><span class="line">publisher.publishEvent(<span class="keyword">new</span> WeightDefinedEvent(<span class="keyword">this</span>, config));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(WeightConfig config)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> exchange -&gt; &#123;</span><br><span class="line">Map&lt;String, String&gt; weights = exchange.getAttributeOrDefault(WEIGHT_ATTR,</span><br><span class="line">Collections.emptyMap());</span><br><span class="line"></span><br><span class="line">String routeId = exchange.getAttribute(GATEWAY_PREDICATE_ROUTE_ATTR);</span><br><span class="line"></span><br><span class="line"><span class="comment">// all calculations and comparison against random num happened in</span></span><br><span class="line"><span class="comment">// WeightCalculatorWebFilter</span></span><br><span class="line">String group = config.getGroup();</span><br><span class="line"><span class="keyword">if</span> (weights.containsKey(group)) &#123;</span><br><span class="line"></span><br><span class="line">String chosenRoute = weights.get(group);</span><br><span class="line"><span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">log.trace(<span class="string">"in group weight: "</span>+ group + <span class="string">", current route: "</span> + routeId +<span class="string">", chosen route: "</span> + chosenRoute);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> routeId.equals(chosenRoute);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-Spring-Cloud-Gateway中的权重路由案例"><a href="#2-Spring-Cloud-Gateway中的权重路由案例" class="headerlink" title="2.Spring Cloud Gateway中的权重路由案例"></a>2.Spring Cloud Gateway中的权重路由案例</h2><h3 id="2-1-案例代码地址"><a href="#2-1-案例代码地址" class="headerlink" title="2.1 案例代码地址"></a>2.1 案例代码地址</h3><p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch4" target="_blank" rel="noopener">https://github.com/SoftwareKing/sc-gateway/tree/master/ch4</a></p><h3 id="2-2-Spring-Cloud-Gateway-Server说明"><a href="#2-2-Spring-Cloud-Gateway-Server说明" class="headerlink" title="2.2 Spring Cloud Gateway Server说明"></a>2.2 Spring Cloud Gateway Server说明</h3><p>Spring Cloud Gateway will dispatch 95% of the requests to version 1 and 5% of the traffic to version 2 of a specified service, as shown by the following figure.</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/f8e439776d6bbff94993fafdfc02b98c.png?Expires=1843885017&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=a8ZhI5O5y7Gs7TP4eusGOT7qdoE%3D" alt=""></p><p>我们通过在Spring Cloud Gateway中会配置不同的权重信息到不同URL上，Spring Cloud Gateway会根据我们配置的路由权重信息，将请求分发到不同的源服务组，权重信息如ch4/ch4-gateway中的application.yml所示，主要配置信息如下。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">ch4-gateway</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">service1_v1</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:8081/v1</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/test</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Weight=service1,</span> <span class="number">95</span></span><br><span class="line"></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">service1_v2</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:8081/v2</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/test</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Weight=service1,</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><blockquote><p>Weight=service1, 95，Weight=service1, 5就是路由的权重信息。</p></blockquote><h3 id="2-3-源服务"><a href="#2-3-源服务" class="headerlink" title="2.3 源服务"></a>2.3 源服务</h3><p>源服务在本案例中源服务如ch4-service-provider所示，主要提提供Gateway Server权重路由对应的后端源服务。因为比较简单因此不做详细说明，主要代码如下所示。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/v1"</span>, produces = <span class="string">"text/plain;charset=UTF-8"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">v1</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Mono.just(<span class="string">"v1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/v2"</span>, produces = <span class="string">"text/plain;charset=UTF-8"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">v2</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Mono.just(<span class="string">"v2"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-测试"><a href="#2-4-测试" class="headerlink" title="2.4 测试"></a>2.4 测试</h3><p>分别启动ch4-gateway，ch4-service-provider进行访问:<a href="http://localhost:8080/test" target="_blank" rel="noopener">http://localhost:8080/test</a> 测试,发现会根据所设权重进行路由。</p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway中的GatewayFilter和GlobalFilter</title>
      <link href="/sc/gw/gw07/"/>
      <url>/sc/gw/gw07/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要介绍了什么是GatewayFilter和GlobalFilter，以及区别和联系。然后介绍如何在Spring Cloud Gateway中自定义使用GatewayFilter和GlobalFilter。</p><a id="more"></a><h2 id="1-Spring-Cloud-gateway的Filter"><a href="#1-Spring-Cloud-gateway的Filter" class="headerlink" title="1. Spring Cloud gateway的Filter"></a>1. Spring Cloud gateway的Filter</h2><p>Spring Cloud gateway中的Filter从接口实现上分为两种一种是GatewayFilter，另外一种是GlobalFilter。</p><h2 id="1-1-GatewayFilter与GlobalFilter的区别"><a href="#1-1-GatewayFilter与GlobalFilter的区别" class="headerlink" title="1.1 GatewayFilter与GlobalFilter的区别"></a>1.1 GatewayFilter与GlobalFilter的区别</h2><p>区别用英语可以总结如下:<br>At a high level global filters are applied to all routes, while a gateway filter will be applied to an individual route(s)</p><blockquote><p>在一个高的角度来看，Global filters会被应用到所有的路由上，而Gateway filter将应用到<code>单个路由</code>上或者<code>一个分组的路由</code>上。在下面的案例中将会进行说明。</p></blockquote><h2 id="1-2-本文代码地址"><a href="#1-2-本文代码地址" class="headerlink" title="1.2 本文代码地址"></a>1.2 本文代码地址</h2><blockquote><p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch2" target="_blank" rel="noopener">https://github.com/SoftwareKing/sc-gateway/tree/master/ch2</a></p></blockquote><h2 id="2-GatewayFilter和GlobalFilter"><a href="#2-GatewayFilter和GlobalFilter" class="headerlink" title="2. GatewayFilter和GlobalFilter"></a>2. GatewayFilter和GlobalFilter</h2><h3 id="2-1-GatewayFilter"><a href="#2-1-GatewayFilter" class="headerlink" title="2.1 GatewayFilter"></a>2.1 GatewayFilter</h3><h4 id="2-1-1-什么是GatewayFilter"><a href="#2-1-1-什么是GatewayFilter" class="headerlink" title="2.1.1 什么是GatewayFilter"></a>2.1.1 什么是GatewayFilter</h4><p>Contract for interception-style, chained processing of Web requests that may be used to implement cross-cutting, application-agnostic requirements such<br> as security, timeouts, and others. Specific to a Gateway Copied from WebFilter</p><blockquote><p>GatewayFilter是从WebFilter中Copy过来的，相当于一个Filter过滤器，可以对访问的URL过滤横切处理，应用场景比如超时，安全等。</p></blockquote><p>从Spring Cloud Gateway的源码中如下所示，可以看出GatewayFilter的使用场景:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Contract for interception-style, chained processing of Web requests that may</span></span><br><span class="line"><span class="comment"> * be used to implement cross-cutting, application-agnostic requirements such</span></span><br><span class="line"><span class="comment"> * as security, timeouts, and others. Specific to a Gateway</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Copied from WebFilter</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 5.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GatewayFilter</span> <span class="keyword">extends</span> <span class="title">ShortcutConfigurable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">String NAME_KEY = <span class="string">"name"</span>;</span><br><span class="line">String VALUE_KEY = <span class="string">"value"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process the Web request and (optionally) delegate to the next</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> WebFilter&#125; through the given &#123;<span class="doctag">@link</span> GatewayFilterChain&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange the current server exchange</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chain provides a way to delegate to the next filter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request processing is complete</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>GatewayFilter和GlobalFilter两个接口中定义的方法一样都是Mono<void> filter(ServerWebExchange exchange, GatewayFilterChain chain)，唯一的区别就是GatewayFilter继承了ShortcutConfigurable，GlobalFilter没有任何继承。</void></p></blockquote><h5 id="2-1-2-自定义GatewayFilter-Custom-GatewayFilter"><a href="#2-1-2-自定义GatewayFilter-Custom-GatewayFilter" class="headerlink" title="2.1.2 自定义GatewayFilter(Custom GatewayFilter)"></a>2.1.2 自定义GatewayFilter(Custom GatewayFilter)</h5><p>如org.xujin.sc.filter.CustomFilter代码所示，通过自定义GatewayFilter对路由转发的处理时长统计。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计某个或者某种路由的的处理时长</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xujin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(GatewayFilter.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COUNT_Start_TIME = <span class="string">"countStartTime"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        exchange.getAttributes().put(COUNT_Start_TIME, System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(</span><br><span class="line">                Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    Long startTime = exchange.getAttribute(COUNT_Start_TIME);</span><br><span class="line">                    Long endTime=(System.currentTimeMillis() - startTime);</span><br><span class="line">                    <span class="keyword">if</span> (startTime != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        log.info(exchange.getRequest().getURI().getRawPath() + <span class="string">": "</span> + endTime + <span class="string">"ms"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-3-Gateway-Filter与RouteLocator绑定使用"><a href="#2-1-3-Gateway-Filter与RouteLocator绑定使用" class="headerlink" title="2.1.3 Gateway Filter与RouteLocator绑定使用"></a>2.1.3 Gateway Filter与RouteLocator绑定使用</h4><p>在org.xujin.sc.GatewayServerApplication中customerRouteLocator如下所示:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customerRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">                .route(r -&gt; r.path(<span class="string">"/test/prefix/**"</span>)</span><br><span class="line">                        .filters(f -&gt; f.stripPrefix(<span class="number">2</span>)</span><br><span class="line">                                .filter(<span class="keyword">new</span> CustomFilter())</span><br><span class="line">                                .addResponseHeader(<span class="string">"X-Response-test"</span>, <span class="string">"test"</span>))</span><br><span class="line">                        .uri(<span class="string">"lb://SC-CONSUMER"</span>)</span><br><span class="line">                        .order(<span class="number">0</span>)</span><br><span class="line">                        .id(<span class="string">"test_consumer_service"</span>)</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>r.path(“/test/prefix/**”)表示自定义了访问前缀，在真正的Gateway进行路由转发的时候，会用过f.stripPrefix(2)把前缀去掉。</p><blockquote><p>使用场景:可以把对外暴露的URL通过加前缀分组打标。</p></blockquote></li><li><p>filter(new CustomFilter()</p><blockquote><p>filter(new CustomFilter()，表示把自定义的Filter加到Filter链里面执行，注意一点是自定义GlobalFilter不需要加进去。</p></blockquote></li><li><p>uri(“lb://SC-CONSUMER”)</p><blockquote><p>uri(“lb://SC-CONSUMER”)表示Spring Cloud Gateway对spring.application.name等于sc-consumer源服务应用中的URL进行协议适配转发。</p></blockquote></li></ol><h4 id="2-1-4-测试如下"><a href="#2-1-4-测试如下" class="headerlink" title="2.1.4 测试如下:"></a>2.1.4 测试如下:</h4><p>1.访问<a href="http://localhost:9000/SC-CONSUMER/hello/xujin" target="_blank" rel="noopener">http://localhost:9000/SC-CONSUMER/hello/xujin</a> 能正常访问。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-27 09:58:07.905 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$337/1295338046@f2ff0c8, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$717/1168359877@1f74a2b, order=1&#125;]&#125;</span><br><span class="line">2018-05-27 09:58:07.905 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@f5bf288&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$717/1168359877@1f74a2b, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@26c77f54&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@4c38cd16&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2c1d57bc&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@6e9a0bea&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@7ddcb0dc&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@3e856100&#125;, order=2147483647&#125;]</span><br></pre></td></tr></table></figure><blockquote><p>从上面的控制台打印日志可以看出，没有打印出该URL对应的耗时。</p></blockquote><p>2.加上URL前缀/test/prefix/访问，测试URL为<br><a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin" target="_blank" rel="noopener">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-05-27 10:01:56.057 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/test/prefix/hello/testCustomFilter/xujin] to Route&#123;id='test_consumer_service', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$337/1295338046@6dbaa72e, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory$$Lambda$340/1149217113@41fb2078, order=0&#125;, org.xujin.sc.filter.CustomFilter@281885a3, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory$$Lambda$342/1099925775@4705cae6, order=0&#125;]&#125;</span><br><span class="line">2018-05-27 10:01:56.057 DEBUG 31658 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@f5bf288&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory$$Lambda$340/1149217113@41fb2078, order=0&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory$$Lambda$342/1099925775@4705cae6, order=0&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@26c77f54&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@4c38cd16&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2c1d57bc&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@6e9a0bea&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@7ddcb0dc&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@3e856100&#125;, order=2147483647&#125;, org.xujin.sc.filter.CustomFilter@281885a3]</span><br><span class="line">2018-05-27 10:02:00.347  INFO 31658 --- [ctor-http-nio-8] o.s.cloud.gateway.filter.GatewayFilter   : /hello/testCustomFilter/xujin: 859ms</span><br></pre></td></tr></table></figure><blockquote><p>如上日志可以看到/hello/testCustomFilter/xujin: 859ms，Gateway转发的时候去掉了前缀。</p></blockquote><h3 id="2-2-GlobalFilter"><a href="#2-2-GlobalFilter" class="headerlink" title="2.2 GlobalFilter"></a>2.2 GlobalFilter</h3><h4 id="2-2-1-什么是GlobalFilter"><a href="#2-2-1-什么是GlobalFilter" class="headerlink" title="2.2.1 什么是GlobalFilter"></a>2.2.1 什么是GlobalFilter</h4><blockquote><p>The GlobalFilter interface has the same signature as GatewayFilter. These are special filters that are conditionally applied to all routes. (This interface and usage are subject to change in future milestones).</p></blockquote><p>Spring Cloud gateway定义了GlobalFilter的接口让我们去自定义实现自己的的GlobalFilter。GlobalFilter是一个全局的Filter，作用于所有的路由。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GlobalFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process the Web request and (optionally) delegate to the next</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> WebFilter&#125; through the given &#123;<span class="doctag">@link</span> GatewayFilterChain&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange the current server exchange</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chain provides a way to delegate to the next filter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request processing is complete</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-自定义全局过滤器-Custom-GlobalFilter"><a href="#2-2-2-自定义全局过滤器-Custom-GlobalFilter" class="headerlink" title="2.2.2 自定义全局过滤器(Custom GlobalFilter)"></a>2.2.2 自定义全局过滤器(Custom GlobalFilter)</h4><p>在这里简单定义AuthSignatureFilter实现<code>GlobalFilter</code>，使用场景就是Gateway对请求的URL校验权限，判断请求的URL是否是合法请求。通过从ServerWebExchange获取请求上下文中authToken对应的值，进行判null处理，其它的check逻辑可以自定定制。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调用鉴权</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthSignatureFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        String token = exchange.getRequest().getQueryParams().getFirst(<span class="string">"authToken"</span>);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span> || token.isEmpty()) &#123;</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>GlobalFilter写完了，那问题来了？如何让其在Gateway中运行生效，有两种方式一种直接加<code>@Component</code>注解，另外一种可以在 Spring Config 中配置这个 Bean如下所示:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AuthSignatureFilter <span class="title">authSignatureFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> AuthSignatureFilter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>1.访问<a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin" target="_blank" rel="noopener">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin</a> 如下所示由于authToken为空401返回.</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/91ce199f4af8f4bd9576aace65940253.jpeg?Expires=1842749245&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=Is0KT0QAVXkPS20EdSPvDqmlxmc%3D" alt=""></p><p>2.访问<a href="http://localhost:9000/test/prefix/hello/testCustomFilter/xujin?authToken=asdasdsddasadsadsadsdadsewew32rg" target="_blank" rel="noopener">http://localhost:9000/test/prefix/hello/testCustomFilter/xujin?authToken=asdasdsddasadsadsadsdadsewew32rg</a></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/86509f882391c3a20d2f32778dd1c2e9.jpeg?Expires=1842749511&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=lAd7U0lj4WZ0HMWF9SpbfKJ4aR8%3D" alt=""></p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway基于服务发现的默认路由规则</title>
      <link href="/sc/gw/gw05/"/>
      <url>/sc/gw/gw05/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本篇文章主要介绍了Spring Cloud Gateway的基于服务发现的默认路由规则，从中可以看出Gateway的路由规则:<a href="http://Gateway_HOST:Gateway_PORT/大写的serviceId/*" target="_blank" rel="noopener">http://Gateway_HOST:Gateway_PORT/大写的serviceId/*</a> 和 zuul的默认路由规则<a href="http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/*差不多。" target="_blank" rel="noopener">http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/*差不多。</a></p><a id="more"></a><h2 id="1-Spring-Gateway概述"><a href="#1-Spring-Gateway概述" class="headerlink" title="1.Spring Gateway概述"></a>1.Spring Gateway概述</h2><h3 id="1-1-什么是Spring-Cloud-Gateway"><a href="#1-1-什么是Spring-Cloud-Gateway" class="headerlink" title="1.1 什么是Spring Cloud Gateway"></a>1.1 什么是Spring Cloud Gateway</h3><p>   <code>Spring Cloud Gateway</code>是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代Netflix ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/3f25fcd95769a54eb391931449d5298f.jpg?Expires=1841935182&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=F%2BSKuTDpXoj5xCXwIIJ4u8D1C2A%3D" alt=""></p><h3 id="1-2-Spring-Cloud-Gateway的功能"><a href="#1-2-Spring-Cloud-Gateway的功能" class="headerlink" title="1.2 Spring Cloud Gateway的功能"></a>1.2 Spring Cloud Gateway的功能</h3><p>Spring Cloud Gateway 的特征：</p><ul><li>基于 Spring Framework 5，Project Reactor 和 Spring Boot 2.0<br>动态路由</li><li>Predicates 和 Filters 作用于特定路由</li><li>集成 Hystrix 断路器</li><li>集成 Spring Cloud DiscoveryClient</li><li>易于编写的 Predicates 和 Filters</li><li>限流</li><li>路径重写</li></ul><h2 id="2-Spring-Cloud-Gateway的工程流程"><a href="#2-Spring-Cloud-Gateway的工程流程" class="headerlink" title="2. Spring Cloud Gateway的工程流程"></a>2. Spring Cloud Gateway的工程流程</h2><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/22e4eccf2cbe09332678c04b8de98ebe.jpg?Expires=1841935407&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=NHcssduqPTQry7HCmudjphw0qC4%3D" alt=""></p><p>   客户端向 Spring Cloud Gateway 发出请求。然后在 Gateway Handler Mapping 中找到与请求相匹配的路由，将其发送到 Gateway Web Handler。Handler 再通过指定的过滤器链来将请求发送到我们实际的服务执行业务逻辑，然后返回。<br>过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前（“pre”）或之后（“post”）执行业务逻辑。</p><h3 id="2-1-Pre和POST两种类型的过滤器"><a href="#2-1-Pre和POST两种类型的过滤器" class="headerlink" title="2.1 Pre和POST两种类型的过滤器"></a>2.1 Pre和POST两种类型的过滤器</h3><h2 id="3-基于服务发现的默认路由规则"><a href="#3-基于服务发现的默认路由规则" class="headerlink" title="3.基于服务发现的默认路由规则"></a>3.基于服务发现的默认路由规则</h2><h3 id="3-1-zuul和gateway的默认路由规则"><a href="#3-1-zuul和gateway的默认路由规则" class="headerlink" title="3.1 zuul和gateway的默认路由规则"></a>3.1 zuul和gateway的默认路由规则</h3><h4 id="3-1-1-zuul的默认路由规则"><a href="#3-1-1-zuul的默认路由规则" class="headerlink" title="3.1.1 zuul的默认路由规则"></a>3.1.1 zuul的默认路由规则</h4><p>说明默认情况下，Zuul会代理所有注册到Eureka Server的微服务，并且Zuul的路由规则如下：<br>   <a href="http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/**" target="_blank" rel="noopener">http://ZUUL_HOST:ZUUL_PORT/微服务在Eureka上的serviceId/**</a> 会被转发到serviceId对应的微服务。<br>   <a href="http://localhost:8040/sc-zuul-first-provider/sc/order/2" target="_blank" rel="noopener">http://localhost:8040/sc-zuul-first-provider/sc/order/2</a><br>   <img src="http://xujin.org/images/sc-study/sc-zuul-01-t1.png" alt="默认路由规则"></p><h4 id="3-1-2-gateway的默认路由规则"><a href="#3-1-2-gateway的默认路由规则" class="headerlink" title="3.1.2 gateway的默认路由规则"></a>3.1.2 gateway的默认路由规则</h4><p>下面的案例中会演示：<a href="http://localhost:9000/SC-CONSUMER/hello/xujin" target="_blank" rel="noopener">http://localhost:9000/SC-CONSUMER/hello/xujin</a></p><blockquote><p><a href="http://Gateway_HOST:Gateway_PORT/大写的serviceId/**，其中微服务应用名默认大写访问。" target="_blank" rel="noopener">http://Gateway_HOST:Gateway_PORT/大写的serviceId/**，其中微服务应用名默认大写访问。</a></p></blockquote><h3 id="3-2-案例示例代码"><a href="#3-2-案例示例代码" class="headerlink" title="3.2  案例示例代码"></a>3.2  案例示例代码</h3><p><a href="https://github.com/SoftwareKing/sc-gateway/tree/master/ch1" target="_blank" rel="noopener">https://github.com/SoftwareKing/sc-gateway/tree/master/ch1</a></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/74473f8fa112dbf946452dd234be9783.jpeg?Expires=1841935730&OSSAccessKeyId=LTAI57F52hRuWq3h&Signature=8hk%2BcIs0lpEA3S01TQsu%2BVdome8%3D" width="450px" height="252px"></p><table><thead><tr><th>模块</th><th>说明</th><th>端口</th></tr></thead><tbody><tr><td>ch1-sc-consumer</td><td>服务消费者</td><td>8000</td></tr><tr><td>ch1-sc-eureka</td><td>Eureka Server注册中心</td><td>8761</td></tr><tr><td>ch1-sc-gateway</td><td>Spring Cloud Gateway Sever</td><td>9000</td></tr><tr><td>ch1-sc-provider</td><td>服务提供者</td><td>8001</td></tr></tbody></table><h4 id="3-2-1-ch1-sc-gateway工程说明"><a href="#3-2-1-ch1-sc-gateway工程说明" class="headerlink" title="3.2.1 ch1-sc-gateway工程说明"></a>3.2.1 ch1-sc-gateway工程说明</h4><h4 id="3-2-1-1-Maven依赖"><a href="#3-2-1-1-Maven依赖" class="headerlink" title="3.2.1.1  Maven依赖"></a>3.2.1.1  Maven依赖</h4><p>Spring Cloud Gateway sever主要的maven依赖如下所示</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="3-2-1-2-yml文件配置"><a href="#3-2-1-2-yml文件配置" class="headerlink" title="3.2.1.2 yml文件配置"></a>3.2.1.2 yml文件配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-gateway-server</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        locator:</span></span><br><span class="line"><span class="attr">          enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><p>配置说明：</p><blockquote><p>spring.cloud.gateway.discovery.locator.enabled：是否与服务发现组件进行结合，通过 serviceId 转发到具体的服务实例。默认为false，设为true便开启通过服务中心的自动根据 serviceId 创建路由的功能。</p></blockquote><hr><blockquote><p>修改spring cloud gateway server监听的端口为9000</p></blockquote><hr><blockquote><p>eureka.client.service-url.defaultZone: <a href="http://localhost:8761/eureka/,指定注册中心的地址，Spring" target="_blank" rel="noopener">http://localhost:8761/eureka/,指定注册中心的地址，Spring</a> Cloud Gateway从注册中心获取已经注册的服务列表。</p></blockquote><hr><blockquote><p>logging.level.org.springframework.cloud.gateway: debug,开启spring-Cloud-gateway的日志级别为debug，方便debug调试。</p></blockquote><h3 id="3-3-启动测试"><a href="#3-3-启动测试" class="headerlink" title="3.3 启动测试"></a>3.3 启动测试</h3><h4 id="3-3-1-错误的路由规则访问"><a href="#3-3-1-错误的路由规则访问" class="headerlink" title="3.3.1 错误的路由规则访问"></a>3.3.1 错误的路由规则访问</h4><p>访问Spring Cloud Gateway对应的server，当访问<a href="http://localhost:9000/sc-consumer/hello/xujin的时候，报错如下所示，正确的Spring" target="_blank" rel="noopener">http://localhost:9000/sc-consumer/hello/xujin的时候，报错如下所示，正确的Spring</a> Cloud Gateway的默认路由规则:<code>http://Gateway_HOST:Gateway_PORT/大写的serviceId/**</code></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/d98d829455d0f1a180eb1b4561c7d530.jpeg?Expires=1842311197&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=bIbKneLe1y%2B32zADPV6uQP4B2QY%3D" alt=""></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2018-05-18 01:10:49.742 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying &#123;pattern=/SC-CONSUMER/**&#125; to Path</span><br><span class="line">2018-05-18 01:10:49.743 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying filter &#123;regexp=/SC-CONSUMER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-18 01:10:49.743 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-18 01:10:49.744 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying &#123;pattern=/SC-PRODUCER/**&#125; to Path</span><br><span class="line">2018-05-18 01:10:49.744 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying filter &#123;regexp=/SC-PRODUCER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-18 01:10:49.745 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-PRODUCER</span><br><span class="line">2018-05-18 01:10:49.745 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying &#123;pattern=/SC-GATEWAY-SERVER/**&#125; to Path</span><br><span class="line">2018-05-18 01:10:49.747 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying filter &#123;regexp=/SC-GATEWAY-SERVER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-18 01:10:49.748 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-GATEWAY-SERVER</span><br><span class="line">2018-05-18 01:10:49.748 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-18 01:10:49.749 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$707/751096818@7f4c6373, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$709/672603106@293895d2, order=1&#125;]&#125;</span><br><span class="line">2018-05-18 01:10:49.749 DEBUG 6462 --- [ctor-http-nio-5] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@5e85c21b&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$709/672603106@293895d2, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@38e83838&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@6ef2f7ad&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@41def031&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@4966bab1&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@22d477c2&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@39832280&#125;, order=2147483647&#125;]</span><br></pre></td></tr></table></figure><p>从上面的log，看到返回了 404 错误，进一步可以看到 Spring Cloud Gateway 已经为我们的 provider 和 consumer 自动创建了对应的路由转发规则，但是这里的 pattern/regexp 里都是大写的，下面换成大写的测试一下。</p><h4 id="3-3-2-Gateway正确的路由规则测试"><a href="#3-3-2-Gateway正确的路由规则测试" class="headerlink" title="3.3.2 Gateway正确的路由规则测试"></a>3.3.2 Gateway正确的路由规则测试</h4><p>访问正确的<a href="http://localhost:9000/SC-CONSUMER/hello/xujin，可以成功访问。" target="_blank" rel="noopener">http://localhost:9000/SC-CONSUMER/hello/xujin，可以成功访问。</a></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/42059405c29359bcca90c14e3e1f34ca.jpeg?Expires=1842311310&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=eEHIkLTtbPzvhXI2OhoK0TUXwtE%3D" alt=""></p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/ff700908c44140ec692956f4f1b526cc.jpeg?Expires=1842311231&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=ZPi13%2BGvvb2eEIHEqRIkzL3mwKw%3D" alt=""></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2018-05-22 09:04:21.204 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying &#123;pattern=/SC-CONSUMER/**&#125; to Path</span><br><span class="line">2018-05-22 09:04:21.205 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-CONSUMER applying filter &#123;regexp=/SC-CONSUMER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-22 09:04:21.205 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-22 09:04:21.206 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying &#123;pattern=/SC-PRODUCER/**&#125; to Path</span><br><span class="line">2018-05-22 09:04:21.207 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-PRODUCER applying filter &#123;regexp=/SC-PRODUCER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-22 09:04:21.207 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-PRODUCER</span><br><span class="line">2018-05-22 09:04:21.208 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying &#123;pattern=/SC-GATEWAY-SERVER/**&#125; to Path</span><br><span class="line">2018-05-22 09:04:21.208 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition CompositeDiscoveryClient_SC-GATEWAY-SERVER applying filter &#123;regexp=/SC-GATEWAY-SERVER/(?&lt;remaining&gt;.*), replacement=/$&#123;remaining&#125;&#125; to RewritePath</span><br><span class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.r.RouteDefinitionRouteLocator    : RouteDefinition matched: CompositeDiscoveryClient_SC-GATEWAY-SERVER</span><br><span class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Route matched: CompositeDiscoveryClient_SC-CONSUMER</span><br><span class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: GET http://localhost:9000/SC-CONSUMER/hello/xujin] to Route&#123;id='CompositeDiscoveryClient_SC-CONSUMER', uri=lb://SC-CONSUMER, order=0, predicate=org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$706/57023854@24f1a91e, gatewayFilters=[OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$708/2036079541@cbb7393, order=1&#125;]&#125;</span><br><span class="line">2018-05-22 09:04:21.209 DEBUG 1677 --- [ctor-http-nio-2] o.s.c.g.handler.FilteringWebHandler      : Sorted gatewayFilterFactories: [OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@29a98d9f&#125;, order=-1&#125;, OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory$$Lambda$708/2036079541@cbb7393, order=1&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@544e8149&#125;, order=10000&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@55d58825&#125;, order=10100&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@2da3b078&#125;, order=2147483637&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@1a96d94c&#125;, order=2147483646&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.NettyRoutingFilter@19a64eae&#125;, order=2147483647&#125;, OrderedGatewayFilter&#123;delegate=GatewayFilterAdapter&#123;delegate=org.springframework.cloud.gateway.filter.ForwardRoutingFilter@7fb66650&#125;, order=2147483647&#125;]</span><br></pre></td></tr></table></figure><p>可以看出，Spring Cloud Gateway 自动的为我们的 consumer 创建了一个路由，类似于下边这样<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="attr">    - id:</span> <span class="string">CompositeDiscoveryClient_SC-CONSUMER</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">lb://SC-CONSUMER</span></span><br><span class="line"><span class="attr">      order:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      predicates:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">Path=/SC-CONSUMER/**</span></span><br><span class="line"><span class="attr">      filters:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">RewritePath=/SC-CONSUMER/(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure></p><blockquote><p>所以从zuul迁移到gateway的时候，服务路由规则中的微服务应用Id默认从小写变为大写。</p></blockquote>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway只有Pre和POST两种类型的Filter</title>
      <link href="/sc/gw/gw06/"/>
      <url>/sc/gw/gw06/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:Spring Cloud Gateway只有两种类型的Filter，本文介绍如何在Spring Cloud Gateway中创建一个Pre或Post类型的Filter。</p><a id="more"></a><h2 id="zuul的Filter类型"><a href="#zuul的Filter类型" class="headerlink" title="zuul的Filter类型"></a>zuul的Filter类型</h2><p>Zuul 的 Filter 是通过filterType()方法来指定，一个 Filter 只能对应一种类型，要么是 “pre” 要么是“post”</p><h3 id="Spring-Cloud-Gateway的Filter类型"><a href="#Spring-Cloud-Gateway的Filter类型" class="headerlink" title="Spring Cloud Gateway的Filter类型"></a>Spring Cloud Gateway的Filter类型</h3><p>Spring Cloud Gateway 基于 Project Reactor 和 WebFlux，采用响应式编程风格，打开它的 Filter 的接口GatewayFilter你会发现它只有一个方法filter</p><h2 id="Pre类型的Filter"><a href="#Pre类型的Filter" class="headerlink" title="Pre类型的Filter"></a>Pre类型的Filter</h2><p>在Spring Cloud Gateway源码中定义了一个Pre类型的Filter，code将会在chain.filter() 之前被执行,代码:<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/master/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/AddRequestHeaderGatewayFilterFactory.java" target="_blank" rel="noopener">AddRequestHeader</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.cloud.gateway.filter.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddRequestHeaderGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractNameValueGatewayFilterFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(NameValueConfig config)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">ServerHttpRequest request = exchange.getRequest().mutate()</span><br><span class="line">.header(config.getName(), config.getValue())</span><br><span class="line">.build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</span><br><span class="line">&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Post类型的Filter"><a href="#Post类型的Filter" class="headerlink" title="Post类型的Filter"></a>Post类型的Filter</h2><p>对于Post类型的Filter，<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/master/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/filter/factory/SetStatusGatewayFilterFactory.java" target="_blank" rel="noopener">SetStatus</a><br>代码将会在chain.filter(exchange).then()里面的代码运行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SetStatusGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">SetStatusGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> HttpStatus status = ServerWebExchangeUtils.parse(config.status);</span><br><span class="line">        <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// check not really needed, since it is guarded in setStatusCode,</span></span><br><span class="line">                <span class="comment">// but it's a good example</span></span><br><span class="line">                <span class="keyword">if</span> (!exchange.getResponse().isCommitted()) &#123;</span><br><span class="line">                    setResponseStatus(exchange, status);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>公益Eureka Server与定制方法</title>
      <link href="/sc/sc-diy-eureka/"/>
      <url>/sc/sc-diy-eureka/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>: 本文主要简单介绍如何定制一个eureka server，并直接指出最优的定制方式。</p><a id="more"></a><h2 id="1-Spring-Cloud中国公益Eureka-Server"><a href="#1-Spring-Cloud中国公益Eureka-Server" class="headerlink" title="1. Spring Cloud中国公益Eureka Server"></a>1. Spring Cloud中国公益Eureka Server</h2><p>Eureka Server为作为Spring Cloud开发过程中常用的注册中心组件，作为基础设施组件，开发学习过程中，经常需要自己创建Eureka Server应用和重启。为了帮助开发者快速学习入门。Spring Cloud中国社区特搭建一个公益注册中心，仅作为帮助Spring Cloud的开发者进行学习和调试。为了更好服务大家，请勿对本注册中心进行压测。定制的Eureka Server注册中心UI如下所示。</p><p><img src="http://springcloud-new.oss-cn-shenzhen.aliyuncs.com/1966ed6f184d06c2ab793dcaf2c41c8b.jpeg?Expires=1841654009&amp;OSSAccessKeyId=LTAI57F52hRuWq3h&amp;Signature=OeNSoXly3WYi9wfNq3guMPq%2Bt48%3D" alt=""></p><h3 id="1-1-访问地址"><a href="#1-1-访问地址" class="headerlink" title="1.1 访问地址"></a>1.1 访问地址</h3><p> <a href="http://eureka.springcloud.cn" title="http://eureka.springcloud.cn" target="_blank" rel="noopener">http://eureka.springcloud.cn</a></p><h2 id="2-定制Eureka-Serrver的UI"><a href="#2-定制Eureka-Serrver的UI" class="headerlink" title="2.定制Eureka Serrver的UI"></a>2.定制Eureka Serrver的UI</h2><h3 id="2-1-为什么要定制Eureka-Server"><a href="#2-1-为什么要定制Eureka-Server" class="headerlink" title="2.1 为什么要定制Eureka Server"></a>2.1 为什么要定制Eureka Server</h3><p> 原因两点:</p><ul><li>1.觉得默认的UI比较丑  </li><li>2.Eureka Server想客制化一下</li></ul><blockquote><p>至于Spring Cloud Eureka的UI客制化成什么样子由你而定！</p></blockquote><h2 id="3-两种方法定制Eureka-Server"><a href="#3-两种方法定制Eureka-Server" class="headerlink" title="3. 两种方法定制Eureka Server"></a>3. 两种方法定制Eureka Server</h2><h3 id="3-1-直接修改eureka-server的源代码"><a href="#3-1-直接修改eureka-server的源代码" class="headerlink" title="3.1 直接修改eureka server的源代码"></a>3.1 直接修改eureka server的源代码</h3><p>   直接修改eureka server的源代码，该方法是最纯的方式，而且每次有一个Eureka Server的版本都需要去修改。</p><h3 id="3-2-只修改Eureka-Server的UI"><a href="#3-2-只修改Eureka-Server的UI" class="headerlink" title="3.2 只修改Eureka Server的UI"></a>3.2 只修改Eureka Server的UI</h3><p>只需要修改对应的html+css+文案即可，完全不用去修改Eureka Server的源码,强烈推荐。</p><blockquote><p>源码参考地址:<a href="https://github.com/SpringCloud/spring-cloud-eureka" target="_blank" rel="noopener">https://github.com/SpringCloud/spring-cloud-eureka</a></p></blockquote><h3 id="3-3-为什么我定制自己的UI加进去"><a href="#3-3-为什么我定制自己的UI加进去" class="headerlink" title="3.3 为什么我定制自己的UI加进去"></a>3.3 为什么我定制自己的UI加进去</h3><p> 为什么我定制自己的UI加进去，就可以直接Run，那源码代码中的UI是不是被覆盖了？<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.eureka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-server-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p><blockquote><p>如上maven配置所示，官方的spring-cloud-starter-netflix-eureka-server依赖信息配置在下面，由maven的依赖加载顺序决定，定制的UI优先加载显示。</p></blockquote><h2 id="4-如何在项目中使用DIY的Eureka-Server"><a href="#4-如何在项目中使用DIY的Eureka-Server" class="headerlink" title="4. 如何在项目中使用DIY的Eureka Server"></a>4. 如何在项目中使用DIY的Eureka Server</h2><p>只需要配置maven依赖即可:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.eureka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-server-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> Eureka Server </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Eureka Server </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway的Before路由断言工厂</title>
      <link href="/sc/gw/gw04/"/>
      <url>/sc/gw/gw04/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:在上本篇文章Spring Cloud Gateway的After路由断言工厂介绍了Spring Cloud Gateway核心概念和After路由断言，本文简单介绍Before路由断言工厂。因为比较简单所以就<code>抛砖引玉，旨在帮助大家快速入门Spring Cloud Gateway</code>，欢迎大家<code>加我微信Software_King</code>，进入Spring Cloud中国社区微信群交流。</p><a id="more"></a><h2 id="1-Spring-Cloud-Gateway核心概念"><a href="#1-Spring-Cloud-Gateway核心概念" class="headerlink" title="1. Spring Cloud Gateway核心概念"></a>1. Spring Cloud Gateway核心概念</h2><p>   网关简单的说就是提供一个对外统一的API入口和出口，统管企业对外的所有API出口。一般来说，网关对外暴露的URL或者接口信息，我们统称之为路由信息。如果研发过网关中间件，或者使用或了解过ZUUL的，网关的核心肯定是Filter以及Filter Chain(Filter责任链)。Spring Cloud Gateway也具有路由信息和Filter。下面介绍一下Spring Cloud gateway中最重要的几个概念:</p><ul><li><code>路由(route)</code>:路由是网关最基础的部分，路由信息由一个ID、一个目的url、一组断言工厂和一组Filter组成。如果路由断言工厂为真，则说明请求的Url和配置的路由匹配。</li><li><code>断言(Predicate)</code>: java 8中的断言函数。Spring Cloud Gateway中的断言函数输入类型是Spring 5.0框架中的ServerWebExchange。Spring Cloud Gateway中的断言函数允许开发者去定义匹配来自于http request中的任何信息，比如请求头和参数等。</li><li><code>过滤器(filter)</code>:一个标准的Spring webFilter。Spring Cloud Gateway中的Filter分为两种类型的Filter，分别是Gateway Filter和Global Filter.网关 Filter实例是由Spring 框架中的网关Filter的特殊工厂构造。request在转发到目前服务之前，response在返回到调用端之前都可以被修改或者自定义。</li></ul><h2 id="2-什么是Before路由断言"><a href="#2-什么是Before路由断言" class="headerlink" title="2. 什么是Before路由断言"></a>2. 什么是Before路由断言</h2><p>  <code>Before路由断言工厂</code>带有一个<code>UTC时间格式</code>的时间参数，当请求进来的<code>当前时间在路由断言工厂之前</code>会成功匹配，否则不能成功匹配。</p><h2 id="3-Before路由断言工厂的案例"><a href="#3-Before路由断言工厂的案例" class="headerlink" title="3. Before路由断言工厂的案例"></a>3. Before路由断言工厂的案例</h2><h3 id="3-1-引入pom依赖"><a href="#3-1-引入pom依赖" class="headerlink" title="3.1 引入pom依赖"></a>3.1 引入pom依赖</h3><p>pom.xml依赖配置如下所示:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-2-application-yml文件配置"><a href="#3-2-application-yml文件配置" class="headerlink" title="3.2 application.yml文件配置:"></a>3.2 application.yml文件配置:</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">before_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://xujin.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Before=2022-03-13T00:54:30.877+08:00[Asia/Shanghai]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">TRACE</span></span><br><span class="line">    <span class="string">org.springframework.http.server.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">org.springframework.web.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">reactor.ipc.netty:</span> <span class="string">DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="string">management.endpoints.web.exposure.include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gateway提供两种方式去配置Before路由断言工厂，这里介绍的是yml文件的配置方式。</p></blockquote><h3 id="3-3-等价的-Bean配置"><a href="#3-3-等价的-Bean配置" class="headerlink" title="3.3 等价的@Bean配置"></a>3.3 等价的@Bean配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">ZonedDateTime datetime = LocalDateTime.now().plusDays(<span class="number">1</span>).atZone(ZoneId.systemDefault());</span><br><span class="line"></span><br><span class="line"><span class="comment">//@formatter:off</span></span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line">.route(<span class="string">"before_route"</span>, r -&gt; r.before(datetime)</span><br><span class="line">.uri(<span class="string">"http://xujin.org"</span>))</span><br><span class="line"></span><br><span class="line">.build();</span><br><span class="line"><span class="comment">//@formatter:on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gateway提供两种方式去配置After路由断言工厂，这里介绍的是@Bean的配置方式。不管通过<code>yml文件配置或者通过@Bean</code>的方式配置是等价的。</p></blockquote><h3 id="3-4-测试如下"><a href="#3-4-测试如下" class="headerlink" title="3.4 测试如下:"></a>3.4 测试如下:</h3><p>访问<a href="http://localhost:8082/" target="_blank" rel="noopener">http://localhost:8082/</a> 成功转发到<a href="http://xujin.org。" target="_blank" rel="noopener">http://xujin.org。</a></p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway的After路由断言工厂</title>
      <link href="/sc/gw/gw03/"/>
      <url>/sc/gw/gw03/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本篇文章主要介绍了Spring Cloud Gateway核心概念和After路由断言，因为比较简单所以就<code>抛砖引玉，旨在帮助大家快速入门Spring Cloud Gateway</code>，欢迎大家<code>加我微信Software_King</code>，进入Spring Cloud中国社区微信群交流。<br><a id="more"></a></p><h2 id="1-Spring-Cloud-Gateway核心概念"><a href="#1-Spring-Cloud-Gateway核心概念" class="headerlink" title="1.Spring Cloud Gateway核心概念"></a>1.Spring Cloud Gateway核心概念</h2><p>   网关简单的说就是提供一个对外统一的API入口和出口，统管企业对外的所有API出口。一般来说，网关对外暴露的URL或者接口信息，我们统称之为路由信息。如果研发过网关中间件，或者使用或了解过ZUUL的，网关的核心肯定是Filter以及Filter Chain(Filter责任链)。Spring Cloud Gateway也具有路由信息和Filter。下面介绍一下Spring Cloud gateway中最重要的几个概念:</p><ul><li><code>路由(route)</code>:路由是网关最基础的部分，路由信息由一个ID、一个目的url、一组断言工厂和一组Filter组成。如果路由断言工厂为真，则说明请求的Url和配置的路由匹配。</li><li><code>断言(Predicate)</code>: java 8中的断言函数。Spring Cloud Gateway中的断言函数输入类型是Spring 5.0框架中的ServerWebExchange。Spring Cloud Gateway中的断言函数允许开发者去定义匹配来自于http request中的任何信息，比如请求头和参数等。</li><li><code>过滤器(filter)</code>:一个标准的Spring webFilter。Spring Cloud Gateway中的Filter分为两种类型的Filter，分别是Gateway Filter和Global Filter.网关 Filter实例是由Spring 框架中的网关Filter的特殊工厂构造。request在转发到目前服务之前，response在返回到调用端之前都可以被修改或者自定义。</li></ul><h2 id="2-什么是After路由断言"><a href="#2-什么是After路由断言" class="headerlink" title="2.什么是After路由断言"></a>2.什么是After路由断言</h2><p>   After Route Predicate Factory带有一个UTC时间格式的时间参数，当请求进来的当前时间在路由断言工厂之后会成功匹配，否则不能成功匹配。</p><h2 id="3-After路由断言工厂的案例"><a href="#3-After路由断言工厂的案例" class="headerlink" title="3.After路由断言工厂的案例"></a>3.After路由断言工厂的案例</h2><h3 id="3-1-引入pom依赖"><a href="#3-1-引入pom依赖" class="headerlink" title="3.1 引入pom依赖"></a>3.1 引入pom依赖</h3><p>pom.xml依赖配置如下所示:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-2-application-yml文件配置"><a href="#3-2-application-yml文件配置" class="headerlink" title="3.2  application.yml文件配置:"></a>3.2  application.yml文件配置:</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">after_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://xujin.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">After=2018-03-18T17:32:58.129+08:00[Asia/Shanghai]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">TRACE</span></span><br><span class="line">    <span class="string">org.springframework.http.server.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">org.springframework.web.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">reactor.ipc.netty:</span> <span class="string">DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="string">management.endpoints.web.exposure.include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gateway提供两种方式去配置After路由断言工厂，这里介绍的是yml文件的配置方式。</p></blockquote><h3 id="3-3-等价的-Bean配置"><a href="#3-3-等价的-Bean配置" class="headerlink" title="3.3 等价的@Bean配置"></a>3.3 等价的@Bean配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">ZonedDateTime minusTime = LocalDateTime.now().minusDays(<span class="number">1</span>).atZone(ZoneId.systemDefault());</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line">.route(<span class="string">"after_route"</span>, r -&gt; r.after(minusTime)</span><br><span class="line">.uri(<span class="string">"http://xujin.org"</span>))</span><br><span class="line"></span><br><span class="line">.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Spring Cloud Gateway提供两种方式去配置After路由断言工厂，这里介绍的是@Bean的配置方式。不管通过yml文件配置或者通过@Bean的方式配置是等价的。</p></blockquote><h3 id="3-4-测试如下"><a href="#3-4-测试如下" class="headerlink" title="3.4 测试如下:"></a>3.4 测试如下:</h3><p>访问<a href="http://localhost:8081/成功转发到http://xujin.org" target="_blank" rel="noopener">http://localhost:8081/成功转发到http://xujin.org</a></p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway揭秘之处理请求流程</title>
      <link href="/sc/gw/gw02/"/>
      <url>/sc/gw/gw02/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本篇文章主要从源码的角度揭秘Spring Cloud Gateway的怎么处理请求流程。</p><a id="more"></a><h2 id="1-Spring-Gateway概述"><a href="#1-Spring-Gateway概述" class="headerlink" title="1.Spring Gateway概述"></a>1.Spring Gateway概述</h2><p>   <code>Spring Cloud Gateway</code>是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代Netflix ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。</p><h2 id="2-Spring-Cloud-gateway请求入口分析"><a href="#2-Spring-Cloud-gateway请求入口分析" class="headerlink" title="2. Spring Cloud gateway请求入口分析"></a>2. Spring Cloud gateway请求入口分析</h2><p>  不管是Zuul，还是Spring Cloud Gateway还是基于Netty的自研网关，都会把请求进来的Request，或者返回的Response进行包装，转换提取为网关运行的上下文信息，而在Spring Cloud gateway中网关的上下文为ServerWebExchange。</p><h3 id="2-1-入口HttpServerRequest和HttpServerResponse转换"><a href="#2-1-入口HttpServerRequest和HttpServerResponse转换" class="headerlink" title="2.1 入口HttpServerRequest和HttpServerResponse转换"></a>2.1 入口HttpServerRequest和HttpServerResponse转换</h3><p>Spring Cloud Gateway的请求入口，org.springframework.http.server.reactive.ReactorHttpHandlerAdapter#apply方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">apply</span><span class="params">(HttpServerRequest request, HttpServerResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">NettyDataBufferFactory bufferFactory = <span class="keyword">new</span> NettyDataBufferFactory(response.alloc());</span><br><span class="line">ServerHttpRequest adaptedRequest;</span><br><span class="line">ServerHttpResponse adaptedResponse;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">adaptedRequest = <span class="keyword">new</span> ReactorServerHttpRequest(request, bufferFactory);</span><br><span class="line">adaptedResponse = <span class="keyword">new</span> ReactorServerHttpResponse(response, bufferFactory);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (URISyntaxException ex) &#123;</span><br><span class="line">logger.error(<span class="string">"Invalid URL "</span> + ex.getMessage(), ex);</span><br><span class="line">response.status(HttpResponseStatus.BAD_REQUEST);</span><br><span class="line"><span class="keyword">return</span> Mono.empty();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (adaptedRequest.getMethod() == HttpMethod.HEAD) &#123;</span><br><span class="line">adaptedResponse = <span class="keyword">new</span> HttpHeadResponseDecorator(adaptedResponse);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.httpHandler.handle(adaptedRequest, adaptedResponse)</span><br><span class="line">.doOnError(ex -&gt; logger.error(<span class="string">"Handling completed with error"</span>, ex))</span><br><span class="line">.doOnSuccess(aVoid -&gt; logger.debug(<span class="string">"Handling completed with success"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PS，代码来源于spring-web-5.0.4.RELEASE.jar<br>此方法为Spring Cloud Gateway的请求入口方法，该方法的作用就是把接收到的HttpServerRequest或者最终需要返回的HttpServerResponse，包装转换为ReactorServerHttpRequest和ReactorServerHttpResponse。</p></blockquote><h3 id="2-2-构造Spring-Cloud-gateway的上下文ServerWebExchange"><a href="#2-2-构造Spring-Cloud-gateway的上下文ServerWebExchange" class="headerlink" title="2.2 构造Spring Cloud gateway的上下文ServerWebExchange"></a>2.2 构造Spring Cloud gateway的上下文ServerWebExchange</h3><p>在org.springframework.web.server.adapter.HttpWebHandlerAdapter的182行，代码如下所示:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line">ServerWebExchange exchange = createExchange(request, response);</span><br><span class="line"><span class="keyword">return</span> getDelegate().handle(exchange)</span><br><span class="line">.onErrorResume(ex -&gt; handleFailure(request, response, ex))</span><br><span class="line">.then(Mono.defer(response::setComplete));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>createExchange()将ServerHttpRequest ServerHttpResponse构建网关上下文ServerWebExchange。</p></blockquote><hr><blockquote><p>PS:其中org.springframework.web.server.handler.WebHandlerDecorator.getDelegate()通过委托的方式获取一系列需要处理的WebHandler.</p></blockquote><h3 id="2-3-进入Filter链"><a href="#2-3-进入Filter链" class="headerlink" title="2.3 进入Filter链"></a>2.3 进入Filter链</h3><p>org.springframework.cloud.gateway.handler.FilteringWebHandler#handle方法，即77行，代码如下所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">    Route route = exchange.getRequiredAttribute(GATEWAY_ROUTE_ATTR);</span><br><span class="line">    List&lt;GatewayFilter&gt; gatewayFilters = route.getFilters();</span><br><span class="line"></span><br><span class="line">    List&lt;GatewayFilter&gt; combined = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.globalFilters);</span><br><span class="line">    combined.addAll(gatewayFilters);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> needed or cached?</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(combined);</span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">"Sorted gatewayFilterFactories: "</span>+ combined);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultGatewayFilterChain(combined).filter(exchange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-执行Filter链"><a href="#2-4-执行Filter链" class="headerlink" title="2.4 执行Filter链"></a>2.4 执行Filter链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultGatewayFilterChain</span> <span class="keyword">implements</span> <span class="title">GatewayFilterChain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; filters;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultGatewayFilterChain</span><span class="params">(List&lt;GatewayFilter&gt; filters)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.filters = filters;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.index &lt; filters.size()) &#123;</span><br><span class="line">GatewayFilter filter = filters.get(<span class="keyword">this</span>.index++);</span><br><span class="line"><span class="keyword">return</span> filter.filter(exchange, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Mono.empty(); <span class="comment">// complete</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-Gateway-Filter委托为Gloable-Filter执行"><a href="#2-5-Gateway-Filter委托为Gloable-Filter执行" class="headerlink" title="2.5 Gateway Filter委托为Gloable Filter执行"></a>2.5 Gateway Filter委托为Gloable Filter执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayFilterAdapter</span> <span class="keyword">implements</span> <span class="title">GatewayFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> GlobalFilter delegate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GatewayFilterAdapter</span><span class="params">(GlobalFilter delegate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.delegate.filter(exchange, chain);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"GatewayFilterAdapter&#123;"</span>);</span><br><span class="line">sb.append(<span class="string">"delegate="</span>).append(delegate);</span><br><span class="line">sb.append(<span class="string">'&#125;'</span>);</span><br><span class="line"><span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-6-预告待续"><a href="#2-6-预告待续" class="headerlink" title="2.6 预告待续"></a>2.6 预告待续</h3><p>在之后的文章中，将会揭秘Spring Cloud Gateway的架构设计，Filter链设计，以及启动装在流程等。</p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud 源码分析 </tag>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Gateway入门案例</title>
      <link href="/sc/gw/gw-01/"/>
      <url>/sc/gw/gw-01/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本篇文章主要介绍了什么是<code>Spring Cloud Gateway</code>，并基于Spring Cloud Gateway的Finchley.M8版本编写一个Spring Cloud Gateway的入门案例，即基本代理的路由转发配置。</p><a id="more"></a><h2 id="1-Spring-Gateway概述"><a href="#1-Spring-Gateway概述" class="headerlink" title="1.Spring Gateway概述"></a>1.Spring Gateway概述</h2><h3 id="1-1-什么是Spring-Cloud-Gateway"><a href="#1-1-什么是Spring-Cloud-Gateway" class="headerlink" title="1.1 什么是Spring Cloud Gateway"></a>1.1 什么是Spring Cloud Gateway</h3><p>   <code>Spring Cloud Gateway</code>是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代Netflix ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。</p><h2 id="2-Spring-Cloud-Gateway入门案例"><a href="#2-Spring-Cloud-Gateway入门案例" class="headerlink" title="2. Spring Cloud Gateway入门案例"></a>2. Spring Cloud Gateway入门案例</h2><h3 id="2-1-创建maven工程"><a href="#2-1-创建maven工程" class="headerlink" title="2.1 创建maven工程"></a>2.1 创建maven工程</h3><p>配置Spring  Cloud Gateway的相关Maven依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ch18-1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.springcloud.book<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ch18-1-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>ch18-1-gateway<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://springcloud.cn<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.M8<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-Spring-Cloud-Gateway主程序"><a href="#2-2-Spring-Cloud-Gateway主程序" class="headerlink" title="2.2  Spring Cloud Gateway主程序"></a>2.2  Spring Cloud Gateway主程序</h3><p>SpringCloudGatewayApplication.java，代码如下所示:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.springcloud.book.gateway;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudGatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line"><span class="comment">//basic proxy</span></span><br><span class="line">.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</span><br><span class="line">.uri(<span class="string">"http://baidu.com:80/"</span>)</span><br><span class="line">).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(SpringCloudGatewayApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-编写application-yml文件"><a href="#2-3-编写application-yml文件" class="headerlink" title="2.3 编写application.yml文件"></a>2.3 编写application.yml文件</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">spring-cloud-gateway</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">xujin_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://www.xujin.org:80/</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/xujin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.springframework.cloud.gateway:</span> <span class="string">TRACE</span></span><br><span class="line">    <span class="string">org.springframework.http.server.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">org.springframework.web.reactive:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="string">reactor.ipc.netty:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure><h3 id="2-4-基本代理路由配置等同写法"><a href="#2-4-基本代理路由配置等同写法" class="headerlink" title="2.4 基本代理路由配置等同写法"></a>2.4 基本代理路由配置等同写法</h3><p>Spring Cloud Gateway提供了两种配置路由规则的方法</p><ul><li>第一:通过@Bean自定义RouteLocator<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line"><span class="comment">//basic proxy</span></span><br><span class="line">.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</span><br><span class="line">.uri(<span class="string">"http://baidu.com:80/"</span>)</span><br><span class="line">).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><ul><li>第二:通过属于文件或者yml文件配置</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">xujin_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://www.xujin.org:80/</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/xujin</span></span><br></pre></td></tr></table></figure><blockquote><p>PS,以上两种方式等同。</p></blockquote><h3 id="2-5-错误的示范代码如下"><a href="#2-5-错误的示范代码如下" class="headerlink" title="2.5 错误的示范代码如下:"></a>2.5 错误的示范代码如下:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">routingConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Routes.locator()</span><br><span class="line">      .route(<span class="string">"xujin_route"</span>)</span><br><span class="line">      .uri(<span class="string">"http://xujin.org"</span>)</span><br><span class="line">      .predicate(host(<span class="string">"**.xujin.org"</span>))</span><br><span class="line">      .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>温馨提示，上面这种写法是基于Spring Cloud Gateway FM4的版本，相关代码已废弃，目前Spring Cloud Gateway将会在FM9之后Realese。</p></blockquote><h3 id="2-6-运行测试"><a href="#2-6-运行测试" class="headerlink" title="2.6 运行测试"></a>2.6 运行测试</h3><ol><li>访问<a href="http://localhost:8080/baidu" target="_blank" rel="noopener">http://localhost:8080/baidu</a>,路由转发到<a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a></li><li>访问<a href="http://localhost:8080/xujin" target="_blank" rel="noopener">http://localhost:8080/xujin</a>,路由转发到<a href="http://xujin.org">http://xujin.orgyml</a></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line"><span class="comment">//basic proxy</span></span><br><span class="line">.route(r -&gt; r.path(<span class="string">"/baidu"</span>)</span><br><span class="line">.uri(<span class="string">"http://baidu.com:80/"</span>)</span><br><span class="line">).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">xujin_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://www.xujin.org:80/</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/xujin</span></span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Spring Cloud Gateway </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud 源码分析 </tag>
            
            <tag> Spring Cloud Gateway </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>SC中Eureka Server的HA和安全身份验证</title>
      <link href="/sc/sc-eureka-02/"/>
      <url>/sc/sc-eureka-02/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:在《跟我学Spring Cloud》中的上一篇文章中简单介绍了使用Eureka实现服务的注册与发现。在这篇文章中主要介绍一下Eureka Server注册中心的HA以及Eureka Server的身份验证。<br><a id="more"></a></p><h2 id="什么是高可用"><a href="#什么是高可用" class="headerlink" title="什么是高可用"></a>什么是高可用</h2><h3 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h3><p>   High Availability，即高可用HA。在分布式情况下，我们经常说<code>4个9</code>(99.99%)或者<code>5个9</code>(99.999%)。举个简单例子，如果一个微服务分布式系统依赖于30个微服务，每个微服务可用性是99.99%，那么整个微服务系统的可用性就是99.99%的30次方 ≈ 99.7% ，也就是说有0.3%系统是不可用的，0.3%意味着如果<code>Qps很高</code>，有一亿次请求的话，那么就会有<code>30万</code>次失败。换算成时间<code>大约每月有2个小时服务不稳定</code>。特别是随着服务依赖数量的变多，微服务不稳定的概率会成指数性上升。因此要保证微服务应用的HA需要从各方面入手，下面会介绍一下如何实现Eureka Server的HA。参考工程如下所示。 </p><blockquote><p><code>Tips</code>：代码示例:<a href="https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-ha" target="_blank" rel="noopener">https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-ha</a></p></blockquote><p><img src="/images/sc-study/sc-eureka-ha-01.png" alt="参考工程"></p><h2 id="Eureka-Server的HA"><a href="#Eureka-Server的HA" class="headerlink" title="Eureka Server的HA"></a>Eureka Server的HA</h2><h3 id="Eureka-Server的HA-1"><a href="#Eureka-Server的HA-1" class="headerlink" title="Eureka Server的HA"></a>Eureka Server的HA</h3><h4 id="两个工程演示HA"><a href="#两个工程演示HA" class="headerlink" title="两个工程演示HA"></a>两个工程演示HA</h4><p> 如示例工程所示，我新建了两个Project分别为sc-eureka-ha-server1，sc-eureka-ha-server2， 我们知道在Eureka Server的Standalone模式下面，由于只有一个Eureka Server，所以我们通过配置如下信息关闭Eureka Server的自我注册和抓取注册信息，但是两个Eureka Server之间需要设置为True，相互注册相互感知对方注册信息的变化，从而实现信息同步。<br> 1.sc-eureka-ha-server1的application.yml配置Info 如下：</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-ha-server1</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span>                    <span class="comment"># 指定该Eureka实例的端口</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8762/eureka/</span></span><br></pre></td></tr></table></figure><p> 2.sc-eureka-ha-server2的application.yml配置Info 如下</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-ha-server2</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8762</span>                    <span class="comment"># 指定该Eureka实例的端口</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure><p> 3.主程序入口代码没什么区别如下:<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(EurekaServerApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p> 4.分别启动sc-eureka-ha-server1和sc-eureka-ha-server2，访问<a href="http://localhost:8761/" target="_blank" rel="noopener">http://localhost:8761/</a> ,<a href="http://localhost:8762/" target="_blank" rel="noopener">http://localhost:8762/</a> ，如下:<br><img src="/images/sc-study/sc-e-ha-02.png" alt="启动Eureka Server01"></p><p><img src="/images/sc-study/sc-e-ha-03.png" alt="启动Eureka Server02"></p><p> 5.服务提供者sc-eureka-ha-provider其它代码见工程,application.yml如下所示。<br> <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr"> server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8000</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-ha-provider</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure></p><blockquote><p><code>tips:</code> 把服务提供者的服务注册信息，注册到Eureka Server 01上。</p></blockquote><p>启动服务提供者，见如下图所示。<br> <img src="/images/sc-study/sc-e-ha-04.png" alt="服务提供者注册Eureka Server01"><br>片刻服务提供者的信息也同步到Eureka Server02上面<br> <img src="/images/sc-study/sc-e-ha-05.png" alt="服务提供者信息同步到Eureka Server02"></p><h4 id="Jar方式演示HA"><a href="#Jar方式演示HA" class="headerlink" title="Jar方式演示HA"></a>Jar方式演示HA</h4><p> Eureka Server的HA，其实可以通过<code>jar的方式</code>指定使用不同的<code>profile配置</code>的方式，在本地运行两个<code>Eureka Server</code>。只需将Eureka server的application.yml修改如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-ha-server</span>  </span><br><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">   profiles:</span> <span class="string">peer1</span>                                 </span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">   port:</span> <span class="number">8761</span> </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">   instance:</span></span><br><span class="line"><span class="attr">      hostname:</span> <span class="string">peer1.xujin.org</span>  </span><br><span class="line"><span class="attr">   client:</span>                                    </span><br><span class="line"><span class="attr">      serviceUrl:</span></span><br><span class="line"><span class="attr">         defaultZone:</span> <span class="attr">http://peer2.xujin.org:8762/eureka/</span> </span><br><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr"> profiles:</span> <span class="string">peer2</span> </span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">   port:</span> <span class="number">8762</span> </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">   instance:</span></span><br><span class="line"><span class="attr">      hostname:</span> <span class="string">peer2.xujin.org</span></span><br><span class="line"><span class="attr">   client:</span></span><br><span class="line"><span class="attr">     serviceUrl:</span></span><br><span class="line"><span class="attr">        defaultZone:</span> <span class="attr">http://peer1.xujin.org:8761/eureka/</span></span><br></pre></td></tr></table></figure></p><p>通过配置switcHosts或者自行配置HostName对应的IP地址,把工程打成jar之后，运行如下命令<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> java -jar sc-eureka-ha-server1-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer2</span><br><span class="line"></span><br><span class="line">java -jar sc-eureka-ha-server1-0.0.1-SNAPSHOT.jar --spring.profiles.active=peer1</span><br></pre></td></tr></table></figure></p><p>测试如下:<br><img src="/images/sc-study/sc-e-ha-06.png" alt="访问Eureka Server HA验证"><br><img src="/images/sc-study/sc-e-ha-07.png" alt="访问Eureka Server HA验证"></p><h2 id="安全身份验证"><a href="#安全身份验证" class="headerlink" title="安全身份验证"></a>安全身份验证</h2><p>   如果客户端的eureka.client.serviceUrl.defaultZone参数值(即Eureka Server的地址)中包含HTTP Basic Authentication信息，如<a href="http://user:password@localhost:8761/eureka" target="_blank" rel="noopener">http://user:password@localhost:8761/eureka</a>，那么客户端就会自动使用该用户名、密码信息与Eureka服务端进行验证。如果你需要更复杂的验证逻辑，你必须注册一个DiscoveryClientOptionalArgs组件，并将ClientFilter组件注入，在这里定义的逻辑会在每次客户端向服务端发起请求时执行。</p><blockquote><p><code>Tips</code>：代码示例:<a href="https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-security" target="_blank" rel="noopener">https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-security</a></p></blockquote><h3 id="访问Eureka-Server安全身份验证"><a href="#访问Eureka-Server安全身份验证" class="headerlink" title="访问Eureka Server安全身份验证"></a>访问Eureka Server安全身份验证</h3><ol><li><p>如工程sc-eureka-securit中的sc-eureka-security-server工程所示，在pom.xml中增加依赖如下:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>application.yml如下</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">  server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span>                    <span class="comment"># 指定该Eureka实例的端口</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line">    <span class="comment">#表示是否将自己注册到Eureka Server上，默认为true，当前应用为Eureka Server所以无需注册</span></span><br><span class="line"><span class="attr">    registerWithEureka:</span> <span class="literal">false</span>  </span><br><span class="line">    <span class="comment">#表示是否从Eureka Server获取注册信息，默认为true。因为这是一个单点的Eureka Server，不需要同步其他的Eureka Server节点的数据，故而设为false。 </span></span><br><span class="line"><span class="attr">    fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#Eureka Server的访问地址，服务注册和client获取服务注册信息均通过该URL，多个服务注册地址用,隔开</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">  basic:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">     name:</span> <span class="string">xujin</span></span><br><span class="line"><span class="attr">     password:</span> <span class="number">123</span></span><br></pre></td></tr></table></figure><p>3.启动Eureka server测试，如下图所示<br><img src="/images/sc-study/sc-e-s-01.png" alt="访问Eureka Server安全验证"></p><h3 id="服务提供者注册Eureka-Server安全身份验证"><a href="#服务提供者注册Eureka-Server安全身份验证" class="headerlink" title="服务提供者注册Eureka Server安全身份验证"></a>服务提供者注册Eureka Server安全身份验证</h3><p>1.服务提供者只需注册时修改application.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr"> server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8000</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">sc-eureka-security-provider</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://xujin:123@localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure><blockquote><p>Tips:如上所示:<a href="http://用户名:密码@localhost:8761/eureka/" target="_blank" rel="noopener">http://用户名:密码@localhost:8761/eureka/</a></p></blockquote></li></ol>]]></content>
      
      <categories>
          
          <category> 跟我学Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Eureka </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>使用Spring Cloud Eureka实现服务注册与发现</title>
      <link href="/sc/sc-eureka-01/"/>
      <url>/sc/sc-eureka-01/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:由于目前，<code>网上的Spring Cloud的学习的案列</code>，比较<code>凌乱</code>而且<code>没有形成整个体系</code>，因此特开一个专题为<code>跟我学Spring Cloud</code>，希望帮助到<code>有需要的人</code>。本文主要介绍如何使用<code>Spring Cloud中的Eureka组件</code>快速实现<code>微服务的服务注册与发现</code>。至于安全模式和Eureka Server的HA,后面的文章会详细介绍。如果您觉得，有想了解的内容，参与评论留言。<br><a id="more"></a></p><h2 id="什么是服务注册与发现"><a href="#什么是服务注册与发现" class="headerlink" title="什么是服务注册与发现"></a>什么是服务注册与发现</h2><h3 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h3><p>   在服务化的早期，服务不是很多，服务的注册与发现并不是什么新鲜的名词，Nginx+内部域名服务器方式，甚至Nginx+host文件配置方式也能完成服务的注册与发现。服务上下线需要在nginx,服务器做相应的配置，一旦服务的IP端口发生变化，都需要在nginx上做相应的配置，为了解决这个问题引入服务注册中心。<br>   服务注册,即服务在启动的时候就将服务的IP,端口,版本号等EndPoint注册到注册中心(Eueka,Zookeeper,Consul)对服务进行统一管理.<br>   服务发现,简单的就是说，不管服务上下线，当对某个服务发起请求时，能够快速的从本地缓存或者注册中心的注册列表中，快速找到服务提供者。</p><h2 id="服务化早期的做法"><a href="#服务化早期的做法" class="headerlink" title="服务化早期的做法"></a>服务化早期的做法</h2><h3 id="示例工程说明"><a href="#示例工程说明" class="headerlink" title="示例工程说明"></a>示例工程说明</h3><blockquote><p><code>Tips</code>：代码示例:<a href="https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-first" target="_blank" rel="noopener">https://github.com/SoftwareKing/spring-cloud-study/tree/master/sc-eureka-first</a></p></blockquote><p><img src="/images/sc-study/sc-e-p.png" alt="参考工程"></p><h3 id="Spring-MVC中基于无状态的REST"><a href="#Spring-MVC中基于无状态的REST" class="headerlink" title="Spring MVC中基于无状态的REST"></a>Spring MVC中基于无状态的REST</h3><p>   工程可以参考sc-rest-demo下面的sc-rest-provider和sc-rest-consumer，具体使用如下代码所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/sc"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从属性文件中读取服务提供的URL</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;order.orderServiceUrl&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String orderServiceUrl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/consumer/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> OrderModel <span class="title">getOrderInfo</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line"><span class="comment">// this.restTemplate.getForObject("http://localhost:8000/sc/order/" +</span></span><br><span class="line"><span class="comment">// id,OrderModel.class);</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(<span class="keyword">this</span>.orderServiceUrl + <span class="string">"/sc/order/"</span> + id,</span><br><span class="line">OrderModel.class);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>大家注意到没，把<a href="http://localhost:8000" target="_blank" rel="noopener">http://localhost:8000</a> ,硬编码到程序中，是不是比较low。可以采用上面代码中的方式：orderServiceUrl解决。但是这样还是比较low,下面介绍一下引入Eureka实现服务注册与发现的处理。</p></blockquote><h2 id="使用Eureka实现服务的注册与发现"><a href="#使用Eureka实现服务的注册与发现" class="headerlink" title="使用Eureka实现服务的注册与发现"></a>使用Eureka实现服务的注册与发现</h2><h3 id="搭建注册中心-Eureka-Server"><a href="#搭建注册中心-Eureka-Server" class="headerlink" title="搭建注册中心-Eureka Server"></a>搭建注册中心-Eureka Server</h3><p>  1.引入依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入spring boot的依赖 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sc-eureka-first-server-HA01<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>sc-eureka-first-server-HA01<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入Spring Cloud Eureka依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 引入spring cloud的依赖 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Camden.SR5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 添加spring-boot的maven插件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><ol><li>在Resources目录下创建application.yml<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span>                    <span class="comment"># 指定该Eureka实例的端口</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line">    <span class="comment">#表示是否将自己注册到Eureka Server上，默认为true，当前应用为Eureka Server所以无需注册</span></span><br><span class="line"><span class="attr">    registerWithEureka:</span> <span class="literal">false</span>  </span><br><span class="line">    <span class="comment">#表示是否从Eureka Server获取注册信息，默认为true。因为这是一个单点的Eureka Server，不需要同步其他的Eureka Server节点的数据，故而设为false。 </span></span><br><span class="line"><span class="attr">    fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#Eureka Server的访问地址，服务注册和client获取服务注册信息均通过该URL，多个服务注册地址用,隔开</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参考文档：http://projects.spring.io/spring-cloud/docs/1.0.3/spring-cloud.html#_standalone_mode</span></span><br><span class="line"><span class="comment"># 参考文档：http://my.oschina.net/buwei/blog/618756</span></span><br></pre></td></tr></table></figure></li></ol><p>3.创建Spring Boot主应用程序启动代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.eureka.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Eureka Server</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xujin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudEurekaServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(SpringCloudEurekaServer.class, args);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>启动Eureka server测试：<br>  启动sc-eureka-first-server-HA01，访问<a href="http://localhost:8761/" target="_blank" rel="noopener">http://localhost:8761/</a> ,如下图所示:</p><p>  <img src="/images/sc-study/sc-e-1.png" alt="Eureka server"></p><h3 id="创建服务提供者"><a href="#创建服务提供者" class="headerlink" title="创建服务提供者"></a>创建服务提供者</h3><p>  1.服务提供者，为了演示在这里提供一个简单的<code>订单查询服务</code>，如工程<code>sc-eureka-first-provider01</code>和<code>sc-eureka-first-provider02</code>所示。<br>  2.主程序入口代码，如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.eureka.first.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务提供者端，加上<span class="doctag">@EnableDiscoveryClient</span>注解，完成服务注册。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xujin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@site</span> http://xujin.org</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="comment">// @EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderProviderSpringBootAppliaction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(OrderProviderSpringBootAppliaction.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p><code>Tips</code>:如果使用Eureka, 可以使用@EnableEurekaClient注解，但是推荐使用@EnableDiscoveryClient代替@EnableEurekaClient注解，因为@EnableDiscoveryClient是一个高度的抽象， 来自于spring-cloud-commons， 由于Spring Cloud选型是中立的因此抽象出该接口， 当服务注册中心选型改变为Eureka，ZK，Consul时，不需要修改原有代码中的注解。</p></blockquote><p>3.服务提供者暴露的服务-OrderController.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/sc/order/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> OrderModel <span class="title">findOrderById</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">OrderModel orderModel = orderService.findOrderByOrderId(id);</span><br><span class="line"><span class="keyword">return</span> orderModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>启动服务提供者，把服务注册信息，注册到Eureka Server注册中心<br>启动sc-eureka-first-provider01,当启动其中一个服务后刷新Eureka Server会出现安全模式,如下图所示:<br><img src="/images/sc-study/sc-e-safe.png" alt="安全模式"></p><p>启动sc-eureka-first-provider02，刷新Eureka Server如下图所示。<br><img src="/images/sc-study/sc-e-safe-2.png" alt="安全模式"></p><h3 id="创建服务消费者"><a href="#创建服务消费者" class="headerlink" title="创建服务消费者"></a>创建服务消费者</h3><p> 服务消费者主要是一个简单的用户服务，用户服务查询订单服务的订单信息。<br> 1.引入相应的依赖<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xujin.sc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sc-eureka-first-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>sc-eureka-first-consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 引入spring boot的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 引入spring cloud的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>Camden.SR4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 添加spring-boot的maven插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2.主程序入口代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xujin.sc.eureka.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消费者端加入服务发现注解</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(UserConsumerApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ol><li>消费者调用Controller。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(UserController.class);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">// discoveryClient获取服务列表中，应用名为sc-eureka-first-provider一个服务注册信息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serviceUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">List&lt;ServiceInstance&gt; list = discoveryClient</span><br><span class="line">.getInstances(<span class="string">"sc-eureka-first-provider"</span>);</span><br><span class="line"><span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> String.valueOf(list.get(<span class="number">0</span>).getUri());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/sc/user/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Order <span class="title">findByIdByEurekaServer</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">String providerServiceUrl = serviceUrl();</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(providerServiceUrl + <span class="string">"sc/order/"</span> + id,</span><br><span class="line">Order.class);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>如上述代码，所示使用<code>discoveryClient.getInstances(&quot;sc-eureka-first-provider&quot;)</code>获取服务名为<code>sc-eureka-first-provider</code>的服务注册列表信息。</p></blockquote><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>先后启动sc-eureka-first-consumer,如没有异常，打开浏览器访问:<a href="http://localhost:8010/sc/user/2" target="_blank" rel="noopener">http://localhost:8010/sc/user/2</a> ,debug如下所示可以看到<br><img src="/images/sc-study/sc-e-consumer-1.png" alt="服务提供者端服务发现"></p><p>在刷新一下Eureka Server，如图下所示,此时安全模式关闭。<br><img src="/images/sc-study/sc-e-safe-3.png" alt="Eureka Server"></p><blockquote><p>关于安全模式，在本篇文章中，暂不讨论，后面将会专写一篇文章介绍，请暂时忽略。</p></blockquote><h3 id="获取消费者获取服务端消费列表"><a href="#获取消费者获取服务端消费列表" class="headerlink" title="获取消费者获取服务端消费列表"></a>获取消费者获取服务端消费列表</h3><ol><li><p>使用EurekaClient获取服务注册信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EurekaClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serviceUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InstanceInfo instance = discoveryClient.getNextServerFromEureka(<span class="string">"STORES"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> instance.getHomePageUrl();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>使用DiscoveryClient获取服务注册信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serviceUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">"STORES"</span>);</span><br><span class="line">    <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> list.get(<span class="number">0</span>).getUri();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参考链接：<a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/master/docs/src/main/asciidoc/spring-cloud-netflix.adoc" target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-netflix/blob/master/docs/src/main/asciidoc/spring-cloud-netflix.adoc</a></p></li></ol><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p> 上面这个例子使用Eureka实现了服务的注册与发现，但是有一个问题就是获取服务注册列表的方式比较low并且太方便，还有一个问题就是没有使用负载均衡（Load Balance)，这样就没法实现微服务的HA。在后面的文章将会介绍Eureka Server的HA和使用Robbin实现LB。。</p>]]></content>
      
      <categories>
          
          <category> 跟我学Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Eureka </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Eureka服务下线(Cancel)源码分析</title>
      <link href="/sc/sc-eureka-cancle/"/>
      <url>/sc/sc-eureka-cancle/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:在本篇文章中主要对Eureka的Cancel(服务下线)进行源码分析，在Service Provider服务shut down的时候，需要及时通知Eureka Server把自己剔除，从而避免其它客户端调用已经下线的服务，导致服务不可用。</p><h2 id="Cancel-服务下线"><a href="#Cancel-服务下线" class="headerlink" title="Cancel(服务下线)"></a>Cancel(服务下线)</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>在Service Provider服务shut down的时候，需要及时通知Eureka Server把自己剔除，从而避免客户端调用已经下线的服务。</p><h2 id="服务提供者端源码分析"><a href="#服务提供者端源码分析" class="headerlink" title="服务提供者端源码分析"></a>服务提供者端源码分析</h2><ol><li>在eureka-client-1.4.1中的com.netflix.discovery.DiscoveryClient中shutdown()的<code>867</code>行。<a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Shuts down Eureka Client. Also sends a deregistration request to the</span></span><br><span class="line"><span class="comment">    * eureka server.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PreDestroy</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (isShutdown.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">           logger.info(<span class="string">"Shutting down DiscoveryClient ..."</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (statusChangeListener != <span class="keyword">null</span> &amp;&amp; applicationInfoManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">               applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           cancelScheduledTasks();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If APPINFO was registered</span></span><br><span class="line">           <span class="keyword">if</span> (applicationInfoManager != <span class="keyword">null</span> &amp;&amp; clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">               applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN);</span><br><span class="line">               <span class="comment">//调用下线接口</span></span><br><span class="line">               unregister();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (eurekaTransport != <span class="keyword">null</span>) &#123;</span><br><span class="line">               eurekaTransport.shutdown();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           heartbeatStalenessMonitor.shutdown();</span><br><span class="line">           registryStalenessMonitor.shutdown();</span><br><span class="line"></span><br><span class="line">           logger.info(<span class="string">"Completed shut down of DiscoveryClient"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ol><blockquote><p><code>Tips</code> <code>@PreDestroy</code>注解或<code>shutdown()</code>的方法是服务下线的入口</p></blockquote><ol><li>在eureka-client-1.4.1中的<code>com.netflix.discovery.DiscoveryClient</code>中<code>unregister（）</code>的<code>897</code>行<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * unregister w/ the eureka service.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">unregister</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// It can be null if shouldRegisterWithEureka == false</span></span><br><span class="line">  <span class="keyword">if</span>(eurekaTransport != <span class="keyword">null</span> &amp;&amp; eurekaTransport.registrationClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         logger.info(<span class="string">"Unregistering ..."</span>);</span><br><span class="line">         <span class="comment">//发送服务下线请求</span></span><br><span class="line">         EurekaHttpResponse&lt;Void&gt; httpResponse = eurekaTransport.registrationClient.cancel(instanceInfo.getAppName(), instanceInfo.getId());</span><br><span class="line">         logger.info(PREFIX + appPathIdentifier + <span class="string">" - deregister  status: "</span> + httpResponse.getStatusCode());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(PREFIX + appPathIdentifier + <span class="string">" - de-registration failed"</span> + e.getMessage(), e);</span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Eureka-Server服务下线实现细节"><a href="#Eureka-Server服务下线实现细节" class="headerlink" title="Eureka Server服务下线实现细节"></a>Eureka Server服务下线实现细节</h2><ol><li><p>在<code>com.netflix.eureka.resources.InstanceResource</code>中的<code>280</code>行中的<code>cancelLease()</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DELETE</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">cancelLease</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params"> @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</span><br><span class="line">   <span class="comment">//调用cancel</span></span><br><span class="line">   <span class="keyword">boolean</span> isSuccess = registry.cancel(app.getName(), id,</span><br><span class="line">                <span class="string">"true"</span>.equals(isReplication));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">     logger.debug(<span class="string">"Found (Cancel): "</span> + app.getName() + <span class="string">" - "</span> + id);</span><br><span class="line">            <span class="keyword">return</span> Response.ok().build();</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     logger.info(<span class="string">"Not Found (Cancel): "</span> + app.getName() + <span class="string">" - "</span> + id);</span><br><span class="line">            <span class="keyword">return</span> Response.status(Status.NOT_FOUND).build();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在<code>org.springframework.cloud.netflix.eureka.server.InstanceRegistry</code>中的<code>95</code>行的<code>cancel()</code>方法，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(String appName, String serverId, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">   handleCancelation(appName, serverId, isReplication);</span><br><span class="line">   <span class="comment">//调用父类中的cancel</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">super</span>.cancel(appName, serverId, isReplication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在<code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</code>中的<code>376</code>行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">super</span>.cancel(appName, id, isReplication)) &#123;</span><br><span class="line">            <span class="comment">//服务下线成功后，同步更新信息到其它Eureka Server节点</span></span><br><span class="line">            replicateToPeers(Action.Cancel, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute)</span></span><br><span class="line">                    <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin - <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</span><br><span class="line">                            (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>4.在com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl中的<code>618</code>行，主要接口实现方式和register基本一致：首先更新自身Eureka Server中服务的状态，再同步到其它Eureka Server中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateToPeers</span><span class="params">(Action action, String appName, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InstanceInfo info <span class="comment">/* optional */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InstanceStatus newStatus <span class="comment">/* optional */</span>, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = action.getTimer().start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isReplication) &#123;</span><br><span class="line">                numberOfReplicationsLastMin.increment();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If it is a replication already, do not replicate again as this will create a poison replication</span></span><br><span class="line">            <span class="keyword">if</span> (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 同步把服务信息同步到其它的Eureka Server中</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123;</span><br><span class="line">                <span class="comment">// If the url represents this host, do not replicate to yourself.</span></span><br><span class="line">                <span class="keyword">if</span> (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//根据action做相应操作的同步</span></span><br><span class="line">                replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            tracer.stop();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>至此，Eureka服务续约源码分析结束，大家有兴趣可自行阅读。</p><h3 id="源码分析链接"><a href="#源码分析链接" class="headerlink" title="源码分析链接"></a>源码分析链接</h3><p> 其它源码分析链接:<br> Spring Cloud中@EnableEurekaClient源码分析:<br> <a href="http://xujin.org/sc/sc-enableEurekaClient-annonation/">http://xujin.org/sc/sc-enableEurekaClient-annonation/</a><br> Spring Cloud Eureka服务注册源码分析：<br> <a href="http://xujin.org/sc/sc-eureka-register/">http://xujin.org/sc/sc-eureka-register/</a><br> Spring Cloud Eureka服务续约(Renew)源码分析<br> <a href="http://xujin.org/sc/sc-eureka-renew/">http://xujin.org/sc/sc-eureka-renew/</a></p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Eureka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Eureka </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Eureka服务续约(Renew)源码分析</title>
      <link href="/sc/sc-eureka-renew/"/>
      <url>/sc/sc-eureka-renew/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:在本篇文章中主要对Eureka的Renew(服务续约)，从服务提供者发起续约请求开始分析，通过阅读源码和画时序图的方式，展示Eureka服务续约的整个生命周期。服务续约主要是把服务续约的信息更新到自身的Eureka Server中，然后再同步到其它Eureka Server中。</p><h2 id="1-Renew-服务续约"><a href="#1-Renew-服务续约" class="headerlink" title="1. Renew(服务续约)"></a>1. Renew(服务续约)</h2><h3 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h3><p>Renew（服务续约）操作由Service Provider定期调用，类似于heartbeat。目的是隔一段时间Service Provider调用接口，告诉Eureka Server它还活着没挂，不要把它T了。通俗的说就是它们两之间的心跳检测，避免服务提供者被剔除掉。<br>请参考:<a href="http://blog.xujin.org/sc/sc-eureka-mid/#名词解释" target="_blank" rel="noopener">Spring Cloud Eureka名词解释</a><br><a id="more"></a></p><h3 id="1-2-服务续约配置"><a href="#1-2-服务续约配置" class="headerlink" title="1.2 服务续约配置"></a>1.2 服务续约配置</h3><p>  Renew操作会在Service Provider定时发起，用来通知Eureka Server自己还活着。 这里有两个比较重要的配置需要如下，可以在Run之前配置。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.leaseRenewalIntervalInSeconds</span><br></pre></td></tr></table></figure></p><p>  Renew频率。默认是<code>30秒</code>，也就是每30秒会向Eureka Server发起Renew操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.leaseExpirationDurationInSeconds</span><br></pre></td></tr></table></figure></p><p> 服务失效时间。默认是<code>90秒</code>，也就是如果Eureka Server在90秒内没有接收到来自Service Provider的Renew操作，就会把<code>Service Provider剔除</code>。</p><h2 id="2-Renew源码分析"><a href="#2-Renew源码分析" class="headerlink" title="2. Renew源码分析"></a>2. Renew源码分析</h2><h3 id="2-1-服务提供者实现细节"><a href="#2-1-服务提供者实现细节" class="headerlink" title="2.1 服务提供者实现细节"></a>2.1 服务提供者实现细节</h3><p> 服务提供者发发起服务续约的时序图，如下图所示,大家先直观的看一下时序图，等阅读完源码再回顾一下。<br><img src="/images/spring-cloud-netflix/eureka/service-renew.png" alt="服务提供者发起续约时序图"></p><ol><li>在com.netflix.discovery.DiscoveryClient.initScheduledTasks()中的1272行，TimedSupervisorTask会定时发起服务续约，代码如下所示:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Heartbeat timer</span></span><br><span class="line">  scheduler.schedule(</span><br><span class="line">     <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">            <span class="string">"heartbeat"</span>,</span><br><span class="line">             scheduler,</span><br><span class="line">             heartbeatExecutor,</span><br><span class="line">             renewalIntervalInSecs,</span><br><span class="line">             TimeUnit.SECONDS,</span><br><span class="line">             expBackOffBound,</span><br><span class="line">              <span class="keyword">new</span> HeartbeatThread()</span><br><span class="line">            ),</span><br><span class="line">  renewalIntervalInSecs, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure></li></ol><p>2.在com.netflix.discovery.DiscoveryClient中的1393行，有一个<code>HeartbeatThread</code>线程发起续约操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">//调用eureka-client中的renew</span></span><br><span class="line">            <span class="keyword">if</span> (renew()) &#123;</span><br><span class="line">                lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>renew()调用eureka-client-1.4.11.jarcom.netflix.discovery.DiscoveryClient中<code>829</code>行renew()发起<code>PUT Reset</code>请求，调用com.netflix.eureka.resources.InstanceResource中的renewLease()续约。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Renew with the eureka service by making the appropriate REST call</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="keyword">null</span>);</span><br><span class="line">           logger.debug(<span class="string">"&#123;&#125; - Heartbeat status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">           <span class="keyword">if</span> (httpResponse.getStatusCode() == <span class="number">404</span>) &#123;</span><br><span class="line">               REREGISTER_COUNTER.increment();</span><br><span class="line">               logger.info(<span class="string">"&#123;&#125; - Re-registering apps/&#123;&#125;"</span>, PREFIX + appPathIdentifier, instanceInfo.getAppName());</span><br><span class="line">               <span class="keyword">return</span> register();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">200</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">           logger.error(<span class="string">"&#123;&#125; - was unable to send heartbeat!"</span>, PREFIX + appPathIdentifier, e);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><h3 id="2-2-Netflix中的Eureka-Core实现细节"><a href="#2-2-Netflix中的Eureka-Core实现细节" class="headerlink" title="2.2 Netflix中的Eureka Core实现细节"></a>2.2 Netflix中的Eureka Core实现细节</h3><p>   NetFlix中Eureka Core中的服务续约时序图，如下图所示。<br>  <img src="/images/spring-cloud-netflix/eureka/eureka-renew.png" alt="服务续约时序图"></p><ol><li><p>打开<code>com.netflix.eureka.resources.InstanceResource</code>中的<code>106</code>行的<code>renewLease()</code>方法，代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PeerAwareInstanceRegistry registry</span><br><span class="line"><span class="meta">@PUT</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">renewLease</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"overriddenstatus"</span>)</span> String overriddenStatus,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"status"</span>)</span> String status,</span></span><br><span class="line"><span class="function">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isFromReplicaNode = <span class="string">"true"</span>.equals(isReplication);</span><br><span class="line">    <span class="comment">//调用</span></span><br><span class="line">    <span class="keyword">boolean</span> isSuccess = registry.renew(app.getName(), id, isFromReplicaNode);</span><br><span class="line">    <span class="comment">//其余省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>点开registry.renew(app.getName(), id, isFromReplicaNode);我们可以看到，调用了<code>org.springframework.cloud.netflix.eureka.server.InstanceRegistry</code>中的<code>renew（）</code>方法，代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String serverId,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">log(<span class="string">"renew "</span> + appName + <span class="string">" serverId "</span> + serverId + <span class="string">", isReplication &#123;&#125;"</span></span><br><span class="line">+ isReplication);</span><br><span class="line">List&lt;Application&gt; applications = getSortedApplications();</span><br><span class="line"><span class="keyword">for</span> (Application input : applications) &#123;</span><br><span class="line"><span class="keyword">if</span> (input.getName().equals(appName)) &#123;</span><br><span class="line">InstanceInfo instance = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">for</span> (InstanceInfo info : input.getInstances()) &#123;</span><br><span class="line"><span class="keyword">if</span> (info.getHostName().equals(serverId)) &#123;</span><br><span class="line">instance = info;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">publishEvent(<span class="keyword">new</span> EurekaInstanceRenewedEvent(<span class="keyword">this</span>, appName, serverId,</span><br><span class="line">instance, isReplication));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">//调用com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl中的renew方法</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.renew(appName, serverId, isReplication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>3.从<code>super.renew()</code>看到调用了父类中的<code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</code>中<code>420</code>行的<code>renew()</code>方法，代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//服务续约成功，</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">super</span>.renew(appName, id, isReplication)) &#123;</span><br><span class="line">            <span class="comment">//然后replicateToPeers同步其它Eureka Server中的数据</span></span><br><span class="line">            replicateToPeers(Action.Heartbeat, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3.1 从上面代码中<code>super.renew(appName, id, isReplication)</code>可以看出调用的是com.netflix.eureka.registry.AbstractInstanceRegistry中<code>345</code>行的renew()方法，代码如下所示<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">      RENEW.increment(isReplication);</span><br><span class="line">      Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</span><br><span class="line">      Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">          leaseToRenew = gMap.get(id);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (leaseToRenew == <span class="keyword">null</span>) &#123;</span><br><span class="line">          RENEW_NOT_FOUND.increment(isReplication);</span><br><span class="line">          logger.warn(<span class="string">"DS: Registry: lease doesn't exist, registering resource: &#123;&#125; - &#123;&#125;"</span>, appName, id);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          InstanceInfo instanceInfo = leaseToRenew.getHolder();</span><br><span class="line">          <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// touchASGCache(instanceInfo.getASGName());</span></span><br><span class="line">              InstanceStatus overriddenInstanceStatus = <span class="keyword">this</span>.getOverriddenInstanceStatus(</span><br><span class="line">                      instanceInfo, leaseToRenew, isReplication);</span><br><span class="line">              <span class="keyword">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;</span><br><span class="line">                  logger.info(<span class="string">"Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;"</span></span><br><span class="line">                          + <span class="string">"; re-register required"</span>, instanceInfo.getId());</span><br><span class="line">                  RENEW_NOT_FOUND.increment(isReplication);</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;</span><br><span class="line">                  Object[] args = &#123;</span><br><span class="line">                          instanceInfo.getStatus().name(),</span><br><span class="line">                          instanceInfo.getOverriddenStatus().name(),</span><br><span class="line">                          instanceInfo.getId()</span><br><span class="line">                  &#125;;</span><br><span class="line">                  logger.info(</span><br><span class="line">                          <span class="string">"The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. "</span></span><br><span class="line">                                  + <span class="string">"Hence setting the status to overridden status"</span>, args);</span><br><span class="line">                  instanceInfo.setStatus(overriddenInstanceStatus);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          renewsLastMin.increment();</span><br><span class="line">          leaseToRenew.renew();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>其中 <code>leaseToRenew.renew()</code>是调用com.netflix.eureka.lease.Lease<t>中的<code>62</code>行的renew()方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Renew the lease, use renewal duration if it was specified by the</span></span><br><span class="line"><span class="comment"> * associated &#123;<span class="doctag">@link</span> T&#125; during registration, otherwise default duration is</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #DEFAULT_DURATION_IN_SECS&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    lastUpdateTimestamp = System.currentTimeMillis() + duration;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></t></p><p>3.2 replicateToPeers(Action.Heartbeat, appName, id, null, null, isReplication);调用自身的<code>replicateToPeers()</code>方法，在com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl中的<code>618</code>行，主要接口实现方式和register基本一致：首先更新自身Eureka Server中服务的状态，再同步到其它Eureka Server中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateToPeers</span><span class="params">(Action action, String appName, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InstanceInfo info <span class="comment">/* optional */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  InstanceStatus newStatus <span class="comment">/* optional */</span>, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = action.getTimer().start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isReplication) &#123;</span><br><span class="line">                numberOfReplicationsLastMin.increment();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If it is a replication already, do not replicate again as this will create a poison replication</span></span><br><span class="line">            <span class="keyword">if</span> (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 同步把续约信息同步到其它的Eureka Server中</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123;</span><br><span class="line">                <span class="comment">// If the url represents this host, do not replicate to yourself.</span></span><br><span class="line">                <span class="keyword">if</span> (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//根据action做相应操作的同步</span></span><br><span class="line">                replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            tracer.stop();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>至此，Eureka服务续约源码分析结束，大家有兴趣可自行阅读。</p><h3 id="2-3-源码分析链接"><a href="#2-3-源码分析链接" class="headerlink" title="2.3 源码分析链接"></a>2.3 源码分析链接</h3><p> 其它源码分析链接:<br> Spring Cloud中@EnableEurekaClient源码分析:<br> <a href="http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/</a><br> Spring Cloud Eureka服务注册源码分析：<br> <a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-register/</a></p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Eureka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Eureka </tag>
            
            <tag> Spring Cloud 源码分析 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud中@EnableEurekaClient源码分析</title>
      <link href="/sc/sc-enableEurekaClient-annonation/"/>
      <url>/sc/sc-enableEurekaClient-annonation/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:在这篇文章中主要介绍一下Spring Cloud中的@EnableEurekaClient注解，从源码的角度分析是如何work的，让大家能了解Spring Cloud如何通过@EnableEurekaClient注解对NetFlix Eureka Client进行封装为它所用。</p><h2 id="NetFlix-Eureka-client简介"><a href="#NetFlix-Eureka-client简介" class="headerlink" title="NetFlix Eureka client简介"></a>NetFlix Eureka client简介</h2><h3 id="NetFlix-Eureka-client"><a href="#NetFlix-Eureka-client" class="headerlink" title="NetFlix Eureka client"></a>NetFlix Eureka client</h3><p><code>Eureka client</code> 负责与<code>Eureka Server</code> 配合向外提供注册与发现服务接口。首先看下eureka client是怎么定义，Netflix的 eureka client的行为在<code>LookupService</code>中定义，Lookup service for finding active instances，定义了，从outline中能看到起“规定”了如下几个最基本的方法。<br>服务发现必须实现的基本类：com.netflix.discovery.shared.LookupService<t>，可以自行查看源码。</t></p><h2 id="Eureka-client与Spring-Cloud类关系"><a href="#Eureka-client与Spring-Cloud类关系" class="headerlink" title="Eureka client与Spring Cloud类关系"></a>Eureka client与Spring Cloud类关系</h2><p> Eureka client与Spring Cloud Eureka Client类图，如下所示:<br><img src="/images/spring-cloud-netflix/eureka/anoation/class.png" alt="类关系图"><br>在上图中，我加了前缀，带有<code>S</code>的是Spring Cloud封装的，带有<code>N</code>是NetFlix原生的。<br><a id="more"></a></p><ol><li>org.springframework.cloud.netflix.eureka.EurekaDiscoveryClient中<code>49</code>行的eurekaClient就是com.netflix.discovery.EurekaClient，代码如下所示:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaDiscoveryClient</span> <span class="keyword">implements</span> <span class="title">DiscoveryClient</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DESCRIPTION = <span class="string">"Spring Cloud Eureka Discovery Client"</span>;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> EurekaInstanceConfig config;</span><br><span class="line"> <span class="comment">// Netflix中的Eureka Client</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> EurekaClient eurekaClient;</span><br><span class="line"> <span class="comment">//其余省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><blockquote><p><code>Tips</code>:org.springframework.cloud.netflix.eureka.EurekaDiscoveryClient实现了DiscoveryClient，并依赖于com.netflix.discovery.EurekaClient</p></blockquote><ol><li><p>点开com.netflix.discovery.EurekaClient查看代码，可以看出EurekaClient继承了LookupService并实现了EurekaClient接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImplementedBy</span>(DiscoveryClient.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EurekaClient</span> <span class="keyword">extends</span> <span class="title">LookupService</span> </span>&#123;</span><br><span class="line">  <span class="comment">//其余省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>com.netflix.discovery.DiscoveryClient是netflix使用的客户端，从其class的注释可以看到他主要做这几件事情：<br>a) Registering the instance with Eureka Server<br>b) Renewalof the lease with Eureka Server<br>c) Cancellation of the lease from Eureka Server during shutdown</p></li></ol><p>其中<code>com.netflix.discovery.DiscoveryClient</code>实现了<code>com.netflix.discovery.EurekaClient</code>,而spring Cloud中的<code>org.springframework.cloud.netflix.eureka.EurekaDiscoveryClient</code>，依赖于<code>com.netflix.discovery.EurekaClient</code>，因此Spring Cloud与NetFlix的关系由此联系到一起。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DiscoveryClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constants</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HTTP_X_DISCOVERY_ALLOW_REDIRECT = <span class="string">"X-Discovery-AllowRedirect"</span>;</span><br><span class="line">    <span class="comment">//其余省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="EnableEurekaClient注解入口分析"><a href="#EnableEurekaClient注解入口分析" class="headerlink" title="@EnableEurekaClient注解入口分析"></a>@EnableEurekaClient注解入口分析</h2><p>   在上面小节中，理清了<code>NetFlix Eureka</code>与<code>Spring cloud</code>中类的依赖关系，下面将以@EnableEurekaClient为入口，分析主要调用链中的类和方法。</p><h3 id="EnableEurekaClient使用"><a href="#EnableEurekaClient使用" class="headerlink" title="@EnableEurekaClient使用"></a>@EnableEurekaClient使用</h3><ol><li>用过spring cloud的同学都知道，使用@EnableEurekaClient就能简单的开启Eureka Client中的功能，如下代码所示。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudEurekaClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="keyword">new</span> SpringApplicationBuilder(CloudEurekaClientApplication.class).web(<span class="keyword">true</span>).run(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>通过@EnableEurekaClient这个简单的注解，在spring cloud应用启动的时候，就可以把EurekaDiscoveryClient注入，继而使用NetFlix提供的Eureka client。</p><ol><li><p>打开EnableEurekaClient这个类，可以看到这个自定义的annotation @EnableEurekaClient里面没有内容。它的作用就是开启Eureka discovery的配置，正是通过这个标记，autoconfiguration就可以加载相关的Eureka类。那我们看下它是怎么做到的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableEurekaClient &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在上述代码中，我们看到，EnableEurekaClient上面加入了另外一个注解@EnableDiscoveryClient，看看这个注解的代码如下所示:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Annotation to enable a DiscoveryClient implementation.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(EnableDiscoveryClientImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDiscoveryClient &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>这个注解import了EnableDiscoveryClientImportSelector.class这样一个类，其实就是通过这个类来<code>加载</code>需要用到的bean。<br>点开EnableDiscoveryClientImportSelector类，如下代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(Ordered.LOWEST_PRECEDENCE - <span class="number">100</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableDiscoveryClientImportSelector</span></span></span><br><span class="line"><span class="class"><span class="keyword">extends</span> <span class="title">SpringFactoryImportSelector</span>&lt;<span class="title">EnableDiscoveryClient</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RelaxedPropertyResolver(getEnvironment()).getProperty(</span><br><span class="line"><span class="string">"spring.cloud.discovery.enabled"</span>, Boolean.class, Boolean.TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasDefaultFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>看到这里有覆盖了<code>父类SpringFactoryImportSelector</code>的一个方法<code>isEnabled</code>，注意，默认是TRUE，也就是只要import了这个配置，就会enable。</p></blockquote><p>在其父类<code>org.springframework.cloud.commons.util.SpringFactoryImportSelector</code><br>的<code>String[] selectImports(AnnotationMetadata metadata)</code>方法中正是根据这个标记类判定是否加载如下定义的类。在源码第59行，局部代码如下所示。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata metadata) &#123;</span><br><span class="line"><span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line">AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">metadata.getAnnotationAttributes(<span class="keyword">this</span>.annotationClass.getName(), <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">Assert.notNull(attributes, <span class="string">"No "</span> + getSimpleName() + <span class="string">" attributes found. Is "</span></span><br><span class="line">+ metadata.getClassName() + <span class="string">" annotated with @"</span> + getSimpleName() + <span class="string">"?"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find all possible auto configuration classes, filtering duplicates</span></span><br><span class="line">List&lt;String&gt; factories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">new</span> LinkedHashSet&lt;&gt;(SpringFactoriesLoader</span><br><span class="line">.loadFactoryNames(<span class="keyword">this</span>.annotationClass, <span class="keyword">this</span>.beanClassLoader)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (factories.isEmpty() &amp;&amp; !hasDefaultFactory()) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Annotation @"</span> + getSimpleName()</span><br><span class="line">+ <span class="string">" found, but there are no implementations. Did you forget to include a starter?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (factories.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">// there should only ever be one DiscoveryClient, but there might be more than</span></span><br><span class="line"><span class="comment">// one factory</span></span><br><span class="line">log.warn(<span class="string">"More than one implementation "</span> + <span class="string">"of @"</span> + getSimpleName()</span><br><span class="line">+ <span class="string">" (now relying on @Conditionals to pick one): "</span> + factories);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> factories.toArray(<span class="keyword">new</span> String[factories.size()]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在源码中70-71行，即在<br>org.springframework.core.io.support.SpringFactoriesLoader 中的109行的loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader)方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">String factoryClassName = factoryClass.getName();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span><br><span class="line">ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"><span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">URL url = urls.nextElement();</span><br><span class="line">Properties properties = PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> UrlResource(url));</span><br><span class="line">String factoryClassNames = properties.getProperty(factoryClassName);</span><br><span class="line">result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load ["</span> + factoryClass.getName() +</span><br><span class="line"><span class="string">"] factories from location ["</span> + FACTORIES_RESOURCE_LOCATION + <span class="string">"]"</span>, ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ol><li>实际调用<code>loadFactoryNames</code>其实加载<code>META-INF/spring.factories</code>下的class。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">* The location to look for factories.</span></span><br><span class="line"><span class="comment">* &lt;p&gt;Can be present in multiple JAR files.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACTORIES_RESOURCE_LOCATION = <span class="string">"META-INF/spring.factories"</span>;</span><br></pre></td></tr></table></figure></li></ol><p>而在spring-cloud-netflix-eureka-client\src\main\resources\META-INF\spring.factories中配置，用于加载一系列配置信息和Dependences Bean<br><img src="/images/spring-cloud-netflix/eureka/anoation/1.png" alt="spring.factories"><br>可以看到<code>EnableAutoConfiguration</code>的包含了<code>EurekaClientConfigServerAutoConfiguration</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.ribbon.eureka.RibbonEurekaAutoConfiguration</span><br><span class="line"></span><br><span class="line">org.springframework.cloud.bootstrap.BootstrapConfiguration=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration</span><br><span class="line"></span><br><span class="line">org.springframework.cloud.client.discovery.EnableDiscoveryClient=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration</span><br></pre></td></tr></table></figure></p><p>打开org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration可以看到<br>EurekaClientAutoConfiguration具体的注入信息。</p><p>具体@EnableEurekaClien注解开启之后，服务启动后，是服务怎么注册的请参考，下面链接：<br><a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-register/</a></p><h2 id="其它源码分析链接"><a href="#其它源码分析链接" class="headerlink" title="其它源码分析链接"></a>其它源码分析链接</h2><p> Spring Cloud中@EnableEurekaClient源码分析:<br> <a href="http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/</a><br> Spring Cloud Eureka服务注册源码分析：<br> <a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-register/</a><br> Spring Cloud Eureka服务续约(Renew)源码分析<br> <a href="http://blog.xujin.org/sc/sc-eureka-renew/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-renew/</a><br> Spring Cloud Eureka服务下线(Cancel)源码分析<br> <a href="http://blog.xujin.org/sc/sc-eureka-cancle/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-cancle/</a></p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Eureka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Eureka </tag>
            
            <tag> Spring Cloud 源码分析 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Eureka服务注册源码分析</title>
      <link href="/sc/sc-eureka-register/"/>
      <url>/sc/sc-eureka-register/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:在上一篇中，介绍了Eureka的相关的知识，解释了Eureka为什么适合做服务发现和注册。接下来，在本篇文章将通过源码分析的方式，看一下Eureka是怎么work的。本章主要介绍Eureka的服务注册。那eureka client如何将本地服务的注册信息发送到远端的注册服务器eureka server上。通过下面的源码分析，看出Eureka Client的定时任务调用Eureka Server的REST接口，而Eureka接收到调用请求后会处理服务的注册以及Eureka Server中的数据同步的问题。</p><h2 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h2><p> 服务注册，想必大家并不陌生，就是服务提供者启动的时候，把自己提供的服务信息，例如 服务名，IP，端口号，版本号等信息注册到注册中心，比如注册到ZK中。那eureka client如何将本地服务的注册信息发送到远端的注册服务器eureka server上。通过下面的源码分析，看出服务注册可以认为是Eureka client自己完成，不需要服务本身来关心。</p><h3 id="Eureka-Client的定时任务调用Eureka-Server的提供接口"><a href="#Eureka-Client的定时任务调用Eureka-Server的提供接口" class="headerlink" title="Eureka Client的定时任务调用Eureka Server的提供接口"></a>Eureka Client的定时任务调用Eureka Server的提供接口</h3><p>实现思路其实也挺简单，在com.netflix.discovery.DiscoveryClient启动的时候，会初始化一个定时任务，定时的把本地的服务配置信息，即需要注册到远端的服务信息自动刷新到注册服务器上。<br>首先看一下Eureka的代码，在spring-cloud-netflix-eureka-server工程中可以找到这个依赖eureka-client-1.4.11.jar查看代码可以看到，<br>com.netflix.discovery.DiscoveryClient.java中的1240行可以看到Initializes all scheduled tasks，在1277行，可以看到InstanceInfoReplicator定时任务。<br><a id="more"></a></p><ol><li>在DiscoveryClient中初始化一个InstanceInfoReplicator，其实里面封装了以定时任务。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes all scheduled tasks.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">            <span class="comment">// registry cache refresh timer</span></span><br><span class="line">            <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">            <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">            scheduler.schedule(</span><br><span class="line">                    <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                            <span class="string">"cacheRefresh"</span>,</span><br><span class="line">                            scheduler,</span><br><span class="line">                            cacheRefreshExecutor,</span><br><span class="line">                            registryFetchIntervalSeconds,</span><br><span class="line">                            TimeUnit.SECONDS,</span><br><span class="line">                            expBackOffBound,</span><br><span class="line">                            <span class="keyword">new</span> CacheRefreshThread()</span><br><span class="line">                    ),</span><br><span class="line">                    registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">            <span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">            <span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">            logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: "</span> + renewalIntervalInSecs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Heartbeat timer</span></span><br><span class="line">            scheduler.schedule(</span><br><span class="line">                    <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                            <span class="string">"heartbeat"</span>,</span><br><span class="line">                            scheduler,</span><br><span class="line">                            heartbeatExecutor,</span><br><span class="line">                            renewalIntervalInSecs,</span><br><span class="line">                            TimeUnit.SECONDS,</span><br><span class="line">                            expBackOffBound,</span><br><span class="line">                            <span class="keyword">new</span> HeartbeatThread()</span><br><span class="line">                    ),</span><br><span class="line">                    renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// InstanceInfo replicator</span></span><br><span class="line">            <span class="comment">/**************************封装了定时任务**********************************/</span></span><br><span class="line">            instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</span><br><span class="line">                    <span class="keyword">this</span>,</span><br><span class="line">                    instanceInfo,</span><br><span class="line">                    clientConfig.getInstanceInfoReplicationIntervalSeconds(),</span><br><span class="line">                    <span class="number">2</span>); <span class="comment">// burstSize</span></span><br><span class="line"></span><br><span class="line">            statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</span><br><span class="line">                            InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</span><br><span class="line">                        <span class="comment">// log at warn level if DOWN was involved</span></span><br><span class="line">                        logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125;</span><br><span class="line">                    instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</span><br><span class="line">                applicationInfoManager.registerStatusChangeListener(statusChangeListener);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//点击可以查看start方法</span></span><br><span class="line">            instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ol><p>2.以initialDelayMs为间隔调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> initialDelayMs)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (started.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">           instanceInfo.setIsDirty();  <span class="comment">// for initial register</span></span><br><span class="line">           Future next = scheduler.schedule(<span class="keyword">this</span>, initialDelayMs, TimeUnit.SECONDS);</span><br><span class="line">           scheduledPeriodicRef.set(next);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3.ScheduledExecutorService的task的具体业务定义在com.netflix.discovery.InstanceInfoReplicator.run()中，也就是InstanceInfoReplicator中的98-113行，可以看到调用了了client的register方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           discoveryClient.refreshInstanceInfo();</span><br><span class="line"></span><br><span class="line">           Long dirtyTimestamp = instanceInfo.isDirtyWithTime();</span><br><span class="line">           <span class="keyword">if</span> (dirtyTimestamp != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">//客户端发送hhtp注册请求的真正入口</span></span><br><span class="line">               discoveryClient.register();</span><br><span class="line">               instanceInfo.unsetIsDirty(dirtyTimestamp);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">           logger.warn(<span class="string">"There was a problem with the instance info replicator"</span>, t);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           Future next = scheduler.schedule(<span class="keyword">this</span>, replicationIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">           scheduledPeriodicRef.set(next);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4.com.netflix.discovery.DiscoveryClient中的 register()方法，大概在811行。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Register with the eureka service by making the appropriate REST call.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    logger.info(PREFIX + appPathIdentifier + <span class="string">": registering service..."</span>);</span><br><span class="line">    EurekaHttpResponse&lt;Void&gt; httpResponse;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//Eureka Client客户端，调用Eureka服务端的入口</span></span><br><span class="line">        httpResponse = eurekaTransport.registrationClient.register(instanceInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.warn(<span class="string">"&#123;&#125; - registration failed &#123;&#125;"</span>, PREFIX + appPathIdentifier, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(<span class="string">"&#123;&#125; - registration status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">204</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Eureka-server端接到请求后的处理"><a href="#Eureka-server端接到请求后的处理" class="headerlink" title="Eureka server端接到请求后的处理"></a>Eureka server端接到请求后的处理</h3><p>打开spring-cloud-netflix-eureka-server工程或spring-cloud-netflix-eureka-client过程，找到相应的maven依赖jar，如下图所示<br><img src="/images/spring-cloud-netflix/eureka/2016-11-01_223409.png" alt="Eureka中register入口"><br> 1.Eureka server服务端请求入口<br>ApplicationResource.java文件中第183行，如下所示，可以看出Eureka是通过http post的方式去服务注册<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@POST</span></span><br><span class="line">    <span class="meta">@Consumes</span>(&#123;<span class="string">"application/json"</span>, <span class="string">"application/xml"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">addInstance</span><span class="params">(InstanceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</span><br><span class="line">        logger.debug(<span class="string">"Registering instance &#123;&#125; (replication=&#123;&#125;)"</span>, info.getId(), isReplication);</span><br><span class="line">        <span class="comment">// validate that the instanceinfo contains all the necessary required fields</span></span><br><span class="line">        <span class="keyword">if</span> (isBlank(info.getId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing instanceId"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getHostName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing hostname"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getAppName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing appName"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!appName.equals(info.getAppName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Mismatched appName, expecting "</span> + appName + <span class="string">" but was "</span> + info.getAppName()).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo"</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo().getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo Name"</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// handle cases where clients may be registering with bad DataCenterInfo with missing data</span></span><br><span class="line">        DataCenterInfo dataCenterInfo = info.getDataCenterInfo();</span><br><span class="line">        <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> UniqueIdentifier) &#123;</span><br><span class="line">            String dataCenterInfoId = ((UniqueIdentifier) dataCenterInfo).getId();</span><br><span class="line">            <span class="keyword">if</span> (isBlank(dataCenterInfoId)) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> experimental = <span class="string">"true"</span>.equalsIgnoreCase(serverConfig.getExperimental(<span class="string">"registration.validation.dataCenterInfoId"</span>));</span><br><span class="line">                <span class="keyword">if</span> (experimental) &#123;</span><br><span class="line">                    String entity = <span class="string">"DataCenterInfo of type "</span> + dataCenterInfo.getClass() + <span class="string">" must contain a valid id"</span>;</span><br><span class="line">                    <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(entity).build();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> AmazonInfo) &#123;</span><br><span class="line">                    AmazonInfo amazonInfo = (AmazonInfo) dataCenterInfo;</span><br><span class="line">                    String effectiveId = amazonInfo.get(AmazonInfo.MetaDataKey.instanceId);</span><br><span class="line">                    <span class="keyword">if</span> (effectiveId == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        amazonInfo.getMetadata().put(AmazonInfo.MetaDataKey.instanceId.getName(), info.getId());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Registering DataCenterInfo of type &#123;&#125; without an appropriate id"</span>, dataCenterInfo.getClass());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//InstanceRegistry.java文件中的88行的405行register方法</span></span><br><span class="line">        registry.register(info, <span class="string">"true"</span>.equals(isReplication));</span><br><span class="line">        <span class="keyword">return</span> Response.status(<span class="number">204</span>).build();  <span class="comment">// 204 to be backwards compatible</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>2.如下图所示可以看到，从ApplicationResource.java怎么进入到PeerAwareInstanceRegistryImpl中的register方法<br><img src="/images/spring-cloud-netflix/eureka/2016-11-01_222223.png" alt="调用PeerAwareInstanceRegistryImpl中的register"><br>InstanceRegistry.java文件中的88行，可以看到调用PeerAwareInstanceRegistryImpl中的405行register方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">handleRegistration(info, resolveInstanceLeaseDuration(info), isReplication);</span><br><span class="line">       <span class="comment">//调用PeerAwareInstanceRegistryImpl中的405行register方法</span></span><br><span class="line"><span class="keyword">super</span>.register(info, isReplication);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>3.PeerAwareInstanceRegistryImpl中的405行register方法，代码如下所示。阅读方法上面的注释，就知道该方法是注册服务信息并把Eureka Server中的配置信息同步。执行注册的动作在com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl.register(InstanceInfo info, boolean isReplication)中，具体代码如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Registers the information about the &#123;<span class="doctag">@link</span> InstanceInfo&#125; and replicates</span></span><br><span class="line"><span class="comment">    * this information to all peer eureka nodes. If this is replication event</span></span><br><span class="line"><span class="comment">    * from other replica nodes then it is not replicated.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> info</span></span><br><span class="line"><span class="comment">    *            the &#123;<span class="doctag">@link</span> InstanceInfo&#125; to be registered and replicated.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> isReplication</span></span><br><span class="line"><span class="comment">    *            true if this is a replication event from other replica nodes,</span></span><br><span class="line"><span class="comment">    *            false otherwise.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> leaseDuration = Lease.DEFAULT_DURATION_IN_SECS;</span><br><span class="line">       <span class="keyword">if</span> (info.getLeaseInfo() != <span class="keyword">null</span> &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           leaseDuration = info.getLeaseInfo().getDurationInSecs();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//调用父类方法注册</span></span><br><span class="line">       <span class="keyword">super</span>.register(info, leaseDuration, isReplication);</span><br><span class="line">       <span class="comment">// 同步Eureka中的服务信息</span></span><br><span class="line">       replicateToPeers(Action.Register, info.getAppName(), info.getId(), info, <span class="keyword">null</span>, isReplication);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>4.AbstractInstanceRegistry.java中192行，可以看到Eureka真正的服务注册实现的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Registers a new instance with a given duration.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> com.netflix.eureka.lease.LeaseManager#register(java.lang.Object, int, boolean)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            read.lock();</span><br><span class="line">            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());</span><br><span class="line">            REGISTER.increment(isReplication);</span><br><span class="line">            <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt;();</span><br><span class="line">                gMap = registry.putIfAbsent(registrant.getAppName(), gNewMap);</span><br><span class="line">                <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    gMap = gNewMap;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());</span><br><span class="line">            <span class="comment">// Retain the last dirty timestamp without overwriting it, if there is already a lease</span></span><br><span class="line">            <span class="keyword">if</span> (existingLease != <span class="keyword">null</span> &amp;&amp; (existingLease.getHolder() != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                Long existingLastDirtyTimestamp = existingLease.getHolder().getLastDirtyTimestamp();</span><br><span class="line">                Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp();</span><br><span class="line">                logger.debug(<span class="string">"Existing lease found (existing=&#123;&#125;, provided=&#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">                <span class="keyword">if</span> (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"There is an existing lease and the existing lease's dirty timestamp &#123;&#125; is greater"</span> +</span><br><span class="line">                            <span class="string">" than the one that is being registered &#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">                    logger.warn(<span class="string">"Using the existing instanceInfo instead of the new instanceInfo as the registrant"</span>);</span><br><span class="line">                    registrant = existingLease.getHolder();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The lease does not exist and hence it is a new registration</span></span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// Since the client wants to cancel it, reduce the threshold</span></span><br><span class="line">                        <span class="comment">// (1</span></span><br><span class="line">                        <span class="comment">// for 30 seconds, 2 for a minute)</span></span><br><span class="line">                        <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</span><br><span class="line">                                (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                logger.debug(<span class="string">"No previous lease information found; it is new registration"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Lease&lt;InstanceInfo&gt; lease = <span class="keyword">new</span> Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);</span><br><span class="line">            <span class="keyword">if</span> (existingLease != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());</span><br><span class="line">            &#125;</span><br><span class="line">            gMap.put(registrant.getId(), lease);</span><br><span class="line">            <span class="keyword">synchronized</span> (recentRegisteredQueue) &#123;</span><br><span class="line">                recentRegisteredQueue.add(<span class="keyword">new</span> Pair&lt;Long, String&gt;(</span><br><span class="line">                        System.currentTimeMillis(),</span><br><span class="line">                        registrant.getAppName() + <span class="string">"("</span> + registrant.getId() + <span class="string">")"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// This is where the initial state transfer of overridden status happens</span></span><br><span class="line">            <span class="keyword">if</span> (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Found overridden status &#123;&#125; for instance &#123;&#125;. Checking to see if needs to be add to the "</span></span><br><span class="line">                                + <span class="string">"overrides"</span>, registrant.getOverriddenStatus(), registrant.getId());</span><br><span class="line">                <span class="keyword">if</span> (!overriddenInstanceStatusMap.containsKey(registrant.getId())) &#123;</span><br><span class="line">                    logger.info(<span class="string">"Not found overridden id &#123;&#125; and hence adding it"</span>, registrant.getId());</span><br><span class="line">                    overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId());</span><br><span class="line">            <span class="keyword">if</span> (overriddenStatusFromMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.info(<span class="string">"Storing overridden status &#123;&#125; from map"</span>, overriddenStatusFromMap);</span><br><span class="line">                registrant.setOverriddenStatus(overriddenStatusFromMap);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set the status based on the overridden status rules</span></span><br><span class="line">            InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication);</span><br><span class="line">            registrant.setStatusWithoutDirty(overriddenInstanceStatus);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the lease is registered with UP status, set lease service up timestamp</span></span><br><span class="line">            <span class="keyword">if</span> (InstanceStatus.UP.equals(registrant.getStatus())) &#123;</span><br><span class="line">                lease.serviceUp();</span><br><span class="line">            &#125;</span><br><span class="line">            registrant.setActionType(ActionType.ADDED);</span><br><span class="line">            recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(lease));</span><br><span class="line">            registrant.setLastUpdatedTimestamp();</span><br><span class="line">            invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</span><br><span class="line">            logger.info(<span class="string">"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)"</span>,</span><br><span class="line">                    registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            read.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>更多的细节源码内容，大家可以自己阅读。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ApplicationResource类接收Http服务请求，调用PeerAwareInstanceRegistryImpl的register方法，PeerAwareInstanceRegistryImpl完成服务注册后，调用replicateToPeers向其它Eureka Server节点（Peer）做状态同步。如下图所示。<br><img src="/images/spring-cloud-netflix/eureka/eureka-server-register.png" alt="Eureka Server注册时序图"></p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Eureka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Eureka </tag>
            
            <tag> Spring Cloud 源码分析 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Spring Cloud Netflix之Eureka下篇原理</title>
      <link href="/sc/sc-eureka-mid/"/>
      <url>/sc/sc-eureka-mid/</url>
      <content type="html"><![CDATA[<p><strong>摘要</strong>:本文主要介绍Eureka的工作原理，Eureka 组件分为两部分：<code>Eureka server</code>和 <code>Eureka client</code>。而客户端又分为 <code>Application Service 客户端</code>和 <code>Application Client 客户端</code>两种。Eureka 的工作机制每个 region 都有自己的 Eureka 服务器集群，每个 zone 至少要有一个 Eureka 服务器以应对 zone 瘫痪。<br><a id="more"></a></p><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><ol><li>Renew:我的理解是续约，为什么叫续约呢？<br>Renew（服务续约）操作由Service Provider<code>定期调用</code>，类似于heartbeat。目的是隔一段时间Service Provider调用接口，告诉Eureka Server它还活着没挂，不要把它踢掉。通俗的说就是它们两之间的心跳检测，避免服务提供者被剔除掉。</li><li>Cancel（服务下线）<br>一般在Service Provider<code>挂了</code>或<code>shut down</code>的时候调用，用来把自身的服务从Eureka Server中<code>删除</code>，以防客户端调用到不存在的服务。</li><li>Fetch Registries(获取注册信息)，<br>Fetch Registries由Service Consumer(服务消费者)调用，用来获取Eureka Server上注册的服务info。</li><li>Eviction(剔除)<br>Eviction（失效服务剔除）用来定期在Eureka Server检测失效的服务，检测标准就是超过一定时间没有Renew的服务。<h2 id="回顾Eureka架构图"><a href="#回顾Eureka架构图" class="headerlink" title="回顾Eureka架构图"></a>回顾Eureka架构图</h2><h3 id="Eureka架构图"><a href="#Eureka架构图" class="headerlink" title="Eureka架构图"></a>Eureka架构图</h3>Eureka架构图如下图所示，github地址:<a href="https://github.com/netflix/eureka" target="_blank" rel="noopener">https://github.com/netflix/eureka</a><br>document地址:<a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance" target="_blank" rel="noopener">https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance</a><br><img src="/images/spring-cloud-netflix/eureka/eureka_architecture.png" alt="Eureka架构图"><br>&ensp;　从图中我们可以看出，Eureka 组件分为两部分：<code>Eureka server</code>和 <code>Eureka client</code>。而客户端又分为 <code>Application Service 客户端</code>和 <code>Application Client 客户端</code>两种。Eureka 的工作机制每个 region 都有自己的 Eureka 服务器集群，每个 zone 至少要有一个 Eureka 服务器以应对 zone 瘫痪。<br>&ensp;　Application Service 在启动时注册到 Eureka 服务器，之后每 <code>30</code> 秒钟发送心跳以更新自身状态,即<code>Renew(续约)</code>。如果该客户端没能发送心跳更新，它将在 <code>90</code> 秒之后被其注册的 Eureka 服务器剔除，即<code>Eviction(剔除)</code>。来自任意 zone 的 Application Client 可以获取这些注册信息(每隔 <code>30</code> 秒查看一次)并依此定位到在任何区域可以给自己提供服务的提供者(即Fetch Registries)，进而进行远程调用。<blockquote><p>服务提供者本身携带的Eureka Client既能<code>服务注册</code>，<code>服务续约</code>，也能通过client<code>定位服务</code>和<code>调用其它的服务</code>。</p></blockquote></li></ol><h2 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h2><h3 id="服务注册-1"><a href="#服务注册-1" class="headerlink" title="服务注册"></a>服务注册</h3><p>  服务注册源码分析，请参考:<a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="noopener">http://blog.xujin.org/sc/sc-eureka-register/</a></p><h2 id="Renew-服务续约"><a href="#Renew-服务续约" class="headerlink" title="Renew(服务续约)"></a>Renew(服务续约)</h2><h3 id="服务续约"><a href="#服务续约" class="headerlink" title="服务续约"></a>服务续约</h3><p>  Renew操作会在Service Provider端定期发起，用来通知Eureka Server自己还活着。 这里有两个比较重要的配置需要注意一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.leaseRenewalIntervalInSeconds</span><br></pre></td></tr></table></figure></p><p>  Renew频率。默认是30秒，也就是每30秒会向Eureka Server发起Renew操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.leaseExpirationDurationInSeconds</span><br></pre></td></tr></table></figure></p><p> 服务失效时间。默认是90秒，也就是如果Eureka Server在90秒内没有接收到来自Service Provider的Renew操作，就会把Service Provider剔除。</p>]]></content>
      
      <categories>
          
          <category> Spring Cloud Eureka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Eureka </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>什么是Spring Cloud Config？</title>
      <link href="/sc/sc-config/"/>
      <url>/sc/sc-config/</url>
      <content type="html"><![CDATA[<p>前言:在单体应用中，我们一般的做法是把Property和Code放在一起，没有什么问题。但是在分布式系统中，由于存在多个服务实例，需要分别管理到每个具体的服务工程中的配置，上线需要准备check list 并逐个检查每个上线的服务是否正确。在系统上线之后修改某个配置，需要重启服务。这样开发就相当麻烦。因此我们急需需要把分布式系统中的配置信息抽取出来统一管理，服务获取系统信息时有一个覆盖顺序:property–&gt; Evn—-&gt;配置中心。这样修改环境变量或者修改配置中心的配置就能取到最新的配置信息。在唯品会 Venus Framework中我们专门设计了这个功能。Spring cloud出现之后，避免了大家重复造轮子。</p><h2 id="什么是-Spring-Cloud-Config"><a href="#什么是-Spring-Cloud-Config" class="headerlink" title="什么是 Spring Cloud Config ?"></a>什么是 Spring Cloud Config ?</h2><p>其官方文档中对自己的定义是如下，官网连接:<a href="http://cloud.spring.io/spring-cloud-config/" target="_blank">Spring Cloud Config</a>。</p><blockquote><p>Spring Cloud Config provides server and client-side support for externalized configuration in a distributed system.<br>With the Config Server you have a central place to manage external properties for applications across all environments.</p></blockquote><p>简单来说，Spring Cloud Config就是我们通常意义上的配置中心 - 把应用原本放在本地文件的配置抽取出来放在中心服务器，从而能够提供更好的管理、发布能力。<br><a id="more"></a></p><p>另外，Spring Cloud Config提供基于以下3个维度的配置管理：</p><ul><li><strong>应用</strong><ul><li>这个比较好理解，每个配置都是属于某一个应用的</li></ul></li><li><strong>环境</strong><ul><li>每个配置都是区分环境的，如dev, test, prod等</li></ul></li><li><strong>版本</strong><ul><li>这个可能是一般的配置中心所缺乏的，就是对同一份配置的不同版本管理，比如:可以通过Git进行版本控制。</li><li>Spring Cloud Config提供版本的支持，也就是说对于一个应用的不同部署实例，可以从服务端获取到不同版本的配置，这对于一些特殊场景如：灰度发布，A/B测试等提供了很好的支持。</li></ul></li></ul><h2 id="为什么会诞生Spring-Cloud-Config"><a href="#为什么会诞生Spring-Cloud-Config" class="headerlink" title="为什么会诞生Spring Cloud Config?"></a>为什么会诞生Spring Cloud Config?</h2><p>   配置中心目前现状:不管是开源的(百度的disconf)，还是一些公司自己闭源投入使用的产品已经不少了，那为什么还会诞生Spring Cloud Config呢？</p><p>在我看来，Spring Cloud Config在以下几方面还是有比较独特的优势，如下：</p><ul><li><strong>基于应用、环境、版本三个维度管理</strong><ul><li>这个在前面提过了，主要是有版本的支持</li></ul></li><li><strong>配置存储支持Git</strong><ul><li>这个就比较有特色了，后端基于Git存储，一方面程序员非常熟悉，另一方面在部署上会非常简单，而且借助于Git，天生就能非常好的支持版本</li><li>当然，它还支持其它的存储如本地文件、SVN等</li></ul></li><li><strong>和Spring无缝集成</strong><ul><li>它无缝支持Spring里面<code>Environment</code>和<code>PropertySource</code>的接口</li><li>所以对于已有的Spring应用程序的迁移成本非常低，在配置获取的接口上是完全一致的</li></ul></li></ul><h2 id="Spring-Cloud-Config-入门例子"><a href="#Spring-Cloud-Config-入门例子" class="headerlink" title="Spring Cloud Config 入门例子"></a>Spring Cloud Config 入门例子</h2><p>上述节点主要介绍了Spring cloud的相关理论，大家对Spring Cloud Config有了一个初步的认识，接下来例子让大家感受一下Spring cloud config的魅力。</p><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p><img src="/images/2016-10-18/overview.png" alt="Overview"></p><p>上图简要描述了一个普通Spring Cloud Config应用的场景。其中主要有以下几个组件：</p><ul><li><em>Config Client</em><ul><li>Client很好理解，就是使用了Spring Cloud Config的应用</li><li>Spring Cloud Config提供了基于Spring的客户端，应用只要在代码中引入Spring Cloud Config Client的jar包即可工作</li></ul></li><li><em>Config Server</em><ul><li>Config Server是需要独立部署的一个web应用，它负责把git上的配置返回给客户端</li></ul></li><li><em>Remote Git Repository</em><ul><li>远程Git仓库，一般而言，我们会把配置放在一个远程仓库，通过现成的git客户端来管理配置</li></ul></li><li><em>Local Git Repostiory</em><ul><li>Config Server的本地Git仓库</li><li>Config Server接到来自客户端的配置获取请求后，会先把远程仓库的配置clone到本地的临时目录，然后从临时目录读取配置并返回</li></ul></li></ul>]]></content>
      
      <categories>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Config </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>关于SpringCloud中国社区以及国内使用情况</title>
      <link href="/sc/springcloud/"/>
      <url>/sc/springcloud/</url>
      <content type="html"><![CDATA[<h2 id="Spring-Cloud中国社区起源"><a href="#Spring-Cloud中国社区起源" class="headerlink" title="Spring Cloud中国社区起源"></a>Spring Cloud中国社区起源</h2><p>  其实当Spring Cloud项目刚在github上出现的时候，我就一直在关注其项目发展，到了2015年8月，由于个人兴趣研究Spring Cloud项目，由于国内相关文档较少，当时就想建立一个中国社区，于是就先把域名注册了，选中域名为springcloud.cn。<br> <img src="/images/domainname.png" alt="springcloud.cn"></p><h2 id="为什么要发起Spring-Cloud中国社区"><a href="#为什么要发起Spring-Cloud中国社区" class="headerlink" title="为什么要发起Spring Cloud中国社区"></a>为什么要发起Spring Cloud中国社区</h2><p> Spring Cloud发展到2016年，国内关注的人越来越多，但是相应学习交流的平台和材料比较分散，不利于学习交流，因此Spring Cloud中国社区应运而生。<br> <img src="/images/sc.jpg" alt="社区标识"><br>　Spring Cloud中国社区是国内首个Spring Cloud构建微服务架构的交流社区。我们致力于为Spring Boot或Spring Cloud技术人员提供分享和交流的平台，推动Spring Cloud在中国的普及和应用。 欢迎CTO、架构师、开发者等，在这里学习与交流使用Spring Cloud的实战经验。 目前QQ群人数:7000+,微信群:2000+.<br> 扫描下面二维码或者微信搜索SpringCloud，关注社区公众号<br>  <img src="/images/gzh.jpg" alt="社区微信公众号"><br> Spring Cloud中国社区QQ群①:415028731<br> Spring cloud中国社区QQ群②:530321604<br> Spring Cloud中国社区官网:<a href="http://springcloud.cn" target="_blank" rel="noopener">http://springcloud.cn</a><br> Spring Cloud中国社区论坛:<a href="http://springcloud.cn" target="_blank" rel="noopener">http://springcloud.cn</a><br> Spring Cloud中国社区文档:<a href="http://docs.springcloud.cn" target="_blank" rel="noopener">http://docs.springcloud.cn</a></p><h2 id="spring-cloud目前国内使用情况"><a href="#spring-cloud目前国内使用情况" class="headerlink" title="spring cloud目前国内使用情况"></a>spring cloud目前国内使用情况</h2><ol><li>中国联通子公司<br><a href="http://flp.baidu.com/feedland/video/?entry=box_searchbox_feed&amp;id=144115189637730162&amp;from=timeline&amp;isappinstalled=0" target="_blank" rel="noopener">http://flp.baidu.com/feedland/video/?entry=box_searchbox_feed&amp;id=144115189637730162&amp;from=timeline&amp;isappinstalled=0</a><a id="more"></a></li><li>上海米么金服</li><li>指点无限（北京）科技有限公司 </li><li>易保软件 目前在定制开发中<br>  <a href="http://www.ebaotech.com/cn/" target="_blank" rel="noopener">http://www.ebaotech.com/cn/</a></li><li>广州简法网络</li><li>深圳睿云智合科技有限公司<br>  持续交付产品基于Spring Cloud研发 <a href="http://www.wise2c.com" target="_blank" rel="noopener">http://www.wise2c.com</a></li><li>猪八戒网</li><li>上海云首科技有限公司</li><li>华为<br>  整合netty进来用rpc 包括nerflix那套东西 需要注意的是sleuth traceid的传递需要自己写。tps在物理机上能突破20w</li><li>东软</li><li>南京云帐房网络科技有限公司</li><li>四众互联(北京)网络科技有限公司</li><li>深圳摩令技术科技有限公司</li><li>广州万表网</li><li>视觉中国</li><li>上海秦苍信息科技有限公司-买单侠</li><li>爱油科技(大连)有限公司<br><a href="http://blog.xujin.org/sc/sc-fx1/" target="_blank" rel="noopener">爱油科技基于SpringCloud的微服务实践</a></li><li>广发银行</li><li>卖货郎(<a href="http://www.51mhl.com/）" target="_blank" rel="noopener">http://www.51mhl.com/）</a></li><li>拍拍贷</li><li>甘肃电信</li><li>新浪商品部</li><li>春秋航空</li><li>冰鉴科技</li><li>万达网络科技集团-共享商业平台-共享供应链中心</li><li>网易乐得技术团队</li><li>饿了么某技术团队</li><li>高阳捷迅信息科技–话费中心业务平台–凭证查询及收单系统<br>数据在统计之中，会一直持续更新，敬请期待！</li></ol><h2 id="捐赠社区发展"><a href="#捐赠社区发展" class="headerlink" title="捐赠社区发展"></a>捐赠社区发展</h2><h3 id="捐赠社区"><a href="#捐赠社区" class="headerlink" title="捐赠社区"></a>捐赠社区</h3><p>   如果你觉得，Spring Cloud中国社区还可以，为了更好的发展，你可以捐赠社区，点击下面的打赏捐赠，捐赠的钱将用于社区发展和线下meeting up。</p>]]></content>
      
      <categories>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
